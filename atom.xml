<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Dai zhe&#39;s notes</title>
  
  <subtitle>Just Du It</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://daizhe.net.cn/"/>
  <updated>2019-03-12T11:55:21.809Z</updated>
  <id>https://daizhe.net.cn/</id>
  
  <author>
    <name>哆啦A梦</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>jenkins安装介绍及简单job实现</title>
    <link href="https://daizhe.net.cn/2019/03/12/jenkins%E5%AE%89%E8%A3%85%E4%BB%8B%E7%BB%8D%E5%8F%8A%E7%AE%80%E5%8D%95job%E5%AE%9E%E7%8E%B0/"/>
    <id>https://daizhe.net.cn/2019/03/12/jenkins安装介绍及简单job实现/</id>
    <published>2019-03-12T09:50:11.862Z</published>
    <updated>2019-03-12T11:55:21.809Z</updated>
    
    <content type="html"><![CDATA[<h1 id="jenkins安装介绍及简单job实现"><a href="#jenkins安装介绍及简单job实现" class="headerlink" title="jenkins安装介绍及简单job实现"></a>jenkins安装介绍及简单job实现</h1><p><img src="/2019/03/12/jenkins安装介绍及简单job实现/标题.png" alt=""><br><a id="more"></a></p><h2 id="一、安装jenkins"><a href="#一、安装jenkins" class="headerlink" title="一、安装jenkins"></a>一、安装jenkins</h2>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;jenkins安装介绍及简单job实现&quot;&gt;&lt;a href=&quot;#jenkins安装介绍及简单job实现&quot; class=&quot;headerlink&quot; title=&quot;jenkins安装介绍及简单job实现&quot;&gt;&lt;/a&gt;jenkins安装介绍及简单job实现&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/03/12/jenkins安装介绍及简单job实现/标题.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="jenkins" scheme="https://daizhe.net.cn/categories/jenkins/"/>
    
    
      <category term="jenkins" scheme="https://daizhe.net.cn/tags/jenkins/"/>
    
  </entry>
  
  <entry>
    <title>慕课网之redis</title>
    <link href="https://daizhe.net.cn/2019/03/11/%E6%85%95%E8%AF%BE%E7%BD%91%E4%B9%8Bredis/"/>
    <id>https://daizhe.net.cn/2019/03/11/慕课网之redis/</id>
    <published>2019-03-11T10:41:57.617Z</published>
    <updated>2019-03-11T12:57:29.156Z</updated>
    
    <content type="html"><![CDATA[<h1 id="企业级Redis开发运维"><a href="#企业级Redis开发运维" class="headerlink" title="企业级Redis开发运维"></a>企业级Redis开发运维</h1><p><img src="/2019/03/11/慕课网之redis/标题.png" alt=""><br><a id="more"></a></p><h2 id="一、Redis初识"><a href="#一、Redis初识" class="headerlink" title="一、Redis初识"></a>一、Redis初识</h2><ul><li>性能优势<ul><li>开源</li><li>高性能key-value服务器</li><li>多种数据结构</li><li>丰富的功能</li><li>高可用分布式支持</li></ul></li><li>Redis的特性<ul><li>速度快</li><li>持久化功能</li><li>多数据结构</li><li>支持多种编辑语言</li><li>功能丰富</li><li>代码简单，使用简单</li><li>支持主从复制</li><li>高可用、分布式</li></ul></li></ul><h3 id="速度快"><a href="#速度快" class="headerlink" title="速度快"></a>速度快</h3><ul><li>在服务器硬件较好的前提下，每秒可达10W次读写</li><li>redis的数据是放置在内存中</li><li>单线程(多线程会成为并发的瓶颈)，redis的单线程不会成为快速读取数据的瓶颈</li></ul><h3 id="持久化"><a href="#持久化" class="headerlink" title="持久化"></a>持久化</h3><ul><li>断电不丢数据即redis所有的数据是保存在内存中，对数据的更新将异步地保存在磁盘上（RDB/AOF数据持久化的方式）</li></ul><h3 id="多种数据结构"><a href="#多种数据结构" class="headerlink" title="多种数据结构"></a>多种数据结构</h3><ul><li>redis支持的数据结构<ul><li>string（字符串）</li><li>list（列表）</li><li>set（集合）</li><li>zset（有序集合）</li><li>hash（哈希数据）等数据结构的存储</li></ul></li></ul><h3 id="支持多种的客户端语言"><a href="#支持多种的客户端语言" class="headerlink" title="支持多种的客户端语言"></a>支持多种的客户端语言</h3><ul><li>java</li><li>php</li><li>python</li><li>ruby</li><li>lua</li><li>nodc js</li></ul><h3 id="功能丰富"><a href="#功能丰富" class="headerlink" title="功能丰富"></a>功能丰富</h3><ul><li>发布订阅</li><li>lua脚本</li><li>简单事务</li><li>pipeline 提升并发</li></ul><hr><h2 id="二、API的理解和使用"><a href="#二、API的理解和使用" class="headerlink" title="二、API的理解和使用"></a>二、API的理解和使用</h2><h3 id="通用命令"><a href="#通用命令" class="headerlink" title="通用命令"></a>通用命令</h3><ul><li>通用命令<ul><li>keys ：显示所有的key（一般不在生产环境使用，如果真的要查看所有的key，使用scan命令）<ul><li>keys * ：遍历所有的key</li><li>keys ha* : 显示所有以ha开头的key</li><li>keys h[a-z] </li><li>keys ha?  : 代表一位数值</li></ul></li><li>get key ：查看key 对用的value</li><li>dbsize：计算数据库的大小</li><li>exists key ：判断一个key是否存在</li><li>del key [key..] ：删除key/可以删除多个</li><li>expire key seconds ：为key设置过期时间</li><li>ttl key ： 查看此key剩余的过期时长</li><li>type key ：查看数据的类型 </li></ul></li><li>数据结构和内部编码</li><li>单线程架构</li></ul><h3 id="字符串类型"><a href="#字符串类型" class="headerlink" title="字符串类型"></a>字符串类型</h3><h3 id="哈希类型"><a href="#哈希类型" class="headerlink" title="哈希类型"></a>哈希类型</h3><h3 id="列表类型"><a href="#列表类型" class="headerlink" title="列表类型"></a>列表类型</h3><h3 id="集合类型"><a href="#集合类型" class="headerlink" title="集合类型"></a>集合类型</h3><h3 id="有序集合类型"><a href="#有序集合类型" class="headerlink" title="有序集合类型"></a>有序集合类型</h3><h2 id="三、Resi客户端的使用"><a href="#三、Resi客户端的使用" class="headerlink" title="三、Resi客户端的使用"></a>三、Resi客户端的使用</h2><h2 id="四、瑞士军刀Redis"><a href="#四、瑞士军刀Redis" class="headerlink" title="四、瑞士军刀Redis"></a>四、瑞士军刀Redis</h2><h2 id="五、Redis持久化的取舍和选择"><a href="#五、Redis持久化的取舍和选择" class="headerlink" title="五、Redis持久化的取舍和选择"></a>五、Redis持久化的取舍和选择</h2><h2 id="六、Redis复制的原则和优化"><a href="#六、Redis复制的原则和优化" class="headerlink" title="六、Redis复制的原则和优化"></a>六、Redis复制的原则和优化</h2><h2 id="七、Redis-Sentinel"><a href="#七、Redis-Sentinel" class="headerlink" title="七、Redis Sentinel"></a>七、Redis Sentinel</h2><h2 id="八、Redis-Cluster"><a href="#八、Redis-Cluster" class="headerlink" title="八、Redis Cluster"></a>八、Redis Cluster</h2>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;企业级Redis开发运维&quot;&gt;&lt;a href=&quot;#企业级Redis开发运维&quot; class=&quot;headerlink&quot; title=&quot;企业级Redis开发运维&quot;&gt;&lt;/a&gt;企业级Redis开发运维&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/03/11/慕课网之redis/标题.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="redis_慕课网" scheme="https://daizhe.net.cn/categories/redis-%E6%85%95%E8%AF%BE%E7%BD%91/"/>
    
    
      <category term="redis_慕课网" scheme="https://daizhe.net.cn/tags/redis-%E6%85%95%E8%AF%BE%E7%BD%91/"/>
    
  </entry>
  
  <entry>
    <title>web架构单机时代</title>
    <link href="https://daizhe.net.cn/2019/03/11/Oldboy%E4%B9%8Bweb%E6%9E%B6%E6%9E%84%E5%8D%95%E6%9C%BA%E6%97%B6%E4%BB%A3/"/>
    <id>https://daizhe.net.cn/2019/03/11/Oldboy之web架构单机时代/</id>
    <published>2019-03-11T05:47:47.909Z</published>
    <updated>2019-03-11T10:47:26.366Z</updated>
    
    <content type="html"><![CDATA[<h1 id="web架构单机时代"><a href="#web架构单机时代" class="headerlink" title="web架构单机时代"></a>web架构单机时代</h1><p><img src="/2019/03/11/Oldboy之web架构单机时代/标题.png" alt=""><br><a id="more"></a></p><h2 id="一、单机性能优化基础"><a href="#一、单机性能优化基础" class="headerlink" title="一、单机性能优化基础"></a>一、单机性能优化基础</h2><p><img src="/2019/03/11/Oldboy之web架构单机时代/1.png" alt=""></p><ul><li><p>1）用户浏览器发送请求经过网络到达web服务器</p></li><li><p>2）web服务器处理请求并响应数据</p></li><li><p>3）响应数据从web服务器发送到用户端</p></li><li><p>4）用户浏览器接收数据，本地计算和渲染</p></li></ul><p>范例：</p><p><img src="/2019/03/11/Oldboy之web架构单机时代/2.png" alt=""></p><p>用户请求的时间消耗？<br><img src="/2019/03/11/Oldboy之web架构单机时代/3.png" alt=""></p><ul><li><p>如何缩短处理时间？</p><ul><li>方法：<ul><li>1）单机性能优化</li><li>2）使用集群</li><li>3）使用缓存</li><li>4）瓶颈点优化</li><li>5）多机房部署，就近访问</li></ul></li></ul></li><li><p>流程：</p><ul><li>单机时代–&gt;系统集群–&gt;文件存储–&gt;缓存应用–&gt;数据存储–&gt;异地灾备</li></ul></li></ul><p>单机时代架构图–单机<br><img src="/2019/03/11/Oldboy之web架构单机时代/4.png" alt=""></p><p>单机时代架构图–动静分离<br><img src="/2019/03/11/Oldboy之web架构单机时代/5.png" alt=""></p><p>单机时代架构图–数据库分离<br><img src="/2019/03/11/Oldboy之web架构单机时代/6.png" alt=""></p><p>单机时代架构图–组件分离<br><img src="/2019/03/11/Oldboy之web架构单机时代/7.png" alt=""></p><ul><li><p>什么是Sockit？（优化优选：Socket套接字受资源限制）</p><ul><li>Socket五元组<ul><li>1：源地址</li><li>2：源端口</li><li>3：目的IP地址</li><li>4：目的端口</li><li>5：类型：TCP/UDP</li></ul></li><li>TCP Socket四元组<ul><li>1：源IP地址</li><li>2：源端口</li><li>3：目的IP地址</li><li>4：目的端口</li></ul></li></ul></li><li><p>吞吐率</p></li><li>响应时间</li></ul><h2 id="二、Socket基础和TCP三次握手"><a href="#二、Socket基础和TCP三次握手" class="headerlink" title="二、Socket基础和TCP三次握手"></a>二、Socket基础和TCP三次握手</h2><p>查看客户端请求服务端服务的随机端口范围</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">查看默认的随机端口范围</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cat /proc/sys/net/ipv4/ip_local_port_range </span></span><br><span class="line">  3276860999</span><br><span class="line"></span><br><span class="line">自定义优化随机端口范围</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># echo "10000 61000" &gt;  /proc/sys/net/ipv4/ip_local_port_range </span></span><br><span class="line">  ~]<span class="comment"># cat /proc/sys/net/ipv4/ip_local_port_range </span></span><br><span class="line">  1000061000</span><br></pre></td></tr></table></figure><p>调整可以打开的最大文件描述符<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">默认的打开最大文件</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># ulimit -n</span></span><br><span class="line">  1024</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># vim /etc/security/limits.conf </span></span><br><span class="line"></span><br><span class="line">*                soft    core               unlimited</span><br><span class="line">*                hard    core             unlimited</span><br><span class="line">*                    soft    nproc            1000000</span><br><span class="line">*                    hard    nproc          1000000</span><br><span class="line">*                    soft    nofile            1000000</span><br><span class="line">*                hard    nofile          1000000</span><br><span class="line">*                soft    memlock      32000</span><br><span class="line">*                hard    memlock    32000</span><br><span class="line">*                soft    msgqueue    8192000</span><br><span class="line">*                hard    msgqueue  8192000</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># reboot</span></span><br><span class="line">  ~]<span class="comment"># ulimit -n</span></span><br><span class="line">  1000000</span><br></pre></td></tr></table></figure></p><p>使用ab命令对apache性能进行测试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">安装ab命令压力测试工具</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># yum install httpd-devel -y</span></span><br><span class="line">   </span><br><span class="line">ab 命令参数解释</span><br><span class="line">  -n ： 指定总共发起的并发</span><br><span class="line">  -c ： 每次并发</span><br></pre></td></tr></table></figure></p><p>nc<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">nc [-hlnruz][-g&lt;网关...&gt;][-G&lt;指向器数目&gt;][-i&lt;延迟秒数&gt;][-o&lt;输出文件&gt;][-p&lt;通信端口&gt;][-s&lt;来源地址&gt;][-v...][-w&lt;超时秒数&gt;][主机名称][通信端口...]</span><br><span class="line">补充说明：执行本指令可设置路由器的相关参数。</span><br><span class="line">参　　数：</span><br><span class="line">-g&lt;网关&gt; 设置路由器跃程通信网关，最多可设置8个。</span><br><span class="line">-G&lt;指向器数目&gt; 设置来源路由指向器，其数值为4的倍数。</span><br><span class="line">-h 在线帮助。</span><br><span class="line">-i&lt;延迟秒数&gt; 设置时间间隔，以便传送信息及扫描通信端口。</span><br><span class="line">-l 使用监听模式，管控传入的资料。</span><br><span class="line">-n 直接使用IP地址，而不通过域名服务器。</span><br><span class="line">-o&lt;输出文件&gt; 指定文件名称，把往来传输的数据以16进制字码倾倒成该文件保存。</span><br><span class="line">-p&lt;通信端口&gt; 设置本地主机使用的通信端口。</span><br><span class="line">-r 乱数指定本地与远端主机的通信端口。</span><br><span class="line">-s&lt;来源地址&gt; 设置本地主机送出数据包的IP地址。</span><br><span class="line">-u 使用UDP传输协议。</span><br><span class="line">-v 显示指令执行过程。</span><br><span class="line">-w&lt;超时秒数&gt; 设置等待连线的时间。</span><br><span class="line">-z 使用0输入/输出模式，只在扫描通信端口时使用。</span><br><span class="line"></span><br><span class="line">服务端指定一个端口监控</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># nc -l -4 -p 9999 -k</span></span><br><span class="line"></span><br><span class="line">客户端创建一个套接字链接服务端</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># nc 172.20.101.228 9999  #指定服务端的IP地址记忆监听的端口</span></span><br><span class="line">  haha</span><br><span class="line"></span><br><span class="line">服务端也收到客户端发送来的消息</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># nc -l -4 -p 9999 -k</span></span><br><span class="line">  haha</span><br><span class="line"></span><br><span class="line">服务端查看Socket （可以查看到四源组）</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># netstat -na | grep 9999</span></span><br><span class="line">  tcp        0      0 0.0.0.0:9999            0.0.0.0:*               LISTEN     </span><br><span class="line">  tcp        0      0 192.168.35.115:9999     172.20.101.221:54594    ESTABLISHED</span><br><span class="line"></span><br><span class="line">客户端以伪终端的方式向服务端监听的套接字发送信息（伪设备）</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># echo "hellow" &gt; /dev/tcp/172.20.101.228/9999</span></span><br><span class="line"></span><br><span class="line">服务端接收到客户端的消息</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># nc -l -4 -p 9999 -k</span></span><br><span class="line">  hellow</span><br></pre></td></tr></table></figure></p><p>TCP状态转换图</p><p><img src="/2019/03/11/Oldboy之web架构单机时代/8.png" alt=""></p><h2 id="三、Time-wait优化"><a href="#三、Time-wait优化" class="headerlink" title="三、Time_wait优化"></a>三、Time_wait优化</h2><p>time_wait优化的参数<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">1为开启，0为关闭</span><br><span class="line"></span><br><span class="line">复用socekt链接</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cat /proc/sys/net/ipv4/tcp_tw_reuse </span></span><br><span class="line">  0</span><br><span class="line"></span><br><span class="line">时间戳</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cat /proc/sys/net/ipv4/tcp_timestamps </span></span><br><span class="line">  1</span><br><span class="line"></span><br><span class="line"><span class="comment"># tcp_tw_reuse 建议开启，但是前提时tcp_timestamps 已经打开</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">快速销毁socket,不等60s（快速回收）</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cat /proc/sys/net/ipv4/tcp_tw_recycle </span></span><br><span class="line">  0   <span class="comment">#建议打开，但是用户的网络为NAT网络时则不建议打开</span></span><br></pre></td></tr></table></figure></p><h2 id="四、HTTP长连接和短链接"><a href="#四、HTTP长连接和短链接" class="headerlink" title="四、HTTP长连接和短链接"></a>四、HTTP长连接和短链接</h2><ul><li><p>1：HTTP协议与TCP/IP协议的关系</p><ul><li>HTTP的长连接和短连接本质上是TCP长连接和短连接。HTTP属于应用层协议，在传输层使用TCP协议，在网络层使用IP协议。 IP协议主要解决网络路由和寻址问题，TCP协议主要解决如何在IP层之上可靠地传递数据包，使得网络上接收端收到发送端所发出的所有包，并且顺序与发送顺序一致。TCP协议是可靠的、面向连接的。</li></ul></li><li><p>2：如何理解HTTP协议是无状态的</p><ul><li>HTTP协议是无状态的，指的是协议对于事务处理没有记忆能力，服务器不知道客户端是什么状态。也就是说，打开一个服务器上的网页和上一次打开这个服务器上的网页之间没有任何联系。HTTP是一个无状态的面向连接的协议，无状态不代表HTTP不能保持TCP连接，更不能代表HTTP使用的是UDP协议（无连接）。</li></ul></li><li><p>3：什么是长连接、短连接？</p><ul><li>在HTTP/1.0中默认使用短连接。也就是说，客户端和服务器每进行一次HTTP操作，就建立一次连接，任务结束就中断连接。当客户端浏览器访问的某个HTML或其他类型的Web页中包含有其他的Web资源（如JavaScript文件、图像文件、CSS文件等），每遇到这样一个Web资源，浏览器就会重新建立一个HTTP会话。</li><li>而从HTTP/1.1起，默认使用长连接，用以保持连接特性。使用长连接的HTTP协议，会在响应头加入这行代码：<ul><li>Connection:keep-alive</li></ul></li><li>在使用长连接的情况下，当一个网页打开完成后，客户端和服务器之间用于传输HTTP数据的TCP连接不会关闭，客户端再次访问这个服务器时，会继续使用这一条已经建立的连接。Keep-Alive不会永久保持连接，它有一个保持时间，可以在不同的服务器软件（如Apache）中设定这个时间。实现长连接需要客户端和服务端都支持长连接。</li><li><code>HTTP协议的长连接和短连接，实质上是TCP协议的长连接和短连接。</code></li></ul></li><li><p>3.1: TCP连接</p><ul><li>当网络通信时采用TCP协议时，在真正的读写操作之前，客户端与服务器端之间必须建立一个连接，当读写操作完成后，双方不再需要这个连接时可以释放这个连接。连接的建立依靠“三次握手”，而释放则需要“四次握手”，所以每个连接的建立都是需要资源消耗和时间消耗的。</li></ul></li></ul><p>经典的三次握手建立连接示意图：</p><p><img src="/2019/03/11/Oldboy之web架构单机时代/9.png" alt=""></p><p><img src="/2019/03/11/Oldboy之web架构单机时代/10.png" alt=""></p><p>经典的四次握手关闭连接示意图：</p><p><img src="/2019/03/11/Oldboy之web架构单机时代/11.png" alt=""></p><p><img src="/2019/03/11/Oldboy之web架构单机时代/12.png" alt=""></p><ul><li><p>3.2. TCP短连接</p><ul><li><p>模拟一下TCP短连接的情况：client向server发起连接请求，server接到请求，然后双方建立连接。client向server发送消息，server回应client，然后一次请求就完成了。这时候双方任意都可以发起close操作，不过一般都是client先发起close操作。上述可知，短连接一般只会在 client/server间传递一次请求操作。</p></li><li><p>短连接的优点是：管理起来比较简单，存在的连接都是有用的连接，不需要额外的控制手段。</p></li></ul></li><li><p>3.3. TCP长连接</p><ul><li><p>我们再模拟一下长连接的情况：client向server发起连接，server接受client连接，双方建立连接，client与server完成一次请求后，它们之间的连接并不会主动关闭，后续的读写操作会继续使用这个连接。</p></li><li><p>TCP的保活功能主要为服务器应用提供。如果客户端已经消失而连接未断开，则会使得服务器上保留一个半开放的连接，而服务器又在等待来自客户端的数据，此时服务器将永远等待客户端的数据。保活功能就是试图在服务端器端检测到这种半开放的连接。</p></li><li><p>如果一个给定的连接在两小时内没有任何动作，服务器就向客户发送一个探测报文段，根据客户端主机响应探测4个客户端状态：</p></li><li><p>客户主机依然正常运行，且服务器可达。此时客户的TCP响应正常，服务器将保活定时器复位。</p></li><li>客户主机已经崩溃，并且关闭或者正在重新启动。上述情况下客户端都不能响应TCP。服务端将无法收到客户端对探测的响应。服务器总共发送10个这样的探测，每个间隔75秒。若服务器没有收到任何一个响应，它就认为客户端已经关闭并终止连接。</li><li>客户端崩溃并已经重新启动。服务器将收到一个对其保活探测的响应，这个响应是一个复位，使得服务器终止这个连接。</li><li>客户机正常运行，但是服务器不可达。这种情况与第二种状态类似。</li></ul></li><li><p>4: 长连接和短连接的优点和缺点</p><ul><li><p>由上可以看出，长连接可以省去较多的TCP建立和关闭的操作，减少浪费，节约时间。对于频繁请求资源的客户端适合使用长连接。在长连接的应用场景下，client端一般不会主动关闭连接，当client与server之间的连接一直不关闭，随着客户端连接越来越多，server会保持过多连接。这时候server端需要采取一些策略，如关闭一些长时间没有请求发生的连接，这样可以避免一些恶意连接导致server端服务受损；如果条件允许则可以限制每个客户端的最大长连接数，这样可以完全避免恶意的客户端拖垮整体后端服务。</p></li><li><p>短连接对于服务器来说管理较为简单，存在的连接都是有用的连接，不需要额外的控制手段。但如果客户请求频繁，将在TCP的建立和关闭操作上浪费较多时间和带宽。</p></li><li><p>长连接和短连接的产生在于client和server采取的关闭策略。不同的应用场景适合采用不同的策略。</p></li><li><p>由上可以看出，长连接可以省去较多的TCP建立和关闭的操作，减少浪费，节约时间。对于频繁请求资源的客户来说，较适用长连接。不过这里存在一个问题，存活功能的探测周期太长，还有就是它只是探测TCP连接的存活，属于比较斯文的做法，遇到恶意的连接时，保活功能就不够使了。在长连接的应用场景下，client端一般不会主动关闭它们之间的连接，Client与server之间的连接如果一直不关闭的话，会存在一个问题，随着客户端连接越来越多，server早晚有扛不住的时候，这时候server端需要采取一些策略，如关闭一些长时间没有读写事件发生的连接，这样可 以避免一些恶意连接导致server端服务受损；如果条件再允许就可以以客户端机器为颗粒度，限制每个客户端的最大长连接数，这样可以完全避免某个蛋疼的客户端连累后端服务。</p></li><li><p>短连接对于服务器来说管理较为简单，存在的连接都是有用的连接，不需要额外的控制手段。但如果客户请求频繁，将在TCP的建立和关闭操作上浪费时间和带宽。</p></li><li><p>长连接和短连接的产生在于client和server采取的关闭策略，具体的应用场景采用具体的策略，没有十全十美的选择，只有合适的选择。</p></li></ul></li><li><p>长连接短连接操作过程</p><ul><li>短连接的操作步骤是：<ul><li>建立连接——数据传输——关闭连接…建立连接——数据传输——关闭连接</li></ul></li></ul></li><li>长连接的操作步骤是：<ul><li>建立连接——数据传输…（保持连接）…数据传输——关闭连接</li></ul></li><li><p>什么时候用长连接，短连接？  　　</p><ul><li><p>长连接多用于操作频繁，点对点的通讯，而且连接数不能太多情况，。每个TCP连接都需要三步握手，这需要时间，如果每个操作都是先连接，再操作的话那么处理速度会降低很多，所以每个操作完后都不断开，次处理时直接发送数据包就OK了，不用建立TCP连接。例如：数据库的连接用长连接， 如果用短连接频繁的通信会造成socket错误，而且频繁的socket 创建也是对资源的浪费。 </p></li><li><p>而像WEB网站的http服务一般都用短链接，因为长连接对于服务端来说会耗费一定的资源，而像WEB网站这么频繁的成千上万甚至上亿客户端的连接用短连接会更省一些资源，如果用长连接，而且同时有成千上万的用户，如果每个用户都占用一个连接的话，那可想而知吧。所以并发量大，但每个用户无需频繁操作情况下需用短连好。</p></li></ul></li></ul><h2 id="五、运维知识体系"><a href="#五、运维知识体系" class="headerlink" title="五、运维知识体系"></a>五、运维知识体系</h2><ul><li>安装<ul><li>包管理工具：yum、apt-get</li><li>编译安装：./configure –prefix=/path/xxx</li><li>二进制安装</li></ul></li><li>配置<ul><li>网络</li><li>路径</li><li>容量</li><li>性能</li><li>安装</li><li>功能</li><li>日志</li></ul></li><li>启动<ul><li>systemctl</li><li>./执行</li><li>nohup/screen</li></ul></li><li>管理</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;web架构单机时代&quot;&gt;&lt;a href=&quot;#web架构单机时代&quot; class=&quot;headerlink&quot; title=&quot;web架构单机时代&quot;&gt;&lt;/a&gt;web架构单机时代&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/03/11/Oldboy之web架构单机时代/标题.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="Oldboy" scheme="https://daizhe.net.cn/categories/Oldboy/"/>
    
    
      <category term="Oldboy" scheme="https://daizhe.net.cn/tags/Oldboy/"/>
    
  </entry>
  
  <entry>
    <title>git常用命令及wab环境准备</title>
    <link href="https://daizhe.net.cn/2019/03/10/git%E5%B8%B8%E7%94%A8%E5%91%BD%E4%BB%A4%E5%8F%8Awab%E7%8E%AF%E5%A2%83%E5%87%86%E5%A4%87/"/>
    <id>https://daizhe.net.cn/2019/03/10/git常用命令及wab环境准备/</id>
    <published>2019-03-10T08:19:14.444Z</published>
    <updated>2019-03-12T09:53:06.936Z</updated>
    
    <content type="html"><![CDATA[<h1 id="git常用命令及wab环境准备"><a href="#git常用命令及wab环境准备" class="headerlink" title="git常用命令及wab环境准备"></a>git常用命令及wab环境准备</h1><p><img src="/2019/03/10/git常用命令及wab环境准备/标题.png" alt=""><br><a id="more"></a></p><p><img src="/2019/03/10/git常用命令及wab环境准备/41.png" alt=""></p><h1 id="git常用命令"><a href="#git常用命令" class="headerlink" title="git常用命令"></a>git常用命令</h1><h2 id="一、创建用户和组及项目"><a href="#一、创建用户和组及项目" class="headerlink" title="一、创建用户和组及项目"></a>一、创建用户和组及项目</h2><p>1：创建一个用户<br><img src="/2019/03/10/git常用命令及wab环境准备/13.png" alt=""></p><p><img src="/2019/03/10/git常用命令及wab环境准备/14.png" alt=""><br><img src="/2019/03/10/git常用命令及wab环境准备/15.png" alt=""></p><p>2：查看此用户是否创建成功，并设置密码<br><img src="/2019/03/10/git常用命令及wab环境准备/16.png" alt=""><br><img src="/2019/03/10/git常用命令及wab环境准备/17.png" alt=""><br><img src="/2019/03/10/git常用命令及wab环境准备/18.png" alt=""></p><p>3：使用新为开发创建的账号登陆测试<br><img src="/2019/03/10/git常用命令及wab环境准备/19.png" alt=""><br><img src="/2019/03/10/git常用命令及wab环境准备/20.png" alt=""></p><p>4：给开发的账号设置密码，也可以管理员不设置密码，直接测试登陆，然后开发账号预留的邮箱会接收到初始化设置密码的连接，可以点击链接设置新的密码</p><p>5：使用root用户关闭首页注册功能<br><img src="/2019/03/10/git常用命令及wab环境准备/21.png" alt=""><br><img src="/2019/03/10/git常用命令及wab环境准备/22.png" alt=""><br><img src="/2019/03/10/git常用命令及wab环境准备/23.png" alt=""><br><img src="/2019/03/10/git常用命令及wab环境准备/24.png" alt=""></p><p>6：验证页面是否还有无注册功能<br><img src="/2019/03/10/git常用命令及wab环境准备/25.png" alt=""></p><p>7：创建组：</p><ul><li>使用管理员root创建组，一个组里面可以有多个项目分支，可以将开发添加到组里面进行设置权限，不同的组就是公司不同的开发项目或者服务模块，不同的组添加不同的开发即可实现对开发设置权限的管理。</li></ul><p><img src="/2019/03/10/git常用命令及wab环境准备/1.png" alt=""></p><p><img src="/2019/03/10/git常用命令及wab环境准备/2.png" alt=""></p><p><img src="/2019/03/10/git常用命令及wab环境准备/3.png" alt=""></p><p>8：创建项目<br><img src="/2019/03/10/git常用命令及wab环境准备/4.png" alt=""><br><img src="/2019/03/10/git常用命令及wab环境准备/5.png" alt=""><br><img src="/2019/03/10/git常用命令及wab环境准备/6.png" alt=""></p><p>9：用户可以有权限查看到的项目（root用户可以查看到所有组中的项目）<br><img src="/2019/03/10/git常用命令及wab环境准备/7.png" alt=""></p><p>10：将此组授权给开发部门的老大，去维护此项目</p><ul><li>授权可以对组授权，可以对项目授权</li></ul><p><img src="/2019/03/10/git常用命令及wab环境准备/8.png" alt=""></p><p><img src="/2019/03/10/git常用命令及wab环境准备/9.png" alt=""></p><p>11：授权完普通用户权限后使用普通用户登陆(这里为了演示授予属主属组权限)</p><ul><li>将相当于此项目交给开发部门维护</li></ul><p><img src="/2019/03/10/git常用命令及wab环境准备/10.png" alt=""></p><p>12：在此项目中添加一个README<br><img src="/2019/03/10/git常用命令及wab环境准备/26.png" alt=""></p><p><img src="/2019/03/10/git常用命令及wab环境准备/27.png" alt=""></p><p>README已经添加<br><img src="/2019/03/10/git常用命令及wab环境准备/28.png" alt=""></p><hr><h2 id="二、如何从github上克隆项目"><a href="#二、如何从github上克隆项目" class="headerlink" title="二、如何从github上克隆项目"></a>二、如何从github上克隆项目</h2><p>1：在github上查找项目的链接（下载时支持的协议 ： ssh/http）</p><ul><li>ssh：克隆下载是使用密钥认证的</li><li>http：是使用帐户名密码认证的</li></ul><p><img src="/2019/03/10/git常用命令及wab环境准备/29.png" alt=""></p><p>2：使用客户端命令克隆下载<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">解释</span><br><span class="line"></span><br><span class="line">安装客户端命令</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># yum install git -y </span></span><br><span class="line"></span><br><span class="line">下载克隆此项目</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># git clone 项目链接</span></span><br><span class="line"></span><br><span class="line">修改完项目上传</span><br><span class="line"></span><br><span class="line">  在<span class="built_in">clone</span>下来的项目的目录下，先添加到本地的暂停区</span><br><span class="line"></span><br><span class="line">  项目目录]<span class="comment"># git add  添加的文件/目录/.代表当前目录下的所有的文件</span></span><br><span class="line"></span><br><span class="line">  上传到github</span><br><span class="line"></span><br><span class="line">  项目目录]<span class="comment"># git commit -m "自定义标签"</span></span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">演示执行命令</span><br><span class="line"></span><br><span class="line">  root@jenkins:/<span class="built_in">source</span><span class="comment"># git clone http://192.168.8.3/test-service/test-project.git</span></span><br><span class="line">  Cloning into <span class="string">'test-project'</span>...</span><br><span class="line">  Username <span class="keyword">for</span> <span class="string">'http://192.168.8.3'</span>: jack</span><br><span class="line">  Password <span class="keyword">for</span> <span class="string">'http://jack@192.168.8.3'</span>: </span><br><span class="line">  remote: Enumerating objects: 3, <span class="keyword">done</span>.</span><br><span class="line">  remote: Counting objects: 100% (3/3), <span class="keyword">done</span>.</span><br><span class="line">  remote: Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">  Unpacking objects: 100% (3/3), <span class="keyword">done</span>.</span><br><span class="line">  root@jenkins:/<span class="built_in">source</span><span class="comment"># cat  test-project/index.html </span></span><br><span class="line">  &lt;h1&gt;11111111111&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">  编辑文件并测试提交：</span><br><span class="line"></span><br><span class="line">  root@jenkins:/<span class="built_in">source</span><span class="comment"># cd 项目目录/</span></span><br><span class="line">  root@jenkins:/<span class="built_in">source</span>/项目目录<span class="comment"># git config --global user.name "jack"</span></span><br><span class="line">  root@jenkins:/<span class="built_in">source</span>/项目目录<span class="comment"># git config --global user.email 2973707860@qq.com</span></span><br><span class="line">  root@jenkins:/<span class="built_in">source</span>/项目目录<span class="comment"># vim index.html </span></span><br><span class="line">  root@jenkins:/<span class="built_in">source</span>/项目目录<span class="comment"># cat index.html </span></span><br><span class="line">  &lt;h1&gt;11111111111&lt;/h1&gt;</span><br><span class="line">  &lt;h1&gt;22222222222&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">  root@jenkins:/<span class="built_in">source</span>/项目目录<span class="comment"># git add index.html </span></span><br><span class="line">  root@jenkins:/<span class="built_in">source</span>/项目目录<span class="comment"># git commit -m "v1"</span></span><br></pre></td></tr></table></figure><p>3：上传</p><p><img src="/2019/03/10/git常用命令及wab环境准备/31.png" alt=""></p><p>4：github验证数据</p><p><img src="/2019/03/10/git常用命令及wab环境准备/30.png" alt=""></p><hr><h2 id="三、将gitlab上创建的项目下载到本地"><a href="#三、将gitlab上创建的项目下载到本地" class="headerlink" title="三、将gitlab上创建的项目下载到本地"></a>三、将gitlab上创建的项目下载到本地</h2><p>1：使用git命令下载（http协议）</p><p><img src="/2019/03/10/git常用命令及wab环境准备/32.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">下载克隆此项目</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cd /data/</span></span><br><span class="line">  data]<span class="comment"># git clone http://172.18.135.1/group1/project1.git</span></span><br><span class="line">  Cloning into <span class="string">'project1'</span>...</span><br><span class="line">  Username <span class="keyword">for</span> <span class="string">'http://172.18.135.1'</span>: daizhe</span><br><span class="line">  Password <span class="keyword">for</span> <span class="string">'http://daizhe@172.18.135.1'</span>: </span><br><span class="line">  remote: Enumerating objects: 3, <span class="keyword">done</span>.</span><br><span class="line">  remote: Counting objects: 100% (3/3), <span class="keyword">done</span>.</span><br><span class="line">  remote: Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">  Unpacking objects: 100% (3/3), <span class="keyword">done</span>.</span><br></pre></td></tr></table></figure><p>2：查看下载下来的项目<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">下载下来的目录是以项目名称命名的</span><br><span class="line"></span><br><span class="line">  data]<span class="comment"># ls</span></span><br><span class="line">  project1</span><br><span class="line">  data]<span class="comment"># cd project1/</span></span><br><span class="line">  project1]<span class="comment"># ls</span></span><br><span class="line">  README.md</span><br><span class="line">  project1]<span class="comment"># cat README.md </span></span><br><span class="line">  <span class="comment"># 一级标题</span></span><br><span class="line">  <span class="comment">## 二级标题</span></span><br></pre></td></tr></table></figure></p><p>3：修改项目内容并上传<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">修改项目内容</span><br><span class="line"></span><br><span class="line">  project1]<span class="comment"># vim README.md </span></span><br><span class="line">  <span class="comment"># 一级标题</span></span><br><span class="line">  <span class="comment">## 二级标题</span></span><br><span class="line">  <span class="comment">### 三级标题</span></span><br></pre></td></tr></table></figure></p><p>4：上传至Gitlab<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">先添加到本地的暂停区</span><br><span class="line"></span><br><span class="line">project1]<span class="comment"># git add README.md </span></span><br><span class="line"></span><br><span class="line">上传至Gitlab</span><br><span class="line"></span><br><span class="line">project1]<span class="comment"># git commit -m "v1"</span></span><br><span class="line">[master dd12ca1] v1</span><br><span class="line">Committer: root &lt;root@centos7.com&gt;</span><br><span class="line">Your name and email address were configured automatically based</span><br><span class="line">on your username and hostname. Please check that they are accurate.</span><br><span class="line">You can suppress this message by setting them explicitly:</span><br><span class="line"></span><br><span class="line">  git config --global user.name <span class="string">"Your Name"</span></span><br><span class="line">  git config --global user.email you@example.com</span><br><span class="line"></span><br><span class="line">After doing this, you may fix the identity used <span class="keyword">for</span> this commit with:</span><br><span class="line"></span><br><span class="line">  git commit --amend --reset-author</span><br><span class="line"></span><br><span class="line"> 1 file changed, 2 insertions(+), 1 deletion(-)</span><br><span class="line"></span><br><span class="line">project1]<span class="comment"># git push</span></span><br><span class="line">warning: push.default is <span class="built_in">unset</span>; its implicit value is changing <span class="keyword">in</span></span><br><span class="line">Git 2.0 from <span class="string">'matching'</span> to <span class="string">'simple'</span>. To squelch this message</span><br><span class="line">and maintain the current behavior after the default changes, use:</span><br><span class="line"></span><br><span class="line">git config --global push.default matching</span><br><span class="line"></span><br><span class="line">To squelch this message and adopt the new behavior now, use:</span><br><span class="line"></span><br><span class="line">git config --global push.default simple</span><br><span class="line"></span><br><span class="line">See <span class="string">'git help config'</span> and search <span class="keyword">for</span> <span class="string">'push.default'</span> <span class="keyword">for</span> further information.</span><br><span class="line">(the <span class="string">'simple'</span> mode was introduced <span class="keyword">in</span> Git 1.7.11. Use the similar mode</span><br><span class="line"><span class="string">'current'</span> instead of <span class="string">'simple'</span> <span class="keyword">if</span> you sometimes use older versions of Git)</span><br><span class="line"></span><br><span class="line">Username <span class="keyword">for</span> <span class="string">'http://172.18.135.1'</span>: daizhe</span><br><span class="line">Password <span class="keyword">for</span> <span class="string">'http://daizhe@172.18.135.1'</span>: </span><br><span class="line">Counting objects: 5, <span class="keyword">done</span>.</span><br><span class="line">Writing objects: 100% (3/3), 256 bytes | 0 bytes/s, <span class="keyword">done</span>.</span><br><span class="line">Total 3 (delta 0), reused 0 (delta 0)</span><br><span class="line">To http://172.18.135.1/group1/project1.git</span><br><span class="line"> a259ec8..dd12ca1  master -&gt; master</span><br></pre></td></tr></table></figure></p><p>4：Gitlab服务端进行验证是否已经上传成功</p><p><img src="/2019/03/10/git常用命令及wab环境准备/33.png" alt=""></p><p>5：在命令行本地添加一个测试页面<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">编写测试页面</span><br><span class="line"></span><br><span class="line">  project1]<span class="comment"># vim index.html</span></span><br><span class="line"></span><br><span class="line">  &lt;!DOCTYPE html&gt;</span><br><span class="line">  &lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">        &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">        &lt;title&gt;你好代哲&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;h1&gt;测试页面 v1&lt;/h1&gt;</span><br><span class="line">  &lt;h1&gt;&lt;/h1&gt;</span><br><span class="line">  &lt;/html&gt;</span><br><span class="line"></span><br><span class="line">上传至gitlab</span><br><span class="line"></span><br><span class="line">  project1]<span class="comment"># git add .</span></span><br><span class="line">  project1]<span class="comment"># git commit -m "v1"</span></span><br><span class="line">  project1]<span class="comment"># git push</span></span><br></pre></td></tr></table></figure></p><p>6：在gitlab 页面验证是否已经上传<br><img src="/2019/03/10/git常用命令及wab环境准备/34.png" alt=""></p><h2 id="四、gitlab-分支操作"><a href="#四、gitlab-分支操作" class="headerlink" title="四、gitlab 分支操作"></a>四、gitlab 分支操作</h2><ul><li>分支：命名空间上的一个隔离<ul><li>默认情况下全是对master上的操作</li></ul></li></ul><p>1：项目中创建一个新的分支（此分支适用于开发上传的代码先在测试环境测试，测试完成无误后在合并到master分支）<br><img src="/2019/03/10/git常用命令及wab环境准备/35.png" alt=""><br><img src="/2019/03/10/git常用命令及wab环境准备/36.png" alt=""></p><p>2：验证测试的develop分支是否创建成功<br><img src="/2019/03/10/git常用命令及wab环境准备/36.png" alt=""></p><p>3：客户端继续编写测试的项目，并上传到develop分支上<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">克隆一下gitlab上的develop分支</span><br><span class="line">  -b选项指定分支，如果不指定，默认的情况下为master分支</span><br><span class="line"></span><br><span class="line">  data]<span class="comment"># git clone -b develop http://172.18.135.1/group1/project1.git</span></span><br><span class="line">  Cloning into <span class="string">'project1'</span>...</span><br><span class="line">  Username <span class="keyword">for</span> <span class="string">'http://172.18.135.1'</span>: daizhe</span><br><span class="line">  Password <span class="keyword">for</span> <span class="string">'http://daizhe@172.18.135.1'</span>: </span><br><span class="line">  remote: Enumerating objects: 11, <span class="keyword">done</span>.</span><br><span class="line">  remote: Counting objects: 100% (11/11), <span class="keyword">done</span>.</span><br><span class="line">  remote: Compressing objects: 100% (6/6), <span class="keyword">done</span>.</span><br><span class="line">  remote: Total 11 (delta 0), reused 0 (delta 0)</span><br><span class="line">  Unpacking objects: 100% (11/11), <span class="keyword">done</span>.</span><br><span class="line"></span><br><span class="line">编辑新的测试版本</span><br><span class="line"></span><br><span class="line">  data]<span class="comment"># ls</span></span><br><span class="line">  project1</span><br><span class="line">  project1]<span class="comment"># ls</span></span><br><span class="line">  index.html</span><br><span class="line">  project1]<span class="comment"># vim index.html </span></span><br><span class="line"></span><br><span class="line">  &lt;!DOCTYPE html&gt;</span><br><span class="line">  &lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">        &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">        &lt;title&gt;你好代哲&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;h1&gt;测试页面 v1&lt;/h1&gt;</span><br><span class="line">  &lt;h1&gt;测试页面 v2&lt;/h1&gt;</span><br><span class="line">  &lt;/html&gt;</span><br><span class="line"></span><br><span class="line">上传到gitlab的develop测试分支</span><br><span class="line"></span><br><span class="line">  project1]<span class="comment"># git add .</span></span><br><span class="line">  project1]<span class="comment"># git commit -m "v2"</span></span><br><span class="line">  project1]<span class="comment"># git push</span></span><br></pre></td></tr></table></figure></p><p>4：gitlab查看develop测试分支是否成功上传新的测试页面<br><img src="/2019/03/10/git常用命令及wab环境准备/38.png" alt=""></p><h2 id="五、git常用命令"><a href="#五、git常用命令" class="headerlink" title="五、git常用命令"></a>五、git常用命令</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">git config --global user.name “name“ <span class="comment">#设置全局用户名 </span></span><br><span class="line">git config --global user.email xxx@xx.com <span class="comment">#设置全局邮箱</span></span><br><span class="line">git config --global –list <span class="comment">#列出用户全局设置</span></span><br><span class="line">git add index.html / . <span class="comment">#添加指定文件、目录或当前目录下所有数据到暂存区</span></span><br><span class="line">git commit -m “11“ <span class="comment">#提交文件到工作区</span></span><br><span class="line">git status <span class="comment">#查看工作区的状态</span></span><br><span class="line">git push <span class="comment">#提交代码到服务器</span></span><br><span class="line">git pull <span class="comment">#获取代码到本地</span></span><br><span class="line">git <span class="built_in">log</span> <span class="comment">#查看操作日志</span></span><br><span class="line">vim .gitignore <span class="comment">#定义忽略文件</span></span><br><span class="line">git reset --hard HEAD^^ <span class="comment">#git版本回滚， HEAD为当前版本，加一个^为上一个，^^为上上一个版本</span></span><br><span class="line">git reflog <span class="comment"># #获取每次提交的ID，可以使用--hard根据提交的ID进行版本回退</span></span><br><span class="line">git reset --hard 5ae4b06 <span class="comment">#回退到指定id的版本</span></span><br><span class="line"><span class="comment"># git branch #查看当前所处的分支</span></span><br><span class="line"><span class="comment">#git checkout  -b develop #创建并切换到一个新分支</span></span><br><span class="line"><span class="comment">#git checkout   develop #切换分支</span></span><br></pre></td></tr></table></figure><p>1：设置全局的用户名和邮箱地址<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">在克隆的项目下有一个隐藏的文件</span><br><span class="line"></span><br><span class="line">  project1]<span class="comment"># pwd</span></span><br><span class="line">  /data/project1</span><br><span class="line">  project1]<span class="comment"># ls -a</span></span><br><span class="line">  .git    <span class="comment">#保存的配置信息</span></span><br><span class="line">  project1]<span class="comment"># vim .git/config  #这也是在git push时不用指定gitlab服务器的地址直接给上传到gitlab上的原因</span></span><br><span class="line">  [core]</span><br><span class="line">        repositoryformatversion = 0</span><br><span class="line">        filemode = <span class="literal">true</span></span><br><span class="line">        bare = <span class="literal">false</span></span><br><span class="line">        logallrefupdates = <span class="literal">true</span></span><br><span class="line">  [remote <span class="string">"origin"</span>]</span><br><span class="line">        url = http://172.18.135.1/group1/project1.git</span><br><span class="line">        fetch = +refs/heads/*:refs/remotes/origin/*</span><br><span class="line">  [branch <span class="string">"develop"</span>]</span><br><span class="line">        remote = origin</span><br><span class="line">        merge = refs/heads/develop</span><br><span class="line"></span><br><span class="line">设置全局的用户和邮箱（指定以下命令需要在项目目录下）</span><br><span class="line"></span><br><span class="line">  project1]<span class="comment"># git config --global user.name "daizhe"</span></span><br><span class="line">  project1]<span class="comment"># git config --global user.email "1284808408@qq.com"</span></span><br><span class="line">  project1]<span class="comment"># git config --global --list</span></span><br><span class="line">  user.name=daizhe</span><br><span class="line">  user.email=1284808408@qq.com</span><br></pre></td></tr></table></figure></p><p>2：查看当前工作目录的状态信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">project1]<span class="comment"># git status</span></span><br><span class="line"><span class="comment"># On branch develop</span></span><br><span class="line">nothing to commit, working directory clean</span><br><span class="line"></span><br><span class="line">project1]<span class="comment"># vim index.html </span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">      &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">      &lt;title&gt;你好代哲&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;测试页面 v1&lt;/h1&gt;</span><br><span class="line">&lt;h1&gt;测试页面 v2&lt;/h1&gt;</span><br><span class="line">&lt;h1&gt;测试页面 v3&lt;/h1&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line"></span><br><span class="line">project1]<span class="comment"># git add index.html</span></span><br><span class="line">project1]<span class="comment"># git status</span></span><br><span class="line"><span class="comment"># On branch develop</span></span><br><span class="line"><span class="comment"># Changes to be committed:</span></span><br><span class="line"><span class="comment">#   (use "git reset HEAD &lt;file&gt;..." to unstage)</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#modified:   index.html</span></span><br><span class="line"><span class="comment">#</span></span><br></pre></td></tr></table></figure></p><p>3：获取代码到本地<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">project1]<span class="comment"># git pull</span></span><br><span class="line">Username <span class="keyword">for</span> <span class="string">'http://172.18.135.1'</span>: daizhe</span><br><span class="line">Password <span class="keyword">for</span> <span class="string">'http://daizhe@172.18.135.1'</span>: </span><br><span class="line">Already up-to-date. <span class="comment">#显示当前代码为最新的</span></span><br></pre></td></tr></table></figure></p><p>4：查看操作历史记录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">project1]<span class="comment"># git log</span></span><br><span class="line">commit 67c23338f9305ff655d6820b1f011e84727d9663</span><br><span class="line">Author: root &lt;root@centos7.com&gt;</span><br><span class="line">Date:   Tue Mar 12 13:37:11 2019 +0800</span><br><span class="line"></span><br><span class="line">  v2</span><br><span class="line"></span><br><span class="line">commit b348f8abf5f7870ac25cd9072e1bfd5359fb21b5</span><br><span class="line">Author: daizhe &lt;1284808408@qq.com&gt;</span><br><span class="line">Date:   Tue Mar 12 13:23:00 2019 +0800  <span class="comment">#操作的时间</span></span><br><span class="line"></span><br><span class="line">  Delete README.md    <span class="comment">#操作的文件</span></span><br><span class="line"></span><br><span class="line">commit 8a388405bd4f517eac2d6144466aef897f2de30d</span><br><span class="line">Author: root &lt;root@centos7.com&gt;</span><br><span class="line">Date:   Tue Mar 12 13:20:45 2019 +0800</span><br></pre></td></tr></table></figure></p><p>5：版本回滚</p><p>比如说现在的代码版本已经到了v3了<br><img src="/2019/03/10/git常用命令及wab环境准备/39.png" alt=""></p><p>从v3回滚到v2版本（HEAD^ ：代表当前版本的前上一个版本、HEAD^^ : 回滚到当前版本的前两个版本）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">回滚到上一个版本</span><br><span class="line"></span><br><span class="line">  project1]<span class="comment"># git reset --hard HEAD^</span></span><br><span class="line">  HEAD is now at 67c2333 v2</span><br><span class="line"></span><br><span class="line">  验证本地客户端是否已经混滚到上一个版本</span><br><span class="line"></span><br><span class="line">  project1]<span class="comment"># vim index.html </span></span><br><span class="line">  &lt;!DOCTYPE html&gt;</span><br><span class="line">  &lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">        &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">        &lt;title&gt;你好代哲&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;h1&gt;测试页面 v1&lt;/h1&gt;</span><br><span class="line">  &lt;h1&gt;测试页面 v2&lt;/h1&gt;</span><br><span class="line">  &lt;/html&gt;</span><br></pre></td></tr></table></figure></p><p>6：可以回滚到gitlab指定的版本号</p><p>什么是版本号<br><img src="/2019/03/10/git常用命令及wab环境准备/40.png" alt=""></p><p>根据指定的版本号克隆回滚<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">project1]<span class="comment"># git reset --hard 7aeb57e677633c4e7b80058c1acd525637633f52</span></span><br><span class="line">HEAD is now at 7aeb57e v3</span><br><span class="line"></span><br><span class="line">project1]<span class="comment"># vim index.html </span></span><br><span class="line">&lt;!DOCTYPE html&gt;</span><br><span class="line">&lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">&lt;head&gt;</span><br><span class="line">      &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">      &lt;title&gt;你好代哲&lt;/title&gt;</span><br><span class="line">&lt;/head&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;h1&gt;测试页面 v1&lt;/h1&gt;</span><br><span class="line">&lt;h1&gt;测试页面 v2&lt;/h1&gt;</span><br><span class="line">&lt;h1&gt;测试页面 v3&lt;/h1&gt;</span><br><span class="line">&lt;/html&gt;</span><br></pre></td></tr></table></figure></p><p>7：分支相关的操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">查看当前所处的分支</span><br><span class="line"></span><br><span class="line">  project1]<span class="comment"># git branch</span></span><br><span class="line">  * develop</span><br><span class="line"></span><br><span class="line">切换到项目的master分支</span><br><span class="line"></span><br><span class="line">  project1]<span class="comment"># git checkout master</span></span><br><span class="line">  Branch master <span class="built_in">set</span> up to track remote branch master from origin.</span><br><span class="line">  Switched to a new branch <span class="string">'master'</span></span><br><span class="line">  project1]<span class="comment"># git branch</span></span><br><span class="line">      develop</span><br><span class="line">    * master    <span class="comment">#切换到master就可以将客户端本地的代码上传到master分支上了（前提是在测试端已经测试通过的代码）</span></span><br><span class="line"></span><br><span class="line">创建新的分支并切换到此分支</span><br><span class="line"></span><br><span class="line">  project1]<span class="comment"># git checkout  -b develop #创建并切换到一个新分支</span></span><br></pre></td></tr></table></figure></p><h1 id="Web环境准备"><a href="#Web环境准备" class="headerlink" title="Web环境准备"></a>Web环境准备</h1><p><img src="/2019/03/10/git常用命令及wab环境准备/41.png" alt=""></p><h2 id="一、安装两台tomcat作为后端的web服务器"><a href="#一、安装两台tomcat作为后端的web服务器" class="headerlink" title="一、安装两台tomcat作为后端的web服务器"></a>一、安装两台tomcat作为后端的web服务器</h2><p>1：二进制安装java 8环境（JDK）</p><p><img src="/2019/03/10/git常用命令及wab环境准备/42.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">两台tomcat的jdk的安装步骤相同</span><br><span class="line"></span><br><span class="line">标准化目录规划</span><br><span class="line">  web应用路劲/apps  <span class="comment">#运行身份为tomcat，运行java不可使用root用户运行</span></span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># ls</span></span><br><span class="line">  dk-8u192-linux-x64.tar.gz</span><br><span class="line"></span><br><span class="line">创建应用放置路径</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># mkdir /apps </span></span><br><span class="line">  ~]<span class="comment"># mv jdk-8u192-linux-x64.tar.gz /apps</span></span><br><span class="line"></span><br><span class="line">创建运行tomcat的用户</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># useradd tomcat -u 2001</span></span><br><span class="line">  ~]<span class="comment"># passwd tomcat   #设置密码  （强制删除用户命令 userdel -rf user）</span></span><br><span class="line"></span><br><span class="line">解压jdk</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cd /apps/</span></span><br><span class="line">  apps]<span class="comment"># tar xvf jdk-8u192-linux-x64.tar.gz </span></span><br><span class="line"></span><br><span class="line">设置环境变量</span><br><span class="line"></span><br><span class="line">  apps]<span class="comment">#  vim /etc/profile</span></span><br><span class="line">  最后面添加</span><br><span class="line">  <span class="built_in">export</span> HISTTIMEFORMAT=<span class="string">"%F %T `whoami` "</span></span><br><span class="line">  <span class="built_in">export</span> <span class="built_in">export</span> LANG=<span class="string">"en_US.utf-8"</span></span><br><span class="line">  <span class="built_in">export</span> JAVA_HOME=/apps/jdk</span><br><span class="line">  <span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/jre/lib/rt.jar:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line">  <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line"></span><br><span class="line">  apps]<span class="comment"># source /etc/profile</span></span><br><span class="line"></span><br><span class="line">为了方便升级JDK制作软连接</span><br><span class="line"></span><br><span class="line">  apps]<span class="comment"># ln -sv /apps/jdk1.8.0_192/ /apps/jdk</span></span><br><span class="line"></span><br><span class="line">验证是否已经安装java环境</span><br><span class="line"></span><br><span class="line">  apps]<span class="comment"># java -version</span></span><br><span class="line">  java version <span class="string">"1.8.0_192"</span></span><br><span class="line">  Java(TM) SE Runtime Environment (build 1.8.0_192-b12)</span><br><span class="line">  Java HotSpot(TM) 64-Bit Server VM (build 25.192-b12, mixed mode)</span><br></pre></td></tr></table></figure><p>2：二进制安装tomcat（版本为8.5.37）</p><p>版本下载站点：<a href="http://mirrors.shu.edu.cn/apache/tomcat/" target="_blank" rel="noopener">http://mirrors.shu.edu.cn/apache/tomcat/</a></p><p><img src="/2019/03/10/git常用命令及wab环境准备/43.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">两台tomcat的安装步骤相同</span><br><span class="line"></span><br><span class="line">上传</span><br><span class="line"></span><br><span class="line">  apps]<span class="comment"># pwd</span></span><br><span class="line">  /apps</span><br><span class="line">  apps]<span class="comment"># ls</span></span><br><span class="line">  apache-tomcat-8.5.37.tar.gz</span><br><span class="line"></span><br><span class="line">解压</span><br><span class="line"></span><br><span class="line">  apps]<span class="comment"># tar xvf apache-tomcat-8.5.37.tar.gz </span></span><br><span class="line"></span><br><span class="line">制作软链接</span><br><span class="line"></span><br><span class="line">  apps]<span class="comment"># ln -sv /apps/apache-tomcat-8.5.37/ /apps/tomcat</span></span><br></pre></td></tr></table></figure><p>手动测试启动tomcat<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /apps/tomcat/bin/catalina.sh start</span></span><br></pre></td></tr></table></figure></p><p>tomcatA<br><img src="/2019/03/10/git常用命令及wab环境准备/44.png" alt=""></p><p>tomcatB<br><img src="/2019/03/10/git常用命令及wab环境准备/45.png" alt=""></p><h2 id="二、tomcat各服务器上创建数据目录"><a href="#二、tomcat各服务器上创建数据目录" class="headerlink" title="二、tomcat各服务器上创建数据目录"></a>二、tomcat各服务器上创建数据目录</h2><ul><li>代码路径标准化<ul><li>/data/tomcat_webdir : 存放解压完后的应用程序</li><li>/data/tomcat_appdir : 存放远程服务器发来的打包文件</li></ul></li></ul><p>1：创建数据目录及项目目录、测试文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">创建数据目录</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># mkdir -pv /data/tomcat_webdir /data/tomcat_appdir</span></span><br><span class="line"></span><br><span class="line">编辑tomcatA和tomcatB各主机的配置文件</span><br><span class="line"></span><br><span class="line">  修改tomcat服务器的应用路径：/data/tomcat_webdir</span><br><span class="line">  打算在/data/tomcat_webdir放置项目名称</span><br><span class="line">  禁用自动解压、自动部署（unpackWARs=<span class="string">"true"</span> autoDeploy=<span class="string">"true"</span>&gt;）</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /apps/tomcat/conf/server.xml </span></span><br><span class="line">  148       &lt;Host name=<span class="string">"localhost"</span>  :appBase=<span class="string">"/data/tomcat_webdir"</span></span><br><span class="line">  149             unpackWARs=<span class="string">"false"</span> autoDeploy=<span class="string">"false"</span>&gt;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建项目目录及项目文件</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># mkdir /data/tomcat_webdir/myapp</span></span><br><span class="line"></span><br><span class="line">  TomcatA 的测试项目文件</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /data/tomcat_webdir/myapp/index.html</span></span><br><span class="line">  &lt;!DOCTYPE html&gt;</span><br><span class="line">  &lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">        &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">        &lt;title&gt;Tomcat A&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;h1&gt;Tomcat A v1&lt;/h1&gt;</span><br><span class="line">  &lt;h1&gt;&lt;/h1&gt;</span><br><span class="line">  &lt;/html&gt;</span><br><span class="line"></span><br><span class="line">  TomcatB 的测试项目文件</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /data/tomcat_webdir/myapp/index.html</span></span><br><span class="line">  &lt;!DOCTYPE html&gt;</span><br><span class="line">  &lt;html lang=<span class="string">"en"</span>&gt;</span><br><span class="line">  &lt;head&gt;</span><br><span class="line">        &lt;meta charset=<span class="string">"UTF-8"</span>&gt;</span><br><span class="line">        &lt;title&gt;Tomcat B&lt;/title&gt;</span><br><span class="line">  &lt;/head&gt;</span><br><span class="line">  &lt;body&gt;</span><br><span class="line">  &lt;h1&gt;Tomcat B v1&lt;/h1&gt;</span><br><span class="line">  &lt;h1&gt;&lt;/h1&gt;</span><br><span class="line">  &lt;/html&gt;</span><br></pre></td></tr></table></figure></p><p>2：先以root用户测试启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">两台tomcat A/B 都要启动测试</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># /apps/tomcat/bin/catalina.sh stop</span></span><br><span class="line">  ~]<span class="comment"># /apps/tomcat/bin/catalina.sh start</span></span><br></pre></td></tr></table></figure></p><p>3：web界面访问测试<br><img src="/2019/03/10/git常用命令及wab环境准备/46.png" alt=""></p><p>4：tomcatA/B 各tomcat服务器 ，停掉tomcat修改为以普通用户启动tomcat<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">停掉tomcat</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># /apps/tomcat/bin/catalina.sh stop</span></span><br><span class="line"></span><br><span class="line">修改权限</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># chown tomcat.tomcat /data/ /apps/ -R</span></span><br></pre></td></tr></table></figure></p><p>使用脚本启动tomcat<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cat /etc/init.d/tomcat </span></span><br><span class="line"><span class="comment">#!/bin/bash：</span></span><br><span class="line"><span class="comment"># #########################################################</span></span><br><span class="line"><span class="comment"># Tomcat init script for     "代哲编写"####</span></span><br><span class="line"><span class="comment">###########################################################</span></span><br><span class="line"><span class="comment"># chkconfig: 2345 96 14 ###################################</span></span><br><span class="line"><span class="comment"># description: 2018/11/1. 代哲##########################</span></span><br><span class="line"><span class="comment"># #########################################################</span></span><br><span class="line"></span><br><span class="line">JDK_HOME=/apps/jdk</span><br><span class="line">CATALINA_HOME=/apps/tomcat</span><br><span class="line"><span class="built_in">export</span> JDK_HOME CATALINA_HOME</span><br><span class="line"><span class="built_in">source</span> /etc/profile</span><br><span class="line"><span class="comment">#PID=`ps -ef  | grep  -v grep  | grep java | awk  '&#123;print $2&#125;'`</span></span><br><span class="line"><span class="comment">#NUM=`ps -ef  | grep  -v grep  | grep java | awk  '&#123;print $2&#125;' | wc -l`</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#case $1 in</span></span><br><span class="line"><span class="function"><span class="title">start</span></span>() &#123;</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"正在判断服务状态，请稍等！"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"请稍等3秒钟"</span></span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"3"</span>;sleep 1;<span class="built_in">echo</span> <span class="string">"2"</span>;sleep 1;<span class="built_in">echo</span> <span class="string">"1"</span>;sleep 1</span><br><span class="line">   <span class="keyword">if</span>netstat -an | grep 8080 | grep LISTEN &gt;/dev/null</span><br><span class="line">     <span class="keyword">then</span></span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"Tomcat已经正在运行了！"</span>  </span><br><span class="line">  <span class="keyword">else</span> </span><br><span class="line">   <span class="built_in">echo</span> <span class="string">"Tomcat没有运行，1秒后启动！"</span></span><br><span class="line"><span class="built_in">echo</span> 1;sleep 1  </span><br><span class="line">  <span class="variable">$CATALINA_HOME</span>/bin/catalina.sh start </span><br><span class="line">  <span class="built_in">echo</span>  <span class="string">"Tomcat 已经成功启动完成,5秒后判断是否启动成功"</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="string">"5"</span>;sleep 1;<span class="built_in">echo</span> <span class="string">"4"</span>;sleep 1</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"3"</span>;sleep 1;<span class="built_in">echo</span> <span class="string">"2"</span>;sleep 1;<span class="built_in">echo</span> <span class="string">"1"</span>;sleep 1</span><br><span class="line"><span class="keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null</span><br><span class="line">    <span class="keyword">then</span></span><br><span class="line">PID=`ps -ef | grep  tomcat | grep jdk | awk <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">NUM=`ps -ef | grep  tomcat | grep jdk | awk <span class="string">'&#123;print $2&#125;'</span> | wc -l`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Tomcat 已经成功启动<span class="variable">$&#123;NUM&#125;</span> 个Tomcat进程!,PID为<span class="variable">$&#123;PID&#125;</span>"</span></span><br><span class="line">    <span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Tomcat启动失败，请重新启动！"</span></span><br><span class="line">        <span class="built_in">echo</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"> <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">stop</span></span>() &#123;</span><br><span class="line">PID=`ps -ef  | grep  -v grep  | grep java | awk  <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">NUM=`ps -ef | grep  -v <span class="string">"color"</span>  | grep tomcat | awk <span class="string">'&#123;print $2&#125;'</span> | wc -l`</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"正在判断服务状态，请稍等3秒钟！"</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"3"</span>;sleep 1;<span class="built_in">echo</span> <span class="string">"2"</span>;sleep 1;<span class="built_in">echo</span> <span class="string">"1"</span>;sleep 1</span><br><span class="line"><span class="keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null </span><br><span class="line">   <span class="keyword">then</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Tomcat运行中，1秒后关闭！"</span></span><br><span class="line"><span class="built_in">echo</span>  1;sleep 1 </span><br><span class="line"><span class="built_in">echo</span> <span class="string">"即将关闭Tomcat服务，请稍等！"</span> </span><br><span class="line">        <span class="variable">$CATALINA_HOME</span>/bin/catalina.sh stop ;<span class="built_in">echo</span> <span class="string">"已经执行关闭命令,正在检查关闭了多少Tomcat进程，请稍等30秒钟！"</span></span><br><span class="line">sleep 8</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"3"</span>;sleep 1;<span class="built_in">echo</span> <span class="string">"2"</span>;sleep 1;<span class="built_in">echo</span> <span class="string">"1"</span>;sleep 1</span><br><span class="line">pkill java &amp;&amp; pkill tomcat</span><br><span class="line"><span class="keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null;<span class="keyword">then</span></span><br><span class="line">PID=`ps -ef  | grep  -v grep  | grep java | awk  <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">NUM=`ps -ef | grep  -v <span class="string">"color"</span>  | grep tomcat | awk <span class="string">'&#123;print $2&#125;'</span> | wc -l`</span><br><span class="line"><span class="built_in">kill</span> -9 <span class="variable">$PID</span> ;<span class="built_in">echo</span> <span class="string">"已成功关闭<span class="variable">$&#123;NUM&#125;</span> 个tomcat进程"</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">  <span class="built_in">echo</span>  <span class="string">"Tomcat 已经关闭完成！"</span> </span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"3"</span>;sleep 1;<span class="built_in">echo</span> <span class="string">"2"</span>;sleep 1;<span class="built_in">echo</span> <span class="string">"1"</span>;sleep 1 </span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">else</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"Tomcat 没有运行"</span></span><br><span class="line"><span class="built_in">echo</span> 1</span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null;<span class="keyword">then</span></span><br><span class="line">            PID=`ps -ef  | grep  -v grep  | grep java | awk  <span class="string">'&#123;print $2&#125;'</span>`</span><br><span class="line">            <span class="comment">#NUM=`ps -ef | grep  -v "color"  | grep tomcat | awk '&#123;print $2&#125;' | wc -l`</span></span><br><span class="line">            <span class="built_in">echo</span> <span class="string">"关闭失败，即将强制删除tomcat进程!"</span></span><br><span class="line">            sleep 2</span><br><span class="line">            pkill tomcat ;sleep 2 </span><br><span class="line">            <span class="keyword">if</span>  netstat -an | grep 8080 | grep LISTEN &gt;/dev/null;<span class="keyword">then</span></span><br><span class="line">                <span class="built_in">echo</span> <span class="string">"强制关闭失败，即将再次强制删除tomcat进程!"</span></span><br><span class="line">                pkill java; sleep 2</span><br><span class="line">            <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"><span class="function"><span class="title">restart</span></span>() &#123;</span><br><span class="line">stop </span><br><span class="line">start </span><br><span class="line"> &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="string">"<span class="variable">$1</span>"</span> <span class="keyword">in</span> </span><br><span class="line">start) </span><br><span class="line">start </span><br><span class="line">;; </span><br><span class="line"></span><br><span class="line">stop) </span><br><span class="line">stop </span><br><span class="line">;; </span><br><span class="line"></span><br><span class="line">restart) </span><br><span class="line">restart </span><br><span class="line">;; </span><br><span class="line"></span><br><span class="line">*) </span><br><span class="line"><span class="built_in">echo</span> $<span class="string">"Usage: <span class="variable">$0</span> &#123;start|stop|restart|status&#125;"</span> </span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># chmod a+x /etc/init.d/tomcat</span></span><br></pre></td></tr></table></figure></p><p>切换tomcat普通用户启动tomcat<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># su - tomcat</span></span><br><span class="line">~]$ bash /etc/init.d/tomcat start</span><br><span class="line">正在判断服务状态，请稍等！</span><br><span class="line">请稍等3秒钟</span><br><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br><span class="line">Tomcat没有运行，1秒后启动！</span><br><span class="line">1</span><br><span class="line">Using CATALINA_BASE:   /apps/tomcat</span><br><span class="line">Using CATALINA_HOME:   /apps/tomcat</span><br><span class="line">Using CATALINA_TMPDIR: /apps/tomcat/temp</span><br><span class="line">Using JRE_HOME:        /apps/jdk</span><br><span class="line">Using CLASSPATH:       /apps/tomcat/bin/bootstrap.jar:/apps/tomcat/bin/tomcat-juli.jar</span><br><span class="line">Tomcat started.</span><br><span class="line">Tomcat 已经成功启动完成,5秒后判断是否启动成功</span><br><span class="line">5</span><br><span class="line">4</span><br><span class="line">3</span><br><span class="line">2</span><br><span class="line">1</span><br><span class="line">Tomcat 已经成功启动2 个Tomcat进程!,PID为3797</span><br><span class="line">3826</span><br></pre></td></tr></table></figure></p><h1 id="LB-HA-负载均衡-高可用-环境部署"><a href="#LB-HA-负载均衡-高可用-环境部署" class="headerlink" title="LB + HA 负载均衡+高可用 环境部署"></a>LB + HA 负载均衡+高可用 环境部署</h1><h2 id="两台机器安装-haproxy-keepalived"><a href="#两台机器安装-haproxy-keepalived" class="headerlink" title="两台机器安装 haproxy+keepalived"></a>两台机器安装 haproxy+keepalived</h2><p>1:安装haproxy+keepalived 实现负载<br><code>`</code>bash<br>使用yum源安装</p><p>  ~]# yum install haproxy keepalived -y</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;git常用命令及wab环境准备&quot;&gt;&lt;a href=&quot;#git常用命令及wab环境准备&quot; class=&quot;headerlink&quot; title=&quot;git常用命令及wab环境准备&quot;&gt;&lt;/a&gt;git常用命令及wab环境准备&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/03/10/git常用命令及wab环境准备/标题.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="jenkins" scheme="https://daizhe.net.cn/categories/jenkins/"/>
    
    
      <category term="jenkins" scheme="https://daizhe.net.cn/tags/jenkins/"/>
    
  </entry>
  
  <entry>
    <title>keepalived加lvs实现高可用</title>
    <link href="https://daizhe.net.cn/2019/03/10/keepalived%E5%8A%A0lvs%E5%AE%9E%E7%8E%B0%E9%AB%98%E5%8F%AF%E7%94%A8/"/>
    <id>https://daizhe.net.cn/2019/03/10/keepalived加lvs实现高可用/</id>
    <published>2019-03-10T03:23:02.467Z</published>
    <updated>2019-03-10T06:40:41.096Z</updated>
    
    <content type="html"><![CDATA[<h1 id="keepalived加lvs实现高可用"><a href="#keepalived加lvs实现高可用" class="headerlink" title="keepalived加lvs实现高可用"></a>keepalived加lvs实现高可用</h1><p><img src="/2019/03/10/keepalived加lvs实现高可用/标题.gif" alt=""><br><a id="more"></a></p><h2 id="tcpdump抓包"><a href="#tcpdump抓包" class="headerlink" title="tcpdump抓包"></a>tcpdump抓包</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># tcpdump -i ens37 -nn host 172.18.135.1</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;keepalived加lvs实现高可用&quot;&gt;&lt;a href=&quot;#keepalived加lvs实现高可用&quot; class=&quot;headerlink&quot; title=&quot;keepalived加lvs实现高可用&quot;&gt;&lt;/a&gt;keepalived加lvs实现高可用&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/03/10/keepalived加lvs实现高可用/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="keepalived" scheme="https://daizhe.net.cn/categories/keepalived/"/>
    
    
      <category term="keepalived" scheme="https://daizhe.net.cn/tags/keepalived/"/>
    
  </entry>
  
  <entry>
    <title>keepalived及haproxy生产负载和高可用应用（编译安装）</title>
    <link href="https://daizhe.net.cn/2019/03/09/keepalived%E5%8F%8Ahaproxy%E7%94%9F%E4%BA%A7%E8%B4%9F%E8%BD%BD%E5%92%8C%E9%AB%98%E5%8F%AF%E7%94%A8%E5%BA%94%E7%94%A8%EF%BC%88%E7%BC%96%E8%AF%91%E5%AE%89%E8%A3%85%EF%BC%89/"/>
    <id>https://daizhe.net.cn/2019/03/09/keepalived及haproxy生产负载和高可用应用（编译安装）/</id>
    <published>2019-03-09T03:07:58.276Z</published>
    <updated>2019-03-09T03:20:45.735Z</updated>
    
    <content type="html"><![CDATA[<h1 id="keepalived配置多vip及实现双主模式"><a href="#keepalived配置多vip及实现双主模式" class="headerlink" title="keepalived配置多vip及实现双主模式"></a>keepalived配置多vip及实现双主模式</h1><p><img src="/2019/03/09/keepalived及haproxy生产负载和高可用应用（编译安装）/标题.gif" alt=""><br><a id="more"></a></p><p>一：在生产环境中haproxy广泛用于四层和七层的反向负载，haproxy则通过VRRP技术实现虚拟IP高可用从而实现haproxy的高可用，本文将侧重于介绍keepalived方面的知识及相关配置介绍，haproxy只用于测试web代理，具体如下：</p><p>1.1：安装haproxy：</p><p>1.1.1：编译安装haproxy：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node137 ~]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line">[root@linux-node137 src]<span class="comment"># wget http://www.haproxy.org/download/1.7/src/haproxy-1.7.3.tar.gz</span></span><br><span class="line">[root@linux-node137 src]<span class="comment"># tar xvf haproxy-1.7.3.tar.gz</span></span><br><span class="line">[root@linux-node137 src]<span class="comment"># cd haproxy-1.7.3/</span></span><br><span class="line">[root@linux-node137 haproxy-1.7.3]<span class="comment">#  yum install gcc pcre pcre-devel openssl  openssl-devel -y</span></span><br><span class="line">[root@linux-node137 haproxy-1.7.3]<span class="comment"># vim README #安装文档及相关帮助信息</span></span><br><span class="line">[root@linux-node137 haproxy-1.7.3]<span class="comment"># make TARGET=linux2628 USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1  PREFIX=/usr/local/haproxy</span></span><br><span class="line">[root@linux-node137 haproxy-1.7.3]<span class="comment"># make install PREFIX=/usr/local/haproxy</span></span><br></pre></td></tr></table></figure></p><p>1.1.2：准备启动脚本文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node137 haproxy-1.7.3]<span class="comment"># vim /usr/lib/systemd/system/haproxy.service</span></span><br><span class="line">[Unit]</span><br><span class="line">Description=HAProxy Load Balancer</span><br><span class="line">After=syslog.target network.target</span><br><span class="line"></span><br><span class="line">[Service]</span><br><span class="line">EnvironmentFile=/etc/sysconfig/haproxy</span><br><span class="line">ExecStart=/usr/sbin/haproxy-systemd-wrapper -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid <span class="variable">$OPTIONS</span></span><br><span class="line">ExecReload=/bin/<span class="built_in">kill</span> -USR2 <span class="variable">$MAINPID</span></span><br><span class="line"></span><br><span class="line">[Install]</span><br><span class="line">WantedBy=multi-user.target</span><br></pre></td></tr></table></figure></p><p>1.1.3：复制启动脚本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node137 haproxy-1.7.3]<span class="comment"># cp haproxy-systemd-wrapper  /usr/sbin/haproxy-systemd-wrapper</span></span><br><span class="line">[root@linux-node137 haproxy-1.7.3]<span class="comment"># cp haproxy /usr/sbin/haproxy</span></span><br></pre></td></tr></table></figure></p><p>1.1.4：准备sysconfig配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node137 haproxy-1.7.3]<span class="comment"># vim /etc/sysconfig/haproxy</span></span><br><span class="line"><span class="comment"># Add extra options to the haproxy daemon here. This can be useful for</span></span><br><span class="line"><span class="comment"># specifying multiple configuration files with multiple -f options.</span></span><br><span class="line"><span class="comment"># See haproxy(1) for a complete list of options.</span></span><br><span class="line">OPTIONS=<span class="string">""</span></span><br></pre></td></tr></table></figure></p><p>1.1.5：主备配置文件，简单配置，后续完善：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node137 haproxy-1.7.3]<span class="comment"># mkdir /etc/haproxy</span></span><br><span class="line">[root@linux-node137 haproxy-1.7.3]<span class="comment"># vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line">global</span><br><span class="line">maxconn 100000</span><br><span class="line">chroot /usr/<span class="built_in">local</span>/haproxy</span><br><span class="line">uid 99</span><br><span class="line">gid 99</span><br><span class="line">daemon</span><br><span class="line">nbproc 1</span><br><span class="line">pidfile /usr/<span class="built_in">local</span>/haproxy/run/haproxy.pid</span><br><span class="line"><span class="built_in">log</span> 127.0.0.1 local3 info</span><br><span class="line"></span><br><span class="line">defaults</span><br><span class="line">option http-keep-alive</span><br><span class="line">option  forwardfor</span><br><span class="line">maxconn 100000</span><br><span class="line">mode http</span><br><span class="line">timeout connect 300000ms</span><br><span class="line">timeout client  300000ms</span><br><span class="line">timeout server  300000ms</span><br><span class="line"></span><br><span class="line">listen stats</span><br><span class="line"> mode http</span><br><span class="line"> <span class="built_in">bind</span> 0.0.0.0:9999</span><br><span class="line"> stats <span class="built_in">enable</span></span><br><span class="line"> <span class="built_in">log</span> global</span><br><span class="line"> stats uri     /haproxy-status</span><br><span class="line"> stats auth    haadmin:q1w2e3r4ys</span><br><span class="line"></span><br><span class="line">listen  web_port</span><br><span class="line"> <span class="built_in">bind</span> 0.0.0.0:80</span><br><span class="line"> mode http</span><br><span class="line"> <span class="built_in">log</span> global</span><br><span class="line"> server web1  172.10.1.238:80  check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure></p><p>1.1.6：启动haproxy:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node137 haproxy-1.7.3]<span class="comment"># systemctl  restart haproxy</span></span><br></pre></td></tr></table></figure></p><p>1.1.7：验证haproxy监听的端口：<br><img src="/2019/03/09/keepalived及haproxy生产负载和高可用应用（编译安装）/1.png" alt=""></p><p>1.1.8：后端web服务器安装http：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@aqdl ~]<span class="comment"># yum install httpd</span></span><br><span class="line">[root@aqdl html]<span class="comment"># echo "Haptoxy Page" &gt; /var/www/html/index.html</span></span><br><span class="line">[root@aqdl ~]<span class="comment"># systemctl  restart httpd</span></span><br></pre></td></tr></table></figure></p><p>1.1.9：访问haproxy的80端口:<br><img src="/2019/03/09/keepalived及haproxy生产负载和高可用应用（编译安装）/2.png" alt=""></p><p>1.1.10：开启haproxy日志：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node137 ~]<span class="comment"># vim /etc/rsyslog.conf</span></span><br><span class="line"> 15 <span class="variable">$ModLoad</span> imudp</span><br><span class="line"> 16 <span class="variable">$UDPServerRun</span> 514</span><br><span class="line"> 92 local3.*         /var/<span class="built_in">log</span>/haproxy.log <span class="comment">#保存后的日志目录</span></span><br></pre></td></tr></table></figure></p><p>1.1.11：重启rsyslog服务：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node137 ~]<span class="comment"># systemctl  restart  rsyslog</span></span><br></pre></td></tr></table></figure></p><p>1.1.12：配置haproxy调用rsyslog：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node137 ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line"> 9 <span class="built_in">log</span> 127.0.0.1 local3 info</span><br><span class="line">[root@linux-node137 ~]<span class="comment"># systemctl  restart haproxy</span></span><br></pre></td></tr></table></figure></p><p>1.1.13：访问web界面并验证haproxy日志目录：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node137 ~]<span class="comment"># tail /var/log/haproxy.log </span></span><br><span class="line">Mar  9 16:04:40 localhost haproxy[55688]: Proxy stats started.</span><br><span class="line">Mar  9 16:04:40 localhost haproxy[55688]: Proxy web_port started.</span><br><span class="line">Mar  9 16:06:45 localhost haproxy[55689]: Connect from 192.168.10.1:2623 to 192.168.10.137:80 (web_port/TCP)</span><br></pre></td></tr></table></figure></p><p>二：keepalived安装及配置：</p><p>2.1：编译安装keepalived：</p><p>2.1.1：源码编译安装keepalived：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node137 ~]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line">[root@linux-node137 src]<span class="comment"># wget http://www.keepalived.org/software/keepalived-1.3.4.tar.gz</span></span><br><span class="line">[root@linux-node137 src]<span class="comment"># tar xvf keepalived-1.3.4.tar.gz</span></span><br><span class="line">[root@linux-node137 src]<span class="comment"># cd keepalived-1.3.4/</span></span><br><span class="line">[root@linux-node137 keepalived-1.3.4]<span class="comment"># yum install libnfnetlink-devel libnfnetlink ipvsadm  libnl libnl-devel  \</span></span><br><span class="line">libnl3 libnl3-devel   lm_sensors-libs net-snmp-agent-libs net-snmp-libs  openssh-server openssh-clients  openssl \</span><br><span class="line">openssl-devel automake iproute </span><br><span class="line"></span><br><span class="line">[root@localhost keepalived-1.3.4]<span class="comment">#  ./configure --prefix=/usr/local/keepalived --disable-fwmark   #传递参数关闭管理防火墙功能</span></span><br></pre></td></tr></table></figure></p><p><img src="/2019/03/09/keepalived及haproxy生产负载和高可用应用（编译安装）/3.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node137 keepalived-1.3.4]<span class="comment"># make &amp;&amp; amke install</span></span><br></pre></td></tr></table></figure><p>2.1.2：安装完成界面如下：<br><img src="/2019/03/09/keepalived及haproxy生产负载和高可用应用（编译安装）/4.png" alt=""></p><p>2.1.3：复制相关配置文件及启动脚本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node137 keepalived-1.3.4]<span class="comment"># cp /usr/local/src/keepalived-1.3.4/keepalived/etc/init.d/keepalived.rh.init /etc/sysconfig/keepalived.sysconfig</span></span><br><span class="line">[root@linux-node137 keepalived-1.3.4]<span class="comment"># cp /usr/local/src/keepalived-1.3.4/keepalived/keepalived.service  /usr/lib/systemd/system/</span></span><br><span class="line">[root@linux-node137 keepalived-1.3.4]<span class="comment"># cp  /usr/local/src/keepalived-1.3.4/bin/keepalived  /usr/sbin/</span></span><br></pre></td></tr></table></figure></p><p>2.1.4：准备一个简单的配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-node137 keepalived-1.3.4]<span class="comment"># mkdir /etc/keepalived</span></span><br><span class="line">[root@linux-node137 keepalived-1.3.4]<span class="comment"># vim /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     acassen@firewall.loc</span><br><span class="line">     failover@firewall.loc</span><br><span class="line">     sysadmin@firewall.loc</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from Alexandre.Cassen@firewall.loc</span><br><span class="line">   smtp_server 192.168.200.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id LVS_DEVEL</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VI_1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface eth0</span><br><span class="line">    virtual_router_id 80</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    <span class="comment">#unicast_src_ip 172.10.1.37</span></span><br><span class="line">    <span class="comment">#unicast_peer &#123;</span></span><br><span class="line">    <span class="comment">#    172.10.1.38</span></span><br><span class="line">    <span class="comment">#&#125;</span></span><br><span class="line"></span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 1111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        192.168.10.15 dev eth0 label eth0:0</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2.1.5：测试keepalived能否正常启动并绑定VIP到本地网卡<br><img src="/2019/03/09/keepalived及haproxy生产负载和高可用应用（编译安装）/5.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;keepalived配置多vip及实现双主模式&quot;&gt;&lt;a href=&quot;#keepalived配置多vip及实现双主模式&quot; class=&quot;headerlink&quot; title=&quot;keepalived配置多vip及实现双主模式&quot;&gt;&lt;/a&gt;keepalived配置多vip及实现双主模式&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/03/09/keepalived及haproxy生产负载和高可用应用（编译安装）/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="keepalived" scheme="https://daizhe.net.cn/categories/keepalived/"/>
    
    
      <category term="keepalived" scheme="https://daizhe.net.cn/tags/keepalived/"/>
    
  </entry>
  
  <entry>
    <title>keepalived配置多vip及实现双主模式</title>
    <link href="https://daizhe.net.cn/2019/03/09/keepalived%E9%85%8D%E7%BD%AE%E5%A4%9Avip%E5%8F%8A%E5%AE%9E%E7%8E%B0%E5%8F%8C%E4%B8%BB%E6%A8%A1%E5%BC%8F/"/>
    <id>https://daizhe.net.cn/2019/03/09/keepalived配置多vip及实现双主模式/</id>
    <published>2019-03-09T02:53:27.468Z</published>
    <updated>2019-03-10T06:40:42.197Z</updated>
    
    <content type="html"><![CDATA[<h1 id="keepalived配置多vip及实现双主模式"><a href="#keepalived配置多vip及实现双主模式" class="headerlink" title="keepalived配置多vip及实现双主模式"></a>keepalived配置多vip及实现双主模式</h1><p><img src="/2019/03/09/keepalived配置多vip及实现双主模式/标题.gif" alt=""><br><a id="more"></a></p><h2 id="安装keepalived"><a href="#安装keepalived" class="headerlink" title="安装keepalived"></a>安装keepalived</h2><p>1：实验准备</p><ul><li>各节点同步时时间</li><li>各节点关闭selinux</li></ul><p>2：安装keepalived （本地yum源安装）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># yum info keepalived</span></span><br><span class="line">Version     : 1.3.5</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># yum install keepalived -y</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># rpm -ql keepalived</span></span><br><span class="line">/etc/keepalived/keepalived.conf <span class="comment">#主配置文件</span></span><br><span class="line">/etc/sysconfig/keepalived   <span class="comment">#环境初始化的配置文件</span></span><br><span class="line">/usr/lib/systemd/system/keepalived.service  <span class="comment">#程序启动的脚本</span></span><br><span class="line">/usr/sbin/keepalived    <span class="comment">#可执行程序</span></span><br></pre></td></tr></table></figure></p><p>3：keepalived配置文件解析</p><ul><li><p>keepalived的所有的配置文件都在一个配置文件中设置，支持的配置项也比较多。但分为三类</p><ul><li>1：全局配置（Global Configuration）</li><li>2: VRRP 配置</li><li>3：LVS配置</li></ul></li><li><p>很明显，全局配置就是对整个keepalived起效的配置，不管是否使用LVS,VRRPD是keepalived的核心，LVS配置只在要使用的keepalived来配置和管理LVS时需要使用，如果仅使用Keepalived来做HA，LVS的配置完全是不需要的</p></li><li>配置文件都是以块（block）形式组织的，每隔块都在{和}包围的范围内，#和开头的行都是注释行</li></ul><hr><p>使用mailx发送邮件测试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># yum install mailx</span></span><br><span class="line">~]<span class="comment"># echo "hellow" | mail -s "biaoti" 1284808408@qq.com</span></span><br></pre></td></tr></table></figure></p><hr><p>4：养成良好的习惯，编辑服务的配置文件之前就要备份配置文件及解析配置文件</p><p>配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     1284808408@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from root@example.com</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">   <span class="comment">#vrrp_mcast_group4 224.0.0.18</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VRRP-V1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens37</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">172.18.135.8</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>解析配置文件</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">备份配置文件</span><br><span class="line">  ~]<span class="comment"># cd /etc/keepalived/</span></span><br><span class="line">  keepalived]<span class="comment"># cp keepalived.conf keepalived.conf.bak</span></span><br><span class="line"></span><br><span class="line">编辑配置文件</span><br><span class="line">  ! Configuration File <span class="keyword">for</span> keepalived   <span class="comment">#提示注释的信息可以使用！/#添加注释信息</span></span><br><span class="line">  global_defs &#123;   <span class="comment">#全局配置段</span></span><br><span class="line">   notification_email &#123;   <span class="comment">#定义接收邮件的邮箱</span></span><br><span class="line">    1284808408@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from     <span class="comment">#定义通知邮箱发件人的地址</span></span><br><span class="line">   smtp_server 127.0.0.1    <span class="comment">#定义邮件服务器的地址</span></span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id                <span class="comment">#此处不用定义，默认为本机的主机名称</span></span><br><span class="line">   <span class="comment">#vrrp_mcast_group4 224.0.0.18 #默认组播地址 224.0.0.0~239.255.255.255</span></span><br><span class="line">   vrrp_skip_check_adv_addr <span class="comment">#如果收到的报文和上一个报文是同一个路由器则跳过检查报文中的源地址</span></span><br><span class="line">   vrrp_strict  <span class="comment">#严格遵守VRRP协议，不允许状态 ：1.没有VIP地址，2.单播邻居，3.在VRRP版本2中有IPV6地址</span></span><br><span class="line">   vrrp_garp_interval 0 <span class="comment">#ARP报文发送延迟，一般设置为0表示不延迟</span></span><br><span class="line">   vrrp_gna_interval 0  <span class="comment">#消息发送延迟一般设置为0表示不延迟</span></span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance 自定义实例的名称 &#123;  <span class="comment">#VRRP相关的配置</span></span><br><span class="line">    state MASTER  <span class="comment">#当前的初始状态   MASTER | BACKUP  主/备份</span></span><br><span class="line">    interface eth0  <span class="comment">#指定当前keepalived在启动以后监听的网卡，组播会从此网卡发出</span></span><br><span class="line">    virtual_router_id 51    <span class="comment">#定义ID 地址范围为0-255 ID号不能冲突</span></span><br><span class="line">    priority 100    <span class="comment">#定义优先级，数字越大优先级越高，一般master的优先级一定是高于backup的，会将VIP绑定在优先级比较高的keepalived服务器上，一般建议将master的优先级要高于backup50个数值，实际上高出一个数值就可以</span></span><br><span class="line">    advert_int 1  <span class="comment">#探测信息，默认一秒发送一个广播包，此包是发送到组播中的</span></span><br><span class="line">     authentication &#123;   <span class="comment">#定义认证的方式（PASS|AH）</span></span><br><span class="line">        auth_type PASS    <span class="comment">#简单的密码认证</span></span><br><span class="line">        auth_pass 66666666    <span class="comment">#指定认证的密码 ，默认的密码为1111，仅支持前8位密码</span></span><br><span class="line">    &#125;</span><br><span class="line">  virtual_ipaddress &#123;   <span class="comment">#VIP相关的配置  ，定义的VIP地址一定是和指定interface 网卡在相同的网段中</span></span><br><span class="line">      172.18.135.8</span><br><span class="line">    &#125;   </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5：此节点上启动HA节点<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">启动节点的keepalived</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl start keepalived</span></span><br><span class="line">  ~]<span class="comment"># systemctl enable keepalived</span></span><br><span class="line"></span><br><span class="line">查看进程的状态</span><br><span class="line"></span><br><span class="line">   ~]<span class="comment"># ps -ef | grep keepalived</span></span><br><span class="line">  root       6412      1  0 15:03 ?        00:00:00 /usr/sbin/keepalived -D</span><br><span class="line">  root       6413   6412  0 15:03 ?        00:00:00 /usr/sbin/keepalived -D</span><br><span class="line">  root       6414   6412  0 15:03 ?        00:00:00 /usr/sbin/keepalived -D</span><br><span class="line">  root       6508   6466  0 15:06 pts/0    00:00:00 grep --color=auto keepalived</span><br><span class="line"></span><br><span class="line">  查看VIP</span><br><span class="line"></span><br><span class="line">  ~] <span class="comment"># ip addr</span></span><br><span class="line">  ens37: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:14:4d:6c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.135.1/24 brd 172.18.135.255 scope global noprefixroute ens37</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 172.18.135.8/32 scope global ens37</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::4587:5c47:4c05:570b/64 scope link noprefixroute </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></p><p>6：启动keepalived会默认生成访问墙的规则<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># iptables -L</span></span><br><span class="line">Chain INPUT (policy ACCEPT)     <span class="comment">#拒绝从任何地址到VIP地址的访问</span></span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line">DROP       all  --  anywhere             anywhere         match-set keepalived dst</span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination</span><br></pre></td></tr></table></figure></p><p>7：解决yum安装的keepalived启动时默认生成的防火墙额规则的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">方法一：</span><br><span class="line"></span><br><span class="line">  直接清空防火墙</span><br><span class="line">  ~]<span class="comment"># iptables -F</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  可以在keepalived启动时跳过生成防火墙的规则</span><br><span class="line">  编辑配置文件</span><br><span class="line">  global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     1284808408@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from root@example.com</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">   <span class="comment">#vrrp_mcast_group4 224.0.0.18</span></span><br><span class="line">   vrrp_iptables    <span class="comment">#不生成防火墙策略</span></span><br><span class="line">  &#125;</span><br><span class="line">  ....</span><br></pre></td></tr></table></figure></p><p>8：其他节点ping  keepalived VIP地址测试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># ping 172.18.135.8</span></span><br><span class="line">PING 172.18.135.8 (172.18.135.8) 56(84) bytes of data.</span><br><span class="line">64 bytes from 172.18.135.8: icmp_seq=1 ttl=64 time=0.077 ms</span><br><span class="line">64 bytes from 172.18.135.8: icmp_seq=2 ttl=64 time=0.106 ms</span><br><span class="line">64 bytes from 172.18.135.8: icmp_seq=3 ttl=64 time=0.090 ms</span><br></pre></td></tr></table></figure></p><hr><h2 id="将VIP在HA主机上设置一个单独的子接口"><a href="#将VIP在HA主机上设置一个单独的子接口" class="headerlink" title="将VIP在HA主机上设置一个单独的子接口"></a>将VIP在HA主机上设置一个单独的子接口</h2><p>1：编辑keepalived的配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     1284808408@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from root@example.com</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">   <span class="comment">#vrrp_mcast_group4 224.0.0.18</span></span><br><span class="line">   vrrp_iptables</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VRRP-V1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens37</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">172.18.135.8 dev ens37 label ens37:1   <span class="comment">#定义lable，也可以在地址后面添加掩码</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2：重新启动查看网卡接口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># systemctl restart keepalived</span></span><br></pre></td></tr></table></figure></p><hr><h2 id="高可用集群部署"><a href="#高可用集群部署" class="headerlink" title="高可用集群部署"></a>高可用集群部署</h2><p><img src="/2019/03/09/keepalived配置多vip及实现双主模式/1.png" alt=""></p><p>1：node1配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     1284808408@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from root@example.com</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">   <span class="comment">#vrrp_mcast_group4 224.0.0.18</span></span><br><span class="line">   vrrp_iptables</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VRRP-V1 &#123;</span><br><span class="line">    state MASTER        <span class="comment">#主</span></span><br><span class="line">    interface ens37</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100        <span class="comment">#100优先级</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">172.18.135.8/24 dev ens37 label ens37:01</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2：启动keepalived<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># systemctl start keepalived</span></span><br></pre></td></tr></table></figure></p><p>3：node2 配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># yum install keepalived -y</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># vim /etc/keepalived/keepalived.conf </span></span><br><span class="line"></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     1284808408@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from root@example.com</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">   <span class="comment">#vrrp_mcast_group4 224.0.0.18</span></span><br><span class="line">   vrrp_iptables</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VRRP-V1 &#123;</span><br><span class="line">    state BACKUP          <span class="comment">#备</span></span><br><span class="line">    interface ens37</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 90           <span class="comment">#90优先级要低于MASTER</span></span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.18.135.8/24 dev ens37 label ens37:01</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>4：node2 启动keepalived<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># systemctl start keepalived</span></span><br><span class="line">~]<span class="comment"># systemctl enable keepalived</span></span><br></pre></td></tr></table></figure></p><p>5：测试在node1节点上ens37网卡断掉，是否会将vip飘到node2上(可以查看日志信息)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">node1</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># ifconfig ens37 down</span></span><br><span class="line"></span><br><span class="line">node2</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># ip addr</span></span><br><span class="line">ens37: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:97:a5:a7 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.135.2/24 brd 172.18.135.255 scope global ens37</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 172.18.135.8/24 scope global secondary ens37:01</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet6 fe80::8aad:e002:aea0:6f27/64 scope link </span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">如果node1节点挂掉了，node2可以继续对外提供服务，但是node1的优先级要高于node2 如果node1恢复则vip会继续飘回node1上</span><br></pre></td></tr></table></figure></p><hr><h2 id="指定当主节点VIP宕机时自动发送报警邮件信息"><a href="#指定当主节点VIP宕机时自动发送报警邮件信息" class="headerlink" title="指定当主节点VIP宕机时自动发送报警邮件信息"></a>指定当主节点VIP宕机时自动发送报警邮件信息</h2><p>1：编辑keepalived配置文件（node1 和node2 配置文件相同）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line">  notify_master</span><br><span class="line">  <span class="comment">#当前节点成为主节点时触发的脚本</span></span><br><span class="line">  notify_backup</span><br><span class="line">  <span class="comment">#当前节点转为备份节点时触发的脚本</span></span><br><span class="line">  notify_fault</span><br><span class="line">  <span class="comment">#当前节点转为“失败”状态时触发的脚本</span></span><br><span class="line"></span><br><span class="line">定义报警时触发的脚本</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># vim  /etc/keepalived/notify.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line">contact=<span class="string">'1284808408@qq.com'</span></span><br><span class="line"><span class="function"><span class="title">notify</span></span>() &#123;</span><br><span class="line">        <span class="built_in">local</span> mailsubject=<span class="string">"<span class="variable">$(hostname)</span> to be <span class="variable">$1</span>, vip floating"</span></span><br><span class="line">        <span class="built_in">local</span> mailbody=<span class="string">"<span class="variable">$(date +'%F %T')</span>: vrrp transition, <span class="variable">$(hostname)</span> changed to be <span class="variable">$1</span>"</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$mailbody</span>"</span> | mail -s <span class="string">"<span class="variable">$mailsubject</span>"</span> <span class="variable">$contact</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">        master)</span><br><span class="line">        notify master</span><br><span class="line">        ;;</span><br><span class="line">        backup)</span><br><span class="line">        notify backup</span><br><span class="line">        ;;</span><br><span class="line">        fault)</span><br><span class="line">        notify fault</span><br><span class="line">        ;;</span><br><span class="line">        *)</span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"Usage: <span class="variable">$(basename $0)</span> &#123;master|backup|fault&#125;"</span></span><br><span class="line">        <span class="built_in">exit</span> 1</span><br><span class="line">        ;;</span><br><span class="line">        <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># chmod +x /etc/keepalived/notify.sh </span></span><br><span class="line"></span><br><span class="line">编辑keepalived配置文件调用脚本</span><br><span class="line">~]<span class="comment"># cat /etc/keepalived/keepalived.conf</span></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     1284808408@qq.com</span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from root@example.com</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">   router_id</span><br><span class="line">   vrrp_skip_check_adv_addr</span><br><span class="line">   vrrp_strict</span><br><span class="line">   vrrp_garp_interval 0</span><br><span class="line">   vrrp_gna_interval 0</span><br><span class="line">   <span class="comment">#vrrp_mcast_group4 224.0.0.18</span></span><br><span class="line">   vrrp_iptables</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VRRP-V1 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens37</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">172.18.135.8/24 dev ens37 label ens37:01    <span class="comment">#可配置多个VIP地址</span></span><br><span class="line">  172.18.135.9/24 dev ens37 label ens37:02</span><br><span class="line">    &#125;</span><br><span class="line">  notify_master <span class="string">"/etc/keepalived/notify.sh master"</span></span><br><span class="line">  notify_backup <span class="string">"/etc/keepalived/notify.sh backup"</span></span><br><span class="line">  notify_fault <span class="string">"/etc/keepalived/notify.sh fault"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">重启服务</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart keepalived</span></span><br></pre></td></tr></table></figure></p><hr><h2 id="keepalived-双主模式"><a href="#keepalived-双主模式" class="headerlink" title="keepalived 双主模式"></a>keepalived 双主模式</h2><p><img src="/2019/03/09/keepalived配置多vip及实现双主模式/2.png" alt=""></p><ul><li>互为主备</li><li>VIP: 172.18.135.8 - KP_server1 MASTER  - KP_server2 BACKUP</li><li>VIP: 172.18.135.9 - KP_server2 MASTER  - KP_server1 BACKUP</li></ul><p>KP_server1配置文件(主VIP ： 172.18.135.8   备VIP ：172.18.135.9)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/keepalived/keepalived.conf</span></span><br><span class="line"></span><br><span class="line">   &#125;</span><br><span class="line">   notification_email_from root@example.com</span><br><span class="line">   smtp_server 127.0.0.1</span><br><span class="line">   smtp_connect_timeout 30</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.18.135.8/24 dev ens37 label ens37:01</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  notify_master <span class="string">"/etc/keepalived/notify.sh master"</span></span><br><span class="line">  notify_backup <span class="string">"/etc/keepalived/notify.sh backup"</span></span><br><span class="line">  notify_fault <span class="string">"/etc/keepalived/notify.sh fault"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">vrrp_instance VRRP-V2 &#123;</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens37</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.18.135.9/24 dev ens37 label ens37:01</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">  notify_master <span class="string">"/etc/keepalived/notify.sh master"</span></span><br><span class="line">  notify_backup <span class="string">"/etc/keepalived/notify.sh backup"</span></span><br><span class="line">  notify_fault <span class="string">"/etc/keepalived/notify.sh fault"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>KP_server2配置文件(主VIP ： 172.18.135.9   备VIP ：172.18.135.8)</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/keepalived/keepalived.conf </span></span><br><span class="line"></span><br><span class="line">! Configuration File <span class="keyword">for</span> keepalived</span><br><span class="line"></span><br><span class="line">global_defs &#123;</span><br><span class="line">   notification_email &#123;</span><br><span class="line">     1284808408@qq.com</span><br><span class="line">    state BACKUP</span><br><span class="line">    interface ens37</span><br><span class="line">    virtual_router_id 51</span><br><span class="line">    priority 90</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.18.135.8/24 dev ens37 label ens37:01</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">vrrp_instance VRRP-V2 &#123;</span><br><span class="line">    state MASTER</span><br><span class="line">    interface ens37</span><br><span class="line">    virtual_router_id 52</span><br><span class="line">    priority 100</span><br><span class="line">    advert_int 1</span><br><span class="line">    authentication &#123;</span><br><span class="line">        auth_type PASS</span><br><span class="line">        auth_pass 11111111</span><br><span class="line">    &#125;</span><br><span class="line">    virtual_ipaddress &#123;</span><br><span class="line">        172.18.135.9/24 dev ens37 label ens37:01</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>两个节点的重新启动keepalived服务</p><p>KP_server1<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># systemctl restart keepalived</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># ip addr</span></span><br><span class="line">ens37: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP group default qlen 1000</span><br><span class="line">    link/ether 00:0c:29:14:4d:6c brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.135.1/24 brd 172.18.135.255 scope global noprefixroute ens37</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 172.18.135.8/24 scope global secondary ens37:01</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></p><p>KP_server2<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># systemctl restart keepalived</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># ip addr</span></span><br><span class="line">ens37: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc pfifo_fast state UP qlen 1000</span><br><span class="line">    link/ether 00:0c:29:97:a5:a7 brd ff:ff:ff:ff:ff:ff</span><br><span class="line">    inet 172.18.135.2/24 brd 172.18.135.255 scope global ens37</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br><span class="line">    inet 172.18.135.9/24 scope global secondary ens37:01</span><br><span class="line">       valid_lft forever preferred_lft forever</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;keepalived配置多vip及实现双主模式&quot;&gt;&lt;a href=&quot;#keepalived配置多vip及实现双主模式&quot; class=&quot;headerlink&quot; title=&quot;keepalived配置多vip及实现双主模式&quot;&gt;&lt;/a&gt;keepalived配置多vip及实现双主模式&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/03/09/keepalived配置多vip及实现双主模式/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="keepalived" scheme="https://daizhe.net.cn/categories/keepalived/"/>
    
    
      <category term="keepalived" scheme="https://daizhe.net.cn/tags/keepalived/"/>
    
  </entry>
  
  <entry>
    <title>ELK之filebeat多个文件日志收集</title>
    <link href="https://daizhe.net.cn/2019/03/06/ELK%E4%B9%8Bfilebeat%E5%A4%9A%E4%B8%AA%E6%96%87%E4%BB%B6%E6%97%A5%E5%BF%97%E6%94%B6%E9%9B%86/"/>
    <id>https://daizhe.net.cn/2019/03/06/ELK之filebeat多个文件日志收集/</id>
    <published>2019-03-06T01:51:36.026Z</published>
    <updated>2019-03-06T11:40:34.460Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ELK之filebeat多个文件日志收集"><a href="#ELK之filebeat多个文件日志收集" class="headerlink" title="ELK之filebeat多个文件日志收集"></a>ELK之filebeat多个文件日志收集</h1><p><img src="/2019/03/06/ELK之filebeat多个文件日志收集/标题.png" alt=""><br><a id="more"></a></p><h2 id="filebeat日志收集实战："><a href="#filebeat日志收集实战：" class="headerlink" title="filebeat日志收集实战："></a>filebeat日志收集实战：</h2><ul><li>架构规划：<ul><li>在下面的图当中从左向右看，当要访问ELK日志统计平台的时候，首先访问的是两台nginx+keepalived做的负载高可用，访问的地址是keepalived的IP，当一台nginx代理服务器挂掉之后也不影响访问，然后nginx将请求转发到kibana，kibana再去elasticsearch获取数据，elasticsearch是两台做的集群，数据会随机保存在任意一台elasticsearch服务器，redis服务器做数据的临时保存，避免web服务器日志量过大的时候造成的数据收集与保存不一致导致的日志丢失，可以临时保存到redis，redis可以是集群，然后再由logstash服务器在非高峰时期从redis持续的取出即可，另外有一台mysql数据库服务器，用于持久化保存特定的数据，web服务器的日志由filebeat收集之后发送给另外的一台logstash，再有其写入到redis即可完成日志的收集，从图中可以看出，redis服务器处于前端结合的最中间，其左右都要依赖于redis的正常运行，web服务删个日志经过filebeat收集之后通过日志转发层的logstash写入到redis不同的key当中，然后提取层logstash再从redis将数据提取并安按照不同的类型写入到elasticsearch的不同index当中，用户最终通过nginx代理的kibana查看到收集到的日志的具体内容：</li></ul></li></ul><p><img src="/2019/03/06/ELK之filebeat多个文件日志收集/1.png" alt=""></p><p>1：filebeat收集日志转发至logstash(基于beats模块)</p><p>官方文档：<a href="https://www.elastic.co/guide/en/beats/filebeat/current/logstash-output.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/logstash-output.html</a></p><p>目前只收集了系统日志，下面将tomcat的访问日志和启动时生成的catalina.txt文件的日志进行收集，另外测试多行匹配，并将输出改为logstash进根据日志类型判断写入到不同的redis key当中，在一个filebeat服务上面同时收集不同类型的日志，比如收集系统日志的时候还要收集tomcat的访问日志，那么直接带来的问题就是要在写入至redis的时候要根据不同的日志类型写入到reids不通的key当中，首先通过logstash监听一个端口，并做标准输出测试，具体配置为：</p><p>配置Logstash配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cd /etc/logstash/conf.d/</span></span><br><span class="line">conf.d]<span class="comment"># cat beats-test.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">        beats &#123;</span><br><span class="line">        port =&gt; 5044</span><br><span class="line">        codec =&gt; <span class="string">"json"</span> <span class="comment">#指定编码格式</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#将输出改为文件进行临时输出测试</span></span><br><span class="line">output &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/tmp/filebeat.txt"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>logstash配置文件测试语法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conf.d]<span class="comment"># /usr/share/logstash/bin/logstash -f  /etc/logstash/conf.d/beats-test.conf  -t</span></span><br><span class="line">conf.d]<span class="comment"># systemctl  restart  logstash #重启服务</span></span><br></pre></td></tr></table></figure></p><p>2：更改web服务器的filebeat配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#配置filebeat配置文件，配置收集nginx的访问日志，标准输出至Logstash中</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># vim /etc/filebeat/filebeat.yml </span></span><br><span class="line">12 filebeat.prospectors:</span><br><span class="line"></span><br><span class="line">18 - input_type: <span class="built_in">log</span></span><br><span class="line">21   paths:</span><br><span class="line">22     - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line"></span><br><span class="line">39   fields:</span><br><span class="line">40      <span class="built_in">type</span>: nginx-accesslog</span><br><span class="line"></span><br><span class="line">116 output.logstash:</span><br><span class="line">117   hosts: [<span class="string">"172.18.135.2:5044"</span>] <span class="comment">#logstash 服务器地址，可以是多个</span></span><br><span class="line">118   enabled: <span class="literal">true</span>   <span class="comment">#是否开启输出至logstash，默认即为true</span></span><br><span class="line">119   worker: 1  <span class="comment">#工作线程数</span></span><br><span class="line">120   <span class="comment">#compression_level: 3 #压缩级别，数值越大，压缩比越高（1~9），一般情况下不使用，因为会占用cpu资源</span></span><br><span class="line">121   <span class="comment">#loadbalance: true #多个输出的时候开启负载,在输出到多个logstash时开启此项</span></span><br></pre></td></tr></table></figure></p><p>重启filebeat<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># systemctl  restart filebeat</span></span><br></pre></td></tr></table></figure></p><p>3：客户端模拟访问web服务器，logstash查看是记录日志文件<br><img src="/2019/03/06/ELK之filebeat多个文件日志收集/2.png" alt=""></p><p>4：Logstash中配置将filebeat发送来的日志发送到redis<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">前面配置logstash是将filebeat发来的日志信息，存储到本地的文件中</span><br><span class="line"></span><br><span class="line">编辑logstahs配置文件</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># cd /etc/logstash/conf.d/</span></span><br><span class="line">conf.d]<span class="comment"># cat beats-test.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">        beats &#123;</span><br><span class="line">        port =&gt; 5044</span><br><span class="line">        codec =&gt; <span class="string">"json"</span> <span class="comment">#指定编码格式</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#将输出改为文件进行临时输出测试</span></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [fields] [<span class="built_in">type</span>] == <span class="string">"nginx-accesslog"</span> &#123;</span><br><span class="line">    redis &#123;</span><br><span class="line">      host =&gt; <span class="string">"172.18.135.2"</span> <span class="comment">#redis服务器的地址</span></span><br><span class="line">      prot =&gt; <span class="string">"6379"</span></span><br><span class="line">      password =&gt; <span class="string">"123456"</span></span><br><span class="line">      data_type =&gt; <span class="string">"list"</span></span><br><span class="line">      key =&gt; <span class="string">"nginx-accesslog"</span>  <span class="comment">#日志数据存储到redis时的key的名称 </span></span><br><span class="line">      db =&gt; 1</span><br><span class="line">      codec =&gt; <span class="string">"json"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>logstash配置文件测试语法<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">conf.d]<span class="comment"># /usr/share/logstash/bin/logstash -f  /etc/logstash/conf.d/beats-test.conf  -t</span></span><br><span class="line">conf.d]<span class="comment"># systemctl  restart  logstash #重启服务</span></span><br></pre></td></tr></table></figure></p><p>5：在redis上查看是否已经存入1库中</p><p>6：配置logstash从redis中读取键值并存储到ES集群中做日志收集<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/logstash/conf.d/redis-systemlog-es.conf </span></span><br><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">  redis &#123;</span><br><span class="line">    host =&gt; <span class="string">"172.18.135.2"</span> <span class="comment">#redis主机地址</span></span><br><span class="line">    password =&gt; <span class="string">"123456"</span></span><br><span class="line">    port =&gt; <span class="string">"6379"</span></span><br><span class="line">    db =&gt; <span class="string">"1"</span></span><br><span class="line">    key =&gt; <span class="string">"nginx-accesslog"</span></span><br><span class="line">    data_type =&gt; <span class="string">"list"</span></span><br><span class="line">    codec =&gt; <span class="string">"json"</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [fields][<span class="built_in">type</span>] == <span class="string">"nginx-accesslog"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [<span class="string">"172.18.135.1:9200"</span>] <span class="comment">#ES集群主机地址</span></span><br><span class="line">      index =&gt; <span class="string">"nginx-log-135-1-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">      codec =&gt; <span class="string">"json"</span></span><br><span class="line">&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>语法检测并启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/redis-systemlog-es.conf -t</span></span><br><span class="line">~]<span class="comment"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p><p>7：ES主机上head插件查看日志索引是否存储</p><p>8：kibana根据定义的索引展示日志记录</p><hr><h2 id="filebeat收集多类型的日志文件"><a href="#filebeat收集多类型的日志文件" class="headerlink" title="filebeat收集多类型的日志文件"></a>filebeat收集多类型的日志文件</h2><p>1：编辑用来收集日志的filebeat配置文件，收集本机的多个日子文件(收集本机上的nginx的访问日志和本机的所有的文件)，发送到Logstash<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># grep -v "#" /etc/filebeat/filebeat.yml | grep -v "^$"</span></span><br><span class="line">filebeat.prospectors:</span><br><span class="line">- input_type: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line">  fields:</span><br><span class="line">     <span class="built_in">type</span>: nginx-accesslog  <span class="comment">#标识nginx访问日志的类型（需要将nginx的日志类型改为json）</span></span><br><span class="line">     - input_type: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/message</span><br><span class="line">  fields:</span><br><span class="line">     <span class="built_in">type</span>: systemlog  <span class="comment">#标识message日志的类型</span></span><br><span class="line">output.logstash:</span><br><span class="line">  hosts: [<span class="string">"172.18.135.1:5044"</span>]  </span><br><span class="line">  <span class="built_in">enable</span>: <span class="literal">true</span></span><br><span class="line">  worker: 1</span><br><span class="line">  compression_level: 5</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">2：编辑logstash配置文件，将filebeat发送来的日志信息，根据定义的<span class="built_in">type</span>类型存储到redis中</span><br><span class="line">```bash</span><br><span class="line">~]<span class="comment"># cd /etc/logstash/conf.d/</span></span><br><span class="line">conf.d]<span class="comment"># cat beats-test.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">        beats &#123;</span><br><span class="line">        port =&gt; 5044</span><br><span class="line">        codec =&gt; <span class="string">"json"</span> <span class="comment">#指定编码格式</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#将输出改为文件进行临时输出测试</span></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [fields] [<span class="built_in">type</span>] == <span class="string">"nginx-accesslog"</span> &#123;</span><br><span class="line">    redis &#123;</span><br><span class="line">      host =&gt; <span class="string">"172.18.135.2"</span> <span class="comment">#redis服务器的地址</span></span><br><span class="line">      prot =&gt; <span class="string">"6379"</span></span><br><span class="line">      password =&gt; <span class="string">"123456"</span></span><br><span class="line">      data_type =&gt; <span class="string">"list"</span></span><br><span class="line">      key =&gt; <span class="string">"nginx-accesslog"</span>  <span class="comment">#日志数据存储到redis时的key的名称 </span></span><br><span class="line">      db =&gt; 1</span><br><span class="line">      codec =&gt; <span class="string">"json"</span></span><br><span class="line">    &#125;&#125;</span><br><span class="line">  <span class="keyword">if</span> [fields] [<span class="built_in">type</span>] == <span class="string">"systemlog"</span> &#123;</span><br><span class="line">    redis &#123;</span><br><span class="line">      host =&gt; <span class="string">"172.18.135.2"</span> <span class="comment">#redis服务器的地址</span></span><br><span class="line">      prot =&gt; <span class="string">"6379"</span></span><br><span class="line">      password =&gt; <span class="string">"123456"</span></span><br><span class="line">      data_type =&gt; <span class="string">"list"</span></span><br><span class="line">      key =&gt; <span class="string">"systemlog"</span>  <span class="comment">#日志数据存储到redis时的key的名称 </span></span><br><span class="line">      db =&gt; 1</span><br><span class="line">    &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>语法检测并启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/redis-systemlog-es.conf -t</span></span><br><span class="line">~]<span class="comment"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p><p>3：在redis上查看是否已经存入1库中</p><p>4：编辑另一台logstash主机配置文件，从redis中服务日志键值，存储到后端的ES存储集群中，进行日志存储<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/logstash/conf.d/redis-systemlog-es.conf </span></span><br><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">  redis &#123;</span><br><span class="line">    host =&gt; <span class="string">"172.18.135.2"</span> <span class="comment">#redis主机地址</span></span><br><span class="line">    password =&gt; <span class="string">"123456"</span></span><br><span class="line">    port =&gt; <span class="string">"6379"</span></span><br><span class="line">    db =&gt; <span class="string">"1"</span></span><br><span class="line">    key =&gt; <span class="string">"nginx-accesslog"</span></span><br><span class="line">    data_type =&gt; <span class="string">"list"</span></span><br><span class="line">    codec =&gt; <span class="string">"json"</span></span><br><span class="line"> &#125;</span><br><span class="line">   redis &#123;</span><br><span class="line">    host =&gt; <span class="string">"172.18.135.2"</span> <span class="comment">#redis主机地址</span></span><br><span class="line">    password =&gt; <span class="string">"123456"</span></span><br><span class="line">    port =&gt; <span class="string">"6379"</span></span><br><span class="line">    db =&gt; <span class="string">"1"</span></span><br><span class="line">    key =&gt; <span class="string">"systemlog"</span></span><br><span class="line">    data_type =&gt; <span class="string">"list"</span></span><br><span class="line">    <span class="comment">#codec =&gt; "json"</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [fields][<span class="built_in">type</span>] == <span class="string">"nginx-accesslog"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [<span class="string">"172.18.135.1:9200"</span>] <span class="comment">#ES集群主机地址</span></span><br><span class="line">      index =&gt; <span class="string">"nginx-log-135-1-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">      codec =&gt; <span class="string">"json"</span></span><br><span class="line">&#125;&#125;</span><br><span class="line">  <span class="keyword">if</span> [fields][<span class="built_in">type</span>] == <span class="string">"systemlog"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [<span class="string">"172.18.135.1:9200"</span>] <span class="comment">#ES集群主机地址</span></span><br><span class="line">      index =&gt; <span class="string">"message-log-135-1-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">      codec =&gt; <span class="string">"json"</span></span><br><span class="line">&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>语法检测并启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/redis-systemlog-es.conf -t</span></span><br><span class="line">~]<span class="comment"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p><p>5：ES主机上head插件查看日志索引是否存储</p><p>6：kibana根据定义的索引展示日志记录</p><hr><h2 id="脚本编写进行监控"><a href="#脚本编写进行监控" class="headerlink" title="脚本编写进行监控"></a>脚本编写进行监控</h2><ul><li>依据判断logstash存储到redis数据的数据长度来判断存储redis数据的logstash程序是否已经宕机</li><li>实际环境当中，可能会出现reids当中堆积了大量的数据而logstash由于种种原因未能及时提取日志，此时会导致redis服务器的内存被大量使用，甚至出现如下内存即将被使用完毕的情景</li></ul><p>1：查看reids中的日志队列长度发现有大量的日志堆积在redis 当中<br><img src="/2019/03/06/ELK之filebeat多个文件日志收集/3.png" alt=""></p><p>2：在写入redis日志信息的logstash主机上编写python脚本（编写python脚本，获取redis中列表长度并返回值）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~] <span class="comment"># cat redis-llen.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding:utf-</span></span><br><span class="line"><span class="comment">#Author Dai zhe</span></span><br><span class="line">import redis</span><br><span class="line">def redis_conn():</span><br><span class="line">    pool=redis.ConnectionPool(host=<span class="string">"Redis主机地址"</span>,port=6379,db=1,password=123456)</span><br><span class="line">    conn = redis.Redis(connection_pool=pool)</span><br><span class="line">    data = conn.llen(<span class="string">'存储在redis的KEY名称'</span>)</span><br><span class="line">    <span class="built_in">print</span>(data)</span><br><span class="line">redis_conn()</span><br></pre></td></tr></table></figure></p><p>3：安装管理模块<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># yum install python-pip</span></span><br><span class="line">~]<span class="comment"># pip install redis</span></span><br></pre></td></tr></table></figure></p><p>4：执行脚本<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># python redis-llen.py</span></span><br><span class="line">这里显示redia KEY对应的值的大小</span><br></pre></td></tr></table></figure></p><hr><h2 id="脚本编写进行ES存储定期清理"><a href="#脚本编写进行ES存储定期清理" class="headerlink" title="脚本编写进行ES存储定期清理"></a>脚本编写进行ES存储定期清理</h2><p>在ES主机上</p><ul><li>关于elasticsearch存储index的定期删除，elasticsearch存储的日志较多的时候会影响搜索性能，因此建议定期清理，脚本如下，这次是shell脚本：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">[root@els-s2 ~]<span class="comment"># vim els_delete.sh</span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">DATE=`date -d <span class="string">"2 days ago"</span> +%Y.%m.%d`</span><br><span class="line">LOG_NAME=<span class="string">"api4-systemlog-7-103"</span>   <span class="comment">#索引名称,定义的索引尽量使用含有日期格式的索引</span></span><br><span class="line">FILE_NAME=<span class="variable">$&#123;LOG_NAME&#125;</span>-<span class="variable">$&#123;DATE&#125;</span></span><br><span class="line">curl -XDELETE  http://ES主机地址:9200/<span class="variable">$&#123;FILE_NAME&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;FILE_NAME&#125;</span> delete success"</span></span><br><span class="line"></span><br><span class="line">[root@els-s2 ~]<span class="comment"># chmod  a+x /root/els_delete.sh </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">测试执行：</span><br><span class="line"></span><br><span class="line">[root@els-s2 ~]<span class="comment"># bash -x /root/els_delete.sh</span></span><br><span class="line">++ date -d <span class="string">'30 days ago'</span> +%Y.%m.%d</span><br><span class="line">+ DATE=2016.08.05</span><br><span class="line">+ LOG_NAME=api4-systemlog</span><br><span class="line">+ FILE_NAME=api4-systemlog-2016.08.05</span><br><span class="line">+ curl -XDELETE http://hfelk.chinacloudapp.cn:9200/api4-systemlog-2016.08.05</span><br><span class="line">&#123;<span class="string">"acknowledged"</span>:<span class="literal">true</span>&#125;+ <span class="built_in">echo</span> <span class="string">'api4-systemlog-2016.08.05 delete success'</span></span><br><span class="line">api4-systemlog-2016.08.05 delete success</span><br><span class="line">6.2：添加任务计定期执行即可：</span><br><span class="line"></span><br><span class="line">[root@els-s2 ~]<span class="comment"># crontab  -e</span></span><br><span class="line">1 * * * * /root/els_delete.sh <span class="comment">#每天凌晨一点清除一月之前的日志</span></span><br></pre></td></tr></table></figure><p>备注：</p><ul><li>千万不要直接去ES主机上删除数据<ul><li>/data/esdata/</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ELK之filebeat多个文件日志收集&quot;&gt;&lt;a href=&quot;#ELK之filebeat多个文件日志收集&quot; class=&quot;headerlink&quot; title=&quot;ELK之filebeat多个文件日志收集&quot;&gt;&lt;/a&gt;ELK之filebeat多个文件日志收集&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/03/06/ELK之filebeat多个文件日志收集/标题.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>ELK之使用filebeat替换logstash</title>
    <link href="https://daizhe.net.cn/2019/03/03/ELK%E4%B9%8B%E4%BD%BF%E7%94%A8filebeat%E6%9B%BF%E6%8D%A2logstash/"/>
    <id>https://daizhe.net.cn/2019/03/03/ELK之使用filebeat替换logstash/</id>
    <published>2019-03-03T03:29:01.771Z</published>
    <updated>2019-03-06T08:01:02.063Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ELK之使用filebeat替换logstash"><a href="#ELK之使用filebeat替换logstash" class="headerlink" title="ELK之使用filebeat替换logstash"></a>ELK之使用filebeat替换logstash</h1><p><img src="/2019/03/03/ELK之使用filebeat替换logstash/标题.png" alt=""><br><a id="more"></a></p><h2 id="filebeat"><a href="#filebeat" class="headerlink" title="filebeat"></a>filebeat</h2><ul><li>Filebeat是轻量级单用途的日志收集工具，用于在没有安装java的服务器上专门收集日志，可以将日志转发到logstash、elasticsearch或redis及kafka等场景中进行下一步处理。</li><li>官网下载地址：<a href="https://www.elastic.co/downloads/beats/filebeat" target="_blank" rel="noopener">https://www.elastic.co/downloads/beats/filebeat</a></li><li>官方文档：<a href="https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-" target="_blank" rel="noopener">https://www.elastic.co/guide/en/beats/filebeat/current/filebeat-</a></li></ul><h2 id="将本机的json格式的日志通过filebeat收集并标准输出至屏幕"><a href="#将本机的json格式的日志通过filebeat收集并标准输出至屏幕" class="headerlink" title="将本机的json格式的日志通过filebeat收集并标准输出至屏幕"></a>将本机的json格式的日志通过filebeat收集并标准输出至屏幕</h2><ul><li><p>确认日志格式为json格式：<br>先访问web服务器，以产生一定的日志，然后确认是json格式，因为下面的课程中会使用到：</p></li><li><p>这里演示的本机的json日志格式为web服务器tomcat的访问日志格式</p></li></ul><p>1：访问tomcat WEB站点，生成访问日志信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># ab -n100 -c100 http://192.168.15.16:8080/web</span></span><br></pre></td></tr></table></figure></p><p>2：确认日志格式，后续会用日志做统计<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># tail  /usr/local/tomcat/logs/localhost_access_log.2017-04-28.txt </span></span><br><span class="line">&#123;<span class="string">"clientip"</span>:<span class="string">"192.168.15.15"</span>,<span class="string">"ClientUser"</span>:<span class="string">"-"</span>,<span class="string">"authenticated"</span>:<span class="string">"-"</span>,<span class="string">"AccessTime"</span>:<span class="string">"[28/Apr/2017:21:16:46 +0800]"</span>,<span class="string">"method"</span>:<span class="string">"GET /webdir/ HTTP/1.0"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>,<span class="string">"SendBytes"</span>:<span class="string">"12"</span>,<span class="string">"Query?string"</span>:<span class="string">""</span>,<span class="string">"partner"</span>:<span class="string">"-"</span>,<span class="string">"AgentVersion"</span>:<span class="string">"ApacheBench/2.3"</span>&#125;</span><br><span class="line">&#123;<span class="string">"clientip"</span>:<span class="string">"192.168.15.15"</span>,<span class="string">"ClientUser"</span>:<span class="string">"-"</span>,<span class="string">"authenticated"</span>:<span class="string">"-"</span>,<span class="string">"AccessTime"</span>:<span class="string">"[28/Apr/2017:21:16:46 +0800]"</span>,<span class="string">"method"</span>:<span class="string">"GET /webdir/ HTTP/1.0"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>,<span class="string">"SendBytes"</span>:<span class="string">"12"</span>,<span class="string">"Query?string"</span>:<span class="string">""</span>,<span class="string">"partner"</span>:<span class="string">"-"</span>,<span class="string">"AgentVersion"</span>:<span class="string">"ApacheBench/2.3"</span>&#125;</span><br></pre></td></tr></table></figure></p><p>3：安装配置filebeat<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    ~]<span class="comment"># systemctl  stop logstash  #停止logstash服务(如果有安装)</span></span><br><span class="line">    src]<span class="comment"># wget https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-5.3.2-x86_64.rpm</span></span><br><span class="line">    src]<span class="comment"># yum install filebeat-5.3.2-x86_64.rpm  -y</span></span><br><span class="line">`</span><br></pre></td></tr></table></figure></p><p>4：配置filebeat收集系统日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">    ~]<span class="comment"># cd /etc/filebeat/</span></span><br><span class="line">    filebeat~]<span class="comment"># cp filebeat.yml filebeat.yml.bak #备份源配置文件</span></span><br><span class="line"></span><br><span class="line">filebeat收集多个系统日志并输出到本地文件</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># grep -v "#"  /etc/filebeat/filebeat.yml | grep -v "^$"</span></span><br><span class="line">filebeat.prospectors:</span><br><span class="line">- input_type: <span class="built_in">log</span></span><br><span class="line">  paths:</span><br><span class="line">    - /var/<span class="built_in">log</span>/messages</span><br><span class="line">    - /var/<span class="built_in">log</span>/*.<span class="built_in">log</span></span><br><span class="line">  exclude_lines: [<span class="string">"^DBG"</span>,<span class="string">"^$"</span>] <span class="comment">#不收取的</span></span><br><span class="line">  <span class="comment">#include_lines: ["^ERR", "^WARN"]  #只收取的</span></span><br><span class="line">  document_type: system-log-1512 <span class="comment">#类型，会在每条日志中插入标记</span></span><br><span class="line">output.file:</span><br><span class="line">  path: <span class="string">"/tmp"</span></span><br><span class="line">  filename: <span class="string">"filebeat.txt"</span></span><br></pre></td></tr></table></figure></p><p>5：启动filebeat服务并验证本地文件是否有数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">filebeat]<span class="comment"># systemctl  start filebeat</span></span><br></pre></td></tr></table></figure></p><p><img src="/2019/03/03/ELK之使用filebeat替换logstash/1.png" alt=""></p><hr><hr><h2 id="使用Filebeat收集本机的Nginx的访问日志并存储到后端的ES主机上"><a href="#使用Filebeat收集本机的Nginx的访问日志并存储到后端的ES主机上" class="headerlink" title="使用Filebeat收集本机的Nginx的访问日志并存储到后端的ES主机上"></a>使用Filebeat收集本机的Nginx的访问日志并存储到后端的ES主机上</h2><p><img src="/2019/03/03/ELK之使用filebeat替换logstash/2.png" alt=""></p><p>Filebeat官方参考手册：<a href="https://www.elastic.co/products/beats" target="_blank" rel="noopener">https://www.elastic.co/products/beats</a></p><p>1：rpm包安装Filebeat<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># ls</span></span><br><span class="line">filebeat-5.6.13-x86_64.rpm</span><br><span class="line">~]<span class="comment"># rpm -ivh filebeat-5.6.13-x86_64.rpm</span></span><br></pre></td></tr></table></figure></p><p>Filebeat配置文件解析<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/filebeat/filebeat.yml  #yml语法格式</span></span><br><span class="line">21  paths:      <span class="comment">#基于path参数，指定收集的哪个日志文件，支持模糊匹配</span></span><br><span class="line">22    - /var/<span class="built_in">log</span>/*.<span class="built_in">log</span></span><br><span class="line">23    <span class="comment">#- c:\programdata\elasticsearch\logs\*    #windows收集windows日志文件语法</span></span><br><span class="line"></span><br><span class="line">27    <span class="comment">#exclude_lines: ["^DBG"]  #排除日志文件中开头以DBU开头的行不做收集</span></span><br><span class="line"></span><br><span class="line">31    <span class="comment">#include_lines: ["^ERR", "^WARN"]     #指定日志文件中只收集的行</span></span><br><span class="line"></span><br><span class="line">35    <span class="comment">#exclude_files: [".gz$"]      #排除文件，范例排除收集压缩的文件</span></span><br><span class="line"></span><br><span class="line">39   <span class="comment">#fields:   </span></span><br><span class="line">40   <span class="comment">#  level: debug    #在收集的每条日志中插入debug</span></span><br><span class="line">41   <span class="comment">#  review: 1</span></span><br><span class="line"></span><br><span class="line"><span class="comment">## 多行合并</span></span><br><span class="line">49   <span class="comment">#multiline.pattern: ^\[</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#================================ Outputs ================================    =====</span></span><br><span class="line"></span><br><span class="line">81 output.elasticsearch:   <span class="comment">#将收集的日志存储到ES主机上格式</span></span><br><span class="line"></span><br><span class="line">83   hosts: [<span class="string">"localhost:9200"</span>]</span><br><span class="line"></span><br><span class="line">86   <span class="comment">#protocol: "https"     #支持安全认证机制</span></span><br><span class="line">87   <span class="comment">#username: "elastic"</span></span><br><span class="line">88   <span class="comment">#password: "changeme"</span></span><br></pre></td></tr></table></figure></p><p>2：编辑配置文件修改nginx日志的格式<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">http &#123;</span><br><span class="line"><span class="comment">#    log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line"><span class="comment">#                      '$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line"><span class="comment">#                      '"$http_user_agent" "$http_x_forwarded_for"';</span></span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment">#    access_log  /var/log/nginx/access.log  main;</span></span><br><span class="line"></span><br><span class="line">log_format access_json <span class="string">'&#123;"@timestamp":"$time_iso8601",'</span>        <span class="comment">#定义日志的格式</span></span><br><span class="line">        <span class="string">'"host":"$server_addr",'</span></span><br><span class="line">        <span class="string">'"clientip":"$remote_addr",'</span></span><br><span class="line">        <span class="string">'"size":$body_bytes_sent,'</span></span><br><span class="line">        <span class="string">'"responsetime":$request_time,'</span></span><br><span class="line">        <span class="string">'"upstreamtime":"$upstream_response_time",'</span></span><br><span class="line">        <span class="string">'"upstreamhost":"$upstream_addr",'</span></span><br><span class="line">        <span class="string">'"http_host":"$host",'</span></span><br><span class="line">        <span class="string">'"url":"$uri",'</span></span><br><span class="line">        <span class="string">'"domain":"$host",'</span></span><br><span class="line">        <span class="string">'"xff":"$http_x_forwarded_for",'</span></span><br><span class="line">        <span class="string">'"referer":"$http_referer",'</span></span><br><span class="line">        <span class="string">'"status":"$status"&#125;'</span>;</span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  access_json;</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># mkdir -p /var/log/nginx/</span></span><br><span class="line">~]<span class="comment"># systemctl start nginx </span></span><br><span class="line">~]<span class="comment"># systemctl enable nginx</span></span><br></pre></td></tr></table></figure></p><p>3：使用filebeat收集nginx访问日志，配置filebeat收集系统日志：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cd /etc/filebeat/</span></span><br><span class="line">filebeat]<span class="comment"># cp filebeat.yml  filebeat.yml.bak #备份源配置文件</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># vim /etc/filebeat/filebeat.yml </span></span><br><span class="line">21   paths:</span><br><span class="line">22     - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line"></span><br><span class="line">39   fields:        <span class="comment">#定义type</span></span><br><span class="line">40         <span class="built_in">type</span>: nginx-accesslog</span><br><span class="line"></span><br><span class="line">82 output.elasticsearch:    <span class="comment">#指定将filebeat收集来的日志存储在ES中</span></span><br><span class="line">83   <span class="comment"># Array of hosts to connect to.</span></span><br><span class="line">84   hosts: [<span class="string">"172.18.135.1:9200"</span>]</span><br><span class="line">85   index <span class="string">"filebeat-nginx-accesslog"</span>   <span class="comment">#默认的index名称 filebeat-%&#123;+yyyy.MM.DD&#125;</span></span><br></pre></td></tr></table></figure></p><p>4：启动filebeat<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># systemctl start filebeat</span></span><br><span class="line">~]<span class="comment"># systemctl enable filebeat</span></span><br></pre></td></tr></table></figure></p><p>5：在ES主机上的head插件查看索引  </p><p>6：在kinban展示日志</p><hr><h2 id="filebeat收集nginx访问日志并写入redis（nginx日志格式需要改为json格式）"><a href="#filebeat收集nginx访问日志并写入redis（nginx日志格式需要改为json格式）" class="headerlink" title="filebeat收集nginx访问日志并写入redis（nginx日志格式需要改为json格式）"></a>filebeat收集nginx访问日志并写入redis（nginx日志格式需要改为json格式）</h2><p>Filebeat支持将数据直接写入到redis服务器，本步骤为写入到redis当中的一个可以，另外filebeat还支持写入到elasticsearch、logstash等服务器。</p><p>1：filebeat配置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/filebeat/filebeat.yml </span></span><br><span class="line">21   paths:</span><br><span class="line">22     - /var/<span class="built_in">log</span>/nginx/access.log</span><br><span class="line"></span><br><span class="line">39   fields:        <span class="comment">#定义type，格式很重要</span></span><br><span class="line">40         <span class="built_in">type</span>: nginx-accesslog</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">116 output.redis:       <span class="comment">#将日志输出至redis</span></span><br><span class="line">117   hosts: [<span class="string">"172.18.135.5"</span>]       <span class="comment">#redis地址</span></span><br><span class="line">118   password: <span class="string">"123456"</span>            <span class="comment">#redis密码</span></span><br><span class="line">119   key: <span class="string">"system-log-5612"</span>        <span class="comment">#KEY名称（自定义）</span></span><br><span class="line">120   db: 1                         <span class="comment">#存储到redis的库</span></span><br><span class="line">121   timeout: 5                    <span class="comment">#超时时长</span></span><br></pre></td></tr></table></figure></p><p>2：启动filebeat<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># systemctl start filebeat</span></span><br><span class="line">~]<span class="comment"># systemctl enable filebeat</span></span><br></pre></td></tr></table></figure></p><p>3：测试访问nginx 默认的web页面,验证日志的格式是否为json<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># curl 172.18.135.5:80</span></span><br><span class="line"> ~]<span class="comment"># cat /var/log/nginx/access.log </span></span><br><span class="line">&#123;<span class="string">"@timestamp"</span>:<span class="string">"2019-03-03T16:38:24+08:00"</span>,<span class="string">"host"</span>:<span class="string">"172.18.135.5"</span>,<span class="string">"clientip"</span>:<span class="string">"172.18.135.5"</span>,<span class="string">"size"</span>:3700,<span class="string">"responsetime"</span>:0.000,<span class="string">"upstreamtime"</span>:<span class="string">"-"</span>,<span class="string">"upstreamhost"</span>:<span class="string">"-"</span>,<span class="string">"http_host"</span>:<span class="string">"172.18.135.5"</span>,<span class="string">"url"</span>:<span class="string">"/index.html"</span>,<span class="string">"domain"</span>:<span class="string">"172.18.135.5"</span>,<span class="string">"xff"</span>:<span class="string">"-"</span>,<span class="string">"referer"</span>:<span class="string">"-"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>&#125;</span><br><span class="line">&#123;<span class="string">"@timestamp"</span>:<span class="string">"2019-03-03T16:38:25+08:00"</span>,<span class="string">"host"</span>:<span class="string">"172.18.135.5"</span>,<span class="string">"clientip"</span>:<span class="string">"172.18.135.5"</span>,<span class="string">"size"</span>:3700,<span class="string">"responsetime"</span>:0.000,<span class="string">"upstreamtime"</span>:<span class="string">"-"</span>,<span class="string">"upstreamhost"</span>:<span class="string">"-"</span>,<span class="string">"http_host"</span>:<span class="string">"172.18.135.5"</span>,<span class="string">"url"</span>:<span class="string">"/index.html"</span>,<span class="string">"domain"</span>:<span class="string">"172.18.135.5"</span>,<span class="string">"xff"</span>:<span class="string">"-"</span>,<span class="string">"referer"</span>:<span class="string">"-"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>&#125;</span><br></pre></td></tr></table></figure></p><p>3：验证redis是否有数据(指定查看对用的库)<br><img src="/2019/03/03/ELK之使用filebeat替换logstash/3.png" alt=""></p><p>4：查看redis中的日志数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">注意选择的db是否和filebeat写入一致</span><br><span class="line"></span><br><span class="line">172.18.135.2:6379&gt; select 1</span><br><span class="line">OK</span><br><span class="line">172.18.135.2:6379[1]&gt; RPOP system-log-5612</span><br><span class="line"><span class="string">"&#123;\"@timestamp\":\"2019-03-03T10:04:39.966Z\",\"beat\":&#123;\"hostname\":\"centos77\",\"name\":\"centos77\",\"version\":\"5.6.13\"&#125;,\"fields\":&#123;\"type\":\"nginx-accesslog\"&#125;,\"input_type\":\"log\",\"message\":\"&#123;\\\"@timestamp\\\":\\\"2019-03-03T18:04:37+08:00\\\",\\\"host\\\":\\\"172.18.135.5\\\",\\\"clientip\\\":\\\"172.18.135.5\\\",\\\"size\\\":3700,\\\"responsetime\\\":0.000,\\\"upstreamtime\\\":\\\"-\\\",\\\"upstreamhost\\\":\\\"-\\\",\\\"http_host\\\":\\\"172.18.135.5\\\",\\\"url\\\":\\\"/index.html\\\",\\\"domain\\\":\\\"172.18.135.5\\\",\\\"xff\\\":\\\"-\\\",\\\"referer\\\":\\\"-\\\",\\\"status\\\":\\\"200\\\"&#125;\",\"offset\":9248,\"source\":\"/var/log/nginx/access.log\",\"type\":\"log\"&#125;"</span></span><br></pre></td></tr></table></figure></p><p><img src="/2019/03/03/ELK之使用filebeat替换logstash/11.png" alt=""></p><p>截图补充：对应关系要对应好<br><img src="/2019/03/03/ELK之使用filebeat替换logstash/12.png" alt=""></p><p>5：配置logstash从redis读取上面的日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim   /etc/logstash/conf.d/redis-systemlog-es.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  redis &#123;</span><br><span class="line">    host =&gt; <span class="string">"192.168.15.12"</span>         <span class="comment">#指定redis地址</span></span><br><span class="line">    port =&gt; <span class="string">"6379"</span></span><br><span class="line">    password =&gt; <span class="string">"123456"</span>           <span class="comment">#指定redis密码         </span></span><br><span class="line">    db =&gt; <span class="string">"1"</span>                      <span class="comment">#从redis哪个库中取数据，需要和filebeat存储时指定的库序号保持一致</span></span><br><span class="line">    key =&gt; <span class="string">"system-log-1512"</span>       <span class="comment">#从redis取出的KEY的名称，需要和filebeat存储仅redis时的KEY名称保持一致</span></span><br><span class="line">    data_type =&gt; <span class="string">"list"</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [fields][<span class="built_in">type</span>] == <span class="string">"nginx-accesslog"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [<span class="string">"192.168.15.11:9200"</span>]   <span class="comment">#ES主机地址</span></span><br><span class="line">       index =&gt; <span class="string">"system-log-1512"</span>  <span class="comment">#定义存储的索引名称</span></span><br><span class="line">      codec =&gt; <span class="string">"json"</span></span><br><span class="line">&#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># systemctl  restart logstash #重启logstash服务</span></span><br></pre></td></tr></table></figure></p><p>6：查看logstash服务日志<br><img src="/2019/03/03/ELK之使用filebeat替换logstash/5.png" alt=""></p><p><img src="/2019/03/03/ELK之使用filebeat替换logstash/6.png" alt=""></p><p>7：查看redis中是否有数据</p><p><img src="/2019/03/03/ELK之使用filebeat替换logstash/7.png" alt=""></p><p>8：在ES的head插件验证索引是否创建<br><img src="/2019/03/03/ELK之使用filebeat替换logstash/8.png" alt=""></p><p>9：kibana界面添加索引<br><img src="/2019/03/03/ELK之使用filebeat替换logstash/9.png" alt=""></p><p>10：在kibana验证system日志<br><img src="/2019/03/03/ELK之使用filebeat替换logstash/10.png" alt=""></p><p>11：监控redis数据长度</p><p>实际环境当中，可能会出现reids当中堆积了大量的数据而logstash由于种种原因未能及时提取日志，此时会导致redis服务器的内存被大量使用，甚至出现如下内存即将被使用完毕的情景：</p><p><img src="/2019/03/03/ELK之使用filebeat替换logstash/13.png" alt=""></p><p>12：查看reids中的日志队列长度发现有大量的日志堆积在redis 当中</p><p><img src="/2019/03/03/ELK之使用filebeat替换logstash/14.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ELK之使用filebeat替换logstash&quot;&gt;&lt;a href=&quot;#ELK之使用filebeat替换logstash&quot; class=&quot;headerlink&quot; title=&quot;ELK之使用filebeat替换logstash&quot;&gt;&lt;/a&gt;ELK之使用filebeat替换logstash&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/03/03/ELK之使用filebeat替换logstash/标题.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>zookeeper和kafka</title>
    <link href="https://daizhe.net.cn/2019/02/23/ELK%E4%B9%8Bzookeeper%E5%92%8Ckafka/"/>
    <id>https://daizhe.net.cn/2019/02/23/ELK之zookeeper和kafka/</id>
    <published>2019-02-23T08:47:13.894Z</published>
    <updated>2019-03-03T04:13:42.963Z</updated>
    
    <content type="html"><![CDATA[<h1 id="zookeeper和kafka"><a href="#zookeeper和kafka" class="headerlink" title="zookeeper和kafka"></a>zookeeper和kafka</h1><p><img src="/2019/02/23/ELK之zookeeper和kafka/标题.png" alt=""><br><a id="more"></a></p><h1 id="kafka及zookeeper简介："><a href="#kafka及zookeeper简介：" class="headerlink" title="kafka及zookeeper简介："></a>kafka及zookeeper简介：</h1><ul><li>Kafka （默认port：9092）被称为下一代分布式消息系统，是非营利性组织ASF(Apache Software Foundation，简称为ASF)基金会中的一个开源项目，比如HTTP Server、Hadoop、ActiveMQ、Tomcat等开源软件都属于Apache基金会的开源软件，类似的消息系统还有RbbitMQ、ActiveMQ、ZeroMQ，最主要的优势是其具备分布式功能、并且结合zookeeper可以实现动态扩容。</li><li>官方站点：<a href="http://www.infoq.com/cn/articles/apache-kafka" target="_blank" rel="noopener">http://www.infoq.com/cn/articles/apache-kafka</a></li></ul><p><img src="/2019/02/23/ELK之zookeeper和kafka/1.png" alt=""></p><ul><li>ZooKeeper（默认port：2181）是一个分布式且开源的分布式应用程序协调服务。<ul><li>zookeeper集群特性：整个集群中只要有超过集群数量一半的zookeeper工作是正常的，那么整个集群对外就是可用的，假如有2台服务器做了一个zookeeper集群，只要有任何一台故障或宕机，那么这个zookeeper集群就不可用了，因为剩下的一台没有超过集群一半的数量，但是假如有三台zookeeper组成一个集群，那么损坏一台就还剩两台，大于3台的一半，所以损坏一台还是可以正常运行的，但是再损坏一台就只剩一台集群就不可用了。那么要是4台组成一个zookeeper集群，损坏一台集群肯定是正常的，那么损坏两台就还剩两台，那么2台不大于集群数量的一半，所以3台的zookeeper集群和4台的zookeeper集群损坏两台的结果都是集群不可用，一次类推5台和6台以及7台和8台都是同理，所以这也就是为什么集群一般都是奇数的原因。</li></ul></li></ul><p><img src="/2019/02/23/ELK之zookeeper和kafka/3.png" alt=""></p><h1 id="zookeeper集群部署"><a href="#zookeeper集群部署" class="headerlink" title="zookeeper集群部署"></a>zookeeper集群部署</h1><h2 id="安装zookeeper："><a href="#安装zookeeper：" class="headerlink" title="安装zookeeper："></a>安装zookeeper：</h2><p>三台服务器：  备注：也可以将ZK和KF集群安装在6台主机上各三台<br>IP分别是：172.18.135.1 &ensp;&ensp;  172.18.135.2  &ensp;&ensp; 172.18.135.5  </p><p>1：三台服务器分别配置hosts文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat /etc/hosts</span><br><span class="line">127.0.0.1   localhost localhost.localdomain localhost4 localhost4.localdomain4</span><br><span class="line">::1         localhost localhost.localdomain localhost6 localhost6.localdomain6</span><br><span class="line">172.18.135.1  es1.com</span><br><span class="line">172.18.135.2  es2.com</span><br><span class="line">172.18.135.5  es5.com</span><br></pre></td></tr></table></figure></p><p>2：zookeeper的安装是依赖java环境的,三台主机安装java，JDK<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># java -version</span></span><br><span class="line">openjdk version <span class="string">"1.8.0_161"</span></span><br><span class="line">OpenJDK Runtime Environment (build 1.8.0_161-b14)</span><br><span class="line">OpenJDK 64-Bit Server VM (build 25.161-b14, mixed mode)</span><br></pre></td></tr></table></figure></p><p>3：下载安装并验证zookeeper：<br>kafka下载地址：<br><a href="http://kafka.apache.org/downloads.html" target="_blank" rel="noopener">http://kafka.apache.org/downloads.html</a>  </p><p>zookeeper 下载地址：<br><a href="http://zookeeper.apache.org/releases.html" target="_blank" rel="noopener">http://zookeeper.apache.org/releases.html</a>  </p><p>4：三台主机安装zookeeper(需要依赖java环境)：</p><ul><li>ZooKeeper是一个分布式且开源的分布式应用程序协调服务。<ul><li>zookeeper集群特性：整个集群中只要有超过集群数量一半的zookeeper工作是正常的，那么整个集群对外就是可用的，假如有2台服务器做了一个zookeeper集群，只要有任何一台故障或宕机，那么这个zookeeper集群就不可用了，因为剩下的一台没有超过集群一半的数量，但是假如有三台zookeeper组成一个集群，那么损坏一台就还剩两台，大于3台的一半，所以损坏一台还是可以正常运行的，但是再损坏一台就只剩一台集群就不可用了。那么要是4台组成一个zookeeper集群，损坏一台集群肯定是正常的，那么损坏两台就还剩两台，那么2台不大于集群数量的一半，所以3台的zookeeper集群和4台的zookeeper集群损坏两台的结果都是集群不可用，一次类推5台和6台以及7台和8台都是同理，所以这也就是为什么集群一般都是奇数的原因。</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">三台主机都要编译安装zookeeper（配置相同，配置如下）</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line">  src]<span class="comment"># ls</span></span><br><span class="line">  zookeeper-3.4.13.tar.gz</span><br><span class="line"></span><br><span class="line">  src]<span class="comment"># tar xvf zookeeper-3.4.13.tar.gz </span></span><br><span class="line"></span><br><span class="line">创建软连接方便下次升级</span><br><span class="line"></span><br><span class="line">  src]<span class="comment"># ln -sv /usr/local/src/zookeeper-3.4.13 /usr/local/zookeeper</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">三台主机配置zookeeper配置的文件</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cp  /usr/local/zookeeper/conf/zoo_sample.cfg  /usr/local/zookeeper/conf/zoo.cfg </span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># grep "^[a-Z]" /usr/local/zookeeper/conf/zoo.cfg</span></span><br><span class="line">  tickTime=2000</span><br><span class="line">  initLimit=10</span><br><span class="line">  syncLimit=5</span><br><span class="line">  dataDir=/usr/<span class="built_in">local</span>/zookeeper/data</span><br><span class="line">  clientPort=2181</span><br><span class="line">  maxClientCnxns=4096</span><br><span class="line">  autopurge.snapRetainCount=3</span><br><span class="line">  autopurge.purgeInterval=72</span><br><span class="line">  server.1=172.18.135.1:2888:3888</span><br><span class="line">  server.2=172.18.135.2:2888:3888</span><br><span class="line">  server.3=172.18.135.5:2888:3888</span><br><span class="line"></span><br><span class="line">三台主机创建zookeeper数据目录</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># mkdir  /usr/local/zookeeper/data</span></span><br><span class="line"></span><br><span class="line">在三台主机上手动生成serverID</span><br><span class="line"></span><br><span class="line">172.18.135.1</span><br><span class="line">  ~]<span class="comment"># echo "1" &gt; /usr/local/zookeeper/data/myid</span></span><br><span class="line"></span><br><span class="line">172。18.135.2</span><br><span class="line">  ~]<span class="comment"># echo "2" &gt; /usr/local/zookeeper/data/myid</span></span><br><span class="line"></span><br><span class="line">172.18.135.5</span><br><span class="line">  ~]<span class="comment"># echo "3" &gt; /usr/local/zookeeper/data/myid</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">三台机器启动zookeeper</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># ls /usr/local/zookeeper/bin/</span></span><br><span class="line">  zkServer.sh   <span class="comment">#启动服务端脚本</span></span><br><span class="line">  zkCli.sh      <span class="comment">#启动客户端脚本</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># /usr/local/zookeeper/bin/zkServer.sh  start</span></span><br><span class="line">  ZooKeeper JMX enabled by default</span><br><span class="line">  Using config: /usr/<span class="built_in">local</span>/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">  Starting zookeeper ... STARTED</span><br><span class="line"></span><br><span class="line">查看各主机的端口是否监听  </span><br><span class="line"><span class="comment">#启动zookeeper进程时，已经将角色身份分配好，如果为领导者端口为3888，2181，2888，如果身份为跟随者端口为2181，2888</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  ::ffff:172.18.135.2:3888   </span><br><span class="line">                   :::2181                                                              </span><br><span class="line">  ::ffff:172.18.135.2:2888</span><br></pre></td></tr></table></figure><p>zookeeper配置文件详解<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">src]<span class="comment"># grep "^[a-Z]" /usr/local/zookeeper/conf/zoo.cfg </span></span><br><span class="line">tickTime=2000  <span class="comment">#服务器与服务器之间和客户端与服务器之间的单次心跳检测时间间隔，单位为毫秒</span></span><br><span class="line">initLimit=5  <span class="comment">#集群中leader服务器与follower服务器初始连接心跳次数，即多少个2000毫秒</span></span><br><span class="line">syncLimit=5  <span class="comment"># leader与follower之间连接完成之后，后期检测发送和应答的心跳次数，如果该follower 在设置的时间内(5*2000)不能与leader 进行通信，那么此 follower 将被视为不可用。</span></span><br><span class="line">clientPort=2181 <span class="comment">#客户端连接 Zookeeper 服务器的端口，Zookeeper 会监听这个端口，接受客户端的访问请求</span></span><br><span class="line">dataDir=/usr/<span class="built_in">local</span>/zookeeper/data  <span class="comment">#自定义的zookeeper保存数据的目录</span></span><br><span class="line">autopurge.snapRetainCount=3 <span class="comment">#设置zookeeper保存保留多少次客户端连接的数据</span></span><br><span class="line">autopurge.purgeInterval=1 <span class="comment">#设置zookeeper间隔多少小时清理一次保存的客户端数据（单位为小时，0为关闭自动清理）</span></span><br><span class="line">server.1=192.168.15.211:2888:3888  <span class="comment">#服务器编号=服务器IP:LF数据同步端口:LF选举端口</span></span><br><span class="line">server.2=192.168.15.212:2888:3888</span><br><span class="line">server.3=192.168.15.213:2888:3888</span><br></pre></td></tr></table></figure></p><p>5：查看各主机的zookeeper节点状态信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">java程序往leader中写入数据，从follower中读取数据，此功能是基于底层的java库实现的</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment">#  /usr/local/zookeeper/bin/zkServer.sh  status</span></span><br><span class="line">  ZooKeeper JMX enabled by default</span><br><span class="line">  Using config: /usr/<span class="built_in">local</span>/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">  Mode: leader    <span class="comment">#角色：领导者/追随者</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># /usr/local/zookeeper/bin/zkServer.sh  status</span></span><br><span class="line">  ZooKeeper JMX enabled by default</span><br><span class="line">  Using config: /usr/<span class="built_in">local</span>/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">  Mode: follower  </span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># /usr/local/zookeeper/bin/zkServer.sh  status</span></span><br><span class="line">  ZooKeeper JMX enabled by default</span><br><span class="line">  Using config: /usr/<span class="built_in">local</span>/zookeeper/bin/../conf/zoo.cfg</span><br><span class="line">  Mode: follower</span><br></pre></td></tr></table></figure></p><h2 id="zookeeper简单操作测试"><a href="#zookeeper简单操作测试" class="headerlink" title="zookeeper简单操作测试"></a>zookeeper简单操作测试</h2><p>6：连接到leader节点生成数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">客户端链接至领导者节点</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment">#  /usr/local/zookeeper/bin/zkCli.sh -server 172.18.135.2:2181    #指定server端的节点地址和端口</span></span><br><span class="line"></span><br><span class="line">在/下创建消息</span><br><span class="line"></span><br><span class="line">  [zk: 172.18.135.2:2181(CONNECTED) 0]  create /<span class="built_in">test</span> <span class="string">"hello"</span></span><br><span class="line">  Created /<span class="built_in">test</span></span><br></pre></td></tr></table></figure></p><p>7：链接到follower节点查看消息是否同步leader节点<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">客户端连接至跟随者节点查看消息</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># /usr/local/zookeeper/bin/zkCli.sh -server 172.18.135.1:2181</span></span><br><span class="line">  [zk: 172.18.135.1:2181(CONNECTED) 0] get /<span class="built_in">test</span></span><br><span class="line">  hello</span><br><span class="line">  cZxid = 0x100000004</span><br><span class="line">  ctime = Sat Feb 23 19:11:52 CST 2019</span><br><span class="line">  mZxid = 0x100000004</span><br><span class="line">  mtime = Sat Feb 23 19:11:52 CST 2019</span><br><span class="line">  pZxid = 0x100000004</span><br><span class="line">  cversion = 0</span><br><span class="line">  dataVersion = 0</span><br><span class="line">  aclVersion = 0</span><br><span class="line">  ephemeralOwner = 0x0</span><br><span class="line">  dataLength = 5</span><br><span class="line">  numChildren = 0</span><br></pre></td></tr></table></figure></p><hr><h1 id="kafka-集群部署"><a href="#kafka-集群部署" class="headerlink" title="kafka 集群部署"></a>kafka 集群部署</h1><ul><li>kafka：（端口9092）<ul><li>Broker <ul><li>Kafka集群包含一个或多个服务器，这种服务器被称为broker</li></ul></li><li>Topic <ul><li>每条发布到Kafka集群的消息都有一个类别，这个类别被称为topic。（物理上不同topic的消息分开存储，逻辑上一个topic的消息虽然保存于一个或多个broker上但用户只需指定消息的topic即可生产或消费数据而不必关心数据存于何处）</li></ul></li><li>Partition <ul><li>parition是物理上的概念，每个topic包含一个或多个partition，创建topic时可指定parition数量。每个partition对应于一个文件夹，该文件夹下存储该partition的数据和索引文件</li></ul></li><li>Producer <ul><li>生产消息，负责发布消息到Kafka broker</li></ul></li><li>Consumer <ul><li>消费消息。每个consumer属于一个特定的consuer group（可为每个consumer指定group name，若不指定group name则属于默认的group）。使用consumer high level API时，同一topic的一条消息只能被同一个consumer group内的一个consumer消费，但多个consumer group可同时消费这一消息。</li></ul></li></ul></li></ul><p>1：在上面安装zookeeper的三台主机上安装kafka<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">安装解压</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line">  src]<span class="comment"># ls</span></span><br><span class="line">  kafka_2.12-2.1.0.tgz </span><br><span class="line"></span><br><span class="line">  src]<span class="comment"># tar xvf kafka_2.12-2.1.0.tgz </span></span><br><span class="line"></span><br><span class="line">  src]<span class="comment"># ln -sv /usr/local/src/kafka_2.12-2.1.0 /usr/local/kafka</span></span><br><span class="line">  ‘/usr/<span class="built_in">local</span>/kafka’ -&gt; ‘/usr/<span class="built_in">local</span>/src/kafka_2.12-2.1.0’</span><br><span class="line"></span><br><span class="line">编辑各配置文件</span><br><span class="line"></span><br><span class="line">  172.18.135.1</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /usr/local/kafka/config/server.properties </span></span><br><span class="line">  21 broker.id=1  <span class="comment">#设置每个代理全局唯一的整数ID</span></span><br><span class="line">  31 listeners=PLAINTEXT://172.18.135.1:9092  <span class="comment">#指定kafka监听的本机地址</span></span><br><span class="line">  60 log.dirs=/usr/<span class="built_in">local</span>/kafka/logs   <span class="comment">#指定kafka保存日志的位置</span></span><br><span class="line">  65 num.partitions=1 <span class="comment">#kafka分区，一个数据仅保留一个分区</span></span><br><span class="line">  103 log.retention.hours=72  <span class="comment">#保留指定小时的日志内容</span></span><br><span class="line">  123 zookeeper.connect=172.18.135.1:2181,172.18.135.2:2181,172.18.135.5:2181 <span class="comment">#所有的zookeeper地址，让zookeeper注册在kafka中</span></span><br><span class="line"></span><br><span class="line">  创建日志存放的目录</span><br><span class="line">  ~]<span class="comment"># mkdir -p /usr/local/kafka/logs</span></span><br><span class="line"></span><br><span class="line">  172.18.135.2</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /usr/local/kafka/config/server.properties </span></span><br><span class="line">  21 broker.id=2</span><br><span class="line">  31 listeners=PLAINTEXT://172.18.135.2:9092</span><br><span class="line">  60 log.dirs=/usr/<span class="built_in">local</span>/kafka/logs</span><br><span class="line">  65 num.partitions=1</span><br><span class="line">  103 log.retention.hours=72</span><br><span class="line">  123 zookeeper.connect=172.18.135.1:2181,172.18.135.2:2181,172.18.135.5:2181</span><br><span class="line">  创建日志存放的目录</span><br><span class="line">  ~]<span class="comment"># mkdir -p /usr/local/kafka/logs</span></span><br><span class="line"></span><br><span class="line">  172.18.135.5</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /usr/local/kafka/config/server.properties </span></span><br><span class="line">  21 broker.id=3</span><br><span class="line">  31 listeners=PLAINTEXT://172.18.135.5:9092</span><br><span class="line">  60 log.dirs=/usr/<span class="built_in">local</span>/kafka/logs</span><br><span class="line">  65 num.partitions=1</span><br><span class="line">  103 log.retention.hours=72</span><br><span class="line">  123 zookeeper.connect=172.18.135.1:2181,172.18.135.2:2181,172.18.135.5:2181</span><br><span class="line">  创建日志存放的目录</span><br><span class="line">  ~]<span class="comment"># mkdir -p /usr/local/kafka/logs</span></span><br></pre></td></tr></table></figure></p><p>2：各主机启动kafka<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/local/kafka/bin/kafka-server-start.sh -daemon /usr/local/kafka/config/server.properties  #以守护进程的方式启动</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># ss -tnl</span></span><br><span class="line">::ffff:172.18.135.2:9092  <span class="comment">#kafka监听端口</span></span><br></pre></td></tr></table></figure></p><h2 id="将zookeeper和kafka加入开机启动项中"><a href="#将zookeeper和kafka加入开机启动项中" class="headerlink" title="将zookeeper和kafka加入开机启动项中"></a>将zookeeper和kafka加入开机启动项中</h2><p>将各主机的kafka和zookeeper程序设置为开机自启<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/rc.d/rc.local </span></span><br><span class="line">/usr/<span class="built_in">local</span>/zookeeper/bin/zkServer.sh  start</span><br><span class="line">sleep 20</span><br><span class="line">/usr/<span class="built_in">local</span>/kafka/bin/kafka-server-start.sh -daemon /usr/<span class="built_in">local</span>/kafka/config/server.properties</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># chmod +x /etc/rc.d/rc.local</span></span><br></pre></td></tr></table></figure></p><h2 id="zookeeper命令测试"><a href="#zookeeper命令测试" class="headerlink" title="zookeeper命令测试"></a>zookeeper命令测试</h2><p>1：验证kafka进程<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># jps</span></span><br><span class="line">26450 Jps</span><br><span class="line">1079 Elasticsearch</span><br><span class="line">10905 QuorumPeerMain</span><br><span class="line">19790 Kafka</span><br></pre></td></tr></table></figure></p><p>2：测试zookeeper创建topic：创建名为logstashtest，partitions(分区)为3，replication(复制)为3的topic(主题)：<br>在任意kafaka服务器操作：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/local/kafka/bin/kafka-topics.sh --create  --zookeeper 172.18.135.1:2181,172.18.135.2:2181,172.18.135.5:2181 --partitions 3 --replication-factor 3 --topic logstashtest</span></span><br><span class="line">Created topic <span class="string">"logstashtest"</span>.</span><br></pre></td></tr></table></figure></p><p>3：测试zookeeper获取topic<br>可以在任意一台kafka服务器进行测试：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/local/kafka/bin/kafka-topics.sh  --describe --zookeeper 172.18.135.1:2181,172.18.135.2:2181,172.18.135.5:2181  --topic logstashtest</span></span><br><span class="line">Topic:logstashtestPartitionCount:3ReplicationFactor:3Configs:</span><br><span class="line"> Topic: logstashtestPartition: 0Leader: 1     Replicas: 1,3,2Isr: 1,2,3</span><br><span class="line"> Topic: logstashtestPartition: 1Leader: 2     Replicas: 2,1,3Isr: 2,1,3</span><br><span class="line"> Topic: logstashtestPartition: 2Leader: 3     Replicas: 3,2,1Isr: 3,2,1</span><br></pre></td></tr></table></figure></p><ul><li>状态说明：logstashtest有三个分区分别为0、1、2，分区0的leader是3（broker.id），分区0有三个副本，并且状态都为lsr（ln-sync，表示可以参加选举成为leader）。</li></ul><p>4：获取所有topic<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/local/kafka/bin/kafka-topics.sh  --list --zookeeper 172.18.135.1:2181,172.18.135.2:2181,172.18.135.5:2181</span></span><br><span class="line">logstashtest</span><br></pre></td></tr></table></figure></p><p>5：删除topic<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment">#/usr/local/kafka/bin/kafka-topics.sh --delete --zookeeper 172.18.135.1:2181,172.18.135.2:2181,172.18.135.5:2181  --topic logstashtest</span></span><br></pre></td></tr></table></figure></p><h2 id="kafka命令测试消息发送"><a href="#kafka命令测试消息发送" class="headerlink" title="kafka命令测试消息发送"></a>kafka命令测试消息发送</h2><p>1：创建topic<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/local/kafka/bin/kafka-topics.sh --create --zookeeper 172.18.135.1:2181,172.18.135.2:2181,172.18.135.5:2181 --partitions 3 --replication-factor 3 --topic  messagetest</span></span><br><span class="line">Created topic <span class="string">"messagetest"</span>.</span><br></pre></td></tr></table></figure></p><p>2：发送消息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/local/kafka/bin/kafka-console-producer.sh --broker-list  172.18.135.1:9092,172.18.135.2:9092,172.18.135.3:9092 --topic  messagetest</span></span><br></pre></td></tr></table></figure></p><hr><h2 id="使用logstash测试向kafka写入数据"><a href="#使用logstash测试向kafka写入数据" class="headerlink" title="使用logstash测试向kafka写入数据"></a>使用logstash测试向kafka写入数据</h2><p><img src="/2019/02/23/ELK之zookeeper和kafka/2.png" alt=""></p><h3 id="测试使用logstash测试向kafka写入数据"><a href="#测试使用logstash测试向kafka写入数据" class="headerlink" title="测试使用logstash测试向kafka写入数据"></a>测试使用logstash测试向kafka写入数据</h3><p>logstash收集日志标准输出至kafka参考官方文档:<a href="https://www.elastic.co/guide/en/logstash/5.6/plugins-outputs-kafka.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/5.6/plugins-outputs-kafka.html</a></p><p>1：编辑logstash配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/logstash/conf.d/logstash-kafka.sh</span></span><br><span class="line"></span><br><span class="line">input &#123;     <span class="comment">#标准输入为收集桌面信息</span></span><br><span class="line">  stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line">output &#123;    <span class="comment">#logstash收集日志写入kafka中</span></span><br><span class="line">  kafka &#123;</span><br><span class="line">      codec =&gt; json </span><br><span class="line">      topic_id =&gt; <span class="string">"messagetest"</span>   <span class="comment">#指定写入的topic，如果指定的topic在kafka集群中不存在，则kafka自动创建此topic</span></span><br><span class="line">      bootstrap_servers =&gt; <span class="string">"172.18.135.1:9092"</span>    <span class="comment">#指定集群中任意kafka的地址</span></span><br><span class="line">      batch_size =&gt; 5   </span><br><span class="line">  &#125;</span><br><span class="line">  stdout &#123;    <span class="comment">#logstash收集的日志再在终端中打印一份</span></span><br><span class="line">      codec =&gt; rubydebug  </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2：检查logstash配置文件的语法格式并启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/logstash-kafka.sh -t</span></span><br><span class="line">WARNING: Could not find logstash.yml <span class="built_in">which</span> is typically located <span class="keyword">in</span> <span class="variable">$LS_HOME</span>/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config <span class="built_in">which</span> logs errors to the console</span><br><span class="line">Configuration OK</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/logstash-kafka.sh</span></span><br></pre></td></tr></table></figure></p><p>3：验证kafka收到logstash数据</p><p>3.1：logstash启动，标准输入为桌面<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/logstash-kafka.sh</span></span><br><span class="line">[INFO ] 2019-03-02 18:44:19.332 [[main]-pipeline-manager] AppInfoParser - Kafka version : 0.10.0.1</span><br><span class="line">[INFO ] 2019-03-02 18:44:19.333 [[main]-pipeline-manager] AppInfoParser - Kafka commitId : a7a17cdec9eaa6c5</span><br><span class="line">The stdin plugin is now waiting <span class="keyword">for</span> input:</span><br><span class="line">haha</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">        <span class="string">"host"</span> =&gt; <span class="string">"es3.com"</span>,</span><br><span class="line">  <span class="string">"@timestamp"</span> =&gt; 2019-03-02T10:45:27.185Z,</span><br><span class="line">     <span class="string">"message"</span> =&gt; <span class="string">"haha"</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">logstash</span><br><span class="line">&#123;</span><br><span class="line">    <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">        <span class="string">"host"</span> =&gt; <span class="string">"es3.com"</span>,</span><br><span class="line">  <span class="string">"@timestamp"</span> =&gt; 2019-03-02T10:49:07.782Z,</span><br><span class="line">     <span class="string">"message"</span> =&gt; <span class="string">"logstash"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>3.2：kafka集群也监听的messagetest topic<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/local/kafka/bin/kafka-console-consumer.sh --topic messagetest --bootstrap-server 172.18.135.1:9092 --from-beginning</span></span><br><span class="line">haha</span><br><span class="line">&#123;<span class="string">"@version"</span>:<span class="string">"1"</span>,<span class="string">"host"</span>:<span class="string">"es3.com"</span>,<span class="string">"@timestamp"</span>:<span class="string">"2019-03-02T10:45:27.185Z"</span>,<span class="string">"message"</span>:<span class="string">"haha"</span>&#125;</span><br><span class="line">&#123;<span class="string">"@version"</span>:<span class="string">"1"</span>,<span class="string">"host"</span>:<span class="string">"es3.com"</span>,<span class="string">"@timestamp"</span>:<span class="string">"2019-03-02T10:49:07.782Z"</span>,<span class="string">"message"</span>:<span class="string">"logstash"</span>&#125;</span><br></pre></td></tr></table></figure></p><hr><h3 id="后端logstash收集单个Nginx日志文件缓存到zk和KF集群，ZK和KF集群上的logstash再取走存储到ES中"><a href="#后端logstash收集单个Nginx日志文件缓存到zk和KF集群，ZK和KF集群上的logstash再取走存储到ES中" class="headerlink" title="后端logstash收集单个Nginx日志文件缓存到zk和KF集群，ZK和KF集群上的logstash再取走存储到ES中"></a>后端logstash收集单个Nginx日志文件缓存到zk和KF集群，ZK和KF集群上的logstash再取走存储到ES中</h3><p>1：编辑Logstash配置文件，收集nginx日志的logstash，再将收集的日志文件存储到ZK和KF集群中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim  /etc/logstash/conf.d/nginx-kafka.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/var/log/nginx/access.log"</span></span><br><span class="line">    start_position =&gt; <span class="string">"beginning"</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"nginx-accesslog-1512"</span></span><br><span class="line">    codec =&gt; <span class="string">"json"</span> <span class="comment">#声明json编码格式</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"nginx-accesslog-1512"</span> &#123;</span><br><span class="line">    kafka &#123;</span><br><span class="line">        bootstrap_servers =&gt; <span class="string">"192.168.15.11:9092"</span> <span class="comment">#任意kafka集群中服务器地址</span></span><br><span class="line">        topic_id =&gt; <span class="string">"nginx-accesslog-1512"</span>    <span class="comment">#日志保存在KF中的topic主题名称</span></span><br><span class="line">        codec =&gt; <span class="string">"json"</span>   <span class="comment">#指定日志编码格式</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    file &#123;</span><br><span class="line">      path =&gt; <span class="string">"/tmp/nginx-jsog-log.txt"</span> <span class="comment">#将日志保存在本地文件中一份</span></span><br><span class="line">  &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2：测试logstash配置文件语法格式，并启动logstash<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx-kafka.conf -t</span></span><br><span class="line">WARNING: Could not find logstash.yml <span class="built_in">which</span> is typically located <span class="keyword">in</span> <span class="variable">$LS_HOME</span>/config or /etc/logstash. You can specify the path using --path.sett</span><br><span class="line">ings. Continuing using the defaultsCould not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config <span class="built_in">which</span> logs errors to the console</span><br><span class="line">Configuration OK</span><br><span class="line">~]<span class="comment"># systemctl  restart logstash</span></span><br></pre></td></tr></table></figure></p><p>3:访问Nginx Web界面<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># ab -n100 -c10 http://nginx地址/index.html</span></span><br></pre></td></tr></table></figure></p><p>4：验证日志写入到/tmp 文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># head /tmp/nginx-jsog-log.txt</span></span><br></pre></td></tr></table></figure></p><p><img src="/2019/02/23/ELK之zookeeper和kafka/4.png" alt=""></p><p>5：配置logstash从kafka读取日志（logstash可以安装在ZK和KF集群中的任何一台主机上都可以）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim  /etc/logstash/conf.d/nginx-kafka.conf </span></span><br><span class="line">input &#123;   <span class="comment">#标准输入从KAFKA输入</span></span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers =&gt; <span class="string">"192.168.15.11:9092"</span>   <span class="comment">#任意kafka集群中服务器地址</span></span><br><span class="line">    topics =&gt; <span class="string">"nginx-accesslog-1512"</span>  <span class="comment">#logstash从KF中取走topic的主题名称</span></span><br><span class="line">    codec =&gt; <span class="string">"json"</span> </span><br><span class="line">    consumer_threads =&gt; 1</span><br><span class="line">    <span class="comment">#decorate_events =&gt; true </span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;  <span class="comment">#输出至后端的ES中</span></span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"nginx-accesslog-1512"</span> &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">"ES主机地址:9200"</span>]</span><br><span class="line">    index =&gt; <span class="string">"nginx-accesslog-kafka-1512-%&#123;+YYYY.MM.dd&#125;"</span>    <span class="comment">#指定索引格式</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>6：测试语法并重启logstash<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/kafka-es.conf -t</span></span><br><span class="line">~]<span class="comment"># systemctl  restart logstash</span></span><br></pre></td></tr></table></figure></p><p>7：在ES主机上head插件验证数据<br><img src="/2019/02/23/ELK之zookeeper和kafka/5.png" alt=""></p><p>8：kibana添加Nginx访问日志索引<br><img src="/2019/02/23/ELK之zookeeper和kafka/6.png" alt=""></p><p>9：kibana验证数据<br><img src="/2019/02/23/ELK之zookeeper和kafka/7.png" alt=""></p><hr><h3 id="使用logstash收集多日志文件并写入kafka："><a href="#使用logstash收集多日志文件并写入kafka：" class="headerlink" title="使用logstash收集多日志文件并写入kafka："></a>使用logstash收集多日志文件并写入kafka：</h3><p>1：配置logstash收集message日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">  ~]<span class="comment"># chmod  644 /var/log/messages</span></span><br><span class="line">  conf.d]<span class="comment"># cat nginx-kafka.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/var/log/nginx/access.log"</span></span><br><span class="line">    start_position =&gt; <span class="string">"beginning"</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"nginx-accesslog-1512"</span></span><br><span class="line">    codec =&gt; <span class="string">"json"</span></span><br><span class="line">  &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/var/log/messages"</span></span><br><span class="line">    start_position =&gt; <span class="string">"beginning"</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"system-log-1512"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"nginx-accesslog-1512"</span> &#123;</span><br><span class="line">    kafka &#123;</span><br><span class="line">      bootstrap_servers =&gt; <span class="string">"192.168.15.11:9092"</span></span><br><span class="line">      topic_id =&gt; <span class="string">"nginx-accesslog-1512"</span></span><br><span class="line">      batch_size =&gt; 5</span><br><span class="line">      codec =&gt; <span class="string">"json"</span> </span><br><span class="line">   &#125; &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"system-log-1512"</span> &#123;</span><br><span class="line">    kafka &#123;</span><br><span class="line">      bootstrap_servers =&gt; <span class="string">"192.168.15.11:9092"</span></span><br><span class="line">      topic_id =&gt; <span class="string">"system-log-1512"</span></span><br><span class="line">      batch_size =&gt; 5</span><br><span class="line">      codec =&gt; <span class="string">"json"</span> <span class="comment">#写入的时候使用json编码，因为logstash收集后会转换成json格式</span></span><br><span class="line">  &#125;</span><br><span class="line">    file &#123;</span><br><span class="line">      path =&gt; <span class="string">"/tmp/systemlog-1512-log.txt"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2：测试并重启logstash<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginx-kafka.conf  -t</span></span><br><span class="line">~]<span class="comment"># systemctl  restart logstash</span></span><br></pre></td></tr></table></figure></p><p>3：验证logstash启动完成<br><img src="/2019/02/23/ELK之zookeeper和kafka/8.png" alt=""></p><p>4：验证日志写入到目标文件<br><img src="/2019/02/23/ELK之zookeeper和kafka/9.png" alt=""></p><p>5：配置logstash从kafka读取系统日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#此步骤如果没有从kafka正确收集日志或者将日志从kafka读取并写入到文件没有输出，可以使用/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/kafka-es.conf 进行标准输出测试。</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># cat /etc/logstash/conf.d/kafka-es.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers =&gt; <span class="string">"192.168.15.11:9092"</span> </span><br><span class="line">    topics =&gt; <span class="string">"nginx-accesslog-1512"</span> </span><br><span class="line">    codec =&gt; <span class="string">"json"</span> </span><br><span class="line">    consumer_threads =&gt; 1</span><br><span class="line">    decorate_events =&gt; <span class="literal">true</span> </span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  kafka &#123;</span><br><span class="line">    bootstrap_servers =&gt; <span class="string">"192.168.15.11:9092"</span></span><br><span class="line">    topics =&gt; <span class="string">"system-log-1512"</span></span><br><span class="line">    consumer_threads =&gt; 1</span><br><span class="line">    decorate_events =&gt; <span class="literal">true</span></span><br><span class="line">    codec =&gt; <span class="string">"json"</span> </span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"nginx-accesslog-1512"</span> &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">"192.168.15.11:9200"</span>]</span><br><span class="line">    index =&gt; <span class="string">"nginx-accesslog-1512-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"system-log-1512"</span> &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">"192.168.15.12:9200"</span>]</span><br><span class="line">    index =&gt; <span class="string">"system-log-1512-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">  &#125;</span><br><span class="line">  stdout &#123;</span><br><span class="line">    codec =&gt; <span class="string">"rubydebug"</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>6：验证配置并启动logstash<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/kafka-es.conf –t</span></span><br><span class="line">~]<span class="comment"># systemctl  start logstash</span></span><br></pre></td></tr></table></figure></p><p>7：在head插件验证数据<br><img src="/2019/02/23/ELK之zookeeper和kafka/10.png" alt=""></p><p>8：在kibana添加索引<br><img src="/2019/02/23/ELK之zookeeper和kafka/11.png" alt=""></p><p>9：kibana验证数据<br><img src="/2019/02/23/ELK之zookeeper和kafka/12.png" alt=""></p><hr><h3 id="补充："><a href="#补充：" class="headerlink" title="补充："></a>补充：</h3><ul><li>也可以将logstash开启两个进程去同时收集日志<ul><li>/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/kafka-es.conf    #systemcd 管理的进程去收集日志</li><li>/usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/kafka-es.conf &amp;   # 手动管理的进程去收集日志</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;zookeeper和kafka&quot;&gt;&lt;a href=&quot;#zookeeper和kafka&quot; class=&quot;headerlink&quot; title=&quot;zookeeper和kafka&quot;&gt;&lt;/a&gt;zookeeper和kafka&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/23/ELK之zookeeper和kafka/标题.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>ELK之Logstash收集日志并写入redis</title>
    <link href="https://daizhe.net.cn/2019/02/22/ELK%E4%B9%8BLogstash%E6%94%B6%E9%9B%86%E6%97%A5%E5%BF%97%E5%B9%B6%E5%86%99%E5%85%A5redis/"/>
    <id>https://daizhe.net.cn/2019/02/22/ELK之Logstash收集日志并写入redis/</id>
    <published>2019-02-22T09:34:58.811Z</published>
    <updated>2019-03-03T03:46:42.842Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ELK之Logstash收集日志并写入redis"><a href="#ELK之Logstash收集日志并写入redis" class="headerlink" title="ELK之Logstash收集日志并写入redis"></a>ELK之Logstash收集日志并写入redis</h1><p><img src="/2019/02/22/ELK之Logstash收集日志并写入redis/标题.png" alt=""><br><a id="more"></a></p><p><img src="/2019/02/22/ELK之Logstash收集日志并写入redis/4.png" alt=""></p><h2 id="logstash收集日志并写入redis："><a href="#logstash收集日志并写入redis：" class="headerlink" title="logstash收集日志并写入redis："></a>logstash收集日志并写入redis：</h2><ul><li>用一台服务器按照部署redis服务，专门用于日志缓存使用，用于web服务器产生大量日志的场景，例如下面的服务器内存即将被使用完毕，查看是因为redis服务保存了大量的数据没有被读取而占用了大量的内存空间。</li></ul><p>Redis output plugin 官网解释：<a href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-redis.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/current/plugins-outputs-redis.html</a></p><p>1：部署redis<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># yum install redis -y</span></span><br></pre></td></tr></table></figure></p><p>2：设置redis持久化及访问密码：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">为安全考虑，生产环境必须设置reids连接密码：</span><br><span class="line">[root@linux-host2 redis]<span class="comment"># redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt; config <span class="built_in">set</span> requirepass 12345678  <span class="comment">#动态设置，重启后无效</span></span><br><span class="line">OK</span><br><span class="line"></span><br><span class="line">202~204 注释掉不需要做快照，改为</span><br><span class="line">    save <span class="string">""</span>   <span class="comment">#logstash从redis中将日志数据取走，数据则从redis消失，所以不做快照</span></span><br><span class="line">480 requirepass  123456 <span class="comment">#redis.conf配置文件</span></span><br></pre></td></tr></table></figure></p><p><img src="/2019/02/22/ELK之Logstash收集日志并写入redis/1.png" alt=""></p><p>3:启动并测试redis服务：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">redis]<span class="comment"># redis-server  /usr/local/redis/redis.conf #启动服务</span></span><br><span class="line">redis]<span class="comment"># redis-cli </span></span><br><span class="line">127.0.0.1:6379&gt; ping</span><br><span class="line">PONG</span><br></pre></td></tr></table></figure></p><p>4：配置logstash服务器将日志写入至redis：<br>将tomcat服务器的logstash收集之后的tomcat 访问日志写入到redis服务器，然后通过另外的logstash将redis服务器的数据取出在写入到elasticsearch服务器。</p><p>官方文档：<a href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-redis.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/current/plugins-outputs-redis.html</a></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cat /etc/logstash/conf.d/tomcat_tcp.conf</span></span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/usr/local/tomcat/logs/tomcat_access_log.*.log"</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"tomcat-accesslog-1512"</span></span><br><span class="line">    start_position =&gt; <span class="string">"beginning"</span></span><br><span class="line">    stat_interval =&gt; <span class="string">"2"</span></span><br><span class="line">  &#125;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 7800</span><br><span class="line">    mode =&gt; <span class="string">"server"</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"tcplog-1512"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"tomcat-accesslog-1512"</span> &#123;</span><br><span class="line">    redis &#123;</span><br><span class="line">      data_type =&gt; <span class="string">"list"</span><span class="comment">#以列表的方式写入</span></span><br><span class="line">      key =&gt; <span class="string">"tomcat-accesslog-1512"</span>    <span class="comment">#日志写入redis的key名称</span></span><br><span class="line">      host =&gt; <span class="string">"192.168.15.12"</span>   <span class="comment">#指定redis服务器地址</span></span><br><span class="line">      port =&gt; <span class="string">"6379"</span></span><br><span class="line">      db =&gt; <span class="string">"0"</span><span class="comment">#指定写入的库</span></span><br><span class="line">      password =&gt; <span class="string">"123456"</span>  <span class="comment">#redis密码</span></span><br><span class="line"> &#125;&#125;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"tcplog-1512"</span> &#123;</span><br><span class="line">    redis &#123;</span><br><span class="line">      data_type =&gt; <span class="string">"list"</span></span><br><span class="line">      key =&gt; <span class="string">"tcplog-1512"</span></span><br><span class="line">      host =&gt; <span class="string">"192.168.15.12"</span></span><br><span class="line">      port =&gt; <span class="string">"6379"</span></span><br><span class="line">      db =&gt; <span class="string">"1"</span></span><br><span class="line">      password =&gt; <span class="string">"123456"</span></span><br><span class="line">&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>5：测试logstash配置文件语法是否正确<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tomcat.conf</span></span><br></pre></td></tr></table></figure></p><p>6:访问tomcat的web界面并生成系统日志<br><img src="/2019/02/22/ELK之Logstash收集日志并写入redis/2.png" alt=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># echo "伪设备1"  &gt; /dev/tcp/192.168.15.12/7800</span></span><br></pre></td></tr></table></figure></p><p>7:验证redis是否有数据<br><img src="/2019/02/22/ELK之Logstash收集日志并写入redis/3.png" alt=""></p><p>8: 配置Redis主机上的logstash服务器从redis读取数据：<br>配置专门logstash服务器从redis读取指定的key的数据，并写入到elasticsearch。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-host3 ~]<span class="comment"># cat /etc/logstash/conf.d/redis-to-els.conf </span></span><br><span class="line">[root@linux-host1 conf.d]<span class="comment"># cat /etc/logstash/conf.d/redis-tomcat-es.conf</span></span><br><span class="line">input &#123;</span><br><span class="line">  redis &#123;</span><br><span class="line">    data_type =&gt; <span class="string">"list"</span></span><br><span class="line">    key =&gt; <span class="string">"tomcat-accesslog-1512"</span></span><br><span class="line">    host =&gt; <span class="string">"192.168.15.12"</span></span><br><span class="line">    port =&gt; <span class="string">"6379"</span></span><br><span class="line">    db =&gt; <span class="string">"0"</span></span><br><span class="line">    password =&gt; <span class="string">"123456"</span></span><br><span class="line">    codec =&gt; <span class="string">"json"</span>   <span class="comment">#指定取出的日志格式</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  redis &#123;</span><br><span class="line">    data_type =&gt; <span class="string">"list"</span></span><br><span class="line">    key =&gt; <span class="string">"tcplog-1512"</span></span><br><span class="line">    host =&gt; <span class="string">"192.168.15.12"</span></span><br><span class="line">    port =&gt; <span class="string">"6379"</span></span><br><span class="line">    db =&gt; <span class="string">"1"</span></span><br><span class="line">    password =&gt; <span class="string">"123456"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"tomcat-accesslog-1512"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [<span class="string">"192.168.15.11:9200"</span>]</span><br><span class="line">      index =&gt; <span class="string">"logstash-tomcat1512-accesslog-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"tcplog-1512"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [<span class="string">"192.168.15.11:9200"</span>]</span><br><span class="line">      index =&gt; <span class="string">"logstash-tcplog1512-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>9：测试logstash及启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">conf.d]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/redis-to-els.conf</span></span><br></pre></td></tr></table></figure></p><p>10：验证redis的数据是否被取出<br><img src="/2019/02/22/ELK之Logstash收集日志并写入redis/5.png" alt=""></p><p>11：在head插件验证数据<br><img src="/2019/02/22/ELK之Logstash收集日志并写入redis/6.png" alt=""></p><p>12：kibana添加tomcat访问日志索引<br><img src="/2019/02/22/ELK之Logstash收集日志并写入redis/7.png" alt=""></p><p>13：kibana添加tcp日志索引<br><img src="/2019/02/22/ELK之Logstash收集日志并写入redis/8.png" alt=""></p><p>14：kibana验证tomcat访问日志<br><img src="/2019/02/22/ELK之Logstash收集日志并写入redis/9.png" alt=""></p><p>15：kibana 验证tcp日志<br><img src="/2019/02/22/ELK之Logstash收集日志并写入redis/10.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ELK之Logstash收集日志并写入redis&quot;&gt;&lt;a href=&quot;#ELK之Logstash收集日志并写入redis&quot; class=&quot;headerlink&quot; title=&quot;ELK之Logstash收集日志并写入redis&quot;&gt;&lt;/a&gt;ELK之Logstash收集日志并写入redis&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/22/ELK之Logstash收集日志并写入redis/标题.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>ELK之Logstash收集rsyslog中记录的haproxy服务的日志</title>
    <link href="https://daizhe.net.cn/2019/02/21/ELK%E4%B9%8BLogstash%E6%94%B6%E9%9B%86rsyslog%E4%B8%AD%E8%AE%B0%E5%BD%95%E7%9A%84haproxy%E6%9C%8D%E5%8A%A1%E7%9A%84%E6%97%A5%E5%BF%97/"/>
    <id>https://daizhe.net.cn/2019/02/21/ELK之Logstash收集rsyslog中记录的haproxy服务的日志/</id>
    <published>2019-02-21T11:39:18.153Z</published>
    <updated>2019-03-03T03:46:51.276Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ELK之Logstash收集rsyslog中记录的haproxy服务的日志"><a href="#ELK之Logstash收集rsyslog中记录的haproxy服务的日志" class="headerlink" title="ELK之Logstash收集rsyslog中记录的haproxy服务的日志"></a>ELK之Logstash收集rsyslog中记录的haproxy服务的日志</h1><p><img src="/2019/02/21/ELK之Logstash收集rsyslog中记录的haproxy服务的日志/标题.png" alt=""><br><a id="more"></a></p><p><img src="/2019/02/21/ELK之Logstash收集rsyslog中记录的haproxy服务的日志/1.png" alt=""></p><h2 id="通过rsyslog收集haproxy日志："><a href="#通过rsyslog收集haproxy日志：" class="headerlink" title="通过rsyslog收集haproxy日志："></a>通过rsyslog收集haproxy日志：</h2><ul><li><code>logstash和rsyslog可以不在同一台主机</code></li><li><p><code>ES和kibana也可以不在同一台主机运行</code></p></li><li><p>在centos 6及之前的版本叫做syslog，centos 7开始叫做rsyslog，根据官方的介绍，rsyslog(2013年版本)可以达到每秒转发百万条日志的级别，官方网址：<a href="http://www.rsyslog.com/，确认系统安装的版本命令如下：" target="_blank" rel="noopener">http://www.rsyslog.com/，确认系统安装的版本命令如下：</a></p></li></ul><p>1：安装rsyslog和haproxy<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">安装haproxy</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># yum install haproxy -y</span></span><br><span class="line"></span><br><span class="line">安装rsyslog</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># yum install rsyslog -y</span></span><br></pre></td></tr></table></figure></p><p>2：编辑rsyslog服务配置文件，打开rsyslog服务用来保存haproxy的日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">编辑rsyslog配置文件</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/rsyslog.conf </span></span><br><span class="line">  15 <span class="variable">$ModLoad</span> imudp</span><br><span class="line">  16 <span class="variable">$UDPServerRun</span> 514</span><br><span class="line"></span><br><span class="line">  19 <span class="variable">$ModLoad</span> imtcp</span><br><span class="line">  20 <span class="variable">$InputTCPServerRun</span> 514</span><br><span class="line"></span><br><span class="line">  74 local2.*                       /var/<span class="built_in">log</span>/haproxy.log  <span class="comment">#自定义日志级别，将此日志级别的日志存放在本机的此文件中</span></span><br><span class="line">  75 local2.*       @@本机地址:1514       <span class="comment">#端口自定义不和其他服务冲突即可              </span></span><br><span class="line">  <span class="comment">#也将此日志的级别存放在本主机上，定义监听的端口为1514（使用本机的logstash主机监听此地址）#最后面一行添加，local2对应haproxy配置文件定义的local级别</span></span><br><span class="line"></span><br><span class="line">查看haproxy配置文件</span><br><span class="line">  <span class="comment">#20~26行默认的配置文件解释：如果要设置将haproxy的日志记录在本机rsyslog服务器中就要在rsyslog配置文件中添加local2.*                       /var/log/haproxy.log</span></span><br><span class="line">    <span class="comment"># 2) configure local2 events to go to the /var/log/haproxy.log</span></span><br><span class="line">    <span class="comment">#   file. A line like the following can be added to</span></span><br><span class="line">    <span class="comment">#   /etc/sysconfig/syslog</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="comment">#    local2.*                       /var/log/haproxy.log</span></span><br><span class="line">    <span class="comment">#</span></span><br><span class="line">    <span class="built_in">log</span>         127.0.0.1 local2</span><br></pre></td></tr></table></figure></p><p>3：重新启动haproxy和rsyslog服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># systemctl start rsyslog</span></span><br><span class="line">~]<span class="comment"># systemctl enable rsyslog</span></span><br><span class="line">~]<span class="comment"># systemctl start haproxy</span></span><br><span class="line">~]<span class="comment"># systemctl enable haproxy</span></span><br></pre></td></tr></table></figure></p><h3 id="测试标准输出至屏幕"><a href="#测试标准输出至屏幕" class="headerlink" title="测试标准输出至屏幕"></a>测试标准输出至屏幕</h3><p>4：配置本机的logstash来监听此端口的日志—&gt;测试标准输出至屏幕<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">编辑配置文件</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/logstash/conf.d/rsyslog.conf</span></span><br><span class="line"></span><br><span class="line">  input&#123;</span><br><span class="line">      syslog &#123;</span><br><span class="line">        <span class="built_in">type</span> =&gt; <span class="string">"ststem-rsyslog"</span></span><br><span class="line">        port =&gt; <span class="string">"1514"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line"></span><br><span class="line">  output&#123;</span><br><span class="line">        stdout&#123;</span><br><span class="line">                codec =&gt; rubydebug</span><br><span class="line">  &#125;&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">检测配置文件启动logstash</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/rsyslog.conf -t</span></span><br><span class="line">  ~]<span class="comment"># systemctl restart logstash</span></span><br><span class="line"></span><br><span class="line">查看logstash收集rsyslogs日志的端口（rsyslog使用本机定义的端口，将haproxy的日志发送到本机logstash上做收集）</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  :::1514   logstash监听（定义的rsyslog使用此端口将haproxy日志发送给本机的logstash中做收集）</span><br><span class="line">  *:514    rsyslog端口 UDP协议</span><br><span class="line">  *:5000   haproxy端口</span><br></pre></td></tr></table></figure></p><p>5：开启haproxy的状态页面</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line">  最后面定义list</span><br><span class="line"></span><br><span class="line">  listen stats</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:9999</span><br><span class="line">  stats <span class="built_in">enable</span></span><br><span class="line">  <span class="built_in">log</span> global</span><br><span class="line">  stats uri     /haproxy-status</span><br><span class="line">  stats auth    haadmin:q1w2e3r4ys</span><br><span class="line"></span><br><span class="line">重启haproxy</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart haproxy</span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  9999  <span class="comment">#自定义haproxy开启的状态页监听端口</span></span><br><span class="line">  5000</span><br></pre></td></tr></table></figure><p>6：客户端web界面访问haproxy状态页面</p><p><img src="/2019/02/21/ELK之Logstash收集rsyslog中记录的haproxy服务的日志/2.png" alt=""></p><p>7:查看本机的命令行页面查看本机的logstash是否收集到rsyslog收集的haproxy日志<br><img src="/2019/02/21/ELK之Logstash收集rsyslog中记录的haproxy服务的日志/3.png" alt=""></p><h3 id="将logstash收集的rsyslog的日志输出至远端的ES集群中存储"><a href="#将logstash收集的rsyslog的日志输出至远端的ES集群中存储" class="headerlink" title="将logstash收集的rsyslog的日志输出至远端的ES集群中存储"></a>将logstash收集的rsyslog的日志输出至远端的ES集群中存储</h3><p>8：编辑logstash配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/logstash/conf.d/haproxy.conf </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">input&#123;</span><br><span class="line">    syslog &#123;</span><br><span class="line">      <span class="built_in">type</span> =&gt; <span class="string">"ststem-rsyslog"</span></span><br><span class="line">      port =&gt; <span class="string">"1514"</span></span><br><span class="line">&#125;&#125;</span><br><span class="line"></span><br><span class="line">output&#123;</span><br><span class="line">      <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"syslog"</span> &#123;</span><br><span class="line">      elasticsearch &#123;</span><br><span class="line">      hosts =&gt; <span class="string">"172.18.135.1:9200"</span>    <span class="comment">#ES主机地址</span></span><br><span class="line">      index =&gt; <span class="string">"rsyslog-7-103-%&#123;+YYYY.MM&#125;"</span></span><br><span class="line">&#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>9：检测logstash配置文件及启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/haproxy.conf -t</span></span><br><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/haproxy.conf</span></span><br></pre></td></tr></table></figure></p><p>10：客户端web界面访问haproxy状态页面</p><p><img src="/2019/02/21/ELK之Logstash收集rsyslog中记录的haproxy服务的日志/2.png" alt=""></p><p>11：head插件web界面访问haproxy以生成新日志：</p><p><img src="/2019/02/21/ELK之Logstash收集rsyslog中记录的haproxy服务的日志/4.png" alt=""></p><p>12：kibana界面添加索引<br><img src="/2019/02/21/ELK之Logstash收集rsyslog中记录的haproxy服务的日志/5.png" alt=""></p><p>13：kibana验证数据<br><img src="/2019/02/21/ELK之Logstash收集rsyslog中记录的haproxy服务的日志/6.png" alt=""></p><hr><h2 id="OUTPUT输出中index查看支持的输出的索引的格式时间格式"><a href="#OUTPUT输出中index查看支持的输出的索引的格式时间格式" class="headerlink" title="OUTPUT输出中index查看支持的输出的索引的格式时间格式"></a>OUTPUT输出中index查看支持的输出的索引的格式时间格式</h2><p>官方文档：<a href="https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html#plugins-outputs-elasticsearch-index" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/current/plugins-outputs-elasticsearch.html#plugins-outputs-elasticsearch-index</a></p><p><a href="https://www.joda.org/joda-time/apidocs/org/joda/time/format/DateTimeFormat.html" target="_blank" rel="noopener">https://www.joda.org/joda-time/apidocs/org/joda/time/format/DateTimeFormat.html</a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ELK之Logstash收集rsyslog中记录的haproxy服务的日志&quot;&gt;&lt;a href=&quot;#ELK之Logstash收集rsyslog中记录的haproxy服务的日志&quot; class=&quot;headerlink&quot; title=&quot;ELK之Logstash收集rsyslog中记录的haproxy服务的日志&quot;&gt;&lt;/a&gt;ELK之Logstash收集rsyslog中记录的haproxy服务的日志&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/21/ELK之Logstash收集rsyslog中记录的haproxy服务的日志/标题.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>ELK之Logstash收集TCP和UDP日志</title>
    <link href="https://daizhe.net.cn/2019/02/21/ELK%E4%B9%8BLogstash%E6%94%B6%E9%9B%86TCP%E5%92%8CUDP%E6%97%A5%E5%BF%97/"/>
    <id>https://daizhe.net.cn/2019/02/21/ELK之Logstash收集TCP和UDP日志/</id>
    <published>2019-02-21T03:01:44.367Z</published>
    <updated>2019-03-03T03:46:37.323Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ELK之Logstash收集TCP和UDP日志"><a href="#ELK之Logstash收集TCP和UDP日志" class="headerlink" title="ELK之Logstash收集TCP和UDP日志"></a>ELK之Logstash收集TCP和UDP日志</h1><p><img src="/2019/02/21/ELK之Logstash收集TCP和UDP日志/标题.png" alt=""><br><a id="more"></a></p><h2 id="Logstash收集TCP和UDP日志"><a href="#Logstash收集TCP和UDP日志" class="headerlink" title="Logstash收集TCP和UDP日志"></a>Logstash收集TCP和UDP日志</h2><ul><li><p>通过logstash的tcp/udp插件收集日志，通常用于在向elasticsearch日志补录丢失的部分日志，可以将丢失的日志写到一个文件，然后通过TCP日志收集方式直接发送给logstash然后再写入到elasticsearch服务器。</p></li><li><p>官方介绍：<a href="https://www.elastic.co/guide/en/logstash/5.6/input-plugins.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/5.6/input-plugins.html</a></p></li></ul><p>Logstash配置文件解释<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">logstash配置文件，先进行收集测试：</span><br><span class="line">[root@linux-host6 ~]<span class="comment"># cat /etc/logstash/conf.d/tcp.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  tcp &#123;             <span class="comment">#指定收集tcp的日志</span></span><br><span class="line">    port =&gt; 9889    </span><br><span class="line">    host =&gt; <span class="string">"0.0.0.0"</span>  <span class="comment">#指定监听的本机地址，如果不指定默认时0.0.0.0监听本机的所有可用的地址</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"tcplog"</span>  <span class="comment">#指定类型</span></span><br><span class="line">    mode =&gt; <span class="string">"server"</span>   <span class="comment">#是定server或者client ，如果不指定默认的为server</span></span><br><span class="line">    codec =&gt; json</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;</span><br><span class="line">    codec =&gt; rubydebug</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><hr><h3 id="标准输出测试（测试基于tcp收集日志，是否可以收到日志）"><a href="#标准输出测试（测试基于tcp收集日志，是否可以收到日志）" class="headerlink" title="标准输出测试（测试基于tcp收集日志，是否可以收到日志）"></a>标准输出测试（测试基于tcp收集日志，是否可以收到日志）</h3><p>1:logstash收集本机的tcp链接的日志文件，编辑logstash配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cat /etc/logstash/conf.d/tcp.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 12345</span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"tcplog"</span></span><br><span class="line">    mode =&gt; <span class="string">"server"</span>  </span><br><span class="line">   codec =&gt; json</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;</span><br><span class="line">    codec =&gt; rubydebug</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2：测试logstash配置文件并启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">测试配置文件语法</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcplog.cof -t</span></span><br><span class="line"></span><br><span class="line">前台启动logstash测试是否可以接收到tcp日志</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcplog.cof</span></span><br><span class="line"></span><br><span class="line">验证端口是否启动</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  :::12345</span><br></pre></td></tr></table></figure></p><p>3：其他主机测试：在其他服务器安装nc命令：<br>NetCat简称nc，在网络工具中有“瑞士军刀”美誉，其功能实用，是一个简单、可靠的网络工具，可通过TCP或UDP协议传输读写数据，另外还具有很多其他功能。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">安装测试工具</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment">#  yum instll nc –y</span></span><br><span class="line"></span><br><span class="line">发送tcp消息到logstash主机</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># echo "nc test" | nc 172.20.101.221(logstash主机地址) 12345</span></span><br></pre></td></tr></table></figure></p><p>4：查看logstash主机是否接收到日志消息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcplog.cof</span></span><br><span class="line">WARNING: Could not find logstash.yml <span class="built_in">which</span> is typically located <span class="keyword">in</span> <span class="variable">$LS_HOME</span>/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config <span class="built_in">which</span> logs errors to the console</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"@timestamp"</span> =&gt; 2019-02-21T03:34:35.041Z,</span><br><span class="line">        <span class="string">"port"</span> =&gt; 43030,</span><br><span class="line">    <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">        <span class="string">"host"</span> =&gt; <span class="string">"172.20.0.1"</span>,</span><br><span class="line">     <span class="string">"message"</span> =&gt; <span class="string">"nc test"</span>,</span><br><span class="line">        <span class="string">"type"</span> =&gt; <span class="string">"tcplog"</span>,</span><br><span class="line">        <span class="string">"tags"</span> =&gt; [</span><br><span class="line">      [0] <span class="string">"_jsonparsefailure"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>5:其他主机测试：通过nc命令发送一个文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">通过nc命令发送一个文件：</span><br><span class="line">  ~]<span class="comment"># nc 172.20.101.221 12345 &lt; /etc/passwd</span></span><br></pre></td></tr></table></figure></p><p>6：logstash主机查看验证数据<br><img src="/2019/02/21/ELK之Logstash收集TCP和UDP日志/1.png" alt=""></p><p>7：其他主机测试：<br>通过伪设备的方式发送消息：<br>在类Unix操作系统中，块设备有硬盘、内存的硬件，但是还有设备节点并不一定要对应物理设备，我们把没有这种对应关系的设备是伪设备，比如/dev/null，/dev/zero，/dev/random以及/dev/tcp和/dev/upd等，Linux操作系统使用这些伪设备提供了多种不通的功能，tcp通信只是dev下面众多伪设备当中的一种设备。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># echo "伪设备"  &gt; /dev/tcp/172.20.101.221/12345</span></span><br></pre></td></tr></table></figure></p><p>8：logstash主机查看验证数据<br><img src="/2019/02/21/ELK之Logstash收集TCP和UDP日志/2.png" alt=""></p><hr><h3 id="Lgstash收集本机TCP日志将输出改为elasticsearch"><a href="#Lgstash收集本机TCP日志将输出改为elasticsearch" class="headerlink" title="Lgstash收集本机TCP日志将输出改为elasticsearch"></a>Lgstash收集本机TCP日志将输出改为elasticsearch</h3><p>1：logstash收集本机的tcp链接的日志文件，编辑logstash配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  ~]<span class="comment"># vim /etc/logstash/conf.d/tcplog.cof </span></span><br><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 12345</span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"tcplog"</span></span><br><span class="line">    mode =&gt; <span class="string">"server"</span></span><br><span class="line">    host =&gt; <span class="string">"0.0.0.0"</span></span><br><span class="line">    codec =&gt; json</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"tcplog"</span> &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">"172.18.135.1:9200"</span>]</span><br><span class="line">    index =&gt;  <span class="string">"logstash-tcplog-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2：测试logstash配置文件语法并启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcplog.cof -t</span></span><br><span class="line">~]<span class="comment"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p><p>3；通过nc命令或伪设备输入日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># nc 172.20.101.221 12345 &lt; /etc/passwd</span></span><br></pre></td></tr></table></figure></p><p>4：在kibana界面添加索引<br><img src="/2019/02/21/ELK之Logstash收集TCP和UDP日志/3.png" alt=""></p><p>5：kibana验证数据<br><img src="/2019/02/21/ELK之Logstash收集TCP和UDP日志/4.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ELK之Logstash收集TCP和UDP日志&quot;&gt;&lt;a href=&quot;#ELK之Logstash收集TCP和UDP日志&quot; class=&quot;headerlink&quot; title=&quot;ELK之Logstash收集TCP和UDP日志&quot;&gt;&lt;/a&gt;ELK之Logstash收集TCP和UDP日志&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/21/ELK之Logstash收集TCP和UDP日志/标题.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>ELK之Logstash收集Nginx日志</title>
    <link href="https://daizhe.net.cn/2019/02/20/ELK%E4%B9%8BLogstash%E6%94%B6%E9%9B%86Nginx%E6%97%A5%E5%BF%97/"/>
    <id>https://daizhe.net.cn/2019/02/20/ELK之Logstash收集Nginx日志/</id>
    <published>2019-02-20T13:21:02.812Z</published>
    <updated>2019-03-03T03:46:09.920Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ELK之Logstash收集Nginx日志"><a href="#ELK之Logstash收集Nginx日志" class="headerlink" title="ELK之Logstash收集Nginx日志"></a>ELK之Logstash收集Nginx日志</h1><p><img src="/2019/02/20/ELK之Logstash收集Nginx日志/标题.png" alt=""><br><a id="more"></a></p><h2 id="收集nginx访问日志"><a href="#收集nginx访问日志" class="headerlink" title="收集nginx访问日志"></a>收集nginx访问日志</h2><p><img src="/2019/02/20/ELK之Logstash收集Nginx日志/1.png" alt=""></p><p>1.安装nginx<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">编译安装</span><br><span class="line"></span><br><span class="line">    src]<span class="comment"># pwd</span></span><br><span class="line">    /usr/share/src</span><br><span class="line">    src]<span class="comment"># ls</span></span><br><span class="line">    nginx-1.2.9.tar.gz</span><br><span class="line">    src]<span class="comment"># tar xzvf nginx-1.2.9.tar.gz </span></span><br><span class="line"></span><br><span class="line">    nginx-1.2.9]<span class="comment"># pwd</span></span><br><span class="line">    /usr/share/src/nginx-1.2.9</span><br><span class="line"></span><br><span class="line">指定安装位置并编译安装</span><br><span class="line"></span><br><span class="line">    nginx-1.2.9]<span class="comment"># ./configure --prefix=/usr/share/nginx &amp;&amp; make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure></p><p>2：修改nginx日志格式(将输出的日志格式修改为json格式的日志格式)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cat /usr/share/nginx/conf/nginx.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">    <span class="comment">#                  '$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">    <span class="comment">#                  '"$http_user_agent" "$http_x_forwarded_for"';</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  logs/access.log  main;</span></span><br><span class="line">    <span class="comment">#注意定义的日志的位置</span></span><br><span class="line">log_format access_json <span class="string">'&#123;"@timestamp":"$time_iso8601",'</span>        <span class="comment">#定义日志的格式</span></span><br><span class="line">        <span class="string">'"host":"$server_addr",'</span></span><br><span class="line">        <span class="string">'"clientip":"$remote_addr",'</span></span><br><span class="line">        <span class="string">'"size":$body_bytes_sent,'</span></span><br><span class="line">        <span class="string">'"responsetime":$request_time,'</span></span><br><span class="line">        <span class="string">'"upstreamtime":"$upstream_response_time",'</span></span><br><span class="line">        <span class="string">'"upstreamhost":"$upstream_addr",'</span></span><br><span class="line">        <span class="string">'"http_host":"$host",'</span></span><br><span class="line">        <span class="string">'"url":"$uri",'</span></span><br><span class="line">        <span class="string">'"domain":"$host",'</span></span><br><span class="line">        <span class="string">'"xff":"$http_x_forwarded_for",'</span></span><br><span class="line">        <span class="string">'"referer":"$http_referer",'</span></span><br><span class="line">        <span class="string">'"status":"$status"&#125;'</span>;</span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  access_json;         <span class="comment">#调用此日志格式</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建对应的保存日志的目录</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># mkdir /var/log/nginx</span></span><br></pre></td></tr></table></figure></p><p>3：启动nginx并访问默认页面查看日志格式<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">启动nginx</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># /usr/share/nginx/sbin/nginx -t</span></span><br><span class="line">    nginx: the configuration file /usr/share/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">    nginx: configuration file /usr/share/nginx/conf/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line">    ~]<span class="comment"># /usr/share/nginx/sbin/nginx</span></span><br><span class="line"></span><br><span class="line">访问默认页面</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># curl 172.20.101.221:80</span></span><br><span class="line"></span><br><span class="line">查看日志格式</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># cat /var/log/nginx/access.log </span></span><br><span class="line">    &#123;<span class="string">"@timestamp"</span>:<span class="string">"2019-02-21T10:44:15+08:00"</span>,<span class="string">"host"</span>:<span class="string">"192.168.35.103"</span>,<span class="string">"clientip"</span>:<span class="string">"172.20.101.221"</span>,<span class="string">"size"</span>:612,<span class="string">"responsetime"</span>:0.000,<span class="string">"upstreamtime"</span>:<span class="string">"-"</span>,<span class="string">"upstreamhost"</span>:<span class="string">"-"</span>,<span class="string">"http_host"</span>:<span class="string">"172.20.101.221"</span>,<span class="string">"url"</span>:<span class="string">"/index.html"</span>,<span class="string">"domain"</span>:<span class="string">"172.20.101.221"</span>,<span class="string">"xff"</span>:<span class="string">"-"</span>,<span class="string">"referer"</span>:<span class="string">"-"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>&#125;</span><br></pre></td></tr></table></figure></p><p>4：配置本机上的logstash收集本机的nginx日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/logstash/conf.d/nginxlog.conf</span></span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/var/log/nginx/access.log"</span></span><br><span class="line">    start_position =&gt; <span class="string">"end"</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"nginx-accesslog"</span></span><br><span class="line">    codec =&gt; json</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"nginx-accesslog"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [<span class="string">"172.18.135.1:9200"</span>]</span><br><span class="line">      index =&gt; <span class="string">"logstash-nginx-accesslog-1516-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>5：logstash进行配置文件语法检测及重启服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginxlog.conf -t</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p><p>6：kibana界面添加索引<br><img src="/2019/02/20/ELK之Logstash收集Nginx日志/2.png" alt=""></p><p>7：kibana界面验证数据<br><img src="/2019/02/20/ELK之Logstash收集Nginx日志/3.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ELK之Logstash收集Nginx日志&quot;&gt;&lt;a href=&quot;#ELK之Logstash收集Nginx日志&quot; class=&quot;headerlink&quot; title=&quot;ELK之Logstash收集Nginx日志&quot;&gt;&lt;/a&gt;ELK之Logstash收集Nginx日志&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/ELK之Logstash收集Nginx日志/标题.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>ELK之Logstash收集本机ES服务json类型日志</title>
    <link href="https://daizhe.net.cn/2019/02/20/ELK%E4%B9%8BLogstash%E6%94%B6%E9%9B%86%E6%9C%AC%E6%9C%BAES%E6%9C%8D%E5%8A%A1json%E7%B1%BB%E5%9E%8B%E6%97%A5%E5%BF%97/"/>
    <id>https://daizhe.net.cn/2019/02/20/ELK之Logstash收集本机ES服务json类型日志/</id>
    <published>2019-02-20T13:10:43.136Z</published>
    <updated>2019-03-03T03:46:30.714Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ELK之Logstash收集本机ES服务json类型日志"><a href="#ELK之Logstash收集本机ES服务json类型日志" class="headerlink" title="ELK之Logstash收集本机ES服务json类型日志"></a>ELK之Logstash收集本机ES服务json类型日志</h1><p><img src="/2019/02/20/ELK之Logstash收集本机ES服务json类型日志/标题.png" alt=""><br><a id="more"></a></p><h2 id="收集java日志："><a href="#收集java日志：" class="headerlink" title="收集java日志："></a>收集java日志：</h2><ul><li>java日志的格式长度不统一，有的条日志很短而有的一条记录很长好几行</li><li>使用codec的multiline插件实现多行匹配，这是一个可以将多行进行合并的插件，而且可以使用what指定将匹配到的行与前面的行合并还是和后面的行合并</li></ul><p>multiline（匹配多行输入官方解释）：<a href="https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html</a></p><h3 id="这里演示收集ES机器上的日志-ES程序的运行是要求部署JAVA环境的，射门生成的日志格式也是java格式类型-但是日志格式的开头都是以-开头"><a href="#这里演示收集ES机器上的日志-ES程序的运行是要求部署JAVA环境的，射门生成的日志格式也是java格式类型-但是日志格式的开头都是以-开头" class="headerlink" title="这里演示收集ES机器上的日志(ES程序的运行是要求部署JAVA环境的，射门生成的日志格式也是java格式类型,但是日志格式的开头都是以[开头)"></a>这里演示收集ES机器上的日志(ES程序的运行是要求部署JAVA环境的，射门生成的日志格式也是java格式类型,但是日志格式的开头都是以[开头)</h3><p>1: ES主机上安装收集日志的logstash程序<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># ls</span></span><br><span class="line">logstash-5.6.13.rpm </span><br><span class="line">~]<span class="comment"># rpm -ivh logstash-5.6.13.rpm</span></span><br></pre></td></tr></table></figure></p><h3 id="收集ES日志语法测试"><a href="#收集ES日志语法测试" class="headerlink" title="收集ES日志语法测试"></a>收集ES日志语法测试</h3><p>2：配置ES主机上用来收集日志的logstash程序的配置文件<br>解释<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cat /etc/logstash/conf.d/java.conf</span></span><br><span class="line">input &#123;</span><br><span class="line">        stdin &#123;</span><br><span class="line">        codec =&gt; multiline &#123;</span><br><span class="line">        pattern =&gt; <span class="string">"^\["</span> <span class="comment">#当遇到[开头的行时候将多行进行合并</span></span><br><span class="line">        negate =&gt; <span class="literal">true</span>  <span class="comment">#true为匹配成功进行操作，false为不成功进行操作</span></span><br><span class="line">        what =&gt; <span class="string">"previous"</span>  <span class="comment">#与上面的行合并，如果是下面的行合并就是next</span></span><br><span class="line">        &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123; <span class="comment">#日志过滤，如果所有的日志都过滤就写这里，如果只针对某一个过滤就写在input里面的日志输入里面</span></span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">        stdout &#123;</span><br><span class="line">        codec =&gt; rubydebug</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure></p><p>配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cat /etc/logstash/conf.d/es.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">      stdin &#123;</span><br><span class="line">      codec =&gt; multiline &#123;</span><br><span class="line">      pattern =&gt; <span class="string">"^\["</span></span><br><span class="line">      negate =&gt; <span class="literal">true</span></span><br><span class="line">      what =&gt; <span class="string">"previous"</span></span><br><span class="line">      &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">      stdout &#123;</span><br><span class="line">      codec =&gt; rubydebug</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure></p><p>2：检测配置文件的语法格式并启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/es.conf -t</span></span><br><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/es.conf</span></span><br></pre></td></tr></table></figure></p><p>3：日志输入输出测试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/es.conf </span></span><br><span class="line">WARNING: Could not find logstash.yml <span class="built_in">which</span> is typically located <span class="keyword">in</span> <span class="variable">$LS_HOME</span>/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config <span class="built_in">which</span> logs errors to the console</span><br><span class="line">The stdin plugin is now waiting <span class="keyword">for</span> input:</span><br><span class="line">1111</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1122432</span><br><span class="line">4324324324</span><br><span class="line">234234</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[v1</span><br><span class="line">&#123;</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"es1.com"</span>,</span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; 2019-02-20T12:54:38.873Z,</span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"1111\n1122432\n4324324324\n234234"</span>,</span><br><span class="line">          <span class="string">"tags"</span> =&gt; [</span><br><span class="line">        [0] <span class="string">"multiline"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">[123</span><br><span class="line">&#123;</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"es1.com"</span>,</span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; 2019-02-20T12:54:42.617Z,</span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"[v1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="搜集ES日志实战"><a href="#搜集ES日志实战" class="headerlink" title="搜集ES日志实战"></a>搜集ES日志实战</h3><p>1：logstash配置文件标准输出至文件中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@linux-host1 ~]<span class="comment"># vim /etc/logstash/conf.d/java.conf</span></span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/data/eslogs/ES.log"</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"javalog"</span></span><br><span class="line">    start_position =&gt; <span class="string">"beginning"</span></span><br><span class="line">    codec =&gt; multiline &#123;</span><br><span class="line">    pattern =&gt; <span class="string">"^\["</span></span><br><span class="line">    negate =&gt; <span class="literal">true</span></span><br><span class="line">    what =&gt; <span class="string">"previous"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"javalog"</span> &#123;</span><br><span class="line">  stdout &#123;</span><br><span class="line">      codec =&gt; rubydebug</span><br><span class="line">    &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt;  <span class="string">"/tmp/m.txt"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2:语法验证：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-host1 ~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/java.conf  -t</span></span><br></pre></td></tr></table></figure></p><p>3：将输出改为elasticsearch和本地的一个文件中：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">更改后的内容如下：</span><br><span class="line">[root@linux-host1 ~]<span class="comment"># cat /etc/logstash/conf.d/java.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/data/eslogs/ES.log"</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"javalog"</span></span><br><span class="line">    start_position =&gt; <span class="string">"beginning"</span></span><br><span class="line">    codec =&gt; multiline &#123;</span><br><span class="line">    pattern =&gt; <span class="string">"^\["</span></span><br><span class="line">    negate =&gt; <span class="literal">true</span></span><br><span class="line">    what =&gt; <span class="string">"previous"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"javalog"</span> &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/tmp/java.txt"</span></span><br><span class="line">  &#125;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt;  [<span class="string">"192.168.15.11:9200"</span>]</span><br><span class="line">    index =&gt; <span class="string">"javalog-1511-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@linux-host1 ~]<span class="comment"># systemctl  restart logstash</span></span><br></pre></td></tr></table></figure></p><p>4:然后重启一下elasticsearch服务，目前是为了生成新的日志，以验证logstash能否自动收集新生成的日志。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-host1 ~]<span class="comment"># systemctl  restart elasticsearch</span></span><br></pre></td></tr></table></figure></p><p>5：kibana界面添加javalog-1511索引：<br><img src="/2019/02/20/ELK之Logstash收集本机ES服务json类型日志/1.png" alt=""></p><p>6：模拟生成数据查看kibana界面查看数据：<br><img src="/2019/02/20/ELK之Logstash收集本机ES服务json类型日志/2.png" alt=""></p><p>7：关于sincedb：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-host1~]<span class="comment"># cat /var/lib/logstash/plugins/inputs/file/.sincedb_1ced15cfacdbb0380466be84d620085a</span></span><br><span class="line">134219868 0 2064 29465 <span class="comment">#记录了收集文件的inode信息</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ELK之Logstash收集本机ES服务json类型日志&quot;&gt;&lt;a href=&quot;#ELK之Logstash收集本机ES服务json类型日志&quot; class=&quot;headerlink&quot; title=&quot;ELK之Logstash收集本机ES服务json类型日志&quot;&gt;&lt;/a&gt;ELK之Logstash收集本机ES服务json类型日志&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/ELK之Logstash收集本机ES服务json类型日志/标题.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>mysql之存储引擎和服务器配置</title>
    <link href="https://daizhe.net.cn/2019/02/20/mysql%E4%B9%8B%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/"/>
    <id>https://daizhe.net.cn/2019/02/20/mysql之存储引擎和服务器配置/</id>
    <published>2019-02-20T07:08:47.059Z</published>
    <updated>2019-02-20T07:17:57.629Z</updated>
    
    <content type="html"><![CDATA[<h1 id="mysql之存储引擎和服务器配置"><a href="#mysql之存储引擎和服务器配置" class="headerlink" title="mysql之存储引擎和服务器配置"></a>mysql之存储引擎和服务器配置</h1><p><img src="/2019/02/20/mysql之存储引擎和服务器配置/标题.gif" alt=""><br><a id="more"></a></p><p><img src="/2019/02/20/mysql之存储引擎和服务器配置/1.png" alt=""></p><p>存储引擎：如何去管理数据库的数据文件<br><img src="/2019/02/20/mysql之存储引擎和服务器配置/2.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">查看当前数据库的存储引擎</span><br><span class="line">MariaDB [(none)]&gt; show engines;</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| Engine             | Support | Comment                                                                    | Transactions | XA   | Savepoints |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| MEMORY             | YES     | Hash based, stored <span class="keyword">in</span> memory, useful <span class="keyword">for</span> temporary tables                  | NO           | NO   | NO         |</span><br><span class="line">| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                                      | NO           | NO   | NO         |</span><br><span class="line">| CSV                | YES     | CSV storage engine                                                         | NO           | NO   | NO         |</span><br><span class="line">| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears)             | NO           | NO   | NO         |</span><br><span class="line">| MyISAM             | YES     | MyISAM storage engine                                                      | NO           | NO   | NO         |</span><br><span class="line">| InnoDB             | DEFAULT | Percona-XtraDB, Supports transactions, row-level locking, and foreign keys | YES          | YES  | YES        |</span><br><span class="line">| ARCHIVE            | YES     | Archive storage engine                                                     | NO           | NO   | NO         |</span><br><span class="line">| FEDERATED          | YES     | FederatedX pluggable storage engine                                        | YES          | NO   | YES        |</span><br><span class="line">| PERFORMANCE_SCHEMA | YES     | Performance Schema                                                         | NO           | NO   | NO         |</span><br><span class="line">| Aria               | YES     | Crash-safe tables with MyISAM heritage                                     | NO           | NO   | NO         |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">10 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><p><code>MyISAM引擎特点：</code><br>不支持事务<br>表级锁定<br>读写相互阻塞，写入不能读，读时不能写<br>只缓存索引<br>不支持外键约束<br>不支持聚簇索引<br>读取数据较快，占用资源较少<br>不支持MVCC（多版本并发控制机制）高并发<br>崩溃恢复性较差<br>MySQL5.5.5前默认的数据库引擎  </p><p>MyISAM存储引擎适用场景<br>&ensp;&ensp;只读（或者写较少）、表较小（可以接受长时间进行修复操作）<br>&ensp;&ensp;MyISAM引擎文件<br>&ensp;&ensp;tbl_name.frm 表格式定义<br>&ensp;&ensp;tbl_name.MYD 数据文件<br>&ensp;&ensp;tbl_name.MYI 索引文件   </p><p><code>InnoDB引擎特点</code><br>行级锁<br>支持事务，适合处理大量短期事务<br>读写阻塞与事务隔离级别相关<br>可缓存数据和索引<br>支持聚簇索引<br>崩溃恢复性更好<br>支持MVCC高并发<br>从MySQL5.5后支持全文索引<br>从MySQL5.5.5开始为默认的数据库引擎   </p><p>InnoDB数据库文件<br>所有InnoDB表的数据和索引放置于同一个表空间中<br>&ensp;&ensp;表空间文件：datadir定义的目录下<br>&ensp;&ensp;数据文件：ibddata1, ibddata2, …<br>每个表单独使用一个表空间存储表的数据和索引<br>&ensp;&ensp;启用：innodb_file_per_table=ON<br>&ensp;&ensp;参看：<a href="https://mariadb.com/kb/en/library/xtradbinnodb-serversystem-variables/#innodb_file_per_table" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/xtradbinnodb-serversystem-variables/#innodb_file_per_table</a>   ON (&gt;= MariaDB 5.5)<br>两类文件放在数据库独立目录中<br>&ensp;&ensp;数据文件(存储数据和索引)：tb_name.ibd<br>&ensp;&ensp;表格式定义：tb_name.frm   </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">如果想让老版本的数据库创建的库以及表支持innodb搜索引擎需要编辑配置文件中添加</span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">default-storage-engine=innodb</span><br><span class="line"></span><br><span class="line">删除hellodb这个数据库</span><br><span class="line">mysql -e <span class="string">'drop database hellodb'</span></span><br></pre></td></tr></table></figure><p><code>其它存储引擎</code><br>Performance_Schema：Performance_Schema数据库使用<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; use information_schema</span><br><span class="line">Reading table information <span class="keyword">for</span> completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MariaDB [information_schema]&gt; show tables;(这些表都是基于此搜索引擎的)</span><br><span class="line">+---------------------------------------+</span><br><span class="line">| Tables_in_information_schema          |</span><br><span class="line">+---------------------------------------+</span><br><span class="line">| CHARACTER_SETS                        |</span><br><span class="line">| CLIENT_STATISTICS                     |</span><br><span class="line">| COLLATIONS                            |</span><br><span class="line">| COLLATION_CHARACTER_SET_APPLICABILITY |</span><br><span class="line">| COLUMNS                               |</span><br><span class="line">| COLUMN_PRIVILEGES                     |</span><br><span class="line">| ENGINES                               |</span><br><span class="line">| EVENTS                                |</span><br><span class="line">| FILES                                 |</span><br><span class="line">| GLOBAL_STATUS                         |</span><br><span class="line">| GLOBAL_VARIABLES                      |</span><br><span class="line">| INDEX_STATISTICS                      |</span><br><span class="line">| KEY_CACHES                            |</span><br><span class="line">| KEY_COLUMN_USAGE                      |</span><br><span class="line">| PARAMETERS                            |</span><br><span class="line">| PARTITIONS                            |</span><br><span class="line">| PLUGINS                               |</span><br><span class="line">| PROCESSLIST                           |</span><br><span class="line">| PROFILING                             |</span><br><span class="line">| REFERENTIAL_CONSTRAINTS               |</span><br><span class="line">| ROUTINES                              |</span><br><span class="line">| SCHEMATA                              |</span><br><span class="line">| SCHEMA_PRIVILEGES                     |</span><br><span class="line">| SESSION_STATUS                        |</span><br><span class="line">| SESSION_VARIABLES                     |</span><br><span class="line">| STATISTICS                            |</span><br><span class="line">| TABLES                                |</span><br><span class="line">| TABLESPACES                           |</span><br><span class="line">| TABLE_CONSTRAINTS                     |</span><br><span class="line">| TABLE_PRIVILEGES                      |</span><br><span class="line">| TABLE_STATISTICS                      |</span><br><span class="line">| TRIGGERS                              |</span><br><span class="line">| USER_PRIVILEGES                       |</span><br><span class="line">| USER_STATISTICS                       |</span><br><span class="line">| VIEWS                                 |</span><br><span class="line">| INNODB_CMPMEM_RESET                   |</span><br><span class="line">| INNODB_RSEG                           |</span><br><span class="line">| INNODB_UNDO_LOGS                      |</span><br><span class="line">| INNODB_CMPMEM                         |</span><br><span class="line">| INNODB_SYS_TABLESTATS                 |</span><br><span class="line">| INNODB_LOCK_WAITS                     |</span><br><span class="line">| INNODB_INDEX_STATS                    |</span><br><span class="line">| INNODB_CMP                            |</span><br><span class="line">| INNODB_CMP_RESET                      |</span><br><span class="line">| INNODB_CHANGED_PAGES                  |</span><br><span class="line">| INNODB_BUFFER_POOL_PAGES              |</span><br><span class="line">| INNODB_TRX                            |</span><br><span class="line">| INNODB_BUFFER_POOL_PAGES_INDEX        |</span><br><span class="line">| INNODB_LOCKS                          |</span><br><span class="line">| INNODB_BUFFER_POOL_PAGES_BLOB         |</span><br><span class="line">| INNODB_SYS_TABLES                     |</span><br><span class="line">| INNODB_SYS_FIELDS                     |</span><br><span class="line">| INNODB_SYS_COLUMNS                    |</span><br><span class="line">| INNODB_SYS_STATS                      |</span><br><span class="line">| INNODB_SYS_FOREIGN                    |</span><br><span class="line">| INNODB_SYS_INDEXES                    |</span><br><span class="line">| XTRADB_ADMIN_COMMAND                  |</span><br><span class="line">| INNODB_TABLE_STATS                    |</span><br><span class="line">| INNODB_SYS_FOREIGN_COLS               |</span><br><span class="line">| INNODB_BUFFER_PAGE_LRU                |</span><br><span class="line">| INNODB_BUFFER_POOL_STATS              |</span><br><span class="line">| INNODB_BUFFER_PAGE                    |</span><br><span class="line">+---------------------------------------+</span><br><span class="line">62 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [information_schema]&gt; show table status from performance_schema;</span><br><span class="line">+----------------------------------------------+--------------------+---------+------------+-------+----------------+-------------+-----------------+--------------+-----------+----------------+-------------+-------------+------------+-----------------+----------+----------------+---------+</span><br><span class="line">| Name                                         | Engine             | Version | Row_format | Rows  | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time | Update_time | Check_time | Collation       | Checksum | Create_options | Comment |</span><br><span class="line">+----------------------------------------------+--------------------+---------+------------+-------+----------------+-------------+-----------------+--------------+-----------+----------------+-------------+-------------+------------+-----------------+----------+----------------+---------+</span><br><span class="line">| cond_instances                               | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| events_waits_current                         | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| events_waits_history                         | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| events_waits_history_long                    | PERFORMANCE_SCHEMA |      10 | Dynamic    | 10000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| events_waits_summary_by_instance             | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| events_waits_summary_by_thread_by_event_name | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| events_waits_summary_global_by_event_name    | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| file_instances                               | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| file_summary_by_event_name                   | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| file_summary_by_instance                     | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| mutex_instances                              | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| performance_timers                           | PERFORMANCE_SCHEMA |      10 | Fixed      |     5 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| rwlock_instances                             | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| setup_consumers                              | PERFORMANCE_SCHEMA |      10 | Dynamic    |     8 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| setup_instruments                            | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| setup_timers                                 | PERFORMANCE_SCHEMA |      10 | Dynamic    |     1 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| threads                                      | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">+----------------------------------------------+--------------------+---------+------------+-------+----------------+-------------+-----------------+--------------+-----------+----------------+-------------+-------------+------------+-----------------+----------+----------------+---------+</span><br><span class="line">17 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">该数据库是存储性能相关</span><br></pre></td></tr></table></figure></p><p>Memory ：将所有数据存储在RAM（内存）中，以便在需要快速查找参考和其他类似 数据的环境中进行快速访问。适用存放临时数据。引擎以前被称为HEAP引擎  </p><p>MRG_MyISAM：使MySQL DBA或开发人员能够对一系列相同的  MyISAM表 进行逻辑分组，并将它们作为一个对象引用。适用于VLDB(Very Large Data Base)环境，如数据仓库   </p><p>Archive ：为存储和检索大量很少参考的存档或安全审核信息，只支持 SELECT和INSERT操作；支持行级锁和专用缓存区</p><p>Federated联合：用于访问其它远程MySQL服务器一个代理，它通过创建一 个到远程MySQL服务器的客户端连接，并将查询传输到远程服务器执行，而 后完成数据存取，提供链接单独MySQL服务器的能力，以便从多个物理服务 器创建一个逻辑数据库。非常适合分布式或数据集市环境 </p><p>BDB：可替代InnoDB的事务引擎，支持COMMIT、ROLLBACK和其他事务特性<br>Cluster/NDB：MySQL的簇式数据库引擎，尤其适合于具有高性能查找要求的 应用程序，这类查找需求还要求具有最高的正常工作时间和可用性  </p><p>CSV：CSV存储引擎使用逗号分隔值格式将数据存储在文本文件中。可以使用 CSV引擎以CSV格式导入和导出其他软件和应用程序之间的数据交换  </p><p>BLACKHOLE ：黑洞存储引擎接受但不存储数据，检索总是返回一个空集。该功 能可用于分布式数据库设计，数据自动复制，但不是本地存储   </p><p>example：“stub”引擎，它什么都不做。可以使用此引擎创建表，但不能将数 据存储在其中或从中检索。目的是作为例子来说明如何开始编写新的存储引擎   </p><p>MariaDB支持的其它存储引擎：<br>OQGraph<br>SphinxSE<br>TokuDB<br>Cassandra<br>CONNECT<br>SQUENCE   </p><p><code>查看mysql支持的存储引擎</code><br>show engines;<br><code>查看当前默认的存储引擎</code><br>show variables like ‘%storage_engine%’;<br><code>设置默认的存储引擎</code><br>vim /etc/my.conf  [mysqld]<br>default_storage_engine= InnoDB<br><code>查看库中所有表使用的存储引擎</code><br>show table status from db_name;<br><code>查看库中指定表的存储引擎</code><br>show table status like  ‘ tb_name ‘;<br>show create table tb_name;<br><code>设置表的存储引擎：</code><br>CREATE TABLE tb_name(… ) ENGINE=InnoDB;<br>ALTER TABLE tb_name ENGINE=InnoDB;   </p><h2 id="MySQL中的系统数据库"><a href="#MySQL中的系统数据库" class="headerlink" title="MySQL中的系统数据库"></a>MySQL中的系统数据库</h2><p><code>mysql数据库</code><br>是mysql的核心数据库，类似于Sql  Server中的master库，主要负责存储数据 库的用户、权限设置、关键字等mysql自己需要使用的控制和管理信息<br><code>performance_schema数据库</code><br>MySQL 5.5开始新增的数据库，主要用于收集数据库服务器性能参数,库里表的 存储引擎均为PERFORMANCE_SCHEMA，用户不能创建存储引擎为 PERFORMANCE_SCHEMA的表<br><code>information_schema数据库</code><br>MySQL 5.0之后产生的，一个虚拟数据库，物理上并不存在 information_schema数据库类似与“数据字典”，提供了访问数据库元数据的 方式，即数据的数据。比如数据库名或表名，列类型，访问权限（更加细化的 访问方式） </p><h2 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a><code>服务器配置</code></h2><p><code>mysqld选项cmd-line和option file(可以写在配置文件中即服务器选项)</code>  </p><p><code>服务器系统变量 system var（服务器在内存中存放的状态，登陆服务器之后，show variables like &#39;变量名&#39; 可以看到的）</code>  </p><p><code>服务器状态变量  status var（只读性的变量，当前数据库的状态）</code><br>&ensp;&ensp;<a href="https://dev.mysql.com/doc/refman/5.7/en/mysqld-optiontables.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/mysqld-optiontables.html</a><br>&ensp;&ensp;<a href="https://mariadb" target="_blank" rel="noopener">https://mariadb</a>. com/kb/en/library/full-list-of-mariadb-optionssystem-and-status-variables/<br>注意：其中有些参数支持运行时修改，会立即生效；有些参数不支持，且 只能通过修改配置文件，并重启服务器程序生效；有些参数作用域是全局 的，且不可改变；有些可以为每个用户提供单独（会话）的设置  </p><p><code>获取mysqld的可用选项列表：服务器选项</code><br>&ensp;&ensp;<code>mysqld --help --verbose</code><br>&ensp;&ensp;<code>mysqld --print-defaults  获取默认设置</code> </p><h2 id="服务器配置-1"><a href="#服务器配置-1" class="headerlink" title="服务器配置"></a>服务器配置</h2><p><code>服务器系统变量：分全局和会话两种</code><br><code>服务器状态变量：分全局和会话两种</code><br>获取运行中的mysql进程使用各服务器参数及其值<br>&ensp;&ensp;mysql&gt; SHOW GLOBAL VARIABLES;<br>&ensp;&ensp;mysql&gt; SHOW [SESSION] VARIABLES;<br>设置服务器选项方法：<br>&ensp;&ensp;在命令行中设置<br>&ensp;&ensp;&ensp;&ensp;shell&gt; ./mysqld_safe –skip-name-resolve=1<br>&ensp;&ensp;在配置文件my.cnf中设置<br>&ensp;&ensp;&ensp;&ensp;skip_name_resolve=1   </p><h2 id="服务器端设置"><a href="#服务器端设置" class="headerlink" title="服务器端设置"></a>服务器端设置</h2><p><code>服务器系统变量：分全局和会话两种</code><br>获取系统变量：<br>&ensp;&ensp;mysql&gt; show global variables;  显示所有的全局变量<br>&ensp;&ensp;mysql&gt; show [session] variables;  显示所有的会话变量<br>&ensp;&ensp;mysql&gt; select @@varriables;  显示系统变量</p><p>修改服务器变量的值：<br>&ensp;&ensp;mysql&gt; help SET<br>修改全局变量：仅对修改后新创建的会话有效；对已经建立的会话无效<br>&ensp;&ensp;mysql&gt; SET GLOBAL system_var_name=value;<br>&ensp;&ensp;mysql&gt; SET @@global.system_var_name=value;<br>修改会话变量：<br>&ensp;&ensp;mysql&gt; SET [SESSION] system_var_name=value;<br>&ensp;&ensp;mysql&gt; SET @@[session.]system_var_name=value;<br>状态变量（只读）：用于保存mysqld运行中的统计数据的变量，不可更改<br>&ensp;&ensp;mysql&gt; SHOW GLOBAL STATUS;<br>&ensp;&ensp;mysql&gt; SHOW [SESSION] STATUS;   </p><h2 id="服务器变量SQL-MODE"><a href="#服务器变量SQL-MODE" class="headerlink" title="服务器变量SQL_MODE"></a><code>服务器变量SQL_MODE</code></h2><p>SQL_MODE：对其设置可以完成一些约束检查的工作,可分别进行全局的设置或当前会 话的设置，参看：<a href="https://mariadb.com/kb/en/library/sql-mode/" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/sql-mode/</a><br>常见MODE:<br>&ensp;&ensp;NO_AUTO_CREATE_USER<br>&ensp;&ensp;&ensp;&ensp;禁止GRANT创建密码为空的用户<br>&ensp;&ensp;NO_ZERO_DATE<br>&ensp;&ensp;&ensp;&ensp;在严格模式，不允许使用‘0000-00-00’的时间<br>&ensp;&ensp;ONLY_FULL_GROUP_BY<br>&ensp;&ensp;&ensp;&ensp;对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么 将认为这个SQL是不合法的<br>&ensp;&ensp;NO_BACKSLASH_ESCAPES<br>&ensp;&ensp;&ensp;&ensp;反斜杠“\”作为普通字符而非转义字符<br>&ensp;&ensp;PIPES_AS_CONCAT<br>&ensp;&ensp;&ensp;&ensp;将”||”视为连接操作符而非“或运算符</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">主要影响对数据库的操作</span><br><span class="line"></span><br><span class="line">查看sql_mode值</span><br><span class="line">MariaDB [hellodb]&gt; show variables like <span class="string">'sql_mode'</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| sql_mode      |       |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">创建一个表，限制输入的name记录的字段的字符长度为3个字符</span><br><span class="line">MariaDB [hellodb]&gt; create table <span class="built_in">test</span> (id int,name char(3));</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; show create table <span class="built_in">test</span>\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: <span class="built_in">test</span></span><br><span class="line">Create Table: CREATE TABLE `<span class="built_in">test</span>` (</span><br><span class="line">  `id` int(11) DEFAULT NULL,</span><br><span class="line">  `name` char(3) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">添加长字段测试，添加字段未被限制不让添加仅仅是报警</span><br><span class="line">MariaDB [hellodb]&gt; insert <span class="built_in">test</span> value (2,<span class="string">'abcde'</span>);</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看报警信息</span><br><span class="line">MariaDB [hellodb]&gt; show warnings;</span><br><span class="line">+---------+------+-------------------------------------------+</span><br><span class="line">| Level   | Code | Message                                   |</span><br><span class="line">+---------+------+-------------------------------------------+</span><br><span class="line">| Warning | 1265 | Data truncated <span class="keyword">for</span> column <span class="string">'name'</span> at row 1 |</span><br><span class="line">+---------+------+-------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看表中的所有的字段，虽然添加超过限制的字段，但是录入了在限制内的字段，显示的字段为3个所以留下了三个字段</span><br><span class="line">MariaDB [hellodb]&gt; select * from <span class="built_in">test</span>;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | name |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 | abc  |</span><br><span class="line">|    2 | abc  |</span><br><span class="line">+------+------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">修改sql_mode变量</span><br><span class="line">  5.5版本的数据库默认sql_mod的值为空</span><br><span class="line">MariaDB [hellodb]&gt; show variables like <span class="string">'sql_mode'</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| sql_mode      |       |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">修改sql_mode值限制在添加字段的时候的值不能超长，未修改之前只是报警，截取可以限制的长度内的字段则被记录</span><br><span class="line">MariaDB [hellodb]&gt; <span class="built_in">set</span> sql_mode=<span class="string">'traditional'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; show variables like <span class="string">'sql_mode'</span>;</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name | Value                                                                                                                                                |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| sql_mode      | STRICT_TRANS_TABLES,STRICT_ALL_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,TRADITIONAL,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">再次添加超长字段测试：直接不是报警了，直接报错</span><br><span class="line">MariaDB [hellodb]&gt; insert <span class="built_in">test</span> value (3,<span class="string">'abcdeddd'</span>);</span><br><span class="line">ERROR 1406 (22001): Data too long <span class="keyword">for</span> column <span class="string">'name'</span> at row 1</span><br><span class="line"></span><br><span class="line">查看添加的记录是否添加进入：未被添加进去</span><br><span class="line">MariaDB [hellodb]&gt; select * from <span class="built_in">test</span>;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | name |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 | abc  |</span><br><span class="line">|    2 | abc  |</span><br><span class="line">+------+------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p>在命令外显示系统自带的变量：数据库的状态信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mysql -e 'show status' | grep select </span></span><br><span class="line">Com_insert_select0</span><br><span class="line">Com_replace_select0</span><br><span class="line">Com_select1                  查询的次数</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; use hellodb;</span><br><span class="line">Reading table information <span class="keyword">for</span> completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MariaDB [hellodb]&gt; show status like <span class="string">'com_select'</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Com_select    | 2     |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">再次查询查看是否会增长</span><br><span class="line">MariaDB [hellodb]&gt; select * from <span class="built_in">test</span>;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | name |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 | abc  |</span><br><span class="line">|    2 | abc  |</span><br><span class="line">+------+------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; show status like <span class="string">'com_select'</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Com_select    | 3     |   记录执行查询命令的次数</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line">状态变量不可使用<span class="built_in">set</span>修改</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;mysql之存储引擎和服务器配置&quot;&gt;&lt;a href=&quot;#mysql之存储引擎和服务器配置&quot; class=&quot;headerlink&quot; title=&quot;mysql之存储引擎和服务器配置&quot;&gt;&lt;/a&gt;mysql之存储引擎和服务器配置&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/mysql之存储引擎和服务器配置/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://daizhe.net.cn/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://daizhe.net.cn/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysql之数据库用户和权限管理</title>
    <link href="https://daizhe.net.cn/2019/02/20/mysql%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%94%A8%E6%88%B7%E5%92%8C%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/"/>
    <id>https://daizhe.net.cn/2019/02/20/mysql之数据库用户和权限管理/</id>
    <published>2019-02-20T07:02:04.976Z</published>
    <updated>2019-02-20T07:17:44.116Z</updated>
    
    <content type="html"><![CDATA[<h1 id="mysql之数据库用户和权限管理"><a href="#mysql之数据库用户和权限管理" class="headerlink" title="mysql之数据库用户和权限管理"></a>mysql之数据库用户和权限管理</h1><p><img src="/2019/02/20/mysql之数据库用户和权限管理/标题.gif" alt=""><br><a id="more"></a></p><h2 id="MySQL用户和权限管理"><a href="#MySQL用户和权限管理" class="headerlink" title="MySQL用户和权限管理"></a>MySQL用户和权限管理</h2><p>元数据数据库：mysql<br>&ensp;&ensp;系统授权表：<br>&ensp;&ensp;db, host, user<br>&ensp;&ensp;columns_priv, tables_priv, procs_priv, proxies_priv<br>用户账号：<br>&ensp;&ensp;‘USERNAME‘@’HOST’  &ensp;&ensp;  用户名@允许从哪台主机登陆<br>&ensp;&ensp;@’HOST’:<br>&ensp;&ensp;主机名<br>&ensp;&ensp;IP地址或Network<br>&ensp;&ensp;通配符： %   _<br>&ensp;&ensp;示例：172.16.%.%   </p><h2 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a><code>用户管理</code></h2><p><code>创建用户：CREATE USER</code><br>&ensp;&ensp;CREATE USER ‘USERNAME‘@’HOST’ [IDENTIFIED BY ‘password’]；<br>&ensp;&ensp;默认权限：USAGE<br><code>用户重命名：RENAME USER</code><br>&ensp;&ensp;RENAME USER old_user_name TO new_user_name;<br><code>删除用户：</code><br>&ensp;&ensp;DROP USER ‘USERNAME‘@’HOST‘<br>&ensp;&ensp;示例：删除默认的空用户<br>&ensp;&ensp;DROP USER ‘‘@’localhost’;<br><code>修改密码：</code><br>&ensp;&ensp;mysql&gt;SET PASSWORD FOR ‘user‘@’host’ = PASSWORD(‘password’);<br>&ensp;&ensp;mysql&gt;UPDATE mysql.user SET password=PASSWORD(‘password’) WHERE clause; （直接修改表，不会立即生效，配合下面的命令）<br>&ensp;&ensp;&ensp;&ensp;此方法需要执行下面指令才能生效：<br>&ensp;&ensp;&ensp;&ensp;mysql&gt; FLUSH PRIVILEGES;<br>&ensp;&ensp;#mysqladmin -u root -poldpass  password  ‘newpass’<br><code>忘记管理员密码的解决办法：</code><br>&ensp;&ensp;启动mysqld进程时，为其使用如下选项：<br>&ensp;&ensp;&ensp;&ensp;–skip-grant-tables<br>&ensp;&ensp;&ensp;&ensp;–skip-networking   (禁止数据库有网络功能，防止破解口令的同时其他人利用此特性盗取数据)<br>&ensp;&ensp;使用UPDATE命令修改管理员密码<br>&ensp;&ensp;关闭mysqld进程，移除上述两个选项，重启mysqld<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">查看mysql数据库中的用户信息</span><br><span class="line">系统表</span><br><span class="line">MariaDB [mysql]&gt; show tables;</span><br><span class="line">+---------------------------+</span><br><span class="line">| Tables_in_mysql           |</span><br><span class="line">+---------------------------+</span><br><span class="line">| columns_priv              |</span><br><span class="line">| db                        |</span><br><span class="line">| event                     |</span><br><span class="line">| func                      |</span><br><span class="line">| general_log               |</span><br><span class="line">| help_category             |</span><br><span class="line">| help_keyword              |</span><br><span class="line">| help_relation             |</span><br><span class="line">| help_topic                |</span><br><span class="line">| host                      |</span><br><span class="line">| ndb_binlog_index          |</span><br><span class="line">| plugin                    |</span><br><span class="line">| proc                      |</span><br><span class="line">| procs_priv                |</span><br><span class="line">| proxies_priv              |</span><br><span class="line">| servers                   |</span><br><span class="line">| slow_log                  |</span><br><span class="line">| tables_priv               |</span><br><span class="line">| time_zone                 |</span><br><span class="line">| time_zone_leap_second     |</span><br><span class="line">| time_zone_name            |</span><br><span class="line">| time_zone_transition      |</span><br><span class="line">| time_zone_transition_type |</span><br><span class="line">| user                      |</span><br><span class="line">+---------------------------+</span><br><span class="line">24 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line">查询当前数据库服务器中的用户</span><br><span class="line">MariaDB [mysql]&gt; select user,host from user;</span><br><span class="line">+------+-------------+</span><br><span class="line">| user | host        |</span><br><span class="line">+------+-------------+</span><br><span class="line">| root | 127.0.0.1   |</span><br><span class="line">| root | ::1         |</span><br><span class="line">|      | centos7.com |</span><br><span class="line">| root | centos7.com |</span><br><span class="line">|      | localhost   |</span><br><span class="line">| root | localhost   |</span><br><span class="line">+------+-------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><code>创建账号</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">创建账号，授权允许此用户可以在那台主机上登陆数据库</span><br><span class="line"> 创建<span class="built_in">test</span>这个用户可以在172.18.133. 这个网段的连接此服务器，并且设置口令为centos</span><br><span class="line">MariaDB [mysql]&gt; create user <span class="built_in">test</span>@<span class="string">'172.18.133.%'</span> identified by <span class="string">'centos'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看是否创建</span><br><span class="line">MariaDB [mysql]&gt; select user,host from user;</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | host         |</span><br><span class="line">+------+--------------+</span><br><span class="line">| root | 127.0.0.1    |   系统自带的管理员</span><br><span class="line">| <span class="built_in">test</span> | 172.18.133.% |   </span><br><span class="line">| root | ::1          |   系统自带的管理员</span><br><span class="line">|      | centos7.com  |   匿名账号</span><br><span class="line">| root | centos7.com  |   系统自带的管理员</span><br><span class="line">|      | localhost    |   匿名账号</span><br><span class="line">| root | localhost    |</span><br><span class="line">+------+--------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">使用此账号远程登陆 -h 指定服务器端的ip地址</span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql -utest -pcentos -h172.18.133.162</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 11</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">'\c'</span> to clear the current input statement.</span><br><span class="line">MariaDB [(none)]&gt; </span><br><span class="line"></span><br><span class="line">查看当前连接的用户名：使用user函数查看</span><br><span class="line">MariaDB [(none)]&gt; select user();</span><br><span class="line">+---------------------+</span><br><span class="line">| user()              |</span><br><span class="line">+---------------------+</span><br><span class="line">| <span class="built_in">test</span>@172.18.133.162 |</span><br><span class="line">+---------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">使用create user 创建的账号，登陆上来之后查看当前数据库的数据库仅能看到两个，因为创建的账号没有权限</span><br><span class="line">  使用create user创建好账号登陆</span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">删除用户</span><br><span class="line">  范例为：删除匿名用户</span><br><span class="line">MariaDB [mysql]&gt; select user,host from user;</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | host         |</span><br><span class="line">+------+--------------+</span><br><span class="line">| root | 127.0.0.1    |</span><br><span class="line">| <span class="built_in">test</span> | 172.18.133.% |</span><br><span class="line">| root | ::1          |</span><br><span class="line">|      | centos7.com  |   匿名账号</span><br><span class="line">| root | centos7.com  |</span><br><span class="line">|      | localhost    |   匿名账号</span><br><span class="line">| root | localhost    |</span><br><span class="line">+------+--------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">  删除匿名用户：没有用户名就时空，用单引号引起来</span><br><span class="line">MariaDB [mysql]&gt; drop user <span class="string">''</span>@centos7.com</span><br><span class="line">    -&gt; ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [mysql]&gt; drop user <span class="string">''</span>@localhost;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">再次查询当前数据库的账号</span><br><span class="line">MariaDB [mysql]&gt; select user,host from user;</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | host         |</span><br><span class="line">+------+--------------+</span><br><span class="line">| root | 127.0.0.1    |</span><br><span class="line">| <span class="built_in">test</span> | 172.18.133.% |</span><br><span class="line">| root | ::1          |</span><br><span class="line">| root | centos7.com  |</span><br><span class="line">| root | localhost    |</span><br><span class="line">+------+--------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><code>修改用户口令，设置密码</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">修改用户口令 ： password函数生成加密口令</span><br><span class="line">  查看当前的账号信息以及密码</span><br><span class="line">MariaDB [mysql]&gt; select user,host,password from user;</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">| user | host         | password                                  |</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">| root | localhost    |                                           |</span><br><span class="line">| root | centos7.com  |                                           |</span><br><span class="line">| root | 127.0.0.1    |                                           |</span><br><span class="line">| root | ::1          |                                           |</span><br><span class="line">| <span class="built_in">test</span> | 172.18.133.% | *128977E278358FF80A246B5046F51043A2B1FCED |</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">  使用password 可以将你要设置的字符串设置加密</span><br><span class="line">MariaDB [mysql]&gt; select password(<span class="string">'dai'</span>);</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| password(<span class="string">'dai'</span>)                           |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| *CE886B6974FB59FB743ADF5DB78FDA6B25649F5C |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">修改用户的口令：对<span class="built_in">test</span>用户修改口令，将原有的centos口令修改为daizhe</span><br><span class="line">MariaDB [mysql]&gt; <span class="built_in">set</span> password <span class="keyword">for</span> <span class="built_in">test</span>@<span class="string">'172.18.133.%'</span>=password(<span class="string">'daizhe'</span>);</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [mysql]&gt; select user,host,password from user;</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">| user | host         | password                                  |</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">| root | localhost    |                                           |</span><br><span class="line">| root | centos7.com  |                                           |</span><br><span class="line">| root | 127.0.0.1    |                                           |</span><br><span class="line">| root | ::1          |                                           |</span><br><span class="line">| <span class="built_in">test</span> | 172.18.133.% | *0E04F27C8B21547FD069D6E8519AE49B7ECE8E94 |</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">使用新口令登陆</span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql -utest -pdaizhe -h172.18.133.162</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 6</span><br><span class="line"></span><br><span class="line">将数据库系统自带的管理员用户添加密码：设置密码为daizhe （mysql数据库的缺点就是设置相同口令的密码会看的出来，因为没有加盐 sort）</span><br><span class="line">MariaDB [mysql]&gt; update user <span class="built_in">set</span> password=password(<span class="string">'daizhe'</span>) <span class="built_in">where</span> user=<span class="string">'root'</span>;</span><br><span class="line">Query OK, 4 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 4  Changed: 4  Warnings: 0</span><br><span class="line">MariaDB [mysql]&gt; select user,host,password from user;</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">| user | host         | password                                  |</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">| root | localhost    | *0E04F27C8B21547FD069D6E8519AE49B7ECE8E94 |</span><br><span class="line">| root | centos7.com  | *0E04F27C8B21547FD069D6E8519AE49B7ECE8E94 |</span><br><span class="line">| root | 127.0.0.1    | *0E04F27C8B21547FD069D6E8519AE49B7ECE8E94 |</span><br><span class="line">| root | ::1          | *0E04F27C8B21547FD069D6E8519AE49B7ECE8E94 |</span><br><span class="line">| <span class="built_in">test</span> | 172.18.133.% | *0E04F27C8B21547FD069D6E8519AE49B7ECE8E94 |</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">  此时不会立即生效:执行生效命令</span><br><span class="line">MariaDB [mysql]&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">测试密码是否已经被更改</span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql </span></span><br><span class="line">ERROR 1045 (28000): Access denied <span class="keyword">for</span> user <span class="string">'root'</span>@<span class="string">'localhost'</span> (using password: NO)</span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql -pdaizhe</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 9</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br></pre></td></tr></table></figure></p><p><code>范例：假设root口令忘记了</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  如果是测试环境，可以最直接的方法，删除数据库的数据目录，因为数据库的所有数据都存放在数据库的数据目录中</span><br><span class="line">rm -rf /var/lib/mysql/*</span><br><span class="line">systemctl restart mariadb</span><br><span class="line"></span><br><span class="line">破解root密码并且保存数据库的所有数据</span><br><span class="line">编辑数据的配置文件（使得数据库登陆时忽略授权表）</span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">skip-grant-tables</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart mariadb</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 2</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br></pre></td></tr></table></figure></p><h2 id="MySQL权限管理"><a href="#MySQL权限管理" class="headerlink" title="MySQL权限管理"></a><code>MySQL权限管理</code></h2><p><code>权限类别：</code><br>&ensp;&ensp;管理类<br>&ensp;&ensp;程序类<br>&ensp;&ensp;数据库级别<br>&ensp;&ensp;表级别<br>&ensp;&ensp;字段级别  </p><h2 id="MySQL用户和权限管理-1"><a href="#MySQL用户和权限管理-1" class="headerlink" title="MySQL用户和权限管理"></a><code>MySQL用户和权限管理</code></h2><p><code>管理类：</code><br>&ensp;&ensp;CREATE TEMPORARY TABLES<br>&ensp;&ensp;CREATE USER<br>&ensp;&ensp;FILE<br>&ensp;&ensp;SUPER<br>&ensp;&ensp;SHOW DATABASES<br>&ensp;&ensp;RELOAD<br>&ensp;&ensp;SHUTDOWN<br>&ensp;&ensp;REPLICATION SLAVE<br>&ensp;&ensp;REPLICATION CLIENT<br>&ensp;&ensp;LOCK TABLES<br>&ensp;&ensp;PROCESS<br><code>程序类：</code> FUNCTION、PROCEDURE、TRIGGER    函数、存储过程、触发器<br>&ensp;&ensp;CREATE<br>&ensp;&ensp;ALTER<br>&ensp;&ensp;DROP<br>&ensp;&ensp;EXCUTE<br><code>库和表级别：</code>DATABASE、TABLE    数据库、表<br>&ensp;&ensp;ALTER<br>&ensp;&ensp;CREATE<br>&ensp;&ensp;CREATE VIEW<br>&ensp;&ensp;DROP<br>&ensp;&ensp;INDEX<br>&ensp;&ensp;SHOW VIEW<br>&ensp;&ensp;GRANT OPTION：能将自己获得的权限转赠给其他用户  （让权限具有传递性）<br><code>数据操作：</code>   增删改查<br>&ensp;&ensp;SELECT<br>&ensp;&ensp;INSERT<br>&ensp;&ensp;DELETE<br>&ensp;&ensp;UPDATE<br><code>字段级别：</code>    精确到字段的增删改查<br>&ensp;&ensp;SELECT(col1,col2,…)<br>&ensp;&ensp;UPDATE(col1,col2,…)<br>&ensp;&ensp;INSERT(col1,col2,…)<br><code>所有权限：</code>ALL PRIVILEGES 或 ALL  </p><h2 id="授权"><a href="#授权" class="headerlink" title="授权"></a><code>授权</code></h2><p><code>授权</code><br>参考：<a href="https://dev.mysql.com/doc/refman/5.7/en/grant.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/grant.html</a><br>&ensp;&ensp;GRANT priv_type [(column_list)],… ON [object_type] priv_level TO ‘user‘@’host’ [IDENTIFIED BY ‘password’] [WITH GRANT OPTION];<br>&ensp;&ensp;priv_type: ALL [PRIVILEGES]<br>&ensp;&ensp;object_type:TABLE | FUNCTION | PROCEDURE<br>&ensp;&ensp;priv_level:  <em>(所有库)  | </em>.<em>  | db_name.</em>  | db_name.tbl_name  | tbl_name(当前库 的表)  | db_name.routine_name(指定库的函数,存储过程,触发器)<br>with_option: GRANT OPTION<br>&ensp;&ensp;| MAX_QUERIES_PER_HOUR count<br>&ensp;&ensp;| MAX_UPDATES_PER_HOUR count<br>&ensp;&ensp;| MAX_CONNECTIONS_PER_HOUR count<br>&ensp;&ensp;| MAX_USER_CONNECTIONS count<br>示例：GRANT SELECT (col1), INSERT (col1,col2) ON mydb.mytbl TO ‘someuser‘@’somehost‘;   </p><p><code>回收授权</code><br>回收授权：REVOKE   priv_type [(column_list)]  [, priv_type [(column_list)]] …    ON [object_type] priv_level  FROM user [, user] …<br>示例：  REVOKE DELETE ON testdb.* FROM ‘testuser‘@‘172.16.0.%’; 查<br>看指定用户获得的授权：<br>&ensp;&ensp;Help SHOW GRANTS<br>&ensp;&ensp;SHOW GRANTS FOR ‘user‘@’host’;<br>&ensp;&ensp;SHOW GRANTS FOR CURRENT_USER[()];<br>注意：MariaDB服务进程启动时会读取mysql库中所有授权表至内存<br>&ensp;&ensp;(1) GRANT或REVOKE等执行权限操作会保存于系统表中，MariaDB的服务进 程通常会自动重读授权表，使之生效<br>&ensp;&ensp;(2) 对于不能够或不能及时重读授权表的命令，可手动让MariaDB的服务进程 重读授权表：mysql&gt; FLUSH PRIVILEGES;   </p><p><code>范例：实现用户的权限授权</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">创建一个账号</span><br><span class="line">MariaDB [mysql]&gt; create user daizhe@<span class="string">'172.18.133.%'</span> identified by <span class="string">'daizhe'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">授权创建的daizhe 这个账号权限</span><br><span class="line"> 多这个账号授权所有权限，在hollodb中的所有表</span><br><span class="line">MariaDB [mysql]&gt; grant all on hellodb.* to daizhe@<span class="string">'172.18.133.%'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">使用此账号，远程连接查看是否已经授权</span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql -udaizhe -pdaizhe -h172.18.133.162</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 9</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">'\c'</span> to clear the current input statement.</span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用grant 创建用户、授权、设置密码</span><br><span class="line">  创建test2这个用户，针对hellodb这个库中的表， 仅能针对特定的字段来查询，</span><br><span class="line">MariaDB [(none)]&gt; grant select(name,age) on hellodb.students to test2@<span class="string">'172.18.133.%'</span> identified by <span class="string">'daizhe'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看授权完的用户的权限</span><br><span class="line">MariaDB [(none)]&gt; show grants <span class="keyword">for</span> test2@<span class="string">'172.18.133.%'</span>\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">Grants <span class="keyword">for</span> test2@172.18.133.%: GRANT USAGE ON *.* TO <span class="string">'test2'</span>@<span class="string">'172.18.133.%'</span> IDENTIFIED BY PASSWORD <span class="string">'*0E04F27C8B21547FD069D6E8519AE49B7ECE8E94'</span></span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">Grants <span class="keyword">for</span> test2@172.18.133.%: GRANT SELECT (age, name) ON `hellodb`.`students` TO <span class="string">'test2'</span>@<span class="string">'172.18.133.%'</span></span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">取消回收权限 revoke</span><br><span class="line">  创建一个用户给与针对于所有库的所有权限</span><br><span class="line">MariaDB [(none)]&gt; grant all on *.* to test3@<span class="string">'172.18.133.%'</span> identified by <span class="string">'daizhe'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">取消这个用户的select 查询权限</span><br><span class="line">MariaDB [(none)]&gt; revoke select on *.* from test3@<span class="string">'172.18.133.%'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看test3用户的权限</span><br><span class="line">MariaDB [(none)]&gt; show grants <span class="keyword">for</span> test3@<span class="string">'172.18.133.%'</span>\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">Grants <span class="keyword">for</span> test3@172.18.133.%: GRANT INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE ON *.* TO <span class="string">'test3'</span>@<span class="string">'172.18.133.%'</span> IDENTIFIED BY PASSWORD <span class="string">'*0E04F27C8B21547FD069D6E8519AE49B7ECE8E94'</span></span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看当前用户的权限</span><br><span class="line">MariaDB [(none)]&gt; show grants <span class="keyword">for</span> current_user()\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">Grants <span class="keyword">for</span> root@localhost: GRANT ALL PRIVILEGES ON *.* TO <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED BY PASSWORD <span class="string">'*0E04F27C8B21547FD069D6E8519AE49B7ECE8E94'</span> WITH GRANT OPTION</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">Grants <span class="keyword">for</span> root@localhost: GRANT PROXY ON <span class="string">''</span>@<span class="string">''</span> TO <span class="string">'root'</span>@<span class="string">'localhost'</span> WITH GRANT OPTION</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;mysql之数据库用户和权限管理&quot;&gt;&lt;a href=&quot;#mysql之数据库用户和权限管理&quot; class=&quot;headerlink&quot; title=&quot;mysql之数据库用户和权限管理&quot;&gt;&lt;/a&gt;mysql之数据库用户和权限管理&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/mysql之数据库用户和权限管理/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://daizhe.net.cn/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://daizhe.net.cn/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysql之数据库DML语言</title>
    <link href="https://daizhe.net.cn/2019/02/20/mysql%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%BA%93DML%E8%AF%AD%E8%A8%80/"/>
    <id>https://daizhe.net.cn/2019/02/20/mysql之数据库DML语言/</id>
    <published>2019-02-20T06:50:41.722Z</published>
    <updated>2019-02-20T07:17:51.082Z</updated>
    
    <content type="html"><![CDATA[<h1 id="mysql之数据库DML语言"><a href="#mysql之数据库DML语言" class="headerlink" title="mysql之数据库DML语言"></a>mysql之数据库DML语言</h1><p><img src="/2019/02/20/mysql之数据库DML语言/标题.gif" alt=""><br><a id="more"></a></p><h2 id="DML语言-增加insert"><a href="#DML语言-增加insert" class="headerlink" title="DML语言 增加insert"></a>DML语言 增加insert</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"> DML语句   </span><br><span class="line">DML: INSERT增加, DELETE删除, UPDATE  改 </span><br><span class="line"></span><br><span class="line">增加insert</span><br><span class="line">查看帮助：MariaDB [studentdb]&gt; <span class="built_in">help</span> insert</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查询当前数据库中的表信息</span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)    （为空）</span><br><span class="line"></span><br><span class="line">查询当前表中的记录数 （count 为函数）</span><br><span class="line">MariaDB [studentdb]&gt; select count(*) from student;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|        0 |</span><br><span class="line">+----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)  （为空）</span><br><span class="line"></span><br><span class="line">在当前使用的表中添加纪录</span><br><span class="line">首先查看表的结构，查看有哪些字段</span><br><span class="line">MariaDB [studentdb]&gt; desc student;</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| Field   | Type                | Null | Key | Default | Extra          |</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| id      | int(10) unsigned    | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name    | varchar(10)         | NO   |     | NULL    |                |</span><br><span class="line">| sex     | enum(<span class="string">'f'</span>,<span class="string">'m'</span>)       | YES  |     | m       |                |</span><br><span class="line">| age     | tinyint(3) unsigned | YES  |     | NULL    |                |</span><br><span class="line">| phone   | char(11)            | YES  |     | NULL    |                |</span><br><span class="line">| address | varchar(50)         | YES  |     | NULL    |                |</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在表中添加纪录（赋值字段对应的字段，相对应的值，顺序不可变）（值和字段必须相同）</span><br><span class="line">MariaDB [studentdb]&gt; insert into student (name,age,phone,address) values (<span class="string">'mage'</span>,30,10086,<span class="string">'beijing'</span>), (<span class="string">'daizhe'</span>,20,10010,<span class="string">'tangshan'</span>);</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line">Records: 2  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">查询表中的纪录</span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">| id | name   | sex  | age  | phone | address  |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">|  1 | mage   | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe | m    |   20 | 10010 | tangshan |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; select count(*) from student;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|        2 |</span><br><span class="line">+----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">假如上述赋值时手机号忘记了怎么赋值（空值设置方法）</span><br><span class="line">MariaDB [studentdb]&gt; insert into student (age,name,phone,address) values (20,<span class="string">'ma'</span>,null,<span class="string">'shijiahuang'</span>);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">+----+--------+------+------+-------+-------------+</span><br><span class="line">| id | name   | sex  | age  | phone | address     |</span><br><span class="line">+----+--------+------+------+-------+-------------+</span><br><span class="line">|  1 | mage   | m    |   30 | 10086 | beijing     |</span><br><span class="line">|  2 | daizhe | m    |   20 | 10010 | tangshan    |</span><br><span class="line">|  3 | dehua  | m    |   22 | NULL  | tianjin     |</span><br><span class="line">|  4 | ma     | m    |   20 | NULL  | shijiahuang |</span><br><span class="line">+----+--------+------+------+-------+-------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">单独挑出字段来赋值</span><br><span class="line">MariaDB [studentdb]&gt; insert student <span class="built_in">set</span> name=<span class="string">'dehua'</span>,age=22,address=<span class="string">'tianjin'</span>;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">| id | name   | sex  | age  | phone | address  |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">|  1 | mage   | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe | m    |   20 | 10010 | tangshan |</span><br><span class="line">|  3 | dehua  | m    |   22 | NULL  | tianjin  |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p>克隆表结构，并且纪录也被克隆<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">克隆表结构</span><br><span class="line">MariaDB [studentdb]&gt; create table employee select * from student;</span><br><span class="line">Query OK, 2 rows affected (0.01 sec)</span><br><span class="line">Records: 2  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">查看克隆生成的表的结构</span><br><span class="line">MariaDB [studentdb]&gt; desc employee;</span><br><span class="line">+---------+---------------------+------+-----+---------+-------+</span><br><span class="line">| Field   | Type                | Null | Key | Default | Extra |</span><br><span class="line">+---------+---------------------+------+-----+---------+-------+</span><br><span class="line">| id      | int(10) unsigned    | NO   |     | 0       |       |</span><br><span class="line">| name    | varchar(10)         | NO   |     | NULL    |       |</span><br><span class="line">| sex     | enum(<span class="string">'f'</span>,<span class="string">'m'</span>)       | YES  |     | m       |       |</span><br><span class="line">| age     | tinyint(3) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| phone   | char(11)            | YES  |     | NULL    |       |</span><br><span class="line">| address | varchar(50)         | YES  |     | NULL    |       |</span><br><span class="line">+---------+---------------------+------+-----+---------+-------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line">查看数据是否也被克隆，被克隆</span><br><span class="line">MariaDB [studentdb]&gt; select * from employee;</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">| id | name   | sex  | age  | phone | address  |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">|  1 | mage   | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe | m    |   20 | 10010 | tangshan |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>克隆表结构，并且纪录不被克隆<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [studentdb]&gt; create table haha like student;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; desc haha;</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| Field   | Type                | Null | Key | Default | Extra          |</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| id      | int(10) unsigned    | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name    | varchar(10)         | NO   |     | NULL    |                |</span><br><span class="line">| sex     | enum(<span class="string">'f'</span>,<span class="string">'m'</span>)       | YES  |     | m       |                |</span><br><span class="line">| age     | tinyint(3) unsigned | YES  |     | NULL    |                |</span><br><span class="line">| phone   | char(11)            | YES  |     | NULL    |                |</span><br><span class="line">| address | varchar(50)         | YES  |     | NULL    |                |</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; select * from haha</span><br><span class="line">    -&gt; ;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>将相同表结构的数据合并<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [studentdb]&gt; select * from haha;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; insert haha select * from student;   (将student中的数据导入到haha表中，前提是两张表的表结构是相同的)</span><br><span class="line">Query OK, 4 rows affected (0.01 sec)</span><br><span class="line">Records: 4  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p><p>在表的纪录的数据中添加汉字<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">添加中文件字段</span><br><span class="line">MariaDB [studentdb]&gt; insert into student (age,name,phone,address) values (19,<span class="string">'星星'</span>,114114,<span class="string">'河北'</span>);</span><br><span class="line"></span><br><span class="line">结果显示为乱码</span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">+----+--------+------+------+--------+-------------+</span><br><span class="line">| id | name   | sex  | age  | phone  | address     |</span><br><span class="line">+----+--------+------+------+--------+-------------+</span><br><span class="line">|  1 | mage   | m    |   30 | 10086  | beijing     |</span><br><span class="line">|  2 | daizhe | m    |   20 | 10010  | tangshan    |</span><br><span class="line">|  3 | dehua  | m    |   22 | NULL   | tianjin     |</span><br><span class="line">|  4 | ma     | m    |   20 | NULL   | shijiahuang |</span><br><span class="line">|  5 | ??     | m    |   19 | 114114 | ??          |</span><br><span class="line">+----+--------+------+------+--------+-------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">乱码原因</span><br><span class="line">当初创建表的时候，用的为在字符集不支持汉字</span><br><span class="line">MariaDB [studentdb]&gt; show create table student;</span><br><span class="line"></span><br><span class="line">| student | CREATE TABLE `student` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(10) NOT NULL,</span><br><span class="line">  `sex` enum(<span class="string">'f'</span>,<span class="string">'m'</span>) DEFAULT <span class="string">'m'</span>,</span><br><span class="line">  `age` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">  `phone` char(11) DEFAULT NULL,</span><br><span class="line">  `address` varchar(50) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1 |</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建一个utf8mb4的数据库</span><br><span class="line">MariaDB [studentdb]&gt;  create database db_utf8mb4 character <span class="built_in">set</span>=utf8mb4;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| db_utf8mb4         |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| studentdb          |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">克隆一张，studentdb库中的表student 倒 db_utf8mb4库中，仅克隆表结构</span><br><span class="line">（跨库导入表，库于表之间需要加点）</span><br><span class="line">MariaDB [studentdb]&gt; use db_utf8mb4;</span><br><span class="line">Database changed</span><br><span class="line">MariaDB [db_utf8mb4]&gt; </span><br><span class="line">   跨库克隆</span><br><span class="line">MariaDB [db_utf8mb4]&gt; create table student like studentdb.student</span><br><span class="line">    -&gt; ;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">查看克隆过来的表的字符集</span><br><span class="line">MariaDB [db_utf8mb4]&gt; show create table student;</span><br><span class="line"></span><br><span class="line">| student | CREATE TABLE `student` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(10) NOT NULL,</span><br><span class="line">  `sex` enum(<span class="string">'f'</span>,<span class="string">'m'</span>) DEFAULT <span class="string">'m'</span>,</span><br><span class="line">  `age` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">  `phone` char(11) DEFAULT NULL,</span><br><span class="line">  `address` varchar(50) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=latin1 |</span><br><span class="line"></span><br><span class="line">  此表为latin1也不支持中文，修改表的字符集</span><br><span class="line">MariaDB [db_utf8mb4]&gt; alter table student character <span class="built_in">set</span> = utf8mb4</span><br><span class="line">    -&gt; ;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)               </span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MariaDB [db_utf8mb4]&gt; show create table student;</span><br><span class="line">| student | CREATE TABLE `student` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(10) CHARACTER SET latin1 NOT NULL,</span><br><span class="line">  `sex` enum(<span class="string">'f'</span>,<span class="string">'m'</span>) CHARACTER SET latin1 DEFAULT <span class="string">'m'</span>,</span><br><span class="line">  `age` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">  `phone` char(11) CHARACTER SET latin1 DEFAULT NULL,</span><br><span class="line">  `address` varchar(50) CHARACTER SET latin1 DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line"></span><br><span class="line">在此表中手动添加纪录</span><br><span class="line">MariaDB [db_utf8mb4]&gt; insert student (name,age,address) values (<span class="string">'nana'</span>,22,<span class="string">'石家庄'</span>);Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [db_utf8mb4]&gt; select * from status;</span><br><span class="line">ERROR 1146 (42S02): Table <span class="string">'db_utf8mb4.status'</span> doesn<span class="string">'t exist</span></span><br><span class="line"><span class="string">MariaDB [db_utf8mb4]&gt; select * from student;</span></span><br><span class="line"><span class="string">+----+------+------+------+-------+---------+</span></span><br><span class="line"><span class="string">| id | name | sex  | age  | phone | address |</span></span><br><span class="line"><span class="string">+----+------+------+------+-------+---------+</span></span><br><span class="line"><span class="string">|  1 | nana | m    |   22 | NULL  | ？？？  |</span></span><br><span class="line"><span class="string">+----+------+------+------+-------+---------+</span></span><br><span class="line"><span class="string">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">结果还是乱码</span></span><br><span class="line"><span class="string">查看此库的信息，显示编码不一致（结论客户端和服务端都应该统一编码）</span></span><br><span class="line"><span class="string">MariaDB [db_utf8mb4]&gt; status</span></span><br><span class="line"><span class="string">--------------</span></span><br><span class="line"><span class="string">mysql  Ver 15.1 Distrib 5.5.60-MariaDB, for Linux (x86_64) using readline 5.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Connection id:2</span></span><br><span class="line"><span class="string">Current database:db_utf8mb4</span></span><br><span class="line"><span class="string">Current user:root@localhost</span></span><br><span class="line"><span class="string">SSL:Not in use</span></span><br><span class="line"><span class="string">Current pager:stdout</span></span><br><span class="line"><span class="string">Using outfile:'</span><span class="string">'</span></span><br><span class="line"><span class="string">Using delimiter:;</span></span><br><span class="line"><span class="string">Server:MariaDB</span></span><br><span class="line"><span class="string">Server version:5.5.60-MariaDB MariaDB Server</span></span><br><span class="line"><span class="string">Protocol version:10</span></span><br><span class="line"><span class="string">Connection:Localhost via UNIX socket</span></span><br><span class="line"><span class="string">Insert id:1</span></span><br><span class="line"><span class="string">Server characterset:latin1</span></span><br><span class="line"><span class="string">Db     characterset:utf8mb4</span></span><br><span class="line"><span class="string">Client characterset:utf8</span></span><br><span class="line"><span class="string">Conn.  characterset:utf8</span></span><br><span class="line"><span class="string">UNIX socket:/var/lib/mysql/mysql.sock</span></span><br><span class="line"><span class="string">Uptime:3 min 21 sec</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Threads: 1  Questions: 14  Slow queries: 0  Opens: 1  Flush tables: 2  Open tables: 27  Queries per second avg: 0.069</span></span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">设置所有的编码都进行统一</span><br><span class="line">  设定之前查看当前数据库字符集，目前客户端和服务端都不一致</span><br><span class="line">  MariaDB [(none)]&gt; status</span><br><span class="line">--------------</span><br><span class="line">mysql  Ver 15.1 Distrib 5.5.60-MariaDB, <span class="keyword">for</span> Linux (x86_64) using readline 5.1</span><br><span class="line"></span><br><span class="line">Connection id:3</span><br><span class="line">Current database:</span><br><span class="line">Current user:root@localhost</span><br><span class="line">SSL:Not <span class="keyword">in</span> use</span><br><span class="line">Current pager:stdout</span><br><span class="line">Using outfile:<span class="string">''</span></span><br><span class="line">Using delimiter:;</span><br><span class="line">Server:MariaDB</span><br><span class="line">Server version:5.5.60-MariaDB MariaDB Server</span><br><span class="line">Protocol version:10</span><br><span class="line">Connection:Localhost via UNIX socket</span><br><span class="line">Server characterset:latin1</span><br><span class="line">Db     characterset:latin1</span><br><span class="line">Client characterset:utf8</span><br><span class="line">Conn.  characterset:utf8</span><br><span class="line">UNIX socket:/var/lib/mysql/mysql.sock</span><br><span class="line">Uptime:1 min 5 sec</span><br><span class="line"></span><br><span class="line">Threads: 1  Questions: 9  Slow queries: 0  Opens: 0  Flush tables: 2  Open tables: 26  Queries per second avg: 0.138</span><br><span class="line"></span><br><span class="line">编辑配置文件</span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]  （服务端添加一行）</span><br><span class="line">character-set-server=utf8mb4</span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/my.cnf.d/mysql-clients.cnf </span></span><br><span class="line">[mysql]    （客户端添加）</span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart mariadb</span></span><br><span class="line"></span><br><span class="line">查看更改完的字符集</span><br><span class="line">MariaDB [(none)]&gt; status</span><br><span class="line">--------------</span><br><span class="line">mysql  Ver 15.1 Distrib 5.5.60-MariaDB, <span class="keyword">for</span> Linux (x86_64) using readline 5.1</span><br><span class="line"></span><br><span class="line">Connection id:2</span><br><span class="line">Current database:</span><br><span class="line">Current user:root@localhost</span><br><span class="line">SSL:Not <span class="keyword">in</span> use</span><br><span class="line">Current pager:stdout</span><br><span class="line">Using outfile:<span class="string">''</span></span><br><span class="line">Using delimiter:;</span><br><span class="line">Server:MariaDB</span><br><span class="line">Server version:5.5.60-MariaDB MariaDB Server</span><br><span class="line">Protocol version:10</span><br><span class="line">Connection:Localhost via UNIX socket</span><br><span class="line">Server characterset:utf8mb4</span><br><span class="line">Db     characterset:utf8mb4</span><br><span class="line">Client characterset:utf8mb4</span><br><span class="line">Conn.  characterset:utf8mb4</span><br><span class="line">UNIX socket:/var/lib/mysql/mysql.sock</span><br><span class="line">Uptime:42 sec</span><br><span class="line"></span><br><span class="line">Threads: 1  Questions: 5  Slow queries: 0  Opens: 0  Flush tables: 2  Open tables: 26  Queries per second avg: 0.119</span><br><span class="line"></span><br><span class="line">此时再次可以新创建一个数据库，添加新表，写入字段，添加纪录，则此时已经支持了汉字，创库之前就要统一编码机制</span><br><span class="line"></span><br><span class="line">备份时，系统用什么字符集，备份就用相同的字符集建议使用utf8mb4</span><br><span class="line"></span><br><span class="line">修改统一的字符集，并创建新表</span><br><span class="line">MariaDB [xinbiao2]&gt; create database db2;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [xinbiao2]&gt; show create database db2;</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                 |</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">| db2      | CREATE DATABASE `db2` /*!40100 DEFAULT CHARACTER SET utf8mb4 */ |</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [xinbiao2]&gt; use db2;</span><br><span class="line">Database changed</span><br><span class="line">MariaDB [db2]&gt; create table biao (id int,name char(3));</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [db2]&gt; show create table biao;</span><br><span class="line">+-------+--------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                             |</span><br><span class="line">+-------+--------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| biao  | CREATE TABLE `biao` (</span><br><span class="line">  `id` int(11) DEFAULT NULL,</span><br><span class="line">  `name` char(3) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------+--------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [db2]&gt; desc biao;</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">| Field | Type    | Null | Key | Default | Extra |</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11) | YES  |     | NULL    |       |</span><br><span class="line">| name  | char(3) | YES  |     | NULL    |       |</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">全部字段赋值</span><br><span class="line">MariaDB [db2]&gt; insert biao value(1,<span class="string">'星星'</span>);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [db2]&gt; select * from biao;</span><br><span class="line">+------+--------+</span><br><span class="line">| id   | name   |</span><br><span class="line">+------+--------+</span><br><span class="line">|    1 | 星星   |</span><br><span class="line">+------+--------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">已经支持汉字</span><br></pre></td></tr></table></figure><p>字符集：实例可以自己指定，表结构可以指定，字段可以指定（最好统一）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">查看以前创建的表的创建规则，生成一个新字符集的表</span><br><span class="line">MariaDB [db2]&gt; show create table studentdb.student;</span><br><span class="line"></span><br><span class="line">| student | CREATE TABLE `student` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(10) NOT NULL,</span><br><span class="line">  `sex` enum(<span class="string">'f'</span>,<span class="string">'m'</span>) DEFAULT <span class="string">'m'</span>,</span><br><span class="line">  `age` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">  `phone` char(11) DEFAULT NULL,</span><br><span class="line">  `address` varchar(50) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1 |</span><br><span class="line"></span><br><span class="line">仿照上一个的创建信息，创建一张新的表，默认的字符集为上面设置的。</span><br><span class="line"></span><br><span class="line">MariaDB [db2]&gt; CREATE TABLE `t2` (</span><br><span class="line">    -&gt;   `id` int(10) unsigned NOT NULL DEFAULT <span class="string">'0'</span>,</span><br><span class="line">    -&gt;   `name` varchar(10)  NOT NULL,</span><br><span class="line">    -&gt;   `sex` enum(<span class="string">'f'</span>,<span class="string">'m'</span>)  DEFAULT <span class="string">'m'</span>,</span><br><span class="line">    -&gt;   `age` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">    -&gt;   `mobile` char(11)  DEFAULT NULL,</span><br><span class="line">    -&gt;   `address` varchar(50)  DEFAULT NULL</span><br><span class="line">    -&gt; ) ENGINE=InnoDB;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">查看创建信息，在创建时未指定表结构，使用默认的表结构utf8mb4</span><br><span class="line">MariaDB [db2]&gt; show create table t2;</span><br><span class="line">| t2    | CREATE TABLE `t2` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL DEFAULT <span class="string">'0'</span>,</span><br><span class="line">  `name` varchar(10) NOT NULL,</span><br><span class="line">  `sex` enum(<span class="string">'f'</span>,<span class="string">'m'</span>) DEFAULT <span class="string">'m'</span>,</span><br><span class="line">  `age` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">  `mobile` char(11) DEFAULT NULL,</span><br><span class="line">  `address` varchar(50) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line"></span><br><span class="line">在表中插入记录，挑选字段插入</span><br><span class="line">MariaDB [db2]&gt; insert t2 (name,age,address) values(<span class="string">'代哲'</span>,21,<span class="string">'唐山'</span>);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [db2]&gt; select * from t2;</span><br><span class="line">+----+--------+------+------+--------+---------+</span><br><span class="line">| id | name   | sex  | age  | mobile | address |</span><br><span class="line">+----+--------+------+------+--------+---------+</span><br><span class="line">|  0 | 代哲   | m    |   21 | NULL   | 唐山    |</span><br><span class="line">+----+--------+------+------+--------+---------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><h2 id="DML-语言-删除-delete"><a href="#DML-语言-删除-delete" class="headerlink" title="DML 语言 删除 delete"></a>DML 语言 删除 delete</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">删库：drop database 库名</span><br><span class="line">删表：drop table 表名</span><br><span class="line">删除数据库中的表数据，但不删除表结构，而且不记录日志，效率高，慎用：truncate table 表</span><br><span class="line"></span><br><span class="line">全部删除表中所有内容：</span><br><span class="line">MariaDB [studentdb]&gt; delete from 表名;</span><br><span class="line">使用delete删除指定删除的条件，使用<span class="built_in">where</span>指定条件</span><br><span class="line"></span><br><span class="line">删除表中的单条记录</span><br><span class="line">  查看表中的内容</span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">| id | name    | sex  | age  | phone | address  |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">|  1 | mage    | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe  | m    |   20 | 10010 | tangshan |</span><br><span class="line">|  3 | laowang | m    |   18 | NULL  | tangshan |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">  删除表中的字段，需要定义查询条件</span><br><span class="line">  范例：删除id为3号和三号以后的字段</span><br><span class="line">MariaDB [studentdb]&gt; delete from student <span class="built_in">where</span> id &gt;= 3;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">高版本的数据库版本</span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 8</span><br><span class="line">Server version: 10.3.11-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; create database b1;</span><br><span class="line">Query OK, 1 row affected (0.001 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; use b1;</span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line">MariaDB [b1]&gt; create table t1(id int,name char(3));</span><br><span class="line">Query OK, 0 rows affected (0.007 sec)</span><br><span class="line"></span><br><span class="line">当在高版本的数据库中创建一个库，再创建一个表，查看数据库数据目录</span><br><span class="line">[root@centos7 ~]<span class="comment"># ls /var/lib/mysql/b1/</span></span><br><span class="line">db.opt  t1.frm  t1.ibd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">低版本的数据库</span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 4</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">当在低版本的数据库中创建一个库，再创建一个表，查看数据库数据目录</span><br><span class="line">[root@centos7 ~]<span class="comment"># ls /var/lib/mysql/studentdb/</span></span><br><span class="line">db.opt  student.frm  xinbiao1.frm  xinbiao.frm</span><br><span class="line">frm文件存放表结构</span><br><span class="line">缺少ibd文件，存放用户的数据，老版本的数据放置再</span><br><span class="line">/var/lib/mysql/ibdata1（所有数据库，以及所有表的数据放在这个文件中）</span><br><span class="line"></span><br><span class="line">可以再老版本中添加选项使得和新版本一样，使得每个数据单独放置</span><br><span class="line">   可以在数据库程序使用系统函数查看</span><br><span class="line">老版本为关闭状态</span><br><span class="line">MariaDB [(none)]&gt; show variables like <span class="string">'%per_table%'</span>;</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| Variable_name         | Value |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| innodb_file_per_table | OFF   |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">新版本为开启状态</span><br><span class="line">MariaDB [b1]&gt; show variables like <span class="string">'%per_table%'</span>;</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| Variable_name         | Value |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| innodb_file_per_table | ON    |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.002 sec)</span><br><span class="line"></span><br><span class="line">可以再老版本的配置文件中加以定义，添加一行，重启服务</span><br><span class="line">重启后，只有再次创建的新 表才会遵循此规则</span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">innodb_file_per_table</span><br></pre></td></tr></table></figure><h2 id="DML-语言-更改-update"><a href="#DML-语言-更改-update" class="headerlink" title="DML 语言 更改 update"></a>DML 语言 更改 update</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">update 进行数据更改时也要使用<span class="built_in">where</span>进行条件匹配</span><br><span class="line">如果不加条件匹配则修改所有的字段</span><br><span class="line"></span><br><span class="line">更改表内容</span><br><span class="line">  先查看下表内容</span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">| id | name    | sex  | age  | phone | address  |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">|  1 | mage    | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe  | m    |   20 | 10010 | tangshan |</span><br><span class="line">|  3 | laowang | m    |   18 | NULL  | tangshan |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">将一号的姓名进行更改</span><br><span class="line">MariaDB [studentdb]&gt; update student <span class="built_in">set</span> name=<span class="string">'aaaa'</span> <span class="built_in">where</span> id=1;</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">| id | name    | sex  | age  | phone | address  |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">|  1 | aaaa    | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe  | m    |   20 | 10010 | tangshan |</span><br><span class="line">|  3 | laowang | m    |   18 | NULL  | tangshan |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line"></span><br><span class="line">防止忘记使用<span class="built_in">where</span>条件判断语句，可以使用</span><br><span class="line">方法1：</span><br><span class="line">mysql选项： -U | --safe-updates </span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql -U</span></span><br><span class="line">MariaDB [studentdb]&gt; update student <span class="built_in">set</span> name=<span class="string">'aaaa'</span>;</span><br><span class="line">ERROR 1175 (HY000): You are using safe update mode and you tried to update a table without a WHERE that uses a KEY column</span><br><span class="line">提示说你使用的是安装更新模式</span><br><span class="line"></span><br><span class="line">方法2：</span><br><span class="line">可以修改配置文件，追加</span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/my.cnf.d/mysql-clients.cnf </span></span><br><span class="line">[mysql]</span><br><span class="line">safe-updates</span><br></pre></td></tr></table></figure><p>字符集更改<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">数据库级的更改</span><br><span class="line">alter database studentdb character <span class="built_in">set</span> utf8;</span><br><span class="line"></span><br><span class="line">表整个所有字段的字符集更改(仅能影响表中后增加的字段)</span><br><span class="line">alter table student character <span class="built_in">set</span> utf8;</span><br><span class="line"></span><br><span class="line">原来的字段想被修改</span><br><span class="line">alter table student chage 原字段name 新字段name varchar(20) character <span class="built_in">set</span> utf8;</span><br><span class="line"></span><br><span class="line">尽量设计表之前就要将客户端和服务端的字符集就要设计好，后期尽量不要修改</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;mysql之数据库DML语言&quot;&gt;&lt;a href=&quot;#mysql之数据库DML语言&quot; class=&quot;headerlink&quot; title=&quot;mysql之数据库DML语言&quot;&gt;&lt;/a&gt;mysql之数据库DML语言&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/mysql之数据库DML语言/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://daizhe.net.cn/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://daizhe.net.cn/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysql之select多表操作</title>
    <link href="https://daizhe.net.cn/2019/02/20/mysql%E4%B9%8Bselect%E5%A4%9A%E8%A1%A8%E6%93%8D%E4%BD%9C/"/>
    <id>https://daizhe.net.cn/2019/02/20/mysql之select多表操作/</id>
    <published>2019-02-20T06:46:48.143Z</published>
    <updated>2019-02-20T07:18:04.466Z</updated>
    
    <content type="html"><![CDATA[<h1 id="mysql之select多表操作"><a href="#mysql之select多表操作" class="headerlink" title="mysql之select多表操作"></a>mysql之select多表操作</h1><p><img src="/2019/02/20/mysql之select多表操作/标题.gif" alt=""><br><a id="more"></a></p><h2 id="DQL语句-select-查询"><a href="#DQL语句-select-查询" class="headerlink" title="DQL语句 select 查询"></a>DQL语句 select 查询</h2><p><img src="/2019/02/20/mysql之select多表操作/1.png" alt=""></p><p>范例中的两张表<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; show tables;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_hellodb |</span><br><span class="line">+-------------------+</span><br><span class="line">| students          |</span><br><span class="line">| teachers          |</span><br><span class="line">+-------------------+</span><br><span class="line"></span><br><span class="line">两张表组合查询：</span><br><span class="line">两种情况：两张表纵向合并，和两张表横向合并</span><br><span class="line">纵向合并：前提是字段相同，如果不同，可以挑选出相同的字段来显示</span><br><span class="line">横向合并：笛卡尔乘积:交叉连接：cross join:互相两张表互相每条记录组合一变</span><br></pre></td></tr></table></figure></p><p><code>纵向合并</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">首先查看两张表的字段信息</span><br><span class="line">学生表</span><br><span class="line">MariaDB [hellodb]&gt; select * from students;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |       4 |         4 |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |       3 |         1 |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">讲师表</span><br><span class="line">MariaDB [hellodb]&gt; select * from teachers</span><br><span class="line">    -&gt; ;</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">| TID | Name          | Age | Gender |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">|   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">如果纵向显示可以挑选出字段想多的信息来显示</span><br><span class="line">挑选学生表的字段</span><br><span class="line">MariaDB [hellodb]&gt; select stuid,name,age,gender from students;</span><br><span class="line">+-------+---------------+-----+--------+</span><br><span class="line">| stuid | name          | age | gender |</span><br><span class="line">+-------+---------------+-----+--------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |</span><br><span class="line">........</span><br><span class="line"></span><br><span class="line">已经挑选了相同的字段，现在进行两表纵向合并显示</span><br><span class="line">关键字union合并显示、联合（并非真实的合并，仅仅是显示结果的合并）</span><br><span class="line">字段的标题是由前面定义的显示的字段决定的，显示结果如下，如果想定义自己想看到的字段，可以在前面匹配第一张表显示的字段上加以别名显示</span><br><span class="line">MariaDB [hellodb]&gt; select stuid,name,age,gender from students</span><br><span class="line">    -&gt; union</span><br><span class="line">    -&gt; select * from teachers;</span><br><span class="line">+-------+---------------+-----+--------+</span><br><span class="line">| stuid | name          | age | gender |</span><br><span class="line">+-------+---------------+-----+--------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |</span><br><span class="line">|     1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-------+---------------+-----+--------+</span><br><span class="line"></span><br><span class="line">挑选两张表相同的字段来显示</span><br><span class="line">MariaDB [hellodb]&gt; select stuid,name from students union select tid,name from teachers;</span><br><span class="line">+-------+---------------+</span><br><span class="line">| stuid | name          |</span><br><span class="line">+-------+---------------+</span><br><span class="line">|     1 | Shi Zhongyu   |</span><br><span class="line">|     2 | Shi Potian    |</span><br><span class="line">|     3 | Xie Yanke     |</span><br><span class="line">|     4 | Ding Dian     |</span><br><span class="line">|     5 | Yu Yutong     |</span><br><span class="line">|     6 | Shi Qing      |</span><br><span class="line">|     7 | Xi Ren        |</span><br><span class="line">|     8 | Lin Daiyu     |</span><br><span class="line">|     9 | Ren Yingying  |</span><br><span class="line">|    10 | Yue Lingshan  |</span><br><span class="line">|    11 | Yuan Chengzhi |</span><br><span class="line">|    12 | Wen Qingqing  |</span><br><span class="line">|    13 | Tian Boguang  |</span><br><span class="line">|    14 | Lu Wushuang   |</span><br><span class="line">|    15 | Duan Yu       |</span><br><span class="line">|    16 | Xu Zhu        |</span><br><span class="line">|    17 | Lin Chong     |</span><br><span class="line">|    18 | Hua Rong      |</span><br><span class="line">|    19 | Xue Baochai   |</span><br><span class="line">|    20 | Diao Chan     |</span><br><span class="line">|    21 | Huang Yueying |</span><br><span class="line">|    22 | Xiao Qiao     |</span><br><span class="line">|    23 | Ma Chao       |</span><br><span class="line">|    24 | Xu Xian       |</span><br><span class="line">|    25 | Sun Dasheng   |</span><br><span class="line">|     1 | Song Jiang    |</span><br><span class="line">|     2 | Zhang Sanfeng |</span><br><span class="line">|     3 | Miejue Shitai |</span><br><span class="line">|     4 | Lin Chaoying  |</span><br><span class="line">+-------+---------------+</span><br><span class="line">29 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">显示自己想要显示的字段，加以别名显示</span><br><span class="line">MariaDB [hellodb]&gt; select stuid as 编号,name as 名字 from students union select tid,name from teachers;</span><br><span class="line">+--------+---------------+</span><br><span class="line">| 编号   | 名字          |</span><br><span class="line">+--------+---------------+</span><br><span class="line">|      1 | Shi Zhongyu   |</span><br><span class="line">|      2 | Shi Potian    |</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">如果两张表合并时，显示的字段相同，且有相同的记录信息，则不仅显示一条，因为select语句有重复的记录，union会去重</span><br><span class="line"></span><br><span class="line">去重小技巧：将同一个表中的相同字段去重</span><br><span class="line">方法1：自己和自己合并去重</span><br><span class="line">select * from 表 union select * from 表</span><br><span class="line">方法2：使用distinct,取唯一值</span><br><span class="line">select distinct * from 表</span><br></pre></td></tr></table></figure></p><p><code>横向合并</code>cross join<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">cross join 横向合并：笛卡尔乘积</span><br><span class="line">MariaDB [hellodb]&gt; select * from students cross join teachers;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID | TID | Name          | Age | Gender |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |       4 |         4 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |       4 |         4 |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |       4 |         4 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |       4 |         4 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |       3 |         1 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |       3 |         1 |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |       3 |         1 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |       3 |         1 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">100 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">意义不大：生产一般不用</span><br></pre></td></tr></table></figure></p><p><img src="/2019/02/20/mysql之select多表操作/1.png" alt=""><br><code>两表交集内连接</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">先查看两表的记录</span><br><span class="line">  学生表</span><br><span class="line">MariaDB [hellodb]&gt; select * from students;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |       4 |         4 |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |       3 |         1 |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">25 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">  讲师表</span><br><span class="line">MariaDB [hellodb]&gt; select * from teachers;</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">| TID | Name          | Age | Gender |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">|   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">学生表中的TeacherID和讲师表中的TID，可以作为交集的相等记录</span><br><span class="line">语法1：</span><br><span class="line">MariaDB [hellodb]&gt; select * from students,teachers <span class="built_in">where</span> students.teacherid=teachers.tid;</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">| StuID | Name        | Age | Gender | ClassID | TeacherID | TID | Name          | Age | Gender |</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">|     5 | Yu Yutong   |  26 | M      |       3 |         1 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     1 | Shi Zhongyu |  22 | M      |       2 |         3 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     4 | Ding Dian   |  32 | M      |       4 |         4 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">语法2：内连接inner join ..on</span><br><span class="line">MariaDB [hellodb]&gt; select * from students inner join teachers on students.teacherid=teachers.tid;</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">| StuID | Name        | Age | Gender | ClassID | TeacherID | TID | Name          | Age | Gender |</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">|     5 | Yu Yutong   |  26 | M      |       3 |         1 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    25 | Sun Dasheng | 100 | M      |    NULL |         1 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     1 | Shi Zhongyu |  22 | M      |       2 |         3 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     4 | Ding Dian   |  32 | M      |       4 |         4 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line">可以将内连接后的查询结果再次进行查询</span><br><span class="line">（name 在此句中出现了两次，要指定表名）</span><br><span class="line">MariaDB [hellodb]&gt; select stuid,students.name,tid,teachers.name from students inner join teachers on students.teacherid=teachers.tid;</span><br><span class="line">+-------+-------------+-----+---------------+</span><br><span class="line">| stuid | name        | tid | name          |</span><br><span class="line">+-------+-------------+-----+---------------+</span><br><span class="line">|     5 | Yu Yutong   |   1 | Song Jiang    |</span><br><span class="line">|    25 | Sun Dasheng |   1 | Song Jiang    |</span><br><span class="line">|     1 | Shi Zhongyu |   3 | Miejue Shitai |</span><br><span class="line">|     4 | Ding Dian   |   4 | Lin Chaoying  |</span><br><span class="line">+-------+-------------+-----+---------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">此时虽然已经查询到了，但是为了区分name的含义，可以考虑添加别名</span><br><span class="line">MariaDB [hellodb]&gt; select stuid,students.name as 学生姓名,tid,teachers.name as 老师名字 from students inner join teachers on students.teacherid=teachers.tid;</span><br><span class="line">+-------+--------------+-----+---------------+</span><br><span class="line">| stuid | 学生姓名     | tid | 老师名字      |</span><br><span class="line">+-------+--------------+-----+---------------+</span><br><span class="line">|     5 | Yu Yutong    |   1 | Song Jiang    |</span><br><span class="line">|    25 | Sun Dasheng  |   1 | Song Jiang    |</span><br><span class="line">|     1 | Shi Zhongyu  |   3 | Miejue Shitai |</span><br><span class="line">|     4 | Ding Dian    |   4 | Lin Chaoying  |</span><br><span class="line">+-------+--------------+-----+---------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">为了简化也可以给表起别名</span><br><span class="line">MariaDB [hellodb]&gt; select stuid,s.name as student_name,tid,t.name teacher_name from students as s inner join teachers t on s.teacherid=t.tid;</span><br><span class="line">+-------+--------------+-----+---------------+</span><br><span class="line">| stuid | student_name | tid | teacher_name  |</span><br><span class="line">+-------+--------------+-----+---------------+</span><br><span class="line">|     5 | Yu Yutong    |   1 | Song Jiang    |</span><br><span class="line">|    25 | Sun Dasheng  |   1 | Song Jiang    |</span><br><span class="line">|     1 | Shi Zhongyu  |   3 | Miejue Shitai |</span><br><span class="line">|     4 | Ding Dian    |   4 | Lin Chaoying  |</span><br><span class="line">+-------+--------------+-----+---------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><code>取a表的所有记录，b表取于a表相同条件的记录 外连接</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">左外连接</span><br><span class="line">left outer join </span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; select * from students as s left outer join teachers t on s.teacherid=t.tid;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+------+---------------+------+--------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID | TID  | Name          | Age  | Gender |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+------+---------------+------+--------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |    3 | Miejue Shitai |   77 | F      |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |       4 |         4 |    4 | Lin Chaoying  |   93 | F      |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |       3 |         1 |    1 | Song Jiang    |   45 | M      |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |         1 |    1 | Song Jiang    |   45 | M      |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+------+---------------+------+--------+</span><br><span class="line">25 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">右外链接</span><br><span class="line">right outer join</span><br><span class="line">MariaDB [hellodb]&gt; select * from students as s right outer join teachers t on s.teacherid=t.tid;</span><br><span class="line">+-------+-------------+------+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">| StuID | Name        | Age  | Gender | ClassID | TeacherID | TID | Name          | Age | Gender |</span><br><span class="line">+-------+-------------+------+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">|     1 | Shi Zhongyu |   22 | M      |       2 |         3 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     4 | Ding Dian   |   32 | M      |       4 |         4 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     5 | Yu Yutong   |   26 | M      |       3 |         1 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    25 | Sun Dasheng |  100 | M      |    NULL |         1 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|  NULL | NULL        | NULL | NULL   |    NULL |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">+-------+-------------+------+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">左外连接和右外连接 ，表的左右顺序很重要</span><br></pre></td></tr></table></figure></p><p><code>左外连接 变种：排除交集和b表</code>将右边的表全部不显示，仅显示a表中和b表不相同的记录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; select * from students as s left outer join teachers t on s.teacherid=t.tid <span class="built_in">where</span> t.tid is null;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+------+------+------+--------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID | TID  | Name | Age  | Gender |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+------+------+------+--------+</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 | NULL | NULL | NULL | NULL   |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 | NULL | NULL | NULL | NULL   |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+------+------+------+--------+</span><br><span class="line">21 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line">右外连接的 变种</span><br><span class="line">MariaDB [hellodb]&gt; select * from students as s right outer join teachers t on s.teacherid=t.tid <span class="built_in">where</span> s.teacherid is null;</span><br><span class="line">+-------+------+------+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">| StuID | Name | Age  | Gender | ClassID | TeacherID | TID | Name          | Age | Gender |</span><br><span class="line">+-------+------+------+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">|  NULL | NULL | NULL | NULL   |    NULL |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">+-------+------+------+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><h2 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h2><p>查询语句中嵌入另外的语句查询<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">范例：查询老师年龄大于学生平均年龄的老师列表</span><br><span class="line">  查询学生的平均年龄</span><br><span class="line">MariaDB [hellodb]&gt; select avg(age) from students;</span><br><span class="line">+----------+</span><br><span class="line">| avg(age) |</span><br><span class="line">+----------+</span><br><span class="line">|  27.4000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看老师的表</span><br><span class="line">MariaDB [hellodb]&gt; select * from teachers;</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">| TID | Name          | Age | Gender |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">|   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">查询老师年龄大于学生平均年龄的老师列表</span><br><span class="line">MariaDB [hellodb]&gt; select * from teachers <span class="built_in">where</span> age &gt; (select avg(age) from students);</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">| TID | Name          | Age | Gender |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">|   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><code>完全外连接</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">full outer join</span><br><span class="line"></span><br><span class="line">mysql数据库不支持</span><br><span class="line"></span><br><span class="line">变相逻辑实现</span><br><span class="line">使用左外连接和右外连接实现</span><br><span class="line">MariaDB [hellodb]&gt; select * from students as s left outer join teachers t on s.teacherid=t.tid</span><br><span class="line">    -&gt; union</span><br><span class="line">    -&gt; select * from students as s right outer join teachers t on s.teacherid=t.tid;</span><br><span class="line">+-------+---------------+------+--------+---------+-----------+------+---------------+------+--------+</span><br><span class="line">| StuID | Name          | Age  | Gender | ClassID | TeacherID | TID  | Name          | Age  | Gender |</span><br><span class="line">+-------+---------------+------+--------+---------+-----------+------+---------------+------+--------+</span><br><span class="line">|     1 | Shi Zhongyu   |   22 | M      |       2 |         3 |    3 | Miejue Shitai |   77 | F      |</span><br><span class="line">|     2 | Shi Potian    |   22 | M      |       1 |         7 | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     3 | Xie Yanke     |   53 | M      |       2 |        16 | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     4 | Ding Dian     |   32 | M      |       4 |         4 |    4 | Lin Chaoying  |   93 | F      |</span><br><span class="line">|     5 | Yu Yutong     |   26 | M      |       3 |         1 |    1 | Song Jiang    |   45 | M      |</span><br><span class="line">|     6 | Shi Qing      |   46 | M      |       5 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     7 | Xi Ren        |   19 | F      |       3 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     8 | Lin Daiyu     |   17 | F      |       7 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     9 | Ren Yingying  |   20 | F      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    10 | Yue Lingshan  |   19 | F      |       3 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    11 | Yuan Chengzhi |   23 | M      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    12 | Wen Qingqing  |   19 | F      |       1 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    13 | Tian Boguang  |   33 | M      |       2 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    14 | Lu Wushuang   |   17 | F      |       3 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    15 | Duan Yu       |   19 | M      |       4 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    16 | Xu Zhu        |   21 | M      |       1 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    17 | Lin Chong     |   25 | M      |       4 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    18 | Hua Rong      |   23 | M      |       7 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    19 | Xue Baochai   |   18 | F      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    20 | Diao Chan     |   19 | F      |       7 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    21 | Huang Yueying |   22 | F      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    22 | Xiao Qiao     |   20 | F      |       1 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    23 | Ma Chao       |   23 | M      |       4 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    24 | Xu Xian       |   27 | M      |    NULL |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    25 | Sun Dasheng   |  100 | M      |    NULL |         1 |    1 | Song Jiang    |   45 | M      |</span><br><span class="line">|  NULL | NULL          | NULL | NULL   |    NULL |      NULL |    2 | Zhang Sanfeng |   94 | M      |</span><br><span class="line">+-------+---------------+------+--------+---------+-----------+------+---------------+------+--------+</span><br><span class="line">26 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>仅去除交集:两个都有的去除<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; select * from  (select stuid,s.name as student_name,s.age as student_age,s.gender as student_gender ,classid,teacherid,tid,t.name as teacher_name,t.age as teacher_age,t.gender as teacher_gedner </span><br><span class="line">    -&gt; from students as s  left outer join teachers  t on  s.teacherid=t.tid  </span><br><span class="line">    -&gt; union  </span><br><span class="line">    -&gt; select stuid,s.name,s.age,s.gender,classid,teacherid,tid,t.name,t.age,t.gender </span><br><span class="line">    -&gt; from students as s right outer join teachers  t on  s.teacherid=t.tid) </span><br><span class="line">    -&gt; as f  <span class="built_in">where</span> f.teacherid is null or f.tid is null;</span><br><span class="line">+-------+---------------+-------------+----------------+---------+-----------+------+---------------+-------------+----------------+</span><br><span class="line">| stuid | student_name  | student_age | student_gender | classid | teacherid | tid  | teacher_name  | teacher_age | teacher_gedner |</span><br><span class="line">+-------+---------------+-------------+----------------+---------+-----------+------+---------------+-------------+----------------+</span><br><span class="line">|     2 | Shi Potian    |          22 | M              |       1 |         7 | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|     3 | Xie Yanke     |          53 | M              |       2 |        16 | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|     6 | Shi Qing      |          46 | M              |       5 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|     7 | Xi Ren        |          19 | F              |       3 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|     8 | Lin Daiyu     |          17 | F              |       7 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|     9 | Ren Yingying  |          20 | F              |       6 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    10 | Yue Lingshan  |          19 | F              |       3 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    11 | Yuan Chengzhi |          23 | M              |       6 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    12 | Wen Qingqing  |          19 | F              |       1 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    13 | Tian Boguang  |          33 | M              |       2 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    14 | Lu Wushuang   |          17 | F              |       3 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    15 | Duan Yu       |          19 | M              |       4 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    16 | Xu Zhu        |          21 | M              |       1 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    17 | Lin Chong     |          25 | M              |       4 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    18 | Hua Rong      |          23 | M              |       7 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    19 | Xue Baochai   |          18 | F              |       6 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    20 | Diao Chan     |          19 | F              |       7 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    21 | Huang Yueying |          22 | F              |       6 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    22 | Xiao Qiao     |          20 | F              |       1 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    23 | Ma Chao       |          23 | M              |       4 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    24 | Xu Xian       |          27 | M              |    NULL |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|  NULL | NULL          |        NULL | NULL           |    NULL |      NULL |    2 | Zhang Sanfeng |          94 | M              |</span><br><span class="line">+-------+---------------+-------------+----------------+---------+-----------+------+---------------+-------------+----------------+</span><br><span class="line">22 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>定义的char(3) 是三个字符的意思，非字节</p><p>不同的字符所占的字节是不同的。</p><p>ASCII码：</p><p>一个英文字母（不分大小写）占一个字节的空间，一个中文汉字占两个字节的空间。一个二进制数字序列，在计算机中作为一个数字单元，一般为8位二进制数，换算为十进制。最小值0，最大值255。如一个ASCII码就是一个字节。</p><p>UTF-8编码：</p><p>一个英文字符等于一个字节，一个中文（含繁体）等于三个字节。</p><p>Unicode编码：</p><p>一个英文等于两个字节，一个中文（含繁体）等于两个字节。</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;mysql之select多表操作&quot;&gt;&lt;a href=&quot;#mysql之select多表操作&quot; class=&quot;headerlink&quot; title=&quot;mysql之select多表操作&quot;&gt;&lt;/a&gt;mysql之select多表操作&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/mysql之select多表操作/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://daizhe.net.cn/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://daizhe.net.cn/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysql之select单表操作</title>
    <link href="https://daizhe.net.cn/2019/02/20/mysql%E4%B9%8Bselect%E5%8D%95%E8%A1%A8%E6%93%8D%E4%BD%9C/"/>
    <id>https://daizhe.net.cn/2019/02/20/mysql之select单表操作/</id>
    <published>2019-02-20T06:45:14.673Z</published>
    <updated>2019-02-20T07:18:11.906Z</updated>
    
    <content type="html"><![CDATA[<h1 id="mysql之select单表操作"><a href="#mysql之select单表操作" class="headerlink" title="mysql之select单表操作"></a>mysql之select单表操作</h1><p><img src="/2019/02/20/mysql之select单表操作/标题.gif" alt=""><br><a id="more"></a></p><h2 id="DQL语句-select-查询"><a href="#DQL语句-select-查询" class="headerlink" title="DQL语句 select 查询"></a>DQL语句 select 查询</h2><p><code>挑选字段来显示</code><br>列的过滤<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">查询所有的字段信息：代表从student这个表中查询所有字段</span><br><span class="line">select * from student;</span><br><span class="line"></span><br><span class="line">挑选字段显示（定义显示的顺序由自己定义）</span><br><span class="line">MariaDB [studentdb]&gt; select id,name,age from student;</span><br><span class="line">+----+---------+------+</span><br><span class="line">| id | name    | age  |</span><br><span class="line">+----+---------+------+</span><br><span class="line">|  1 | aaaa    |   30 |</span><br><span class="line">|  2 | daizhe  |   20 |</span><br><span class="line">|  3 | laowang |   18 |</span><br><span class="line">+----+---------+------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">将显示的字段名称加以别名：此场景适用于挑选的字段过长，或者将字母转换为中文显示</span><br><span class="line">MariaDB [studentdb]&gt; select name as 姓名,age from student;</span><br><span class="line">+---------+------+</span><br><span class="line">| 姓名    | age  |</span><br><span class="line">+---------+------+</span><br><span class="line">| aaaa    |   30 |</span><br><span class="line">| daizhe  |   20 |</span><br><span class="line">| laowang |   18 |</span><br><span class="line">+---------+------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure></p><p><code>挑选特定的行来显示</code><br>行的过滤<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">范例：查看年龄为25岁以上的学员信息</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> age &gt; 25;</span><br><span class="line">+----+------+------+------+-------+---------+</span><br><span class="line">| id | name | sex  | age  | phone | address |</span><br><span class="line">+----+------+------+------+-------+---------+</span><br><span class="line">|  1 | aaaa | m    |   30 | 10086 | beijing |</span><br><span class="line">+----+------+------+------+-------+---------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">范例：查看年龄大于等于25 小于等于28</span><br><span class="line">方法1：</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> age &gt;= 25 and age &lt;= 28;</span><br><span class="line">方法2：between 在什么之间</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> age between 25 and 28;</span><br><span class="line"></span><br><span class="line">范例：查询年龄等于20 和等于30的人</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> age <span class="keyword">in</span> (20,30);</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">| id | name   | sex  | age  | phone | address  |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">|  1 | aaaa   | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe | m    |   20 | 10010 | tangshan |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">范例：查询班级表中手机号未知的人</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> phone is null;</span><br><span class="line"></span><br><span class="line">范例：查询班级手机号不为空的人</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> phone is not null;</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">| id | name   | sex  | age  | phone | address  |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">|  1 | aaaa   | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe | m    |   20 | 10010 | tangshan |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br></pre></td></tr></table></figure></p><p><code>模糊匹配</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">范例：包含a字母的人的姓名</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> name like <span class="string">'%a%'</span>;</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">| id | name    | sex  | age  | phone | address  |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">|  1 | aaaa    | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe  | m    |   20 | 10010 | tangshan |</span><br><span class="line">|  3 | laowang | m    |   18 | NULL  | tangshan |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">范例：以a开头的人的姓名</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> name like <span class="string">'a%'</span>;</span><br></pre></td></tr></table></figure></p><p><code>正则表达式</code>rlike:正则表达式，索引失效，不建议使用<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">范例：使用正则表达式，匹配以a开头的人姓名</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> name rlike <span class="string">'^a'</span>;</span><br><span class="line">+----+------+------+------+-------+---------+</span><br><span class="line">| id | name | sex  | age  | phone | address |</span><br><span class="line">+----+------+------+------+-------+---------+</span><br><span class="line">|  1 | aaaa | m    |   30 | 10086 | beijing |</span><br><span class="line">+----+------+------+------+-------+---------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>如果执行结果由报警<br>可以执行show warnings; 查看报警信息  </p><p><code>去重distinct</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">范例：显示所有的性别，但不显示重复的性别信息</span><br><span class="line">MariaDB [studentdb]&gt; select distinct sex from student;</span><br><span class="line">+------+</span><br><span class="line">| sex  |</span><br><span class="line">+------+</span><br><span class="line">| m    |</span><br><span class="line">+------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>范例：将范例数据信息导入数据库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mysql &lt; hellodb_innodb.sql </span></span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| hellodb            |</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; show tables;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_hellodb |</span><br><span class="line">+-------------------+</span><br><span class="line">| classes           |</span><br><span class="line">| coc               |</span><br><span class="line">| courses           |</span><br><span class="line">| scores            |</span><br><span class="line">| students          |</span><br><span class="line">| teachers          |</span><br><span class="line">| toc               |</span><br><span class="line">+-------------------+</span><br></pre></td></tr></table></figure></p><p><code>group分组</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">范例：统计一下班内所有的男生的平均年龄和女生的平均年龄</span><br><span class="line">  按性别分组</span><br><span class="line"></span><br><span class="line">  显示整个表有多少条记录</span><br><span class="line">MariaDB [hellodb]&gt; select count(*) from students;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|       25 |</span><br><span class="line">+----------+</span><br><span class="line">  </span><br><span class="line">  按性别统计男生的个数和女生的个数 (gender是字段性别的意思)</span><br><span class="line">MariaDB [hellodb]&gt; select gender as 性别,count(*) as 人数 from students group by gender;</span><br><span class="line">+--------+--------+</span><br><span class="line">| 性别   | 人数   |</span><br><span class="line">+--------+--------+</span><br><span class="line">| F      |     10 |</span><br><span class="line">| M      |     15 |</span><br><span class="line">+--------+--------+</span><br><span class="line"></span><br><span class="line">统计平均年龄：函数 avg</span><br><span class="line">MariaDB [hellodb]&gt; select gender,avg(age) from students group by gender;+--------+----------+</span><br><span class="line">| gender | avg(age) |</span><br><span class="line">+--------+----------+</span><br><span class="line">| F      |  19.0000 |</span><br><span class="line">| M      |  33.0000 |</span><br><span class="line">+--------+----------+</span><br><span class="line"></span><br><span class="line">注意：后面 跟了group by 子句 ，在select 后面仅能出现两种内容，分组字段本身和聚合函数</span><br></pre></td></tr></table></figure></p><p><code>having</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">仅统计男生的平均年龄（在group by 后面加条件不能使用<span class="built_in">where</span> 要使用having 来判断条件）</span><br><span class="line">  先分组再过滤（先分完组再进行过滤）</span><br><span class="line">MariaDB [hellodb]&gt; select gender,avg(age) from students group by gender having gender = <span class="string">'M'</span>;</span><br><span class="line">+--------+----------+</span><br><span class="line">| gender | avg(age) |</span><br><span class="line">+--------+----------+</span><br><span class="line">| M      |  33.0000 |</span><br><span class="line">+--------+----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">  先过滤再分组(从过滤出的结果中再分组)</span><br><span class="line">MariaDB [hellodb]&gt; select gender,avg(age) from students <span class="built_in">where</span> gender= <span class="string">'M'</span> group by gender;</span><br><span class="line">+--------+----------+</span><br><span class="line">| gender | avg(age) |</span><br><span class="line">+--------+----------+</span><br><span class="line">| M      |  33.0000 |</span><br><span class="line">+--------+----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><code>多次分组</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">范例：针对不同性别不班级分别统计，每个班不同性别的最大年龄</span><br><span class="line">比如：一般的男生最大年龄，一般的女生的最大年龄，二班的男生的最大年龄和最大女生的年龄...</span><br><span class="line"></span><br><span class="line">max（）函数</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; select classid,gender,max(age) from students group by classid,gender;</span><br><span class="line">+---------+--------+----------+</span><br><span class="line">| classid | gender | max(age) |</span><br><span class="line">+---------+--------+----------+</span><br><span class="line">|    NULL | M      |      100 |</span><br><span class="line">|       1 | F      |       20 |</span><br><span class="line">|       1 | M      |       22 |</span><br><span class="line">|       2 | M      |       53 |</span><br><span class="line">|       3 | F      |       19 |</span><br><span class="line">|       3 | M      |       26 |</span><br><span class="line">|       4 | M      |       32 |</span><br><span class="line">|       5 | M      |       46 |</span><br><span class="line">|       6 | F      |       22 |</span><br><span class="line">|       6 | M      |       23 |</span><br><span class="line">|       7 | F      |       19 |</span><br><span class="line">|       7 | M      |       23 |</span><br><span class="line">+---------+--------+----------+</span><br></pre></td></tr></table></figure></p><p><code>order by根据指定的字段对查询结果进行排序</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">排序：默认为从小到大排序</span><br><span class="line">范例：拿学生的年龄进行排序</span><br><span class="line">MariaDB [hellodb]&gt; select * from students order by age;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |</span><br><span class="line"></span><br><span class="line">倒序排：从大到小排序</span><br><span class="line">MariaDB [hellodb]&gt; select * from students order by age desc;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |</span><br><span class="line"></span><br><span class="line">排序完可以查看年龄最小的3个</span><br><span class="line">MariaDB [hellodb]&gt; select * from students order by age <span class="built_in">limit</span> 3;</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name        | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+</span><br><span class="line">|     8 | Lin Daiyu   |  17 | F      |       7 |      NULL |</span><br><span class="line">|    14 | Lu Wushuang |  17 | F      |       3 |      NULL |</span><br><span class="line">|    19 | Xue Baochai |  18 | F      |       6 |      NULL |</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+</span><br><span class="line"></span><br><span class="line">跳过前第3个取后续4个</span><br><span class="line">ariaDB [hellodb]&gt; select * from students order by age <span class="built_in">limit</span> 3,4;</span><br><span class="line">+-------+--------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name         | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+--------------+-----+--------+---------+-----------+</span><br><span class="line">|    12 | Wen Qingqing |  19 | F      |       1 |      NULL |</span><br><span class="line">|    10 | Yue Lingshan |  19 | F      |       3 |      NULL |</span><br><span class="line">|     7 | Xi Ren       |  19 | F      |       3 |      NULL |</span><br><span class="line">|    15 | Duan Yu      |  19 | M      |       4 |      NULL |</span><br><span class="line">+-------+--------------+-----+--------+---------+-----------+</span><br></pre></td></tr></table></figure></p><p><code>多列排序</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">范例：先按班级排序，如果同一个班，再班级相同的情况下，在对年龄排序（班级为正序，年龄为倒序）</span><br><span class="line">MariaDB [hellodb]&gt; select * from students order by classid ,age desc;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |</span><br><span class="line"></span><br><span class="line"> 空值的优先级高，可以使得null值，放到最后</span><br><span class="line">MariaDB [hellodb]&gt; select * from students order by -classid desc;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |</span><br><span class="line">.......</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br></pre></td></tr></table></figure></p><p>练习：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">(2) 以ClassID为分组依据，显示每组的平均年龄 </span><br><span class="line">(3) 显示第2题中平均年龄大于30的分组及平均年龄 </span><br><span class="line">MariaDB [hellodb]&gt; select classid,avg(age) from students group by classd having avg(age) &gt; 30;</span><br><span class="line">+---------+----------+</span><br><span class="line">| classid | avg(age) |</span><br><span class="line">+---------+----------+</span><br><span class="line">|    NULL |  63.5000 |</span><br><span class="line">|       2 |  36.0000 |</span><br><span class="line">|       5 |  46.0000 |</span><br><span class="line">+---------+----------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">(7) 查询年龄大于等于20岁，小于等于25岁的同学的信</span><br><span class="line">方法1：</span><br><span class="line">MariaDB [hellodb]&gt; select * from students <span class="built_in">where</span> age between 20 and 25;+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |</span><br><span class="line"></span><br><span class="line">方法2：</span><br><span class="line">MariaDB [hellodb]&gt; select * from students <span class="built_in">where</span> age &gt;=20 and age &lt;=25;+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;mysql之select单表操作&quot;&gt;&lt;a href=&quot;#mysql之select单表操作&quot; class=&quot;headerlink&quot; title=&quot;mysql之select单表操作&quot;&gt;&lt;/a&gt;mysql之select单表操作&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/mysql之select单表操作/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://daizhe.net.cn/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://daizhe.net.cn/tags/mysql/"/>
    
  </entry>
  
</feed>
