<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Dai zhe&#39;s notes</title>
  
  <subtitle>Just Du It</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://9527dz.top/"/>
  <updated>2018-12-25T06:18:34.726Z</updated>
  <id>https://9527dz.top/</id>
  
  <author>
    <name>唐憎洗发</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>kvm虚拟机基础应用</title>
    <link href="https://9527dz.top/2018/12/25/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/"/>
    <id>https://9527dz.top/2018/12/25/kvm虚拟机基础应用/</id>
    <published>2018-12-25T03:28:26.046Z</published>
    <updated>2018-12-25T06:18:34.726Z</updated>
    
    <content type="html"><![CDATA[<h1 id="kvm虚拟机基础应用"><a href="#kvm虚拟机基础应用" class="headerlink" title="kvm虚拟机基础应用"></a>kvm虚拟机基础应用</h1><p><img src="/2018/12/25/kvm虚拟机基础应用/kvm.png" alt=""><br><a id="more"></a></p><ul><li>kvm: Kernel-based Virtual Machine  <ul><li>Qumranet公司 –&gt; RedHat  <ul><li>(1) X86_64  </li><li>(2) HVM:   <ul><li>Intel VT  </li><li>AMD AMD-v  </li></ul></li></ul></li></ul></li></ul><p><img src="/2018/12/25/kvm虚拟机基础应用/kvm1.png" alt=""><br><img src="/2018/12/25/kvm虚拟机基础应用/kvm管理工具.png" alt="">  </p><ul><li><p>KVM的组件：</p><ul><li>两类组件：<ul><li>(kvm.ko)/dev/kvm：工作为hypervisor，在用户空间可通过系统调用ioctl()与内核中的kvm模块交互，从而完成虚拟机的创建、启动、停止、删除等各种管理功能；</li><li>qemu-kvm进程：工作于用户空间，用于实现IO设备模拟；用于实现一个虚拟机实例；</li></ul></li></ul></li><li><p>KVM模块load进内存之后，系统的运行模式：</p><ul><li>内核模式：GuestOS执行IO类的操作时，或其它的特殊指令操作时的模式；它也被称为“Guest-Kernel”模式；<pre><code>用户模式：Host OS的用户空间，用于代为GuestOS发出IO请求；来宾模式：GuestOS的用户模式；所有的非IO类请求；</code></pre></li></ul></li><li><p>运行中的一个kvm虚拟机就是一个qemu-kvm进程，运行qemu-kvm程序并传递给它合适的选项及参数即能完成虚拟机启动，终止此进程即能关闭虚拟机；</p></li></ul><h2 id="安装使用KVM"><a href="#安装使用KVM" class="headerlink" title="安装使用KVM"></a>安装使用KVM</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br></pre></td><td class="code"><pre><span class="line">安装kvm的主机上：</span><br><span class="line"></span><br><span class="line">判断CPU是否支持硬件虚拟化：</span><br><span class="line">[root@centos7 ~]<span class="comment"># grep -i -E '(vmx|svm|lm)' /proc/cpuinfo</span></span><br><span class="line">    cpu型号：</span><br><span class="line">    vmx：Intel VT-x</span><br><span class="line">    svm：AMD AMD-v</span><br><span class="line">    lm:64位cpu</span><br><span class="line"></span><br><span class="line">加载kvm模块使得内核支持kvm,并判断是否成功加载此模块</span><br><span class="line">  [root@centos7 ~]<span class="comment"># modprobe kvm</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># lsmod | grep kvm</span></span><br><span class="line">  kvm_intel             174841  0 </span><br><span class="line">  kvm                   578518  1 kvm_intel</span><br><span class="line">  irqbypass              13503  1 kvm</span><br><span class="line">  [root@centos7 ~]<span class="comment"># file /dev/kvm （字符设备）</span></span><br><span class="line">  /dev/kvm: character special</span><br><span class="line"></span><br><span class="line">安装qemu-kvm,使用户空间具有控制工具</span><br><span class="line">  [root@centos7 ~]<span class="comment"># yum install qemu-kvm -y</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># rpm -ql qemu-kvm</span></span><br><span class="line">  /usr/libexec/qemu-kvm   命令行工具被放在了非PATH变量中，红帽防止用户手动创建虚拟主机。此工具很底层</span><br><span class="line"></span><br><span class="line">使用virt-manager管理kvm(libvirt-daemon-kvm守护进程工具 qemu-kvm  virt-manager图形化工具 libvirt库)</span><br><span class="line">  [root@centos7 ~]<span class="comment"># yum install libvirt-daemon-kvm qemu-kvm  virt-manager libvirt -y</span></span><br><span class="line">  （因为已经安装图形化界面的管理工具，确保宿主机上已经安装图像化相关的库 yum groupinstall GNOME Desktop）</span><br><span class="line"></span><br><span class="line">如果宿主机上已经安装有图像化相关的库则启动libvirt守护进程</span><br><span class="line">  [root@centos7 ~]<span class="comment"># systemctl start libvirtd</span></span><br><span class="line"></span><br><span class="line">libvirtd安装好默认仅提供了一个net网络</span><br><span class="line">创建桥接网络</span><br><span class="line">    将物理网卡当交换及使用</span><br><span class="line">    将软交换机当物理网卡使用</span><br><span class="line">创建物理桥（交换机）</span><br><span class="line">  [root@centos7 ~]<span class="comment"># cd /etc/sysconfig/network-scripts/</span></span><br><span class="line">  [root@centos7 network-scripts]<span class="comment"># cp ifcfg-ens37 ifcfg-br0</span></span><br><span class="line"></span><br><span class="line">配置网卡的配置文件，使br0当网卡使用，将ens37当交换机使用</span><br><span class="line">  [root@centos7 network-scripts]<span class="comment"># vim ifcfg-ens37</span></span><br><span class="line">  HWADDR=00:0C:29:14:4D:6C</span><br><span class="line">  TYPE=Ethernet</span><br><span class="line">  BROWSER_ONLY=no</span><br><span class="line">  BOOTPROTO=none</span><br><span class="line">  DEFROUTE=yes</span><br><span class="line">  IPV4_FAILURE_FATAL=no</span><br><span class="line">  IPV6INIT=no</span><br><span class="line">  NAME=ens37</span><br><span class="line">  DEVICE=ens37</span><br><span class="line">  BRIDGE=br0</span><br><span class="line">  ONBOOT=yes</span><br><span class="line"></span><br><span class="line">  [root@centos7 network-scripts]<span class="comment"># vim ifcfg-br0 </span></span><br><span class="line">  NAME=br0</span><br><span class="line">  DEVICE=br0</span><br><span class="line">  TYPE=Bridge</span><br><span class="line">  PROXY_METHOD=none</span><br><span class="line">  BROWSER_ONLY=no</span><br><span class="line">  BOOTPROTO=none</span><br><span class="line">  IPADDR=172.18.135.1</span><br><span class="line">  PREFIX=24</span><br><span class="line">  GATEWAY=172.18.0.1</span><br><span class="line">  DNS1=8.8.8.8</span><br><span class="line">  DEFROUTE=yes</span><br><span class="line">  IPV4_FAILURE_FATAL=no</span><br><span class="line">  IPV6_FAILURE_FATAL=no</span><br><span class="line">  IPV6_PRIVACY=no</span><br><span class="line">  ONBOOT=yes</span><br><span class="line">  [root@centos7 network-scripts]<span class="comment"># systemctl restart network</span></span><br><span class="line"></span><br><span class="line">  此时br0已经是网卡了，ens37变成了交换机</span><br><span class="line">    [root@centos7 network-scripts]<span class="comment"># ifconfig</span></span><br><span class="line">   br0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">          inet 172.18.135.1  netmask 255.255.255.0  broadcast   172.18.135.255</span><br><span class="line">          inet6 fe80::20c:29ff:fe14:4d6c  prefixlen 64  scopeid     0x20&lt;link&gt;</span><br><span class="line">          ether 00:0c:29:14:4d:6c  txqueuelen 1000  (Ethernet)</span><br><span class="line">         RX packets 590  bytes 75531 (73.7 KiB)</span><br><span class="line">         RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">         TX packets 53  bytes 8801 (8.5 KiB)</span><br><span class="line">         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">   ens37: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">         ether 00:0c:29:14:4d:6c  txqueuelen 1000  (Ethernet)</span><br><span class="line">         RX packets 7333  bytes 809500 (790.5 KiB)</span><br><span class="line">         RX errors 0  dropped 2  overruns 0  frame 0</span><br><span class="line">         TX packets 1275  bytes 194949 (190.3 KiB)</span><br><span class="line">         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">------------------------------------------------------------------------------------------------------------------------</span><br><span class="line">远程连接安装kvm的主机</span><br><span class="line">一下操作在远程连接的主机上操作</span><br><span class="line">  查看网卡已经多了一个virbr0b设备，次接口是libvirtd自动生成的net模式类型的接口</span><br><span class="line">    [root@centos7 ~]<span class="comment"># ssh -X 安装kvm的主机地址</span></span><br><span class="line">    [root@centos7 ~]<span class="comment"># systemctl start libvirtd</span></span><br><span class="line">    [root@centos7 ~]<span class="comment"># ifconfig</span></span><br><span class="line">  br0: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">         inet 172.18.135.1  netmask 255.255.255.0  broadcast 172.18.135.255</span><br><span class="line">         inet6 fe80::20c:29ff:fe14:4d6c  prefixlen 64  scopeid 0x20&lt;link&gt;</span><br><span class="line">          ether 00:0c:29:14:4d:6c  txqueuelen 1000  (Ethernet)</span><br><span class="line">          RX packets 3006  bytes 1312927 (1.2 MiB)</span><br><span class="line">          RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">          TX packets 412  bytes 58640 (57.2 KiB)</span><br><span class="line">         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">    ens37: flags=4163&lt;UP,BROADCAST,RUNNING,MULTICAST&gt;  mtu 1500</span><br><span class="line">          ether 00:0c:29:14:4d:6c  txqueuelen 1000  (Ethernet)</span><br><span class="line">          RX packets 18644  bytes 3281398 (3.1 MiB)</span><br><span class="line">          RX errors 0  dropped 28  overruns 0  frame 0</span><br><span class="line">         TX packets 1827  bytes 281257 (274.6 KiB)</span><br><span class="line">         TX errors 0  dropped 0 overruns 0   carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">  lo: flags=73&lt;UP,LOOPBACK,RUNNING&gt;  mtu 65536</span><br><span class="line">          inet 127.0.0.1  netmask 255.0.0.0</span><br><span class="line">         inet6 ::1  prefixlen 128  scopeid 0x10&lt;host&gt;</span><br><span class="line">         loop  txqueuelen 1000  (Local Loopback)</span><br><span class="line">         RX packets 312  bytes 32472 (31.7 KiB)</span><br><span class="line">         RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">          TX packets 312  bytes 32472 (31.7 KiB)</span><br><span class="line">          TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">  virbr0: flags=4099&lt;UP,BROADCAST,MULTICAST&gt;  mtu 1500</span><br><span class="line">          inet 192.168.122.1  netmask 255.255.255.0  broadcast 192.168.122.255</span><br><span class="line">         ether 52:54:00:ff:0b:1f  txqueuelen 1000  (Ethernet)</span><br><span class="line">         RX packets 0  bytes 0 (0.0 B)</span><br><span class="line">         RX errors 0  dropped 0  overruns 0  frame 0</span><br><span class="line">         TX packets 0  bytes 0 (0.0 B)</span><br><span class="line">         TX errors 0  dropped 0 overruns 0  carrier 0  collisions 0</span><br><span class="line"></span><br><span class="line">检查libvirtd程序是否启动，级运行virt-manager图形化</span><br><span class="line">  [root@centos7 ~]<span class="comment"># systemctl status libvirtd</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># virt-manager</span></span><br></pre></td></tr></table></figure><p>以下操作在远程远程连接的主机上<br>使用pxe安装环境<br><img src="/2018/12/25/kvm虚拟机基础应用/virt-manager.png" alt=""><br><img src="/2018/12/25/kvm虚拟机基础应用/第一步.png" alt=""><br><img src="/2018/12/25/kvm虚拟机基础应用/第二步.png" alt=""></p><p><img src="/2018/12/25/kvm虚拟机基础应用/pxe.png" alt=""><br><img src="/2018/12/25/kvm虚拟机基础应用/第三步.png" alt=""><br>使用本地的镜像（导入现有磁盘映像）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># ls</span></span><br><span class="line">cirros-0.3.0-x86_64-disk.img</span><br><span class="line">[root@centos7 ~]<span class="comment"># mkdir /vms</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># mv cirros-0.3.0-x86_64-disk.img /vms/</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># cd /vms/</span></span><br><span class="line">[root@centos7 vms]<span class="comment"># ls</span></span><br><span class="line">cirros-0.3.0-x86_64-disk.img</span><br><span class="line">[root@centos7 vms]<span class="comment"># cp cirros-0.3.0-x86_64-disk.img pc1.img</span></span><br><span class="line">[root@centos7 vms]<span class="comment"># cp cirros-0.3.0-x86_64-disk.img pc2.img</span></span><br></pre></td></tr></table></figure></p><p><img src="/2018/12/25/kvm虚拟机基础应用/本地1.png" alt=""><br><img src="/2018/12/25/kvm虚拟机基础应用/本地2.png" alt=""><br>点击Browse Local本地浏览<br><img src="/2018/12/25/kvm虚拟机基础应用/本地3.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;kvm虚拟机基础应用&quot;&gt;&lt;a href=&quot;#kvm虚拟机基础应用&quot; class=&quot;headerlink&quot; title=&quot;kvm虚拟机基础应用&quot;&gt;&lt;/a&gt;kvm虚拟机基础应用&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2018/12/25/kvm虚拟机基础应用/kvm.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="linux服务" scheme="https://9527dz.top/categories/linux%E6%9C%8D%E5%8A%A1/"/>
    
    
      <category term="kvm虚拟机基础应用" scheme="https://9527dz.top/tags/kvm%E8%99%9A%E6%8B%9F%E6%9C%BA%E5%9F%BA%E7%A1%80%E5%BA%94%E7%94%A8/"/>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://9527dz.top/2018/12/22/%E7%BD%91%E7%BB%9C%E5%9F%BA%E7%A1%80/"/>
    <id>https://9527dz.top/2018/12/22/网络基础/</id>
    <published>2018-12-22T11:35:57.600Z</published>
    <updated>2018-12-22T14:07:55.420Z</updated>
    
    <content type="html"><![CDATA[<h2 id="企业网络架构介绍"><a href="#企业网络架构介绍" class="headerlink" title="企业网络架构介绍"></a>企业网络架构介绍</h2><ul><li><p>网络:</p><ul><li>多个终端设备</li><li>网络传输介质设备实现通讯</li></ul></li><li><p>局域网：最小的网络、本地、公司</p></li><li>广域网：不通的局域网连接</li><li><p>城域网：比广域网小，例如：一个城市</p></li><li><p>无线网（AP）</p><ul><li>CCNA</li><li>CCNP</li></ul></li><li>企业网络远程互联<ul><li>企业网络组网不受地域限制，可以通过各种远程互联技术把分布在不同的地域的网络的网络连接在一起<ul><li>ipsu</li><li>mpls vpn</li><li>专线</li></ul></li></ul></li><li>广域网：逻辑的层次划分</li><li>小型企业组网：扁平</li><li>大型网络组网：层次  <ul><li>思想：<ul><li>业务</li><li>冗余</li><li>层次-安全</li></ul></li></ul></li></ul><p><img src="/2018/12/22/网络基础/企业网络基础结构.png" alt=""><br><img src="/2018/12/22/网络基础/企业网络.png" alt=""></p><h2 id="传输介质介绍"><a href="#传输介质介绍" class="headerlink" title="传输介质介绍"></a>传输介质介绍</h2><ul><li><p>通讯网络除了包含通讯设备的本身之外，还包含连接这些设备的传输介质，如同线缆、双绞线、和光纤等，不同的传输介质具有不用的特征，这些特性直接影响到通讯诸多方面，如线路编码方式、传输速度和传输距离等。</p></li><li><p>路由</p></li><li>交换机</li><li>传输介质：连接设备的线缆<ul><li>网线</li><li>光线</li></ul></li></ul><p><img src="/2018/12/22/网络基础/两台主机连接.png" alt=""></p><ul><li><p>两个终端，用一条能承载数据传输的物理介质（也成为传输介质），连接起来，组成了一个最简单的网络。</p></li><li><p>介质</p></li></ul><p><img src="/2018/12/22/网络基础/同轴电缆.png" alt=""><br><img src="/2018/12/22/网络基础/双绞线.png" alt=""><br><img src="/2018/12/22/网络基础/以太网线线序.png" alt=""><br><img src="/2018/12/22/网络基础/串口电缆.png" alt=""><br><img src="/2018/12/22/网络基础/光纤.png" alt=""></p><ul><li>光猫：光纤设置转换为网络设备进入网络</li><li>白色：单模光纤</li><li>黄色：多模光纤</li></ul><p><img src="/2018/12/22/网络基础/冲突域.png" alt=""></p><ul><li>共享式网络中可能会出现信号冲突现象</li></ul><p><img src="/2018/12/22/网络基础/共享网络冲突域解决方法.png" alt=""></p><ul><li><p>CSMA/CD: 载波侦听多路访问/冲突检测技术</p><ul><li>工作原理：先听先发，边听边发，冲突避让，等待重发。</li></ul></li><li><p>以太网的最大包长和最小包长</p><ul><li>最大包长1518byte,其中三层数据1500byte（称为MTU）只是一个规定而言</li><li>最小包长64byte<ul><li>原因：如果A主机发送的帧很小，很快完成帧的发送，而两台冲突主机相差很远，在主机A发送的帧传输到B的前一刻，B开始发送帧，这样，当A的帧到达B时，B检测到冲突，于是发送冲突信号。假如在B冲突信号传输到A之前，A的帧已经发送完毕，那么A将检测不到冲突而误认为已经发送成功，因此必须有最小包长的限制。</li></ul></li></ul></li></ul><p><img src="/2018/12/22/网络基础/双工模式.png" alt=""></p><ul><li>两种双工模式都支持双向数据传输</li><li>冲突与：半双工模式</li></ul><h2 id="分层模型及以太网帧结构"><a href="#分层模型及以太网帧结构" class="headerlink" title="分层模型及以太网帧结构"></a>分层模型及以太网帧结构</h2><p><img src="/2018/12/22/网络基础/网络通讯协议.png" alt=""></p><ul><li><p>不同的协议栈用于定义和管理不同的网络的数据转发规则</p></li><li><p>什么是协议</p><ul><li>为了使数据可以在网络上从源传递到目标地址，网络上所有设备需要“讲”相同的语言</li></ul></li><li><p>数据通讯协议的定义</p><ul><li>决定数据的格式和传输的一组规则和一组惯例</li></ul></li><li><p>网络通讯的过程很复杂</p><ul><li>数据以电子信号的形式穿越介质到达正确的计算机，然后转换为最初的形式，以便接收者可以阅读</li><li>为了降低网络设计的复杂性，将协议进行了分层设计</li></ul></li><li><p>分层设计的意义</p><ul><li>通讯服务层的模块设计可相对独立于具有的通讯路线和通讯接口的差别</li><li>而通信服务层的模块设计又可相对独立具体用户应用的要求不同</li><li>简化了相关的网络操作，提供了不不同的厂商之间的兼容性；促进了标准化工作，结构上进行了分层；易于学习和操作</li><li>各个层次独立，一层的变化不会影响到邻层</li></ul></li><li><p><code>OSI参考模型</code></p><ul><li>国际标准化组织ISO于1984年提出了OSI RM 。OSI参考模型很快成了计算机网络的基础模型</li><li>OSI参考模型具有的优点：简化了相关的网络操作，提供了不同的厂商之间的兼容性；促进了标准化工作；结构上进行了分层；易于学习和操作</li><li>OSI参考模型各个层次的功能如下：<ul><li>网络层：在设备之间传输比特流，规定了电平、速度和断缆针脚</li><li>数据链路层：将比特流组合成了字节，再将字节组合成帧，使用链路层地址（以太网使用MAC地址）来访问介质，并进行排差错检测</li><li>网络层：提供逻辑地址，供路由确定路径</li><li>传输层：提供面向连接或者非面向连接的数据传递以及进行排差错检测</li><li>会话层：负责建、管理和终止表示层实体之间的通讯会话。该层的通信由不同的设备中的应用程序之间的服务请求和响应组成（通信设备可能存在多个会话）</li><li>表示层：提供各种用于应用层数据的编码和转换功能，确保一个系统的应用层发送的数据能够被另一个系统的应用层识别（数据表、加密、图片、文档、文字）</li><li>应用层：OSI参考模型中最靠近用户的一层，为应用程序提供网络服务</li></ul></li></ul></li></ul><p><img src="/2018/12/22/网络基础/osi参考模型.png" alt=""></p><ul><li>OSI层次设计的理念<ul><li>建立七层模型的主要目的使为解决异种网络互连时所遇到的兼容性问题</li><li>它的优点：将服务、接口和协议这三个概念明确地区分开来<ul><li>服务：某一层为上一层提供什么功能</li><li>接口：上层如何使用下层的服务</li><li>协议：如何实现本层的服务</li></ul></li><li>这样各层之间具有很强的独立性，互联网络中各尸体采用什么样的协议时没有限制的，只要向上提供形同的服务并且不改变相邻层的接口就可以了</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      
      
        &lt;h2 id=&quot;企业网络架构介绍&quot;&gt;&lt;a href=&quot;#企业网络架构介绍&quot; class=&quot;headerlink&quot; title=&quot;企业网络架构介绍&quot;&gt;&lt;/a&gt;企业网络架构介绍&lt;/h2&gt;&lt;ul&gt;
&lt;li&gt;&lt;p&gt;网络:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;多个终端设备&lt;/li&gt;
&lt;li&gt;网络传输
      
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>mysql</title>
    <link href="https://9527dz.top/2018/12/20/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/"/>
    <id>https://9527dz.top/2018/12/20/数据库基础原理/</id>
    <published>2018-12-20T11:06:25.673Z</published>
    <updated>2018-12-20T11:12:45.834Z</updated>
    
    <content type="html"><![CDATA[<p><img src="https://raw.githubusercontent.com/Dz6666/Dz6666.github.ii/master/css/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%A7%E6%A0%87%E9%A2%98.png" alt=""></p><h2 id="MYSQL数据库"><a href="#MYSQL数据库" class="headerlink" title="MYSQL数据库"></a>MYSQL数据库</h2><p>关系型数据库基础<br>安装MySQL<br>管理数据库和表<br>用户和权限管理<br>函数，存储过程和触发器<br>MySQL架构<br>存储引擎<br>服务器选项，系统和状态变量<br>优化查询和索引管理<br>锁和事务管理<br>日志管理<br>备份还原<br>MySQL集群  </p><h2 id="数据的时代"><a href="#数据的时代" class="headerlink" title="数据的时代"></a>数据的时代</h2><p>涉及的数据量大<br>数据不随程序的结束而消失<br>数据被多个应用程序共享<br>大数据   </p><h2 id="数据库的发展史"><a href="#数据库的发展史" class="headerlink" title="数据库的发展史"></a>数据库的发展史</h2><p>萌芽阶段：文件系统        使用磁盘文件来存储数据<br>初级阶段：第一代数据库    出现了网状模型、层次模型的数据库<br>中级阶段：第二代数据库    关系型数据库和结构化查询语言<br>高级阶段：新一代数据库    “关系-对象”型数据库   </p><h2 id="文件管理系统的缺点"><a href="#文件管理系统的缺点" class="headerlink" title="文件管理系统的缺点"></a>文件管理系统的缺点</h2><p>编写应用程序不方便<br>数据冗余不可避免<br>应用程序依赖性<br>不支持对文件的并发访问<br>数据间联系弱<br>难以按用户视图表示数据<br>无安全控制功能   </p><h2 id="数据库管理系统的优点"><a href="#数据库管理系统的优点" class="headerlink" title="数据库管理系统的优点"></a>数据库管理系统的优点</h2><p>相互关联的数据的集合<br>较少的数据冗余<br>程序与数据相互独立<br>保证数据的安全、可靠<br>最大限度地保证数据的正确性<br>数据可以并发使用并能同时保证一致性   </p><h2 id="数据库管理系统"><a href="#数据库管理系统" class="headerlink" title="数据库管理系统"></a>数据库管理系统</h2><p>数据库是数据的汇集，它以一定的组织形式存于存储介质上<br>DBMS是管理数据库的系统软件，它实现数据库系统的各种功能。是数据库系 统的核心<br>DBA：负责数据库的规划、设计、协调、维护和管理等工作<br>应用程序指以数据库为基础的应用程序<br><img src="https://raw.githubusercontent.com/Dz6666/Dz6666.github.ii/master/fancybox/DBMS.png" alt="管理数据库的系统软件"></p><h2 id="数据库管理系统的基本功能"><a href="#数据库管理系统的基本功能" class="headerlink" title="数据库管理系统的基本功能"></a>数据库管理系统的基本功能</h2><p>数据定义<br>数据处理<br>数据安全<br>数据备份 </p><h2 id="网状数据库"><a href="#网状数据库" class="headerlink" title="网状数据库"></a>网状数据库</h2><p>最早出现的是网状DBMS，1964年通用电气公司的Charles Bachman成功地开发出世界上第一 个网状IDS，也是第一个数据库管理系统，IDS 具有数据模式和日志的特征，只能在GE主机运行   </p><h2 id="层次数据库"><a href="#层次数据库" class="headerlink" title="层次数据库"></a>层次数据库</h2><h2 id="数据库系统的架构"><a href="#数据库系统的架构" class="headerlink" title="数据库系统的架构"></a>数据库系统的架构</h2><p>单机架构<br>大型主机/终端架构<br>主从式架构（C/S）<br>分布式架构   </p><h2 id="关系型数据库"><a href="#关系型数据库" class="headerlink" title="关系型数据库"></a>关系型数据库</h2><p>关系型数据库：使用的是sql语言，结构化的查询语言  ，内部机制特性ACID特性：保证数据库的安全稳定，影响性能<br>NOSQL：redis:高性能，高并发</p><p><code>关系 ：</code>关系就是二维表，其中：表中的行、列次序并不重要<br><code>行row：</code>表中的每一行，又称为一条记录<br><code>列column：</code>表中的每一列，称为属性，字段<br><code>主键（Primary key）：</code>用于惟一确定一个记录的字段<br><code>域domain：</code>属性的取值范围，如，性别只能是‘男’和‘女’两个值    </p><p>一个服务器可以搭建多个DBMS<br>DBMS:多个数据库  ，推荐存放一个数据库，防止访问量过大<br>库：同一个项目的相关系数据，多个表<br>表：一个表多个字段和记录  </p><h2 id="关系数据库"><a href="#关系数据库" class="headerlink" title="关系数据库"></a>关系数据库</h2><p>RDBMS：<br>&ensp;&ensp;MySQL: MySQL, MariaDB, Percona Server<br>&ensp;&ensp;PostgreSQL: 简称为pgsql，EnterpriseDB  &ensp;&ensp;Oracle    MSSQL<br>&ensp;&ensp;DB2<br>数据库排名：   <a href="https://db-engines.com/en/ranking" target="_blank" rel="noopener">https://db-engines.com/en/ranking</a>  </p><h2 id="实体-联系模型E-R"><a href="#实体-联系模型E-R" class="headerlink" title="实体-联系模型E-R"></a>实体-联系模型E-R</h2><p>实体Entity：客观存在并可以相互区分的客观事物或抽象事件称为实体<br>&ensp;&ensp;在E-R图中用矩形框表示实体，把实体名写在框内<br>属性：实体所具有的特征或性质<br>联系：联系是数据之间的关联集合，是客观存在的应用语义链<br>&ensp;&ensp;实体内部的联系：指组成实体的各属性之间的联系。如职工实体中，职工号和 部门经理号之间有一种关联关系<br>&ensp;&ensp;实体之间的联系：指不同实体之间联系。例：学生选课实体和学生基本信息实 体之间<br>&ensp;&ensp;实体之间的联系用菱形框表示   </p><h2 id="联系类型"><a href="#联系类型" class="headerlink" title="联系类型"></a>联系类型</h2><p>联系的类型<br>&ensp;&ensp;一对一联系(1:1)<br>&ensp;&ensp;一对多联系(1:n)<br>&ensp;&ensp;多对多联系(m:n)<br>数据的操作：<br>&ensp;&ensp;数据提取：在数据集合中提取感兴趣的内容。SELECT<br>&ensp;&ensp;数据更新：变更数据库中的数据。INSERT、DELETE、UPDATE<br>数据的约束条件 ：是一组完整性规则的集合<br>&ensp;&ensp;实体（行）完整性 Entity integrity<br>&ensp;&ensp;域（列）完整性 Domain Integrity<br>&ensp;&ensp;参考完整性 Referential Integrity </p><h2 id="简易数据规划流程"><a href="#简易数据规划流程" class="headerlink" title="简易数据规划流程"></a>简易数据规划流程</h2><p>第一阶段：收集数据，得到字段<br>&ensp;&ensp;收集必要且完整的数据项<br>&ensp;&ensp;转换成数据表的字段<br>第二阶段：把字段分类，归入表，建立表的关联<br>&ensp;&ensp;关联：表和表间的关系<br>&ensp;&ensp;分割数据表并建立关联的优点<br>&ensp;&ensp;节省空间<br>&ensp;&ensp;减少输入错误<br>&ensp;&ensp;方便数据修改<br>第三阶段：<br>&ensp;&ensp;规范化数据库   </p><h2 id="数据库的正规化分析"><a href="#数据库的正规化分析" class="headerlink" title="数据库的正规化分析"></a>数据库的正规化分析</h2><p>RDMBS设计范式基础概念<br>&ensp;&ensp;设计关系数据库时，遵从不同的规范要求，设计出合理的关系型数据库，这些不 同的规范要求被称为不同范式，各种范式呈递次规范，越高的范式数据库冗余越小<br>&ensp;&ensp;目前关系数据库有六种范式：第一范式（1NF）、第二范式（2NF）、第三范式 （3NF）、巴德斯科范式（BCNF）、第四范式(4NF）和第五范式（5NF，又称 完美范式）。满足最低要求的范式是第一范式（1NF）。在第一范式的基础上 进一步满足更多规范要求的称为第二范式（2NF），其余范式以次类推。一般 数据库只需满足第三范式(3NF）即可 </p><p><code>1NF：无重复的列，每一列都是不可分割的基本数据项，同一列中不能有多个 值，即实体中的某个属性不能有多个值或者不能有重复的属性。除去同类型的 字段，就是无重复的列</code><br>说明：第一范式（1NF）是对关系模式的基本要求，不满足第一范式（1NF） 的数据库就不是关系数据库<br><code>2NF：属性完全依赖于主键，第二范式必须先满足第一范式，要求表中的每个 行必须可以被唯一地区分。通常为表加上一个列，以存储各个实例的唯一标识 PK，非PK的字段需要与整个PK有直接相关性</code><br><code>3NF：属性不依赖于其它非主属性，满足第三范式必须先满足第二范式。第三 范式要求一个数据库表中不包含已在其它表中已包含的非主关键字信息，非PK 的字段间不能有从属关系</code>  </p><h2 id="SQL概念"><a href="#SQL概念" class="headerlink" title="SQL概念"></a>SQL概念</h2><p>SQL: Structure Query Language<br>&ensp;&ensp;结构化查询语言<br>&ensp;&ensp;SQL解释器：<br>&ensp;&ensp;数据存储协议：应用层协议，C/S<br>S：server, 监听于套接字，接收并处理客户端的应用请求<br>C：Client<br>&ensp;&ensp;客户端程序接口<br>&ensp;&ensp;&ensp;&ensp;CLI     字符、命令行<br>&ensp;&ensp;&ensp;&ensp;GUI     图形化<br>&ensp;&ensp;应用编程接口  API<br>&ensp;&ensp;&ensp;&ensp;ODBC：Open Database Connectivity     开放的数据库连接<br>&ensp;&ensp;&ensp;&ensp;JDBC：Java Data Base Connectivity     java开放数据库的开发接口</p><p>mysql：端口tcp 3306<br>oracle：端口tcp 1521<br>sqlserver:端口tcp 1433</p><h2 id="约束"><a href="#约束" class="headerlink" title="约束"></a>约束</h2><p><code>约束：constraint，表中的数据要遵守的限制</code><br>&ensp;&ensp;主键pk：一个或多个字段的组合，填入的数据必须能在本表中唯一标识本行； 必须提供数据，即NOT NULL，一个表只能有一个<br>&ensp;&ensp;惟一键uk：一个或多个字段的组合，填入的数据必须能在本表中唯一标识本行； 允许为NULL，一个表可以存在多个<br>&ensp;&ensp;外键fk：一个表中的某字段可填入的数据取决于另一个表的主键或唯一键已有 的数据 ,作用在依赖的表上，被依赖的表上，可以作用主键和唯一键<br>&ensp;&ensp;检查：字段值在一定范围内   </p><h2 id="基本概念"><a href="#基本概念" class="headerlink" title="基本概念"></a>基本概念</h2><p>索引：将表中的一个或多个字段中的数据复制一份另存，并且按特定次序排序 存储   （例如：书签，标识）<br>关系运算：<br>&ensp;&ensp;选择：挑选出符合条件的行<br>&ensp;&ensp;投影：挑选出需要的字段<br>&ensp;&ensp;连接：表间字段的关联  </p><h2 id="数据模型"><a href="#数据模型" class="headerlink" title="数据模型"></a>数据模型</h2><p>数据抽象：<br>&ensp;&ensp;物理层：数据存储格式，即RDBMS在磁盘上如何组织文件<br>&ensp;&ensp;逻辑层：DBA角度，描述存储什么数据，以及数据间存在什么样的关系<br>&ensp;&ensp;视图层：用户角度，描述DB中的部分数据<br>关系模型的分类：<br>&ensp;&ensp;关系模型<br>&ensp;&ensp;基于对象的关系模型<br>&ensp;&ensp;半结构化的关系模型：XML数据  ：扩展的标记语言</p><p><code>范例：基于xml语言存放的数据</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">下面目录内的文件都是基于xml语言存放数据的文件</span><br><span class="line">[root@centos6 gconf]<span class="comment"># cd /etc/gconf/gconf.xml.defaults/</span></span><br></pre></td></tr></table></figure></p><p><code>范例：设置开机自动登陆</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos6 ~]<span class="comment"># vim /etc/gdm/custom.conf </span></span><br><span class="line"><span class="comment"># GDM configuration storage</span></span><br><span class="line">[daemon]</span><br><span class="line">AutomaticLoginEnable=ture</span><br><span class="line">AutomaticLongin=root</span><br></pre></td></tr></table></figure></p><h2 id="MySQL历史"><a href="#MySQL历史" class="headerlink" title="MySQL历史"></a>MySQL历史</h2><p>1979年：TcX公司 Monty Widenius，Unireg<br>1996年：发布MySQL1.0，Solaris版本，Linux版本<br>1999年：MySQL AB公司，瑞典<br>2003年：MySQL 5.0版本，提供视图、存储过程等功能<br>2008年：Sun 收购<br>2009年：Oracle收购sun<br>2009年：Monty成立MariaDB   </p><h2 id="MySQL和MariaDB"><a href="#MySQL和MariaDB" class="headerlink" title="MySQL和MariaDB"></a>MySQL和MariaDB</h2><p>官方网址：<br><a href="https://www.mysql.com/" target="_blank" rel="noopener">https://www.mysql.com/</a><br><a href="http://mariadb.org/" target="_blank" rel="noopener">http://mariadb.org/</a><br><code>官方文档</code><br><code>https://dev.mysql.com/doc/</code><br><code>https://mariadb.com/kb/en/</code><br>版本演变：<br>MySQL：5.1 –&gt; 5.5 –&gt; 5.6 –&gt; 5.7 –&gt;8.0<br>MariaDB：5.5 –&gt;10.0–&gt; 10.1 –&gt; 10.2 –&gt; 10.3<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">yum info ..</span><br><span class="line">centos6默认光盘安装mysql 5.1.73</span><br><span class="line">centos7使用的是mariadb 5.5.56</span><br></pre></td></tr></table></figure></p><h2 id="MYSQL的特性"><a href="#MYSQL的特性" class="headerlink" title="MYSQL的特性"></a>MYSQL的特性</h2><p><code>插件式存储引擎：</code>也称为“表类型”，存储管理器有多种实现版本，功能和特 性可能均略有差别；用户可根据需要灵活选择,Mysql5.5.5开始innoDB引擎是 MYSQL默认引擎<br>&ensp;&ensp;MyISAM ==&gt; Aria<br>&ensp;&ensp;InnoDB ==&gt; XtraDB<br>单进程，多线程<br>诸多扩展和新特性<br>提供了较多测试组件<br>开源   </p><p>raw:裸文件系统：无文件系统：二进制方式存储</p>]]></content>
    
    <summary type="html">
    
      
      
        &lt;p&gt;&lt;img src=&quot;https://raw.githubusercontent.com/Dz6666/Dz6666.github.ii/master/css/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%A4%A7%E6%A0%87%E9%A2%98.png
      
    
    </summary>
    
      <category term="数据库" scheme="https://9527dz.top/categories/%E6%95%B0%E6%8D%AE%E5%BA%93/"/>
    
    
      <category term="数据库基础原理" scheme="https://9527dz.top/tags/%E6%95%B0%E6%8D%AE%E5%BA%93%E5%9F%BA%E7%A1%80%E5%8E%9F%E7%90%86/"/>
    
  </entry>
  
  <entry>
    <title></title>
    <link href="https://9527dz.top/2018/12/19/nfs%E6%9C%8D%E5%8A%A1%E5%99%A8/"/>
    <id>https://9527dz.top/2018/12/19/nfs服务器/</id>
    <published>2018-12-19T09:32:20.163Z</published>
    <updated>2018-12-19T13:35:37.903Z</updated>
    
    <content type="html"><![CDATA[<hr><p>title: ftp<br>tags: linux服务<br>categories: NFS服务器<br>date: </p><h2 id="top"><a href="#top" class="headerlink" title="top: "></a>top: </h2><h2 id="NFS服务"><a href="#NFS服务" class="headerlink" title="NFS服务"></a>NFS服务</h2><p><img src="/2018/12/19/nfs服务器/nfs标题.png" alt=""><br><a id="more"></a></p><p><code>NFS：Network File System 网络文件系统，基于内核的文件系统。</code>Sun公司 开发，通过使用NFS，用户和程序可以像访问本地文件一样访问远端系统上的 文件，基于RPC<code>（Remote Procedure Call Protocol远程过程调用）实现</code> </p><p>RPC采用C/S模式。客户机请求程序调用进程发送一个有进程参数的调用信息 到服务进程，然后等待应答信息。在服务器端，进程保持睡眠状态直到调用 信息到达为止。当一个调用信息到达，服务器获得进程参数，计算结果，发 送答复信息，然后等待下一个调用信息，最后，客户端调用进程接收答复信 息，获得进程结果，然后调用执行继续进行 </p><p>NFS优势：节省本地存储空间，将常用的数据,如home目录,存放在NFS服务 器上且可以通过网络访问，本地终端将可减少自身存储空间的使用 </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">常用系统的驱动查看模块</span><br><span class="line">[root@centos7 ~]<span class="comment"># locate xfs.ko</span></span><br><span class="line">/usr/lib/modules/3.10.0-862.el7.x86_64/kernel/fs/xfs/xfs.ko.xz</span><br><span class="line">[root@centos7 ~]<span class="comment"># ls /usr/lib/modules/3.10.0-862.el7.x86_64/kernel/fs/</span></span><br><span class="line">binfmt_misc.ko.xz  cifs    ext4     gfs2   mbcache.ko.xz  nls        udf</span><br><span class="line">btrfs              cramfs  fat      isofs  nfs            overlayfs  xfs</span><br><span class="line">cachefiles         dlm     fscache  jbd2   nfs_common     pstore</span><br><span class="line">ceph               exofs   fuse     lockd  nfsd           squashfs</span><br><span class="line"></span><br><span class="line">linux内核默认已经安装nfs文件系统，已经加载驱动模块</span><br><span class="line">[root@centos7 ~]<span class="comment"># locate nfs.ko</span></span><br><span class="line">/usr/lib/modules/3.10.0-862.el7.x86_64/kernel/drivers/xen/xenfs/xenfs.ko.xz</span><br><span class="line">/usr/lib/modules/3.10.0-862.el7.x86_64/kernel/fs/nfs/nfs.ko.xz</span><br></pre></td></tr></table></figure><h2 id="NFS文件系统"><a href="#NFS文件系统" class="headerlink" title="NFS文件系统"></a>NFS文件系统</h2><p><img src="/2018/12/19/nfs服务器/nfs文件系统.png" alt=""></p><h2 id="NFS工作原理"><a href="#NFS工作原理" class="headerlink" title="NFS工作原理"></a>NFS工作原理</h2><p><img src="/2018/12/19/nfs服务器/nfs工作原理.png" alt=""></p><h2 id="NFS各个版本的对比s"><a href="#NFS各个版本的对比s" class="headerlink" title="NFS各个版本的对比s"></a>NFS各个版本的对比s</h2><p><img src="/2018/12/19/nfs服务器/nfs各个版本的对比.png" alt=""></p><h2 id="NFS服务介绍"><a href="#NFS服务介绍" class="headerlink" title="NFS服务介绍"></a>NFS服务介绍</h2><p>软件包：nfs-utils（并非服务器包时文件系统即工具）<br>Kernel支持:nfs.ko<br>端口：2049(nfsd), 其它端口由portmap(111)分配<br>配置文件：/etc/exports,/etc/exports.d/*.exports<br>CentOS7不支持同一目录同时用nfs和samba共享，因为使用锁机制不同<br>相关软件包:rpcbind（必须rpcbind， 服务如果不可用则nfs服务也不可用），tcp_wrappers<br>CentOS6开始portmap进程由rpcbind代替<br>NFS服务主要进程：<br>&ensp;&ensp;rpc.nfsd    最主要的NFS进程，管理客户端是否可登录<br>&ensp;&ensp;rpc.mountd 挂载和卸载NFS文件系统，包括权限管理<br>&ensp;&ensp;rpc.lockd   非必要，管理文件锁，避免同时写出错<br>&ensp;&ensp;rpc.statd   非必要，检查文件一致性，可修复文件<br>日志：/var/lib/nfs/  </p><p>范例：查看nfs对应的端口<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># rpcinfo -p</span></span><br><span class="line">   program vers proto   port  service</span><br><span class="line">    100000    4   tcp    111  portmapper</span><br><span class="line">    100000    3   tcp    111  portmapper</span><br><span class="line"></span><br><span class="line">此服务使用的随机端口比较多，所以此服务一般不会跨网络使用，最好在局域网内使用</span><br></pre></td></tr></table></figure></p><p>范例：配置防火墙，将随机端口绑死，实现跨网络<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">配置防火墙，开放NFS服务 </span><br><span class="line">配置NFS使用固定端口 </span><br><span class="line">vim  /etc/sysconfig/nfs </span><br><span class="line">RQUOTAD_PORT=875 </span><br><span class="line">LOCKD_TCPPORT=32803 </span><br><span class="line">LOCKD_UDPPORT=32769 </span><br><span class="line">MOUNTD_PORT=892 </span><br><span class="line">STATD_PORT=662 </span><br><span class="line">STATD_OUTGOING_PORT=2020 </span><br><span class="line">防火墙除开放上述端口，还需开放TCP和UDP的111和2049共4个端</span><br></pre></td></tr></table></figure></p><p><code>范例：实现共享文件夹</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br></pre></td><td class="code"><pre><span class="line">服务端：</span><br><span class="line"></span><br><span class="line">创建共享的目录</span><br><span class="line">  [root@centos7 ~]<span class="comment"># mkdir /data/a</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># mkdir /data/b</span></span><br><span class="line"></span><br><span class="line">编辑服务器的配置文件（此配置配置文件是系统的基本文件，此文件可以定义共享的目录的策略）</span><br><span class="line">  [root@centos7 ~]<span class="comment"># rpm -qf /etc/exports</span></span><br><span class="line">  setup-2.8.71-9.el7.noarch</span><br><span class="line"></span><br><span class="line">   [root@centos7 ~]<span class="comment"># vim /etc/exports （*代表所有人可以访问）</span></span><br><span class="line">  /data/a  *  </span><br><span class="line">  </span><br><span class="line">  生效配置文件（提示我们没有配置策略使用默认的配置策略，sync直接写磁盘，不放buffer）</span><br><span class="line">  [root@centos7 ~]<span class="comment"># exportfs -r</span></span><br><span class="line">  exportfs: No options <span class="keyword">for</span> /data/a *: suggest *(sync) to avoid warning</span><br><span class="line"></span><br><span class="line">客户端：</span><br><span class="line">  创建挂载点，使用服务端共享的目录进行挂载</span><br><span class="line">  [root@centos7 ~]<span class="comment"># mkdir /data/nfs1 /data/nfs2</span></span><br><span class="line"></span><br><span class="line">  [root@centos7 ~]<span class="comment"># showmount -e 192.168.52.179</span></span><br><span class="line">  Export list <span class="keyword">for</span> 192.168.52.179:</span><br><span class="line">  /data/a *</span><br><span class="line"></span><br><span class="line">  挂载指向服务端的地址</span><br><span class="line">  [root@centos7 ~]<span class="comment"># mount 192.168.52.179:/data/a /data/nfs1</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># df</span></span><br><span class="line">  192.168.52.179:/data/a  20961280   33024  20928256   1% /data/nfs1</span><br><span class="line"></span><br><span class="line">服务端在共享的目录中创建文件，客户端查看是否同步</span><br><span class="line">  [root@centos7 ~]<span class="comment"># touch /data/a/a.txt</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># ls /data/nfs1/</span></span><br><span class="line">  a.txt</span><br><span class="line"></span><br><span class="line">  查看共享默认的权限：只读属性</span><br><span class="line">  [root@centos7 ~]<span class="comment"># touch /data/nfs1/b.txt</span></span><br><span class="line">  touch: cannot touch ‘/data/nfs1/b.txt’: Read-only file system</span><br><span class="line"></span><br><span class="line">  客户端查看挂载属性：默认使用的挂载版本为vers=4</span><br><span class="line">  [root@centos7 ~]<span class="comment"># mount</span></span><br><span class="line">  192.168.52.179:/data/a on /data/nfs1 <span class="built_in">type</span> nfs4 (rw,relatime,vers=4.1,rsize=262144,wsize=262144,namlen=255,hard,proto=tcp,port=0,timeo=600,retrans=2,sec=sys,clientaddr=192.168.52.179,local_lock=none,addr=192.168.52.179)</span><br><span class="line"></span><br><span class="line">  客户端挂载指定版本挂载</span><br><span class="line">  [root@centos7 ~]<span class="comment"># mount -o vers=3 192.168.52.179:/data/a /data/nfs1</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># mount | tail -n1</span></span><br><span class="line">  192.168.52.179:/data/a on /data/nfs1 <span class="built_in">type</span> nfs (rw,relatime,vers=3,rsize=262144,wsize=262144,namlen=255,hard,proto=tcp,timeo=600,retrans=2,sec=sys,mountaddr=192.168.52.179,mountvers=3,mountport=20048,mountproto=udp,local_lock=none,addr=192.168.52.179)</span><br><span class="line"></span><br><span class="line">服务端修改挂载的目录权限</span><br><span class="line">  [root@centos7 ~]<span class="comment"># vim /etc/exports</span></span><br><span class="line"></span><br><span class="line">  /data/a *(sync,ro)        同步，只读</span><br><span class="line">  /data/b *(rw)             可读可写</span><br><span class="line"></span><br><span class="line">  生效并查看权限</span><br><span class="line">  [root@centos7 ~]<span class="comment"># exportfs  -r</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># exportfs  -v  （root_squash压榨root权限   no_all_squash普通用户不压榨）</span></span><br><span class="line">  /data/a       &lt;world&gt;(ro,sync,wdelay,hide,no_subtree_check,sec=sys,secure,root_squash,no_all_squash)</span><br><span class="line">  /data/b       &lt;world&gt;(rw,sync,wdelay,hide,no_subtree_check,sec=sys,secure,root_squash,no_all_squash)</span><br><span class="line"></span><br><span class="line">客户端挂载:挂载也是有读写权限的但是还是不可以创建文件</span><br><span class="line">  [root@centos7 ~]<span class="comment"># mkdir /data/nfs2/</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># mount 192.168.52.179:/data/b /data/nfs2/</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># touch /data/nfs2/a.txt</span></span><br><span class="line">  touch: cannot touch ‘/data/nfs2/a.txt’: Permission denied</span><br><span class="line">  因为客户端访问服务端的共享目录的身份默认的是以nfsnoboby身份</span><br><span class="line"></span><br><span class="line">服务端授权设置acl</span><br><span class="line">  [root@centos7 ~]<span class="comment"># setfacl  -m u:nfsnobody:rwx /data/b/</span></span><br><span class="line"></span><br><span class="line">客户端测试</span><br><span class="line">  [root@centos7 ~]<span class="comment"># touch /data/nfs2/a.txt</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># ll !$</span></span><br><span class="line">  ll /data/nfs2/a.txt</span><br><span class="line">  -rw-r--r--. 1 nfsnobody nfsnobody 0 Dec 19 20:17 /data/nfs2/a.tx</span><br><span class="line"></span><br><span class="line">客户端使用客户端的普通用户，在服务端共享的目录中创建文件显示权限不足（因为客户端创建的用户为普通用户，如果有同名用户则显示相同的用户，如果没有则显示客户端的用户的id）(映射成id相同的人，普通用户不压榨)</span><br></pre></td></tr></table></figure></p><p><code>导出的文件系统的格式：</code><br>&ensp;&ensp;/dir  主机1(opt1,opt2)   主机2(opt1,opt2)…   </p><p>#开始为注释   </p><p>主机格式：<br>&ensp;&ensp;/单个主机：ipv4，ipv6，FQDN<br>&ensp;&ensp;/IP networks：两种掩码格式均支持<br>&ensp;&ensp;/&ensp;&ensp;/172.18.0.0/255.255.0.0<br>&ensp;&ensp;/&ensp;&ensp;/172.18.0.0/16<br>&ensp;&ensp;/wildcards：主机名通配，例如<em>.magedu.com，IP不可以<br>&ensp;&ensp;/netgroups：NIS域的主机组，@group_name<br>&ensp;&ensp;/anonymous：表示使用</em>通配所有客户端   </p><h2 id="nfs配置文件"><a href="#nfs配置文件" class="headerlink" title="nfs配置文件"></a><code>nfs配置文件</code></h2><p>每个条目指定目录导出到的哪些主机，及相关的权限和选项<br>&ensp;&ensp;默认选项：(ro,sync,root_squash,no_all_squash)<br>&ensp;&ensp;ro,rw 只读和读写 • async 异步，数据变化后不立即写磁盘，性能高<br>&ensp;&ensp;sync（1.0.0后为默认）同步，数据在请求时立即写入共享<br>&ensp;&ensp;no_all_squash （默认）保留共享文件的UID和GID<br>&ensp;&ensp;all_squash 所有远程用户(包括root)都变成nfsnobody<br>&ensp;&ensp;root_squash （默认）远程root映射为nfsnobody,UID为65534，早期版本 是4294967294 (nfsnobody)<br>&ensp;&ensp;no_root_squash 远程root映射成root用户<br>&ensp;&ensp;anonuid和anongid 指明匿名用户映射为特定用户UID和组GID，而非 nfsnobody,可配合all_squash使用   </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">不压榨远程root用户的权限</span><br><span class="line">  [root@centos7 ~]<span class="comment"># vim /etc/exports</span></span><br><span class="line">  /data/a *(sync,ro)</span><br><span class="line">  /data/b *(rw,no_root_squash)</span><br><span class="line">  [root@centos7 ~]<span class="comment"># exportfs -v</span></span><br><span class="line">  /data/a       &lt;world&gt;(ro,sync,wdelay,hide,no_subtree_check,sec=sys,secure,root_squash,no_all_squash)</span><br><span class="line">  /data/b       &lt;world&gt;(rw,sync,wdelay,hide,no_subtree_check,sec=sys,secure,root_squash,no_all_squash)</span><br></pre></td></tr></table></figure><h2 id="NFS工具"><a href="#NFS工具" class="headerlink" title="NFS工具"></a>NFS工具</h2><p><code>rpcinfo</code><br>&ensp;&ensp;rpcinfo -p hostname<br>&ensp;&ensp;rpcinfo –s hostname 查看RPC注册程序   </p><p><code>exportfs</code><br>&ensp;&ensp;–v 查看本机所有NFS共享<br>&ensp;&ensp;–r 重读配置文件，并共享目录<br>&ensp;&ensp;–a 输出本机所有共享<br>&ensp;&ensp;–au 停止本机所有共享   </p><p><code>showmount -e hostname</code><br><code>mount.nfs 挂载工具</code><br><code>NFSv4支持通过挂载NFS服务器的共享“根”，从而浏览NFS服务器上的共享 目录列表</code><br>&ensp;&ensp;mount  nfsserver:/    /mnt/nfs   </p><h2 id="客户端NFS挂载"><a href="#客户端NFS挂载" class="headerlink" title="客户端NFS挂载"></a><code>客户端NFS挂载</code></h2><p>基于安全考虑，建议使用nosuid,nodev,noexec挂载选项<br>NFS相关的挂载选项：<br>&ensp;&ensp;fg（默认）前台挂载，bg后台挂载<br>&ensp;&ensp;hard（默认）持续请求，soft 非持续请求<br>&ensp;&ensp;intr 和hard配合，请求可中断<br>&ensp;&ensp;rsize和wsize 一次读和写数据最大字节数，rsize=32768<br>&ensp;&ensp;_netdev 无网络不挂载<br>示例：<br>&ensp;&ensp;mount -o rw,nosuid,fg,hard,intr 172.16.0.1:/testdir /mnt/nfs/<br>开机挂载:/etc/fstab<br>&ensp;&ensp;172.16.0.1:/public   /mnt/nfs   nfs   defaults  0  0   </p><h2 id="自动挂载"><a href="#自动挂载" class="headerlink" title="自动挂载"></a>自动挂载</h2><p>可使用autofs按需要挂载NFS共享，在空闲时自动卸载<br>由autofs包提供<br>系统管理器指定由/etc/auto.master自动挂载器守护进程控制的挂载点<br>自动挂载监视器访问这些目录并按要求挂载文件系统<br>文件系统在失活的指定间隔5分钟后会自动卸载<br>为所有导出到网络中的NFS启用特殊匹配 -host 至“browse”<br>参看帮助：man 5 autofs<br>支持含通配符的目录名<br>&ensp;&ensp;*     server:/export/&amp;   </p><h2 id="直接匹配"><a href="#直接匹配" class="headerlink" title="直接匹配"></a>直接匹配</h2><p>直接匹配包括绝对路径名称<br>不会影响本地目录结构<br>示例：<br>&ensp;&ensp;/etc/auto.master:<br>&ensp;&ensp;/-      /etc/auto.direct   </p><p>&ensp;&ensp;/etc/auto.direct:<br>&ensp;&ensp;/foo    server1:/export/foo<br>&ensp;&ensp;/user/local/  server1:/usr/local   </p>]]></content>
    
    <summary type="html">
    
      &lt;hr&gt;
&lt;p&gt;title: ftp&lt;br&gt;tags: linux服务&lt;br&gt;categories: NFS服务器&lt;br&gt;date: &lt;/p&gt;
&lt;h2 id=&quot;top&quot;&gt;&lt;a href=&quot;#top&quot; class=&quot;headerlink&quot; title=&quot;top: &quot;&gt;&lt;/a&gt;top: &lt;/h2&gt;&lt;h2 id=&quot;NFS服务&quot;&gt;&lt;a href=&quot;#NFS服务&quot; class=&quot;headerlink&quot; title=&quot;NFS服务&quot;&gt;&lt;/a&gt;NFS服务&lt;/h2&gt;&lt;p&gt;&lt;img src=&quot;/2018/12/19/nfs服务器/nfs标题.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
    
  </entry>
  
  <entry>
    <title>linux防火墙</title>
    <link href="https://9527dz.top/2018/03/06/linux%E9%98%B2%E7%81%AB%E5%A2%99/"/>
    <id>https://9527dz.top/2018/03/06/linux防火墙/</id>
    <published>2018-03-05T16:00:00.000Z</published>
    <updated>2018-12-23T09:46:29.864Z</updated>
    
    <content type="html"><![CDATA[<h1 id="linux防火墙"><a href="#linux防火墙" class="headerlink" title="linux防火墙"></a>linux防火墙</h1><p><img src="/2018/03/06/linux防火墙/linux防火墙.png" alt=""><br><a id="more"></a></p><h2 id="本章内容"><a href="#本章内容" class="headerlink" title="本章内容"></a>本章内容</h2><h2 id="安全技术"><a href="#安全技术" class="headerlink" title="安全技术"></a>安全技术</h2><ul><li><p>入侵检测与管理系统（Intrusion Detection Systems）：特点是不阻断任何网络 访问，量化、定位来自内外网络的威胁情况，主要以提供报告和事后监督为主， 提供有针对性的指导措施和安全决策依据。一般采用旁路部署方式 </p></li><li><p>入侵防御系统（Intrusion Prevention System）：以透明模式工作，分析数据包 的内容如：溢出攻击、拒绝服务攻击、木马、蠕虫、系统漏洞等进行准确的分析 判断，在判定为攻击行为后立即予以阻断，主动而有效的保护网络的安全，一般 采用在线部署方式 </p></li><li><p>防火墙（ FireWall ）：隔离功能，工作在网络或主机边缘，对进出网络或主机的 数据包基于一定的规则检查，并在匹配某规则时由规则定义的行为进行处理的一 组功能的组件，基本上的实现都是默认情况下关闭所有的通过型访问，只开放允 许访问的策略(防范非授权网络)</p></li></ul><p><code>linux操作系统的空间：内核空间和用户空间</code><br><code>端口：进程地址</code></p><h2 id="防火墙的分类"><a href="#防火墙的分类" class="headerlink" title="防火墙的分类"></a>防火墙的分类</h2><p>防火墙的分类   </p><ul><li>主机防火墙：服务范围为当前主机   <ul><li>网络防火墙：服务范围为防火墙一侧的局域网   </li><li>硬件防火墙：在专用硬件级别实现部分功能的防火墙；另一个部分功能基于软件   </li><li>实现，Checkpoint,NetScreen   </li><li>软件防火墙：运行于通用硬件平台之上的防火墙的应用软件   </li></ul></li><li>网络层防火墙：OSI模型下四层   <ul><li>应用层防火墙/代理服务器：代理网关，OSI模型七层  </li></ul></li></ul><h2 id="网络型防火墙"><a href="#网络型防火墙" class="headerlink" title="网络型防火墙"></a>网络型防火墙</h2><p>网络层防火墙   </p><ul><li>包过滤防火墙   </li><li>网络层对数据包进行选择，选择的依据是系统内设置的过滤逻辑，被称为访问控制 列表（ACL），通过检查数据流中每个数据的源地址，目的地址，所用端口号和协议 状态等因素，或他们的组合来确定是否允许该数据包通过   </li><li>优点：对用户来说透明，处理速度快且易于维护   </li><li>缺点：无法检查应用层数据，如病毒等  </li></ul><p><img src="/2018/03/06/linux防火墙/网路型防火墙.png" alt=""></p><h2 id="应用层防火墙"><a href="#应用层防火墙" class="headerlink" title="应用层防火墙"></a>应用层防火墙</h2><p>应用层防火墙/代理服务型防火墙（Proxy Service）   </p><ul><li>将所有跨越防火墙的网络通信链路分为两段   </li><li>内外网用户的访问都是通过代理服务器上的“链接”来实现   </li><li>优点：在应用层对数据进行检查，比较安全   </li><li>缺点：增加防火墙的负载  </li></ul><p>现实生产环境中所使用的防火墙一般都是二者结合体<br>&ensp;&ensp;即先检查网络数据，通过之后再送到应用层去检查  </p><p><img src="/2018/03/06/linux防火墙/应用层防火墙.png" alt=""></p><h2 id="iptables的基本认识"><a href="#iptables的基本认识" class="headerlink" title="iptables的基本认识"></a>iptables的基本认识</h2><p>Netfilter组件<br>&ensp;&ensp;内核空间，集成在linux内核中<br>&ensp;&ensp;扩展各种网络服务的结构化底层框架<br>&ensp;&ensp;内核中选取五个位置放了五个hook(勾子) function(INPUT、OUTPUT、 FORWARD、PREROUTING、POSTROUTING)，而这五个hook function 向用户开放，用户可以通过一个命令工具（iptables）向其写入规则<br>&ensp;&ensp;由信息过滤表（table）组成，包含控制IP包处理的规则集（rules），规则 被分组放在链（chain）上   </p><p><code>三种报文流向：</code><br><code>netfilter内核级别的框架，，人是不可和内核打交道，使用用户空间的工具iptables，规则编辑器，内核级的系统级别netfilter的调用接口，将写的规则送到内核中的钩子hook上直接生效，直接送到内存中，说明主机关机则规则就没有了，所以想永久生效，可以放在内核启动时初始化时读取到的文件中，或者在或者启动完后，自动执行某个命令或者启动某个服务来调用</code>（即刻生效，但是不会永久有效）<br>路由前：PREROUTING<br>流入：INPUT<br>流出：OUTPUT<br>转发：FORWARD<br>路由后：POSTROUTING    </p><p>&ensp;&ensp;<code>流入本机：PREROUTING --&gt; INPUT--&gt;用户空间进程</code><br>&ensp;&ensp;<code>流出本机：用户空间进程 --&gt;OUTPUT--&gt; POSTROUTING</code><br>&ensp;&ensp;<code>转发：PREROUTING --&gt; FORWARD --&gt; POSTROUTING</code>  </p><p>linux早期没有防火墙的，仿照unix的发行版的OpenBSD，著名的以安全为目标的发行版<br>OpenBSD：纯软件，内核级只负责传输层一下级检测实现，进行工作和防护  </p><p>定制防火墙规则：黑名单、白名单<br>&ensp;&ensp;黑名单适用于知道改拒绝谁<br>&ensp;&ensp;百名单高效的仅授权可以连接的  </p><h2 id="iptables的基本认识-1"><a href="#iptables的基本认识-1" class="headerlink" title="iptables的基本认识"></a>iptables的基本认识</h2><p>防火墙工具<br>iptables<br>&ensp;&ensp;命令行工具，工作在用户空间<br>&ensp;&ensp;用来编写规则，写好的规则被送往netfilter，告诉内核如何去处理信息包   </p><p>firewalld<br>&ensp;&ensp;CentOS 7 引入了新的前端管理工具<br>&ensp;&ensp;管理工具：<br>&ensp;&ensp;&ensp;&ensp;firewall-cmd 命令行<br>&ensp;&ensp;&ensp;&ensp;firewall-config 图形  </p><h2 id="历史"><a href="#历史" class="headerlink" title="历史"></a>历史</h2><p><code>ipfw -&gt; ipchains -&gt; iptables -&gt; nftables(rhel8)</code></p><p><code>主机级别防火墙：INPUT---OUTPUTS</code><br><code>网络级别防火墙：FROWARD</code></p><p>NAT：网络地址转换</p><p><code>iptables：四个功能：table</code></p><ul><li>filter:过滤    </li><li>nat:地址转换   </li><li>mangle:报文修改，fwmark</li><li>raw:关闭连接追踪</li></ul><p>Centos：使用iptables的方式</p><ul><li>netfilter:内核框架（framework）</li><li>syscall:系统调用接口，iptables命令行工具，管理规则（服务化的管理工具）</li><li>firewalld:守护进程，firewall-cmd(默认安装，但是尽量不使用)</li></ul><p>禁用firewalld<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># systemctl stop firewalld</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl disable firewalld</span></span><br><span class="line">Removed symlink /etc/systemd/system/multi-user.target.wants/firewalld.service.</span><br><span class="line">Removed symlink /etc/systemd/system/dbus-org.fedoraproject.FirewallD1.service.</span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl is-enabled firewalld</span></span><br><span class="line">disabled</span><br></pre></td></tr></table></figure></p><p><code>报文流向：</code></p><ul><li>到本机内部：prerouting–&gt;input</li><li>由本机发现：output–&gt;postrouting</li><li>转发：prerouting –&gt;forward–&gt;postrouting</li></ul><p><code>tables&lt;--&gt;CHANS链:</code></p><ul><li>filter: INPUT,PORWARD,OUTPUT</li><li>nat: PREROUTING,INPUT,OUTPUT,POSTROUTING</li><li>mangle: PREROUTING,INPUT,FOREARD,OUTPUT,POSTROUIING</li><li>raw: PREROUTING,OUTPUT</li></ul><p>查看各表中的链的规则：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># iptables -t filter -nL</span></span><br><span class="line">Chain INPUT (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain FORWARD (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination         </span><br><span class="line"></span><br><span class="line">Chain OUTPUT (policy ACCEPT)</span><br><span class="line">target     prot opt <span class="built_in">source</span>               destination</span><br></pre></td></tr></table></figure></p><h2 id="Netfilter表和链对应的关系"><a href="#Netfilter表和链对应的关系" class="headerlink" title="Netfilter表和链对应的关系"></a>Netfilter表和链对应的关系</h2><p><img src="/2018/03/06/linux防火墙/Netfilter表和链对应关系.png" alt=""></p><h2 id="数据包过滤匹配流程"><a href="#数据包过滤匹配流程" class="headerlink" title="数据包过滤匹配流程"></a>数据包过滤匹配流程</h2><p><img src="/2018/03/06/linux防火墙/数据包过滤匹配流程.png" alt=""></p><h2 id="命令的使用格式"><a href="#命令的使用格式" class="headerlink" title="命令的使用格式"></a><code>命令的使用格式</code></h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">SYNOPSIS</span><br><span class="line">       iptables [-t table] &#123;-A|-C|-D&#125; chain rule-specification</span><br><span class="line"></span><br><span class="line">       ip6tables [-t table] &#123;-A|-C|-D&#125; chain rule-specification</span><br><span class="line"></span><br><span class="line">       iptables [-t table] -I chain  [rulenum]  rule-specifica‐</span><br><span class="line">       tion</span><br><span class="line"></span><br><span class="line">       iptables [-t table] -R chain rulenum rule-specification</span><br><span class="line"></span><br><span class="line">       iptables [-t table] -D chain rulenum</span><br><span class="line"></span><br><span class="line">       iptables [-t table] -S [chain [rulenum]]</span><br><span class="line"></span><br><span class="line">       iptables   [-t   table]   &#123;-F|-L|-Z&#125;  [chain  [rulenum]]</span><br><span class="line">       [options...]</span><br><span class="line"></span><br><span class="line">       iptables [-t table] -N chain</span><br><span class="line"></span><br><span class="line">       iptables [-t table] -X [chain]</span><br><span class="line"></span><br><span class="line">       iptables [-t table] -P chain target</span><br><span class="line"></span><br><span class="line">       iptables [-t table] -E old-chain-name new-chain-name</span><br><span class="line"></span><br><span class="line">       rule-specification = [matches...] [target]</span><br><span class="line"></span><br><span class="line">       match = -m matchname [per-match-options]</span><br><span class="line"></span><br><span class="line">       target = -j targetname [per-target-options]</span><br></pre></td></tr></table></figure><p><code>iptables [-t tables,如果不指定则代表使用默认的filter] SUBCMMAND子命令  chain [rulenum规则号码] [rule-spce]</code> </p><p><code>rule-specification=[matches匹配条件][-j target处理动作]</code></p><p>CRUD:增删改查（指定多个规则隐含的是与关系，符合所有的条件才是满足定义的条件的）</p><p>子命令：</p><ul><li>管理规则：<ul><li>-A ：append,尾部追加</li><li>-I ：inset,插入</li><li>-D ：删除</li><li>-R ：替换</li></ul></li><li>管理链<ul><li>-N ：new,新增加一条链</li><li>-X : 删除一条自定义、空的，不可有规则、引用计数为0的链</li><li>-E : rename 改自定义引用技术为0的链</li><li>-P ： policy,设置链的默认策略</li><li>-F ： flush,清空</li><li>-Z ： zero,置零，计数器归零<ul><li>iptables的每条规则和每个链都有专用的两个计数器：pkts规则匹配到的报个数计数器，bytes报文体积计数器kbytes</li></ul></li></ul></li><li>查看 -L<ul><li>-n : 以数字显示主机的地址和端口</li><li>-v : -vv : 显示详细的信息</li><li>-x : exact，避免单位的换算显示精准的信息</li><li>–line-numbers : 显示行号</li></ul></li><li>链<ul><li>内置链</li><li>自定义链</li></ul></li><li><p>匹配条件</p><ul><li>检查报文<ul><li>TCP或UDP首部：源端口，目标端口<ul><li>FSM:有限状态机</li></ul></li><li>IP首部：sip,dip（源ip和目标ip）</li><li>MAC首部:MAC地址</li></ul></li><li><p>匹配条件</p><ul><li>通用匹配<ul><li>[!] -s,–sip,–spurce-ip:报文的源地址,其值可以是ip或者是网络地址，不可使离散的网络（!为取反）</li><li>[!] -d,–dip,–destination:报文的目标地址</li><li>-i,–in-interface : 表示从哪个网卡进入（PREROUTING，INPUT,FORWARD）</li><li>-o,–out-interface : 表示从哪个网卡出去(,OUTPUT,POSTRUTING,FORWARD)</li><li>-p protocol:四层协议，tcp,udp,icmp</li></ul></li><li><p>扩展匹配</p><ul><li><p>隐式扩展</p><ul><li>-p tcp :隐含 -m tcp<ul><li>[!] –source-port ,–sport port [:port] : 匹配报文中的传输层的源端口,连续的端口范围，22，21：22</li><li>[!] –destination-port ,–dport poet [:port] :匹配报文中传输层的目标端口</li><li>[!] –tcp-flags mask comp<ul><li>SYN,ACK,RST,，FIN,URG,PSH</li><li>mask:需要检查的标志位列表，以逗号分隔；</li><li>comp:必须为1的标志列表，余下的出现在mask列表中的标志位则必须为0</li><li>范例:-tcp-flags SYN,ACK,FIN,RST   SYN   表示检查报文tcp首部，syn为1，其余的为0，代表只检查源报文来的第一次握手</li></ul></li><li>[!] –syn : tcp发送报文三次握手的第一次（相当于：–tcp-flags SYN,SCK,FINRST  SYN）</li></ul></li><li>-p udp : 隐含了-m udp:<ul><li>[!] –source-port ,–sport port[:port] :匹配报文中传输层的源端口</li><li>[!] –destination-port,–dport port[:port] :匹配报文中传输层的目标端口</li></ul></li><li>-p icmp(互联网控制协议) ： 隐含了-m udp:<ul><li>[!] –lcmp-type {type[/code]|typename}<ul><li>8 : echo-request回显请求</li><li>0 : echo-reply  回显应答</li></ul></li></ul></li></ul></li><li><p>显示扩展 ； 必须使用-m选项指出matchname(模块),有的match可能存在专用的选项</p><ul><li>1.matchname扩展<br>  以离散的或连续的方式定义多端口匹配条件<ul><li>[!] –source-ports,–sports port[,port|,port:port]…:指定多个源端口,逗号隔开最多制定15个</li><li>[!] –destnation-ports,–dports port[,port|,port:port]…:制定多个目标端口</li><li>[!] –ports port[,port|,port:port]…:指定多个端口</li></ul></li><li>2.iprange扩展<br>  以连续的ip地址范围指明连续的多地址匹配条件</li><li>3.set扩展<br>  依赖于ipset命令行工具<ul><li>set存在的类型：<ul><li>hash:net  : 网络地址的集合</li><li>hash:ip   ：目标ip地址</li></ul></li><li>使用方式：<ul><li>先创建集合 ：ipset create NAMETYPE</li><li>向集合中添加元素 ：ipset add NAMETYPE</li></ul></li></ul></li><li>4.string扩展<br>  对报文的应用层数据做字符串匹配检测<ul><li>[!] –string pattern : 要检测的字符串模式</li><li>[!] –hex-string pattern : 要检测的字符串模式，16进制编码</li><li>–algo {bm|kmp}</li></ul></li><li>5.time扩展<br>  根据报文到达的时间与指定的时间范围进行匹配度检测<ul><li>–datestart YYYY[-MM[-DD]Thh[:mm]:ss]]]]] : 起始日期时间</li><li>–datestop YYYY[-MM[-DD]Thh[:mm]:ss]]]]] : 结束日期时间</li><li>–timestart hh:mm[:ss]</li><li>–timestop  hh:mm[:ss]</li><li>[!] –monthdays day[,day…] ： 每月几号的时间</li><li>[!] –weekdays day[,day…]  ： 每周几的时间</li><li>–kerneltz : 使用内核中的配置的时区</li></ul></li><li><p>6、connlimit扩展<br>  根据每客户端IP做并发连接数匹配；    </p><ul><li>–connlimit-upto n：连接数数量小于等于n，此时应该允许；</li><li>–connlimit-above n：连接数数量大于n，此时应该拒绝；            <ul><li>~]# iptables -A INPUT -d 172.16.100.67 -p tcp –dport 23 -m connlimit –connlimit-upto 2 -j ACCEPT</li></ul></li></ul></li><li><p>7、limit扩展<br>  基于收发报文的速率进行匹配；        </p><ul><li>–limit rate[/second|/minute|/hour|/day]：平均速率</li><li>–limit-burst number：峰值速率</li></ul></li><li><p>8、state扩展<br>  状态检测；连接追踪机制（conntrack）；</p><ul><li>INVALID：无法识别的状态； </li><li>ESTABLISHED：已建立的连接；</li><li>NEW：新连接； </li><li>RELATED：相关联的连接；</li><li><p>UNTRACKED：未追踪的连接；</p><ul><li><p>nf_conntrack内核模块；</p><ul><li>追踪到的连接：/proc/net/nf_conntrack文件中；</li></ul></li><li><p>能追踪的最大连接数量定义在：/proc/sys/net/nf_conntrack_max</p><ul><li>此值可自行定义，建议必要时调整到足够大；</li></ul></li><li><p>不同的协议的连接追踪的时长：</p><ul><li>/proc/sys/net/netfilter/</li></ul></li><li><p>[!] –state STATE</p></li><li><p>如何开放被模式的ftp服务： </p><ul><li>(1) 装载追踪ftp协议的模块；<ul><li># modprobe nf_conntrack_ftp</li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul></li></ul><pre><code>- (2) 放行命令连接    - ~] # iptables -A INPUT -d 172.16.100.67 -p tcp -m state --state ESTABLISHED -j ACCEPT    - ~] # iptables -A INPUT -d 172.16.100.67 -p tcp --dport 21 -m state --state NEW -j ACCEPT- (3) 放行数据连接    - ~] iptables -A INPUT -d 172.16.100.67 -p tcp -m state --state RELATED -j ACCEPT</code></pre><ul><li><p>处理动作target</p><ul><li>DROP : 丢弃</li><li>REJECT : 拒绝</li><li>ACCEPT :  接受</li><li>RETURN : 无匹配的链的时候自动调回</li><li>REDIRECT : 重定向</li><li>SANT : 源地址转换</li><li>DNAT: 目标地址转换</li><li>MASQUERADE : 地址伪装</li><li>LOG : 日志</li><li>自定义链</li></ul></li><li><p>管理机制 ： 两不兼容，最好不要并行</p><ul><li>firewalld : firewalld-cmd</li><li>iptables ： iptables-save,iptables-restore<ul><li>yum install iptables-services<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">每一个内核就是一个扩展  xt开头</span><br><span class="line">[root@centos7 ~]<span class="comment"># cd /lib/modules/3.10.0-862.el7.x86_64/kernel/net/netfilter/</span></span><br><span class="line">[root@centos7 netfilter]<span class="comment"># ls</span></span><br><span class="line">ipset                          xt_connlimit.ko.xz</span><br><span class="line">ipvs                           xt_connmark.ko.xz</span><br><span class="line">nf_conntrack_amanda.ko.xz      xt_CONNSECMARK.ko.xz</span><br><span class="line">nf_conntrack_broadcast.ko.xz   xt_conntrack.ko.xz</span><br><span class="line">nf_conntrack_ftp.ko.xz         xt_cpu.ko.xz</span><br><span class="line">nf_conntrack_h323.ko.xz        xt_CT.ko.xz</span><br><span class="line">nf_conntrack_irc.ko.xz         xt_dccp.ko.xz</span><br><span class="line">nf_conntrack.ko.xz             xt_devgroup.ko.xz</span><br></pre></td></tr></table></figure></li></ul></li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">查看某表中的规则</span><br><span class="line">[root@centos7 ~]<span class="comment"># iptables -t filter -vnL</span></span><br><span class="line"></span><br><span class="line">将某表中的INPUT链计数器置零</span><br><span class="line">[root@centos7 ~]<span class="comment"># iptables -t filter -Z INPUT</span></span><br><span class="line"></span><br><span class="line">规则显示详情</span><br><span class="line">[root@centos7 ~]<span class="comment"># iptables -t filter -vnL</span></span><br><span class="line"> pkts(报文数) bytes(字节数) target（目标）     prot（协议） opt（选项） <span class="keyword">in</span>（报文流入的接口）     out（报文流出的接口）     <span class="built_in">source</span>（源地址）               destination（目标地址）         </span><br><span class="line"></span><br><span class="line">显示iptables表的本文和自己的精确的显示以及行号的显示</span><br><span class="line">[root@centos7 ~]<span class="comment"># iptables -t filter -vxnL --line-numbers</span></span><br><span class="line"></span><br><span class="line">-N 自定义规则链（见名知意）</span><br><span class="line">[root@centos7 ~]<span class="comment"># iptables -N web_rules</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># iptables -vnL</span></span><br><span class="line">Chain web_rules (0 references) 0个引用</span><br><span class="line"> pkts bytes target     prot opt <span class="keyword">in</span>     out     <span class="built_in">source</span>               destination   </span><br><span class="line"></span><br><span class="line">-E 修改自定义的规则链名称（改名通常适用于修改自定义规则连0引用的规则链）</span><br><span class="line">[root@centos7 ~]<span class="comment"># iptables -E web_rules cifs_rules</span></span><br><span class="line"></span><br><span class="line">-X 删除自定义的规则链：计数为0，若不为0 可以将主链中的调用删除再进行清空删除</span><br><span class="line">[root@centos7 ~]<span class="comment"># iptables -F cifs_rules</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># iptables -X cifs_rules</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">内部规则：</span><br><span class="line">    Chain OUTPUT (policy ACCEPT 1 packets, 356 bytes)具有规则链和接收器</span><br></pre></td></tr></table></figure><p>范例：使得iptables定义的规则永久有效<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">命令：内核中定义的规则标准输出至屏幕</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables-save</span></span><br><span class="line">    将标准的输入重定向到文件中</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables-save &gt; /data/iptables.txt</span></span><br><span class="line">    模拟清空防火墙规则</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -F</span></span><br><span class="line">    还原防火墙的规则</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables-restore /data/iptables.txt</span></span><br></pre></td></tr></table></figure></p><p>范例：如何将定义的防火墙规则开机自动生效<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">yum install iptables-services -y</span><br><span class="line"></span><br><span class="line">服务方式管理的iptables</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># /usr/libexec/iptables/iptables.init restrt</span></span><br><span class="line">Usage: iptables &#123;start|stop|reload|restart|condrestart|status|panic|save&#125;</span><br></pre></td></tr></table></figure></p><h2 id="显示扩展"><a href="#显示扩展" class="headerlink" title="显示扩展"></a>显示扩展</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br></pre></td><td class="code"><pre><span class="line">1：multiport显示扩展：匹配多个源、目标端口</span><br><span class="line">    定义入栈规则</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -I INPUT -p tcp -m multiport --dports 21:22,80,139,445</span></span><br><span class="line">    定义出栈规则</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -I OUTPUT -p tcp -m multiport --sports 21:22,80,139,445</span></span><br><span class="line"></span><br><span class="line">    删除入栈规则的第<span class="comment">#条</span></span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -D INPUT #</span></span><br><span class="line"></span><br><span class="line">2：iprange扩展：匹配ip地址的连续范围（仅开放给有限的地址去怕ping）</span><br><span class="line">    入栈</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -I INPUT 4 -p icmp --icmp-type 8 -m iprange --src-range 192.168.10.10-192.168.10.20 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line">    出栈</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -I OUTPUT 4 -p icmp --icmp-type 0 -m iprange --dst-range 192.168.10.10-192.168.10.20 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line">3：<span class="built_in">set</span>扩展:非连续的ip地址，人为定义ip地址集后续调用</span><br><span class="line">    安装</span><br><span class="line">    [root@centos7 ~]<span class="comment"># yum install ipset -y</span></span><br><span class="line">    查看帮助用法</span><br><span class="line">    ipset -h </span><br><span class="line"></span><br><span class="line">    创建集合ip哈希表</span><br><span class="line">    [root@centos7 ~]<span class="comment"># ipset create pinghosts hash:ip  (如果为多个网段hash:net)</span></span><br><span class="line">    [root@centos7 ~]<span class="comment"># ipset list</span></span><br><span class="line">    Name: pinghosts</span><br><span class="line">    Type: <span class="built_in">hash</span>:ip</span><br><span class="line">    Revision: 1</span><br><span class="line">    Header: family inet hashsize 1024 maxelem 65536</span><br><span class="line">    Size <span class="keyword">in</span> memory: 16528</span><br><span class="line">    References: 0</span><br><span class="line">    Members:</span><br><span class="line"></span><br><span class="line">    向集合中添加允许的主机地址</span><br><span class="line">    [root@centos7 ~]<span class="comment"># ipset add pinghosts 192.168.10.10</span></span><br><span class="line">    [root@centos7 ~]<span class="comment"># ipset add pinghosts 192.168.10.20</span></span><br><span class="line">    [root@centos7 ~]<span class="comment"># ipset list</span></span><br><span class="line">    Name: pinghosts</span><br><span class="line">    Type: <span class="built_in">hash</span>:ip</span><br><span class="line">    Revision: 1</span><br><span class="line">    Header: family inet hashsize 1024 maxelem 65536</span><br><span class="line">    Size <span class="keyword">in</span> memory: 16560</span><br><span class="line">    References: 0</span><br><span class="line">    Members:</span><br><span class="line">    192.168.10.20</span><br><span class="line">    192.168.10.10</span><br><span class="line"></span><br><span class="line">    设置规则允许集合表中的主机对本机进行ping</span><br><span class="line">    入栈</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -I INPUT 4 -p icmp --icmp-type 8 -m set --match-set pinghosts src -j ACCEPT</span></span><br><span class="line">    出栈</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -I OUTPUT 4 -p icmp --icmp-type 0 -m set --match-set pinghosts dst -j ACCEPT</span></span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -vnL</span></span><br><span class="line"></span><br><span class="line">4：string扩展：对报文的应用层数据做字符串匹配检测</span><br><span class="line">    假设web网页中的敏感字体进行字符串匹配检测</span><br><span class="line"></span><br><span class="line">    入栈</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -I INPUT -m string --string "敏感字" --algo bm -j REJECT</span></span><br><span class="line">    出栈</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -I OUTPUT -m srting --string "敏感字" --algo bm -j REJECT</span></span><br><span class="line"></span><br><span class="line">多个扩展可一起使用，与的关系，满足所有的条件</span><br><span class="line">time扩展 ： 根据报文到达的时间与指定的时间范围进行匹配度检测</span><br><span class="line"></span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -I INPUT 5 -p icmp --icmp-type 8 -m set --match-set pinghosts src -m time --timestart 08:00:00 --timestop 14:00:00 --weekdays Tue,Thu,Sat --kerneltz -j ACCEPT</span></span><br><span class="line"></span><br><span class="line">5：connlimit扩展：并发连接数限制</span><br><span class="line">    根据每个客户端ip做并发连接数数量匹配，可防止CC攻击。</span><br><span class="line">    --connlimit-upto <span class="comment"># :连接的数量小于等于#时匹配</span></span><br><span class="line">    --connlimit-above <span class="comment"># : 连接的数量大于#时匹配</span></span><br><span class="line">    通常分别与默认的拒绝或允许策略配合使用（默认的意思并非默认规则，而是定义的规则已经有允许，在此基础上做连接数量限制，定义在已经有的允许的规则之前）</span><br><span class="line"></span><br><span class="line">    限制ssh连接本机的连接数限制</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -I INPUT 2 -p tcp --dport 22 -m connlimit --connlimit-above 2 -j REJECT</span></span><br><span class="line"></span><br><span class="line">6：<span class="built_in">limit</span>扩展</span><br><span class="line">    基于收发报文的速度做匹配(报文传输速率限制)</span><br><span class="line">    令牌桶过滤器</span><br><span class="line">    --<span class="built_in">limit</span> <span class="comment"># [/second|/minute|/hour|/day]</span></span><br><span class="line">    --<span class="built_in">limit</span>-burst number</span><br><span class="line"></span><br><span class="line">    允许别人ping自己仅能按照特定的速率进行ping</span><br><span class="line">    出去的速率无需控制，仅控制本机进来的速率</span><br><span class="line">    限制ping速率为每3秒钟一个，限制突发速率为5个</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -I INPUT -p icmp --icmmp-type 8 -s 192.168.52.177 -d 192.168.52.182 -m limit --limit 20/minute --limit-burst 5 -j ACCEPT</span></span><br><span class="line"></span><br><span class="line">7：state状态扩展</span><br><span class="line">    根据“连续追踪机制”去检查连接的状态，较消耗资源</span><br><span class="line">    - conntrack机制：追踪本机上的请求和响应之间的关系</span><br><span class="line">        状态有如下几种：</span><br><span class="line">            - NEW：新发出的请求，连接追踪信息库中不存在此链接的相关信息条目，因此，将其识别为第一次触发的请求（新人）</span><br><span class="line">            - ESTABLISHED:NEW状态之后，连接追踪信息库中为其建立的条目失效之前期间内所进行的通讯状态（熟人）</span><br><span class="line">            - RELATED:新发起的但与已有连接相关的连接，如：ftp协议中的数据连接与命令连接之间的关系（熟人的熟人）</span><br><span class="line">            - INVALID:无效的连接，如flag标记不正确（识别不出的连接）</span><br><span class="line">            - UNTRACKED:未进行的追踪的连接，如raw表中关闭追踪（未追踪的）</span><br><span class="line">            - SNAT:源地址转换</span><br><span class="line">            - DNAT:目标地址转换</span><br><span class="line">    示例： </span><br><span class="line">    iptables -A INPUT -d 172.16.1.10 -p tcp -m multiport --dports 22,80 -m state --state NEW,ESTABLISHED -j ACCEPT </span><br><span class="line">    iptables -A OUTPUT -s 172.16.1.10 -p tcp -m multiport --sports 22,80 -m state --state ESTABLISHED -j ACCEPT </span><br><span class="line">    </span><br><span class="line">    已经追踪到的并记录下来的连接信息库 </span><br><span class="line">    /proc/net/nf_conntrack </span><br><span class="line">    调整连接追踪功能所能够容纳的最大连接数量 </span><br><span class="line"></span><br><span class="line">    /proc/sys/net/nf_conntrack_max </span><br><span class="line">        永久生效修改的所能够容纳的最大的连接数量</span><br><span class="line">        [root@centos7 ~]<span class="comment"># vim /etc/sysctl.d/nf_conntrack_max.conf</span></span><br><span class="line">        net.nf_conntrack_max = 10000000</span><br><span class="line">        [root@centos7 ~]<span class="comment"># sysctl -p /etc/sysctl.d/nf_conntrack_max.conf</span></span><br><span class="line">        net.nf_conntrack_max = 100000</span><br><span class="line">        [root@centos7 ~]<span class="comment"># cat /proc/sys/net/nf_conntrack_max </span></span><br><span class="line">        100000</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    不同的协议的连接追踪时长 /proc/sys/net/netfilter/ </span><br><span class="line">    注意：CentOS7 需要加载模块： modprobe nf_conntrack</span><br><span class="line"></span><br><span class="line">范例：</span><br><span class="line">    允许所有已经连结果的请求入栈出栈</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -A INPUT  -m state --state ESTABLISHED -j ACCEPT</span></span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -A OUTPUT  -m state --state ESTABLISHED -j ACCEPT</span></span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -A INPUT  -p tcp -m multiport --dports 21:22,80 -m state --state NEW -j ACCEPT</span></span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -A OUTPUT ! -i lo -j REJECT</span></span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -A OUTPUT ! -o lo -j REJECT</span></span><br><span class="line"></span><br><span class="line">    服务端开放客户端ftp服务，客户端主动访问服务端，服务端数据端口为随机端口，在客户端添加规则</span><br><span class="line">    [root@centos7 ~]<span class="comment"># iptables -I INPUT 2 -p tcp -m state --state RELATED -j ACCEPT</span></span><br><span class="line">    实现ftp RELATED 需要手动载入一个模块</span><br><span class="line">    [root@centos7 ~]<span class="comment"># modprobe nf_conntrack</span></span><br><span class="line">    [root@centos7 ~]<span class="comment"># modinfo nf_conntrack</span></span><br><span class="line">    [root@centos7 ~]<span class="comment"># lsmod | grep nf_conntrack</span></span><br><span class="line">        手动载入的模块，重启后失效，大量的ftp服务就会被肆意的放行，如何让ftp连接状态iptabless开机继续生效（自动装入模块）</span><br><span class="line">        方法1：</span><br><span class="line">        [root@centos7 ~]<span class="comment"># vim /etc/sysconfig/iptables-config </span></span><br><span class="line">        第六行</span><br><span class="line">        IPTABLES_MODULES=<span class="string">"nf-conntrack_ftp"</span></span><br><span class="line">        方法2：</span><br><span class="line">        [root@centos7 ~]<span class="comment"># vim /etc/sysconfig/modules/nf_conntrack.mudules</span></span><br><span class="line">        <span class="comment">#!/bin/bash</span></span><br><span class="line">        /sbin/modprobe nf_conntrack_ftp</span><br><span class="line">        [root@centos7 ~]<span class="comment"># chmod +x /etc/sysconfig/modules/nf_conntrack.mudules </span></span><br><span class="line">        前提是已经安装启动iptables.services</span><br><span class="line">        [root@centos7 ~]<span class="comment"># systemctl restart iptables</span></span><br><span class="line">        [root@centos7 ~]<span class="comment"># systemctl enable iptables</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;linux防火墙&quot;&gt;&lt;a href=&quot;#linux防火墙&quot; class=&quot;headerlink&quot; title=&quot;linux防火墙&quot;&gt;&lt;/a&gt;linux防火墙&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2018/03/06/linux防火墙/linux防火墙.png&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="iptables防火墙" scheme="https://9527dz.top/categories/iptables%E9%98%B2%E7%81%AB%E5%A2%99/"/>
    
    
      <category term="iptables防火墙" scheme="https://9527dz.top/tags/iptables%E9%98%B2%E7%81%AB%E5%A2%99/"/>
    
  </entry>
  
  <entry>
    <title>旧事-大好河山</title>
    <link href="https://9527dz.top/2017/10/01/%E6%97%A7%E4%BA%8B-%E5%A4%A7%E5%A5%BD%E6%B2%B3%E5%B1%B1/"/>
    <id>https://9527dz.top/2017/10/01/旧事-大好河山/</id>
    <published>2017-10-01T00:00:00.000Z</published>
    <updated>2018-12-17T02:37:16.866Z</updated>
    
    <content type="html"><![CDATA[<script src="//cdn.bootcss.com/jquery/1.11.3/jquery.min.js"></script> <div id="hbe-security"> <div class="input-container"> <input type="password" class="form-control" id="pass" placeholder=" 输入密码,PC:Enter查看,Phone:输入法换行查看. " /> <label for="pass"> 输入密码,PC:Enter查看,Phone:输入法换行查看. </label> <div class="bottom-line"></div> </div> </div> <div id="encrypt-blog" style="display:none"> U2FsdGVkX1+PoNfHPGJecQUxm+Lpa/MQZ/WYzKZm8laQBWfD8Y3HM4GKRu8O63k2Rf75oTHeRVmaEG0ljsu/ll5c7uvHOtzLorMsPcFcF7C3ALWruWRBhY0TL99QstWOi9siiJTwQBBgNybMSOB6Lm7biUdf/xkJUjwzkfodNzinZyp76rGUyejeZD+dzuk6QKotWSHbK+nf4Q+lp6sT9TPpa7UlngdRiXhLPIhRrSnDy3SgJxFZEPZWvl5icXY91rPEiS6qW0YqV/DkvV8It3Sy0Y0WSUkEzFiNngLLFtqmM8CKBoDtecc+U52Ub8zizW764DorJfIxtY2bUDwTFH2ssAf/dM7KIb4rZfbnppXOgQ3fWQ8l/Mzh7L8hfR7R </div><script src="/lib/crypto-js.js"></script><script src="/lib/blog-encrypt.js"></script><link href="/css/blog-encrypt.css" rel="stylesheet" type="text/css">]]></content>
    
    <summary type="html">
    
      &lt;font size=3 color=&quot;#FF0000&quot;&gt;私密文章，需要输入密码.&lt;/font&gt;&lt;/br&gt;
    
    </summary>
    
      <category term="旧事，杂记" scheme="https://9527dz.top/categories/%E6%97%A7%E4%BA%8B%EF%BC%8C%E6%9D%82%E8%AE%B0/"/>
    
    
      <category term="旧事，杂记" scheme="https://9527dz.top/tags/%E6%97%A7%E4%BA%8B%EF%BC%8C%E6%9D%82%E8%AE%B0/"/>
    
  </entry>
  
</feed>
