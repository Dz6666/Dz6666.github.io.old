<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Dai zhe&#39;s notes</title>
  
  <subtitle>Just Du It</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://daizhe.net.cn/"/>
  <updated>2019-02-11T09:18:53.452Z</updated>
  <id>https://daizhe.net.cn/</id>
  
  <author>
    <name>哆啦A梦</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>zabbix自定义监控深入之tcp连接状态监控</title>
    <link href="https://daizhe.net.cn/2019/02/11/zabbix%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7%E6%B7%B1%E5%85%A5%E4%B9%8Btcp%E8%BF%9E%E6%8E%A5%E7%8A%B6%E6%80%81%E5%AE%9E%E6%88%98/"/>
    <id>https://daizhe.net.cn/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/</id>
    <published>2019-02-11T09:15:56.788Z</published>
    <updated>2019-02-11T09:18:53.452Z</updated>
    
    <content type="html"><![CDATA[<h1 id="第二章：zabbix自定义监控深入之tcp连接状态监控"><a href="#第二章：zabbix自定义监控深入之tcp连接状态监控" class="headerlink" title="第二章：zabbix自定义监控深入之tcp连接状态监控"></a>第二章：zabbix自定义监控深入之tcp连接状态监控</h1><p><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/标题.gif" alt=""><br><a id="more"></a></p><h2 id="列表详解实战"><a href="#列表详解实战" class="headerlink" title="列表详解实战"></a>列表详解实战</h2><h3 id="一下实现自定义一个监控项"><a href="#一下实现自定义一个监控项" class="headerlink" title="一下实现自定义一个监控项"></a><code>一下实现自定义一个监控项</code></h3><p>自定义监控项-监控tcp连接ESTABLISHED状态<br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/1.png" alt=""><br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/2.png" alt=""></p><p>server端自定义的监控agent端的监控项的键值默认是不存在的所以要在agent以脚本的形式定义在响应的位置中，这样server端才可以取出agent端对应的键值<br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/3.png" alt=""></p><p>查看定义的应用集<br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/4.png" alt=""></p><p>查看自定义的监控项<br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/5.png" alt=""></p><hr><h2 id="tcp11种状态实战"><a href="#tcp11种状态实战" class="headerlink" title="tcp11种状态实战"></a>tcp11种状态实战</h2><h3 id="实现定义多个监控项即tcp的多种连接状态"><a href="#实现定义多个监控项即tcp的多种连接状态" class="headerlink" title="实现定义多个监控项即tcp的多种连接状态"></a><code>实现定义多个监控项即tcp的多种连接状态</code></h3><p>1.可以在agent定义的脚本的文件中使用传递参数的方式实现</p><p><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/6.png" alt=""></p><p>2.server端验证键值取值方式</p><p><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/7.png" alt=""></p><p>3.zabbix-web界面也修改为监控多中tcp的连接的状态</p><p><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/8.png" alt=""></p><p>4.修改完成后显示不支持的key<br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/9.png" alt=""></p><p>5.快速发现新的键值-缩短发现时长<br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/10.png" alt=""></p><p>6.已经实现监控多个键值监控项<br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/11.png" alt=""></p><p>7.可以点击克隆添加其他tcp连接状态<br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/zzabbix自定义监控深入之tcp连接状态实战/12.png" alt=""></p><p>8.在server-web界面将创建好的应用集中的监控项添加到监控的agent端<br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/13.png" alt=""></p><hr><h3 id="tcp的十一种状态详解"><a href="#tcp的十一种状态详解" class="headerlink" title="tcp的十一种状态详解"></a>tcp的十一种状态详解</h3><ul><li>LISTEN - 侦听来自远方TCP端口的连接请求；</li><li>SYN-SENT -在发送连接请求后等待匹配的连接请求；</li><li>SYN-RECEIVED - 在收到和发送一个连接请求后等待对连接请求的确认；</li><li>ESTABLISHED- 代表一个打开的连接，数据可以传送给用户；</li><li>FIN-WAIT-1 - 等待远程TCP的连接中断请求，或先前的连接中断请求的确认；</li><li>FIN-WAIT-2 - 从远程TCP等待连接中断请求；</li><li>CLOSE-WAIT - 等待从本地用户发来的连接中断请求；</li><li>CLOSING -等待远程TCP对连接中断的确认；</li><li>LAST-ACK - 等待原来发向远程TCP的连接中断请求的确认；</li><li>TIME-WAIT -等待足够的时间以确保远程TCP接收到连接中断请求的确认；</li><li><p>CLOSED - 没有任何连接状态；</p></li><li><p>客户端独有的：（1）SYN_SENT （2）FIN_WAIT1 （3）FIN_WAIT2 （4）CLOSING （5）TIME_WAIT 。</p></li><li>服务端独有的：（1）LISTEN （2）SYN_RCVD （3）CLOSE_WAIT （4）LAST_ACK 。<br>  共有的：（1）CLOSED （2）ESTABLISHED 。</li></ul><h2 id="值映射实战"><a href="#值映射实战" class="headerlink" title="值映射实战"></a>值映射实战</h2><p>1.定义一个检测agent端ssh22 号端口是否开启的监控项（演示监听tcp的22端口是否处于监听状态，使用类型是字符类型–&gt;使用的Server state值映射）<br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/14.png" alt=""></p><p>2.已经添加在此tcp_status应用集<br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/15.png" alt=""></p><p>3.添加触发器<br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/16.png" alt=""><br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/17.png" alt=""><br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/18.png" alt=""></p><p>4.添加报警媒介（如果忘记见第一章节zabbix入门/邮件报警）<br><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/19.png" alt=""></p><h4 id="值映射解释"><a href="#值映射解释" class="headerlink" title="值映射解释"></a>值映射解释</h4><p><img src="/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/20.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;第二章：zabbix自定义监控深入之tcp连接状态监控&quot;&gt;&lt;a href=&quot;#第二章：zabbix自定义监控深入之tcp连接状态监控&quot; class=&quot;headerlink&quot; title=&quot;第二章：zabbix自定义监控深入之tcp连接状态监控&quot;&gt;&lt;/a&gt;第二章：zabbix自定义监控深入之tcp连接状态监控&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/11/zabbix自定义监控深入之tcp连接状态实战/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="zabbix" scheme="https://daizhe.net.cn/categories/zabbix/"/>
    
    
      <category term="zabbix" scheme="https://daizhe.net.cn/tags/zabbix/"/>
    
  </entry>
  
  <entry>
    <title>zabbix自定义监控深入之内存百分比实战</title>
    <link href="https://daizhe.net.cn/2019/02/11/zabbix%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7%E6%B7%B1%E5%85%A5%E4%B9%8B%E5%86%85%E5%AD%98%E7%99%BE%E5%88%86%E6%AF%94%E5%AE%9E%E6%88%98/"/>
    <id>https://daizhe.net.cn/2019/02/11/zabbix自定义监控深入之内存百分比实战/</id>
    <published>2019-02-11T09:15:32.734Z</published>
    <updated>2019-02-12T03:45:30.091Z</updated>
    
    <content type="html"><![CDATA[<h1 id="第二章：zabbix自定义监控深入之内存百分比实战"><a href="#第二章：zabbix自定义监控深入之内存百分比实战" class="headerlink" title="第二章：zabbix自定义监控深入之内存百分比实战"></a>第二章：zabbix自定义监控深入之内存百分比实战</h1><p><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/标题.gif" alt=""><br><a id="more"></a></p><h2 id="取内存的百分比"><a href="#取内存的百分比" class="headerlink" title="取内存的百分比"></a>取内存的百分比</h2><ul><li>取出内存的可用的MB大小 / 总内存的大小 = 实际可用的百分比</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"> ~]<span class="comment"># free -m  （总内存大小）                                              （可用内存的大小）</span></span><br><span class="line">                total        used        free      shared  buff/cache     available</span><br><span class="line">Mem:             1821         548         303           8         970        1029</span><br><span class="line">Swap:            2047           3        2044</span><br><span class="line"></span><br><span class="line">命令行计算实际可用内存的百分比  </span><br><span class="line">  ~]<span class="comment"># echo 1029*100/1821 | bc</span></span><br><span class="line">  56    <span class="comment">#百分之56</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># free -m | awk '/Mem/&#123;print $NF*100/$2&#125;'</span></span><br><span class="line">56.5074</span><br></pre></td></tr></table></figure><p>1.客户端编写监控键值脚本（zabbix-agent）<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/1.png" alt=""></p><p>2.服务端测试查看是否可以通过定义的键值取值<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/2.png" alt=""></p><p>3.zabbix-web端创建监控项<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/3.png" alt=""></p><p>4.查看监控的实际的可用的内存百分比<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/4.png" alt=""></p><p>5.压测zabbix-agent端查看图形是否有变化<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/5.png" alt=""></p><h2 id="图形展示乱码处理"><a href="#图形展示乱码处理" class="headerlink" title="图形展示乱码处理"></a>图形展示乱码处理</h2><p>6.在zabbix-server服务端解决图像化乱码<br>默认的字体文件实际上是软连接<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/6.png" alt=""></p><p>7.zabbix-server将原字体文件备份<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/7.png" alt=""></p><p>8.将windows的字体复制导入到zabbix-server对应的字体目录中<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/8.png" alt=""><br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/9.png" alt=""></p><p>9.刷新zabbix-web查看是否更改成功<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/10.png" alt=""></p><h3 id="第二种解决字体乱码的方式"><a href="#第二种解决字体乱码的方式" class="headerlink" title="第二种解决字体乱码的方式"></a>第二种解决字体乱码的方式</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~] <span class="comment"># yum install wqy-microhei-fonts</span></span><br><span class="line">~] <span class="comment"># cp /usr/share/fonts/wqy-microhei.ttc /usr/share/fonts/dejavu/DejaVuSans.ttf</span></span><br></pre></td></tr></table></figure><h2 id="触发器深入实战"><a href="#触发器深入实战" class="headerlink" title="触发器深入实战"></a>触发器深入实战</h2><ul><li>自定义单条件触发器，设置内存低于30%进行报警</li></ul><p>10.定义触发器当可用内存低于阈值则报警  </p><p><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/11.png" alt=""><br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/12.png" alt=""></p><p>11.查看是否添加成功触发器<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/13.png" alt=""></p><p>12.压低zabbix-agent内存，检测报警邮件<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/14.png" alt=""><br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/15.png" alt=""></p><p>13.调试报警邮箱的动作使用系统内置的变量使得发送的邮箱内容更加详细<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/16.png" alt=""><br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/17.png" alt=""></p><p><code>自定义报警信息和恢复信息</code><br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/25.png" alt=""></p><p>14.重新压测查看发送的邮箱信息内容<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/18.png" alt=""></p><hr><h2 id="实现既监控内存的使用的情况又监控swap的剩余的使用的内存-多条触发器规则"><a href="#实现既监控内存的使用的情况又监控swap的剩余的使用的内存-多条触发器规则" class="headerlink" title="实现既监控内存的使用的情况又监控swap的剩余的使用的内存(多条触发器规则)"></a>实现既监控内存的使用的情况又监控swap的剩余的使用的内存(多条触发器规则)</h2><ul><li><code>内存低于百分之10加上，swap使用超过百分之5，在此进行监控报警（更精准）</code></li></ul><p>1.zabbix-agent客户端编写监控键值脚本<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/19.png" alt=""></p><p>2.zabbix-server服务端测试查看是否可以通过定义的键值取值<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/20.png" alt=""></p><p>3.在zabbix-web端创建监控项<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/21.png" alt=""><br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/22.png" alt=""></p><p>4.在zabbix-web端创建多条件的触发器<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/23.png" alt=""><br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/24.png" alt=""></p><p>5.已经定义多条件的触发器（满足内存低于30%规则，并且同时满足swap使用率超过5%则报警）<br><img src="/2019/02/11/zabbix自定义监控深入之内存百分比实战/26.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;第二章：zabbix自定义监控深入之内存百分比实战&quot;&gt;&lt;a href=&quot;#第二章：zabbix自定义监控深入之内存百分比实战&quot; class=&quot;headerlink&quot; title=&quot;第二章：zabbix自定义监控深入之内存百分比实战&quot;&gt;&lt;/a&gt;第二章：zabbix自定义监控深入之内存百分比实战&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/11/zabbix自定义监控深入之内存百分比实战/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="zabbix" scheme="https://daizhe.net.cn/categories/zabbix/"/>
    
    
      <category term="zabbix" scheme="https://daizhe.net.cn/tags/zabbix/"/>
    
  </entry>
  
  <entry>
    <title>zabbix自定义监控深入之系统内置监控项</title>
    <link href="https://daizhe.net.cn/2019/02/11/zabbix%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7%E6%B7%B1%E5%85%A5%E4%B9%8B%E7%B3%BB%E7%BB%9F%E5%86%85%E7%BD%AE%E7%9B%91%E6%8E%A7%E9%A1%B9/"/>
    <id>https://daizhe.net.cn/2019/02/11/zabbix自定义监控深入之系统内置监控项/</id>
    <published>2019-02-11T03:06:37.560Z</published>
    <updated>2019-02-11T06:03:43.409Z</updated>
    
    <content type="html"><![CDATA[<h1 id="第二章：zabbix自定义监控深入之系统内置监控项"><a href="#第二章：zabbix自定义监控深入之系统内置监控项" class="headerlink" title="第二章：zabbix自定义监控深入之系统内置监控项"></a>第二章：zabbix自定义监控深入之系统内置监控项</h1><p><img src="/2019/02/11/zabbix自定义监控深入之系统内置监控项/标题.gif" alt=""><br><a id="more"></a></p><ul><li>1.所有的主机必须统一监控项<ul><li>nginx.conf,tomcat.conf</li></ul></li><li>2.将监控项进行分类，然后配置不同模板<ul><li>手动一个个的当以监控项–&gt;加入nginx模板</li></ul></li><li>3.不同的主机引用不同模板<ul><li>nginx这台主机–&gt;关联–&gt;nginx模板</li></ul></li></ul><hr><p>系统自带的监控项的意义（zabbix客户端 被动模式）<br><img src="/2019/02/11/zabbix自定义监控深入之系统内置监控项/1.png" alt=""><br><img src="/2019/02/11/zabbix自定义监控深入之系统内置监控项/2.png" alt=""><br><img src="/2019/02/11/zabbix自定义监控深入之系统内置监控项/3.png" alt=""><br><img src="/2019/02/11/zabbix自定义监控深入之系统内置监控项/4.png" alt=""></p><hr><p>如果查看此监控项对用的agent值<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">可以在zabbix-server端查看agent键值</span><br><span class="line"></span><br><span class="line">1.重启agent客户端，验证是否已经添加到监控项</span><br><span class="line">    ~]<span class="comment"># systemctl restart zabbix-agent</span></span><br><span class="line">    ~]<span class="comment"># zabbix_agentd -p | grep IO</span></span><br><span class="line">        IO       [t|2.53]       <span class="comment">#如果此处出现IO       [t| IO commond not found] 表示这个iostat命令未安装</span></span><br><span class="line"></span><br><span class="line">2.zabbix-server验证zabbix-agent是否有对应的监控项</span><br><span class="line">    ~]<span class="comment"># yum install zabbix-get -y</span></span><br><span class="line">    zabbix-get</span><br><span class="line">        -s 指定agent ip地址</span><br><span class="line">        -k 指定定义在agent监控项的名称</span><br><span class="line">        -p 指定agent 端口 ，默认为10050</span><br><span class="line">    ~]<span class="comment"># zabbix_get -s 172.20.139.70 -k IO</span></span><br><span class="line">        2.25</span><br></pre></td></tr></table></figure></p><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">系统自带监控项是有些是支持传递参数的</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># zabbix_get -s 172.20.139.70 -k 'net.tcp.port[&lt;ip&gt;,port]</span></span><br><span class="line">~]<span class="comment"># zabbix_get -s 172.20.139.70 -k 'net.tcp.port[&lt;172.20.139.70&gt;,22]'</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;第二章：zabbix自定义监控深入之系统内置监控项&quot;&gt;&lt;a href=&quot;#第二章：zabbix自定义监控深入之系统内置监控项&quot; class=&quot;headerlink&quot; title=&quot;第二章：zabbix自定义监控深入之系统内置监控项&quot;&gt;&lt;/a&gt;第二章：zabbix自定义监控深入之系统内置监控项&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/11/zabbix自定义监控深入之系统内置监控项/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="zabbix" scheme="https://daizhe.net.cn/categories/zabbix/"/>
    
    
      <category term="zabbix" scheme="https://daizhe.net.cn/tags/zabbix/"/>
    
  </entry>
  
  <entry>
    <title>zabbix自定义监控项之自定义微信报警</title>
    <link href="https://daizhe.net.cn/2019/02/10/zabbix%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E5%BE%AE%E4%BF%A1%E6%8A%A5%E8%AD%A6/"/>
    <id>https://daizhe.net.cn/2019/02/10/zabbix自定义监控之自定义微信报警/</id>
    <published>2019-02-10T12:30:33.873Z</published>
    <updated>2019-02-11T03:09:41.246Z</updated>
    
    <content type="html"><![CDATA[<h1 id="第二章：zabbix自定义监控之自定义微信报警"><a href="#第二章：zabbix自定义监控之自定义微信报警" class="headerlink" title="第二章：zabbix自定义监控之自定义微信报警"></a>第二章：zabbix自定义监控之自定义微信报警</h1><p><img src="/2019/02/10/zabbix自定义监控之自定义微信报警/标题.gif" alt=""><br><a id="more"></a></p><ul><li>企业微信注册</li><li>官方站点：<a href="https://work.weixin.qq.com" target="_blank" rel="noopener">https://work.weixin.qq.com</a></li></ul><ul><li><p>实现企业微信报警</p></li><li><p>1.创建媒体介质类型–&gt;脚本–&gt;写什么内容–&gt;脚本放在哪儿</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">脚本的放置位置在zabbixx-server的配置文件中有定义</span><br><span class="line">    ~]<span class="comment"># vim /etc/zabbix/zabbix_server.conf </span></span><br><span class="line">    516行</span><br><span class="line">    <span class="comment">#定义将脚本放置在此文件中</span></span><br><span class="line">    AlertScriptsPath=/usr/lib/zabbix/alertscripts</span><br></pre></td></tr></table></figure><ul><li><p>weixin.py程序内容 </p><ul><li>1.将此文件配置完成后放置在/usr/lib/zabbix/alertscripts 路径下并添加+x 执行权</li><li>2.执行python脚本需要安装 <ul><li>yum install python-pip</li><li>pip install requests      #python 扩展模块</li></ul></li><li>3.执行脚本./weixin.py weixinID 发送的信息，如果企业微信收到发送的信息，则代表测试成功，成功后会生成一个日志信息/tmp/weixin.log ，需要将此日志文件的所有者和所属组修改为zabbix用户</li></ul></li></ul><p><img src="/2019/02/10/zabbix自定义监控之自定义微信报警/6.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment"># encoding: utf-8</span></span><br><span class="line"><span class="comment"># Create time 2016-10-08</span></span><br><span class="line"><span class="comment">#Auth chenpeng</span></span><br><span class="line">import urllib2</span><br><span class="line">import json</span><br><span class="line">import sys</span><br><span class="line">import time</span><br><span class="line">class WebChat(object):</span><br><span class="line">def __init__(self,CropID,Secret):</span><br><span class="line">self.CropID = CropID</span><br><span class="line">self.Secret = Secret</span><br><span class="line">def Get_Token(self,info):</span><br><span class="line"><span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">:param info: 存储执行结果和执行程序状态码code （0代表执行成功，非零表示不成功）</span></span><br><span class="line"><span class="string">:return:</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span></span><br><span class="line">self.info = info</span><br><span class="line">gurl = <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/gettoken?corpid=%s&amp;corpsecret=%s"</span> % (self.CropID,self.Secret)</span><br><span class="line">try:</span><br><span class="line"><span class="comment">#通过Get方式获取token</span></span><br><span class="line">req = urllib2.Request(gurl)</span><br><span class="line">response = urllib2.urlopen(req)</span><br><span class="line">g_result = json.loads(response.read(),<span class="string">"UTF-8"</span>)</span><br><span class="line"><span class="keyword">if</span> g_result .has_key(<span class="string">'access_token'</span>):</span><br><span class="line">self.info[<span class="string">'result'</span>]= g_result [<span class="string">'access_token'</span>]</span><br><span class="line">self.info[<span class="string">'code'</span>] = 0</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">self.info[<span class="string">'result'</span>] = g_result</span><br><span class="line">self.info[<span class="string">'code'</span>] = 1</span><br><span class="line">except Exception,e:</span><br><span class="line">self.info[<span class="string">'code'</span>] = 1</span><br><span class="line">self.info[<span class="string">'result'</span>] = e</span><br><span class="line">def Send_Msg(self,touser,toparty,agentid,access_token,content,info,*args,**kwargs):</span><br><span class="line"><span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">发送信息到微信</span></span><br><span class="line"><span class="string">:param touser: 部门成员id，zabbix中定义的微信接收者,</span></span><br><span class="line"><span class="string">成员ID列表（消息接收者，多个接收者用‘|'</span>分隔，最多支持1000个）。</span><br><span class="line">特殊情况：指定为@all，则向关注该企业应用的全部成员发送</span><br><span class="line">:param toparty: 部门id，定义了范围，组内成员都可接收到消息,</span><br><span class="line">部门ID列表，多个接收者用‘|<span class="string">'分隔，最多支持100个。当touser为@all时忽略本参数</span></span><br><span class="line"><span class="string">:param agentid: 企业应用的id，整型。可在应用的设置页面查看</span></span><br><span class="line"><span class="string">:param access_token: 根据CropID,Secret获取的访问token值</span></span><br><span class="line"><span class="string">:param content: 滤出zabbix传递的第三个参数,</span></span><br><span class="line"><span class="string">表示发送微信消息的内容消息内容，最长不超过2048个字节，</span></span><br><span class="line"><span class="string">注意：主页型应用推送的文本消息在微信端最多只显示20个字（包含中英文）</span></span><br><span class="line"><span class="string">:param info: 返回执行结果信息&#123;'</span>result<span class="string">':None,'</span>code<span class="string">':None&#125;;'</span>code<span class="string">':0或者非零 ;0表示成功 非零表示失败</span></span><br><span class="line"><span class="string">:param args:</span></span><br><span class="line"><span class="string">:param kwargs:</span></span><br><span class="line"><span class="string">:return:</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span></span><br><span class="line">self.touser = touser</span><br><span class="line">self.toparty = toparty</span><br><span class="line">self.agentid = agentid</span><br><span class="line">self.conntent = content</span><br><span class="line">self.access_token = access_token</span><br><span class="line">self.info = info</span><br><span class="line">purl = <span class="string">"https://qyapi.weixin.qq.com/cgi-bin/message/send?access_token=%s"</span> % (access_token)</span><br><span class="line">data = &#123;</span><br><span class="line"><span class="string">"touser"</span>: <span class="string">""</span>,</span><br><span class="line"><span class="string">"toparty"</span>: <span class="string">""</span>,</span><br><span class="line"><span class="string">"totag"</span>: <span class="string">""</span>, <span class="comment">#标签ID列表，多个接收者用‘|'分隔，最多支持100个。当touser为@all时忽略本参数,非必须</span></span><br><span class="line"><span class="string">"msgtype"</span>: <span class="string">"text"</span>, <span class="comment">#必须</span></span><br><span class="line"><span class="string">"agentid"</span>: <span class="string">""</span>, <span class="comment">#必须</span></span><br><span class="line"><span class="string">"text"</span>: &#123;</span><br><span class="line"><span class="string">"content"</span>: <span class="string">""</span> <span class="comment">#必须</span></span><br><span class="line">&#125;,</span><br><span class="line"><span class="string">"safe"</span>: <span class="string">"0"</span> <span class="comment"># 表示是否是保密消息，0表示否，1表示是，默认0</span></span><br><span class="line">&#125;</span><br><span class="line">data[<span class="string">'touser'</span>] = self.touser</span><br><span class="line">data[<span class="string">'agentid'</span>] = self.agentid</span><br><span class="line">data[<span class="string">'toparty'</span>] = self.toparty</span><br><span class="line">data[<span class="string">'text'</span>][<span class="string">'content'</span>]=self.conntent</span><br><span class="line">data = json.dumps(data,ensure_ascii=False)</span><br><span class="line">try:</span><br><span class="line"><span class="comment">#通过PUT方式获取发送数据</span></span><br><span class="line">req = urllib2.Request(purl, data)</span><br><span class="line">response = urllib2.urlopen(req)</span><br><span class="line">res = json.loads(response.read())</span><br><span class="line">self.info[<span class="string">'code'</span>] = res[<span class="string">'errcode'</span>]</span><br><span class="line">self.info[<span class="string">'result'</span>] = res[<span class="string">'errmsg'</span>]</span><br><span class="line">except Exception,e:</span><br><span class="line">self.info[<span class="string">'result'</span>] = e</span><br><span class="line">self.info[<span class="string">'code'</span>] = 1</span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">reload(sys)</span><br><span class="line">sys.setdefaultencoding(<span class="string">'utf-8'</span>)</span><br><span class="line">def <span class="built_in">log</span>(date, touser, content,info):</span><br><span class="line"><span class="string">''</span><span class="string">'</span></span><br><span class="line"><span class="string">发送的日志打印日志</span></span><br><span class="line"><span class="string">:param date: 时间</span></span><br><span class="line"><span class="string">:param touser: 发送给谁</span></span><br><span class="line"><span class="string">:param content: 发送的信息内容</span></span><br><span class="line"><span class="string">:param info: 发送执行的结果</span></span><br><span class="line"><span class="string">:return:</span></span><br><span class="line"><span class="string">'</span><span class="string">''</span></span><br><span class="line">msg = <span class="string">'%s %s %s 发送结果 - %s\n'</span> % (date, touser, content, info)</span><br><span class="line">with open(<span class="string">'msg.log'</span>, <span class="string">'a'</span>) as f:</span><br><span class="line">f.write(msg)</span><br><span class="line">agentid = sys.argv[1]</span><br><span class="line"><span class="comment">#agentid = 1</span></span><br><span class="line">touser = <span class="string">'xxxxxxx@qq.com'</span></span><br><span class="line">toparty = <span class="string">''</span></span><br><span class="line">content = sys.argv[2:]</span><br><span class="line">content = <span class="string">'\n'</span>.join(content)</span><br><span class="line"><span class="comment">#content = '测试'</span></span><br><span class="line">CropID = <span class="string">'xxxxxxxxxxxxxxxxxxx'</span></span><br><span class="line">Secret = <span class="string">'xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx'</span></span><br><span class="line">info=&#123;<span class="string">'result'</span>:None,<span class="string">'code'</span>:None&#125;</span><br><span class="line">date = time.strftime(<span class="string">'%Y-%m-%d %H:%M:%S'</span>)</span><br><span class="line">res=WebChat(CropID,Secret)</span><br><span class="line">res.Get_Token(info)</span><br><span class="line"><span class="keyword">if</span> info[<span class="string">'code'</span>] == 0:</span><br><span class="line">access_token = info[<span class="string">'result'</span>]</span><br><span class="line">res.Send_Msg(touser=touser, toparty=toparty, agentid=agentid, access_token=access_token,</span><br><span class="line">content=content,info=info)</span><br><span class="line"><span class="keyword">if</span> info[<span class="string">'code'</span>] == 0:</span><br><span class="line">content = <span class="built_in">eval</span>(content)</span><br><span class="line"><span class="built_in">log</span>(date, touser, content,info)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="built_in">log</span>(date, touser, content, info)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line"><span class="built_in">log</span>(date,touser,content,info)</span><br></pre></td></tr></table></figure><ul><li>上面的微信报警已经实现单点发送</li></ul><hr><p>1.创建报警媒介</p><p><img src="/2019/02/10/zabbix自定义监控之自定义微信报警/1.png" alt=""><br><img src="/2019/02/10/zabbix自定义监控之自定义微信报警/2.png" alt=""><br><img src="/2019/02/10/zabbix自定义监控之自定义微信报警/3.png" alt=""></p><p>2.创建报警企业微信接收人</p><p><img src="/2019/02/10/zabbix自定义监控之自定义微信报警/4.png" alt=""><br><img src="/2019/02/10/zabbix自定义监控之自定义微信报警/5.png" alt=""></p><p>3.测试即可</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;第二章：zabbix自定义监控之自定义微信报警&quot;&gt;&lt;a href=&quot;#第二章：zabbix自定义监控之自定义微信报警&quot; class=&quot;headerlink&quot; title=&quot;第二章：zabbix自定义监控之自定义微信报警&quot;&gt;&lt;/a&gt;第二章：zabbix自定义监控之自定义微信报警&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/10/zabbix自定义监控之自定义微信报警/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="zabbix" scheme="https://daizhe.net.cn/categories/zabbix/"/>
    
    
      <category term="zabbix" scheme="https://daizhe.net.cn/tags/zabbix/"/>
    
  </entry>
  
  <entry>
    <title>zabbix自定义监控项之自定义邮件报警</title>
    <link href="https://daizhe.net.cn/2019/02/10/zabbix%E8%87%AA%E5%AE%9A%E4%B9%89%E7%9B%91%E6%8E%A7%E4%B9%8B%E8%87%AA%E5%AE%9A%E4%B9%89%E9%82%AE%E4%BB%B6%E6%8A%A5%E8%AD%A6/"/>
    <id>https://daizhe.net.cn/2019/02/10/zabbix自定义监控之自定义邮件报警/</id>
    <published>2019-02-10T12:26:05.446Z</published>
    <updated>2019-02-11T03:09:33.831Z</updated>
    
    <content type="html"><![CDATA[<h1 id="第二章：zabbix自定义监控之自定义邮件报警"><a href="#第二章：zabbix自定义监控之自定义邮件报警" class="headerlink" title="第二章：zabbix自定义监控之自定义邮件报警"></a>第二章：zabbix自定义监控之自定义邮件报警</h1><p><img src="/2019/02/10/zabbix自定义监控之自定义邮件报警/标题.gif" alt=""><br><a id="more"></a></p><h2 id="自定义邮件报警信息"><a href="#自定义邮件报警信息" class="headerlink" title="自定义邮件报警信息"></a>自定义邮件报警信息</h2><ul><li>当监控项超过触发器设定的阈值–&gt;触发动作–&gt;发送消息|执行动作</li><li>需要考虑到的问题<ul><li>1.怎么报警</li><li>2.报警怎么发</li><li>3.发什么内容</li><li>4.报警发给谁</li></ul></li></ul><p>1.打开动作选项（入门：定义的监控项的数值达到阈值时仅发生 wen界面的报警但并未有处理动作）<br><img src="/2019/02/10/zabbix自定义监控之自定义邮件报警/1.png" alt=""></p><p>2.设定消息发送的介质（邮件/微信）<br><img src="/2019/02/10/zabbix自定义监控之自定义邮件报警/2.png" alt=""><br>3.配置发件人的账号和授权码(注意：不是收件人)<br>使用qq邮箱接收信息开启邮箱一下功能<br><img src="/2019/02/10/zabbix自定义监控之自定义邮件报警/3.png" alt=""><br><img src="/2019/02/10/zabbix自定义监控之自定义邮件报警/4.png" alt=""><br>4.配置收件人接收的邮箱地址<br><img src="/2019/02/10/zabbix自定义监控之自定义邮件报警/5.png" alt=""><br>5.添加收件人的邮箱，以及接受报警的等级<br><img src="/2019/02/10/zabbix自定义监控之自定义邮件报警/6.png" alt=""><br>6.一定要点击更新按钮<br><img src="/2019/02/10/zabbix自定义监控之自定义邮件报警/7.png" alt=""><br>7.测试触发邮箱报警<br>  继续使用入门级的监控agent客户端系统连接数<br><img src="/2019/02/10/zabbix自定义监控之自定义邮件报警/8.png" alt=""><br>  agent端开启三个窗口连接<br><img src="/2019/02/10/zabbix自定义监控之自定义邮件报警/9.png" alt=""><br>  已经触发报警<br><img src="/2019/02/10/zabbix自定义监控之自定义邮件报警/10.png" alt=""><br><img src="/2019/02/10/zabbix自定义监控之自定义邮件报警/12.png" alt=""><br>  邮箱收到报警邮箱<br><img src="/2019/02/10/zabbix自定义监控之自定义邮件报警/11.png" alt="">  </p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;第二章：zabbix自定义监控之自定义邮件报警&quot;&gt;&lt;a href=&quot;#第二章：zabbix自定义监控之自定义邮件报警&quot; class=&quot;headerlink&quot; title=&quot;第二章：zabbix自定义监控之自定义邮件报警&quot;&gt;&lt;/a&gt;第二章：zabbix自定义监控之自定义邮件报警&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/10/zabbix自定义监控之自定义邮件报警/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="zabbix" scheme="https://daizhe.net.cn/categories/zabbix/"/>
    
    
      <category term="zabbix" scheme="https://daizhe.net.cn/tags/zabbix/"/>
    
  </entry>
  
  <entry>
    <title>zabbix入门</title>
    <link href="https://daizhe.net.cn/2019/02/10/zabbix%E5%85%A5%E9%97%A8/"/>
    <id>https://daizhe.net.cn/2019/02/10/zabbix入门/</id>
    <published>2019-02-10T08:42:36.036Z</published>
    <updated>2019-02-10T08:50:03.586Z</updated>
    
    <content type="html"><![CDATA[<h1 id="第一章：zabbix入门"><a href="#第一章：zabbix入门" class="headerlink" title="第一章：zabbix入门"></a>第一章：zabbix入门</h1><p><img src="/2019/02/10/zabbix入门/标题.gif" alt=""><br><a id="more"></a></p><h2 id="监控机基础知识概况"><a href="#监控机基础知识概况" class="headerlink" title="监控机基础知识概况"></a>监控机基础知识概况</h2><ul><li>zabbix并非监控，而是实现监控的工具</li><li>Zabbix-server是一个c/s和b/s结构</li><li>安装zabbbix的服务器安装时和php7.1有冲突：若此机器上已经安装php7.1就安装不上zabbix</li></ul><hr><h2 id="监控知识体系"><a href="#监控知识体系" class="headerlink" title="监控知识体系"></a>监控知识体系</h2><ul><li><p>为什么要使用监控</p><ul><li>1.对系统不间断实时监控</li><li>2.实时反馈系统当前状态</li><li>3.保证服务可靠性安全性</li><li>4.保证业务持续稳定运行</li></ul></li><li><p>监控怎么用，比如我们需要监控磁盘的使用率</p><ul><li>1.如何查看磁盘使用率 （df -h）</li><li>2.监控磁盘的哪些指标 （block、inode）</li><li>3.如何获取具体的信息 （df -h | awk ‘/\/$/{print $(NF-1)}’）</li><li>4.获取的数值到达多少报警 小于等于80%</li></ul></li><li><p>有哪些监控软件</p><ul><li>cacti、nagios、zabbix</li><li>lepus(天兔)数据库监控系统</li><li>open-falcon 小米</li><li>prometheus (普罗米修斯，dcker，k8s)</li></ul></li><li><p>如果去到一家新的公司，如何入手？</p><ul><li>1.硬件监控——路由器、交换机、防火墙</li><li>2.系统监控——cpu、内存、磁盘、网络、进程、tcp</li><li>3.服务监控——nginx、php、tomcat、redis、memcache、mysql</li><li>4.web监控——响应时间、加载时间、渲染时间</li><li>5.日志监控——ELK、（收集、存储、分析、展示）日志</li><li>6.安全监控——firewalld、WAF(nginx+lua)、安全宝、牛盾云、安全狗</li></ul></li></ul><hr><hr><h2 id="zabbix大纲"><a href="#zabbix大纲" class="headerlink" title="zabbix大纲"></a>zabbix大纲</h2><ul><li>0.单机监控</li><li>1.安装zabbix</li><li>2.zabbix基础架构</li><li>3.监控一台主机</li><li>4.自定义监控项  （自己编写脚本-&gt;zabbix）</li><li>5.自定义阈值    （达到预设的瓶颈）</li><li>6.自定义动作  （发邮件|执行命令）</li><li>7.自定义报警</li></ul><hr><hr><h2 id="单机监控"><a href="#单机监控" class="headerlink" title="单机监控"></a>单机监控</h2><ul><li>单机进程cpu查看负载和使用率<ul><li>uptime</li><li>top</li><li>htop</li><li>主要重要的查看项(调度用户&lt;——&gt;系统 ：上下文切换)<ul><li>us:用户空间的使用（小于等于35%）</li><li>sy：内核空间的使用（小于等于35%）<ul><li>查看此进程的用户/内核的使用 <ul><li>time ls</li></ul></li></ul></li><li>id cpu：空闲的cpu使用率（最低不得小于5%）</li></ul></li></ul></li><li>单机内存查看<ul><li>free -m</li></ul></li><li>单机磁盘查看<ul><li>df</li><li>iotop</li><li>iostat</li></ul></li><li><p>单机查看网络</p><ul><li>ifconfig</li><li>iftop -n<ul><li>界面显示的是类似刻度的范围，为显示流量图的长条作标尺用的</li><li>中间的&lt;= =&gt;这两个左右的箭头表示的是流量的方向<ul><li>TX：发送流量</li><li>RX：接收的流量</li><li>TOTAL: 总流量</li><li>Cumm: 运行iftop到目前时间的总流量</li><li>peak: 流量峰值</li><li>rates： 分别表示过去2s 10s 40s 的平均流量</li></ul></li></ul></li><li>nethogs</li><li>netstat <ul><li>-tnlp</li><li>-na</li><li>-rn</li></ul></li></ul></li><li><p><code>glances(可以查看全局的命令)</code></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@example.com ~]<span class="comment"># yum install -y epel-release</span></span><br><span class="line">[root@example.com ~]<span class="comment"># yum install -y glances</span></span><br></pre></td></tr></table></figure></li><li><p>Mbps:  1000Mbps       Mbps / 8 = MB</p></li><li>MB:    12MB</li></ul><hr><h2 id="引入zabbix分布式监控系统"><a href="#引入zabbix分布式监控系统" class="headerlink" title="引入zabbix分布式监控系统"></a>引入zabbix分布式监控系统</h2><p>1.使用shell脚本来监控服务器</p><ul><li>内存：每隔1分钟，当你的可用内存低于100m,发送邮件报警，要求显示剩余内存<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">模拟可用内存低于100m</span><br><span class="line">        临时管理swap（swap硬盘模拟内存）</span><br><span class="line">            swapoff -a （关闭）</span><br><span class="line">            swapon -a (开启)</span><br><span class="line">        消耗内存</span><br><span class="line">            dd <span class="keyword">if</span>=/dev/ser0 of=/dev/null bs=800M</span><br><span class="line">            此时内存全部使用，但是系统不会崩溃，因为linux系当检测到内存全部用完的时候，为了保障系统不会崩溃，从而将使用内存最多的进程杀死（oom）。</span><br><span class="line"></span><br><span class="line">实现步骤：</span><br><span class="line">    1.怎么获取内存的可用值</span><br><span class="line">        ~]<span class="comment"># free -m | awk '/^Mem/&#123;print $NF&#125;'</span></span><br><span class="line">    2.获取到内存可用的值如何设定阈值进行比较</span><br><span class="line">    3.比较如果大于100m则不处理，如果小于100m则报警</span><br><span class="line"></span><br><span class="line">    编写脚本实现取出内存当前的阈值进行比较</span><br><span class="line">    ~]<span class="comment"># !vim</span></span><br><span class="line">    HostName=$(hostname)_$(hostname -i)</span><br><span class="line">    Date=$(date +%F)</span><br><span class="line">    <span class="keyword">while</span> <span class="literal">true</span>;<span class="keyword">do</span></span><br><span class="line">    Free=$(free -m|awk <span class="string">'/^Mem/&#123;print $NF&#125;'</span>)</span><br><span class="line">        <span class="keyword">if</span> [ <span class="variable">$Free</span> -le 100 ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">echo</span> <span class="string">"<span class="variable">$Date</span> <span class="variable">$HostName</span> Mem Is &lt; <span class="variable">$&#123;Free&#125;</span>MB"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">    sleep 1</span><br><span class="line">    <span class="keyword">done</span></span><br><span class="line">    4.如何每隔1分钟执行一次</span><br></pre></td></tr></table></figure></li></ul><hr><p>范例：</p><ul><li>公司未启用swap（swap也是公司中服务器不建议启用的，因为swap是将磁盘模拟内存使用，消耗cpu的性能，建议关闭swap。加大内存），随着客户的流量日益增大，导致将zabbix服务进程强制OOM，<br>Zabbix服务进程被kill，有两种解决的方法，如果公司为了性能着想加大内存，如果公司资有限添加swap,如果是为了服务的效率建议使用添加内存的方式，</li></ul><hr><ul><li>Zabbix-server是一个c/s和b/s结构</li></ul><h2 id="安装zabbix（单机）"><a href="#安装zabbix（单机）" class="headerlink" title="安装zabbix（单机）"></a>安装zabbix（单机）</h2><ul><li><p>官方安装使用手册：<a href="https://www.zabbix.com/documentation/4.0/zh/manual/installation" target="_blank" rel="noopener">https://www.zabbix.com/documentation/4.0/zh/manual/installation</a></p></li><li><p>服务端安装：端口10051 </p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">1.安装</span><br><span class="line">  ~]<span class="comment"># rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm</span></span><br><span class="line"></span><br><span class="line">2.安装Zabbix服务器，前端，代理（zabbix要连接数据库）解决的依赖关系，安装了php、httpd</span><br><span class="line">zabbix-agent ： zabbix客户端</span><br><span class="line">  ~]<span class="comment"># yum install zabbix-server-mysql zabbix-web-mysql zabbix-agent -y</span></span><br><span class="line"></span><br><span class="line">3.安装数据库</span><br><span class="line">  ~]<span class="comment"># yum install mariadb-server -y</span></span><br><span class="line"></span><br><span class="line">4.创建zabbix数据库以及用户</span><br><span class="line">  <span class="comment">#启动数据库，加入开机启动项</span></span><br><span class="line">  ~]<span class="comment"># systemctl start mariadb</span></span><br><span class="line">  ~]<span class="comment"># systemctl enable mariadb</span></span><br><span class="line">  <span class="comment">#创建数据库并授权</span></span><br><span class="line">  ~]<span class="comment"># mysql -uroot</span></span><br><span class="line">  mysql&gt; create database zabbix character <span class="built_in">set</span> utf8 collate utf8_bin;</span><br><span class="line">  mysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by <span class="string">'centos'</span>;</span><br><span class="line">  mysql&gt; quit;</span><br><span class="line"></span><br><span class="line">5.导入初始架构和数据。系统将提示您输入新创建的密码（）</span><br><span class="line">  ~]<span class="comment"># cd /usr/share/doc/zabbix-server-mysql-4.0.4/</span></span><br><span class="line">  <span class="comment">#查看压缩包的内容不解压zcat</span></span><br><span class="line">  <span class="comment">#导入到zabbix库中</span></span><br><span class="line">  zabbix-server-mysql-4.0.4]<span class="comment">#  zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uroot zabbix(zabbix为前面创建的数据库名称)</span></span><br><span class="line"></span><br><span class="line">6.启动zabbix server进程</span><br><span class="line">  <span class="comment">#在zabbix_server.conf中编辑配置数据库配置</span></span><br><span class="line">  ~]<span class="comment"># vim /etc/zabbix/zabbix_server.conf </span></span><br><span class="line">  91行</span><br><span class="line">  <span class="comment"># DBHost=localhost    </span></span><br><span class="line">  <span class="comment">#数据库的地址，这里演示的为单机模式，默认也是localhost</span></span><br><span class="line">  100行</span><br><span class="line">  DBName=zabbix   </span><br><span class="line">  <span class="comment">#数据库的名称，这里演示创建的数据库的名称也为zabbix</span></span><br><span class="line">  116行</span><br><span class="line">  DBUser=zabbix</span><br><span class="line">  <span class="comment">#授权的数据库的用户</span></span><br><span class="line">  124行</span><br><span class="line">  DBPassword=centos</span><br><span class="line">  <span class="comment">#数据库的密码</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#启动前关闭selinux</span></span><br><span class="line">  ~]<span class="comment"># systemctl start zabbix-server</span></span><br><span class="line">  ~]<span class="comment"># systemctl enable zabbix-server</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#保证80端口为安装zabbix时安装的依赖的httpd使用</span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">    *:10051 </span><br><span class="line">    *:3306</span><br><span class="line">    *:80</span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">7.编辑zabbix前端的PHP配置</span><br><span class="line">  <span class="comment">#zabbix前端的apache配置文件位于/etc/httpd/conf.d/zabbix.conf 一些php设置已经完成了配置</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#依据所在的时区，设置时间，更改配置文件后，重启Apache服务器</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/httpd/conf.d/zabbix.conf </span></span><br><span class="line">  Alias /zabbix /usr/share/zabbix   <span class="comment">#如果访问uri路径为/zabbix 则调度到/usr/share/zabbix 路径下，别名意思</span></span><br><span class="line">  &lt;Directory <span class="string">"/usr/share/zabbix"</span>&gt;</span><br><span class="line">    Options FollowSymLinks</span><br><span class="line">    AllowOverride None</span><br><span class="line">    Require all granted</span><br><span class="line"></span><br><span class="line">    &lt;IfModule mod_php5.c&gt;</span><br><span class="line">    ...</span><br><span class="line">  20行修改为(仅一次修改即可)</span><br><span class="line">        php_value date.timezone Asia/Shanghai</span><br><span class="line">    &lt;/IfModule&gt;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart httpd</span></span><br><span class="line">  ~]<span class="comment"># systemctl enable httpd</span></span><br></pre></td></tr></table></figure><p>8.访问zabbix页面<br><img src="/2019/02/10/zabbix入门/1.png" alt=""><br>健康检测<br><img src="/2019/02/10/zabbix入门/1.png" alt=""><br>zabbix_web连接数据库<br><img src="/2019/02/10/zabbix入门/3.png" alt=""><br>zabbix_web连接zabbix_server<br><img src="/2019/02/10/zabbix入门/4.png" alt=""><br>确认配置<br><img src="/2019/02/10/zabbix入门/5.png" alt=""><br>生成的安装配置<br><img src="/2019/02/10/zabbix入门/6.png" alt=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#可以在生成的此文件中，以后更改配置</span></span><br><span class="line"> ~]<span class="comment"># cat /etc/zabbix/web/zabbix.conf.php</span></span><br><span class="line">&lt;?php</span><br><span class="line">// Zabbix GUI configuration file.</span><br><span class="line">global <span class="variable">$DB</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'TYPE'</span>]     = <span class="string">'MYSQL'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'SERVER'</span>]   = <span class="string">'localhost'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'PORT'</span>]     = <span class="string">'0'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'DATABASE'</span>] = <span class="string">'zabbix'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'USER'</span>]     = <span class="string">'zabbix'</span>;</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'PASSWORD'</span>] = <span class="string">'centos'</span>;</span><br><span class="line"></span><br><span class="line">// Schema name. Used <span class="keyword">for</span> IBM DB2 and PostgreSQL.</span><br><span class="line"><span class="variable">$DB</span>[<span class="string">'SCHEMA'</span>] = <span class="string">''</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$ZBX_SERVER</span>      = <span class="string">'localhost'</span>;</span><br><span class="line"><span class="variable">$ZBX_SERVER_PORT</span> = <span class="string">'10051'</span>;</span><br><span class="line"><span class="variable">$ZBX_SERVER_NAME</span> = <span class="string">'代哲的zabbix'</span>;</span><br><span class="line"></span><br><span class="line"><span class="variable">$IMAGE_FORMAT_DEFAULT</span> = IMAGE_FORMAT_PNG;</span><br></pre></td></tr></table></figure></p><p>登陆</p><p><img src="/2019/02/10/zabbix入门/7.png" alt=""></p><p>初始登陆界面<br><img src="/2019/02/10/zabbix入门/8.png" alt=""><br>修改语言<br><img src="/2019/02/10/zabbix入门/9.png" alt=""></p><hr><h2 id="zabbix快速监控一台服务器"><a href="#zabbix快速监控一台服务器" class="headerlink" title="zabbix快速监控一台服务器"></a>zabbix快速监控一台服务器</h2><ul><li><p>监控一台服务器</p><ul><li>此被监控的主机必须安装客户端</li></ul></li><li><p>客户端安装：端口10050</p></li><li><p>zabbix客户端aliyun下载站点：<a href="https://mirrors.aliyun.com/zabbix/zabbix/3.4/rhel/7/x86_64/" target="_blank" rel="noopener">https://mirrors.aliyun.com/zabbix/zabbix/3.4/rhel/7/x86_64/</a></p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">1.被监控的主机安装客户端（zabbix-agent）</span><br><span class="line">  <span class="comment">#被监控的主机，安装zabbix客户端：zabbix-agent</span></span><br><span class="line">  ~]<span class="comment"># rpm -ivh https://mirrors.aliyun.com/zabbix/zabbix/3.4/rhel/7/x86_64/zabbix-agent-3.4.3-1.el7.x86_64.rpm</span></span><br><span class="line"></span><br><span class="line">2.配置客户端（设置允许zabbix_server端的地址，声明此客户端允许那台服务端进行监控）</span><br><span class="line">  ~]<span class="comment"># vim /etc/zabbix/zabbix_agentd.conf </span></span><br><span class="line">  97行（填写server端的ip/主机名）</span><br><span class="line">  Server=192.168.52.202</span><br><span class="line"></span><br><span class="line">3.启动zabbix-agent客户端</span><br><span class="line">  ~]<span class="comment"># systemctl start zabbix-agent</span></span><br><span class="line">  ~]<span class="comment"># systemctl enable zabbix-agent</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  :::10050</span><br></pre></td></tr></table></figure><hr><h3 id="服务端添加监控项，来监控已经安装zabbix-agent的客户端"><a href="#服务端添加监控项，来监控已经安装zabbix-agent的客户端" class="headerlink" title="服务端添加监控项，来监控已经安装zabbix-agent的客户端"></a>服务端添加监控项，来监控已经安装zabbix-agent的客户端</h3><ul><li>1.添加监控的主机</li></ul><p><img src="/2019/02/10/zabbix入门/10.png" alt=""></p><p><img src="/2019/02/10/zabbix入门/11.png" alt=""></p><ul><li>2.查看监控的</li></ul><p><img src="/2019/02/10/zabbix入门/12.png" alt=""></p><hr><h2 id="zabbix基础架构与分离数据库实战"><a href="#zabbix基础架构与分离数据库实战" class="headerlink" title="zabbix基础架构与分离数据库实战"></a>zabbix基础架构与分离数据库实战</h2><h4 id="基础架构"><a href="#基础架构" class="headerlink" title="基础架构"></a>基础架构</h4><ul><li><p>zbbix监控工具的基本架构<br>zabbix-agent—-&gt;zabbix-server—-&gt;数据库&lt;—– zabbix-web<br>数据采集 &ensp;&ensp;&ensp;  &ensp;             数据分析|报警  &ensp;  &ensp;   &ensp;  &ensp;     数据存储   &ensp;  &ensp;  &ensp;      数据展示</p></li><li><p>server端去主动向agent端收取数据</p></li></ul><p><img src="/2019/02/10/zabbix入门/13.png" alt=""></p><h4 id="分离数据实战"><a href="#分离数据实战" class="headerlink" title="分离数据实战"></a>分离数据实战</h4><ul><li>单台：<ul><li>LAMP</li></ul></li><li><p>拆分-架构</p><ul><li>LAP + Mysql</li></ul></li><li><p>单台主机监控性能是有瓶颈的，可以检测的主机也是有限的。</p></li></ul><p>单台–&gt;架构拆分的修改项</p><ul><li>zabbix-server<ul><li>修改zabbix-server连接数据库的连接信息<ul><li>/etc/zabbix/zabbix_server.conf</li></ul></li></ul></li><li>zabbix-web<ul><li>修改zabbix-web连接数据库的连接信息(web界面创建数据库连接界面点击生成)  <ul><li>/etc/zabbix/web/zabbix.conf.php</li></ul></li></ul></li></ul><p>范例：单机–&gt;架构拆分 LAP + MYSQL<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">将原有建立在zabbix-servers上的mariadb的数据库进行打包导入分离开来的新的数据库中</span><br><span class="line"></span><br><span class="line">1.在新的数据库上创建zabbix数据库</span><br><span class="line">    mysql&gt; create database zabbix character <span class="built_in">set</span> utf8 collate utf8_bin;</span><br><span class="line">    mysql&gt; grant all privileges on zabbix.* to zabbix@<span class="string">'%'</span> identified by <span class="string">'centos'</span>;</span><br><span class="line"></span><br><span class="line">2.在旧的zabbix服务器上备份数据库文件，然后导入至新的数据库中</span><br><span class="line">    ~]<span class="comment"># mysqldump -uroot --databases zabbix --single-transaction &gt; `date +%F%H`-zabbix.sql</span></span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># cat 2019-02-1013-zabbix.sql | mysql -h 新的数据库的地址 -uzabbix -pcentos zabbix</span></span><br><span class="line"></span><br><span class="line">3.验证新的数据库是否已经备份旧的数据库的数据</span><br><span class="line">    ~]<span class="comment"># mysql -e "show databases;"</span></span><br><span class="line">    +--------------------+</span><br><span class="line">     Database           |</span><br><span class="line">    +--------------------+</span><br><span class="line">    | information_schema |</span><br><span class="line">    | mysql              |</span><br><span class="line">    | performance_schema |</span><br><span class="line">    | <span class="built_in">test</span>               |</span><br><span class="line">    | zabbix             |</span><br><span class="line">    +--------------------+</span><br><span class="line"></span><br><span class="line">4.修改zabbix-server的数据库连接的配置文件</span><br><span class="line">    ~]<span class="comment"># grep '^[a-Z]' /etc/zabbix/zabbix_server.conf</span></span><br><span class="line">    LogFile=/var/<span class="built_in">log</span>/zabbix/zabbix_server.log</span><br><span class="line">    LogFileSize=0</span><br><span class="line">    PidFile=/var/run/zabbix/zabbix_server.pid</span><br><span class="line">    SocketDir=/var/run/zabbix</span><br><span class="line">    DBHost=新的数据库的ip地址</span><br><span class="line">    DBName=zabbix   <span class="comment">#新的数据库的数据库名称</span></span><br><span class="line">    DBUser=zabbix   <span class="comment">#新的数据库上授权的账号的信息</span></span><br><span class="line">    SNMPTrapperFile=/var/<span class="built_in">log</span>/snmptrap/snmptrap.log</span><br><span class="line">    Timeout=4</span><br><span class="line">    AlertScriptsPath=/usr/lib/zabbix/alertscripts</span><br><span class="line">    ExternalScripts=/usr/lib/zabbix/externalscripts</span><br><span class="line">    LogSlowQueries=3000</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># systemctl restart zabbix-server</span></span><br><span class="line"></span><br><span class="line">5.修改zabbix-web连接数据库信息的配置文件</span><br><span class="line">    ~]<span class="comment"># vim /etc/zabbix/web/zabbix.conf.php</span></span><br><span class="line">    ~]<span class="comment"># systemctl restart httpd</span></span><br></pre></td></tr></table></figure></p><hr><h2 id="zabbix自定义监控实战"><a href="#zabbix自定义监控实战" class="headerlink" title="zabbix自定义监控实战"></a>zabbix自定义监控实战</h2><ul><li><p>iostat</p><ul><li>命令可以对系统的磁盘IO和CPU使用情况进行监控。iostat属于sysstat软件包</li><li><p>常见的选项</p><ul><li>-c 显示CPU使用情况</li><li>-d 显示磁盘使用情况</li><li>-k 以 KB 为单位显示</li><li>-m 以 M 为单位显示</li><li>-N 显示磁盘阵列(LVM) 信息</li><li>-n 显示NFS 使用情况</li><li>-p[磁盘] 显示磁盘和分区的情况</li><li>-t 显示终端和CPU的信息</li><li>-x 显示详细信息</li><li>-V 显示版本信息</li></ul></li><li><p>执行命令可查看的字段信息解释</p><ul><li>%user：用户进程消耗cpu的比例</li><li>%nice：用户进程优先级调整消耗的cpu比例</li><li>%sys：系统内核消耗的cpu比例</li><li>%iowait：等待磁盘io所消耗的cpu比例</li><li>%idle：闲置cpu的比例（不包括等待磁盘io的s）</li><li>tps：该设备每秒的传输次数。“一次传输”意思是“一次I/O请求”。多个逻辑请求被合并为“一次I/O请求”。“一次传输”请求的大小是未知的。</li><li>kB_read/s：每秒从设备（drive expressed）读取的数据量</li><li>kB_wrtn/s：每秒向设备（drive expressed）写入的数据量</li><li>kB_read：读取的总数据量</li><li>kB_wrtn：写入的总数量数据量<ul><li>这些单位都为Kilobytes。</li></ul></li></ul></li><li>常用组合：<ul><li>iostat -k 1 10 或 iostat -m 1 10</li><li>iostat -d -x -k 1 10</li><li>iostart -c 1 10</li></ul></li></ul></li><li><p>定义监控项的要点</p><ul><li><p>1.监控的系统中的对象</p><ul><li>iostat | awk ‘/^sda/{print $2}’</li></ul></li><li><p>2.如何增加监控项</p><ul><li><code>Userparameter=&lt;监控项名称&gt;,&lt;监控项所指定的命令&gt;</code>(固定格式)</li></ul></li><li><p>3.agetnt如何验证自己是否有对应的监控项并取值</p><ul><li>~]# zabbix_agentd -p | grep</li></ul></li><li><p>4.zabbix-server如何验证zabbix-agent是否有对应的监控项</p><ul><li>zabbix-get</li></ul></li><li>5.zabbixweb界面进行关联zabbix-agent监控项</li></ul></li></ul><h5 id="范例：自定义监控的磁盘IO的，每秒传输次数"><a href="#范例：自定义监控的磁盘IO的，每秒传输次数" class="headerlink" title="范例：自定义监控的磁盘IO的，每秒传输次数"></a>范例：自定义监控的磁盘IO的，每秒传输次数</h5><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">要想使得zabbix-server端主动去收集zabbix-agent端的指定的数据信息，需要在zabbix-agent定义监控的系统对象</span><br><span class="line"></span><br><span class="line">zabbix-agnet端的配置文件中包含了一些定义的配置文件的位置可以将监控的系统对象写在此包含的文件中</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># vim /etc/zabbix/zabbix_agentd.conf </span></span><br><span class="line">Include=/etc/zabbix/zabbix_agentd.d/*.conf</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">1.zabbix-agent监控的系统中的对象</span><br><span class="line">        - iostat | awk <span class="string">'/^sda/&#123;print $2&#125;'</span></span><br><span class="line"></span><br><span class="line">2.在zabbix-agent端定义监控磁盘IO每秒传输的速率</span><br><span class="line">    ~]<span class="comment"># vim /etc/zabbix/zabbix_agentd.d/iostart.conf</span></span><br><span class="line">    UserParameter=IO,iostat | awk <span class="string">'/^sda/&#123;print $2&#125;'</span></span><br><span class="line"></span><br><span class="line">3.重启agent客户端，验证是否已经添加到监控项</span><br><span class="line">    ~]<span class="comment"># systemctl restart zabbix-agent</span></span><br><span class="line">    ~]<span class="comment"># zabbix_agentd -p | grep IO</span></span><br><span class="line">        IO       [t|2.53]       <span class="comment">#如果此处出现IO       [t| IO commond not found] 表示这个iostat命令未安装</span></span><br><span class="line"></span><br><span class="line">4.zabbix-server验证zabbix-agent是否有对应的监控项</span><br><span class="line">    ~]<span class="comment"># yum install zabbix-get -y</span></span><br><span class="line">    zabbix-get</span><br><span class="line">        -s 指定agent ip地址</span><br><span class="line">        -k 指定定义在agent监控项的名称</span><br><span class="line">        -p 指定agent 端口 ，默认为10050</span><br><span class="line">    ~]<span class="comment"># zabbix_get -s 172.20.139.70 -k IO</span></span><br><span class="line">        2.25</span><br></pre></td></tr></table></figure><p>5.zabbixweb界面进行关联zabbix-agent监控项<br>图1<br><img src="/2019/02/10/zabbix入门/14.png" alt=""><br>图2<br><img src="/2019/02/10/zabbix入门/15.png" alt=""><br>图3<br><img src="/2019/02/10/zabbix入门/16.png" alt=""></p><h2 id="zabbix自定义监控阈值实战"><a href="#zabbix自定义监控阈值实战" class="headerlink" title="zabbix自定义监控阈值实战"></a>zabbix自定义监控阈值实战</h2><ul><li>监控项检测到监控的数据达到一个阈值则触发报警信息</li></ul><hr><h3 id="系统默认监控agent中-etc-passwd文件发生变化报警"><a href="#系统默认监控agent中-etc-passwd文件发生变化报警" class="headerlink" title="系统默认监控agent中/etc/passwd文件发生变化报警"></a><code>系统默认监控agent中/etc/passwd文件发生变化报警</code></h3><p>1.缩短检测/etc/passwd文件的时长方便检测<br><img src="/2019/02/10/zabbix入门/17.png" alt=""><br>2.开启报警<br><img src="/2019/02/10/zabbix入门/18.png" alt=""><br>3.在客户端修改/etc/passwd文件触发报警（web页面报警）<br><img src="/2019/02/10/zabbix入门/19.png" alt=""><br><img src="/2019/02/10/zabbix入门/20.png" alt=""></p><hr><h3 id="针对系统默认监控的系统主机登陆的终端个数来定义报警"><a href="#针对系统默认监控的系统主机登陆的终端个数来定义报警" class="headerlink" title="针对系统默认监控的系统主机登陆的终端个数来定义报警"></a><code>针对系统默认监控的系统主机登陆的终端个数来定义报警</code></h3><p><img src="/2019/02/10/zabbix入门/21.png" alt=""></p><p>1.定义触发器，如果系统登陆的终端如果大于2则触发报警信息<br><img src="/2019/02/10/zabbix入门/22.png" alt=""><br><img src="/2019/02/10/zabbix入门/23.png" alt=""></p><p>2.查看定义的监控项<br><img src="/2019/02/10/zabbix入门/24.png" alt=""><br>3.触发监控的报警<br><img src="/2019/02/10/zabbix入门/25.png" alt=""><br>4.已经收到报警<br><img src="/2019/02/10/zabbix入门/26.png" alt=""></p><hr>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;第一章：zabbix入门&quot;&gt;&lt;a href=&quot;#第一章：zabbix入门&quot; class=&quot;headerlink&quot; title=&quot;第一章：zabbix入门&quot;&gt;&lt;/a&gt;第一章：zabbix入门&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/10/zabbix入门/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="zabbix" scheme="https://daizhe.net.cn/categories/zabbix/"/>
    
    
      <category term="zabbix" scheme="https://daizhe.net.cn/tags/zabbix/"/>
    
  </entry>
  
  <entry>
    <title>keepalived使用基础</title>
    <link href="https://daizhe.net.cn/2019/02/04/keepalived%E4%BD%BF%E7%94%A8%E5%9F%BA%E7%A1%80/"/>
    <id>https://daizhe.net.cn/2019/02/04/keepalived使用基础/</id>
    <published>2019-02-04T08:37:37.710Z</published>
    <updated>2019-02-04T09:02:13.117Z</updated>
    
    <content type="html"><![CDATA[<h1 id="keepalived使用基础"><a href="#keepalived使用基础" class="headerlink" title="keepalived使用基础"></a>keepalived使用基础</h1><p><img src="/2019/02/04/keepalived使用基础/标题.gif" alt=""><br><a id="more"></a></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;keepalived使用基础&quot;&gt;&lt;a href=&quot;#keepalived使用基础&quot; class=&quot;headerlink&quot; title=&quot;keepalived使用基础&quot;&gt;&lt;/a&gt;keepalived使用基础&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/04/keepalived使用基础/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="keepalived" scheme="https://daizhe.net.cn/categories/keepalived/"/>
    
    
      <category term="keepalived" scheme="https://daizhe.net.cn/tags/keepalived/"/>
    
  </entry>
  
  <entry>
    <title>keepalived简介</title>
    <link href="https://daizhe.net.cn/2019/01/28/keepalived%E7%AE%80%E4%BB%8B/"/>
    <id>https://daizhe.net.cn/2019/01/28/keepalived简介/</id>
    <published>2019-01-28T08:36:32.931Z</published>
    <updated>2019-02-04T09:26:18.188Z</updated>
    
    <content type="html"><![CDATA[<h1 id="keepalived简介"><a href="#keepalived简介" class="headerlink" title="keepalived简介"></a>keepalived简介</h1><p><img src="/2019/01/28/keepalived简介/标题.gif" alt=""><br><a id="more"></a></p><ul><li>HA 即（high available）高可用，又被叫做双机热备，用于关键性业务（冗余）。</li></ul><h2 id="高可用集群概念"><a href="#高可用集群概念" class="headerlink" title="高可用集群概念"></a>高可用集群概念</h2><ul><li>集群类型：<ul><li>LB     lvs/nginx（http/upstream, stream/upstream）</li><li>HA     高可用性（多适用于接入层的高可用）<ul><li>SPoF: Single Point of Failure，单点故障</li></ul></li><li>HPC    高性能集群(High Performance Computing)</li></ul></li><li><code>系统可用性：SLA(Service-Level Agreement)</code><ul><li>95%=(60<em>24</em>30)*(1-0.9995)</li><li>（指标）=99%, …, 99.999%，99.9999%</li></ul></li><li><p>系统故障：</p><ul><li>硬件故障：设计缺陷、wear out（损耗）、自然灾害……</li><li>软件故障：设计缺陷</li></ul></li><li><p>提升系统高用性的解决方案之降低MTTR(平均故障时间)</p><ul><li>解决方案：建立冗余机制<ul><li>active/passive    主/备</li><li>active/active    双主 </li><li>active –&gt; HEARTBEAT（心跳检测机制判断对方是否存活） –&gt; passive </li><li>active <--> HEARTBEAT <--> active</--></--></li></ul></li></ul></li><li><p>高可用的是“服务”</p><ul><li>HA nginx service：<ul><li>vip/nginx process[/shared storage]</li></ul></li><li>资源：组成一个高可用服务的“组件”<ul><li>(1) passive node的数量（从节点的数量）</li><li>(2) 资源切换（ip地址的切换或者说是服务的切换）</li></ul></li></ul></li><li><p>shared storage：共享存储</p><ul><li>NAS(Network Attached Storage)：网络附加存储，基于网络的共享文件系统。<ul><li>SAN(Storage Area Network)：存储区域网络，基于网络的块级别的共享    </li></ul></li></ul></li><li><p>Network partition：网络分区</p><ul><li>quorum：法定人数<ul><li>with quorum： &gt; total/2（剩余存活的节点一定是大于总节点的一半的）<ul><li>without quorum: &lt;= total/2（故障节点的数量，一定要小于总节点的一半）    </li></ul></li></ul></li><li>隔离设备： fence <ul><li>node：STONITH = Shooting The Other Node In The Head<ul><li>断电重启</li></ul></li><li>资源：断开存储的连接    </li></ul></li></ul></li><li><p>双节点集群(TWO nodes Cluster)</p><ul><li>辅助设备：ping node, quorum disk(仲裁设备)</li><li>Failover：故障切换，即某资源的主节点故障时，将资源转移至其它节点的操作</li><li>Failback：故障移回，即某资源的主节点故障后重新修改上线后，将之前已转移至其它节点的资源重新切回的过程</li></ul></li><li><p>HA Cluster实现方案:</p><ul><li>AIS(Applicaiton Interface Specification)应用程序接口规范        <ul><li>RHCS：Red Hat Cluster Suite红帽集群套件<ul><li>heartbeat：基于心跳监测实现服务高可用</li><li>pacemaker+corosync：资源管理与故障转移</li></ul></li><li><code>vrrp(Virtual Router Redundancy Protocol)：虚拟路由冗余协议,解决静态网关单点风险</code><ul><li>软件层—keepalived</li><li>物理层—路由器、三层交换机、防火墙</li></ul></li></ul></li></ul></li></ul><hr><h2 id="高可用集群-gt-后端存储"><a href="#高可用集群-gt-后端存储" class="headerlink" title="高可用集群-&gt;后端存储"></a>高可用集群-&gt;后端存储</h2><p><img src="/2019/01/28/keepalived简介/存储.png" alt=""></p><hr><h2 id="高可用集群-gt-后端存储-1"><a href="#高可用集群-gt-后端存储-1" class="headerlink" title="高可用集群-&gt;后端存储"></a>高可用集群-&gt;后端存储</h2><ul><li>JBOD （ Just a Bunch Of Disks ）不是标准的 RAID 等级，它通常用来表示一个没有控制软件提供协调控制的磁盘集合， JBOD 将多个物理磁盘串联起来，提供一个巨大的逻辑磁盘， JBOD 的数据存放机制是由第一块磁盘开始按顺序往后存储，当前磁盘存储空间用完后，再依次往后面的磁盘存储数据， JBOD 存储性能完全等同于单块磁盘，而且也不提供数据安全保护，它只是简单提供一种扩展存储空间的机制， JBOD 可用存储容量等于所有成员磁盘的存储空间之和。</li></ul><p><img src="/2019/01/28/keepalived简介/1.png" alt=""></p><h2 id="高可用集群-gt-网络层实现高可用（VRRP）"><a href="#高可用集群-gt-网络层实现高可用（VRRP）" class="headerlink" title="高可用集群-&gt;网络层实现高可用（VRRP）"></a>高可用集群-&gt;网络层实现高可用（VRRP）</h2><p><img src="/2019/01/28/keepalived简介/4.png" alt=""></p><h2 id="Keepalived简介"><a href="#Keepalived简介" class="headerlink" title="Keepalived简介"></a>Keepalived简介</h2><ul><li><code>Keepalived软件主要是通过VRRP协议实现高可用功能的。VRRP是Virtual Router RedundancyProtocol(虚拟路由器冗余协议）的缩写，VRRP出现的目的就是为了解决静态路由单点故障问题的，它能够保证当个别节点宕机时，整个网络可以不间断地运行。</code></li><li>重要作用<ul><li>管理LVS负载均衡软件</li><li>实现LVS集群节点的健康检查中</li><li>作为系统网络服务的高可用性（failover）</li></ul></li></ul><hr><ul><li>keepalived:<ul><li>vrrp协议的软件实现，原生设计目的为了高可用ipvs服务</li></ul></li><li>功能：<ul><li>基于vrrp协议完成地址流动</li><li>为vip地址所在的节点生成ipvs规则(在配置文件中预先定义)</li><li>为ipvs集群的各RS做健康状态检测</li><li>基于脚本调用接口通过执行脚本完成脚本中定义的功能，进而影响集群事务，以此支持nginx、haproxy等服务</li></ul></li><li>组件：<ul><li>用户空间核心组件：<ul><li>vrrp stack-VIP消息通告</li><li>checkers-监测real server</li><li>system call-标记real server权重</li><li>SMTP-邮件组件</li><li>ipvs wrapper-生成IPVS规则</li><li>Netlink Reflector-网络接口<ul><li>WatchDog-监控进程</li></ul></li></ul></li><li>控制组件：配置文件分析器</li><li>IO复用器</li><li>内存管理组件</li></ul></li></ul><p><img src="/2019/01/28/keepalived简介/3.png" alt=""></p><ul><li>官方站点：<a href="http://keepalived.org/index.html" target="_blank" rel="noopener">http://keepalived.org/index.html</a></li><li>官方参考手册：<a href="http://keepalived.org/documentation.html" target="_blank" rel="noopener">http://keepalived.org/documentation.html</a></li><li>DOWNLOAD:<a href="http://keepalived.org/download.html" target="_blank" rel="noopener">http://keepalived.org/download.html</a></li></ul><hr><h2 id="keepalived："><a href="#keepalived：" class="headerlink" title="keepalived："></a>keepalived：</h2><ul><li>vrrp协议：Virtual Router Redundancy Protocol（keepalived基于此协议实现ip地址的高可用）</li></ul><ul><li>术语：<ul><li>虚拟路由器：Virtual Router </li><li>虚拟路由器标识：VRID(0-255)优先级，唯一标识虚拟路由器</li><li>物理路由器：<ul><li>master：主设备</li><li>backup：备用设备</li><li>priority：优先级（优先级数值越大，优先级越高）</li></ul></li><li>VIP：Virtual IP </li><li>VMAC：Virutal MAC (00-00-5e-00-01-VRID)：虚拟mac地址</li></ul></li></ul><hr><ul><li>通告：心跳，优先级等，周期性</li><li>工作方式：抢占式，非抢占式</li><li><p>安全工作：</p><ul><li>认证：<ul><li>无认证</li><li>简单字符认证：预共享密钥</li></ul></li></ul></li><li><p>工作模式：</p><ul><li>主/备：单虚拟路由器</li><li>主/主：主/备（虚拟路由器1），备/主（虚拟路由器2）</li></ul></li></ul><hr><h2 id="vrrp协议的工作流程"><a href="#vrrp协议的工作流程" class="headerlink" title="vrrp协议的工作流程"></a>vrrp协议的工作流程</h2><ul><li><p>vrrp（虚拟路由冗余协议）是一种容错协议，他保证当主机的吓一跳路由器出现故障时，由另一台路由器来代替出现故障的路由器进行工作，从而保持网络通讯的连续性和可靠性。</p></li><li><p>vrrp具有如下优点：</p><ul><li>简化网络管理。在具有多播或广播能力的局域网（如以太网）中，借助vrrp能在某台设备出现故障时仍然提供高可靠的缺省链路，有效避免单一链路发生的故障后网络终端的问题，而无需修改动态路由协议，路由发现协议等配置信息，也无需修改主机的默认的网关配置。</li><li>适应性强。vrrp报文封装在ip报文中，支持各种上层协议。</li><li>网络开销小，vrrp只定义了一种报文—vrrp通告报文，并且只有处于master状态的路由器可以发送vrrp报文</li></ul></li></ul><h2 id="vrrp协议中的相关的术语"><a href="#vrrp协议中的相关的术语" class="headerlink" title="vrrp协议中的相关的术语"></a>vrrp协议中的相关的术语</h2><ul><li>虚拟路由器：由一个master路由器和多个backup路由器组成，主机将虚拟路由器当作默认网关。</li><li>vrid：虚拟路由器的标识，有相同vrid的一组路由器构成一个虚拟路由器。</li><li>master路由器：虚拟路由器中承担报文转发任务的路由器。</li><li>backup路由器：master路由器出现故障时，能够代替master路由器工作的路由器。</li><li>虚拟ip地址：虚拟路由器的ip地址，一个虚拟路由器可以拥有一个或者多个ip地址。</li><li>ip地址拥有者：接口ip地址与虚拟ip地址相同的路由器被称之为ip地址拥有者。</li><li>虚拟mac地址：一个虚拟路由器拥有一个虚拟mac地址。虚拟mac地址的合适为00-00-5E-00-01-{VRID}。通常情况下，虚拟路由器回应ARP请求使用的时虚拟MAC地址，只有虚拟路由器做特殊配置的时候，才会赢接口的真实的MAC地址。</li><li>优先级：VRRP根据优先级来确定虚拟路由器中每台路由器的地位。</li><li>非抢占方式：如果backup路由器工作在非抢占方式下，则只要master路由器没有出现故障，backup路由器即使随后被配置了更高的优先级也不会为master路由器。</li><li>抢占方式：如果backup路由器工作在抢占方式下，当它收到vrrp报文后，会将自己的优先级与通告报文中的优先级进行比较。如果自己的优先级比当前master路由器的优先级高，就会主动抢占成为master路由器；否则，将保持backup状态。</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;keepalived简介&quot;&gt;&lt;a href=&quot;#keepalived简介&quot; class=&quot;headerlink&quot; title=&quot;keepalived简介&quot;&gt;&lt;/a&gt;keepalived简介&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/01/28/keepalived简介/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="keepalived" scheme="https://daizhe.net.cn/categories/keepalived/"/>
    
    
      <category term="keepalived" scheme="https://daizhe.net.cn/tags/keepalived/"/>
    
  </entry>
  
  <entry>
    <title>HAproxyACL</title>
    <link href="https://daizhe.net.cn/2019/01/24/HAproxyACL/"/>
    <id>https://daizhe.net.cn/2019/01/24/HAproxyACL/</id>
    <published>2019-01-24T04:12:51.101Z</published>
    <updated>2019-02-02T08:18:37.834Z</updated>
    
    <content type="html"><![CDATA[<h1 id="HAproxy的ACL过滤器及自定义错误页"><a href="#HAproxy的ACL过滤器及自定义错误页" class="headerlink" title="HAproxy的ACL过滤器及自定义错误页"></a>HAproxy的ACL过滤器及自定义错误页</h1><p><img src="/2019/01/24/HAproxyACL/标题.gif" alt=""><br><a id="more"></a></p><h2 id="一、ACL过滤器（七层http模式下）"><a href="#一、ACL过滤器（七层http模式下）" class="headerlink" title="一、ACL过滤器（七层http模式下）"></a>一、ACL过滤器（七层http模式下）</h2><ul><li><p>acl：对接收到的报文进行匹配和过滤，基于请求报文头部中的源地址、源端口、目标地址、目标端口、请求方法、URL、文件后缀等信息内容进行匹配并执行进一步操作（基于类型的调度决策）。</p><ul><li><code>acl &lt;aclname&gt;  &lt;criterion&gt;   [flags]           [operator]        [&lt;value&gt;]</code></li><li>acl   &ensp;&ensp;   名称    &ensp;&ensp;&ensp;&ensp;          过滤条件   &ensp;&ensp; &ensp;&ensp;     条件标记位   &ensp;&ensp;   具体操作符   &ensp;&ensp;   操作对象类型</li></ul></li><li><p>acl   image_service hdr_dom(host)   -i   img.daizhe.net.cn</p><ul><li>hdr_dom(host)：客户端请求的头部的域名<ul><li>用hots做匹配条件的好处，可以将ip地址复用，对一个ip进行监听，当用户请求进行请求时，可以将一个地址对应多个A记录解析的域名（一个ip地址监听多个公网的域名）。</li></ul></li><li>hdr_dom(User-Agent) ：客户端请求使用的浏览器的类型<ul><li>可以根据客户使用的类型，将客户发来的请求做处理转发。调度器转发后其他后端的提供服务的服务器上。</li></ul></li></ul></li><li>ACL名称，可以使用大字母A-Z、小写字母a-z、数字0-9、冒号：、点.、中横线和下划线，并且严格区分大小写，必须Image_site和image_site完全是两个acl(严格区分大小写)。</li></ul><h4 id="Criterion-ACL-定义ACL标准"><a href="#Criterion-ACL-定义ACL标准" class="headerlink" title="Criterion_ACL(定义ACL标准)"></a>Criterion_ACL(定义ACL标准)</h4><ul><li><p><code>&lt;criterion&gt; ：匹配条件</code></p><ul><li><code>dst         目标IP</code></li><li><code>dst_port       目标PORT</code></li><li><code>src            源IP</code></li><li><code>src_port      源PORT</code></li></ul></li><li><p><code>hdr &lt;string&gt;用于测试请求头部首部指定内容</code></p><ul><li><code>hdr_dom(host)  请求的host名称，如 www.daizhe.net.cn</code></li><li><code>hdr_beg(host)  请求的host开头，如 www. img. video. download. ftp.</code></li><li><code>hdr_end(host)  请求的host结尾，如 .com .net .cn</code></li><li><code>path_beg   请求的URL开头，如/static、/images、/img、/css</code></li><li><code>path_end   请求的URL中资源的结尾，如 .gif  .png  .css  .js .jpg .jpeg</code></li></ul></li></ul><h4 id="flags（条件标记位）"><a href="#flags（条件标记位）" class="headerlink" title="flags（条件标记位）"></a>flags（条件标记位）</h4><ul><li><code>&lt;flags&gt;-条件标记</code><ul><li>-i 不区分大小写(域名经过haproxy调度时不区分域名的字符大小写)</li><li>-m 使用指定的pattern匹配方法</li><li>-n 不做DNS解析<ul><li>-u 禁止acl重名，否则多个同名ACL匹配或关系(调度器上定义acl的名称尽量不要重名，如果有重名，默认隐含的是或的关系)</li><li>–  强制flag结束. 当字符串和某个flag相似时使用</li></ul></li></ul></li></ul><h4 id="operator（具体操作符）"><a href="#operator（具体操作符）" class="headerlink" title="operator（具体操作符）"></a>operator（具体操作符）</h4><ul><li>[operator]-操作符：<ul><li>整数比较：eq、ge、gt、le、lt<br>字符比较：</li><li>exact match     (-m str) :字符串必须完全匹配模式</li><li>substring match (-m sub) :在提取的字符串中查找模式，如果其中任何一个被发现，ACL将匹配</li><li>prefix match    (-m beg) :在提取的字符串首部中查找模式，如果其中任何一个被发现，ACL将匹配</li><li>suffix match    (-m end) :将模式与提取字符串的尾部进行比较，如果其中任何一个匹配，则ACL进行匹配</li><li>subdir match    (-m dir) :查看提取出来的用斜线分隔（“/”）的字符串，如果其中任何一个匹配，则ACL进行匹配</li><li>domain match    (-m dom) :查找提取的用点（“.”）分隔字符串，如果其中任何一个匹配，则ACL进行匹配    </li></ul></li></ul><h4 id="value（操作对象类型）"><a href="#value（操作对象类型）" class="headerlink" title="value（操作对象类型）"></a>value（操作对象类型）</h4><ul><li><code>&lt;value&gt;的类型：</code><ul><li>Boolean #布尔值</li><li>integer or integer range #整数或整数范围，比如用于匹配端口范围</li><li>IP address / network #IP地址或IP范围</li><li>string    （字符串的方式制定域名）</li><li>exact –精确比较</li><li>substring—子串    </li><li>prefix-前缀比较</li><li>subdir-路径， /wp-includes/js/jquery/jquery.js    #匹配子路径</li><li>domain-域名，daizhe.net.cn</li><li>regular expression  #正则表达式</li><li>hex block   #16进制</li></ul></li></ul><h2 id="Acl定义与调用"><a href="#Acl定义与调用" class="headerlink" title="Acl定义与调用"></a>Acl定义与调用</h2><ul><li><p>acl作为条件时的逻辑关系：</p><ul><li>与：隐式（默认）使用</li><li>或：使用“or” 或 “||”表示</li><li>否定：使用“!“ 表示    </li></ul></li><li><p>示例：</p><ul><li>if   invalid_src invalid_port      与关系</li><li>if invalid_src || invalid_port      或<ul><li>if ! invalid_src             非</li></ul></li></ul></li></ul><p><code>范例：调度器拒绝192.16.52.175的主机访问即调度器检测到此地址段的主机则不今次那个调度到后端的主机上</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">haproxy_server</span><br><span class="line">    ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line">    frontend web-port-80</span><br><span class="line">        mode http</span><br><span class="line">        rspadd X-Via:\ HAPorxy</span><br><span class="line">        default_backend websrvs</span><br><span class="line">        <span class="built_in">bind</span> 0.0.0.0:8888</span><br><span class="line">        acl huaidan src 192.168.52.175  <span class="comment">####</span></span><br><span class="line">        block <span class="keyword">if</span> huaidan            <span class="comment">####</span></span><br><span class="line">    backend websrvs</span><br><span class="line">        cookie SERVER-COOKIE insert indirect nocache</span><br><span class="line">        option forwardfor        server web1 192.168.52.162:80 cookie web1 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">     ~]<span class="comment"># systemctl restart haproxy</span></span><br><span class="line"></span><br><span class="line">使用192.16.52.175的主机充当客户端访问调度器验证是否可进行后端服务器的调度</span><br><span class="line">    ~]<span class="comment"># curl 192.168.52.175:8888</span></span><br><span class="line">    &lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;</span><br><span class="line">    Request forbidden by administrative rules.</span><br><span class="line">    &lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure></p><hr><p>范例：acl中与关系的体现</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#acl bad_curl hdr_sub(User-Agent) -i curl</span></span><br><span class="line"><span class="comment">#block if bad_curl</span></span><br><span class="line">定义客户端的请求报文中如果首部User-Agent的值有一个子字串，中是否存在curl命令，</span><br><span class="line"></span><br><span class="line">这里是两个条件一起判断则两个acl是与的关系，表示为来自192.16.52.175地址的主机并且是用curl命令请求数据，通过调度器转后端服务器时才被拒绝</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line">    frontend web-port-80</span><br><span class="line">        mode http</span><br><span class="line">        rspadd X-Via:\ HAPorxy</span><br><span class="line">        <span class="built_in">bind</span> 0.0.0.0:8888</span><br><span class="line">        default_backend websrvs</span><br><span class="line">        acl huaidan src 192.168.52.175  <span class="comment">####</span></span><br><span class="line">        acl bad_curl hdr_sub(User-Agent) -i curl    <span class="comment">####</span></span><br><span class="line">        block <span class="keyword">if</span> huaidan bad_curl   <span class="comment">####</span></span><br><span class="line">    backend websrvs</span><br><span class="line">        cookie SERVER-COOKIE insert indirect nocache</span><br><span class="line">        server web1 192.168.52.162:80 check inter 2000 fall 3 rise 5</span><br><span class="line">        server web2 192.168.0.105:80 check inter 3000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># systemctl restart haproxy</span></span><br><span class="line"></span><br><span class="line">使用192.16.52.175的主机充当客户端访问调度器验证是否可进行后端服务器的调度</span><br><span class="line">    <span class="comment"># 使用wget命令测试</span></span><br><span class="line">    ~]<span class="comment"># wget -O - -q http://192.168.52.175:8888</span></span><br><span class="line">    web1</span><br><span class="line">    <span class="comment"># 使用curl命令测试</span></span><br><span class="line">    ~]<span class="comment"># curl 192.168.52.175:8888</span></span><br><span class="line">    &lt;html&gt;&lt;body&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;</span><br><span class="line">    Request forbidden by administrative rules.</span><br><span class="line">    &lt;/body&gt;&lt;/html&gt;</span><br></pre></td></tr></table></figure><p>范例：acl中或关系的体现<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line">frontend web-port-80</span><br><span class="line">    mode http</span><br><span class="line">    rspadd X-Via:\ HAPorxy</span><br><span class="line">    <span class="built_in">bind</span> 0.0.0.0:8888</span><br><span class="line">    default_backend websrvs</span><br><span class="line">    acl huaidan src 192.168.52.175</span><br><span class="line">    acl bad_curl hdr_sub(User-Agent) -i curl</span><br><span class="line">    block <span class="keyword">if</span> huaidan || bad_curl    <span class="comment">####</span></span><br><span class="line">backend websrvs</span><br><span class="line">    cookie SERVER-COOKIE insert indirect nocache</span><br><span class="line">    server web1 192.168.52.162:80 check inter 2000 fall 3 rise 5</span><br><span class="line">    server web2 192.168.0.105:80 check inter 3000 fall 3 rise 5</span><br></pre></td></tr></table></figure></p><hr><h2 id="二、自定义错误页"><a href="#二、自定义错误页" class="headerlink" title="二、自定义错误页"></a>二、自定义错误页</h2><ul><li><p><code>errorfile &lt;code&gt; &lt;file&gt;</code></p><ul><li><p>返回文件内容，而不是HAProxy生成的错误</p></li><li><p><code>&lt;code&gt;:HTTP状态代码。目前，HAProxy能够生成代码200、400、403、408、500、502、503和504。</code></p></li><li><code>&lt;file&gt;:指定一个文件包含完整的HTTP响应。</code></li></ul></li></ul><p>范例：自定义错误页面<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">haproxy设置acl过滤器</span><br><span class="line"></span><br><span class="line">    frontend web-port-80</span><br><span class="line">        mode http</span><br><span class="line">        rspadd X-Via:\ HAPorxy</span><br><span class="line">        <span class="built_in">bind</span> 0.0.0.0:8888</span><br><span class="line">        default_backend websrvs</span><br><span class="line">        acl huaidan src 192.168.0.106</span><br><span class="line">        acl huandan1 hdr(User-Agent) -m sub -i chrome       <span class="comment">#定义客户段请求是通过chrome浏览器进行访问则拒绝</span></span><br><span class="line">        block <span class="keyword">if</span> huaidan || huaidan1        <span class="comment">#或的关系</span></span><br><span class="line">    backend websrvs</span><br><span class="line">        cookie SERVER-COOKIE insert indirect nocache</span><br><span class="line">        server web1 192.168.52.162:80 check inter 2000 fall 3 rise 5</span><br><span class="line">        server web2 192.168.0.105:80 check inter 3000 fall 3 rise 5</span><br></pre></td></tr></table></figure></p><p>192.168.0.106客户端的windows主机进行访问测试<br>显示的为内建默认的错误页<br><img src="/2019/01/24/HAproxyACL/1.png" alt=""></p><p>自己定义错误页面<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">创建存放错误页面的路径</span><br><span class="line">    ~]<span class="comment"># mkdir /etc/haproxy/err_pages</span></span><br><span class="line"></span><br><span class="line">创建一个错误响应403调用的页面</span><br><span class="line">    ~]<span class="comment"># vim /etc/haproxy/err_pages/403.forbiddeng.html</span></span><br><span class="line">    &lt;h1&gt;403&lt;/h1&gt;</span><br><span class="line"></span><br><span class="line">haproxy_server</span><br><span class="line">    ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line">    frontend web-port-80</span><br><span class="line">        mode http</span><br><span class="line">        rspadd X-Via:\ HAPorxy</span><br><span class="line">        <span class="built_in">bind</span> 0.0.0.0:8888</span><br><span class="line">        default_backend websrvs</span><br><span class="line">        acl huaidan src 192.168.0.106</span><br><span class="line">        acl huandan1 hdr(User-Agent) -m sub -i chrome</span><br><span class="line">        block <span class="keyword">if</span> huaidan || huaidan1</span><br><span class="line">        errorfile 403 /etc/haproxy/err_pages/403.forbiddeng.html    <span class="comment">####</span></span><br><span class="line">    backend websrvs</span><br><span class="line">        cookie SERVER-COOKIE insert indirect nocache</span><br><span class="line">        server web1 192.168.52.162:80 check inter 2000 fall 3 rise 5</span><br><span class="line">        server web2 192.168.0.105:80 check inter 3000 fall 3 rise 5</span><br></pre></td></tr></table></figure></p><hr><p>定义将错误的页面进行其他网站或者其他的url的跳转<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line">   frontend web-port-80</span><br><span class="line">       mode http</span><br><span class="line">       rspadd X-Via:\ HAPorxy</span><br><span class="line">       <span class="built_in">bind</span> 0.0.0.0:8888</span><br><span class="line">       default_backend websrvs</span><br><span class="line">       acl huaidan src 192.168.0.106</span><br><span class="line">       acl huandan1 hdr(User-Agent) -m sub -i chrome</span><br><span class="line">       block <span class="keyword">if</span> huaidan || huaidan1</span><br><span class="line">       errorloc302 403 https://www.daizhe.net.cn/    <span class="comment">####</span></span><br><span class="line">   backend websrvs</span><br><span class="line">       cookie SERVER-COOKIE insert indirect nocache</span><br><span class="line">       server web1 192.168.52.162:80 check inter 2000 fall 3 rise 5</span><br><span class="line">       server web2 192.168.0.105:80 check inter 3000 fall 3 rise 5</span><br></pre></td></tr></table></figure></p><h2 id="三、acl-根据客户端请求的资源path进行acl过滤-user-backend"><a href="#三、acl-根据客户端请求的资源path进行acl过滤-user-backend" class="headerlink" title="三、acl (根据客户端请求的资源path进行acl过滤  user_backend)"></a>三、acl (根据客户端请求的资源path进行acl过滤  user_backend)</h2><ul><li>path     : exact string match</li><li>path_beg : prefix match</li><li>path_dir : subdir match</li><li>path_dom : domain match</li><li>path_end : suffix match</li><li>path_len : length match</li><li>path_reg : regex match</li><li>path_sub : substring match</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">定义客户的请求path中路径的内容，来进行调度</span><br><span class="line"></span><br><span class="line">frontend web-port-80</span><br><span class="line">        mode http</span><br><span class="line">        rspadd X-Via:\ HAPorxy</span><br><span class="line">        <span class="built_in">bind</span> 0.0.0.0:8888</span><br><span class="line">        default_backend websrvs     <span class="comment">#默认的后端主机组</span></span><br><span class="line">        acl images path -m end -i .jpg .jpeg .png .gif      </span><br><span class="line">        <span class="comment">#如果客户请求的url资源是以这些文件类型结尾的</span></span><br><span class="line">        acl images path -m beg /images  </span><br><span class="line">        <span class="comment">#且请求的文件的路径是来自后端服务器中/images文件夹中</span></span><br><span class="line">        user_backend imagsrvs <span class="keyword">if</span> images   </span><br><span class="line">        <span class="comment">#如果满足上所述两个条则则全部归类到images，如果客户端请求的是images这类的文件则使用后端的imagsrvs 中的后端服务器组响应，反之则使用默认的服务器响应</span></span><br><span class="line">    backend websrvs</span><br><span class="line">        cookie SERVER-COOKIE insert indirect nocache</span><br><span class="line">        server web1 192.168.52.162:80 check inter 2000 fall 3 rise 5</span><br><span class="line">        server web2 192.168.0.105:80 check inter 3000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">    backend imagsrvs</span><br><span class="line">        server web3 192.168.62.88:80 check</span><br></pre></td></tr></table></figure><h2 id="四、http-request-七层负载acl"><a href="#四、http-request-七层负载acl" class="headerlink" title="四、http-request 七层负载acl"></a>四、http-request 七层负载acl</h2><ul><li><code>http-request { allow | deny } [ { if | unless } &lt;condition&gt; ]</code><ul><li>7层请求的访问控制<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">haproxy_server</span><br><span class="line"></span><br><span class="line">    frontend web-port-80</span><br><span class="line">        mode http</span><br><span class="line">        rspadd X-Via:\ HAPorxy</span><br><span class="line">        <span class="built_in">bind</span> 0.0.0.0:8888</span><br><span class="line">        default_backend websrvs</span><br><span class="line">        acl haoren src 192.168.52.100   <span class="comment">####</span></span><br><span class="line">        http-request allow <span class="keyword">if</span> haoren  <span class="comment">####  </span></span><br><span class="line">        <span class="comment">#定义了一个白名单仅允许192.168.52.100主机通过调度器访问后端的主机，来自其他源地址的主机则拒绝访问后端的主机</span></span><br><span class="line">        http-request deny   <span class="comment">####</span></span><br><span class="line">    backend websrvs</span><br><span class="line">        server web1 192.168.52.162:80 check inter 2000 fall 3 rise 5</span><br><span class="line">        server web2 192.168.0.105:80 check inter 3000 fall 3 rise 5</span><br></pre></td></tr></table></figure></li></ul></li></ul><h2 id="五、tcp-request-四层负载acl"><a href="#五、tcp-request-四层负载acl" class="headerlink" title="五、tcp-request 四层负载acl"></a>五、tcp-request 四层负载acl</h2><ul><li><code>tcp-request connection {accept|reject}  [{if | unless} &lt;condition&gt;]</code><ul><li>根据第4层条件对传入连接执行操作</li></ul></li></ul><h2 id="六、url-（根据客户端请求的资源url进行acl过滤）"><a href="#六、url-（根据客户端请求的资源url进行acl过滤）" class="headerlink" title="六、url （根据客户端请求的资源url进行acl过滤）"></a>六、url （根据客户端请求的资源url进行acl过滤）</h2><ul><li>url     : exact string match</li><li>url_beg : prefix match</li><li>url_dir : subdir match</li><li>url_dom : domain match</li><li>url_end : suffix match</li><li>url_len : length match</li><li>url_reg : regex match</li><li><p>url_sub : substring match</p></li><li><p>url包括：</p><ul><li>协议</li><li>服务器</li><li>地址</li><li>端口</li><li>path</li></ul></li><li><p>url的范围要比path限制acl更广泛</p></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">定义合法的引用，如果为合法的引用则调度器则将客户端的请求调度到后端的服务器上，如果不为合法的引用则不进行调度</span><br><span class="line"></span><br><span class="line"><span class="comment">#仅允许来自daizhe字段的域名的外链的地址用户可以访问后端的服务器</span></span><br><span class="line"><span class="comment">#如果不符合此条件直接拒绝</span></span><br><span class="line"></span><br><span class="line">hproxy_server</span><br><span class="line">    </span><br><span class="line">    frontend web-port-80</span><br><span class="line">        mode http</span><br><span class="line">        rspadd X-Via:\ HAPorxy</span><br><span class="line">        <span class="built_in">bind</span> 0.0.0.0:8888</span><br><span class="line">        default_backend websrvs</span><br><span class="line">        acl hefadeyinyong（定义的acl名称） hdr(Referer) -m dom -i daizhe</span><br><span class="line">        block <span class="keyword">if</span> ! hefayinyong</span><br><span class="line"></span><br><span class="line">    backend websrvs</span><br><span class="line">        server web1 192.168.52.162:80 check inter 2000 fall 3 rise 5</span><br><span class="line">        server web2 192.168.0.105:80 check inter 3000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">访问测试</span><br><span class="line">    直接访问调度器</span><br><span class="line">    ~]<span class="comment"># curl http: http://haproxy ip</span></span><br><span class="line">    403</span><br><span class="line">    模拟外链跳转来的访问</span><br><span class="line">    ~]<span class="comment"># curl -e "http://www.daizhe.net.cn http://haproxy ip"</span></span><br><span class="line">    200</span><br></pre></td></tr></table></figure><h2 id="七、内建的acl"><a href="#七、内建的acl" class="headerlink" title="七、内建的acl"></a>七、内建的acl</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">Pre-defined ACLs</span><br><span class="line">ACL nameEquivalent toUsage</span><br><span class="line">FALSEalways_falsenever match</span><br><span class="line">HTTPreq_proto_httpmatch <span class="keyword">if</span> protocol is valid HTTP</span><br><span class="line">HTTP_1.0req_ver 1.0match HTTP version 1.0</span><br><span class="line">HTTP_1.1req_ver 1.1match HTTP version 1.1</span><br><span class="line">HTTP_CONTENThdr_val(content-length) gt 0match an existing content-length</span><br><span class="line">HTTP_URL_ABSurl_reg ^[^/:]*://match absolute URL with scheme</span><br><span class="line">HTTP_URL_SLASHurl_beg /match URL beginning with <span class="string">"/"</span></span><br><span class="line">HTTP_URL_STARurl *match URL equal to <span class="string">"*"</span></span><br><span class="line">LOCALHOSTsrc 127.0.0.1/8match connection from <span class="built_in">local</span> host</span><br><span class="line">METH_CONNECTmethod CONNECTmatch HTTP CONNECT method</span><br><span class="line">METH_GETmethod GET HEADmatch HTTP GET or HEAD method</span><br><span class="line">METH_HEADmethod HEADmatch HTTP HEAD method</span><br><span class="line">METH_OPTIONSmethod OPTIONSmatch HTTP OPTIONS method</span><br><span class="line">METH_POSTmethod POSTmatch HTTP POST method</span><br><span class="line">METH_TRACEmethod TRACEmatch HTTP TRACE method</span><br><span class="line">RDP_COOKIEreq_rdp_cookie_cnt gt 0match presence of an RDP cookie</span><br><span class="line">REQ_CONTENTreq_len gt 0match data <span class="keyword">in</span> the request buffer</span><br><span class="line">TRUEalways_truealways match</span><br><span class="line">WAIT_ENDwait_end<span class="built_in">wait</span> <span class="keyword">for</span> end of content analysis</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;HAproxy的ACL过滤器及自定义错误页&quot;&gt;&lt;a href=&quot;#HAproxy的ACL过滤器及自定义错误页&quot; class=&quot;headerlink&quot; title=&quot;HAproxy的ACL过滤器及自定义错误页&quot;&gt;&lt;/a&gt;HAproxy的ACL过滤器及自定义错误页&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/01/24/HAproxyACL/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/categories/HAproxy/"/>
    
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/tags/HAproxy/"/>
    
  </entry>
  
  <entry>
    <title>HAproxy日志配置及报文操作</title>
    <link href="https://daizhe.net.cn/2019/01/23/HAproxy%E6%97%A5%E5%BF%97%E9%85%8D%E7%BD%AE%E5%8F%8A%E6%8A%A5%E6%96%87%E6%93%8D%E4%BD%9C/"/>
    <id>https://daizhe.net.cn/2019/01/23/HAproxy日志配置及报文操作/</id>
    <published>2019-01-23T12:49:55.592Z</published>
    <updated>2019-02-01T05:34:48.874Z</updated>
    
    <content type="html"><![CDATA[<h1 id="HAproxy日志配置及报文操作"><a href="#HAproxy日志配置及报文操作" class="headerlink" title="HAproxy日志配置及报文操作"></a>HAproxy日志配置及报文操作</h1><p><img src="/2019/01/23/HAproxy日志配置及报文操作/标题.gif" alt=""><br><a id="more"></a></p><h2 id="一、配置HAProxy状态页"><a href="#一、配置HAProxy状态页" class="headerlink" title="一、配置HAProxy状态页"></a>一、配置HAProxy状态页</h2><h3 id="1-haproxy状态页面开启"><a href="#1-haproxy状态页面开启" class="headerlink" title="1.haproxy状态页面开启"></a>1.haproxy状态页面开启</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">paproxy_server</span><br><span class="line">    ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line">    listen stats</span><br><span class="line">    mode http</span><br><span class="line">    <span class="built_in">bind</span> 172.18.135.2:9999     <span class="comment">#默认监听的地址为0.0.0.0,最好不要监听本机的所有地址。监听的端口不要和现有的业务冲突</span></span><br><span class="line">    stats <span class="built_in">enable</span></span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    stats uri     /haproxy-status       <span class="comment">#默认访问状态页面的uri（可以自己定义）</span></span><br><span class="line">    stats auth    haadmin:q1w2e3r4ys    <span class="comment">#默认访问uri的用户名和密码</span></span><br><span class="line">    stats auth    daizhe:123456        <span class="comment">#指定用户访问此uri提供的用户名和密码</span></span><br><span class="line">    stats realm HAPorxy\ Stats\ Page      <span class="comment">#设置用户访问uri时提示输入密码的提示信息</span></span><br><span class="line"></span><br><span class="line">    </span><br><span class="line">    ~]<span class="comment"># systemctl restart haproxy</span></span><br></pre></td></tr></table></figure><p>web界面访问查看此状态页面</p><p><img src="/2019/01/23/HAproxy日志配置及报文操作/1.png" alt=""></p><p><img src="/2019/01/23/HAproxy日志配置及报文操作/2.png" alt=""></p><hr><h3 id="2-开启管理状态页面"><a href="#2-开启管理状态页面" class="headerlink" title="2.开启管理状态页面"></a>2.开启管理状态页面</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line">    listen stats</span><br><span class="line">    mode http</span><br><span class="line">    <span class="built_in">bind</span> 172.18.135.2:9999</span><br><span class="line">    stats <span class="built_in">enable</span></span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    stats uri     /haproxy-status</span><br><span class="line">    stats auth    haadmin:q1w2e3r4ys</span><br><span class="line">    stats auth    admin:123456</span><br><span class="line">    stats realm HAPorxy\ Stats\ Page</span><br><span class="line">    stats admin <span class="keyword">if</span> TRUE       <span class="comment">#如果登陆的是daizhe这个用户则打开状态管理页面（或者也可写为 stats admin if LOCAHOST 表示为如果访问的为本机的主机则允许验证账号授权登陆）</span></span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># systemctl restart haproxy</span></span><br></pre></td></tr></table></figure><p>web界面访问查看此状态页面</p><p><img src="/2019/01/23/HAproxy日志配置及报文操作/3.png" alt=""></p><hr><h3 id="3-隐藏管理状态页面的haproxy的版本号"><a href="#3-隐藏管理状态页面的haproxy的版本号" class="headerlink" title="3.隐藏管理状态页面的haproxy的版本号"></a>3.隐藏管理状态页面的haproxy的版本号</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line">    listen stats</span><br><span class="line">    mode http</span><br><span class="line">    <span class="built_in">bind</span> 172.18.135.2:9999</span><br><span class="line">    stats <span class="built_in">enable</span></span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    stats uri     /haproxy-status</span><br><span class="line">    stats auth    haadmin:q1w2e3r4ys</span><br><span class="line">    stats auth    admin:123456</span><br><span class="line">    stats realm HAPorxy\ Stats\ Page</span><br><span class="line">    stats admin <span class="keyword">if</span> TRUE      </span><br><span class="line">    stats hide-version  <span class="comment">#隐藏版本号</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># systemctl restart haproxy</span></span><br></pre></td></tr></table></figure><p>web界面访问查看此状态页面</p><p><img src="/2019/01/23/HAproxy日志配置及报文操作/4.png" alt=""></p><hr><h2 id="二、HAproxy修改报文首部-http模式"><a href="#二、HAproxy修改报文首部-http模式" class="headerlink" title="二、HAproxy修改报文首部(http模式)"></a>二、HAproxy修改报文首部(http模式)</h2><ul><li><h4 id="在请求报文尾部添加指定首部"><a href="#在请求报文尾部添加指定首部" class="headerlink" title="在请求报文尾部添加指定首部"></a>在请求报文尾部添加指定首部</h4><ul><li><code>reqadd  &lt;string&gt; [{if | unless} &lt;cond&gt;]</code></li></ul></li><li><h4 id="在响应报文尾部添加指定首部"><a href="#在响应报文尾部添加指定首部" class="headerlink" title="在响应报文尾部添加指定首部"></a>在响应报文尾部添加指定首部</h4><ul><li><code>rspadd &lt;string&gt; [{if | unless} &lt;cond&gt;]</code><ul><li>示例：rspadd X-Via:\ HAPorxy    </li></ul></li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">客户端中可以查看到响应是通过haproxy调度器调度响应的</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">listen web-port-80</span><br><span class="line">        mode http</span><br><span class="line">        rspadd X-Via:\ HAPorxy      <span class="comment">####</span></span><br><span class="line">        <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">        option forwardfor</span><br><span class="line">        cookie SERVER-COOKIE insert indirect nocache</span><br><span class="line">        server web1 172.18.135.5:8080 cookie web1 check inter 2000 fall 3 rise 5</span><br><span class="line">        server 172.18.135.5 172.18.135.1:8080 cookie web2 check inter 3000 fall 3 rise 5</span><br></pre></td></tr></table></figure><p><img src="/2019/01/23/HAproxy日志配置及报文操作/5.png" alt=""></p><ul><li><h4 id="从请求报文中删除匹配正则表达式的首部"><a href="#从请求报文中删除匹配正则表达式的首部" class="headerlink" title="从请求报文中删除匹配正则表达式的首部"></a>从请求报文中删除匹配正则表达式的首部</h4><ul><li><code>reqdel  &lt;search&gt; [{if | unless} &lt;cond&gt;]</code></li><li><code>reqidel &lt;search&gt; [{if | unless} &lt;cond&gt;] 不分大小写</code></li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">删除响应报文中的server字段的信息</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">listen web-port-80</span><br><span class="line">        mode http</span><br><span class="line">        rspadd X-Via:\ HAPorxy</span><br><span class="line">        rspdel Server:*</span><br><span class="line">        <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">        option forwardfor</span><br><span class="line">        cookie SERVER-COOKIE insert indirect nocache</span><br><span class="line">        server web1 172.18.135.5:8080 cookie web1 check inter 2000 fall 3 rise 5</span><br></pre></td></tr></table></figure><p><img src="/2019/01/23/HAproxy日志配置及报文操作/6.png" alt=""></p><ul><li><h4 id="从响应报文中删除匹配正则表达式的首部"><a href="#从响应报文中删除匹配正则表达式的首部" class="headerlink" title="从响应报文中删除匹配正则表达式的首部"></a>从响应报文中删除匹配正则表达式的首部</h4><ul><li><code>rspdel  &lt;search&gt; [{if | unless} &lt;cond&gt;]</code></li><li><code>rspidel &lt;search&gt; [{if | unless} &lt;cond&gt;]</code><ul><li>示例： rspidel  server.* #从相应报文删除server信息<ul><li>rspidel X-Powered-By:.*  #从响应报文删除X-Powered-By信息</li></ul></li></ul></li></ul></li></ul><h2 id="三、HAProxy-日志配置"><a href="#三、HAProxy-日志配置" class="headerlink" title="三、HAProxy 日志配置"></a>三、HAProxy 日志配置</h2><ul><li>在default配置项定义：<ul><li>log 127.0.0.1  local{1-7} info #基于syslog记录日志到指定设备，级别有(err、warning、info、debug)</li></ul></li></ul><p>范例：基于rsyslog配置收集haproxy日志信息(udp)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">开启haproxy服务器上的rsyslog功能</span><br><span class="line">     ~]<span class="comment"># vim /etc/rsyslog.conf </span></span><br><span class="line">    15~16行</span><br><span class="line">    <span class="variable">$ModLoad</span> imudp</span><br><span class="line">    <span class="variable">$UDPServerRun</span> 514</span><br><span class="line"></span><br><span class="line">    74行</span><br><span class="line">    local3.*    /var/<span class="built_in">log</span>/haproxy.log</span><br><span class="line"></span><br><span class="line">配置haproxy配置文件</span><br><span class="line">    ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line">    global</span><br><span class="line">    ...</span><br><span class="line">    <span class="built_in">log</span> 127.0.0.1 local3 info</span><br><span class="line"></span><br><span class="line">重启服务</span><br><span class="line">    ~]<span class="comment"># systemctl restart rsyslog haproxy</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">客户访问后端web_server 查看haproxy日志</span><br></pre></td></tr></table></figure></p><p><img src="/2019/01/23/HAproxy日志配置及报文操作/7.png" alt=""></p><p>范例：可以将haproxy日志格式使用tcp/http记录在rsyslog日志中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">配置HAProxy：</span><br><span class="line">listen  web_port</span><br><span class="line"> <span class="built_in">bind</span> 127.0.0.1:80</span><br><span class="line"> mode http</span><br><span class="line"> <span class="built_in">log</span> global</span><br><span class="line">option tcplog</span><br><span class="line"> server web1  127.0.0.1:8080  check inter 3000 fall 2 rise 5</span><br></pre></td></tr></table></figure></p><p>详细日志参考手册：<a href="http://cbonte.github.io/haproxy-dconv/1.8/configuration.html#8.1" target="_blank" rel="noopener">http://cbonte.github.io/haproxy-dconv/1.8/configuration.html#8.1</a></p><h2 id="四、自定义paproxy记录日志"><a href="#四、自定义paproxy记录日志" class="headerlink" title="四、自定义paproxy记录日志"></a>四、自定义paproxy记录日志</h2><ul><li><p>将特定信息记录在日志中</p><ul><li><code>capture cookie &lt;name&gt; len &lt;length&gt; #捕获请求和响应报文中的 cookie并记录日志</code></li><li><code>capture request header &lt;name&gt; len &lt;length&gt; #捕获请求报文中指定的首部内容和长度并记录日志</code></li><li><code>capture response header &lt;name&gt; len &lt;length&gt; #捕获响应报文中指定的内容和长度首部并记录日志</code></li></ul></li><li><p>示例：配置haproxy配置文件，注意配置字段和生效的位置（最好设置单独的listen中，仅对一组server生效）</p><ul><li>capture request  header Host len  256 </li><li>capture request header User-Agent len 512     <h2 id="五、压缩功能"><a href="#五、压缩功能" class="headerlink" title="五、压缩功能"></a>五、压缩功能</h2></li></ul></li><li>compression algo   #启用http协议中的压缩机制，常用算法有gzip deflate</li><li><p>compression type  #要压缩的类型</p></li><li><p>示例：</p><ul><li>compression algo gzip</li><li>compression type compression type text/plain text/html text/css text/xml text/javascript application/javascript</li></ul></li></ul><p><img src="/2019/01/23/HAproxy日志配置及报文操作/8.png" alt=""></p><h2 id="Web服务器状态监测"><a href="#Web服务器状态监测" class="headerlink" title="Web服务器状态监测"></a>Web服务器状态监测</h2><ul><li>option httpchk</li><li><code>option httpchk &lt;uri&gt;</code></li><li><code>option httpchk &lt;method&gt; &lt;uri&gt;</code></li><li><code>option httpchk &lt;method&gt; &lt;uri&gt; &lt;version&gt;</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">listen  web_prot_http_nodes</span><br><span class="line">    <span class="built_in">bind</span>  192.168.7.102:80</span><br><span class="line">    mode  http</span><br><span class="line">    <span class="built_in">log</span> global</span><br><span class="line">    option httpchk GET /wp-includes/js/jquery/jquery.js?ver=1.12.4 HTTP/1.0  <span class="comment">#基于指定URL</span></span><br><span class="line">    <span class="comment">#option httpchk HEAD /wp-includes/js/jquery/jquery.js?ver=1.12.4 HTTP/1.0\r\nHost:\ 192.168.7.102 #通过request获取的头部信息进行匹配进行健康检测</span></span><br><span class="line">     server 192.168.7.102  blogs.studylinux.net:80   check inter 3000 fall 3 rise 5</span><br><span class="line">     server 192.168.7.101 192.168.7.101:8080  cookie web1 check inter 3000 fall 3 rise 5</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;HAproxy日志配置及报文操作&quot;&gt;&lt;a href=&quot;#HAproxy日志配置及报文操作&quot; class=&quot;headerlink&quot; title=&quot;HAproxy日志配置及报文操作&quot;&gt;&lt;/a&gt;HAproxy日志配置及报文操作&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/01/23/HAproxy日志配置及报文操作/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/categories/HAproxy/"/>
    
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/tags/HAproxy/"/>
    
  </entry>
  
  <entry>
    <title>HAproxy基于cookie会话保持</title>
    <link href="https://daizhe.net.cn/2019/01/23/HAproxy%E5%9F%BA%E4%BA%8Ecookie%E4%BC%9A%E8%AF%9D%E4%BF%9D%E6%8C%81/"/>
    <id>https://daizhe.net.cn/2019/01/23/HAproxy基于cookie会话保持/</id>
    <published>2019-01-23T12:18:29.061Z</published>
    <updated>2019-01-23T12:54:56.145Z</updated>
    
    <content type="html"><![CDATA[<h1 id="HAproxy基于cookie会话保持"><a href="#HAproxy基于cookie会话保持" class="headerlink" title="HAproxy基于cookie会话保持"></a>HAproxy基于cookie会话保持</h1><p><img src="/2019/01/23/HAproxy基于cookie会话保持/标题.gif" alt=""><br><a id="more"></a></p><h2 id="Cookie-配置"><a href="#Cookie-配置" class="headerlink" title="Cookie 配置"></a>Cookie 配置</h2><ul><li><p><code>cookie &lt;value&gt;：为当前server指定cookie值，实现基于cookie的会话黏性</code></p><ul><li><code>cookie &lt;name&gt; [ rewrite | insert | prefix ] [ indirect ] [ nocache ]  [ postonly ] [ preserve ] [ httponly ] [ secure ]  [ domain &lt;domain&gt; ]* [ maxidle &lt;idle&gt; ] [ maxlife &lt;life&gt; ]</code></li></ul></li><li><p><code>&lt;name&gt;：cookie名称，用于实现持久连接</code></p><ul><li>rewrite：重写</li><li>insert：插入</li><li>prefix：前缀</li><li>nocache：当client和hapoxy之间有缓存时，不缓存cookie</li></ul></li></ul><h2 id="范例：使用haproxy实现基于cookie会话保持（haproxy必须在http协议的模式下实现）"><a href="#范例：使用haproxy实现基于cookie会话保持（haproxy必须在http协议的模式下实现）" class="headerlink" title="范例：使用haproxy实现基于cookie会话保持（haproxy必须在http协议的模式下实现）"></a>范例：使用haproxy实现基于cookie会话保持（haproxy必须在http协议的模式下实现）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#模拟httpd_server不直接对外服务，通过haproxy负载对外进程调度服务</span></span><br><span class="line"><span class="comment">#范例：使用haproxy实现基于cookie会话保持（haproxy必须在http协议的模式下实现）也彻底解决会话调度不均衡</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">实验准备</span><br><span class="line">  四台主机：</span><br><span class="line">    haproxy_server :  yum install haproxy -y</span><br><span class="line">    httpd_serverA : yum install httpd -y</span><br><span class="line">    httpd_serverB : yum install httpd -y</span><br><span class="line">    windows_firefox</span><br><span class="line"></span><br><span class="line">配置httpd_server测试页面</span><br><span class="line">  httpd_serverA</span><br><span class="line">  ~]<span class="comment"># echo "172.18.135.1" &gt; /var/www/html/index.html</span></span><br><span class="line">  ~]<span class="comment"># systemctl start httpd</span></span><br><span class="line">  修改端口8080</span><br><span class="line"></span><br><span class="line">  httpd_serverB</span><br><span class="line">  ~]<span class="comment"># echo "172.18.135.5" &gt; /var/www/html/index.html</span></span><br><span class="line">  ~]<span class="comment"># systemctl start httpd</span></span><br><span class="line">  修改端口8080</span><br><span class="line"></span><br><span class="line">配置haproxy负载</span><br><span class="line">  ~]<span class="comment"># yum install haproxy -y</span></span><br><span class="line">  ~]<span class="comment"># cat  /etc/haproxy/haproxy.cfg </span></span><br><span class="line">  global</span><br><span class="line">  maxconn 100000</span><br><span class="line">  chroot /usr/<span class="built_in">local</span>/haproxy</span><br><span class="line">  <span class="comment">#stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin</span></span><br><span class="line">  uid 1111</span><br><span class="line">  gid 1111</span><br><span class="line">  daemon</span><br><span class="line">  nbproc 4</span><br><span class="line">  cpu-map 1 0</span><br><span class="line">  cpu-map 2 1</span><br><span class="line">  pidfile /usr/<span class="built_in">local</span>/haproxy/run/haproxy.pid</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local3 info</span><br><span class="line"></span><br><span class="line">  defaults</span><br><span class="line">  option http-keep-alive</span><br><span class="line">  option  forwardfor</span><br><span class="line">  maxconn 100000</span><br><span class="line">  mode http</span><br><span class="line">  timeout connect 300000ms</span><br><span class="line">  timeout client  300000ms</span><br><span class="line">  timeout server  300000ms</span><br><span class="line"></span><br><span class="line">  listen stats</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:9999</span><br><span class="line">  stats <span class="built_in">enable</span></span><br><span class="line">  <span class="built_in">log</span> global</span><br><span class="line">  stats uri     /haproxy-status</span><br><span class="line">  stats auth    haadmin:q1w2e3r4ys</span><br><span class="line"></span><br><span class="line">  <span class="comment">#httpd_server基于cookie实现调度</span></span><br><span class="line">  listen web-port-80                  <span class="comment">#web-port-80指定的此分组的名称</span></span><br><span class="line">        mode http                     <span class="comment">#必须为http</span></span><br><span class="line">        <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">        option forwardfor</span><br><span class="line">        cookie SERVER-COOKIE  insert indirect nocache   <span class="comment">#不缓存</span></span><br><span class="line">        server web1 172.18.135.5:8080 cookie web1 check inter 2000 fall 3 rise 5    <span class="comment"># 172.18.135.5为定义的主机的名称，172.18.135.5:8080 定义的后端的主机的地址及服务的端口</span></span><br><span class="line">        server 172.18.135.5 172.18.135.1:8080 cookie web2 check inter 3000 fall 3 rise 5        <span class="comment">#cookie    指定cookie的值，实现区分不同的web_server,也可在请求的头部看到此信息</span></span><br><span class="line"></span><br><span class="line">  启动查看端口 </span><br><span class="line">    ~]<span class="comment"># systemctl start haproxy</span></span><br><span class="line">    ~]<span class="comment"># ss -tnl</span></span><br><span class="line">   9999   </span><br><span class="line">    172.18.135.2:80</span><br></pre></td></tr></table></figure><ul><li>windows_firefox测试</li></ul><p>客户端访问查看请求的头部（请求不跳转，实现基于cookie的会话保持和负载不均衡的情况）<br><img src="/2019/01/23/HAproxy基于cookie会话保持/1.png" alt=""></p><ul><li>也可以使用curl命令验证</li></ul><p><img src="/2019/01/23/HAproxy基于cookie会话保持/2.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;HAproxy基于cookie会话保持&quot;&gt;&lt;a href=&quot;#HAproxy基于cookie会话保持&quot; class=&quot;headerlink&quot; title=&quot;HAproxy基于cookie会话保持&quot;&gt;&lt;/a&gt;HAproxy基于cookie会话保持&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/01/23/HAproxy基于cookie会话保持/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/categories/HAproxy/"/>
    
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/tags/HAproxy/"/>
    
  </entry>
  
  <entry>
    <title>HAproxy IP地址透传</title>
    <link href="https://daizhe.net.cn/2019/01/22/HAproxyIP%E5%9C%B0%E5%9D%80%E9%80%8F%E4%BC%A0/"/>
    <id>https://daizhe.net.cn/2019/01/22/HAproxyIP地址透传/</id>
    <published>2019-01-22T10:00:18.113Z</published>
    <updated>2019-01-23T12:18:58.280Z</updated>
    
    <content type="html"><![CDATA[<h1 id="HAproxy-IP地址透传（七层-四层）"><a href="#HAproxy-IP地址透传（七层-四层）" class="headerlink" title="HAproxy IP地址透传（七层/四层）"></a>HAproxy IP地址透传（七层/四层）</h1><p><img src="/2019/01/22/HAproxyIP地址透传/标题.gif" alt=""><br><a id="more"></a></p><ul><li>四层负载<ul><li>mode http</li></ul></li><li>七层负载<ul><li>mode tcp</li></ul></li></ul><h2 id="实验准备"><a href="#实验准备" class="headerlink" title="实验准备"></a>实验准备</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">```bash</span><br><span class="line"><span class="comment">#如果客户端访问的地址为公网地址上的一个网站，如果客户端用的是NAT方式出去上网的，则后端的nginx查看的日志信息源ip地址应该是客户端通过NAT方式出去的地址</span></span><br><span class="line"></span><br><span class="line">实验准备：</span><br><span class="line">  haproxy_server   172.18.135.2模拟私网地址</span><br><span class="line">  nginx_server     172.18.135.5模拟公网地址</span><br><span class="line">  windows_firefox  172.18.88.88模拟客户端浏览器</span><br><span class="line"></span><br><span class="line">模拟：</span><br><span class="line">  haproxy_server和windows_firefox  为私网地址</span><br><span class="line">  nginx_server 为公网地址</span><br><span class="line"></span><br><span class="line"><span class="comment">#windows_firefox通过haporxy_server的地址透传（NAT）,实现windows_firefox通过访问haporxy_server的地址从跳转至私网地址nginx_server服务器上进行访问</span></span><br></pre></td></tr></table></figure><h3 id="七层地址透传-http"><a href="#七层地址透传-http" class="headerlink" title="七层地址透传(http)"></a>七层地址透传(http)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">haproxy_server</span><br><span class="line">配置haproxy实现透传</span><br><span class="line">  ~]<span class="comment"># yum install haproxy -y</span></span><br><span class="line">  ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg</span></span><br><span class="line">  <span class="comment">#七层地址透传</span></span><br><span class="line">  listen web-port-80</span><br><span class="line">        mode http         <span class="comment">#此透传仅支持http协议，在tcp协议上不影响haproxy启动，但是nginx日志中会写出记录不到真实访问的地址</span></span><br><span class="line">        option forwardfor   <span class="comment">#如果后端服务器需要获得客户端的真实IP需要配置此参数，将可以从HttpHeader中获得客户端IP</span></span><br><span class="line">        <span class="built_in">bind</span> 172.18.135.2:80    <span class="comment">#此地址为调度器的地址</span></span><br><span class="line">        server web1 172.18.135.5:80 weight 2 check inter 2000 fall 3 rise 5   <span class="comment">#web1为定义后端主机的名称</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart haproxy</span></span><br><span class="line">  ~]<span class="comment"># curl -I 172.18.135.2:80</span></span><br><span class="line"></span><br><span class="line">windown_firefox客户端浏览器访问haproxy_server地址</span><br><span class="line">  http://172.18.135.2/</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">nginx_server</span><br><span class="line">查看web服务器的访问日志</span><br><span class="line">  ~]<span class="comment"># yum install nginx -y</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/nginx/nginx.conf     #定义nginx的日志文件为json格式输出，并可以查看到真实的客户端的地址（这里值得是windows_firefox）</span></span><br><span class="line">  http &#123;</span><br><span class="line">  log_format json <span class="string">'&#123;"@timestamp":"$time_iso8601",'</span></span><br><span class="line">                 <span class="string">'"host":"$server_addr",'</span></span><br><span class="line">                 <span class="string">'"clientip":"$remote_addr",'</span></span><br><span class="line">                 <span class="string">'"size":$body_bytes_sent,'</span></span><br><span class="line">                 <span class="string">'"responsetime":$request_time,'</span></span><br><span class="line">                 <span class="string">'"upstreamtime":"$upstream_response_time",'</span></span><br><span class="line">                 <span class="string">'"upstreamhost":"$upstream_addr",'</span></span><br><span class="line">                 <span class="string">'"http_host":"$host",'</span></span><br><span class="line">                 <span class="string">'"url":"$uri",'</span></span><br><span class="line">                 <span class="string">'"referer":"$http_referer",'</span></span><br><span class="line">                 <span class="string">'"agent":"$http_user_agent",'</span></span><br><span class="line">                 <span class="string">'"xff":"$http_x_forwarded_for",'</span></span><br><span class="line">                 <span class="string">'"status":"$status"&#125;'</span>;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access_json  json;</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl start nginx  </span></span><br><span class="line">   ~]<span class="comment"># cat /var/log/nginx/access_json </span></span><br><span class="line">   &#123;<span class="string">"@timestamp"</span>:<span class="string">"2019-01-22T22:00:54+08:00"</span>,<span class="string">"host"</span>:<span class="string">"172.18.135.5"</span>,<span class="string">"clientip"</span>:<span class="string">"172.18.135.2"</span>,<span class="string">"size"</span>:0,<span class="string">"responsetime"</span>:0.000,<span class="string">"upstreamtime"</span>:<span class="string">"-"</span>,<span class="string">"upstreamhost"</span>:<span class="string">"-"</span>,<span class="string">"http_host"</span>:<span class="string">"172.18.135.2"</span>,<span class="string">"url"</span>:<span class="string">"/poweredby.png"</span>,<span class="string">"referer"</span>:<span class="string">"http://172.18.135.2/"</span>,<span class="string">"agent"</span>:<span class="string">"Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:64.0) Gecko/20100101 Firefox/64.0"</span>,<span class="string">"xff"</span>:<span class="string">"172.18.88.88"</span>,<span class="string">"status"</span>:<span class="string">"304"</span>&#125;   <span class="comment">#可以查看到真实访问的windiws_firefox的真实地址</span></span><br></pre></td></tr></table></figure><p><img src="/2019/01/22/HAproxyIP地址透传/七层.png" alt=""></p><h3 id="四层地址透传-tcp"><a href="#四层地址透传-tcp" class="headerlink" title="四层地址透传(tcp)"></a>四层地址透传(tcp)</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">haproxy_server</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line">  <span class="comment">#httpd_server调度</span></span><br><span class="line">  listen web-port-80</span><br><span class="line">        mode tcp</span><br><span class="line">        <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">        option forwardfor</span><br><span class="line">        server web1 172.18.135.5:80 send-proxy weight 2 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart haproxy</span></span><br><span class="line"></span><br><span class="line">nginx_server</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">      server &#123;</span><br><span class="line">        listen       80 proxy_protocol;   <span class="comment">#TCP获取客户端真实IP日志格式</span></span><br><span class="line">  <span class="comment">#        listen       [::]:80 default_server;</span></span><br><span class="line">        server_name  _;</span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Load configuration files for the default server block.</span></span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart nginx </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">客户端访查看nginx日志</span><br></pre></td></tr></table></figure><p><img src="/2019/01/22/HAproxyIP地址透传/四层.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;HAproxy-IP地址透传（七层-四层）&quot;&gt;&lt;a href=&quot;#HAproxy-IP地址透传（七层-四层）&quot; class=&quot;headerlink&quot; title=&quot;HAproxy IP地址透传（七层/四层）&quot;&gt;&lt;/a&gt;HAproxy IP地址透传（七层/四层）&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/01/22/HAproxyIP地址透传/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/categories/HAproxy/"/>
    
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/tags/HAproxy/"/>
    
  </entry>
  
  <entry>
    <title>HAproxy调度算法</title>
    <link href="https://daizhe.net.cn/2019/01/22/HAproxy%E8%B0%83%E5%BA%A6%E7%AE%97%E6%B3%95/"/>
    <id>https://daizhe.net.cn/2019/01/22/HAproxy调度算法/</id>
    <published>2019-01-22T05:55:02.863Z</published>
    <updated>2019-01-28T08:26:33.917Z</updated>
    
    <content type="html"><![CDATA[<h1 id="HAproxy调度算法（四层）"><a href="#HAproxy调度算法（四层）" class="headerlink" title="HAproxy调度算法（四层）"></a>HAproxy调度算法（四层）</h1><p><img src="/2019/01/22/HAproxy调度算法/标题.gif" alt=""><br><a id="more"></a></p><h2 id="HAProxy-调度算法使用的生效字段："><a href="#HAProxy-调度算法使用的生效字段：" class="headerlink" title="HAProxy 调度算法使用的生效字段："></a>HAProxy 调度算法使用的生效字段：</h2><ul><li>defaults</li><li>listen</li><li>backend</li></ul><hr><h2 id="动态算法和静态算法"><a href="#动态算法和静态算法" class="headerlink" title="动态算法和静态算法"></a>动态算法和静态算法</h2><ul><li>静态算法（算法仅根据算法本身与请求报文特征进行调度 起点公平）<ul><li>不支持运行时动态调整，不支持慢启动</li></ul></li><li>动态算法（额外考虑后端各RS的当前的负载的状态 结果公平）<ul><li>支持运行时调整，支持慢启动</li></ul></li></ul><hr><h2 id="HAProxy-静态调度算法"><a href="#HAProxy-静态调度算法" class="headerlink" title="HAProxy 静态调度算法"></a>HAProxy 静态调度算法</h2><ul><li>balance： 指明对后端服务器的调度算法，配置在listen或backend<br>静态算法：按照事先定义好的规则轮询公平调度，不关心后端服务器的当前负载、链接数和相应速度等，且无法实时修改权重，只能重启后生效。<ul><li>static-rr：基于权重的轮询调度，不支持权重的运行时调整及后端服务器慢启动，其后端主机数量没有限制</li><li>first：根据服务器在列表中的位置，自上而下进行调度，但是其只会当第一台服务器的连接数达到上限，新请求才会分配给下一台服务，因此会忽略服务器的权重设置。</li></ul></li></ul><p><code>范例：静态调度--&gt;static-rr:基于权重的轮询调度</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">roundrobin最大后端主机为4096</span><br><span class="line">static-rr 最大后端主机不上限</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#weight 设置权重</span></span><br><span class="line"><span class="comment">#这里设置的172.18.135.1权重为2，172.18.135.5权重为1</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line"><span class="comment">#httpd_server调度</span></span><br><span class="line">frontend web-port-80</span><br><span class="line">        <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">        use_backend web_host</span><br><span class="line"></span><br><span class="line">backend web_host</span><br><span class="line">        balance static-rr</span><br><span class="line">        server 172.18.135.1 172.18.135.1:8080 weight 2 check inter 2000 fall 3 rise 5</span><br><span class="line">        server 172.18.135.5 172.18.135.5:8080 weight 1</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># systemctl restart haproxy</span></span><br></pre></td></tr></table></figure></p><p><img src="/2019/01/22/HAproxy调度算法/static1.png" alt=""><br><img src="/2019/01/22/HAproxy调度算法/static1.png" alt=""><br><img src="/2019/01/22/HAproxy调度算法/static2.png" alt=""></p><p><code>范例：静态调度--&gt;first:根据服务器在列表中的位置，自上而下进行调度即优先使用第一台，当第一台的连接数上限时，才会调度到其他的主机上</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># maxconn 10  设置主机的最大连接数</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line"><span class="comment">#httpd_server调度</span></span><br><span class="line">frontend web-port-80</span><br><span class="line">        <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">        use_backend web_host</span><br><span class="line"></span><br><span class="line">backend web_host</span><br><span class="line">        balance first</span><br><span class="line">        server 172.18.135.1 172.18.135.1:8080 maxconn 10 check inter 2000 fall 3 rise 5</span><br><span class="line">        server 172.18.135.5 172.18.135.5:8080</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># systemctl restart haproxy</span></span><br></pre></td></tr></table></figure></p><p><img src="/2019/01/22/HAproxy调度算法/first.png" alt=""></p><hr><h2 id="HAProxy-动态调度算法"><a href="#HAProxy-动态调度算法" class="headerlink" title="HAProxy 动态调度算法"></a>HAProxy 动态调度算法</h2><ul><li>动态算法：基于后端服务器 状态进行调度适当调整，比如优先调度至当前负载较低的服务器，且权重可以在haproxy运行时动态调整无需重启(支持缓慢启动，实现慢慢的将流量均匀的分配到其他的后端服务器上,也支持运行时重载配置文件)。<ul><li>roundrobin：基于权重的轮询动态调度算法，支持权重的运行时调整，不等于lvs 的rr，支持慢启动即新加的服务器会逐渐增加转发数，每个后端backend中最多支持4095个server，此为默认调度算法，server 权重设置 weight</li><li>leastconn： 加权的最少连接的动态，支持权重的运行时调整和慢启动，即当前后端服务器连接最少的优先调度，比较适合长连接的场景使用，比如MySQL等场景。</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 默认动态算法roundrobin：基于权重的轮询动态调度算法</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#roundrobin 适用于无状态的连接，如果做过session会话共享或者会话绑定也可以使用</span></span><br></pre></td></tr></table></figure><hr><h2 id="HAProxy-调度算法-source"><a href="#HAProxy-调度算法-source" class="headerlink" title="HAProxy 调度算法-source"></a>HAProxy 调度算法-source</h2><ul><li>source：源地址hash，基于用户源地址hash并将请求转发到后端服务器，默认为静态即取模方式，但是可以通过hash-type支持的选项更改，后续同一个源地址请求将被转发至同一个后端web服务器，比较适用于session保持等场景。<ul><li>map-based：取模法，基于服务器权重的hash数组取模，该hash是静态的即不支持在线调整权重，不支持慢启动，其对后端服务器调度均衡，缺点是当服务器的总权重发生变化时，即有服务器上线或下线，都会因权重发生变化而导致调度结果整体改变。</li><li>consistent：一致性哈希，该hash是动态的，支持在线调整权重，支持慢启动，优点在于当服务器的总权重发生变化时，对调度结果影响是局部的，不会引起大的变动，该算法很容易导致后端服务器负载不均衡，但是比较适合session保持。</li></ul></li></ul><hr><h2 id="HAproxy-服务器动态上下线"><a href="#HAproxy-服务器动态上下线" class="headerlink" title="HAproxy 服务器动态上下线"></a>HAproxy 服务器动态上下线</h2><ul><li>静态算法：无法动态上下线</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">  ~]<span class="comment"># useradd  haproxy -s /sbin/nologin  #编译安装的需要创建账号，yum安装的则不需要创建账号</span></span><br><span class="line">  ~]<span class="comment"># mkdir  /var/lib/haproxy</span></span><br><span class="line">  ~]<span class="comment"># chown  haproxy.haproxy /var/lib/haproxy/ -R</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line">  global</span><br><span class="line">  4行</span><br><span class="line">  stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin   <span class="comment">#主要是基于socket文件对服务器进行动态修改</span></span><br><span class="line">  ...</span><br><span class="line">  <span class="comment">#httpd_server调度</span></span><br><span class="line">  frontend web-port-80</span><br><span class="line">        <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">        use_backend web_host</span><br><span class="line"></span><br><span class="line">  backend web_host</span><br><span class="line">        balance static-rr</span><br><span class="line">        server 172.18.135.1 172.18.135.1:8080 weight 2 check inter 2000 fall 3 rise 5</span><br><span class="line">        server 172.18.135.5 172.18.135.5:8080 weight 1</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart haproxy</span></span><br><span class="line"></span><br><span class="line">负载上安装支持的依赖包</span><br><span class="line">  ~]<span class="comment"># yum install socat -y    #输入重定向的工具</span></span><br><span class="line"></span><br><span class="line">查看使用帮助</span><br><span class="line">  ~]<span class="comment"># echo "show info" | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">  ~]<span class="comment"># echo "help" | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line"></span><br><span class="line">基于socat动态对话负载haproxy</span><br><span class="line">  <span class="comment">#动态修改主机的权重</span></span><br><span class="line">  ~]<span class="comment"># echo "set weight " | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">  Require <span class="string">'backend/server'</span>.   <span class="comment">#指明backend名称以及server名称</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># echo "set weight web_host/172.18.135.1 4" | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">  Backend is using a static LB algorithm and only accepts weights <span class="string">'0%'</span> and <span class="string">'100%'</span>.</span><br><span class="line"></span><br><span class="line">  <span class="comment">#提示不可以设置为4的权重，因为是使用的静态的算法只能设置为0%或者为100%（在线或者下线）</span></span><br><span class="line"></span><br><span class="line">查看权重</span><br><span class="line">  ~]<span class="comment"># echo "get weight web_host/172.18.135.1" | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">  2 (initial 2)</span><br></pre></td></tr></table></figure><hr><ul><li>动态算法：支持动态上下线<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#使用consistent：一致性哈希</span></span><br><span class="line"></span><br><span class="line">方式1：</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line"><span class="comment">#httpd_server调度</span></span><br><span class="line">frontend web-port-80</span><br><span class="line">        <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">        use_backend web_host</span><br><span class="line"></span><br><span class="line">backend web_host</span><br><span class="line">        balance <span class="built_in">source</span></span><br><span class="line">        <span class="built_in">hash</span>-type consistent</span><br><span class="line">        server 172.18.135.1 172.18.135.1:8080 weight 2 check inter 2000 fall 3 rise 5</span><br><span class="line">        server 172.18.135.5 172.18.135.5:8080 weight 1</span><br><span class="line"></span><br><span class="line">方式2：listen</span><br><span class="line">~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line"><span class="comment">#httpd_server调度</span></span><br><span class="line">listen web-port-80</span><br><span class="line">  <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">  balance <span class="built_in">source</span></span><br><span class="line">  <span class="built_in">hash</span>-type consistent</span><br><span class="line">  server 172.18.135.1 172.18.135.1:8080 weight 2 check inter 2000 fall 3 rise 5</span><br><span class="line">  server 172.18.135.5 172.18.135.5:8080 weight 1</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart haproxy</span></span><br><span class="line"></span><br><span class="line">动态修改权重（1.8版本的那个太修改权重有BUG，1.5版本就没问题）</span><br><span class="line">  ~]<span class="comment"># echo "set weight web_host/172.18.135.5 3" | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">  ~]<span class="comment"># echo "get weight web_host/172.18.135.5 3" | socat stdio /var/lib/haproxy/haproxy.sock</span></span><br><span class="line">  2019/01/22 16:42:40 socat[15995] E connect(5, AF=1 <span class="string">"/var/lib/haproxy/haproxy.sock"</span>, 31): Connection refused</span><br></pre></td></tr></table></figure></li></ul><hr><h2 id="HAProxy-调度算法-uri"><a href="#HAProxy-调度算法-uri" class="headerlink" title="HAProxy 调度算法-uri"></a>HAProxy 调度算法-uri</h2><ul><li>uri：基于对用户请求的uri做hash并将请求转发到后端指定服务器(多适用于缓存服务器，会使得后端的服务器更好的命中缓存的结果例如缓存服务器 Varnish)<ul><li>map-based：取模法</li><li>consistent：一致性哈希<ul><li><a href="http://example.org/absolute/URI/with/absolute/path/to/resource.txt" target="_blank" rel="noopener">http://example.org/absolute/URI/with/absolute/path/to/resource.txt</a>  #URI/URL</li><li><a href="ftp://example.org/resource.txt" target="_blank" rel="noopener">ftp://example.org/resource.txt</a>   #URI/URL</li><li>/relative/URI/with/absolute/path/to/resource.txt   #URI</li></ul></li></ul></li><li>uri: uniform resource identifier，统一资源标识符,是一个用于标识某一互联网资源名称的字符串</li></ul><p><img src="/2019/01/22/HAproxy调度算法/url.png" alt=""></p><p>范例：uri调度算法示例<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">前提：</span><br><span class="line">  <span class="comment">#协议必须是http，不支持tcp，会切换到tcp的roundrobin负载模式</span></span><br><span class="line">  <span class="comment">#七层调度：应用层</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line">  <span class="comment">#httpd_server调度</span></span><br><span class="line">  listen web-port-80</span><br><span class="line">        <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">        balance uri</span><br><span class="line">        <span class="built_in">hash</span>-type consistent</span><br><span class="line">        server 172.18.135.1 172.18.135.1:8080 weight 2 check inter 2000 fall 3 rise 5</span><br><span class="line">        server 172.18.135.5 172.18.135.5:8080 weight 1</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart haproxy</span></span><br><span class="line"></span><br><span class="line">客户端请求测试（已经实现基于uri绑定调度）</span><br><span class="line">  ~]<span class="comment"># curl http://172.18.135.2/</span></span><br><span class="line">  172.18.135.1</span><br><span class="line">   ~]<span class="comment"># curl http://172.18.135.2/index1.html</span></span><br><span class="line">  172.18.135.2/2</span><br></pre></td></tr></table></figure></p><hr><h2 id="HAProxy-调度算法-url-param"><a href="#HAProxy-调度算法-url-param" class="headerlink" title="HAProxy 调度算法-url_param"></a>HAProxy 调度算法-url_param</h2><ul><li>url_param：<ul><li><code>对用户请求的url中的&lt;params&gt;部分中的参数name作hash计算，并由服务器总权重相除以后派发至某挑出的服务器；通常用于追踪用户，以确保来自同一个用户的请求始终发往同一个Backend Server</code></li><li>假设url = <a href="http://www.magedu.com/foo/bar/index.php?k1=v1&amp;k2=v2" target="_blank" rel="noopener">http://www.magedu.com/foo/bar/index.php?k1=v1&amp;k2=v2</a> </li></ul></li></ul><p>范例：根据用户请求的url_param做调度<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line"><span class="comment">#httpd_server调度</span></span><br><span class="line">listen web-port-80</span><br><span class="line">      <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">      balance url-param name</span><br><span class="line">      <span class="built_in">hash</span>-type consistent</span><br><span class="line">      server 172.18.135.1 172.18.135.1:8080 weight 2 check inter 2000 fall 3 rise 5</span><br><span class="line">      server 172.18.135.5 172.18.135.5:8080 weight 1</span><br></pre></td></tr></table></figure></p><p><img src="/2019/01/22/HAproxy调度算法/url1.png" alt=""></p><hr><h2 id="HAProxy-调度算法-hdr"><a href="#HAProxy-调度算法-hdr" class="headerlink" title="HAProxy 调度算法-hdr"></a>HAProxy 调度算法-hdr</h2><ul><li><code>hdr(&lt;name&gt;)：针对用户每个http头部(header)请求中的指定信息做hash，此处由&lt;name&gt;指定的http首部将会被取出并做hash计算，然后由服务器总权重相除以后派发至某挑出的服务器，假如无有效的值，则会被轮询调度</code><ul><li>hdr( Cookie、 User-Agent、host )</li></ul></li></ul><p>范例：调度算法-hdr：针对用户每个http头部<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#可以获取报文头部的所有数据因为实在应用层</span></span><br><span class="line">  ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line">  <span class="comment">#httpd_server调度</span></span><br><span class="line">  listen web-port-80</span><br><span class="line">        mode http</span><br><span class="line">        <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">        balance hdr(User-Agent)</span><br><span class="line">        <span class="built_in">hash</span>-type consistent</span><br><span class="line">        server 172.18.135.1 172.18.135.1:8080 weight 2 check inter 2000 fall 3 rise 5</span><br><span class="line">        server 172.18.135.5 172.18.135.5:8080 weight 1</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart haproxy</span></span><br></pre></td></tr></table></figure></p><p>测试：基于不同的浏览器做访问</p><p><img src="/2019/01/22/HAproxy调度算法/头部.png" alt=""><br><img src="/2019/01/22/HAproxy调度算法/头部2.png" alt=""></p><hr><h2 id="HAProxy-调度算法-rdp-cookie-几乎不用"><a href="#HAProxy-调度算法-rdp-cookie-几乎不用" class="headerlink" title="HAProxy 调度算法- rdp-cookie(几乎不用)"></a>HAProxy 调度算法- rdp-cookie(几乎不用)</h2><ul><li>rdp-cookie对远程桌面的负载，使用cookie保持会话</li><li><code>rdp-cookie(&lt;name&gt;)</code></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#haproxy</span></span><br><span class="line">listen RDP</span><br><span class="line"><span class="built_in">bind</span>  192.168.7.101:3389</span><br><span class="line">balance rdp-cookie</span><br><span class="line">mode tcp</span><br><span class="line">server rdp0 172.18.139.20:3389 check fall 3 rise 5 inter 2000 weight 1</span><br><span class="line">server rdp1 172.18.139.21:3389 check fall 3 rise 5 inter 2000 weight 1</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#基于iptables实现目标地址转换：</span></span><br><span class="line"><span class="comment">#开启内核的转发功能：</span></span><br><span class="line">iptables -t nat -A PREROUTING -d 目标主机地址 -p tcp --dport 目标端口 -j DNAT --to-destination 转换哪个主机的：哪个端口</span><br><span class="line">iptables -t nat -A POSTROUTING -s 此网段的地址 -j SNAT --to-source  转换为哪个地址</span><br></pre></td></tr></table></figure><p><img src="/2019/01/22/HAproxy调度算法/rdb.png" alt=""></p><hr><h2 id="算法总结及适用场景"><a href="#算法总结及适用场景" class="headerlink" title="算法总结及适用场景"></a>算法总结及适用场景</h2><ul><li>static-rr</li><li>first</li><li><code>source:会话保持，小型业务或者用户源地址非集中访问</code></li><li>uri:缓存</li><li>roundrobin:无状态，session共享或者会话保持</li><li><code>leastconn:数据库，长连接</code></li><li>url_param</li><li><code>hdr:多适用于域名转发，将多个域名转发到同一个地址中</code></li></ul><hr><ul><li>roundrobin——–&gt;tcp/http 动态</li><li>leastconn———–&gt;tcp/http 动态</li><li>static-rr————–&gt;tcp/http  静态</li><li>first——————–&gt;tcp/http  静态</li><li>source—————-&gt;tcp/http     #</li><li>uri———————-&gt;http      #</li><li>url_param———-&gt;http            #   #取决于hash_type是否consistent</li><li>hdr———————&gt;http       #</li><li>rdp-cookie———&gt;tcp             #</li></ul><hr><h2 id="四层与七层的区别："><a href="#四层与七层的区别：" class="headerlink" title="四层与七层的区别："></a>四层与七层的区别：</h2><ul><li>四层：<ul><li>在四层负载设备中，把client发送的报文目标地址(原来是负载均衡设备的IP地址)，根据均衡设备设置的选择web服务器的规则选择对应的web服务器IP地址，这样client就可以直接跟此服务器建立TCP连接并发送数据。</li></ul></li></ul><p><img src="/2019/01/22/HAproxy调度算法/区别.png" alt=""></p><ul><li>七层：<ul><li>七层负载均衡服务器起了一个代理服务器的作用，服务器建立一次TCP连接要三次握手，而client要访问webserver要先与七层负载设备进行三次握手后建立TCP连接，把要访问的报文信息发送给七层负载均衡；然后七层负载均衡再根据设置的均衡规则选择特定的webserver，然后通过三次握手与此台webserver建立TCP连接，然后webserver把需要的数据发送给七层负载均衡设备，负载均衡设备再把数据发送给client；所以，七层负载均衡设备起到了代理服务器的作用。</li></ul></li></ul><p><img src="/2019/01/22/HAproxy调度算法/抓包.png" alt=""></p><hr>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;HAproxy调度算法（四层）&quot;&gt;&lt;a href=&quot;#HAproxy调度算法（四层）&quot; class=&quot;headerlink&quot; title=&quot;HAproxy调度算法（四层）&quot;&gt;&lt;/a&gt;HAproxy调度算法（四层）&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/01/22/HAproxy调度算法/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/categories/HAproxy/"/>
    
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/tags/HAproxy/"/>
    
  </entry>
  
  <entry>
    <title>HAproxy基本配置</title>
    <link href="https://daizhe.net.cn/2019/01/22/HAproxy%E5%9F%BA%E6%9C%AC%E9%85%8D%E7%BD%AE/"/>
    <id>https://daizhe.net.cn/2019/01/22/HAproxy基本配置/</id>
    <published>2019-01-22T01:48:00.524Z</published>
    <updated>2019-01-28T02:55:25.159Z</updated>
    
    <content type="html"><![CDATA[<h1 id="HAproxy基本配置"><a href="#HAproxy基本配置" class="headerlink" title="HAproxy基本配置"></a>HAproxy基本配置</h1><p><img src="/2019/01/22/HAproxy基本配置/标题.gif" alt=""><br><a id="more"></a></p><h2 id="一、源码编译安装haproxy"><a href="#一、源码编译安装haproxy" class="headerlink" title="一、源码编译安装haproxy"></a>一、源码编译安装haproxy</h2><p>haproxy 1.8版本：新特性</p><ul><li>多进程：可以最大限度的利用cpu多核心的特性，开启多个工作进程实现最大限度响应用户的目的。</li></ul><p>安装包下载路径：<a href="https://www.haproxy.org/download/1.8/src/" target="_blank" rel="noopener">https://www.haproxy.org/download/1.8/src/</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br></pre></td><td class="code"><pre><span class="line">安装依赖包</span><br><span class="line">  ~]<span class="comment"># yum install gcc gcc-c++ glibc glibc-devel pcre pcre-devel openssl  openssl-devel systemd-devel net-tools vim iotop bc  zip unzip zlib-devel lrzsz tree screen lsof tcpdump wget ntpdate -y</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line">  src]<span class="comment"># ls</span></span><br><span class="line">  haproxy-1.8.16.tar.gz</span><br><span class="line"></span><br><span class="line">  src]<span class="comment"># tar xvf haproxy-1.8.16.tar.gz </span></span><br><span class="line">  src]<span class="comment"># cd haproxy-1.8.16/</span></span><br><span class="line"></span><br><span class="line">  haproxy-1.8.16]<span class="comment"># pwd</span></span><br><span class="line">  /usr/<span class="built_in">local</span>/src/haproxy-1.8.16</span><br><span class="line"></span><br><span class="line">编译安装</span><br><span class="line">   haproxy-1.8.16]<span class="comment"># make  ARCH=x86_64 TARGET=linux2628 USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 USE_SYSTEMD=1  USE_CPU_AFFINITY=1  PREFIX=/usr/local/haproxy</span></span><br><span class="line">   haproxy-1.8.16]<span class="comment"># make install PREFIX=/usr/local/haproxy </span></span><br><span class="line"></span><br><span class="line">  haproxy-1.8.16]<span class="comment"># cp haproxy  /usr/sbin/</span></span><br><span class="line"></span><br><span class="line">创建启动脚本</span><br><span class="line">  ~]<span class="comment"># vim /usr/lib/systemd/system/haproxy.service </span></span><br><span class="line">  [Unit]</span><br><span class="line">  Description=HAProxy Load Balancer</span><br><span class="line">  After=syslog.target network.target</span><br><span class="line"></span><br><span class="line">  [Service]</span><br><span class="line">  ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg  -c -q</span><br><span class="line">  ExecStart=/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg  -p /run/haproxy.pid</span><br><span class="line">  ExecReload=/bin/<span class="built_in">kill</span> -USR2 <span class="variable">$MAINPID</span></span><br><span class="line">  [Install]</span><br><span class="line">  WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">查看haproxy 版本</span><br><span class="line">  ~]<span class="comment"># haproxy -v</span></span><br><span class="line">  HA-Proxy version 1.8.16-5c3f237 2018/12/21</span><br><span class="line">  Copyright 2000-2018 Willy Tarreau &lt;willy@haproxy.org&gt;</span><br><span class="line"></span><br><span class="line">创建目录和用户(默认启动的用户为nobody)</span><br><span class="line">  ~]<span class="comment"># mkdir  /etc/haproxy</span></span><br><span class="line">  ~]<span class="comment"># useradd haproxy -s /sbin/nologin -u 1111</span></span><br><span class="line">  ~]<span class="comment"># id haproxy</span></span><br><span class="line">  uid=1111(haproxy) gid=1111(haproxy) groups=1111(haproxy)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建配置文件</span><br><span class="line">  ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line">  global</span><br><span class="line">  maxconn 100000</span><br><span class="line">  chroot /usr/<span class="built_in">local</span>/haproxy</span><br><span class="line">  <span class="comment">#stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin</span></span><br><span class="line">  uid 1000</span><br><span class="line">  gid 1000</span><br><span class="line">  daemon</span><br><span class="line">  <span class="comment">#nbproc 4</span></span><br><span class="line">  <span class="comment">#cpu-map 1 0</span></span><br><span class="line">  <span class="comment">#cpu-map 2 1</span></span><br><span class="line">  pidfile /usr/<span class="built_in">local</span>/haproxy/run/haproxy.pid</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local3 info</span><br><span class="line"></span><br><span class="line">  defaults</span><br><span class="line">  option http-keep-alive</span><br><span class="line">  option  forwardfor</span><br><span class="line">  maxconn 100000</span><br><span class="line">  mode http</span><br><span class="line">  timeout connect 300000ms</span><br><span class="line">  timeout client  300000ms</span><br><span class="line">  timeout server  300000ms</span><br><span class="line"></span><br><span class="line">  listen stats</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:9999</span><br><span class="line">  stats <span class="built_in">enable</span></span><br><span class="line">  <span class="built_in">log</span> global</span><br><span class="line">  stats uri     /haproxy-status</span><br><span class="line">  stats auth    haadmin:q1w2e3r4ys</span><br><span class="line"></span><br><span class="line">  listen  web_port</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:80</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">log</span> global</span><br><span class="line">  server web1  127.0.0.1:8080  check inter 3000 fall 2 rise 5</span><br><span class="line"></span><br><span class="line">启动</span><br><span class="line">  ~]<span class="comment"># systemctl start haproxy</span></span><br><span class="line"></span><br><span class="line">进程查看</span><br><span class="line">  ~]<span class="comment"># ps -ef | grep haproxy</span></span><br><span class="line">  root       5883      1  0 09:36 ?        00:00:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">  haproxy     5886   5883  0 09:36 ?        00:00:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">  root       5907   5491  0 09:37 pts/0    00:00:00 grep --color=auto haproxy</span><br></pre></td></tr></table></figure></p><h2 id="二、HAProxy组成"><a href="#二、HAProxy组成" class="headerlink" title="二、HAProxy组成"></a>二、HAProxy组成</h2><ul><li>程序环境：<ul><li>主程序：/usr/sbin/haproxy</li><li>配置文件：/etc/haproxy/haproxy.cfg</li><li>Unit file：/usr/lib/systemd/system/haproxy.service</li></ul></li><li>配置段：<ul><li>global：全局配置段<ul><li>进程及安全配置相关的参数</li><li>性能调整相关参数</li><li>Debug参数</li></ul></li><li>proxy：代理配置段<ul><li>defaults：为frontend, backend, listen提供默认配置 </li><li>frontend：前端，相当于nginx中的server {}    #指明监听的地址和端口不要写*</li><li>backend：后端，相当于nginx中的upstream {}</li><li>listen：同时拥有前端和后端,适用于一对一环境</li></ul></li></ul></li></ul><h3 id="Haproxy-配置-global（全局配置端）"><a href="#Haproxy-配置-global（全局配置端）" class="headerlink" title="Haproxy 配置-global（全局配置端）"></a><code>Haproxy 配置-global（全局配置端）</code></h3><ul><li>global配置参数：</li><li><p><a href="https://cbonte.github.io/haproxy-dconv/1.8/configuration.html#3" target="_blank" rel="noopener">https://cbonte.github.io/haproxy-dconv/1.8/configuration.html#3</a></p><ul><li>chroot #锁定运行目录，当haproxy本身出现漏洞被攻击时，工作目录仅限于此运行目录</li><li>deamon #以守护进程运行</li><li>#stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin #本地通讯的socket文件</li><li>user, group, uid, gid  #运行haproxy的用户身份（可以设置用户的id或者用户名称）</li><li>nbproc  #开启的haproxy进程数，与CPU保持一致</li><li>nbthread  #指定每个haproxy进程开启的线程数，默认为每个进程一个线程</li><li><p>cpu-map 1 0 #绑定haproxy 进程至指定CPU</p></li><li><p>maxconn  #每个haproxy进程的最大并发连接数</p></li><li>maxsslconn     #SSL每个haproxy进程ssl最大连接数</li><li>maxconnrate  #每个进程每秒最大连接数</li><li>spread-checks   #后端server状态check随机提前或延迟百分比时间，建议2-5(20%-50%)之间</li><li>pidfile #指定pid文件路径</li><li>log 127.0.0.1  local3 info #定义全局的syslog服务器；最多可以定义两个</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line">...</span><br><span class="line">nbproc 4    <span class="comment">#指定haproxy的进程数</span></span><br><span class="line">cpu-map 1 0 <span class="comment">#将第一进程绑定在第0颗cpu</span></span><br><span class="line">cpu-map 2 1 <span class="comment">#将第二进程绑定在第1颗cpu</span></span><br><span class="line">...</span><br><span class="line"></span><br><span class="line"><span class="comment">#实现了一个主进程多个子进程</span></span><br><span class="line">~]<span class="comment"># ps -ef | grep haproxy</span></span><br><span class="line">root      11803      1  0 10:34 ?        00:00:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">haproxy   11805  11803  0 10:34 ?        00:00:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">haproxy   11806  11803  0 10:34 ?        00:00:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">haproxy   11807  11803  0 10:34 ?        00:00:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">haproxy   11808  11803  0 10:34 ?        00:00:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">root      11811   5491  0 10:35 pts/0    00:00:00 grep --color=auto haproxy</span><br></pre></td></tr></table></figure><h3 id="HAProxy-Proxies配置（代理配置段）"><a href="#HAProxy-Proxies配置（代理配置段）" class="headerlink" title="HAProxy Proxies配置（代理配置段）"></a><code>HAProxy Proxies配置（代理配置段）</code></h3><ul><li><code>defaults [&lt;name&gt;]  #默认配置项，针对以下的frontend、backend和lsiten生效，可以多个name</code></li><li><code>frontend &lt;name&gt;  #前端servername，类似于Nginx的一个虚拟主机 server</code></li><li><p><code>backend  &lt;name&gt; #后端服务器组，等于nginx的upstreamlisten   &lt;name&gt;      #将frontend和backend合并在一起配置</code></p></li><li><p><code>注：name字段只能使用”-”、”_”、”.”、和”:”，并且严格区分大小写，例如：Web和web是完全不同的两组服务器即是区分大小写的</code></p></li></ul><h4 id="Proxies配置-defaults（默认配置项）"><a href="#Proxies配置-defaults（默认配置项）" class="headerlink" title="Proxies配置- defaults（默认配置项）"></a>Proxies配置- defaults（默认配置项）</h4><ul><li>option redispatch    #当server Id对应的服务器挂掉后，强制定向到其他健康的服务器  </li><li>option abortonclose   #当服务器负载很高的时候，自动结束掉当前队列处理比较久的链接</li><li>option http-keep-alive #开启会话保持</li><li>option  forwardfor #开启IP透传</li><li>mode http #默认工作类型</li><li>timeout connect 120s  #连接到一台后端server的最长时间</li><li>timeout client  600s  #与客户端的最长空闲时间</li><li>timeout server  600s  #等待服务端的超时时长</li><li>timeout http-keep-alive 120s #session 会话保持时间</li><li>#timeout check   5s   #对后端服务器的检测超时时间</li></ul><h4 id="Proxies配置-frontend配置参数-前端servername"><a href="#Proxies配置-frontend配置参数-前端servername" class="headerlink" title="Proxies配置- frontend配置参数(前端servername)"></a>Proxies配置- frontend配置参数(前端servername)</h4><ul><li>bind：指定HAProxy的监听地址，可以是IPV4或IPV6，可以同时监听多个IP或端口，可同时用于listen字段中</li><li><code>bind [&lt;address&gt;]:&lt;port_range&gt; [, ...] [param*]</code></li><li>mode  http/tcp      #指定负载协议类型</li><li><p>use_backend  backend_name   #调用的后端服务器组名称</p></li><li><p>示例：</p><ul><li>frontend  WEB_PORT<ul><li>bind :80,:8080    #支持以逗号分隔的列表格式指定监听的地址以及端口多个套接字</li><li>bind 192.168.7.102:10080,192.168.7.102:10043</li><li>use_backend backend_name </li></ul></li></ul></li></ul><h2 id="范例：使用haproxy实现调度apache"><a href="#范例：使用haproxy实现调度apache" class="headerlink" title="范例：使用haproxy实现调度apache"></a>范例：使用haproxy实现调度apache</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#模拟httpd_server不直接对外服务，通过haproxy负载对外进程调度服务</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#配置haproxy实现基客户端第一次请求服务端保留的cookie进行调度</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">实验准备</span><br><span class="line">  三台主机：</span><br><span class="line">    haproxy_server :  yum install haproxy -y</span><br><span class="line">    httpd_serverA : yum install httpd -y</span><br><span class="line">    httpd_serverB : yum install httpd -y</span><br><span class="line"></span><br><span class="line">配置httpd_server测试页面</span><br><span class="line">  httpd_serverA</span><br><span class="line">  ~]<span class="comment"># echo "172.18.135.1" &gt; /var/www/html/index.html</span></span><br><span class="line">  ~]<span class="comment"># systemctl start httpd</span></span><br><span class="line">  修改端口8080</span><br><span class="line"></span><br><span class="line">  httpd_serverB</span><br><span class="line">  ~]<span class="comment"># echo "172.18.135.5" &gt; /var/www/html/index.html</span></span><br><span class="line">  ~]<span class="comment"># systemctl start httpd</span></span><br><span class="line">  修改端口8080</span><br><span class="line"></span><br><span class="line">配置haproxy负载</span><br><span class="line">  ~]<span class="comment"># yum install haproxy -y</span></span><br><span class="line">  ~]<span class="comment"># cat  /etc/haproxy/haproxy.cfg </span></span><br><span class="line">  global</span><br><span class="line">  maxconn 100000</span><br><span class="line">  chroot /usr/<span class="built_in">local</span>/haproxy</span><br><span class="line">  <span class="comment">#stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin</span></span><br><span class="line">  uid 1111</span><br><span class="line">  gid 1111</span><br><span class="line">  daemon</span><br><span class="line">  nbproc 4</span><br><span class="line">  cpu-map 1 0</span><br><span class="line">  cpu-map 2 1</span><br><span class="line">  pidfile /usr/<span class="built_in">local</span>/haproxy/run/haproxy.pid</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local3 info</span><br><span class="line"></span><br><span class="line">  defaults</span><br><span class="line">  option http-keep-alive</span><br><span class="line">  option  forwardfor</span><br><span class="line">  maxconn 100000</span><br><span class="line">  mode http</span><br><span class="line">  timeout connect 300000ms</span><br><span class="line">  timeout client  300000ms</span><br><span class="line">  timeout server  300000ms</span><br><span class="line"></span><br><span class="line">  listen stats</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:9999</span><br><span class="line">  stats <span class="built_in">enable</span></span><br><span class="line">  <span class="built_in">log</span> global</span><br><span class="line">  stats uri     /haproxy-status</span><br><span class="line">  stats auth    haadmin:q1w2e3r4ys</span><br><span class="line"></span><br><span class="line">  <span class="comment">#httpd_server调度</span></span><br><span class="line">  frontend web-port-80                      <span class="comment">#web-port-80指定的此分组的名称</span></span><br><span class="line">  <span class="built_in">bind</span> 172.18.135.2:80                    <span class="comment">#绑定在调度器本地的地址和端口</span></span><br><span class="line">  use_backend web_host                    <span class="comment">#web_hos 定义的服务的主机组</span></span><br><span class="line"></span><br><span class="line">  backend web_host                          <span class="comment">#调用web_hos主机组</span></span><br><span class="line">  server 172.18.135.1 172.18.135.1:80     <span class="comment"># 172.18.135.1为定义的主机的名称，172.18.135.1:80 定义的后端的主机的地址及服务的端口</span></span><br><span class="line">  server 172.18.135.5 172.18.135.5:80</span><br><span class="line"></span><br><span class="line">启动查看端口 </span><br><span class="line">  ~]<span class="comment"># systemctl start haproxy</span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  9999   </span><br><span class="line">  172.18.135.2:80 </span><br><span class="line"></span><br><span class="line">-----------------------------------------------------------------------------------------------</span><br><span class="line"></span><br><span class="line">haproxy的配置文件中调用主机中也可以写为 <span class="comment">#此处制定默认的backend，适用于backend少的情况下使用</span></span><br><span class="line">frontend myweb *:80</span><br><span class="line">  default_backend webserver</span><br><span class="line"></span><br><span class="line">backend webserver</span><br><span class="line">  server web1 后端主机地址A check</span><br><span class="line">  server web1 后端主机地址B check</span><br><span class="line"></span><br><span class="line">----------------------------------------------------------------------------------------------</span><br><span class="line">也可以使用listen的方式指定</span><br><span class="line">listen myweb </span><br><span class="line">  <span class="built_in">bind</span></span><br><span class="line">  server web1 后端主机的地址A check</span><br><span class="line">  server web2 后端主机的地址B check</span><br></pre></td></tr></table></figure><p>测试：访问调度器地址验证是否调度成功</p><ul><li>默认的调度算法为轮询</li></ul><p><img src="/2019/01/22/HAproxy基本配置/2.png" alt=""><br><img src="/2019/01/22/HAproxy基本配置/3.png" alt=""></p><ul><li>也可以使用下面命令的用法来验证调度是否成功</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># while true; do curl http://172.18.135.2/; sleep .5; done</span></span><br></pre></td></tr></table></figure><h4 id="Proxies配置-backend配置参数"><a href="#Proxies配置-backend配置参数" class="headerlink" title="Proxies配置- backend配置参数"></a>Proxies配置- backend配置参数</h4><ul><li>mode  http/tcp/health     #指定负载协议类型</li><li>option  #配置选项</li><li><p>server   #定义后端real server</p></li><li><p>注意：option后面加httpchk，smtpchk, mysql-check, pgsql-check，ssl-hello-chk方法，可用于实现更多应用层检测功能。</p></li></ul><h2 id="三、后端服务器状态监测及相关配置"><a href="#三、后端服务器状态监测及相关配置" class="headerlink" title="三、后端服务器状态监测及相关配置"></a>三、后端服务器状态监测及相关配置</h2><ul><li>check #对指定real进行健康状态检查，默认不开启<ul><li>addr IP    #可指定的健康状态监测IP</li><li>port num  #指定的健康状态监测端口</li><li>inter num #健康状态检查间隔时间，默认2000 ms(2秒)</li><li>fall  num   #后端服务器失效检查次数，默认为3</li><li>rise num    #后端服务器从下线恢复检查次数，默认为2</li><li><code>weight  #默认为1，最大值为256，0表示不参与负载均衡 (默认轮询、加权)</code></li><li>backup #将后端服务器标记为备份状态</li><li>disabled #将后端服务器标记为不可用状态</li><li>redir <a href="http://www.magedu.com/" target="_blank" rel="noopener">http://www.magedu.com/</a> #将请求临时重定向至其它URL，只适用于http模式</li><li><code>maxconn &lt;maxconn&gt;：当前后端server的最大并发连接数</code></li><li><code>backlog &lt;backlog&gt;：当server的连接数达到上限后的后援队列长度</code></li></ul></li></ul><h2 id="范例：对调度器调度的后端服务器开启健康状态检测"><a href="#范例：对调度器调度的后端服务器开启健康状态检测" class="headerlink" title="范例：对调度器调度的后端服务器开启健康状态检测"></a>范例：对调度器调度的后端服务器开启健康状态检测</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">生产中的定义恢复的次数要比下线的次数要长</span><br><span class="line">~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line"><span class="comment">#httpd_server调度</span></span><br><span class="line">frontend web-port-80</span><br><span class="line">        <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">        use_backend web_host</span><br><span class="line"></span><br><span class="line">backend web_host</span><br><span class="line">        server 172.18.135.1 172.18.135.1:8080 check addr 172.18.135.1 port 8080 inter 2000 fall 3 rise 5</span><br><span class="line">        server 172.18.135.5 172.18.135.5:8080</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># systemctl restart haproxy</span></span><br></pre></td></tr></table></figure><h2 id="frontend和backend-字段也可以写为listen（适用于配置较多的场景）"><a href="#frontend和backend-字段也可以写为listen（适用于配置较多的场景）" class="headerlink" title="frontend和backend 字段也可以写为listen（适用于配置较多的场景）"></a>frontend和backend 字段也可以写为listen（适用于配置较多的场景）</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line"></span><br><span class="line">listen的配置当时</span><br><span class="line"></span><br><span class="line"><span class="comment">#httpd_server调度</span></span><br><span class="line">listen web-port-80</span><br><span class="line"><span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">        server 172.18.135.5 172.18.135.5:8080</span><br><span class="line">        server 172.18.135.1 172.18.135.1:8080 check inter 2000 fall 3 rise 5</span><br><span class="line"></span><br><span class="line">frontend和backend配置方式</span><br><span class="line"></span><br><span class="line"><span class="comment">#httpd_server调度</span></span><br><span class="line">frontend web-port-80</span><br><span class="line">        <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">        use_backend web_host</span><br><span class="line"></span><br><span class="line">backend web_host</span><br><span class="line">        server 172.18.135.1 172.18.135.1:8080 check  inter 2000 fall 3 rise 5</span><br><span class="line">        server 172.18.135.5 172.18.135.5:8080</span><br></pre></td></tr></table></figure><h2 id="范例：redir将请求临时重定向至其它URL，只适用于http模式"><a href="#范例：redir将请求临时重定向至其它URL，只适用于http模式" class="headerlink" title="范例：redir将请求临时重定向至其它URL，只适用于http模式"></a>范例：redir将请求临时重定向至其它URL，只适用于http模式</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">编辑paproxy调度器的配置文件</span><br><span class="line">  ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line">  <span class="comment">#httpd_server调度</span></span><br><span class="line">  frontend web-port-80</span><br><span class="line">        <span class="built_in">bind</span> 172.18.135.2:80</span><br><span class="line">        use_backend web_host</span><br><span class="line"></span><br><span class="line">  backend web_host</span><br><span class="line">        redirect prefix http://www.daizhe.net.cn/</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart haproxy</span></span><br><span class="line"></span><br><span class="line">客户端访问负载的地址</span><br><span class="line">  ~]<span class="comment"># curl -I  172.18.135.2:80</span></span><br><span class="line">  HTTP/1.1 302 Found</span><br><span class="line">  Cache-Control: no-cache</span><br><span class="line">  Content-length: 0</span><br><span class="line">  Location: http://www.daizhe.net.cn//</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#302临时重定向</span></span><br><span class="line"><span class="comment">#301永久重定向</span></span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;HAproxy基本配置&quot;&gt;&lt;a href=&quot;#HAproxy基本配置&quot; class=&quot;headerlink&quot; title=&quot;HAproxy基本配置&quot;&gt;&lt;/a&gt;HAproxy基本配置&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/01/22/HAproxy基本配置/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/categories/HAproxy/"/>
    
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/tags/HAproxy/"/>
    
  </entry>
  
  <entry>
    <title>HAproxy简介</title>
    <link href="https://daizhe.net.cn/2019/01/21/HAproxy%E7%AE%80%E4%BB%8B/"/>
    <id>https://daizhe.net.cn/2019/01/21/HAproxy简介/</id>
    <published>2019-01-21T11:14:16.592Z</published>
    <updated>2019-01-29T03:42:46.875Z</updated>
    
    <content type="html"><![CDATA[<h1 id="HAproxy简介"><a href="#HAproxy简介" class="headerlink" title="HAproxy简介"></a>HAproxy简介</h1><p><img src="/2019/01/21/HAproxy简介/标题.gif" alt=""><br><a id="more"></a></p><ul><li>LB（负载均衡）集群</li></ul><p>公有云Web架构<br><img src="/2019/01/21/HAproxy简介/web.png" alt=""></p><p><img src="/2019/01/21/HAproxy简介/公有云架构.png" alt=""></p><h2 id="一、什么是负载均衡："><a href="#一、什么是负载均衡：" class="headerlink" title="一、什么是负载均衡："></a>一、什么是负载均衡：</h2><ul><li><p>负载均衡(Load Balance，简称LB)是一种服务或基于硬件设备等实现的高可用反向代理技术，负载均衡将特定的业务(web服务、网络流量等)分担给指定的一个或多个后端特定的服务器或设备，从而提高了公司业务的并发处理能力、保证了业务的高可用性、方便了业务后期的水平动态扩展。</p></li><li><p>阿里云SLB介绍 <a href="https://yq.aliyun.com/articles/1803" target="_blank" rel="noopener">https://yq.aliyun.com/articles/1803</a> </p></li></ul><p><img src="/2019/01/21/HAproxy简介/LB.png" alt=""></p><h2 id="二、为什么使用负载均衡"><a href="#二、为什么使用负载均衡" class="headerlink" title="二、为什么使用负载均衡"></a>二、为什么使用负载均衡</h2><ul><li>Web服务器的动态水平扩展<ul><li>对用户无感知</li></ul></li><li>增加业务并发访问及处理能力<ul><li>解决单服务器瓶颈问题</li></ul></li><li>节约公网IP地址<ul><li>降低IT支出成本</li></ul></li><li>隐藏内部服务器IP<ul><li>提高内部服务器安全性</li></ul></li><li>配置简单<ul><li>固定格式的配置文件</li></ul></li><li>功能丰富<ul><li>支持四层和七层，支持动态下线主机</li></ul></li><li>性能较强<ul><li>并发数万甚至数十万</li></ul></li></ul><h2 id="三、常见的负载均衡"><a href="#三、常见的负载均衡" class="headerlink" title="三、常见的负载均衡"></a>三、常见的负载均衡</h2><ul><li><p>软件负载：</p><ul><li><p>四层：</p><ul><li>LVS(Linux Virtual Server)：工作在内核当中</li><li>HAProxy(High Availability Proxy)</li><li>Nginx （1.9.0 以上版本 stream功能）</li></ul></li><li><p>七层：</p><ul><li>HAProxy </li><li>Nginx</li></ul></li></ul></li><li><p>硬件负载：</p><ul><li>F5</li><li>Netscaler</li></ul></li><li><p>应用场景：</p><ul><li>四层：Redis、Mysql、RabbitMQ、Memcache等</li><li>七层：Nginx、Tomcat、Apache、PHP 、图片、动静分离、API等</li></ul></li></ul><h2 id="四、HAProxy介绍"><a href="#四、HAProxy介绍" class="headerlink" title="四、HAProxy介绍"></a>四、HAProxy介绍</h2><ul><li>HAProxy: 是法国开发者Willy Tarreau开发的一个开源软件，是一款具备高并发、高性能的TCP和HTTP负载均衡器，支持基于cookie的持久性，自动故障切换，支持正则表达式为基础的控制运行时间基本web的报表，高级日志记录以帮助排除故障的应用或网络及其他功能。</li><li><p><code>LB Cluster:</code></p><ul><li><code>四层：lvs, nginx(stream模式且nginx1.9.0或更新版本)，haproxy(mode tcp)</code></li><li><code>七层：http: nginx(http), haproxy(mode http), httpd...</code></li></ul></li><li><p>官网：</p><ul><li><a href="http://www.haproxy.org" target="_blank" rel="noopener">http://www.haproxy.org</a></li><li><a href="https://www.haproxy.com" target="_blank" rel="noopener">https://www.haproxy.com</a></li></ul></li><li><p>githun上的文档：<a href="https://cbonte.github.io/haproxy-dconv/" target="_blank" rel="noopener">https://cbonte.github.io/haproxy-dconv/</a> </p></li></ul><h2 id="五、HAProxy功能"><a href="#五、HAProxy功能" class="headerlink" title="五、HAProxy功能"></a>五、HAProxy功能</h2><ul><li><p>HAProxy是TCP / HTTP反向代理服务器，尤其适合于高可用性高并发环境</p><ul><li>可以针对HTTP请求添加cookie，进行路由后端服务器</li><li>可平衡负载至后端服务器，并支持持久连接</li><li>支持基于cookie进行调度</li><li>支持所有主服务器故障切换至备用服务器</li><li>支持专用端口实现监控服务</li><li>支持不影响现有连接情况下停止接受新连接请求</li><li>可以在双向添加，修改或删除HTTP报文首部</li><li>支持基于pattern实现连接请求的访问控制</li><li>通过特定的URI为授权用户提供详细的状态信息</li></ul></li><li><p>HAproxy工作场景：七层http/四层tcp</p><ul><li>工作于七层:解析http请求，可以完成对用户请求的按照内容的类型进行分别调度</li><li>工作于四层：模拟对其他tcp/udp协议传输的应用层服务的调度转发</li><li>工作于前端: 作为https的卸载器</li></ul></li></ul><p>应用场景<br><img src="/2019/01/21/HAproxy简介/应用场景.png" alt=""></p><h2 id="六、安装HAproxy"><a href="#六、安装HAproxy" class="headerlink" title="六、安装HAproxy"></a>六、安装HAproxy</h2><p>1、yum 方式安装haproxy<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">默认base源中HAproxy 1.5版本</span><br><span class="line">  ~]<span class="comment"># yum list haproxy</span></span><br><span class="line">  haproxy.x86_64    1.5.18-8.el7     base</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># yum install haproxy -y</span></span><br><span class="line"></span><br><span class="line">分析haproxy安装的程序文件</span><br><span class="line">   ~]<span class="comment"># rpm -ql haproxy</span></span><br><span class="line">  /etc/haproxy/haproxy.cfg  <span class="comment">#主配置文件</span></span><br><span class="line">  /etc/sysconfig/haproxy    <span class="comment">#环境变量的配置文件，用途少，主要用于传递参数</span></span><br><span class="line">  /usr/lib/systemd/system/haproxy.service   <span class="comment">#程序的启动脚本</span></span><br><span class="line">  <span class="comment">#1.7版本之前启动调用的二进制文件，1.8以后则不使用了（ExecStart=/usr/sbin/haproxy-systemd-wrapper -f /etc/haproxy/haproxy）</span></span><br><span class="line">  /usr/sbin/haproxy</span><br><span class="line">  /usr/sbin/haproxy-systemd-wrapper</span><br><span class="line"></span><br><span class="line">启动</span><br><span class="line">  ~]<span class="comment"># systemctl start haproxy</span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  *:5000  </span><br><span class="line"></span><br><span class="line">查看1.5版本实现的伪多进程</span><br><span class="line">  ~]<span class="comment"># ps -ef | grep haproxy</span></span><br><span class="line">  root       3856      1  0 21:00 ?        00:00:00 /usr/sbin/haproxy-systemd-wrapper -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid <span class="comment">#主进程</span></span><br><span class="line">  haproxy    3857   3856  0 21:00 ?        00:00:00 /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds</span><br><span class="line">  haproxy    3858   3857  0 21:00 ?        00:00:00 /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds</span><br><span class="line">  root       4097   2822  0 21:02 pts/0    00:00:00 grep --color=auto haproxy</span><br></pre></td></tr></table></figure></p><p>2、源码编译安装haproxy<br>haproxy 1.8版本：新特性</p><ul><li>多进程：可以最大限度的利用cpu多核心的特性，开启多个工作进程实现最大限度响应用户的目的。</li></ul><p>安装包下载路径：<a href="https://www.haproxy.org/download/1.8/src/" target="_blank" rel="noopener">https://www.haproxy.org/download/1.8/src/</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br></pre></td><td class="code"><pre><span class="line">安装依赖包</span><br><span class="line">  ~]<span class="comment"># yum install gcc gcc-c++ glibc glibc-devel pcre pcre-devel openssl  openssl-devel systemd-devel net-tools vim iotop bc  zip unzip zlib-devel lrzsz tree screen lsof tcpdump wget ntpdate -y</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line">  src]<span class="comment"># ls</span></span><br><span class="line">  haproxy-1.8.16.tar.gz</span><br><span class="line"></span><br><span class="line">  src]<span class="comment"># tar xvf haproxy-1.8.16.tar.gz </span></span><br><span class="line">  src]<span class="comment"># cd haproxy-1.8.16/</span></span><br><span class="line"></span><br><span class="line">  haproxy-1.8.16]<span class="comment"># pwd</span></span><br><span class="line">  /usr/<span class="built_in">local</span>/src/haproxy-1.8.16</span><br><span class="line"></span><br><span class="line">编译安装</span><br><span class="line">   haproxy-1.8.16]<span class="comment"># make  ARCH=x86_64 TARGET=linux2628 USE_PCRE=1 USE_OPENSSL=1 USE_ZLIB=1 USE_SYSTEMD=1  USE_CPU_AFFINITY=1  PREFIX=/usr/local/haproxy</span></span><br><span class="line">   haproxy-1.8.16]<span class="comment"># make install PREFIX=/usr/local/haproxy </span></span><br><span class="line"></span><br><span class="line">  haproxy-1.8.16]<span class="comment"># cp haproxy  /usr/sbin/</span></span><br><span class="line"></span><br><span class="line">创建启动脚本</span><br><span class="line">  ~]<span class="comment"># vim /usr/lib/systemd/system/haproxy.service </span></span><br><span class="line">  [Unit]</span><br><span class="line">  Description=HAProxy Load Balancer</span><br><span class="line">  After=syslog.target network.target</span><br><span class="line"></span><br><span class="line">  [Service]</span><br><span class="line">  ExecStartPre=/usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg  -c -q</span><br><span class="line">  ExecStart=/usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg  -p /run/haproxy.pid</span><br><span class="line">  ExecReload=/bin/<span class="built_in">kill</span> -USR2 <span class="variable">$MAINPID</span></span><br><span class="line">  [Install]</span><br><span class="line">  WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line">查看haproxy 版本</span><br><span class="line">  ~]<span class="comment"># haproxy -v</span></span><br><span class="line">  HA-Proxy version 1.8.16-5c3f237 2018/12/21</span><br><span class="line">  Copyright 2000-2018 Willy Tarreau &lt;willy@haproxy.org&gt;</span><br><span class="line"></span><br><span class="line">创建目录和用户</span><br><span class="line">  ~]<span class="comment"># mkdir  /etc/haproxy</span></span><br><span class="line"></span><br><span class="line">创建配置文件</span><br><span class="line">  ~]<span class="comment"># vim /etc/haproxy/haproxy.cfg </span></span><br><span class="line">  global</span><br><span class="line">  maxconn 100000</span><br><span class="line">  chroot /usr/<span class="built_in">local</span>/haproxy</span><br><span class="line">  <span class="comment">#stats socket /var/lib/haproxy/haproxy.sock mode 600 level admin</span></span><br><span class="line">  uid 99</span><br><span class="line">  gid 99</span><br><span class="line">  daemon</span><br><span class="line">  <span class="comment">#nbproc 4</span></span><br><span class="line">  <span class="comment">#cpu-map 1 0</span></span><br><span class="line">  <span class="comment">#cpu-map 2 1</span></span><br><span class="line">  pidfile /usr/<span class="built_in">local</span>/haproxy/run/haproxy.pid</span><br><span class="line">  <span class="built_in">log</span> 127.0.0.1 local3 info</span><br><span class="line"></span><br><span class="line">  defaults</span><br><span class="line">  option http-keep-alive</span><br><span class="line">  option  forwardfor</span><br><span class="line">  maxconn 100000</span><br><span class="line">  mode http</span><br><span class="line">  timeout connect 300000ms</span><br><span class="line">  timeout client  300000ms</span><br><span class="line">  timeout server  300000ms</span><br><span class="line"></span><br><span class="line">  listen stats</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:9999</span><br><span class="line">  stats <span class="built_in">enable</span></span><br><span class="line">  <span class="built_in">log</span> global</span><br><span class="line">  stats uri     /haproxy-status</span><br><span class="line">  stats auth    haadmin:q1w2e3r4ys</span><br><span class="line"></span><br><span class="line">  listen  web_port</span><br><span class="line">  <span class="built_in">bind</span> 0.0.0.0:80</span><br><span class="line">  mode http</span><br><span class="line">  <span class="built_in">log</span> global</span><br><span class="line">  server web1  127.0.0.1:8080  check inter 3000 fall 2 rise 5</span><br><span class="line"></span><br><span class="line">启动</span><br><span class="line">  ~]<span class="comment"># systemctl start haproxy</span></span><br><span class="line">  ~]<span class="comment"># systemctl enable haproxy</span></span><br><span class="line"></span><br><span class="line">进程查看</span><br><span class="line">  ~]<span class="comment"># ps -ef | grep haproxy</span></span><br><span class="line">  root       5883      1  0 09:36 ?        00:00:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">  nobody     5886   5883  0 09:36 ?        00:00:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">  root       5907   5491  0 09:37 pts/0    00:00:00 grep --color=auto haproxy</span><br></pre></td></tr></table></figure></p><ul><li>启动验证haproxy状态：<ul><li>以下是1.8.3版本的单主进程多子进程模式：</li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">haproxy-1.8.3]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">haproxy-1.8.3]<span class="comment"># systemctl  restart haproxy</span></span><br><span class="line">haproxy-1.8.3]<span class="comment"># cat /run/haproxy.pid </span></span><br><span class="line">41998</span><br><span class="line">haproxy-1.8.3]<span class="comment"># ps -ef | grep haproxy</span></span><br><span class="line">root      41998      1  0 16:27 ?        00:00:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">nobody    41999  41998  0 16:27 ?        00:00:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">nobody    42000  41998  0 16:27 ?        00:00:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">nobody    42001  41998  0 16:27 ?        00:00:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">nobody    42002  41998  0 16:27 ?        00:00:00 /usr/sbin/haproxy -Ws -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">root      42186  10580  0 16:28 pts/14   00:00:00 grep --color=auto haproxy</span><br></pre></td></tr></table></figure><ul><li>以下是1.7版本的传统多进程的haproxy模式：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># ps -ef | grep haproxy</span></span><br><span class="line">root     118786      1  0 17:10 ?        00:00:00 /usr/sbin/haproxy-systemd-wrapper -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid</span><br><span class="line">root     118787 118786  0 17:10 ?        00:00:00 [haproxy] &lt;defunct&gt;</span><br><span class="line">nobody   118788      1  6 17:10 ?        00:00:00 /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds</span><br><span class="line">nobody   118789      1  6 17:10 ?        00:00:00 /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds</span><br><span class="line">nobody   118790      1  3 17:10 ?        00:00:00 /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds</span><br><span class="line">nobody   118791      1  5 17:10 ?        00:00:00 /usr/sbin/haproxy -f /etc/haproxy/haproxy.cfg -p /run/haproxy.pid -Ds</span><br><span class="line">root     118814  99636  0 17:10 pts/0    00:00:00 grep --color=auto haproxy</span><br></pre></td></tr></table></figure><ul><li>以下是Nginx的单主进程多子进程模式，此模式和1.8.3版本的haproxy工作模式是类似的：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># ps -ef | grep nginx</span></span><br><span class="line">root     13399     1  0 Jan06 ?        00:00:01 nginx: master process /apps/tengine/sbin/nginx -s start</span><br><span class="line">devops   22165 22122  0 16:20 pts/0    00:00:00 grep --color=auto nginx</span><br><span class="line">zceo     22915 13399  0 Jan13 ?        00:41:41 nginx: worker process</span><br><span class="line">zceo     22916 13399  0 Jan13 ?        00:41:59 nginx: worker process</span><br><span class="line">zceo     22917 13399  0 Jan13 ?        00:41:38 nginx: worker process</span><br><span class="line">zceo     22918 13399  0 Jan13 ?        00:41:32 nginx: worker process</span><br><span class="line">zceo     22919 13399  0 Jan13 ?        00:41:22 nginx: worker process</span><br><span class="line">zceo     22920 13399  0 Jan13 ?        00:41:40 nginx: worker process</span><br><span class="line">zceo     22921 13399  0 Jan13 ?        00:42:07 nginx: worker process</span><br><span class="line">zceo     22922 13399  0 Jan13 ?        00:41:40 nginx: worker process</span><br></pre></td></tr></table></figure><ul><li>以下是apache的单主进程多子进程模式，也和1.8.3版本的haproxy工作模式类似：</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># ps -ef | grep apache</span></span><br><span class="line">root      6758     1  0 11:01 ?        00:00:00 /usr/<span class="built_in">local</span>/apache2.2.17/bin/httpd -k start</span><br><span class="line">webshop   6760  6758  0 11:01 ?        00:00:00 /usr/<span class="built_in">local</span>/apache2.2.17/bin/httpd -k start</span><br><span class="line">webshop   6761  6758  0 11:01 ?        00:00:02 /usr/<span class="built_in">local</span>/apache2.2.17/bin/httpd -k start</span><br><span class="line">webshop   6762  6758  0 11:01 ?        00:00:03 /usr/<span class="built_in">local</span>/apache2.2.17/bin/httpd -k start</span><br><span class="line">webshop   6764  6758  0 11:01 ?        00:00:03 /usr/<span class="built_in">local</span>/apache2.2.17/bin/httpd -k start</span><br><span class="line">webshop   6770  6758  0 11:01 ?        00:00:03 /usr/<span class="built_in">local</span>/apache2.2.17/bin/httpd -k start</span><br><span class="line">webshop   6771  6758  0 11:01 ?        00:00:03 /usr/<span class="built_in">local</span>/apache2.2.17/bin/httpd -k start</span><br><span class="line">webshop   6780  6758  0 11:01 ?        00:00:02 /usr/<span class="built_in">local</span>/apache2.2.17/bin/httpd -k start</span><br><span class="line">root      8076  8038  0 11:50 pts/2    00:00:00 grep apache</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;HAproxy简介&quot;&gt;&lt;a href=&quot;#HAproxy简介&quot; class=&quot;headerlink&quot; title=&quot;HAproxy简介&quot;&gt;&lt;/a&gt;HAproxy简介&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/01/21/HAproxy简介/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/categories/HAproxy/"/>
    
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/tags/HAproxy/"/>
    
  </entry>
  
  <entry>
    <title>session一致性架构设计实践</title>
    <link href="https://daizhe.net.cn/2019/01/20/session%E4%B8%80%E8%87%B4%E6%80%A7%E6%9E%B6%E6%9E%84%E8%AE%BE%E8%AE%A1%E5%AE%9E%E8%B7%B5/"/>
    <id>https://daizhe.net.cn/2019/01/20/session一致性架构设计实践/</id>
    <published>2019-01-20T11:44:12.413Z</published>
    <updated>2019-01-20T12:53:20.198Z</updated>
    
    <content type="html"><![CDATA[<h1 id="session一致性架构设计实践"><a href="#session一致性架构设计实践" class="headerlink" title="session一致性架构设计实践"></a>session一致性架构设计实践</h1><p><img src="/2019/01/20/session一致性架构设计实践/标题.gif" alt=""><br><a id="more"></a></p><h2 id="一、缘起"><a href="#一、缘起" class="headerlink" title="一、缘起"></a>一、缘起</h2><p>什么是session？</p><ul><li>服务器为每个用户创建一个会话，存储用户的相关信息，以便多次请求能够定位到同一个上下文。</li><li>Web开发中，web-server可以自动为同一个浏览器的访问用户自动创建session，提供数据存储功能。最常见的，会把用户的登录信息、用户信息存储在session中，以保持登录状态。</li></ul><p>什么是session一致性问题？</p><ul><li>只要用户不重启浏览器，每次http短连接请求，理论上服务端都能定位到session，保持会话。</li></ul><p><img src="/2019/01/20/session一致性架构设计实践/1.png" alt=""></p><ul><li><p>当只有一台web-server提供服务时，每次http短连接请求，都能够正确路由到存储session的对应web-server（废话，因为只有一台）。</p></li><li><p>此时的web-server是无法保证高可用的，采用“冗余+故障转移”的多台web-server来保证高可用时，每次http短连接请求就不一定能路由到正确的session了。</p></li></ul><p><img src="/2019/01/20/session一致性架构设计实践/2.png" alt=""></p><ul><li><p>如上图，假设用户包含登录信息的session都记录在第一台web-server上，反向代理如果将请求路由到另一台web-server上，可能就找不到相关信息，而导致用户需要重新登录。</p></li><li><p>在web-server高可用时，如何保证session路由的一致性，是今天将要讨论的问题。</p></li></ul><h2 id="二、session同步法"><a href="#二、session同步法" class="headerlink" title="二、session同步法"></a>二、session同步法</h2><p><img src="/2019/01/20/session一致性架构设计实践/3.png" alt=""></p><ul><li><p>思路：多个web-server之间相互同步session，这样每个web-server之间都包含全部的session</p></li><li><p>优点：web-server支持的功能，应用程序不需要修改代码</p></li><li><p>不足：</p><ul><li>session的同步需要数据传输，占内网带宽，有时延</li><li>所有web-server都包含所有session数据，数据量受内存限制，无法水平扩展</li><li>有更多web-server时要歇菜</li></ul></li></ul><h2 id="三、客户端存储法"><a href="#三、客户端存储法" class="headerlink" title="三、客户端存储法"></a>三、客户端存储法</h2><p><img src="/2019/01/20/session一致性架构设计实践/4.png" alt=""></p><ul><li>思路：服务端存储所有用户的session，内存占用较大，可以将session存储到浏览器cookie中，每个端只要存储一个用户的数据了</li><li>优点：服务端不需要存储</li><li>缺点：<ul><li>每次http请求都携带session，占外网带宽</li><li>数据存储在端上，并在网络传输，存在泄漏、篡改、窃取等安全隐患</li><li>session存储的数据大小受cookie限制</li></ul></li><li>“端存储”的方案虽然不常用，但确实是一种思路。</li></ul><h2 id="四、反向代理hash一致性"><a href="#四、反向代理hash一致性" class="headerlink" title="四、反向代理hash一致性"></a>四、反向代理hash一致性</h2><ul><li>思路：web-server为了保证高可用，有多台冗余，反向代理层能不能做一些事情，让同一个用户的请求保证落在一台web-server上呢？</li></ul><p><img src="/2019/01/20/session一致性架构设计实践/5.png" alt=""></p><h3 id="方案一：四层代理hash"><a href="#方案一：四层代理hash" class="headerlink" title="方案一：四层代理hash"></a>方案一：四层代理hash</h3><ul><li>反向代理层使用用户ip来做hash，以保证同一个ip的请求落在同一个web-server上</li></ul><p><img src="/2019/01/20/session一致性架构设计实践/6.png" alt=""></p><h3 id="方案二：七层代理hash"><a href="#方案二：七层代理hash" class="headerlink" title="方案二：七层代理hash"></a>方案二：七层代理hash</h3><ul><li>反向代理使用http协议中的某些业务属性来做hash，例如sid，city_id，user_id等，能够更加灵活的实施hash策略，以保证同一个浏览器用户的请求落在同一个web-server上</li><li><p>优点：</p><ul><li>只需要改nginx配置，不需要修改应用代码</li><li>负载均衡，只要hash属性是均匀的，多台web-server的负载是均衡的</li><li>可以支持web-server水平扩展（session同步法是不行的，受内存限制）</li></ul></li><li><p>不足：</p><ul><li>如果web-server重启，一部分session会丢失，产生业务影响，例如部分用户重新登录</li><li><p>如果web-server水平扩展，rehash后session重新分布，也会有一部分用户路由不到正确的session</p></li><li><p>session一般是有有效期的，所有不足中的两点，可以认为等同于部分session失效，一般问题不大。</p></li><li>对于四层hash还是七层hash，个人推荐前者：让专业的软件做专业的事情，反向代理就负责转发，尽量不要引入应用层业务属性，除非不得不这么做（例如，有时候多机房多活需要按照业务属性路由到不同机房的web-server）。</li></ul></li></ul><h2 id="四、后端统一存储"><a href="#四、后端统一存储" class="headerlink" title="四、后端统一存储"></a>四、后端统一存储</h2><p><img src="/2019/01/20/session一致性架构设计实践/7.png" alt=""></p><ul><li>思路：将session存储在web-server后端的存储层，数据库或者缓存</li><li><p>优点：</p><ul><li>没有安全隐患</li><li>可以水平扩展，数据库/缓存水平切分即可</li><li>web-server重启或者扩容都不会有session丢失</li></ul></li><li><p>不足：增加了一次网络调用，并且需要修改应用代码</p><ul><li>对于db存储还是cache，个人推荐后者：session读取的频率会很高，数据库压力会比较大。如果有session高可用需求，cache可以做高可用，但大部分情况下session可以丢失，一般也不需要考虑高可用。</li></ul></li></ul><h2 id="五、总结"><a href="#五、总结" class="headerlink" title="五、总结"></a>五、总结</h2><ul><li><p>保证session一致性的架构设计常见方法：</p><ul><li>session同步法：多台web-server相互同步数据</li><li>客户端存储法：一个用户只存储自己的数据</li><li>反向代理hash一致性：四层hash和七层hash都可以做，保证一个用户的请求落在一台web-server上</li><li>后端统一存储：web-server重启和扩容，session也不会丢失</li></ul></li><li><p>对于方案3和方案4，个人建议推荐后者：</p><ul><li>web层、service层无状态是大规模分布式系统设计原则之一，session属于状态，不宜放在web层</li><li>让专业的软件做专业的事情，web-server存session？还是让cache去做这样的事情吧</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;session一致性架构设计实践&quot;&gt;&lt;a href=&quot;#session一致性架构设计实践&quot; class=&quot;headerlink&quot; title=&quot;session一致性架构设计实践&quot;&gt;&lt;/a&gt;session一致性架构设计实践&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/01/20/session一致性架构设计实践/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="outside class" scheme="https://daizhe.net.cn/categories/outside-class/"/>
    
    
      <category term="outside class" scheme="https://daizhe.net.cn/tags/outside-class/"/>
    
  </entry>
  
  <entry>
    <title>tomcat会话服务</title>
    <link href="https://daizhe.net.cn/2019/01/20/tomcat%E4%BC%9A%E8%AF%9D%E6%9C%8D%E5%8A%A1/"/>
    <id>https://daizhe.net.cn/2019/01/20/tomcat会话服务/</id>
    <published>2019-01-20T03:35:27.812Z</published>
    <updated>2019-01-22T12:09:44.669Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Tomcat-Session-Server"><a href="#Tomcat-Session-Server" class="headerlink" title="Tomcat Session Server"></a>Tomcat Session Server</h1><p><img src="/2019/01/20/tomcat会话服务/标题.gif" alt=""><br><a id="more"></a></p><h2 id="session会话"><a href="#session会话" class="headerlink" title="session会话"></a>session会话</h2><ul><li>session(会话保持)<ul><li>session stick:调度器<ul><li>使用调度器的调度算法来解决问题，损害调度器的负载均衡效果，引入session单点即有一台服务器宕机都会造成数据的丢失。</li></ul></li><li>session replication cluster (sesssion复制集群)：后端服务器组织成集群<ul><li>将后端的服务器组织起来（单播，多播，广播等方式）将单个服务器的会话同步给集群中的其他服务器，从而使得用户的请求被调度到任何一个服务器上得到的session都是相同的（实现调度的服务器到后端被调度的服务器之间的解耦，实现将有状态变成了无状态实现按需进行调度）</li><li>劣势：每个节点都会持有集群中的所有的session信息，对内存资源的消耗非常大，同时对网络资源的占用也非常严重</li></ul></li><li>session server:后端服务器之后即存储服务器</li></ul></li></ul><hr><h3 id="session-server-后端服务器之后即存储服务器"><a href="#session-server-后端服务器之后即存储服务器" class="headerlink" title="session server:后端服务器之后即存储服务器"></a>session server:后端服务器之后即存储服务器</h3><ul><li><p>存储系统种类繁多</p><ul><li>Session Manager 需要专门添加并非内建</li></ul></li><li><p>存储系统性能高</p><ul><li>存储系统要保存session ，而session通常都是简单的数据，但是必须要具有流逝化的特性</li><li>session变化特别的频繁所以存储系统必须要做到快速的存取</li></ul></li><li><p>存储系统要有冗余能力</p><ul><li>存储系统一旦成为一个集中的session server后，将成为整个系统的单点</li></ul></li></ul><hr><ul><li>Cache 缓存：无持久能力（memcached）<ul><li>一般而言都是在内存当中或者即便实在磁盘上，通常系统重启后数据则将丢失，无法完成重构。</li></ul></li><li>Store 存储 (redis)<ul><li>数据的读写有可能是在内存中完成，但是本身却拥有持久存储功能即持久是必备功能</li></ul></li></ul><hr><p>memcached（缓存服务）</p><ul><li>缓存的数据的大小不可大于1M，如果数据大于1M则不被缓存</li><li>完全基于内存工作</li></ul><p>缓存系统使用场景</p><ul><li>服务器存储的系统存在热区</li><li>服务器的数据读多写少</li></ul><p>memcached特证</p><ul><li>协议简单</li><li>基于libevent的事件处理（单进程处理多路请求）</li><li>内置内存存储方式</li><li>memcached不互通信额分布式</li></ul><hr><p>范例：基于nginx实现负载均衡，实现mamcache会话缓存</p><p><img src="/2019/01/20/tomcat会话服务/tomcat负载均衡/负载.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">实验准备</span><br><span class="line">  三台主机</span><br><span class="line">    nginx_server      yum install nginx -y</span><br><span class="line">    tomcat_serverA    yum install java-11-openjdk-devel -y  &amp;&amp; yum install tomcat-admin-webapps tomcat-webapps tomcat-docs-webapp -y  yum install memcached -y</span><br><span class="line">    tomcat_serverB    yum install java-11-openjdk-devel -y  &amp;&amp; yum install tomcat-admin-webapps tomcat-webapps tomcat-docs-webapp -y  yum install memcached -y</span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">在两台tomcat上分别创建测试页面并定制虚拟主机</span><br><span class="line"></span><br><span class="line">tomcatA</span><br><span class="line">  ~]<span class="comment"># mkdir /data/webapps/myapp-v0.1</span></span><br><span class="line">  ~]<span class="comment"># cd /data/webapps/myapp-v0.1</span></span><br><span class="line">  myapp-v0.1]<span class="comment"># mkdir classes lib WEB-INF WETA-INF</span></span><br><span class="line">  myapp-v0.1]<span class="comment">#  vi index.jsp</span></span><br><span class="line">  &lt;%@ page language=<span class="string">"java"</span> %&gt;</span><br><span class="line">   &lt;html&gt;</span><br><span class="line">      &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">       &lt;body&gt;</span><br><span class="line">         &lt;h1&gt;&lt;font color=<span class="string">"purple"</span>&gt;TomcatA.daizhe.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">            &lt;table align=<span class="string">"centre"</span> border=<span class="string">"1"</span>&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">              &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">            &lt;% session.setAttribute(<span class="string">"a.com"</span>,<span class="string">"a.com"</span>); %&gt;</span><br><span class="line">              &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">             &lt;/tr&gt;</span><br><span class="line">             &lt;tr&gt;</span><br><span class="line">         &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">      &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">      &lt;/tr&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">   &lt;/html&gt;</span><br><span class="line"></span><br><span class="line">  webapps]<span class="comment"># ln -sv myapp-v0.1 myapp</span></span><br><span class="line">   ~]<span class="comment"># tree /data</span></span><br><span class="line">  /data</span><br><span class="line">  └── webapps</span><br><span class="line">     ├── myapp -&gt; myapp-v0.1</span><br><span class="line">     └── myapp-v0.1</span><br><span class="line">          ├── classes</span><br><span class="line">          ├── index.jsp</span><br><span class="line">          ├── lib</span><br><span class="line">          ├── WEB-INF</span><br><span class="line">          └── WETA-INF</span><br><span class="line"><span class="comment">#定义虚拟主机使用别名访问</span></span><br><span class="line">   ~]<span class="comment"># vim /etc/tomcat/server.xml </span></span><br><span class="line">   <span class="comment">#140行</span></span><br><span class="line">  &lt;Context path=<span class="string">"/myapp"</span> docBase=<span class="string">"/data/webapps/myapp"</span> reloadable=<span class="string">""</span>/&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#打开页面管理接口（manager app和 host manager）</span></span><br><span class="line">  ~]<span class="comment"># vim /etc/tomcat/tomcat-users.xml </span></span><br><span class="line">  &lt;tomcat-users&gt;</span><br><span class="line">  &lt;role rolename=<span class="string">"manager-gui"</span>/&gt;</span><br><span class="line">  &lt;role rolename=<span class="string">"admin-gui"</span>/&gt;</span><br><span class="line">  &lt;role rolename=<span class="string">"manager-script"</span>/&gt; </span><br><span class="line">  &lt;user username=<span class="string">"tomcat"</span> password=<span class="string">"centos"</span> roles=<span class="string">"manager-gui,manager-script,admin-gui,admin-script"</span>/&gt;</span><br><span class="line">  &lt;/tomcat-users&gt;</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl start tomcat</span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line"></span><br><span class="line">tomcatB</span><br><span class="line">  ~]<span class="comment"># tree /data</span></span><br><span class="line">  /data</span><br><span class="line">  └── webapps</span><br><span class="line">      └── myapp-v0.1</span><br><span class="line">          ├── classes</span><br><span class="line">          ├── index.jsp</span><br><span class="line">          ├── lib</span><br><span class="line">          ├── WEB-INF</span><br><span class="line">          └── WETA-INF</span><br><span class="line">  ~]<span class="comment"># vim /data/webapps/myapp-v0.1/index.jsp </span></span><br><span class="line">  &lt;%@ page language=<span class="string">"java"</span> %&gt;</span><br><span class="line">   &lt;html&gt;</span><br><span class="line">      &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">       &lt;body&gt;</span><br><span class="line">         &lt;h1&gt;&lt;font color=<span class="string">"red"</span>&gt;TomcatB.daizhe.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">            &lt;table align=<span class="string">"centre"</span> border=<span class="string">"1"</span>&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">              &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">            &lt;% session.setAttribute(<span class="string">"a.com"</span>,<span class="string">"a.com"</span>); %&gt;</span><br><span class="line">              &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">             &lt;/tr&gt;</span><br><span class="line">             &lt;tr&gt;</span><br><span class="line">         &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">      &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">      &lt;/tr&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">   &lt;/html&gt;</span><br><span class="line"></span><br><span class="line">  webapps]<span class="comment"># ln -sv myapp-v0.1 myapp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#定义虚拟主机使用别名访问</span></span><br><span class="line">   ~]<span class="comment"># vim /etc/tomcat/server.xml </span></span><br><span class="line">   <span class="comment">#140行</span></span><br><span class="line">  &lt;Context path=<span class="string">"/myapp"</span> docBase=<span class="string">"/data/webapps/myapp"</span> reloadable=<span class="string">""</span>/&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#打开页面管理接口（manager app和 host manager）</span></span><br><span class="line">  ~]<span class="comment"># vim /etc/tomcat/tomcat-users.xml </span></span><br><span class="line">  &lt;tomcat-users&gt;</span><br><span class="line">  &lt;role rolename=<span class="string">"manager-gui"</span>/&gt;</span><br><span class="line">  &lt;role rolename=<span class="string">"admin-gui"</span>/&gt;</span><br><span class="line">  &lt;role rolename=<span class="string">"manager-script"</span>/&gt; </span><br><span class="line">  &lt;user username=<span class="string">"tomcat"</span> password=<span class="string">"centos"</span> roles=<span class="string">"manager-gui,manager-script,admin-gui,admin-script"</span>/&gt;</span><br><span class="line">  &lt;/tomcat-users&gt;</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl start tomcat</span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br></pre></td></tr></table></figure><ul><li>访问测试是否配置成功</li></ul><p><img src="/2019/01/20/tomcat会话服务/tomcat负载均衡/1.png" alt=""><br><img src="/2019/01/20/tomcat会话服务/tomcat负载均衡/5.png" alt=""></p><ul><li><p>tomcat默认不支持将session会话信息放进memcached中，需要借助第三方MSM（memcached session manager）,意思是将memcached当作session会话的后端的session管理器</p><ul><li><p>支持的存储程序</p><ul><li>memcached</li><li>redis</li><li>couchbase</li></ul></li><li><p>托管在github上地址：<a href="https://github.com/magro/memcached-session-manager" target="_blank" rel="noopener">https://github.com/magro/memcached-session-manager</a></p></li><li>配置参考手册：<a href="https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration" target="_blank" rel="noopener">https://github.com/magro/memcached-session-manager/wiki/SetupAndConfiguration</a></li></ul></li></ul><p>配置tomcatA和tomcatB 可以实现两个tomcat可以使用两个memcached 实现两台memcached各存储部分session 会话信息，实现双活机制</p><p><img src="/2019/01/20/tomcat会话服务/1.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line">tomcatA 安装memcached (base仓库)    监听的端口 tcp 11211 / udp 11211</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># yum install memcached -y</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># rpm -ql memcached</span></span><br><span class="line">  /etc/sysconfig/memcached  <span class="comment">#配置文件</span></span><br><span class="line">  /usr/bin/memcached        <span class="comment">#命令执行文件</span></span><br><span class="line">  usr/lib/systemd/system/memcached.service  <span class="comment">#启动程序文件</span></span><br><span class="line"></span><br><span class="line">  查看memcached命令帮助</span><br><span class="line">  ~]<span class="comment"># memcached -h</span></span><br><span class="line">  -p &lt;num&gt;     <span class="comment"># 监听tcp 11211端口</span></span><br><span class="line">  -U &lt;num&gt;     <span class="comment"># 监听UDP 11211端口 ， 设置upd协议为0 表示关闭udp协议的端口</span></span><br><span class="line">  -l &lt;addr&gt;    <span class="comment"># 指定监听的地址</span></span><br><span class="line">  -d           <span class="comment"># 运行为守护进程  </span></span><br><span class="line">  -u &lt;username&gt; <span class="comment"># 指定运行的身份</span></span><br><span class="line">  -m &lt;num&gt;      <span class="comment"># 使用多大的内存空间当作缓存 ，默认为64M ，必须调大</span></span><br><span class="line">  -M            <span class="comment"># 内存耗尽禁用LRU 表示内存耗尽禁止新存储的数据存储</span></span><br><span class="line">  -c &lt;num&gt;      <span class="comment"># 最大并发连接数，默认为1024          </span></span><br><span class="line">  -v            <span class="comment"># 输出信息到前台</span></span><br><span class="line">  -vv           <span class="comment"># 详细</span></span><br><span class="line">  -vvv          <span class="comment"># 详详细   </span></span><br><span class="line">  -f &lt;factor&gt;   <span class="comment"># 增长因子 默认为1.25</span></span><br><span class="line">      </span><br><span class="line">  <span class="comment">#查看增长因子</span></span><br><span class="line">  <span class="comment">#~]# su - daizhe</span></span><br><span class="line">  <span class="comment">#~]$ memcached -vvv -m 256m -f 1.25</span></span><br><span class="line">  <span class="comment">#slab class   1: chunk size        96 perslab   10922</span></span><br><span class="line">  <span class="comment">#slab class   2: chunk size       120 perslab    8738</span></span><br><span class="line">  <span class="comment">#slab class   3: chunk size       152 perslab    6898</span></span><br><span class="line">  <span class="comment">#slab class   4: chunk size       192 perslab    5461</span></span><br><span class="line">  <span class="comment">#slab class   5: chunk size       240 perslab    4369</span></span><br><span class="line"></span><br><span class="line">编辑memcache的配置文件启动</span><br><span class="line"> ~]<span class="comment"># vim /etc/sysconfig/memcached </span></span><br><span class="line">  PORT=<span class="string">"11211"</span>      <span class="comment">#端口</span></span><br><span class="line">  USER=<span class="string">"memcached"</span>  <span class="comment">#运行身份</span></span><br><span class="line">  MAXCONN=<span class="string">"1024"</span>  </span><br><span class="line">  CACHESIZE=<span class="string">"256"</span>   <span class="comment">#内存空间</span></span><br><span class="line">  OPTIONS=<span class="string">"-f 1.1 -M"</span>  <span class="comment">#指定增长因子</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl start memcached</span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  11211</span><br><span class="line"></span><br><span class="line">安装c程序调用memcache依赖的库</span><br><span class="line"><span class="comment"># php程序员： php-pecl-memcache</span></span><br><span class="line"><span class="comment"># python程序员： python-memcached.noarch</span></span><br><span class="line"><span class="comment"># c程序员: libmemcached</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># yum install libmemcached -y </span></span><br><span class="line"></span><br><span class="line">  使用telnet连接（memcached支持文本协议即纯文本的字符串）</span><br><span class="line">  ~]<span class="comment"># yum install telnet -y</span></span><br><span class="line">  ~]<span class="comment"># telnet 127.0.0.1 11211  </span></span><br><span class="line">  <span class="comment">#stats查看状态使用信息</span></span><br><span class="line"></span><br><span class="line">  设置一个键</span><br><span class="line">  <span class="built_in">set</span> mykey 123 60 6</span><br><span class="line">  daizhe</span><br><span class="line">  STORED</span><br><span class="line">  <span class="comment"># 键名：mykey</span></span><br><span class="line">  <span class="comment"># 值：123</span></span><br><span class="line">  <span class="comment"># 超时时长：60内有效</span></span><br><span class="line">  <span class="comment"># 指定字节数</span></span><br><span class="line"></span><br><span class="line">  查看已经存储的键值</span><br><span class="line">  get mykey</span><br><span class="line"></span><br><span class="line">获取memcached的信息</span><br><span class="line">  ~]<span class="comment"># memstat -h</span></span><br><span class="line">  --servers= <span class="comment">#指定服务器地址</span></span><br><span class="line">  ~]<span class="comment"># memstat --servers=127.0.0.1:11211</span></span><br><span class="line"></span><br><span class="line">dump出所有存储的键</span><br><span class="line">  ~]<span class="comment"># memdump --servers=127.0.0.1:11211</span></span><br><span class="line"></span><br><span class="line">清空所有的键</span><br><span class="line">  ~]<span class="comment"># memflush</span></span><br><span class="line"></span><br><span class="line">删除所有的键</span><br><span class="line">  ~]<span class="comment"># memrm</span></span><br><span class="line"></span><br><span class="line">更新键的时间戳</span><br><span class="line">  ~]<span class="comment"># memtouch</span></span><br><span class="line"></span><br><span class="line">判断存在性</span><br><span class="line">  ~]<span class="comment"># memexist</span></span><br></pre></td></tr></table></figure><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">tomcatA 安装memcached</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># yum install memcached -y</span></span><br><span class="line"></span><br><span class="line">编辑memcache的配置文件启动</span><br><span class="line"> ~]<span class="comment"># vim /etc/sysconfig/memcached </span></span><br><span class="line">  PORT=<span class="string">"11211"</span>      <span class="comment">#端口</span></span><br><span class="line">  USER=<span class="string">"memcached"</span>  <span class="comment">#运行身份</span></span><br><span class="line">  MAXCONN=<span class="string">"1024"</span>  </span><br><span class="line">  CACHESIZE=<span class="string">"256"</span>   <span class="comment">#内存空间</span></span><br><span class="line">  OPTIONS=<span class="string">"-f 1.1 -M"</span>  <span class="comment">#指定增长因子</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl start memcached</span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  11211</span><br></pre></td></tr></table></figure><hr><p>jar文件下载路径：<a href="http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/" target="_blank" rel="noopener">http://repo1.maven.org/maven2/de/javakaffee/msm/memcached-session-manager/</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">为tomcatA 节点和 tomcatB 节点的tomcat准备 jar文件</span><br><span class="line">  查看默认的tomcat的jar文件的存放路径</span><br><span class="line">  ~]<span class="comment"># rpm -ql tomcat-lib</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cd /usr/share/java/tomcat/    #所有的tomcat节点上都要放置jar文件</span></span><br><span class="line">  将所有的jar文件防止在此路径下</span><br></pre></td></tr></table></figure></p><p><img src="/2019/01/20/tomcat会话服务/2.png" alt=""><br><img src="/2019/01/20/tomcat会话服务/3.png" alt=""><br><img src="/2019/01/20/tomcat会话服务/4.png" alt=""></p><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">配置tomcatA和tomcatB 节点的tomcat的配置文件（不要和tomcat_session 会话集群同时使用）</span><br><span class="line"></span><br><span class="line">tomcatA和tomcatB</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/tomcat/server.xml </span></span><br><span class="line"><span class="comment">#105</span></span><br><span class="line">      &lt;Engine name=<span class="string">"Catalina"</span> defaultHost=<span class="string">"localhost"</span> jvmRoute=<span class="string">"tcA"</span>&gt; <span class="comment">#两个节点做区分 tcA / tcB</span></span><br><span class="line"><span class="comment">#140行</span></span><br><span class="line">  &lt;Context path=<span class="string">"/myapp"</span> docBase=<span class="string">"/data/webapps/myapp"</span> reloadable=<span class="string">""</span>&gt;</span><br><span class="line">  &lt;Manager className=<span class="string">"de.javakaffee.web.msm.MemcachedBackupSessionManager"</span>    memcachedNodes=<span class="string">"172.18.135.1:11211,172.18.135.5:11211"</span></span><br><span class="line">    failoverNodes=<span class="string">"n1"</span></span><br><span class="line">    requestUriIgnorePattern=<span class="string">".*\.(ico|png|gif|jpg|css|js)$"</span>    transcoderFactoryClass=<span class="string">"de.javakaffee.web.msm.serializer.kryo.KryoTranscoderFactory"</span></span><br><span class="line">    /&gt;</span><br><span class="line">&lt;/Context&gt;</span><br></pre></td></tr></table></figure><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">启动节点中所有tamcat服务器并监控日志信息</span><br><span class="line">  ~]<span class="comment"># systemctl restart tomcat</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment">#tail -f /var/log/tomcat/catalina.2019-01-20.log</span></span><br></pre></td></tr></table></figure><p>使用nginx调度测试</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Tomcat-Session-Server&quot;&gt;&lt;a href=&quot;#Tomcat-Session-Server&quot; class=&quot;headerlink&quot; title=&quot;Tomcat Session Server&quot;&gt;&lt;/a&gt;Tomcat Session Server&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/01/20/tomcat会话服务/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="tomcat" scheme="https://daizhe.net.cn/categories/tomcat/"/>
    
    
      <category term="tomcat" scheme="https://daizhe.net.cn/tags/tomcat/"/>
    
  </entry>
  
  <entry>
    <title>tomcat会话集群</title>
    <link href="https://daizhe.net.cn/2019/01/19/tomcat%E4%BC%9A%E8%AF%9D%E9%9B%86%E7%BE%A4/"/>
    <id>https://daizhe.net.cn/2019/01/19/tomcat会话集群/</id>
    <published>2019-01-19T09:56:29.471Z</published>
    <updated>2019-01-22T12:09:09.101Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Tomcat-Session-Cluster"><a href="#Tomcat-Session-Cluster" class="headerlink" title="Tomcat Session Cluster"></a>Tomcat Session Cluster</h1><p><img src="/2019/01/19/tomcat会话集群/标题.gif" alt=""><br><a id="more"></a></p><h2 id="session会话"><a href="#session会话" class="headerlink" title="session会话"></a>session会话</h2><ul><li>session(会话保持)<ul><li>session stick:调度器<ul><li>使用调度器的调度算法来解决问题，损害调度器的负载均衡效果，引入session单点即有一台服务器宕机都会造成数据的丢失。</li></ul></li><li>session replication cluster (sesssion复制集群)：后端服务器组织成集群<ul><li>将后端的服务器组织起来（单播，多播，广播等方式）将单个服务器的会话同步给集群中的其他服务器，从而使得用户的请求被调度到任何一个服务器上得到的session都是相同的（实现调度的服务器到后端被调度的服务器之间的解耦，实现将有状态变成了无状态实现按需进行调度）</li><li>劣势：每个节点都会持有集群中的所有的session信息，对内存资源的消耗非常大，同时对网络资源的占用也非常严重</li></ul></li><li>session server:后端服务器之后即存储服务器</li></ul></li></ul><h3 id="session-replication-cluster-sesssion复制集群-：后端服务器组织成集群"><a href="#session-replication-cluster-sesssion复制集群-：后端服务器组织成集群" class="headerlink" title="session replication cluster (sesssion复制集群)：后端服务器组织成集群"></a>session replication cluster (sesssion复制集群)：后端服务器组织成集群</h3><ul><li><p>tomcat中自身就带有了一种cluster机制（集群仅是针对于保持用户session会话问题上实现集群）</p><ul><li>将后端多个正常工作的主机在session管理问题上将其基于专有的网络接口或者面向客户端的通用网络接口构建出一个会话集群，此集群可以实现让每一个节点获得会话信息后通过所谓通讯当中的多播机制或者称之为组播机制（Multicast），将自己所获得的会话信息多播到事先约定的多播信道上，实现在同一多播网络中的其他主机获取到相关的会话信息，并将其合并到本地已有的会话信息中。<ul><li>构建通讯集群的方式<ul><li>单播：效率最低</li><li>多播：多播方式最优，可以配置同一集群中的主机，大家共同使用同一个多播地址（多播域），而后在规定的多播第之内发送多播信息，只有同一多播地址上的主机才可以收到此会话信息。</li><li>广播：后端主机获得会话信息后直接以广播的方式发送到其他后端主机上（但是播及面太大，造成影响范围太大）。</li></ul></li></ul></li></ul></li><li><p>tomcat本身就是java语言编写，所以具有完全面向对象的特性，必须使用类来完成任何功能，包括会话管理，在tomcat上会话管理组件称为session manager (会话管理器)，在tomcat上有好几种会话管理机制，统称为会话管理器</p><ul><li><p>默认使用的是持久会话管理</p><ul><li>tomcat接收到客户的session会话信息，是先保存在内存中，会周期性的同步在磁盘上进行数据的保存（所以将tomcat重启后，被正常存储好的会话信息会被将回复回来，但是在未到周期同步在磁盘上的session会话信息，也就是存在内存中的会话尚未同步在磁盘上的会话信息在tomcat宕机时会丢失session会话信息）</li><li>持久会话管理，一定会影响磁盘的IO性能（受本地的磁盘IO限制）</li></ul></li><li><p><code>Delta Session Manager 会话管理器</code></p><ul><li>增量变动之意</li><li>每一个节点自己后来生成的session会话增量变量的信息，将增量的会话变动通过多播方式，多播到多播域内，同一多播域中的其他主机也存在相同的Delta Session Manager 接收其他主机在多播域内变动的session会话信息，并且合并在本地的session存储中</li><li>劣势：session manager 中的每个节点都要保存所有的会话信息并且通常是保存在内存中，一旦客户端访问的数量增多时会使得后端session manager存储会话的节点中都存在大量的会话信息，会使得会话无法被扩展。</li></ul></li><li><p>Backup Session Manager 备份会话管理器</p><ul><li>每一个会话节点（session manager）在保存会话和生成会话时，会将会话同传给集群中的其他一个节点或者说是有限节点，而不是所有会话集群中的所有节点，因为每个节点禁止有所有会话节点中一定比例的会话信息。</li><li>此类会话管理须实现前端调度的会话绑定，且保持会话管理的节点一但宕机后可以将此会话信息保持 发送到另一台备份会话信息的会话管理器上（而不是任何一个会话管理节点）。此类会话管理，需要管理员精心介入到调度拓扑结构中。</li><li>也就是此类会话管理无会话动态性需要管理员明确管理指定，如有宕机需精确的重定向，那台会话管理节点备份了哪台会话节点的会话信息。</li><li>打破了不会让每一个节点持有整个集群的session会话的信息</li></ul></li><li><p><code>自定义会话管理器</code></p><ul><li>将tomcat生成的会话信息不记录在服务器的内存中，而是将会话信息存储到外部适配的缓存的服务器上比如mamcached、redis</li><li>一旦有session会话保持时通过是配置直接保存在外部存储上，这样则使得tomcat可以是同Session_server保存用户的会话信息</li></ul></li></ul></li></ul><p>范例：Delta Session Manager 会话管理器<br>参考文档：<a href="http://tomcat.apache.org/tomcat-7.0-doc/cluster-howto.html" target="_blank" rel="noopener">http://tomcat.apache.org/tomcat-7.0-doc/cluster-howto.html</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">配置启用集群，将下列配置放置于&lt;engine&gt;或&lt;host&gt;中；</span><br><span class="line"></span><br><span class="line">&lt;Cluster className=<span class="string">"org.apache.catalina.ha.tcp.SimpleTcpCluster"</span>  <span class="comment">#属性指明使用的类</span></span><br><span class="line">channelSendOptions=<span class="string">"8"</span>&gt;   </span><br><span class="line"></span><br><span class="line">&lt;Manager className=<span class="string">"org.apache.catalina.ha.session.DeltaManager"</span>   <span class="comment">#指定使用的会话管理器</span></span><br><span class="line">expireSessionsOnShutdown=<span class="string">"false"</span>          <span class="comment">#DeltaManager 用到的属性</span></span><br><span class="line">notifyListenersOnReplication=<span class="string">"true"</span>/&gt;     <span class="comment">#DeltaManager 用到的属性</span></span><br><span class="line"></span><br><span class="line">&lt;Channel className=<span class="string">"org.apache.catalina.tribes.group.GroupChannel"</span>&gt;     <span class="comment">#定义多播信息及集群通讯信道</span></span><br><span class="line"> &lt;Membership className=<span class="string">"org.apache.catalina.tribes.membership.McastService"</span> <span class="comment">#定义集群成员的关系</span></span><br><span class="line">address=<span class="string">"228.0.0.4"</span>   <span class="comment">#多播地址，D类地址用来组播（224~239），多播即大家使用同一个D类中相同的一个地址</span></span><br><span class="line">port=<span class="string">"45564"</span>          <span class="comment">#多播端口</span></span><br><span class="line">frequency=<span class="string">"500"</span>       <span class="comment">#每个多长时间发一次心跳 默认500毫秒</span></span><br><span class="line">dropTime=<span class="string">"3000"</span>/&gt;     <span class="comment">#多长时间内收不到节点的心跳 判断为超时，从而从集群成员中剔除</span></span><br><span class="line"> &lt;Receiver className=<span class="string">"org.apache.catalina.tribes.transport.nio.NioReceiver"</span> <span class="comment">#定义如何接收传递的session会话信息</span></span><br><span class="line">  address=<span class="string">"auto"</span></span><br><span class="line">  port=<span class="string">"4000"</span>         <span class="comment">#监听的端口，如果有冲突，自动切换（4000~4100）</span></span><br><span class="line">  autoBind=<span class="string">"100"</span>      <span class="comment">#自动绑定，如有错误自动重新绑定</span></span><br><span class="line">  selectorTimeout=<span class="string">"5000"</span><span class="comment">#选择器的超时时长默认5秒</span></span><br><span class="line">  maxThreads=<span class="string">"6"</span>/&gt;      <span class="comment">#最大线程数，默认值为6，已经足够使用</span></span><br><span class="line">     &lt;Sender className=<span class="string">"org.apache.catalina.tribes.transport.ReplicationTransmitter"</span>&gt;   <span class="comment">#向外发送心跳以及session会话信息</span></span><br><span class="line"> &lt;Transport className=<span class="string">"org.apache.catalina.tribes.transport.nio.PooledParallelSender"</span>/&gt; <span class="comment">#心跳大佛那个的方式轮询</span></span><br><span class="line"> &lt;/Sender&gt;</span><br><span class="line"> &lt;Interceptor className=<span class="string">"org.apache.catalina.tribes.group.interceptors.TcpFailureDetector"</span>/&gt;  <span class="comment">#探测器校验信息是否出错</span></span><br><span class="line"> &lt;Interceptor className=<span class="string">"org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor"</span>/&gt;</span><br><span class="line">&lt;/Channel&gt;</span><br><span class="line"></span><br><span class="line">    &lt;Valve className=<span class="string">"org.apache.catalina.ha.tcp.ReplicationValve"</span>    <span class="comment">#定义过滤器，过滤复制集群相关的信息</span></span><br><span class="line">filter=<span class="string">""</span>/&gt;</span><br><span class="line">&lt;Valve className=<span class="string">"org.apache.catalina.ha.session.JvmRouteBinderValve"</span>/&gt;   <span class="comment">#绑定JVM的路由信息</span></span><br><span class="line"></span><br><span class="line">   &lt;Deployer className=<span class="string">"org.apache.catalina.ha.deploy.FarmWarDeployer"</span></span><br><span class="line">tempDir=<span class="string">"/tmp/war-temp/"</span></span><br><span class="line">  deployDir=<span class="string">"/tmp/war-deploy/"</span></span><br><span class="line">watchDir=<span class="string">"/tmp/war-listen/"</span></span><br><span class="line">watchEnabled=<span class="string">"false"</span>/&gt;</span><br><span class="line"></span><br><span class="line">&lt;ClusterListener className=<span class="string">"org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener"</span>/&gt;   <span class="comment">#集群侦听器，确保集群相关的资源仅被集群中的成员所使用</span></span><br><span class="line">&lt;ClusterListener className=<span class="string">"org.apache.catalina.ha.session.ClusterSessionListener"</span>/&gt;</span><br><span class="line">&lt;/Cluster&gt;</span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">会话集群配置</span><br><span class="line"></span><br><span class="line">第一步：</span><br><span class="line">配置session集群(修改所有的tomcat服务器会话集群的配置文件)</span><br><span class="line"> ~]<span class="comment"># vim /etc/tomcat/server.xml </span></span><br><span class="line">105行 添加标注信息</span><br><span class="line">    &lt;Engine name=<span class="string">"Catalina"</span> defaultHost=<span class="string">"localhost"</span> jvmRoute=<span class="string">"tcA"</span>&gt;<span class="comment">#每个节点上的标识不要相同</span></span><br><span class="line">128行</span><br><span class="line"> &lt;Host name=<span class="string">"localhost"</span>  appBase=<span class="string">"webapps"</span></span><br><span class="line">            unpackWARs=<span class="string">"true"</span> autoDeploy=<span class="string">"true"</span>&gt;</span><br><span class="line">        &lt;Cluster className=<span class="string">"org.apache.catalina.ha.tcp.SimpleTcpCluster"</span></span><br><span class="line">                channelSendOptions=<span class="string">"8"</span>&gt;</span><br><span class="line">        &lt;Manager className=<span class="string">"org.apache.catalina.ha.session.DeltaManager"</span></span><br><span class="line">                expireSessionsOnShutdown=<span class="string">"false"</span></span><br><span class="line">                notifyListenersOnReplication=<span class="string">"true"</span>/&gt;</span><br><span class="line">        &lt;Channel className=<span class="string">"org.apache.catalina.tribes.group.GroupChannel"</span>&gt;</span><br><span class="line">        &lt;Membership className=<span class="string">"org.apache.catalina.tribes.membership.McastService"</span></span><br><span class="line">                address=<span class="string">"228.0.100.10"</span></span><br><span class="line">                port=<span class="string">"45564"</span></span><br><span class="line">                frequency=<span class="string">"500"</span></span><br><span class="line">                dropTime=<span class="string">"3000"</span>/&gt;</span><br><span class="line">        &lt;Receiver className=<span class="string">"org.apache.catalina.tribes.transport.nio.NioReceiver"</span></span><br><span class="line">                address=<span class="string">"auto"</span></span><br><span class="line">                port=<span class="string">"4000"</span></span><br><span class="line">                autoBind=<span class="string">"100"</span></span><br><span class="line">                selectorTimeout=<span class="string">"5000"</span>  </span><br><span class="line">                maxThreads=<span class="string">"6"</span>/&gt;</span><br><span class="line">        &lt;Sender className=<span class="string">"org.apache.catalina.tribes.transport.ReplicationTransmitter"</span>&gt;</span><br><span class="line">        &lt;Transport className=<span class="string">"org.apache.catalina.tribes.transport.nio.PooledParallelSender"</span>/&gt;</span><br><span class="line">        &lt;/Sender&gt;</span><br><span class="line">        &lt;Interceptor className=<span class="string">"org.apache.catalina.tribes.group.interceptors.TcpFailureDetector"</span>/&gt;</span><br><span class="line">        &lt;Interceptor className=<span class="string">"org.apache.catalina.tribes.group.interceptors.MessageDispatch15Interceptor"</span>/&gt;</span><br><span class="line">   &lt;/Channel&gt;</span><br><span class="line">        &lt;Valve className=<span class="string">"org.apache.catalina.ha.tcp.ReplicationValve"</span></span><br><span class="line">                filter=<span class="string">""</span>/&gt;</span><br><span class="line">        &lt;Valve className=<span class="string">"org.apache.catalina.ha.session.JvmRouteBinderValve"</span>/&gt;</span><br><span class="line">        &lt;Deployer className=<span class="string">"org.apache.catalina.ha.deploy.FarmWarDeployer"</span></span><br><span class="line">                tempDir=<span class="string">"/tmp/war-temp/"</span></span><br><span class="line">                deployDir=<span class="string">"/tmp/war-deploy/"</span></span><br><span class="line">                watchDir=<span class="string">"/tmp/war-listen/"</span></span><br><span class="line">                watchEnabled=<span class="string">"false"</span>/&gt;</span><br><span class="line">        &lt;ClusterListener className=<span class="string">"org.apache.catalina.ha.session.JvmRouteSessionIDBinderListener"</span>/&gt;</span><br><span class="line">        &lt;ClusterListener className=<span class="string">"org.apache.catalina.ha.session.ClusterSessionListener"</span>/&gt;</span><br><span class="line">        &lt;/Cluster&gt;</span><br><span class="line"></span><br><span class="line">第二步：</span><br><span class="line">拷贝 web.xml文件到自己定义的路径别名的虚拟主机中</span><br><span class="line">(修改所有的tomcat服务器会话集群虚拟主机的web.xml)</span><br><span class="line">~]<span class="comment"># cp /etc/tomcat/web.xml /data/webapps/myapp/WEB-INF/</span></span><br><span class="line">WEB-INF]<span class="comment"># pwd</span></span><br><span class="line">/data/webapps/myapp/WEB-INF</span><br><span class="line">23行</span><br><span class="line">&lt;distributable/&gt;<span class="comment">#必须虚拟主机路经下存在web.xml 并且改文件中存在&lt;distributable/&gt; 才可使用会话集群</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">第三步：</span><br><span class="line">集群成员间的时间必须同步</span><br><span class="line">~] <span class="comment"># ntpdate</span></span><br><span class="line"></span><br><span class="line">注意：此时调度器应该继续使用会话粘性，保证客户端请求都调度到一台服务器，因为后端的会话集群服务器同步会话信息并非实时同步。这样可以确保当给客户端提供会话的主机宕机后也可以让令外会话集权中的服务器继续保持会话</span><br><span class="line"></span><br><span class="line">第四步：</span><br><span class="line">重新启动会话集群中的tomcat服务器</span><br><span class="line">~]<span class="comment"># systemctl start tomcat</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># tail -f /var/log/tomcat/catalina.2019-01-20.log </span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">调度器</span><br><span class="line">使用nginx调度测试</span><br><span class="line">~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line"> upstream tcserver &#123;</span><br><span class="line">        server 172.18.135.1:8080;</span><br><span class="line">        server 172.18.135.5:8080;</span><br><span class="line">        &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Load configuration files for the default server block.</span></span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        proxy_pass http://tcserver;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># nginx -t</span></span><br><span class="line">~]<span class="comment"># nginx -s reload</span></span><br></pre></td></tr></table></figure><p>测试(已经实现会话保持和nginx默认的轮询调度)<br><img src="/2019/01/19/tomcat会话集群/1.png" alt=""><br><img src="/2019/01/19/tomcat会话集群/2.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Tomcat-Session-Cluster&quot;&gt;&lt;a href=&quot;#Tomcat-Session-Cluster&quot; class=&quot;headerlink&quot; title=&quot;Tomcat Session Cluster&quot;&gt;&lt;/a&gt;Tomcat Session Cluster&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/01/19/tomcat会话集群/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="tomcat" scheme="https://daizhe.net.cn/categories/tomcat/"/>
    
    
      <category term="tomcat" scheme="https://daizhe.net.cn/tags/tomcat/"/>
    
  </entry>
  
  <entry>
    <title>tomcat负载均衡--nginx | httpd</title>
    <link href="https://daizhe.net.cn/2019/01/19/tomcat%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1/"/>
    <id>https://daizhe.net.cn/2019/01/19/tomcat负载均衡/</id>
    <published>2019-01-19T04:03:46.328Z</published>
    <updated>2019-01-22T12:10:29.948Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tomcat负载均衡及会话保持–nginx-httpd"><a href="#tomcat负载均衡及会话保持–nginx-httpd" class="headerlink" title="tomcat负载均衡及会话保持–nginx | httpd"></a>tomcat负载均衡及会话保持–nginx | httpd</h1><p><img src="/2019/01/19/tomcat负载均衡/标题.gif" alt=""><br><a id="more"></a></p><h2 id="session会话"><a href="#session会话" class="headerlink" title="session会话"></a>session会话</h2><ul><li>session(会话保持)<ul><li>session stick:调度器<ul><li>使用调度器的调度算法来解决问题，损害调度器的负载均衡效果，引入session单点即有一台服务器宕机都会造成数据的丢失。</li></ul></li><li>session replication cluster (sesssion复制集群)：后端服务器组织成集群<ul><li>将后端的服务器组织起来（单播，多播，广播等方式）将单个服务器的会话同步给集群中的其他服务器，从而使得用户的请求被调度到任何一个服务器上得到的session都是相同的（实现调度的服务器到后端被调度的服务器之间的解耦，实现将有状态变成了无状态实现按需进行调度）</li><li>劣势：每个节点都会持有集群中的所有的session信息，对内存资源的消耗非常大，同时对网络资源的占用也非常严重</li></ul></li><li>session server:后端服务器之后即存储服务器</li></ul></li></ul><p>如果对tomcat实现负载均衡调度，一定要考虑到会话保持</p><h2 id="如何对tomcat实现负载均衡（-session-stick-调度器）"><a href="#如何对tomcat实现负载均衡（-session-stick-调度器）" class="headerlink" title="如何对tomcat实现负载均衡（ session stick:调度器）"></a>如何对tomcat实现负载均衡（ session stick:调度器）</h2><p><img src="/2019/01/19/tomcat负载均衡/负载.png" alt=""></p><h3 id="范例：使用nginx实现负载均衡"><a href="#范例：使用nginx实现负载均衡" class="headerlink" title="范例：使用nginx实现负载均衡"></a><code>范例：使用nginx实现负载均衡</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">实验准备</span><br><span class="line">  三台主机</span><br><span class="line">    nginx_server      yum install nginx -y</span><br><span class="line">    tomcat_serverA    yum install java-11-openjdk-devel -y  &amp;&amp; yum install tomcat-admin-webapps tomcat-webapps tomcat-docs-webapp -y </span><br><span class="line">    tomcat_serverB    yum install java-11-openjdk-devel -y  &amp;&amp; yum install tomcat-admin-webapps tomcat-webapps tomcat-docs-webapp -y </span><br><span class="line">  </span><br><span class="line"></span><br><span class="line">在两台tomcat上分别创建测试页面并定制虚拟主机</span><br><span class="line"></span><br><span class="line">tomcatA</span><br><span class="line">  ~]<span class="comment"># mkdir /data/webapps/myapp-v0.1</span></span><br><span class="line">  ~]<span class="comment"># cd /data/webapps/myapp-v0.1</span></span><br><span class="line">  myapp-v0.1]<span class="comment"># mkdir classes lib WEB-INF WETA-INF</span></span><br><span class="line">  myapp-v0.1]<span class="comment">#  vi index.jsp</span></span><br><span class="line">  &lt;%@ page language=<span class="string">"java"</span> %&gt;</span><br><span class="line">   &lt;html&gt;</span><br><span class="line">      &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">       &lt;body&gt;</span><br><span class="line">         &lt;h1&gt;&lt;font color=<span class="string">"purple"</span>&gt;TomcatA.daizhe.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">            &lt;table align=<span class="string">"centre"</span> border=<span class="string">"1"</span>&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">              &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">            &lt;% session.setAttribute(<span class="string">"a.com"</span>,<span class="string">"a.com"</span>); %&gt;</span><br><span class="line">              &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">             &lt;/tr&gt;</span><br><span class="line">             &lt;tr&gt;</span><br><span class="line">         &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">      &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">      &lt;/tr&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">   &lt;/html&gt;</span><br><span class="line"></span><br><span class="line">  webapps]<span class="comment"># ln -sv myapp-v0.1 myapp</span></span><br><span class="line">   ~]<span class="comment"># tree /data</span></span><br><span class="line">  /data</span><br><span class="line">  └── webapps</span><br><span class="line">     ├── myapp -&gt; myapp-v0.1</span><br><span class="line">     └── myapp-v0.1</span><br><span class="line">          ├── classes</span><br><span class="line">          ├── index.jsp</span><br><span class="line">          ├── lib</span><br><span class="line">          ├── WEB-INF</span><br><span class="line">          └── WETA-INF</span><br><span class="line"><span class="comment">#定义虚拟主机使用别名访问</span></span><br><span class="line">   ~]<span class="comment"># vim /etc/tomcat/server.xml </span></span><br><span class="line">   <span class="comment">#140行</span></span><br><span class="line">  &lt;Context path=<span class="string">"/myapp"</span> docBase=<span class="string">"/data/webapps/myapp"</span> reloadable=<span class="string">""</span>/&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#打开页面管理接口（manager app和 host manager）</span></span><br><span class="line">  ~]<span class="comment"># vim /etc/tomcat/tomcat-users.xml </span></span><br><span class="line">  &lt;tomcat-users&gt;</span><br><span class="line">  &lt;role rolename=<span class="string">"manager-gui"</span>/&gt;</span><br><span class="line">  &lt;role rolename=<span class="string">"admin-gui"</span>/&gt;</span><br><span class="line">  &lt;role rolename=<span class="string">"manager-script"</span>/&gt; </span><br><span class="line">  &lt;user username=<span class="string">"tomcat"</span> password=<span class="string">"centos"</span> roles=<span class="string">"manager-gui,manager-script,admin-gui,admin-script"</span>/&gt;</span><br><span class="line">  &lt;/tomcat-users&gt;</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl start tomcat</span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line"></span><br><span class="line">tomcatB</span><br><span class="line">  ~]<span class="comment"># tree /data</span></span><br><span class="line">  /data</span><br><span class="line">  └── webapps</span><br><span class="line">      └── myapp-v0.1</span><br><span class="line">          ├── classes</span><br><span class="line">          ├── index.jsp</span><br><span class="line">          ├── lib</span><br><span class="line">          ├── WEB-INF</span><br><span class="line">          └── WETA-INF</span><br><span class="line">  ~]<span class="comment"># vim /data/webapps/myapp-v0.1/index.jsp </span></span><br><span class="line">  &lt;%@ page language=<span class="string">"java"</span> %&gt;</span><br><span class="line">   &lt;html&gt;</span><br><span class="line">      &lt;head&gt;&lt;title&gt;TomcatA&lt;/title&gt;&lt;/head&gt;</span><br><span class="line">       &lt;body&gt;</span><br><span class="line">         &lt;h1&gt;&lt;font color=<span class="string">"red"</span>&gt;TomcatB.daizhe.com&lt;/font&gt;&lt;/h1&gt;</span><br><span class="line">            &lt;table align=<span class="string">"centre"</span> border=<span class="string">"1"</span>&gt;</span><br><span class="line">            &lt;tr&gt;</span><br><span class="line">              &lt;td&gt;Session ID&lt;/td&gt;</span><br><span class="line">            &lt;% session.setAttribute(<span class="string">"a.com"</span>,<span class="string">"a.com"</span>); %&gt;</span><br><span class="line">              &lt;td&gt;&lt;%= session.getId() %&gt;&lt;/td&gt;</span><br><span class="line">             &lt;/tr&gt;</span><br><span class="line">             &lt;tr&gt;</span><br><span class="line">         &lt;td&gt;Created on&lt;/td&gt;</span><br><span class="line">      &lt;td&gt;&lt;%= session.getCreationTime() %&gt;&lt;/td&gt;</span><br><span class="line">      &lt;/tr&gt;</span><br><span class="line">    &lt;/table&gt;</span><br><span class="line">    &lt;/body&gt;</span><br><span class="line">   &lt;/html&gt;</span><br><span class="line"></span><br><span class="line">  webapps]<span class="comment"># ln -sv myapp-v0.1 myapp</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#定义虚拟主机使用别名访问</span></span><br><span class="line">   ~]<span class="comment"># vim /etc/tomcat/server.xml </span></span><br><span class="line">   <span class="comment">#140行</span></span><br><span class="line">  &lt;Context path=<span class="string">"/myapp"</span> docBase=<span class="string">"/data/webapps/myapp"</span> reloadable=<span class="string">""</span>/&gt;</span><br><span class="line"></span><br><span class="line"><span class="comment">#打开页面管理接口（manager app和 host manager）</span></span><br><span class="line">  ~]<span class="comment"># vim /etc/tomcat/tomcat-users.xml </span></span><br><span class="line">  &lt;tomcat-users&gt;</span><br><span class="line">  &lt;role rolename=<span class="string">"manager-gui"</span>/&gt;</span><br><span class="line">  &lt;role rolename=<span class="string">"admin-gui"</span>/&gt;</span><br><span class="line">  &lt;role rolename=<span class="string">"manager-script"</span>/&gt; </span><br><span class="line">  &lt;user username=<span class="string">"tomcat"</span> password=<span class="string">"centos"</span> roles=<span class="string">"manager-gui,manager-script,admin-gui,admin-script"</span>/&gt;</span><br><span class="line">  &lt;/tomcat-users&gt;</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl start tomcat</span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br></pre></td></tr></table></figure><ul><li>访问测试是否配置成功</li></ul><p><img src="/2019/01/19/tomcat负载均衡/1.png" alt=""><br><img src="/2019/01/19/tomcat负载均衡/5.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">使用nginx实现客户端的请求完全向后端代理</span><br><span class="line">nginx_server</span><br><span class="line">  ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">  upstream tcserver &#123;</span><br><span class="line">        server 172.18.135.1:8080; <span class="comment">#tomcat A 地址</span></span><br><span class="line">        server 172.18.135.5:8080; <span class="comment">#tomcat B 地址</span></span><br><span class="line">        &#125;</span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Load configuration files for the default server block.</span></span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        proxy_pass http://tcserver/;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># nginx -t</span></span><br><span class="line">  ~]<span class="comment"># nginx -s reload</span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br></pre></td></tr></table></figure><ul><li>客户端测试查看（此时是不能保持session会话,服务器认为是不同的session）</li></ul><p><img src="/2019/01/19/tomcat负载均衡/3.png" alt=""><br><img src="/2019/01/19/tomcat负载均衡/4.png" alt=""><br><img src="/2019/01/19/tomcat负载均衡/6.png" alt=""><br><img src="/2019/01/19/tomcat负载均衡/7.png" alt=""></p><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">利用nginx的<span class="built_in">hash</span>算法实现会话绑定</span><br><span class="line"><span class="comment">#基于一致性BASH算法实现会话绑定</span></span><br><span class="line">nginx_server</span><br><span class="line">   upstream tcserver &#123;</span><br><span class="line">        <span class="built_in">hash</span> <span class="variable">$remote_addr</span> consistent;</span><br><span class="line">        server 172.18.135.1:8080;</span><br><span class="line">        server 172.18.135.5:8080;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># nginx -t</span></span><br><span class="line">  ~]<span class="comment"># nginx -s reload</span></span><br></pre></td></tr></table></figure><ul><li>客户端测试（怎么刷新都会是一个tomcat服务器响应，认为是一个客户端）<ul><li>但是这用基于bash的机制是存在劣势的，万一响应的服务器宕机则客户端则无法接收到响应</li></ul></li></ul><p><img src="/2019/01/19/tomcat负载均衡/8.png" alt=""><br><img src="/2019/01/19/tomcat负载均衡/8.png" alt=""></p><hr><h3 id="范例：使用http实现负载均衡"><a href="#范例：使用http实现负载均衡" class="headerlink" title="范例：使用http实现负载均衡"></a><code>范例：使用http实现负载均衡</code></h3><ul><li>httpd也可以实现负载均衡以及会话保持，甚至支持coocki级别的会话保持<ul><li>持续支持的调度算法（lbmethod）<ul><li>bytraffic:后端服务器流量大小承载调度（流量小被调度）</li><li>byrequests:根据请求调度，不考虑后端服务器的繁忙程度（轮询）</li><li>bybusyness ：根据后端繁忙服务器程度进行调度，永不排队（商业版本支持）</li></ul></li></ul></li></ul><p>参考手册：<a href="http://httpd.apache.org/docs/2.4/howto/reverse_proxy.html" target="_blank" rel="noopener">http://httpd.apache.org/docs/2.4/howto/reverse_proxy.html</a></p><h4 id="方式1-http协议"><a href="#方式1-http协议" class="headerlink" title="方式1:http协议"></a>方式1:http协议</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#httpd做tomcat前端调度支持的协议（http\ajp 8009）</span></span><br><span class="line"><span class="comment">#nginx做tomcat前端调度支持的协议（http）</span></span><br><span class="line">httpd_server httpd协议</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/httpd/conf.d/tomcat-cluster.conf</span></span><br><span class="line"></span><br><span class="line">  &lt;proxy balancer://tcsrvs&gt;</span><br><span class="line">  BalancerMember http://172.18.135.1:8080 loadfactor=2  <span class="comment">#定义负载因子如果不定义默认都为1</span></span><br><span class="line">  BalancerMember http://172.18.135.5:8080</span><br><span class="line">  ProxySet lbmethod=byrequests</span><br><span class="line">  &lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">  &lt;VirtualHost *:80&gt;</span><br><span class="line">        ServerName www.centos.com    <span class="comment">#nginx主机名   </span></span><br><span class="line">        ProxyVia On</span><br><span class="line">        ProxyRequests Off</span><br><span class="line">        ProxyPreserveHost On</span><br><span class="line">  &lt;Proxy *&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">  &lt;/Proxy&gt;</span><br><span class="line">        ProxyPass / balancer://tcsrvs/</span><br><span class="line">        ProxyPassReverse / balancer://tcsrvs/</span><br><span class="line">  &lt;Location /&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">  &lt;/Location&gt;</span><br><span class="line">  &lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># httpd -t</span></span><br><span class="line">  ~]<span class="comment"># systemctl start httpd</span></span><br></pre></td></tr></table></figure><ul><li>访问测试（此时保证不了会话绑定）</li></ul><p><img src="/2019/01/19/tomcat负载均衡/9.png" alt=""><br><img src="/2019/01/19/tomcat负载均衡/10.png" alt=""><br><img src="/2019/01/19/tomcat负载均衡/11.png" alt=""><br><img src="/2019/01/19/tomcat负载均衡/12.png" alt=""></p><h4 id="方式2：ajp协议"><a href="#方式2：ajp协议" class="headerlink" title="方式2：ajp协议"></a>方式2：ajp协议</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">httpd_server ajp协议</span><br><span class="line">&lt;proxy balancer://tcsrvs&gt;</span><br><span class="line">BalancerMember ajp://172.18.100.67:8009</span><br><span class="line">BalancerMember ajp://172.18.100.68:8009</span><br><span class="line">ProxySet lbmethod=byrequests</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">&lt;VirtualHost *:80&gt;</span><br><span class="line">ServerName lb.magedu.com</span><br><span class="line">ProxyVia On</span><br><span class="line">ProxyRequests Off</span><br><span class="line">ProxyPreserveHost On</span><br><span class="line">&lt;Proxy *&gt;</span><br><span class="line">Require all granted</span><br><span class="line">&lt;/Proxy&gt;</span><br><span class="line">ProxyPass / balancer://tcsrvs/</span><br><span class="line">ProxyPassReverse / balancer://tcsrvs/</span><br><span class="line">&lt;Location /&gt;</span><br><span class="line">Require all granted</span><br><span class="line">&lt;/Location&gt;</span><br><span class="line">&lt;Location /balancer-manager&gt;</span><br><span class="line">SetHandler balancer-manager</span><br><span class="line">ProxyPass !</span><br><span class="line">Require all granted</span><br><span class="line">&lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure><h3 id="会话粘性（httpd基于cookie的会话粘性）"><a href="#会话粘性（httpd基于cookie的会话粘性）" class="headerlink" title="会话粘性（httpd基于cookie的会话粘性）"></a>会话粘性（httpd基于cookie的会话粘性）</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#httpd不支持客户端地址的粘性</span></span><br><span class="line"><span class="comment">#httpd是根据客户端的cookie做会话粘性</span></span><br><span class="line">httpd服务保持会话粘性：</span><br><span class="line">  <span class="comment">#当服务器第一次收到客户端的请求给他设定cookie时候，在这个cookie中把原有值之外额外设置添加一个对应的键（键名可以自己定义），值则是调度器第一次挑选要负载用户请求的后端服务器的名称，随后用户每后来的访问一定默认会带着cookie,而人为定义之后cookie之中是带有人为设置的键和值的对应信息的（不是基于原ip绑定，而是实现人为的会话中的cookie中插入的键值一致性实现的）</span></span><br><span class="line"></span><br><span class="line">Header add Set-Cookie <span class="string">"ROUTEID=.%&#123;BALANCER_WORKER_ROUTE&#125;e; path=/"</span> env=BALANCER_ROUTE_CHANGED</span><br><span class="line"></span><br><span class="line">Header add Set-Cookie <span class="comment">#给客户端设置的cookie</span></span><br><span class="line">  ROUTEID= <span class="comment">#键名</span></span><br><span class="line">  .%&#123;BALANCER_WORKER_ROUTE&#125;e  <span class="comment">#调度服务器挑选出后端服务器</span></span><br><span class="line">  path= <span class="comment">#指定会话cookie的适用范围</span></span><br></pre></td></tr></table></figure><hr><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">编辑调度器httpd_server设置会话粘性</span><br><span class="line">  ~]<span class="comment"># vim /etc/httpd/conf.d/tomcat-cluster.conf </span></span><br><span class="line">  Header add Set-Cookie <span class="string">"ROUTEID=.%&#123;BALANCER_WORKER_ROUTE&#125;e; path=/"</span> env=BALANCER_ROUTE_CHANGED</span><br><span class="line">  &lt;proxy balancer://tcsrvs&gt;BalancerMember http://172.18.135.1:8080 loadfactor=2 route=TomcatA </span><br><span class="line">  BalancerMember http://172.18.135.5:8080 route=TomcatA loadfactor=1</span><br><span class="line">  ProxySet lbmethod=byrequests</span><br><span class="line">  ProxySet stickysession=ROUTEID</span><br><span class="line">  &lt;/Proxy&gt;</span><br><span class="line"></span><br><span class="line">  &lt;VirtualHost *:80&gt;</span><br><span class="line">        ServerName www.centos.com</span><br><span class="line">        ProxyVia On</span><br><span class="line">        ProxyRequests Off</span><br><span class="line">        ProxyPreserveHost On</span><br><span class="line">  &lt;Proxy *&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">  &lt;/Proxy&gt;</span><br><span class="line">        ProxyPass / balancer://tcsrvs/</span><br><span class="line">        ProxyPassReverse / balancer://tcsrvs/</span><br><span class="line">  &lt;Location /&gt;</span><br><span class="line">        Require all granted</span><br><span class="line">  &lt;/Location&gt;</span><br><span class="line">  &lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># httpd -t</span></span><br><span class="line">  ~]<span class="comment"># systemctl restart httpd</span></span><br></pre></td></tr></table></figure><p>客户端测试（已经实现基于cookie的会话粘性。可以使用Chrome开发者模式F12查看）<br><img src="/2019/01/19/tomcat负载均衡/13.png" alt=""><br><img src="/2019/01/19/tomcat负载均衡/13.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;tomcat负载均衡及会话保持–nginx-httpd&quot;&gt;&lt;a href=&quot;#tomcat负载均衡及会话保持–nginx-httpd&quot; class=&quot;headerlink&quot; title=&quot;tomcat负载均衡及会话保持–nginx | httpd&quot;&gt;&lt;/a&gt;tomcat负载均衡及会话保持–nginx | httpd&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/01/19/tomcat负载均衡/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="tomcat" scheme="https://daizhe.net.cn/categories/tomcat/"/>
    
    
      <category term="tomcat" scheme="https://daizhe.net.cn/tags/tomcat/"/>
    
  </entry>
  
  <entry>
    <title>tomcat配置进阶--反代</title>
    <link href="https://daizhe.net.cn/2019/01/18/tomcat%E9%85%8D%E7%BD%AE%E8%BF%9B%E9%98%B62/"/>
    <id>https://daizhe.net.cn/2019/01/18/tomcat配置进阶2/</id>
    <published>2019-01-18T13:07:51.842Z</published>
    <updated>2019-01-22T12:06:51.689Z</updated>
    
    <content type="html"><![CDATA[<h1 id="tomcat配置进阶–反代"><a href="#tomcat配置进阶–反代" class="headerlink" title="tomcat配置进阶–反代"></a>tomcat配置进阶–反代</h1><p><img src="/2019/01/18/tomcat配置进阶2/标题.gif" alt=""><br><a id="more"></a></p><h2 id="tomcat配置进阶–反代-1"><a href="#tomcat配置进阶–反代-1" class="headerlink" title="tomcat配置进阶–反代"></a>tomcat配置进阶–反代</h2><h3 id="nginx反代配置方式"><a href="#nginx反代配置方式" class="headerlink" title="nginx反代配置方式"></a>nginx反代配置方式</h3><h4 id="完全代理"><a href="#完全代理" class="headerlink" title="完全代理"></a><code>完全代理</code></h4><ul><li>客户端请求的所有资源都经由nginx反代给后端tomcat</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#完全向后反代</span></span><br><span class="line">nginx配置文件</span><br><span class="line"></span><br><span class="line">location  / &#123;</span><br><span class="line">  proxy_pass http://127.0.0.1:8080/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h4 id="动静分离（动静分离的前提是应用程序支持动态页面和静态页面分开也可以达到客户端请求资源的一致性）"><a href="#动静分离（动静分离的前提是应用程序支持动态页面和静态页面分开也可以达到客户端请求资源的一致性）" class="headerlink" title="动静分离（动静分离的前提是应用程序支持动态页面和静态页面分开也可以达到客户端请求资源的一致性）"></a><code>动静分离（动静分离的前提是应用程序支持动态页面和静态页面分开也可以达到客户端请求资源的一致性）</code></h4><p><img src="/2019/01/18/tomcat配置进阶2/分离.png" alt=""></p><ul><li><p>nginx配置中指明客户端请求的闻不见类型为jsp或do结尾才代理给后端的tomcat服务器，除了此类型的文件外都经由nginx处理响应客户端的请求</p></li><li><p>为什么要实现动静分离</p><ul><li>nginx的处理静态资源能力超强<ul><li>主要是nginx处理静态页面的效率远高于tomcat的处理能力，如果tomcat的请求量为1000次，则nginx的请求量为6000次，tomcat每秒的吞吐量为0.6M，nginx的每秒吞吐量为3.6M，可以说，nginx处理静态资源的能力是tomcat处理能力的6倍，优势可见一斑。</li></ul></li><li><p>动态资源和静态资源分开，使服务器结构更清晰。</p></li><li><p>动静分离原理：</p><ul><li>服务端接收来自客户端的请求中，有一部分是静态资源的请求，例如html,css,js和图片资源等等，有一部分是动态数据的请求。因为tomcat处理静态资源的速度比较慢，所以我们可以考虑把所有静态资源独立开来，交给处理静态资源更快的服务器例如nginx处理，而把动态请求交给tomcat处理。<br>如下图所示，我们在机器上同时安装了nginx和tomcat,把所有的静态资源都放置在nginx的webroot目录下面，把动态请求的程序都放在tomcat的webroot目录下面，当客户端访问服务端的时候，如果是静态资源的请求，就直接到nginx的webroot目录下面获取资源，如果是动态资源的请求，nginx利用反向代理的原理，把请求转发给tomcat进行处理，这样就实现了动静分离，提高了服务器处理请求的性能。</li></ul></li></ul></li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#有选择的进行反代以便实现动静分离</span></span><br><span class="line">nginx 配置文件</span><br><span class="line"></span><br><span class="line">location ~* \.(jsp|<span class="keyword">do</span>)$ &#123;</span><br><span class="line">  proxy_pass www.tomcat.com:8080; <span class="comment">#此处最好使用后端tomcat主机名，如果tomcat在本地，则使用localhost</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">location / &#123;</span><br><span class="line">  root /data/myapp/ROOT</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="实现nginx反向代理"><a href="#实现nginx反向代理" class="headerlink" title="实现nginx反向代理"></a>实现nginx反向代理</h2><p><img src="/2019/01/18/tomcat配置进阶2/nginx代理.png" alt=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里使用了docker容器化技术，将tomcat运行在docker容器中运行，运行的容器默认使用docker0桥与宿主机建立关联关系,并在宿主机上安装nginx接受客户端的请求代理给运行在docker容器中的tomcat</span></span><br><span class="line"></span><br><span class="line">安装docker</span><br><span class="line">  ~]<span class="comment"># cd /etc/yum.repos.d/</span></span><br><span class="line">  yum.repos.d]<span class="comment"># wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class="line">  ~]<span class="comment"># yum install docker-ce -y</span></span><br><span class="line">  ~]<span class="comment"># systemctl start docker</span></span><br><span class="line"></span><br><span class="line">获取tomcat镜像</span><br><span class="line">  https://hub.docker.com/_/tomcat?tab=tags</span><br><span class="line"></span><br><span class="line">下载tomcat镜像</span><br><span class="line">  ~]<span class="comment"># docker pull tomcat:8.5-alpine</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">后启动容器（指定容器中tomcat的工作目录与宿主机的目录生成docker管理的卷的存储卷关系）</span><br><span class="line">  ~]<span class="comment"># docker run --name tc1 -d -v /usr/local/tomcat/webapps tomcat:8.5-alpine </span></span><br><span class="line">  ~]<span class="comment"># docker container inspect tc1</span></span><br><span class="line">  ~]<span class="comment"># cd /var/lib/docker/volumes/12d5e74a0cc8e916b7545898b41d802f85fed1cd0a5996fe7f74582245a8b2a3/_data</span></span><br><span class="line">  _data]<span class="comment"># ls</span></span><br><span class="line">  docs  examples  host-manager  manager  ROOT</span><br><span class="line"></span><br><span class="line">宿主机上测试访问</span><br><span class="line">  ~]<span class="comment"># curl 172.17.0.2:8080</span></span><br><span class="line"></span><br><span class="line">宿主机上安装nginx并配置实现代理</span><br><span class="line">  ~]<span class="comment"># yum install nginx -y</span></span><br><span class="line">  ~]<span class="comment"># systemctl start nginx</span></span><br><span class="line">  ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">  server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line"></span><br><span class="line">        <span class="comment"># Load configuration files for the default server block.</span></span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        proxy_pass http://172.17.0.1:8080/;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># nginx -t</span></span><br><span class="line">  ~]<span class="comment"># nginx -s reload</span></span><br><span class="line"></span><br><span class="line">客户端访问宿主机地址(此时nginx已经实现反向代理到tomcat)</span><br><span class="line">   ~]<span class="comment"># curl 172.18.135.1  #访问宿主机地址</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">实现nginx反代tomcat动静分离（仅查看一下动静分离查看效果）</span><br><span class="line">  ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">      server &#123;</span><br><span class="line">        listen       80 default_server;</span><br><span class="line">        listen       [::]:80 default_server;</span><br><span class="line">        server_name  _;</span><br><span class="line">        root         /usr/share/nginx/html;</span><br><span class="line">        index index.jsp index.html;</span><br><span class="line">        <span class="comment"># Load configuration files for the default server block.</span></span><br><span class="line">        include /etc/nginx/default.d/*.conf;</span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">        proxy_pass http://172.17.0.2:8080;</span><br><span class="line">        &#125;</span><br><span class="line">        location ~* \.(jsp|<span class="keyword">do</span>)$ &#123;</span><br><span class="line">        root <span class="string">"映射在宿主机上的存储的卷"</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 404 /404.html;</span><br><span class="line">            location = /40x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        error_page 500 502 503 504 /50x.html;</span><br><span class="line">            location = /50x.html &#123;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure></p><hr><h2 id="实现httpd反向代理"><a href="#实现httpd反向代理" class="headerlink" title="实现httpd反向代理"></a>实现httpd反向代理</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 这里使用了docker容器化技术，将tomcat运行在docker容器中运行，运行的容器默认使用docker0桥与宿主机建立关联关系,并在宿主机上安装httpd接受客户端的请求代理给运行在docker容器中的tomcat</span></span><br><span class="line"></span><br><span class="line">proxy_ajp_module代理配置示例：</span><br><span class="line"><span class="comment">#&lt;VirtualHost *:80&gt;</span></span><br><span class="line"><span class="comment">#ServerName      tc1.centos.com</span></span><br><span class="line"><span class="comment">#ProxyRequests Off   #关闭正向代理</span></span><br><span class="line"><span class="comment">#ProxyVia        On  # 对每一个响应报文都添加一个via首部（可以查看代理的主机地址）</span></span><br><span class="line"><span class="comment">#ProxyPreserveHost On #用户请求的主机向后端代理时要不要保留代理服务器使用的主机名</span></span><br><span class="line"><span class="comment">#&lt;Proxy *&gt;           #定义代理服务</span></span><br><span class="line"><span class="comment">#Require all granted #允许任何请求使用代理服务</span></span><br><span class="line"><span class="comment">#&lt;/Proxy&gt;</span></span><br><span class="line"><span class="comment">#ProxyPass / ajp://tc1.centos.com:8009/  #将用户请求的根代理到服务器端真正的根</span></span><br><span class="line"><span class="comment">#ProxyPassReverse / ajp://tc1.centos.com:8009/   #如果tomcat服务器返回一个重写的法则，也将此法则返回给客户端</span></span><br><span class="line"><span class="comment">#&lt;Location /&gt;    #客户端请求rul根，设置权限</span></span><br><span class="line"><span class="comment">#Require all granted #接受所有请求</span></span><br><span class="line"><span class="comment">#&lt;/Location&gt;</span></span><br><span class="line"><span class="comment">#&lt;/VirtualHost&gt;</span></span><br><span class="line"></span><br><span class="line">proxy_http_module代理配置示例：</span><br><span class="line"><span class="comment">#&lt;VirtualHost *:80&gt;</span></span><br><span class="line"><span class="comment">#ServerName      tc1.centos.com</span></span><br><span class="line"><span class="comment">#ProxyRequests Off</span></span><br><span class="line"><span class="comment">#ProxyVia        On</span></span><br><span class="line"><span class="comment">#ProxyPreserveHost On</span></span><br><span class="line"><span class="comment">#&lt;Proxy *&gt;</span></span><br><span class="line"><span class="comment">#Require all granted</span></span><br><span class="line"><span class="comment">#&lt;/Proxy&gt;</span></span><br><span class="line"><span class="comment">#ProxyPass / http://tc1.centos.com:8080/</span></span><br><span class="line"><span class="comment">#ProxyPassReverse / http://tc1.centos.com:8080/ </span></span><br><span class="line"><span class="comment">#&lt;Location /&gt;</span></span><br><span class="line"><span class="comment">#Require all granted</span></span><br><span class="line"><span class="comment">#&lt;/Location&gt;</span></span><br><span class="line"><span class="comment">#&lt;/VirtualHost&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#      &lt;LocationMatch "\.(jsp|do)$&gt;   #基于正则表达式匹配检查</span></span><br><span class="line"><span class="comment">#       ProxyPass / http://tc1.centos.com:8080/    #定义反代的url，客户请求的其他的url则不进行反代</span></span><br><span class="line"><span class="comment">#    &lt;/LocationMatch&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">宿主上安装httpd（完全代理）</span><br><span class="line">  ~]<span class="comment"># yum install httpd -y </span></span><br><span class="line">  ~]<span class="comment"># httpd -M    #确认proxy_module反代模块存在，否则不支持httpd反向代理</span></span><br><span class="line">  proxy_module (shared)</span><br><span class="line">  proxy_ajp_module (shared) <span class="comment">#反代支持ajp协议</span></span><br><span class="line">  proxy_http_module (shared)  <span class="comment">#httpd协议反代</span></span><br><span class="line">  proxy_fcgi_module (shared)  </span><br><span class="line"></span><br><span class="line">配置httpd</span><br><span class="line">  ~]<span class="comment"># vim /etc/httpd/conf.d/tomcat-http.conf</span></span><br><span class="line">  ~]<span class="comment"># vim /etc/httpd/conf.d/tomcat-http.conf</span></span><br><span class="line">    &lt;VirtualHost *:80&gt;</span><br><span class="line">     ServerName   www.centos.com</span><br><span class="line">     ProxyRequests Off</span><br><span class="line">     ProxyVia        On   <span class="comment">#对每一个响应报文都添加一个via首部</span></span><br><span class="line">     ProxyPreserveHost On</span><br><span class="line">     &lt;Proxy *&gt;</span><br><span class="line">     Require all granted</span><br><span class="line">     &lt;/Proxy&gt;</span><br><span class="line">     ProxyPass / http://172.17.0.2:8080/    <span class="comment">#后端tomcat地址</span></span><br><span class="line">     ProxyPassReverse / http://172.17.0.2:8080/   </span><br><span class="line">     &lt;Location /&gt;</span><br><span class="line">      Require all granted</span><br><span class="line">      &lt;/Location&gt;</span><br><span class="line">      &lt;/VirtualHost&gt;</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># httpd -t</span></span><br><span class="line">  Syntax OK</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># systemctl start httpd</span></span><br><span class="line"></span><br><span class="line">测试</span><br><span class="line">  ~]<span class="comment"># curl 172.18.135.1</span></span><br></pre></td></tr></table></figure><p>配置文件中添加  ProxyVia  On  可以使用浏览器开发者接口查看到<br><img src="/2019/01/18/tomcat配置进阶2/接口.png" alt=""></p><hr><p>http基于ajp协议实现反代<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"> &lt;VirtualHost *:80&gt;</span><br><span class="line">  ServerName   www.centos.com</span><br><span class="line">  ProxyRequests Off</span><br><span class="line">  ProxyVia        On</span><br><span class="line">  ProxyPreserveHost On</span><br><span class="line"> &lt;Proxy *&gt;</span><br><span class="line">  Require all granted</span><br><span class="line"> &lt;/Proxy&gt;</span><br><span class="line">  ProxyPass / ajp://172.17.0.2:8009/</span><br><span class="line">  ProxyPassReverse / ajp://172.17.0.2:8009/</span><br><span class="line">&lt;Location /&gt;</span><br><span class="line">  Require all granted</span><br><span class="line">&lt;/Location&gt;</span><br><span class="line">&lt;/VirtualHost&gt;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;tomcat配置进阶–反代&quot;&gt;&lt;a href=&quot;#tomcat配置进阶–反代&quot; class=&quot;headerlink&quot; title=&quot;tomcat配置进阶–反代&quot;&gt;&lt;/a&gt;tomcat配置进阶–反代&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/01/18/tomcat配置进阶2/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="tomcat" scheme="https://daizhe.net.cn/categories/tomcat/"/>
    
    
      <category term="tomcat" scheme="https://daizhe.net.cn/tags/tomcat/"/>
    
  </entry>
  
</feed>
