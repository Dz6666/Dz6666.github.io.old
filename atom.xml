<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">
  <title>Dai zhe&#39;s notes</title>
  
  <subtitle>Just Du It</subtitle>
  <link href="/atom.xml" rel="self"/>
  
  <link href="https://daizhe.net.cn/"/>
  <updated>2019-02-21T03:50:31.442Z</updated>
  <id>https://daizhe.net.cn/</id>
  
  <author>
    <name>哆啦A梦</name>
    
  </author>
  
  <generator uri="http://hexo.io/">Hexo</generator>
  
  <entry>
    <title>ELK之Logstash收集TCP和UDP日志</title>
    <link href="https://daizhe.net.cn/2019/02/21/ELK%E4%B9%8BLogstash%E6%94%B6%E9%9B%86TCP%E5%92%8CUDP%E6%97%A5%E5%BF%97/"/>
    <id>https://daizhe.net.cn/2019/02/21/ELK之Logstash收集TCP和UDP日志/</id>
    <published>2019-02-21T03:01:44.367Z</published>
    <updated>2019-02-21T03:50:31.442Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ELK之Logstash收集TCP和UDP日志"><a href="#ELK之Logstash收集TCP和UDP日志" class="headerlink" title="ELK之Logstash收集TCP和UDP日志"></a>ELK之Logstash收集TCP和UDP日志</h1><p><img src="/2019/02/21/ELK之Logstash收集TCP和UDP日志/标题.gif" alt=""><br><a id="more"></a></p><h2 id="Logstash收集TCP和UDP日志"><a href="#Logstash收集TCP和UDP日志" class="headerlink" title="Logstash收集TCP和UDP日志"></a>Logstash收集TCP和UDP日志</h2><ul><li><p>通过logstash的tcp/udp插件收集日志，通常用于在向elasticsearch日志补录丢失的部分日志，可以将丢失的日志写到一个文件，然后通过TCP日志收集方式直接发送给logstash然后再写入到elasticsearch服务器。</p></li><li><p>官方介绍：<a href="https://www.elastic.co/guide/en/logstash/5.6/input-plugins.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/5.6/input-plugins.html</a></p></li></ul><p>Logstash配置文件解释<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">logstash配置文件，先进行收集测试：</span><br><span class="line">[root@linux-host6 ~]<span class="comment"># cat /etc/logstash/conf.d/tcp.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  tcp &#123;             <span class="comment">#指定收集tcp的日志</span></span><br><span class="line">    port =&gt; 9889    </span><br><span class="line">    host =&gt; <span class="string">"0.0.0.0"</span>  <span class="comment">#指定监听的本机地址，如果不指定默认时0.0.0.0监听本机的所有可用的地址</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"tcplog"</span>  <span class="comment">#指定类型</span></span><br><span class="line">    mode =&gt; <span class="string">"server"</span>   <span class="comment">#是定server或者client ，如果不指定默认的为server</span></span><br><span class="line">    codec =&gt; json</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;</span><br><span class="line">    codec =&gt; rubydebug</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><hr><h3 id="标准输出测试（测试基于tcp收集日志，是否可以收到日志）"><a href="#标准输出测试（测试基于tcp收集日志，是否可以收到日志）" class="headerlink" title="标准输出测试（测试基于tcp收集日志，是否可以收到日志）"></a>标准输出测试（测试基于tcp收集日志，是否可以收到日志）</h3><p>1:logstash收集本机的tcp链接的日志文件，编辑logstash配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cat /etc/logstash/conf.d/tcp.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 12345</span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"tcplog"</span></span><br><span class="line">    mode =&gt; <span class="string">"server"</span>  </span><br><span class="line">   codec =&gt; json</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  stdout &#123;</span><br><span class="line">    codec =&gt; rubydebug</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2：测试logstash配置文件并启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">测试配置文件语法</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcplog.cof -t</span></span><br><span class="line"></span><br><span class="line">前台启动logstash测试是否可以接收到tcp日志</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcplog.cof</span></span><br><span class="line"></span><br><span class="line">验证端口是否启动</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  :::12345</span><br></pre></td></tr></table></figure></p><p>3：其他主机测试：在其他服务器安装nc命令：<br>NetCat简称nc，在网络工具中有“瑞士军刀”美誉，其功能实用，是一个简单、可靠的网络工具，可通过TCP或UDP协议传输读写数据，另外还具有很多其他功能。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">安装测试工具</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment">#  yum instll nc –y</span></span><br><span class="line"></span><br><span class="line">发送tcp消息到logstash主机</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># echo "nc test" | nc 172.20.101.221(logstash主机地址) 12345</span></span><br></pre></td></tr></table></figure></p><p>4：查看logstash主机是否接收到日志消息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcplog.cof</span></span><br><span class="line">WARNING: Could not find logstash.yml <span class="built_in">which</span> is typically located <span class="keyword">in</span> <span class="variable">$LS_HOME</span>/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config <span class="built_in">which</span> logs errors to the console</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"@timestamp"</span> =&gt; 2019-02-21T03:34:35.041Z,</span><br><span class="line">        <span class="string">"port"</span> =&gt; 43030,</span><br><span class="line">    <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">        <span class="string">"host"</span> =&gt; <span class="string">"172.20.0.1"</span>,</span><br><span class="line">     <span class="string">"message"</span> =&gt; <span class="string">"nc test"</span>,</span><br><span class="line">        <span class="string">"type"</span> =&gt; <span class="string">"tcplog"</span>,</span><br><span class="line">        <span class="string">"tags"</span> =&gt; [</span><br><span class="line">      [0] <span class="string">"_jsonparsefailure"</span></span><br><span class="line">  ]</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>5:其他主机测试：通过nc命令发送一个文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">通过nc命令发送一个文件：</span><br><span class="line">  ~]<span class="comment"># nc 172.20.101.221 12345 &lt; /etc/passwd</span></span><br></pre></td></tr></table></figure></p><p>6：logstash主机查看验证数据<br><img src="/2019/02/21/ELK之Logstash收集TCP和UDP日志/1.png" alt=""></p><p>7：其他主机测试：<br>通过伪设备的方式发送消息：<br>在类Unix操作系统中，块设备有硬盘、内存的硬件，但是还有设备节点并不一定要对应物理设备，我们把没有这种对应关系的设备是伪设备，比如/dev/null，/dev/zero，/dev/random以及/dev/tcp和/dev/upd等，Linux操作系统使用这些伪设备提供了多种不通的功能，tcp通信只是dev下面众多伪设备当中的一种设备。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># echo "伪设备"  &gt; /dev/tcp/172.20.101.221/12345</span></span><br></pre></td></tr></table></figure></p><p>8：logstash主机查看验证数据<br><img src="/2019/02/21/ELK之Logstash收集TCP和UDP日志/2.png" alt=""></p><hr><h3 id="Lgstash收集本机TCP日志将输出改为elasticsearch"><a href="#Lgstash收集本机TCP日志将输出改为elasticsearch" class="headerlink" title="Lgstash收集本机TCP日志将输出改为elasticsearch"></a>Lgstash收集本机TCP日志将输出改为elasticsearch</h3><p>1：logstash收集本机的tcp链接的日志文件，编辑logstash配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">  ~]<span class="comment"># vim /etc/logstash/conf.d/tcplog.cof </span></span><br><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">  tcp &#123;</span><br><span class="line">    port =&gt; 12345</span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"tcplog"</span></span><br><span class="line">    mode =&gt; <span class="string">"server"</span></span><br><span class="line">    host =&gt; <span class="string">"0.0.0.0"</span></span><br><span class="line">    codec =&gt; json</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"tcplog"</span> &#123;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt; [<span class="string">"172.18.135.1:9200"</span>]</span><br><span class="line">    index =&gt;  <span class="string">"logstash-tcplog-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2：测试logstash配置文件语法并启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tcplog.cof -t</span></span><br><span class="line">~]<span class="comment"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p><p>3；通过nc命令或伪设备输入日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># nc 172.20.101.221 12345 &lt; /etc/passwd</span></span><br></pre></td></tr></table></figure></p><p>4：在kibana界面添加索引<br><img src="/2019/02/21/ELK之Logstash收集TCP和UDP日志/3.png" alt=""></p><p>5：kibana验证数据<br><img src="/2019/02/21/ELK之Logstash收集TCP和UDP日志/4.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ELK之Logstash收集TCP和UDP日志&quot;&gt;&lt;a href=&quot;#ELK之Logstash收集TCP和UDP日志&quot; class=&quot;headerlink&quot; title=&quot;ELK之Logstash收集TCP和UDP日志&quot;&gt;&lt;/a&gt;ELK之Logstash收集TCP和UDP日志&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/21/ELK之Logstash收集TCP和UDP日志/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>ELK之Logstash收集Nginx日志</title>
    <link href="https://daizhe.net.cn/2019/02/20/ELK%E4%B9%8BLogstash%E6%94%B6%E9%9B%86Nginx%E6%97%A5%E5%BF%97/"/>
    <id>https://daizhe.net.cn/2019/02/20/ELK之Logstash收集Nginx日志/</id>
    <published>2019-02-20T13:21:02.812Z</published>
    <updated>2019-02-21T02:56:11.190Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ELK之Logstash收集Nginx日志"><a href="#ELK之Logstash收集Nginx日志" class="headerlink" title="ELK之Logstash收集Nginx日志"></a>ELK之Logstash收集Nginx日志</h1><p><img src="/2019/02/20/ELK之Logstash收集Nginx日志/标题.gif" alt=""><br><a id="more"></a></p><h2 id="收集nginx访问日志"><a href="#收集nginx访问日志" class="headerlink" title="收集nginx访问日志"></a>收集nginx访问日志</h2><p><img src="/2019/02/20/ELK之Logstash收集Nginx日志/1.png" alt=""></p><p>1.安装nginx<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">编译安装</span><br><span class="line"></span><br><span class="line">    src]<span class="comment"># pwd</span></span><br><span class="line">    /usr/share/src</span><br><span class="line">    src]<span class="comment"># ls</span></span><br><span class="line">    nginx-1.2.9.tar.gz</span><br><span class="line">    src]<span class="comment"># tar xzvf nginx-1.2.9.tar.gz </span></span><br><span class="line"></span><br><span class="line">    nginx-1.2.9]<span class="comment"># pwd</span></span><br><span class="line">    /usr/share/src/nginx-1.2.9</span><br><span class="line"></span><br><span class="line">指定安装位置并编译安装</span><br><span class="line"></span><br><span class="line">    nginx-1.2.9]<span class="comment"># ./configure --prefix=/usr/share/nginx &amp;&amp; make &amp;&amp; make install</span></span><br></pre></td></tr></table></figure></p><p>2：修改nginx日志格式(将输出的日志格式修改为json格式的日志格式)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cat /usr/share/nginx/conf/nginx.conf</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#user  nobody;</span></span><br><span class="line">worker_processes  1;</span><br><span class="line"></span><br><span class="line"><span class="comment">#error_log  logs/error.log;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  notice;</span></span><br><span class="line"><span class="comment">#error_log  logs/error.log  info;</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#pid        logs/nginx.pid;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">events &#123;</span><br><span class="line">    worker_connections  1024;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">http &#123;</span><br><span class="line">    include       mime.types;</span><br><span class="line">    default_type  application/octet-stream;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#log_format  main  '$remote_addr - $remote_user [$time_local] "$request" '</span></span><br><span class="line">    <span class="comment">#                  '$status $body_bytes_sent "$http_referer" '</span></span><br><span class="line">    <span class="comment">#                  '"$http_user_agent" "$http_x_forwarded_for"';</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#access_log  logs/access.log  main;</span></span><br><span class="line">    <span class="comment">#注意定义的日志的位置</span></span><br><span class="line">log_format access_json <span class="string">'&#123;"@timestamp":"$time_iso8601",'</span>        <span class="comment">#定义日志的格式</span></span><br><span class="line">        <span class="string">'"host":"$server_addr",'</span></span><br><span class="line">        <span class="string">'"clientip":"$remote_addr",'</span></span><br><span class="line">        <span class="string">'"size":$body_bytes_sent,'</span></span><br><span class="line">        <span class="string">'"responsetime":$request_time,'</span></span><br><span class="line">        <span class="string">'"upstreamtime":"$upstream_response_time",'</span></span><br><span class="line">        <span class="string">'"upstreamhost":"$upstream_addr",'</span></span><br><span class="line">        <span class="string">'"http_host":"$host",'</span></span><br><span class="line">        <span class="string">'"url":"$uri",'</span></span><br><span class="line">        <span class="string">'"domain":"$host",'</span></span><br><span class="line">        <span class="string">'"xff":"$http_x_forwarded_for",'</span></span><br><span class="line">        <span class="string">'"referer":"$http_referer",'</span></span><br><span class="line">        <span class="string">'"status":"$status"&#125;'</span>;</span><br><span class="line">    access_log  /var/<span class="built_in">log</span>/nginx/access.log  access_json;         <span class="comment">#调用此日志格式</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    sendfile        on;</span><br><span class="line">    <span class="comment">#tcp_nopush     on;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#keepalive_timeout  0;</span></span><br><span class="line">    keepalive_timeout  65;</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gzip  on;</span></span><br><span class="line"></span><br><span class="line">    server &#123;</span><br><span class="line">        listen       80;</span><br><span class="line">        server_name  localhost;</span><br><span class="line"></span><br><span class="line">        <span class="comment">#charset koi8-r;</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">#access_log  logs/host.access.log  main;</span></span><br><span class="line"></span><br><span class="line">        location / &#123;</span><br><span class="line">            root   html;</span><br><span class="line">            index  index.html index.htm;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建对应的保存日志的目录</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># mkdir /var/log/nginx</span></span><br></pre></td></tr></table></figure></p><p>3：启动nginx并访问默认页面查看日志格式<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">启动nginx</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># /usr/share/nginx/sbin/nginx -t</span></span><br><span class="line">    nginx: the configuration file /usr/share/nginx/conf/nginx.conf syntax is ok</span><br><span class="line">    nginx: configuration file /usr/share/nginx/conf/nginx.conf <span class="built_in">test</span> is successful</span><br><span class="line">    ~]<span class="comment"># /usr/share/nginx/sbin/nginx</span></span><br><span class="line"></span><br><span class="line">访问默认页面</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># curl 172.20.101.221:80</span></span><br><span class="line"></span><br><span class="line">查看日志格式</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># cat /var/log/nginx/access.log </span></span><br><span class="line">    &#123;<span class="string">"@timestamp"</span>:<span class="string">"2019-02-21T10:44:15+08:00"</span>,<span class="string">"host"</span>:<span class="string">"192.168.35.103"</span>,<span class="string">"clientip"</span>:<span class="string">"172.20.101.221"</span>,<span class="string">"size"</span>:612,<span class="string">"responsetime"</span>:0.000,<span class="string">"upstreamtime"</span>:<span class="string">"-"</span>,<span class="string">"upstreamhost"</span>:<span class="string">"-"</span>,<span class="string">"http_host"</span>:<span class="string">"172.20.101.221"</span>,<span class="string">"url"</span>:<span class="string">"/index.html"</span>,<span class="string">"domain"</span>:<span class="string">"172.20.101.221"</span>,<span class="string">"xff"</span>:<span class="string">"-"</span>,<span class="string">"referer"</span>:<span class="string">"-"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>&#125;</span><br></pre></td></tr></table></figure></p><p>4：配置本机上的logstash收集本机的nginx日志<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/logstash/conf.d/nginxlog.conf</span></span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/var/log/nginx/access.log"</span></span><br><span class="line">    start_position =&gt; <span class="string">"end"</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"nginx-accesslog"</span></span><br><span class="line">    codec =&gt; json</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"nginx-accesslog"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [<span class="string">"172.18.135.1:9200"</span>]</span><br><span class="line">      index =&gt; <span class="string">"logstash-nginx-accesslog-1516-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>5：logstash进行配置文件语法检测及重启服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/nginxlog.conf -t</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p><p>6：kibana界面添加索引<br><img src="/2019/02/20/ELK之Logstash收集Nginx日志/2.png" alt=""></p><p>7：kibana界面验证数据<br><img src="/2019/02/20/ELK之Logstash收集Nginx日志/3.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ELK之Logstash收集Nginx日志&quot;&gt;&lt;a href=&quot;#ELK之Logstash收集Nginx日志&quot; class=&quot;headerlink&quot; title=&quot;ELK之Logstash收集Nginx日志&quot;&gt;&lt;/a&gt;ELK之Logstash收集Nginx日志&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/ELK之Logstash收集Nginx日志/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>ELK之Logstash收集本机ES服务json类型日志</title>
    <link href="https://daizhe.net.cn/2019/02/20/ELK%E4%B9%8BLogstash%E6%94%B6%E9%9B%86%E6%9C%AC%E6%9C%BAES%E6%9C%8D%E5%8A%A1json%E7%B1%BB%E5%9E%8B%E6%97%A5%E5%BF%97/"/>
    <id>https://daizhe.net.cn/2019/02/20/ELK之Logstash收集本机ES服务json类型日志/</id>
    <published>2019-02-20T13:10:43.136Z</published>
    <updated>2019-02-20T13:24:07.119Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ELK之Logstash收集本机ES服务json类型日志"><a href="#ELK之Logstash收集本机ES服务json类型日志" class="headerlink" title="ELK之Logstash收集本机ES服务json类型日志"></a>ELK之Logstash收集本机ES服务json类型日志</h1><p><img src="/2019/02/20/ELK之Logstash收集本机ES服务json类型日志/标题.gif" alt=""><br><a id="more"></a></p><h2 id="收集java日志："><a href="#收集java日志：" class="headerlink" title="收集java日志："></a>收集java日志：</h2><ul><li>java日志的格式长度不统一，有的条日志很短而有的一条记录很长好几行</li><li>使用codec的multiline插件实现多行匹配，这是一个可以将多行进行合并的插件，而且可以使用what指定将匹配到的行与前面的行合并还是和后面的行合并</li></ul><p>multiline（匹配多行输入官方解释）：<a href="https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/logstash/current/plugins-codecs-multiline.html</a></p><h3 id="这里演示收集ES机器上的日志-ES程序的运行是要求部署JAVA环境的，射门生成的日志格式也是java格式类型-但是日志格式的开头都是以-开头"><a href="#这里演示收集ES机器上的日志-ES程序的运行是要求部署JAVA环境的，射门生成的日志格式也是java格式类型-但是日志格式的开头都是以-开头" class="headerlink" title="这里演示收集ES机器上的日志(ES程序的运行是要求部署JAVA环境的，射门生成的日志格式也是java格式类型,但是日志格式的开头都是以[开头)"></a>这里演示收集ES机器上的日志(ES程序的运行是要求部署JAVA环境的，射门生成的日志格式也是java格式类型,但是日志格式的开头都是以[开头)</h3><p>1: ES主机上安装收集日志的logstash程序<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># ls</span></span><br><span class="line">logstash-5.6.13.rpm </span><br><span class="line">~]<span class="comment"># rpm -ivh logstash-5.6.13.rpm</span></span><br></pre></td></tr></table></figure></p><h3 id="收集ES日志语法测试"><a href="#收集ES日志语法测试" class="headerlink" title="收集ES日志语法测试"></a>收集ES日志语法测试</h3><p>2：配置ES主机上用来收集日志的logstash程序的配置文件<br>解释<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cat /etc/logstash/conf.d/java.conf</span></span><br><span class="line">input &#123;</span><br><span class="line">        stdin &#123;</span><br><span class="line">        codec =&gt; multiline &#123;</span><br><span class="line">        pattern =&gt; <span class="string">"^\["</span> <span class="comment">#当遇到[开头的行时候将多行进行合并</span></span><br><span class="line">        negate =&gt; <span class="literal">true</span>  <span class="comment">#true为匹配成功进行操作，false为不成功进行操作</span></span><br><span class="line">        what =&gt; <span class="string">"previous"</span>  <span class="comment">#与上面的行合并，如果是下面的行合并就是next</span></span><br><span class="line">        &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line">filter &#123; <span class="comment">#日志过滤，如果所有的日志都过滤就写这里，如果只针对某一个过滤就写在input里面的日志输入里面</span></span><br><span class="line">&#125;</span><br><span class="line">output &#123;</span><br><span class="line">        stdout &#123;</span><br><span class="line">        codec =&gt; rubydebug</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure></p><p>配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cat /etc/logstash/conf.d/es.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">      stdin &#123;</span><br><span class="line">      codec =&gt; multiline &#123;</span><br><span class="line">      pattern =&gt; <span class="string">"^\["</span></span><br><span class="line">      negate =&gt; <span class="literal">true</span></span><br><span class="line">      what =&gt; <span class="string">"previous"</span></span><br><span class="line">      &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter &#123; </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">      stdout &#123;</span><br><span class="line">      codec =&gt; rubydebug</span><br><span class="line">&#125;&#125;</span><br></pre></td></tr></table></figure></p><p>2：检测配置文件的语法格式并启动<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/es.conf -t</span></span><br><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/es.conf</span></span><br></pre></td></tr></table></figure></p><p>3：日志输入输出测试<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/es.conf </span></span><br><span class="line">WARNING: Could not find logstash.yml <span class="built_in">which</span> is typically located <span class="keyword">in</span> <span class="variable">$LS_HOME</span>/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config <span class="built_in">which</span> logs errors to the console</span><br><span class="line">The stdin plugin is now waiting <span class="keyword">for</span> input:</span><br><span class="line">1111</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">1122432</span><br><span class="line">4324324324</span><br><span class="line">234234</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[v1</span><br><span class="line">&#123;</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"es1.com"</span>,</span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; 2019-02-20T12:54:38.873Z,</span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"1111\n1122432\n4324324324\n234234"</span>,</span><br><span class="line">          <span class="string">"tags"</span> =&gt; [</span><br><span class="line">        [0] <span class="string">"multiline"</span></span><br><span class="line">    ]</span><br><span class="line">&#125;</span><br><span class="line">[123</span><br><span class="line">&#123;</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,</span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"es1.com"</span>,</span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; 2019-02-20T12:54:42.617Z,</span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"[v1"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><h3 id="搜集ES日志实战"><a href="#搜集ES日志实战" class="headerlink" title="搜集ES日志实战"></a>搜集ES日志实战</h3><p>1：logstash配置文件标准输出至文件中</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">[root@linux-host1 ~]<span class="comment"># vim /etc/logstash/conf.d/java.conf</span></span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/data/eslogs/ES.log"</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"javalog"</span></span><br><span class="line">    start_position =&gt; <span class="string">"beginning"</span></span><br><span class="line">    codec =&gt; multiline &#123;</span><br><span class="line">    pattern =&gt; <span class="string">"^\["</span></span><br><span class="line">    negate =&gt; <span class="literal">true</span></span><br><span class="line">    what =&gt; <span class="string">"previous"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"javalog"</span> &#123;</span><br><span class="line">  stdout &#123;</span><br><span class="line">      codec =&gt; rubydebug</span><br><span class="line">    &#125;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt;  <span class="string">"/tmp/m.txt"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>2:语法验证：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-host1 ~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/java.conf  -t</span></span><br></pre></td></tr></table></figure></p><p>3：将输出改为elasticsearch和本地的一个文件中：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">更改后的内容如下：</span><br><span class="line">[root@linux-host1 ~]<span class="comment"># cat /etc/logstash/conf.d/java.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/data/eslogs/ES.log"</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"javalog"</span></span><br><span class="line">    start_position =&gt; <span class="string">"beginning"</span></span><br><span class="line">    codec =&gt; multiline &#123;</span><br><span class="line">    pattern =&gt; <span class="string">"^\["</span></span><br><span class="line">    negate =&gt; <span class="literal">true</span></span><br><span class="line">    what =&gt; <span class="string">"previous"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"javalog"</span> &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/tmp/java.txt"</span></span><br><span class="line">  &#125;</span><br><span class="line">  elasticsearch &#123;</span><br><span class="line">    hosts =&gt;  [<span class="string">"192.168.15.11:9200"</span>]</span><br><span class="line">    index =&gt; <span class="string">"javalog-1511-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">[root@linux-host1 ~]<span class="comment"># systemctl  restart logstash</span></span><br></pre></td></tr></table></figure></p><p>4:然后重启一下elasticsearch服务，目前是为了生成新的日志，以验证logstash能否自动收集新生成的日志。<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-host1 ~]<span class="comment"># systemctl  restart elasticsearch</span></span><br></pre></td></tr></table></figure></p><p>5：kibana界面添加javalog-1511索引：<br><img src="/2019/02/20/ELK之Logstash收集本机ES服务json类型日志/1.png" alt=""></p><p>6：模拟生成数据查看kibana界面查看数据：<br><img src="/2019/02/20/ELK之Logstash收集本机ES服务json类型日志/2.png" alt=""></p><p>7：关于sincedb：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-host1~]<span class="comment"># cat /var/lib/logstash/plugins/inputs/file/.sincedb_1ced15cfacdbb0380466be84d620085a</span></span><br><span class="line">134219868 0 2064 29465 <span class="comment">#记录了收集文件的inode信息</span></span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ELK之Logstash收集本机ES服务json类型日志&quot;&gt;&lt;a href=&quot;#ELK之Logstash收集本机ES服务json类型日志&quot; class=&quot;headerlink&quot; title=&quot;ELK之Logstash收集本机ES服务json类型日志&quot;&gt;&lt;/a&gt;ELK之Logstash收集本机ES服务json类型日志&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/ELK之Logstash收集本机ES服务json类型日志/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>mysql之存储引擎和服务器配置</title>
    <link href="https://daizhe.net.cn/2019/02/20/mysql%E4%B9%8B%E5%AD%98%E5%82%A8%E5%BC%95%E6%93%8E%E5%92%8C%E6%9C%8D%E5%8A%A1%E5%99%A8%E9%85%8D%E7%BD%AE/"/>
    <id>https://daizhe.net.cn/2019/02/20/mysql之存储引擎和服务器配置/</id>
    <published>2019-02-20T07:08:47.059Z</published>
    <updated>2019-02-20T07:17:57.629Z</updated>
    
    <content type="html"><![CDATA[<h1 id="mysql之存储引擎和服务器配置"><a href="#mysql之存储引擎和服务器配置" class="headerlink" title="mysql之存储引擎和服务器配置"></a>mysql之存储引擎和服务器配置</h1><p><img src="/2019/02/20/mysql之存储引擎和服务器配置/标题.gif" alt=""><br><a id="more"></a></p><p><img src="/2019/02/20/mysql之存储引擎和服务器配置/1.png" alt=""></p><p>存储引擎：如何去管理数据库的数据文件<br><img src="/2019/02/20/mysql之存储引擎和服务器配置/2.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">查看当前数据库的存储引擎</span><br><span class="line">MariaDB [(none)]&gt; show engines;</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| Engine             | Support | Comment                                                                    | Transactions | XA   | Savepoints |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">| MEMORY             | YES     | Hash based, stored <span class="keyword">in</span> memory, useful <span class="keyword">for</span> temporary tables                  | NO           | NO   | NO         |</span><br><span class="line">| MRG_MYISAM         | YES     | Collection of identical MyISAM tables                                      | NO           | NO   | NO         |</span><br><span class="line">| CSV                | YES     | CSV storage engine                                                         | NO           | NO   | NO         |</span><br><span class="line">| BLACKHOLE          | YES     | /dev/null storage engine (anything you write to it disappears)             | NO           | NO   | NO         |</span><br><span class="line">| MyISAM             | YES     | MyISAM storage engine                                                      | NO           | NO   | NO         |</span><br><span class="line">| InnoDB             | DEFAULT | Percona-XtraDB, Supports transactions, row-level locking, and foreign keys | YES          | YES  | YES        |</span><br><span class="line">| ARCHIVE            | YES     | Archive storage engine                                                     | NO           | NO   | NO         |</span><br><span class="line">| FEDERATED          | YES     | FederatedX pluggable storage engine                                        | YES          | NO   | YES        |</span><br><span class="line">| PERFORMANCE_SCHEMA | YES     | Performance Schema                                                         | NO           | NO   | NO         |</span><br><span class="line">| Aria               | YES     | Crash-safe tables with MyISAM heritage                                     | NO           | NO   | NO         |</span><br><span class="line">+--------------------+---------+----------------------------------------------------------------------------+--------------+------+------------+</span><br><span class="line">10 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="存储引擎"><a href="#存储引擎" class="headerlink" title="存储引擎"></a>存储引擎</h2><p><code>MyISAM引擎特点：</code><br>不支持事务<br>表级锁定<br>读写相互阻塞，写入不能读，读时不能写<br>只缓存索引<br>不支持外键约束<br>不支持聚簇索引<br>读取数据较快，占用资源较少<br>不支持MVCC（多版本并发控制机制）高并发<br>崩溃恢复性较差<br>MySQL5.5.5前默认的数据库引擎  </p><p>MyISAM存储引擎适用场景<br>&ensp;&ensp;只读（或者写较少）、表较小（可以接受长时间进行修复操作）<br>&ensp;&ensp;MyISAM引擎文件<br>&ensp;&ensp;tbl_name.frm 表格式定义<br>&ensp;&ensp;tbl_name.MYD 数据文件<br>&ensp;&ensp;tbl_name.MYI 索引文件   </p><p><code>InnoDB引擎特点</code><br>行级锁<br>支持事务，适合处理大量短期事务<br>读写阻塞与事务隔离级别相关<br>可缓存数据和索引<br>支持聚簇索引<br>崩溃恢复性更好<br>支持MVCC高并发<br>从MySQL5.5后支持全文索引<br>从MySQL5.5.5开始为默认的数据库引擎   </p><p>InnoDB数据库文件<br>所有InnoDB表的数据和索引放置于同一个表空间中<br>&ensp;&ensp;表空间文件：datadir定义的目录下<br>&ensp;&ensp;数据文件：ibddata1, ibddata2, …<br>每个表单独使用一个表空间存储表的数据和索引<br>&ensp;&ensp;启用：innodb_file_per_table=ON<br>&ensp;&ensp;参看：<a href="https://mariadb.com/kb/en/library/xtradbinnodb-serversystem-variables/#innodb_file_per_table" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/xtradbinnodb-serversystem-variables/#innodb_file_per_table</a>   ON (&gt;= MariaDB 5.5)<br>两类文件放在数据库独立目录中<br>&ensp;&ensp;数据文件(存储数据和索引)：tb_name.ibd<br>&ensp;&ensp;表格式定义：tb_name.frm   </p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">如果想让老版本的数据库创建的库以及表支持innodb搜索引擎需要编辑配置文件中添加</span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">default-storage-engine=innodb</span><br><span class="line"></span><br><span class="line">删除hellodb这个数据库</span><br><span class="line">mysql -e <span class="string">'drop database hellodb'</span></span><br></pre></td></tr></table></figure><p><code>其它存储引擎</code><br>Performance_Schema：Performance_Schema数据库使用<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; use information_schema</span><br><span class="line">Reading table information <span class="keyword">for</span> completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MariaDB [information_schema]&gt; show tables;(这些表都是基于此搜索引擎的)</span><br><span class="line">+---------------------------------------+</span><br><span class="line">| Tables_in_information_schema          |</span><br><span class="line">+---------------------------------------+</span><br><span class="line">| CHARACTER_SETS                        |</span><br><span class="line">| CLIENT_STATISTICS                     |</span><br><span class="line">| COLLATIONS                            |</span><br><span class="line">| COLLATION_CHARACTER_SET_APPLICABILITY |</span><br><span class="line">| COLUMNS                               |</span><br><span class="line">| COLUMN_PRIVILEGES                     |</span><br><span class="line">| ENGINES                               |</span><br><span class="line">| EVENTS                                |</span><br><span class="line">| FILES                                 |</span><br><span class="line">| GLOBAL_STATUS                         |</span><br><span class="line">| GLOBAL_VARIABLES                      |</span><br><span class="line">| INDEX_STATISTICS                      |</span><br><span class="line">| KEY_CACHES                            |</span><br><span class="line">| KEY_COLUMN_USAGE                      |</span><br><span class="line">| PARAMETERS                            |</span><br><span class="line">| PARTITIONS                            |</span><br><span class="line">| PLUGINS                               |</span><br><span class="line">| PROCESSLIST                           |</span><br><span class="line">| PROFILING                             |</span><br><span class="line">| REFERENTIAL_CONSTRAINTS               |</span><br><span class="line">| ROUTINES                              |</span><br><span class="line">| SCHEMATA                              |</span><br><span class="line">| SCHEMA_PRIVILEGES                     |</span><br><span class="line">| SESSION_STATUS                        |</span><br><span class="line">| SESSION_VARIABLES                     |</span><br><span class="line">| STATISTICS                            |</span><br><span class="line">| TABLES                                |</span><br><span class="line">| TABLESPACES                           |</span><br><span class="line">| TABLE_CONSTRAINTS                     |</span><br><span class="line">| TABLE_PRIVILEGES                      |</span><br><span class="line">| TABLE_STATISTICS                      |</span><br><span class="line">| TRIGGERS                              |</span><br><span class="line">| USER_PRIVILEGES                       |</span><br><span class="line">| USER_STATISTICS                       |</span><br><span class="line">| VIEWS                                 |</span><br><span class="line">| INNODB_CMPMEM_RESET                   |</span><br><span class="line">| INNODB_RSEG                           |</span><br><span class="line">| INNODB_UNDO_LOGS                      |</span><br><span class="line">| INNODB_CMPMEM                         |</span><br><span class="line">| INNODB_SYS_TABLESTATS                 |</span><br><span class="line">| INNODB_LOCK_WAITS                     |</span><br><span class="line">| INNODB_INDEX_STATS                    |</span><br><span class="line">| INNODB_CMP                            |</span><br><span class="line">| INNODB_CMP_RESET                      |</span><br><span class="line">| INNODB_CHANGED_PAGES                  |</span><br><span class="line">| INNODB_BUFFER_POOL_PAGES              |</span><br><span class="line">| INNODB_TRX                            |</span><br><span class="line">| INNODB_BUFFER_POOL_PAGES_INDEX        |</span><br><span class="line">| INNODB_LOCKS                          |</span><br><span class="line">| INNODB_BUFFER_POOL_PAGES_BLOB         |</span><br><span class="line">| INNODB_SYS_TABLES                     |</span><br><span class="line">| INNODB_SYS_FIELDS                     |</span><br><span class="line">| INNODB_SYS_COLUMNS                    |</span><br><span class="line">| INNODB_SYS_STATS                      |</span><br><span class="line">| INNODB_SYS_FOREIGN                    |</span><br><span class="line">| INNODB_SYS_INDEXES                    |</span><br><span class="line">| XTRADB_ADMIN_COMMAND                  |</span><br><span class="line">| INNODB_TABLE_STATS                    |</span><br><span class="line">| INNODB_SYS_FOREIGN_COLS               |</span><br><span class="line">| INNODB_BUFFER_PAGE_LRU                |</span><br><span class="line">| INNODB_BUFFER_POOL_STATS              |</span><br><span class="line">| INNODB_BUFFER_PAGE                    |</span><br><span class="line">+---------------------------------------+</span><br><span class="line">62 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [information_schema]&gt; show table status from performance_schema;</span><br><span class="line">+----------------------------------------------+--------------------+---------+------------+-------+----------------+-------------+-----------------+--------------+-----------+----------------+-------------+-------------+------------+-----------------+----------+----------------+---------+</span><br><span class="line">| Name                                         | Engine             | Version | Row_format | Rows  | Avg_row_length | Data_length | Max_data_length | Index_length | Data_free | Auto_increment | Create_time | Update_time | Check_time | Collation       | Checksum | Create_options | Comment |</span><br><span class="line">+----------------------------------------------+--------------------+---------+------------+-------+----------------+-------------+-----------------+--------------+-----------+----------------+-------------+-------------+------------+-----------------+----------+----------------+---------+</span><br><span class="line">| cond_instances                               | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| events_waits_current                         | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| events_waits_history                         | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| events_waits_history_long                    | PERFORMANCE_SCHEMA |      10 | Dynamic    | 10000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| events_waits_summary_by_instance             | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| events_waits_summary_by_thread_by_event_name | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| events_waits_summary_global_by_event_name    | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| file_instances                               | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| file_summary_by_event_name                   | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| file_summary_by_instance                     | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| mutex_instances                              | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| performance_timers                           | PERFORMANCE_SCHEMA |      10 | Fixed      |     5 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| rwlock_instances                             | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| setup_consumers                              | PERFORMANCE_SCHEMA |      10 | Dynamic    |     8 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| setup_instruments                            | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| setup_timers                                 | PERFORMANCE_SCHEMA |      10 | Dynamic    |     1 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">| threads                                      | PERFORMANCE_SCHEMA |      10 | Dynamic    |  1000 |              0 |           0 |               0 |            0 |         0 |           NULL | NULL        | NULL        | NULL       | utf8_general_ci |     NULL |                |         |</span><br><span class="line">+----------------------------------------------+--------------------+---------+------------+-------+----------------+-------------+-----------------+--------------+-----------+----------------+-------------+-------------+------------+-----------------+----------+----------------+---------+</span><br><span class="line">17 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">该数据库是存储性能相关</span><br></pre></td></tr></table></figure></p><p>Memory ：将所有数据存储在RAM（内存）中，以便在需要快速查找参考和其他类似 数据的环境中进行快速访问。适用存放临时数据。引擎以前被称为HEAP引擎  </p><p>MRG_MyISAM：使MySQL DBA或开发人员能够对一系列相同的  MyISAM表 进行逻辑分组，并将它们作为一个对象引用。适用于VLDB(Very Large Data Base)环境，如数据仓库   </p><p>Archive ：为存储和检索大量很少参考的存档或安全审核信息，只支持 SELECT和INSERT操作；支持行级锁和专用缓存区</p><p>Federated联合：用于访问其它远程MySQL服务器一个代理，它通过创建一 个到远程MySQL服务器的客户端连接，并将查询传输到远程服务器执行，而 后完成数据存取，提供链接单独MySQL服务器的能力，以便从多个物理服务 器创建一个逻辑数据库。非常适合分布式或数据集市环境 </p><p>BDB：可替代InnoDB的事务引擎，支持COMMIT、ROLLBACK和其他事务特性<br>Cluster/NDB：MySQL的簇式数据库引擎，尤其适合于具有高性能查找要求的 应用程序，这类查找需求还要求具有最高的正常工作时间和可用性  </p><p>CSV：CSV存储引擎使用逗号分隔值格式将数据存储在文本文件中。可以使用 CSV引擎以CSV格式导入和导出其他软件和应用程序之间的数据交换  </p><p>BLACKHOLE ：黑洞存储引擎接受但不存储数据，检索总是返回一个空集。该功 能可用于分布式数据库设计，数据自动复制，但不是本地存储   </p><p>example：“stub”引擎，它什么都不做。可以使用此引擎创建表，但不能将数 据存储在其中或从中检索。目的是作为例子来说明如何开始编写新的存储引擎   </p><p>MariaDB支持的其它存储引擎：<br>OQGraph<br>SphinxSE<br>TokuDB<br>Cassandra<br>CONNECT<br>SQUENCE   </p><p><code>查看mysql支持的存储引擎</code><br>show engines;<br><code>查看当前默认的存储引擎</code><br>show variables like ‘%storage_engine%’;<br><code>设置默认的存储引擎</code><br>vim /etc/my.conf  [mysqld]<br>default_storage_engine= InnoDB<br><code>查看库中所有表使用的存储引擎</code><br>show table status from db_name;<br><code>查看库中指定表的存储引擎</code><br>show table status like  ‘ tb_name ‘;<br>show create table tb_name;<br><code>设置表的存储引擎：</code><br>CREATE TABLE tb_name(… ) ENGINE=InnoDB;<br>ALTER TABLE tb_name ENGINE=InnoDB;   </p><h2 id="MySQL中的系统数据库"><a href="#MySQL中的系统数据库" class="headerlink" title="MySQL中的系统数据库"></a>MySQL中的系统数据库</h2><p><code>mysql数据库</code><br>是mysql的核心数据库，类似于Sql  Server中的master库，主要负责存储数据 库的用户、权限设置、关键字等mysql自己需要使用的控制和管理信息<br><code>performance_schema数据库</code><br>MySQL 5.5开始新增的数据库，主要用于收集数据库服务器性能参数,库里表的 存储引擎均为PERFORMANCE_SCHEMA，用户不能创建存储引擎为 PERFORMANCE_SCHEMA的表<br><code>information_schema数据库</code><br>MySQL 5.0之后产生的，一个虚拟数据库，物理上并不存在 information_schema数据库类似与“数据字典”，提供了访问数据库元数据的 方式，即数据的数据。比如数据库名或表名，列类型，访问权限（更加细化的 访问方式） </p><h2 id="服务器配置"><a href="#服务器配置" class="headerlink" title="服务器配置"></a><code>服务器配置</code></h2><p><code>mysqld选项cmd-line和option file(可以写在配置文件中即服务器选项)</code>  </p><p><code>服务器系统变量 system var（服务器在内存中存放的状态，登陆服务器之后，show variables like &#39;变量名&#39; 可以看到的）</code>  </p><p><code>服务器状态变量  status var（只读性的变量，当前数据库的状态）</code><br>&ensp;&ensp;<a href="https://dev.mysql.com/doc/refman/5.7/en/mysqld-optiontables.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/mysqld-optiontables.html</a><br>&ensp;&ensp;<a href="https://mariadb" target="_blank" rel="noopener">https://mariadb</a>. com/kb/en/library/full-list-of-mariadb-optionssystem-and-status-variables/<br>注意：其中有些参数支持运行时修改，会立即生效；有些参数不支持，且 只能通过修改配置文件，并重启服务器程序生效；有些参数作用域是全局 的，且不可改变；有些可以为每个用户提供单独（会话）的设置  </p><p><code>获取mysqld的可用选项列表：服务器选项</code><br>&ensp;&ensp;<code>mysqld --help --verbose</code><br>&ensp;&ensp;<code>mysqld --print-defaults  获取默认设置</code> </p><h2 id="服务器配置-1"><a href="#服务器配置-1" class="headerlink" title="服务器配置"></a>服务器配置</h2><p><code>服务器系统变量：分全局和会话两种</code><br><code>服务器状态变量：分全局和会话两种</code><br>获取运行中的mysql进程使用各服务器参数及其值<br>&ensp;&ensp;mysql&gt; SHOW GLOBAL VARIABLES;<br>&ensp;&ensp;mysql&gt; SHOW [SESSION] VARIABLES;<br>设置服务器选项方法：<br>&ensp;&ensp;在命令行中设置<br>&ensp;&ensp;&ensp;&ensp;shell&gt; ./mysqld_safe –skip-name-resolve=1<br>&ensp;&ensp;在配置文件my.cnf中设置<br>&ensp;&ensp;&ensp;&ensp;skip_name_resolve=1   </p><h2 id="服务器端设置"><a href="#服务器端设置" class="headerlink" title="服务器端设置"></a>服务器端设置</h2><p><code>服务器系统变量：分全局和会话两种</code><br>获取系统变量：<br>&ensp;&ensp;mysql&gt; show global variables;  显示所有的全局变量<br>&ensp;&ensp;mysql&gt; show [session] variables;  显示所有的会话变量<br>&ensp;&ensp;mysql&gt; select @@varriables;  显示系统变量</p><p>修改服务器变量的值：<br>&ensp;&ensp;mysql&gt; help SET<br>修改全局变量：仅对修改后新创建的会话有效；对已经建立的会话无效<br>&ensp;&ensp;mysql&gt; SET GLOBAL system_var_name=value;<br>&ensp;&ensp;mysql&gt; SET @@global.system_var_name=value;<br>修改会话变量：<br>&ensp;&ensp;mysql&gt; SET [SESSION] system_var_name=value;<br>&ensp;&ensp;mysql&gt; SET @@[session.]system_var_name=value;<br>状态变量（只读）：用于保存mysqld运行中的统计数据的变量，不可更改<br>&ensp;&ensp;mysql&gt; SHOW GLOBAL STATUS;<br>&ensp;&ensp;mysql&gt; SHOW [SESSION] STATUS;   </p><h2 id="服务器变量SQL-MODE"><a href="#服务器变量SQL-MODE" class="headerlink" title="服务器变量SQL_MODE"></a><code>服务器变量SQL_MODE</code></h2><p>SQL_MODE：对其设置可以完成一些约束检查的工作,可分别进行全局的设置或当前会 话的设置，参看：<a href="https://mariadb.com/kb/en/library/sql-mode/" target="_blank" rel="noopener">https://mariadb.com/kb/en/library/sql-mode/</a><br>常见MODE:<br>&ensp;&ensp;NO_AUTO_CREATE_USER<br>&ensp;&ensp;&ensp;&ensp;禁止GRANT创建密码为空的用户<br>&ensp;&ensp;NO_ZERO_DATE<br>&ensp;&ensp;&ensp;&ensp;在严格模式，不允许使用‘0000-00-00’的时间<br>&ensp;&ensp;ONLY_FULL_GROUP_BY<br>&ensp;&ensp;&ensp;&ensp;对于GROUP BY聚合操作，如果在SELECT中的列，没有在GROUP BY中出现，那么 将认为这个SQL是不合法的<br>&ensp;&ensp;NO_BACKSLASH_ESCAPES<br>&ensp;&ensp;&ensp;&ensp;反斜杠“\”作为普通字符而非转义字符<br>&ensp;&ensp;PIPES_AS_CONCAT<br>&ensp;&ensp;&ensp;&ensp;将”||”视为连接操作符而非“或运算符</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">主要影响对数据库的操作</span><br><span class="line"></span><br><span class="line">查看sql_mode值</span><br><span class="line">MariaDB [hellodb]&gt; show variables like <span class="string">'sql_mode'</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| sql_mode      |       |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">创建一个表，限制输入的name记录的字段的字符长度为3个字符</span><br><span class="line">MariaDB [hellodb]&gt; create table <span class="built_in">test</span> (id int,name char(3));</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; show create table <span class="built_in">test</span>\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">       Table: <span class="built_in">test</span></span><br><span class="line">Create Table: CREATE TABLE `<span class="built_in">test</span>` (</span><br><span class="line">  `id` int(11) DEFAULT NULL,</span><br><span class="line">  `name` char(3) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">添加长字段测试，添加字段未被限制不让添加仅仅是报警</span><br><span class="line">MariaDB [hellodb]&gt; insert <span class="built_in">test</span> value (2,<span class="string">'abcde'</span>);</span><br><span class="line">Query OK, 1 row affected, 1 warning (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看报警信息</span><br><span class="line">MariaDB [hellodb]&gt; show warnings;</span><br><span class="line">+---------+------+-------------------------------------------+</span><br><span class="line">| Level   | Code | Message                                   |</span><br><span class="line">+---------+------+-------------------------------------------+</span><br><span class="line">| Warning | 1265 | Data truncated <span class="keyword">for</span> column <span class="string">'name'</span> at row 1 |</span><br><span class="line">+---------+------+-------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看表中的所有的字段，虽然添加超过限制的字段，但是录入了在限制内的字段，显示的字段为3个所以留下了三个字段</span><br><span class="line">MariaDB [hellodb]&gt; select * from <span class="built_in">test</span>;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | name |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 | abc  |</span><br><span class="line">|    2 | abc  |</span><br><span class="line">+------+------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">修改sql_mode变量</span><br><span class="line">  5.5版本的数据库默认sql_mod的值为空</span><br><span class="line">MariaDB [hellodb]&gt; show variables like <span class="string">'sql_mode'</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| sql_mode      |       |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">修改sql_mode值限制在添加字段的时候的值不能超长，未修改之前只是报警，截取可以限制的长度内的字段则被记录</span><br><span class="line">MariaDB [hellodb]&gt; <span class="built_in">set</span> sql_mode=<span class="string">'traditional'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; show variables like <span class="string">'sql_mode'</span>;</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Variable_name | Value                                                                                                                                                |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| sql_mode      | STRICT_TRANS_TABLES,STRICT_ALL_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,TRADITIONAL,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION |</span><br><span class="line">+---------------+------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">再次添加超长字段测试：直接不是报警了，直接报错</span><br><span class="line">MariaDB [hellodb]&gt; insert <span class="built_in">test</span> value (3,<span class="string">'abcdeddd'</span>);</span><br><span class="line">ERROR 1406 (22001): Data too long <span class="keyword">for</span> column <span class="string">'name'</span> at row 1</span><br><span class="line"></span><br><span class="line">查看添加的记录是否添加进入：未被添加进去</span><br><span class="line">MariaDB [hellodb]&gt; select * from <span class="built_in">test</span>;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | name |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 | abc  |</span><br><span class="line">|    2 | abc  |</span><br><span class="line">+------+------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p>在命令外显示系统自带的变量：数据库的状态信息<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mysql -e 'show status' | grep select </span></span><br><span class="line">Com_insert_select0</span><br><span class="line">Com_replace_select0</span><br><span class="line">Com_select1                  查询的次数</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; use hellodb;</span><br><span class="line">Reading table information <span class="keyword">for</span> completion of table and column names</span><br><span class="line">You can turn off this feature to get a quicker startup with -A</span><br><span class="line"></span><br><span class="line">Database changed</span><br><span class="line">MariaDB [hellodb]&gt; show status like <span class="string">'com_select'</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Com_select    | 2     |</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">再次查询查看是否会增长</span><br><span class="line">MariaDB [hellodb]&gt; select * from <span class="built_in">test</span>;</span><br><span class="line">+------+------+</span><br><span class="line">| id   | name |</span><br><span class="line">+------+------+</span><br><span class="line">|    1 | abc  |</span><br><span class="line">|    2 | abc  |</span><br><span class="line">+------+------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; show status like <span class="string">'com_select'</span>;</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Variable_name | Value |</span><br><span class="line">+---------------+-------+</span><br><span class="line">| Com_select    | 3     |   记录执行查询命令的次数</span><br><span class="line">+---------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line">状态变量不可使用<span class="built_in">set</span>修改</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;mysql之存储引擎和服务器配置&quot;&gt;&lt;a href=&quot;#mysql之存储引擎和服务器配置&quot; class=&quot;headerlink&quot; title=&quot;mysql之存储引擎和服务器配置&quot;&gt;&lt;/a&gt;mysql之存储引擎和服务器配置&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/mysql之存储引擎和服务器配置/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://daizhe.net.cn/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://daizhe.net.cn/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysql之数据库用户和权限管理</title>
    <link href="https://daizhe.net.cn/2019/02/20/mysql%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%BA%93%E7%94%A8%E6%88%B7%E5%92%8C%E6%9D%83%E9%99%90%E7%AE%A1%E7%90%86/"/>
    <id>https://daizhe.net.cn/2019/02/20/mysql之数据库用户和权限管理/</id>
    <published>2019-02-20T07:02:04.976Z</published>
    <updated>2019-02-20T07:17:44.116Z</updated>
    
    <content type="html"><![CDATA[<h1 id="mysql之数据库用户和权限管理"><a href="#mysql之数据库用户和权限管理" class="headerlink" title="mysql之数据库用户和权限管理"></a>mysql之数据库用户和权限管理</h1><p><img src="/2019/02/20/mysql之数据库用户和权限管理/标题.gif" alt=""><br><a id="more"></a></p><h2 id="MySQL用户和权限管理"><a href="#MySQL用户和权限管理" class="headerlink" title="MySQL用户和权限管理"></a>MySQL用户和权限管理</h2><p>元数据数据库：mysql<br>&ensp;&ensp;系统授权表：<br>&ensp;&ensp;db, host, user<br>&ensp;&ensp;columns_priv, tables_priv, procs_priv, proxies_priv<br>用户账号：<br>&ensp;&ensp;‘USERNAME‘@’HOST’  &ensp;&ensp;  用户名@允许从哪台主机登陆<br>&ensp;&ensp;@’HOST’:<br>&ensp;&ensp;主机名<br>&ensp;&ensp;IP地址或Network<br>&ensp;&ensp;通配符： %   _<br>&ensp;&ensp;示例：172.16.%.%   </p><h2 id="用户管理"><a href="#用户管理" class="headerlink" title="用户管理"></a><code>用户管理</code></h2><p><code>创建用户：CREATE USER</code><br>&ensp;&ensp;CREATE USER ‘USERNAME‘@’HOST’ [IDENTIFIED BY ‘password’]；<br>&ensp;&ensp;默认权限：USAGE<br><code>用户重命名：RENAME USER</code><br>&ensp;&ensp;RENAME USER old_user_name TO new_user_name;<br><code>删除用户：</code><br>&ensp;&ensp;DROP USER ‘USERNAME‘@’HOST‘<br>&ensp;&ensp;示例：删除默认的空用户<br>&ensp;&ensp;DROP USER ‘‘@’localhost’;<br><code>修改密码：</code><br>&ensp;&ensp;mysql&gt;SET PASSWORD FOR ‘user‘@’host’ = PASSWORD(‘password’);<br>&ensp;&ensp;mysql&gt;UPDATE mysql.user SET password=PASSWORD(‘password’) WHERE clause; （直接修改表，不会立即生效，配合下面的命令）<br>&ensp;&ensp;&ensp;&ensp;此方法需要执行下面指令才能生效：<br>&ensp;&ensp;&ensp;&ensp;mysql&gt; FLUSH PRIVILEGES;<br>&ensp;&ensp;#mysqladmin -u root -poldpass  password  ‘newpass’<br><code>忘记管理员密码的解决办法：</code><br>&ensp;&ensp;启动mysqld进程时，为其使用如下选项：<br>&ensp;&ensp;&ensp;&ensp;–skip-grant-tables<br>&ensp;&ensp;&ensp;&ensp;–skip-networking   (禁止数据库有网络功能，防止破解口令的同时其他人利用此特性盗取数据)<br>&ensp;&ensp;使用UPDATE命令修改管理员密码<br>&ensp;&ensp;关闭mysqld进程，移除上述两个选项，重启mysqld<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">查看mysql数据库中的用户信息</span><br><span class="line">系统表</span><br><span class="line">MariaDB [mysql]&gt; show tables;</span><br><span class="line">+---------------------------+</span><br><span class="line">| Tables_in_mysql           |</span><br><span class="line">+---------------------------+</span><br><span class="line">| columns_priv              |</span><br><span class="line">| db                        |</span><br><span class="line">| event                     |</span><br><span class="line">| func                      |</span><br><span class="line">| general_log               |</span><br><span class="line">| help_category             |</span><br><span class="line">| help_keyword              |</span><br><span class="line">| help_relation             |</span><br><span class="line">| help_topic                |</span><br><span class="line">| host                      |</span><br><span class="line">| ndb_binlog_index          |</span><br><span class="line">| plugin                    |</span><br><span class="line">| proc                      |</span><br><span class="line">| procs_priv                |</span><br><span class="line">| proxies_priv              |</span><br><span class="line">| servers                   |</span><br><span class="line">| slow_log                  |</span><br><span class="line">| tables_priv               |</span><br><span class="line">| time_zone                 |</span><br><span class="line">| time_zone_leap_second     |</span><br><span class="line">| time_zone_name            |</span><br><span class="line">| time_zone_transition      |</span><br><span class="line">| time_zone_transition_type |</span><br><span class="line">| user                      |</span><br><span class="line">+---------------------------+</span><br><span class="line">24 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line">查询当前数据库服务器中的用户</span><br><span class="line">MariaDB [mysql]&gt; select user,host from user;</span><br><span class="line">+------+-------------+</span><br><span class="line">| user | host        |</span><br><span class="line">+------+-------------+</span><br><span class="line">| root | 127.0.0.1   |</span><br><span class="line">| root | ::1         |</span><br><span class="line">|      | centos7.com |</span><br><span class="line">| root | centos7.com |</span><br><span class="line">|      | localhost   |</span><br><span class="line">| root | localhost   |</span><br><span class="line">+------+-------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><code>创建账号</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line">创建账号，授权允许此用户可以在那台主机上登陆数据库</span><br><span class="line"> 创建<span class="built_in">test</span>这个用户可以在172.18.133. 这个网段的连接此服务器，并且设置口令为centos</span><br><span class="line">MariaDB [mysql]&gt; create user <span class="built_in">test</span>@<span class="string">'172.18.133.%'</span> identified by <span class="string">'centos'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看是否创建</span><br><span class="line">MariaDB [mysql]&gt; select user,host from user;</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | host         |</span><br><span class="line">+------+--------------+</span><br><span class="line">| root | 127.0.0.1    |   系统自带的管理员</span><br><span class="line">| <span class="built_in">test</span> | 172.18.133.% |   </span><br><span class="line">| root | ::1          |   系统自带的管理员</span><br><span class="line">|      | centos7.com  |   匿名账号</span><br><span class="line">| root | centos7.com  |   系统自带的管理员</span><br><span class="line">|      | localhost    |   匿名账号</span><br><span class="line">| root | localhost    |</span><br><span class="line">+------+--------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">使用此账号远程登陆 -h 指定服务器端的ip地址</span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql -utest -pcentos -h172.18.133.162</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 11</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">'\c'</span> to clear the current input statement.</span><br><span class="line">MariaDB [(none)]&gt; </span><br><span class="line"></span><br><span class="line">查看当前连接的用户名：使用user函数查看</span><br><span class="line">MariaDB [(none)]&gt; select user();</span><br><span class="line">+---------------------+</span><br><span class="line">| user()              |</span><br><span class="line">+---------------------+</span><br><span class="line">| <span class="built_in">test</span>@172.18.133.162 |</span><br><span class="line">+---------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">使用create user 创建的账号，登陆上来之后查看当前数据库的数据库仅能看到两个，因为创建的账号没有权限</span><br><span class="line">  使用create user创建好账号登陆</span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">删除用户</span><br><span class="line">  范例为：删除匿名用户</span><br><span class="line">MariaDB [mysql]&gt; select user,host from user;</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | host         |</span><br><span class="line">+------+--------------+</span><br><span class="line">| root | 127.0.0.1    |</span><br><span class="line">| <span class="built_in">test</span> | 172.18.133.% |</span><br><span class="line">| root | ::1          |</span><br><span class="line">|      | centos7.com  |   匿名账号</span><br><span class="line">| root | centos7.com  |</span><br><span class="line">|      | localhost    |   匿名账号</span><br><span class="line">| root | localhost    |</span><br><span class="line">+------+--------------+</span><br><span class="line">7 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">  删除匿名用户：没有用户名就时空，用单引号引起来</span><br><span class="line">MariaDB [mysql]&gt; drop user <span class="string">''</span>@centos7.com</span><br><span class="line">    -&gt; ;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [mysql]&gt; drop user <span class="string">''</span>@localhost;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">再次查询当前数据库的账号</span><br><span class="line">MariaDB [mysql]&gt; select user,host from user;</span><br><span class="line">+------+--------------+</span><br><span class="line">| user | host         |</span><br><span class="line">+------+--------------+</span><br><span class="line">| root | 127.0.0.1    |</span><br><span class="line">| <span class="built_in">test</span> | 172.18.133.% |</span><br><span class="line">| root | ::1          |</span><br><span class="line">| root | centos7.com  |</span><br><span class="line">| root | localhost    |</span><br><span class="line">+------+--------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><code>修改用户口令，设置密码</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br></pre></td><td class="code"><pre><span class="line">修改用户口令 ： password函数生成加密口令</span><br><span class="line">  查看当前的账号信息以及密码</span><br><span class="line">MariaDB [mysql]&gt; select user,host,password from user;</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">| user | host         | password                                  |</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">| root | localhost    |                                           |</span><br><span class="line">| root | centos7.com  |                                           |</span><br><span class="line">| root | 127.0.0.1    |                                           |</span><br><span class="line">| root | ::1          |                                           |</span><br><span class="line">| <span class="built_in">test</span> | 172.18.133.% | *128977E278358FF80A246B5046F51043A2B1FCED |</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">  使用password 可以将你要设置的字符串设置加密</span><br><span class="line">MariaDB [mysql]&gt; select password(<span class="string">'dai'</span>);</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| password(<span class="string">'dai'</span>)                           |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">| *CE886B6974FB59FB743ADF5DB78FDA6B25649F5C |</span><br><span class="line">+-------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">修改用户的口令：对<span class="built_in">test</span>用户修改口令，将原有的centos口令修改为daizhe</span><br><span class="line">MariaDB [mysql]&gt; <span class="built_in">set</span> password <span class="keyword">for</span> <span class="built_in">test</span>@<span class="string">'172.18.133.%'</span>=password(<span class="string">'daizhe'</span>);</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [mysql]&gt; select user,host,password from user;</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">| user | host         | password                                  |</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">| root | localhost    |                                           |</span><br><span class="line">| root | centos7.com  |                                           |</span><br><span class="line">| root | 127.0.0.1    |                                           |</span><br><span class="line">| root | ::1          |                                           |</span><br><span class="line">| <span class="built_in">test</span> | 172.18.133.% | *0E04F27C8B21547FD069D6E8519AE49B7ECE8E94 |</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">使用新口令登陆</span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql -utest -pdaizhe -h172.18.133.162</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 6</span><br><span class="line"></span><br><span class="line">将数据库系统自带的管理员用户添加密码：设置密码为daizhe （mysql数据库的缺点就是设置相同口令的密码会看的出来，因为没有加盐 sort）</span><br><span class="line">MariaDB [mysql]&gt; update user <span class="built_in">set</span> password=password(<span class="string">'daizhe'</span>) <span class="built_in">where</span> user=<span class="string">'root'</span>;</span><br><span class="line">Query OK, 4 rows affected (0.00 sec)</span><br><span class="line">Rows matched: 4  Changed: 4  Warnings: 0</span><br><span class="line">MariaDB [mysql]&gt; select user,host,password from user;</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">| user | host         | password                                  |</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">| root | localhost    | *0E04F27C8B21547FD069D6E8519AE49B7ECE8E94 |</span><br><span class="line">| root | centos7.com  | *0E04F27C8B21547FD069D6E8519AE49B7ECE8E94 |</span><br><span class="line">| root | 127.0.0.1    | *0E04F27C8B21547FD069D6E8519AE49B7ECE8E94 |</span><br><span class="line">| root | ::1          | *0E04F27C8B21547FD069D6E8519AE49B7ECE8E94 |</span><br><span class="line">| <span class="built_in">test</span> | 172.18.133.% | *0E04F27C8B21547FD069D6E8519AE49B7ECE8E94 |</span><br><span class="line">+------+--------------+-------------------------------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">  此时不会立即生效:执行生效命令</span><br><span class="line">MariaDB [mysql]&gt; flush privileges;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">测试密码是否已经被更改</span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql </span></span><br><span class="line">ERROR 1045 (28000): Access denied <span class="keyword">for</span> user <span class="string">'root'</span>@<span class="string">'localhost'</span> (using password: NO)</span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql -pdaizhe</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 9</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br></pre></td></tr></table></figure></p><p><code>范例：假设root口令忘记了</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">  如果是测试环境，可以最直接的方法，删除数据库的数据目录，因为数据库的所有数据都存放在数据库的数据目录中</span><br><span class="line">rm -rf /var/lib/mysql/*</span><br><span class="line">systemctl restart mariadb</span><br><span class="line"></span><br><span class="line">破解root密码并且保存数据库的所有数据</span><br><span class="line">编辑数据的配置文件（使得数据库登陆时忽略授权表）</span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">skip-grant-tables</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart mariadb</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 2</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br></pre></td></tr></table></figure></p><h2 id="MySQL权限管理"><a href="#MySQL权限管理" class="headerlink" title="MySQL权限管理"></a><code>MySQL权限管理</code></h2><p><code>权限类别：</code><br>&ensp;&ensp;管理类<br>&ensp;&ensp;程序类<br>&ensp;&ensp;数据库级别<br>&ensp;&ensp;表级别<br>&ensp;&ensp;字段级别  </p><h2 id="MySQL用户和权限管理-1"><a href="#MySQL用户和权限管理-1" class="headerlink" title="MySQL用户和权限管理"></a><code>MySQL用户和权限管理</code></h2><p><code>管理类：</code><br>&ensp;&ensp;CREATE TEMPORARY TABLES<br>&ensp;&ensp;CREATE USER<br>&ensp;&ensp;FILE<br>&ensp;&ensp;SUPER<br>&ensp;&ensp;SHOW DATABASES<br>&ensp;&ensp;RELOAD<br>&ensp;&ensp;SHUTDOWN<br>&ensp;&ensp;REPLICATION SLAVE<br>&ensp;&ensp;REPLICATION CLIENT<br>&ensp;&ensp;LOCK TABLES<br>&ensp;&ensp;PROCESS<br><code>程序类：</code> FUNCTION、PROCEDURE、TRIGGER    函数、存储过程、触发器<br>&ensp;&ensp;CREATE<br>&ensp;&ensp;ALTER<br>&ensp;&ensp;DROP<br>&ensp;&ensp;EXCUTE<br><code>库和表级别：</code>DATABASE、TABLE    数据库、表<br>&ensp;&ensp;ALTER<br>&ensp;&ensp;CREATE<br>&ensp;&ensp;CREATE VIEW<br>&ensp;&ensp;DROP<br>&ensp;&ensp;INDEX<br>&ensp;&ensp;SHOW VIEW<br>&ensp;&ensp;GRANT OPTION：能将自己获得的权限转赠给其他用户  （让权限具有传递性）<br><code>数据操作：</code>   增删改查<br>&ensp;&ensp;SELECT<br>&ensp;&ensp;INSERT<br>&ensp;&ensp;DELETE<br>&ensp;&ensp;UPDATE<br><code>字段级别：</code>    精确到字段的增删改查<br>&ensp;&ensp;SELECT(col1,col2,…)<br>&ensp;&ensp;UPDATE(col1,col2,…)<br>&ensp;&ensp;INSERT(col1,col2,…)<br><code>所有权限：</code>ALL PRIVILEGES 或 ALL  </p><h2 id="授权"><a href="#授权" class="headerlink" title="授权"></a><code>授权</code></h2><p><code>授权</code><br>参考：<a href="https://dev.mysql.com/doc/refman/5.7/en/grant.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.7/en/grant.html</a><br>&ensp;&ensp;GRANT priv_type [(column_list)],… ON [object_type] priv_level TO ‘user‘@’host’ [IDENTIFIED BY ‘password’] [WITH GRANT OPTION];<br>&ensp;&ensp;priv_type: ALL [PRIVILEGES]<br>&ensp;&ensp;object_type:TABLE | FUNCTION | PROCEDURE<br>&ensp;&ensp;priv_level:  <em>(所有库)  | </em>.<em>  | db_name.</em>  | db_name.tbl_name  | tbl_name(当前库 的表)  | db_name.routine_name(指定库的函数,存储过程,触发器)<br>with_option: GRANT OPTION<br>&ensp;&ensp;| MAX_QUERIES_PER_HOUR count<br>&ensp;&ensp;| MAX_UPDATES_PER_HOUR count<br>&ensp;&ensp;| MAX_CONNECTIONS_PER_HOUR count<br>&ensp;&ensp;| MAX_USER_CONNECTIONS count<br>示例：GRANT SELECT (col1), INSERT (col1,col2) ON mydb.mytbl TO ‘someuser‘@’somehost‘;   </p><p><code>回收授权</code><br>回收授权：REVOKE   priv_type [(column_list)]  [, priv_type [(column_list)]] …    ON [object_type] priv_level  FROM user [, user] …<br>示例：  REVOKE DELETE ON testdb.* FROM ‘testuser‘@‘172.16.0.%’; 查<br>看指定用户获得的授权：<br>&ensp;&ensp;Help SHOW GRANTS<br>&ensp;&ensp;SHOW GRANTS FOR ‘user‘@’host’;<br>&ensp;&ensp;SHOW GRANTS FOR CURRENT_USER[()];<br>注意：MariaDB服务进程启动时会读取mysql库中所有授权表至内存<br>&ensp;&ensp;(1) GRANT或REVOKE等执行权限操作会保存于系统表中，MariaDB的服务进 程通常会自动重读授权表，使之生效<br>&ensp;&ensp;(2) 对于不能够或不能及时重读授权表的命令，可手动让MariaDB的服务进程 重读授权表：mysql&gt; FLUSH PRIVILEGES;   </p><p><code>范例：实现用户的权限授权</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">创建一个账号</span><br><span class="line">MariaDB [mysql]&gt; create user daizhe@<span class="string">'172.18.133.%'</span> identified by <span class="string">'daizhe'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">授权创建的daizhe 这个账号权限</span><br><span class="line"> 多这个账号授权所有权限，在hollodb中的所有表</span><br><span class="line">MariaDB [mysql]&gt; grant all on hellodb.* to daizhe@<span class="string">'172.18.133.%'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">使用此账号，远程连接查看是否已经授权</span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql -udaizhe -pdaizhe -h172.18.133.162</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 9</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br><span class="line">Copyright (c) 2000, 2018, Oracle, MariaDB Corporation Ab and others.</span><br><span class="line">Type <span class="string">'help;'</span> or <span class="string">'\h'</span> <span class="keyword">for</span> <span class="built_in">help</span>. Type <span class="string">'\c'</span> to clear the current input statement.</span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| hellodb            |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">使用grant 创建用户、授权、设置密码</span><br><span class="line">  创建test2这个用户，针对hellodb这个库中的表， 仅能针对特定的字段来查询，</span><br><span class="line">MariaDB [(none)]&gt; grant select(name,age) on hellodb.students to test2@<span class="string">'172.18.133.%'</span> identified by <span class="string">'daizhe'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看授权完的用户的权限</span><br><span class="line">MariaDB [(none)]&gt; show grants <span class="keyword">for</span> test2@<span class="string">'172.18.133.%'</span>\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">Grants <span class="keyword">for</span> test2@172.18.133.%: GRANT USAGE ON *.* TO <span class="string">'test2'</span>@<span class="string">'172.18.133.%'</span> IDENTIFIED BY PASSWORD <span class="string">'*0E04F27C8B21547FD069D6E8519AE49B7ECE8E94'</span></span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">Grants <span class="keyword">for</span> test2@172.18.133.%: GRANT SELECT (age, name) ON `hellodb`.`students` TO <span class="string">'test2'</span>@<span class="string">'172.18.133.%'</span></span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">取消回收权限 revoke</span><br><span class="line">  创建一个用户给与针对于所有库的所有权限</span><br><span class="line">MariaDB [(none)]&gt; grant all on *.* to test3@<span class="string">'172.18.133.%'</span> identified by <span class="string">'daizhe'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">取消这个用户的select 查询权限</span><br><span class="line">MariaDB [(none)]&gt; revoke select on *.* from test3@<span class="string">'172.18.133.%'</span>;</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看test3用户的权限</span><br><span class="line">MariaDB [(none)]&gt; show grants <span class="keyword">for</span> test3@<span class="string">'172.18.133.%'</span>\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">Grants <span class="keyword">for</span> test3@172.18.133.%: GRANT INSERT, UPDATE, DELETE, CREATE, DROP, RELOAD, SHUTDOWN, PROCESS, FILE, REFERENCES, INDEX, ALTER, SHOW DATABASES, SUPER, CREATE TEMPORARY TABLES, LOCK TABLES, EXECUTE, REPLICATION SLAVE, REPLICATION CLIENT, CREATE VIEW, SHOW VIEW, CREATE ROUTINE, ALTER ROUTINE, CREATE USER, EVENT, TRIGGER, CREATE TABLESPACE ON *.* TO <span class="string">'test3'</span>@<span class="string">'172.18.133.%'</span> IDENTIFIED BY PASSWORD <span class="string">'*0E04F27C8B21547FD069D6E8519AE49B7ECE8E94'</span></span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看当前用户的权限</span><br><span class="line">MariaDB [(none)]&gt; show grants <span class="keyword">for</span> current_user()\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">Grants <span class="keyword">for</span> root@localhost: GRANT ALL PRIVILEGES ON *.* TO <span class="string">'root'</span>@<span class="string">'localhost'</span> IDENTIFIED BY PASSWORD <span class="string">'*0E04F27C8B21547FD069D6E8519AE49B7ECE8E94'</span> WITH GRANT OPTION</span><br><span class="line">*************************** 2. row ***************************</span><br><span class="line">Grants <span class="keyword">for</span> root@localhost: GRANT PROXY ON <span class="string">''</span>@<span class="string">''</span> TO <span class="string">'root'</span>@<span class="string">'localhost'</span> WITH GRANT OPTION</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;mysql之数据库用户和权限管理&quot;&gt;&lt;a href=&quot;#mysql之数据库用户和权限管理&quot; class=&quot;headerlink&quot; title=&quot;mysql之数据库用户和权限管理&quot;&gt;&lt;/a&gt;mysql之数据库用户和权限管理&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/mysql之数据库用户和权限管理/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://daizhe.net.cn/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://daizhe.net.cn/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysql之数据库DML语言</title>
    <link href="https://daizhe.net.cn/2019/02/20/mysql%E4%B9%8B%E6%95%B0%E6%8D%AE%E5%BA%93DML%E8%AF%AD%E8%A8%80/"/>
    <id>https://daizhe.net.cn/2019/02/20/mysql之数据库DML语言/</id>
    <published>2019-02-20T06:50:41.722Z</published>
    <updated>2019-02-20T07:17:51.082Z</updated>
    
    <content type="html"><![CDATA[<h1 id="mysql之数据库DML语言"><a href="#mysql之数据库DML语言" class="headerlink" title="mysql之数据库DML语言"></a>mysql之数据库DML语言</h1><p><img src="/2019/02/20/mysql之数据库DML语言/标题.gif" alt=""><br><a id="more"></a></p><h2 id="DML语言-增加insert"><a href="#DML语言-增加insert" class="headerlink" title="DML语言 增加insert"></a>DML语言 增加insert</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br></pre></td><td class="code"><pre><span class="line"> DML语句   </span><br><span class="line">DML: INSERT增加, DELETE删除, UPDATE  改 </span><br><span class="line"></span><br><span class="line">增加insert</span><br><span class="line">查看帮助：MariaDB [studentdb]&gt; <span class="built_in">help</span> insert</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">查询当前数据库中的表信息</span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)    （为空）</span><br><span class="line"></span><br><span class="line">查询当前表中的记录数 （count 为函数）</span><br><span class="line">MariaDB [studentdb]&gt; select count(*) from student;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|        0 |</span><br><span class="line">+----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)  （为空）</span><br><span class="line"></span><br><span class="line">在当前使用的表中添加纪录</span><br><span class="line">首先查看表的结构，查看有哪些字段</span><br><span class="line">MariaDB [studentdb]&gt; desc student;</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| Field   | Type                | Null | Key | Default | Extra          |</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| id      | int(10) unsigned    | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name    | varchar(10)         | NO   |     | NULL    |                |</span><br><span class="line">| sex     | enum(<span class="string">'f'</span>,<span class="string">'m'</span>)       | YES  |     | m       |                |</span><br><span class="line">| age     | tinyint(3) unsigned | YES  |     | NULL    |                |</span><br><span class="line">| phone   | char(11)            | YES  |     | NULL    |                |</span><br><span class="line">| address | varchar(50)         | YES  |     | NULL    |                |</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">在表中添加纪录（赋值字段对应的字段，相对应的值，顺序不可变）（值和字段必须相同）</span><br><span class="line">MariaDB [studentdb]&gt; insert into student (name,age,phone,address) values (<span class="string">'mage'</span>,30,10086,<span class="string">'beijing'</span>), (<span class="string">'daizhe'</span>,20,10010,<span class="string">'tangshan'</span>);</span><br><span class="line">Query OK, 2 rows affected (0.00 sec)</span><br><span class="line">Records: 2  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">查询表中的纪录</span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">| id | name   | sex  | age  | phone | address  |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">|  1 | mage   | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe | m    |   20 | 10010 | tangshan |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; select count(*) from student;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|        2 |</span><br><span class="line">+----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">假如上述赋值时手机号忘记了怎么赋值（空值设置方法）</span><br><span class="line">MariaDB [studentdb]&gt; insert into student (age,name,phone,address) values (20,<span class="string">'ma'</span>,null,<span class="string">'shijiahuang'</span>);</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">+----+--------+------+------+-------+-------------+</span><br><span class="line">| id | name   | sex  | age  | phone | address     |</span><br><span class="line">+----+--------+------+------+-------+-------------+</span><br><span class="line">|  1 | mage   | m    |   30 | 10086 | beijing     |</span><br><span class="line">|  2 | daizhe | m    |   20 | 10010 | tangshan    |</span><br><span class="line">|  3 | dehua  | m    |   22 | NULL  | tianjin     |</span><br><span class="line">|  4 | ma     | m    |   20 | NULL  | shijiahuang |</span><br><span class="line">+----+--------+------+------+-------+-------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">单独挑出字段来赋值</span><br><span class="line">MariaDB [studentdb]&gt; insert student <span class="built_in">set</span> name=<span class="string">'dehua'</span>,age=22,address=<span class="string">'tianjin'</span>;</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">| id | name   | sex  | age  | phone | address  |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">|  1 | mage   | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe | m    |   20 | 10010 | tangshan |</span><br><span class="line">|  3 | dehua  | m    |   22 | NULL  | tianjin  |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><p>克隆表结构，并且纪录也被克隆<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">克隆表结构</span><br><span class="line">MariaDB [studentdb]&gt; create table employee select * from student;</span><br><span class="line">Query OK, 2 rows affected (0.01 sec)</span><br><span class="line">Records: 2  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">查看克隆生成的表的结构</span><br><span class="line">MariaDB [studentdb]&gt; desc employee;</span><br><span class="line">+---------+---------------------+------+-----+---------+-------+</span><br><span class="line">| Field   | Type                | Null | Key | Default | Extra |</span><br><span class="line">+---------+---------------------+------+-----+---------+-------+</span><br><span class="line">| id      | int(10) unsigned    | NO   |     | 0       |       |</span><br><span class="line">| name    | varchar(10)         | NO   |     | NULL    |       |</span><br><span class="line">| sex     | enum(<span class="string">'f'</span>,<span class="string">'m'</span>)       | YES  |     | m       |       |</span><br><span class="line">| age     | tinyint(3) unsigned | YES  |     | NULL    |       |</span><br><span class="line">| phone   | char(11)            | YES  |     | NULL    |       |</span><br><span class="line">| address | varchar(50)         | YES  |     | NULL    |       |</span><br><span class="line">+---------+---------------------+------+-----+---------+-------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line">查看数据是否也被克隆，被克隆</span><br><span class="line">MariaDB [studentdb]&gt; select * from employee;</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">| id | name   | sex  | age  | phone | address  |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">|  1 | mage   | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe | m    |   20 | 10010 | tangshan |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>克隆表结构，并且纪录不被克隆<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [studentdb]&gt; create table haha like student;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; desc haha;</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| Field   | Type                | Null | Key | Default | Extra          |</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| id      | int(10) unsigned    | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name    | varchar(10)         | NO   |     | NULL    |                |</span><br><span class="line">| sex     | enum(<span class="string">'f'</span>,<span class="string">'m'</span>)       | YES  |     | m       |                |</span><br><span class="line">| age     | tinyint(3) unsigned | YES  |     | NULL    |                |</span><br><span class="line">| phone   | char(11)            | YES  |     | NULL    |                |</span><br><span class="line">| address | varchar(50)         | YES  |     | NULL    |                |</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; select * from haha</span><br><span class="line">    -&gt; ;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>将相同表结构的数据合并<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [studentdb]&gt; select * from haha;</span><br><span class="line">Empty <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; insert haha select * from student;   (将student中的数据导入到haha表中，前提是两张表的表结构是相同的)</span><br><span class="line">Query OK, 4 rows affected (0.01 sec)</span><br><span class="line">Records: 4  Duplicates: 0  Warnings: 0</span><br></pre></td></tr></table></figure></p><p>在表的纪录的数据中添加汉字<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><span class="line">添加中文件字段</span><br><span class="line">MariaDB [studentdb]&gt; insert into student (age,name,phone,address) values (19,<span class="string">'星星'</span>,114114,<span class="string">'河北'</span>);</span><br><span class="line"></span><br><span class="line">结果显示为乱码</span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">+----+--------+------+------+--------+-------------+</span><br><span class="line">| id | name   | sex  | age  | phone  | address     |</span><br><span class="line">+----+--------+------+------+--------+-------------+</span><br><span class="line">|  1 | mage   | m    |   30 | 10086  | beijing     |</span><br><span class="line">|  2 | daizhe | m    |   20 | 10010  | tangshan    |</span><br><span class="line">|  3 | dehua  | m    |   22 | NULL   | tianjin     |</span><br><span class="line">|  4 | ma     | m    |   20 | NULL   | shijiahuang |</span><br><span class="line">|  5 | ??     | m    |   19 | 114114 | ??          |</span><br><span class="line">+----+--------+------+------+--------+-------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">乱码原因</span><br><span class="line">当初创建表的时候，用的为在字符集不支持汉字</span><br><span class="line">MariaDB [studentdb]&gt; show create table student;</span><br><span class="line"></span><br><span class="line">| student | CREATE TABLE `student` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(10) NOT NULL,</span><br><span class="line">  `sex` enum(<span class="string">'f'</span>,<span class="string">'m'</span>) DEFAULT <span class="string">'m'</span>,</span><br><span class="line">  `age` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">  `phone` char(11) DEFAULT NULL,</span><br><span class="line">  `address` varchar(50) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=6 DEFAULT CHARSET=latin1 |</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">创建一个utf8mb4的数据库</span><br><span class="line">MariaDB [studentdb]&gt;  create database db_utf8mb4 character <span class="built_in">set</span>=utf8mb4;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| db_utf8mb4         |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| studentdb          |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">克隆一张，studentdb库中的表student 倒 db_utf8mb4库中，仅克隆表结构</span><br><span class="line">（跨库导入表，库于表之间需要加点）</span><br><span class="line">MariaDB [studentdb]&gt; use db_utf8mb4;</span><br><span class="line">Database changed</span><br><span class="line">MariaDB [db_utf8mb4]&gt; </span><br><span class="line">   跨库克隆</span><br><span class="line">MariaDB [db_utf8mb4]&gt; create table student like studentdb.student</span><br><span class="line">    -&gt; ;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">查看克隆过来的表的字符集</span><br><span class="line">MariaDB [db_utf8mb4]&gt; show create table student;</span><br><span class="line"></span><br><span class="line">| student | CREATE TABLE `student` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(10) NOT NULL,</span><br><span class="line">  `sex` enum(<span class="string">'f'</span>,<span class="string">'m'</span>) DEFAULT <span class="string">'m'</span>,</span><br><span class="line">  `age` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">  `phone` char(11) DEFAULT NULL,</span><br><span class="line">  `address` varchar(50) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=latin1 |</span><br><span class="line"></span><br><span class="line">  此表为latin1也不支持中文，修改表的字符集</span><br><span class="line">MariaDB [db_utf8mb4]&gt; alter table student character <span class="built_in">set</span> = utf8mb4</span><br><span class="line">    -&gt; ;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)               </span><br><span class="line">Records: 0  Duplicates: 0  Warnings: 0</span><br><span class="line"></span><br><span class="line">MariaDB [db_utf8mb4]&gt; show create table student;</span><br><span class="line">| student | CREATE TABLE `student` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(10) CHARACTER SET latin1 NOT NULL,</span><br><span class="line">  `sex` enum(<span class="string">'f'</span>,<span class="string">'m'</span>) CHARACTER SET latin1 DEFAULT <span class="string">'m'</span>,</span><br><span class="line">  `age` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">  `phone` char(11) CHARACTER SET latin1 DEFAULT NULL,</span><br><span class="line">  `address` varchar(50) CHARACTER SET latin1 DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line"></span><br><span class="line">在此表中手动添加纪录</span><br><span class="line">MariaDB [db_utf8mb4]&gt; insert student (name,age,address) values (<span class="string">'nana'</span>,22,<span class="string">'石家庄'</span>);Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [db_utf8mb4]&gt; select * from status;</span><br><span class="line">ERROR 1146 (42S02): Table <span class="string">'db_utf8mb4.status'</span> doesn<span class="string">'t exist</span></span><br><span class="line"><span class="string">MariaDB [db_utf8mb4]&gt; select * from student;</span></span><br><span class="line"><span class="string">+----+------+------+------+-------+---------+</span></span><br><span class="line"><span class="string">| id | name | sex  | age  | phone | address |</span></span><br><span class="line"><span class="string">+----+------+------+------+-------+---------+</span></span><br><span class="line"><span class="string">|  1 | nana | m    |   22 | NULL  | ？？？  |</span></span><br><span class="line"><span class="string">+----+------+------+------+-------+---------+</span></span><br><span class="line"><span class="string">1 row in set (0.00 sec)</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">结果还是乱码</span></span><br><span class="line"><span class="string">查看此库的信息，显示编码不一致（结论客户端和服务端都应该统一编码）</span></span><br><span class="line"><span class="string">MariaDB [db_utf8mb4]&gt; status</span></span><br><span class="line"><span class="string">--------------</span></span><br><span class="line"><span class="string">mysql  Ver 15.1 Distrib 5.5.60-MariaDB, for Linux (x86_64) using readline 5.1</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Connection id:2</span></span><br><span class="line"><span class="string">Current database:db_utf8mb4</span></span><br><span class="line"><span class="string">Current user:root@localhost</span></span><br><span class="line"><span class="string">SSL:Not in use</span></span><br><span class="line"><span class="string">Current pager:stdout</span></span><br><span class="line"><span class="string">Using outfile:'</span><span class="string">'</span></span><br><span class="line"><span class="string">Using delimiter:;</span></span><br><span class="line"><span class="string">Server:MariaDB</span></span><br><span class="line"><span class="string">Server version:5.5.60-MariaDB MariaDB Server</span></span><br><span class="line"><span class="string">Protocol version:10</span></span><br><span class="line"><span class="string">Connection:Localhost via UNIX socket</span></span><br><span class="line"><span class="string">Insert id:1</span></span><br><span class="line"><span class="string">Server characterset:latin1</span></span><br><span class="line"><span class="string">Db     characterset:utf8mb4</span></span><br><span class="line"><span class="string">Client characterset:utf8</span></span><br><span class="line"><span class="string">Conn.  characterset:utf8</span></span><br><span class="line"><span class="string">UNIX socket:/var/lib/mysql/mysql.sock</span></span><br><span class="line"><span class="string">Uptime:3 min 21 sec</span></span><br><span class="line"><span class="string"></span></span><br><span class="line"><span class="string">Threads: 1  Questions: 14  Slow queries: 0  Opens: 1  Flush tables: 2  Open tables: 27  Queries per second avg: 0.069</span></span><br></pre></td></tr></table></figure></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">设置所有的编码都进行统一</span><br><span class="line">  设定之前查看当前数据库字符集，目前客户端和服务端都不一致</span><br><span class="line">  MariaDB [(none)]&gt; status</span><br><span class="line">--------------</span><br><span class="line">mysql  Ver 15.1 Distrib 5.5.60-MariaDB, <span class="keyword">for</span> Linux (x86_64) using readline 5.1</span><br><span class="line"></span><br><span class="line">Connection id:3</span><br><span class="line">Current database:</span><br><span class="line">Current user:root@localhost</span><br><span class="line">SSL:Not <span class="keyword">in</span> use</span><br><span class="line">Current pager:stdout</span><br><span class="line">Using outfile:<span class="string">''</span></span><br><span class="line">Using delimiter:;</span><br><span class="line">Server:MariaDB</span><br><span class="line">Server version:5.5.60-MariaDB MariaDB Server</span><br><span class="line">Protocol version:10</span><br><span class="line">Connection:Localhost via UNIX socket</span><br><span class="line">Server characterset:latin1</span><br><span class="line">Db     characterset:latin1</span><br><span class="line">Client characterset:utf8</span><br><span class="line">Conn.  characterset:utf8</span><br><span class="line">UNIX socket:/var/lib/mysql/mysql.sock</span><br><span class="line">Uptime:1 min 5 sec</span><br><span class="line"></span><br><span class="line">Threads: 1  Questions: 9  Slow queries: 0  Opens: 0  Flush tables: 2  Open tables: 26  Queries per second avg: 0.138</span><br><span class="line"></span><br><span class="line">编辑配置文件</span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]  （服务端添加一行）</span><br><span class="line">character-set-server=utf8mb4</span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/my.cnf.d/mysql-clients.cnf </span></span><br><span class="line">[mysql]    （客户端添加）</span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl restart mariadb</span></span><br><span class="line"></span><br><span class="line">查看更改完的字符集</span><br><span class="line">MariaDB [(none)]&gt; status</span><br><span class="line">--------------</span><br><span class="line">mysql  Ver 15.1 Distrib 5.5.60-MariaDB, <span class="keyword">for</span> Linux (x86_64) using readline 5.1</span><br><span class="line"></span><br><span class="line">Connection id:2</span><br><span class="line">Current database:</span><br><span class="line">Current user:root@localhost</span><br><span class="line">SSL:Not <span class="keyword">in</span> use</span><br><span class="line">Current pager:stdout</span><br><span class="line">Using outfile:<span class="string">''</span></span><br><span class="line">Using delimiter:;</span><br><span class="line">Server:MariaDB</span><br><span class="line">Server version:5.5.60-MariaDB MariaDB Server</span><br><span class="line">Protocol version:10</span><br><span class="line">Connection:Localhost via UNIX socket</span><br><span class="line">Server characterset:utf8mb4</span><br><span class="line">Db     characterset:utf8mb4</span><br><span class="line">Client characterset:utf8mb4</span><br><span class="line">Conn.  characterset:utf8mb4</span><br><span class="line">UNIX socket:/var/lib/mysql/mysql.sock</span><br><span class="line">Uptime:42 sec</span><br><span class="line"></span><br><span class="line">Threads: 1  Questions: 5  Slow queries: 0  Opens: 0  Flush tables: 2  Open tables: 26  Queries per second avg: 0.119</span><br><span class="line"></span><br><span class="line">此时再次可以新创建一个数据库，添加新表，写入字段，添加纪录，则此时已经支持了汉字，创库之前就要统一编码机制</span><br><span class="line"></span><br><span class="line">备份时，系统用什么字符集，备份就用相同的字符集建议使用utf8mb4</span><br><span class="line"></span><br><span class="line">修改统一的字符集，并创建新表</span><br><span class="line">MariaDB [xinbiao2]&gt; create database db2;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [xinbiao2]&gt; show create database db2;</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                 |</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">| db2      | CREATE DATABASE `db2` /*!40100 DEFAULT CHARACTER SET utf8mb4 */ |</span><br><span class="line">+----------+-----------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [xinbiao2]&gt; use db2;</span><br><span class="line">Database changed</span><br><span class="line">MariaDB [db2]&gt; create table biao (id int,name char(3));</span><br><span class="line">Query OK, 0 rows affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [db2]&gt; show create table biao;</span><br><span class="line">+-------+--------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table | Create Table                                                                                                             |</span><br><span class="line">+-------+--------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| biao  | CREATE TABLE `biao` (</span><br><span class="line">  `id` int(11) DEFAULT NULL,</span><br><span class="line">  `name` char(3) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line">+-------+--------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [db2]&gt; desc biao;</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">| Field | Type    | Null | Key | Default | Extra |</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">| id    | int(11) | YES  |     | NULL    |       |</span><br><span class="line">| name  | char(3) | YES  |     | NULL    |       |</span><br><span class="line">+-------+---------+------+-----+---------+-------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">全部字段赋值</span><br><span class="line">MariaDB [db2]&gt; insert biao value(1,<span class="string">'星星'</span>);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [db2]&gt; select * from biao;</span><br><span class="line">+------+--------+</span><br><span class="line">| id   | name   |</span><br><span class="line">+------+--------+</span><br><span class="line">|    1 | 星星   |</span><br><span class="line">+------+--------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">已经支持汉字</span><br></pre></td></tr></table></figure><p>字符集：实例可以自己指定，表结构可以指定，字段可以指定（最好统一）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">查看以前创建的表的创建规则，生成一个新字符集的表</span><br><span class="line">MariaDB [db2]&gt; show create table studentdb.student;</span><br><span class="line"></span><br><span class="line">| student | CREATE TABLE `student` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(10) NOT NULL,</span><br><span class="line">  `sex` enum(<span class="string">'f'</span>,<span class="string">'m'</span>) DEFAULT <span class="string">'m'</span>,</span><br><span class="line">  `age` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">  `phone` char(11) DEFAULT NULL,</span><br><span class="line">  `address` varchar(50) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB AUTO_INCREMENT=4 DEFAULT CHARSET=latin1 |</span><br><span class="line"></span><br><span class="line">仿照上一个的创建信息，创建一张新的表，默认的字符集为上面设置的。</span><br><span class="line"></span><br><span class="line">MariaDB [db2]&gt; CREATE TABLE `t2` (</span><br><span class="line">    -&gt;   `id` int(10) unsigned NOT NULL DEFAULT <span class="string">'0'</span>,</span><br><span class="line">    -&gt;   `name` varchar(10)  NOT NULL,</span><br><span class="line">    -&gt;   `sex` enum(<span class="string">'f'</span>,<span class="string">'m'</span>)  DEFAULT <span class="string">'m'</span>,</span><br><span class="line">    -&gt;   `age` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">    -&gt;   `mobile` char(11)  DEFAULT NULL,</span><br><span class="line">    -&gt;   `address` varchar(50)  DEFAULT NULL</span><br><span class="line">    -&gt; ) ENGINE=InnoDB;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">查看创建信息，在创建时未指定表结构，使用默认的表结构utf8mb4</span><br><span class="line">MariaDB [db2]&gt; show create table t2;</span><br><span class="line">| t2    | CREATE TABLE `t2` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL DEFAULT <span class="string">'0'</span>,</span><br><span class="line">  `name` varchar(10) NOT NULL,</span><br><span class="line">  `sex` enum(<span class="string">'f'</span>,<span class="string">'m'</span>) DEFAULT <span class="string">'m'</span>,</span><br><span class="line">  `age` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">  `mobile` char(11) DEFAULT NULL,</span><br><span class="line">  `address` varchar(50) DEFAULT NULL</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 |</span><br><span class="line"></span><br><span class="line">在表中插入记录，挑选字段插入</span><br><span class="line">MariaDB [db2]&gt; insert t2 (name,age,address) values(<span class="string">'代哲'</span>,21,<span class="string">'唐山'</span>);</span><br><span class="line">Query OK, 1 row affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [db2]&gt; select * from t2;</span><br><span class="line">+----+--------+------+------+--------+---------+</span><br><span class="line">| id | name   | sex  | age  | mobile | address |</span><br><span class="line">+----+--------+------+------+--------+---------+</span><br><span class="line">|  0 | 代哲   | m    |   21 | NULL   | 唐山    |</span><br><span class="line">+----+--------+------+------+--------+---------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><h2 id="DML-语言-删除-delete"><a href="#DML-语言-删除-delete" class="headerlink" title="DML 语言 删除 delete"></a>DML 语言 删除 delete</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">删库：drop database 库名</span><br><span class="line">删表：drop table 表名</span><br><span class="line">删除数据库中的表数据，但不删除表结构，而且不记录日志，效率高，慎用：truncate table 表</span><br><span class="line"></span><br><span class="line">全部删除表中所有内容：</span><br><span class="line">MariaDB [studentdb]&gt; delete from 表名;</span><br><span class="line">使用delete删除指定删除的条件，使用<span class="built_in">where</span>指定条件</span><br><span class="line"></span><br><span class="line">删除表中的单条记录</span><br><span class="line">  查看表中的内容</span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">| id | name    | sex  | age  | phone | address  |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">|  1 | mage    | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe  | m    |   20 | 10010 | tangshan |</span><br><span class="line">|  3 | laowang | m    |   18 | NULL  | tangshan |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">  删除表中的字段，需要定义查询条件</span><br><span class="line">  范例：删除id为3号和三号以后的字段</span><br><span class="line">MariaDB [studentdb]&gt; delete from student <span class="built_in">where</span> id &gt;= 3;</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">高版本的数据库版本</span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 8</span><br><span class="line">Server version: 10.3.11-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; create database b1;</span><br><span class="line">Query OK, 1 row affected (0.001 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; use b1;</span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line">MariaDB [b1]&gt; create table t1(id int,name char(3));</span><br><span class="line">Query OK, 0 rows affected (0.007 sec)</span><br><span class="line"></span><br><span class="line">当在高版本的数据库中创建一个库，再创建一个表，查看数据库数据目录</span><br><span class="line">[root@centos7 ~]<span class="comment"># ls /var/lib/mysql/b1/</span></span><br><span class="line">db.opt  t1.frm  t1.ibd</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">低版本的数据库</span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql</span></span><br><span class="line">Welcome to the MariaDB monitor.  Commands end with ; or \g.</span><br><span class="line">Your MariaDB connection id is 4</span><br><span class="line">Server version: 5.5.60-MariaDB MariaDB Server</span><br><span class="line"></span><br><span class="line">当在低版本的数据库中创建一个库，再创建一个表，查看数据库数据目录</span><br><span class="line">[root@centos7 ~]<span class="comment"># ls /var/lib/mysql/studentdb/</span></span><br><span class="line">db.opt  student.frm  xinbiao1.frm  xinbiao.frm</span><br><span class="line">frm文件存放表结构</span><br><span class="line">缺少ibd文件，存放用户的数据，老版本的数据放置再</span><br><span class="line">/var/lib/mysql/ibdata1（所有数据库，以及所有表的数据放在这个文件中）</span><br><span class="line"></span><br><span class="line">可以再老版本中添加选项使得和新版本一样，使得每个数据单独放置</span><br><span class="line">   可以在数据库程序使用系统函数查看</span><br><span class="line">老版本为关闭状态</span><br><span class="line">MariaDB [(none)]&gt; show variables like <span class="string">'%per_table%'</span>;</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| Variable_name         | Value |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| innodb_file_per_table | OFF   |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">新版本为开启状态</span><br><span class="line">MariaDB [b1]&gt; show variables like <span class="string">'%per_table%'</span>;</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| Variable_name         | Value |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">| innodb_file_per_table | ON    |</span><br><span class="line">+-----------------------+-------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.002 sec)</span><br><span class="line"></span><br><span class="line">可以再老版本的配置文件中加以定义，添加一行，重启服务</span><br><span class="line">重启后，只有再次创建的新 表才会遵循此规则</span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">innodb_file_per_table</span><br></pre></td></tr></table></figure><h2 id="DML-语言-更改-update"><a href="#DML-语言-更改-update" class="headerlink" title="DML 语言 更改 update"></a>DML 语言 更改 update</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">update 进行数据更改时也要使用<span class="built_in">where</span>进行条件匹配</span><br><span class="line">如果不加条件匹配则修改所有的字段</span><br><span class="line"></span><br><span class="line">更改表内容</span><br><span class="line">  先查看下表内容</span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">| id | name    | sex  | age  | phone | address  |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">|  1 | mage    | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe  | m    |   20 | 10010 | tangshan |</span><br><span class="line">|  3 | laowang | m    |   18 | NULL  | tangshan |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">将一号的姓名进行更改</span><br><span class="line">MariaDB [studentdb]&gt; update student <span class="built_in">set</span> name=<span class="string">'aaaa'</span> <span class="built_in">where</span> id=1;</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; select * from student;</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">| id | name    | sex  | age  | phone | address  |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">|  1 | aaaa    | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe  | m    |   20 | 10010 | tangshan |</span><br><span class="line">|  3 | laowang | m    |   18 | NULL  | tangshan |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line"></span><br><span class="line">防止忘记使用<span class="built_in">where</span>条件判断语句，可以使用</span><br><span class="line">方法1：</span><br><span class="line">mysql选项： -U | --safe-updates </span><br><span class="line">[root@centos7 ~]<span class="comment"># mysql -U</span></span><br><span class="line">MariaDB [studentdb]&gt; update student <span class="built_in">set</span> name=<span class="string">'aaaa'</span>;</span><br><span class="line">ERROR 1175 (HY000): You are using safe update mode and you tried to update a table without a WHERE that uses a KEY column</span><br><span class="line">提示说你使用的是安装更新模式</span><br><span class="line"></span><br><span class="line">方法2：</span><br><span class="line">可以修改配置文件，追加</span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /etc/my.cnf.d/mysql-clients.cnf </span></span><br><span class="line">[mysql]</span><br><span class="line">safe-updates</span><br></pre></td></tr></table></figure><p>字符集更改<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">数据库级的更改</span><br><span class="line">alter database studentdb character <span class="built_in">set</span> utf8;</span><br><span class="line"></span><br><span class="line">表整个所有字段的字符集更改(仅能影响表中后增加的字段)</span><br><span class="line">alter table student character <span class="built_in">set</span> utf8;</span><br><span class="line"></span><br><span class="line">原来的字段想被修改</span><br><span class="line">alter table student chage 原字段name 新字段name varchar(20) character <span class="built_in">set</span> utf8;</span><br><span class="line"></span><br><span class="line">尽量设计表之前就要将客户端和服务端的字符集就要设计好，后期尽量不要修改</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;mysql之数据库DML语言&quot;&gt;&lt;a href=&quot;#mysql之数据库DML语言&quot; class=&quot;headerlink&quot; title=&quot;mysql之数据库DML语言&quot;&gt;&lt;/a&gt;mysql之数据库DML语言&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/mysql之数据库DML语言/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://daizhe.net.cn/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://daizhe.net.cn/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysql之select多表操作</title>
    <link href="https://daizhe.net.cn/2019/02/20/mysql%E4%B9%8Bselect%E5%A4%9A%E8%A1%A8%E6%93%8D%E4%BD%9C/"/>
    <id>https://daizhe.net.cn/2019/02/20/mysql之select多表操作/</id>
    <published>2019-02-20T06:46:48.143Z</published>
    <updated>2019-02-20T07:18:04.466Z</updated>
    
    <content type="html"><![CDATA[<h1 id="mysql之select多表操作"><a href="#mysql之select多表操作" class="headerlink" title="mysql之select多表操作"></a>mysql之select多表操作</h1><p><img src="/2019/02/20/mysql之select多表操作/标题.gif" alt=""><br><a id="more"></a></p><h2 id="DQL语句-select-查询"><a href="#DQL语句-select-查询" class="headerlink" title="DQL语句 select 查询"></a>DQL语句 select 查询</h2><p><img src="/2019/02/20/mysql之select多表操作/1.png" alt=""></p><p>范例中的两张表<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; show tables;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_hellodb |</span><br><span class="line">+-------------------+</span><br><span class="line">| students          |</span><br><span class="line">| teachers          |</span><br><span class="line">+-------------------+</span><br><span class="line"></span><br><span class="line">两张表组合查询：</span><br><span class="line">两种情况：两张表纵向合并，和两张表横向合并</span><br><span class="line">纵向合并：前提是字段相同，如果不同，可以挑选出相同的字段来显示</span><br><span class="line">横向合并：笛卡尔乘积:交叉连接：cross join:互相两张表互相每条记录组合一变</span><br></pre></td></tr></table></figure></p><p><code>纵向合并</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">首先查看两张表的字段信息</span><br><span class="line">学生表</span><br><span class="line">MariaDB [hellodb]&gt; select * from students;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |       4 |         4 |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |       3 |         1 |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">讲师表</span><br><span class="line">MariaDB [hellodb]&gt; select * from teachers</span><br><span class="line">    -&gt; ;</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">| TID | Name          | Age | Gender |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">|   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">如果纵向显示可以挑选出字段想多的信息来显示</span><br><span class="line">挑选学生表的字段</span><br><span class="line">MariaDB [hellodb]&gt; select stuid,name,age,gender from students;</span><br><span class="line">+-------+---------------+-----+--------+</span><br><span class="line">| stuid | name          | age | gender |</span><br><span class="line">+-------+---------------+-----+--------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |</span><br><span class="line">........</span><br><span class="line"></span><br><span class="line">已经挑选了相同的字段，现在进行两表纵向合并显示</span><br><span class="line">关键字union合并显示、联合（并非真实的合并，仅仅是显示结果的合并）</span><br><span class="line">字段的标题是由前面定义的显示的字段决定的，显示结果如下，如果想定义自己想看到的字段，可以在前面匹配第一张表显示的字段上加以别名显示</span><br><span class="line">MariaDB [hellodb]&gt; select stuid,name,age,gender from students</span><br><span class="line">    -&gt; union</span><br><span class="line">    -&gt; select * from teachers;</span><br><span class="line">+-------+---------------+-----+--------+</span><br><span class="line">| stuid | name          | age | gender |</span><br><span class="line">+-------+---------------+-----+--------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |</span><br><span class="line">|     1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-------+---------------+-----+--------+</span><br><span class="line"></span><br><span class="line">挑选两张表相同的字段来显示</span><br><span class="line">MariaDB [hellodb]&gt; select stuid,name from students union select tid,name from teachers;</span><br><span class="line">+-------+---------------+</span><br><span class="line">| stuid | name          |</span><br><span class="line">+-------+---------------+</span><br><span class="line">|     1 | Shi Zhongyu   |</span><br><span class="line">|     2 | Shi Potian    |</span><br><span class="line">|     3 | Xie Yanke     |</span><br><span class="line">|     4 | Ding Dian     |</span><br><span class="line">|     5 | Yu Yutong     |</span><br><span class="line">|     6 | Shi Qing      |</span><br><span class="line">|     7 | Xi Ren        |</span><br><span class="line">|     8 | Lin Daiyu     |</span><br><span class="line">|     9 | Ren Yingying  |</span><br><span class="line">|    10 | Yue Lingshan  |</span><br><span class="line">|    11 | Yuan Chengzhi |</span><br><span class="line">|    12 | Wen Qingqing  |</span><br><span class="line">|    13 | Tian Boguang  |</span><br><span class="line">|    14 | Lu Wushuang   |</span><br><span class="line">|    15 | Duan Yu       |</span><br><span class="line">|    16 | Xu Zhu        |</span><br><span class="line">|    17 | Lin Chong     |</span><br><span class="line">|    18 | Hua Rong      |</span><br><span class="line">|    19 | Xue Baochai   |</span><br><span class="line">|    20 | Diao Chan     |</span><br><span class="line">|    21 | Huang Yueying |</span><br><span class="line">|    22 | Xiao Qiao     |</span><br><span class="line">|    23 | Ma Chao       |</span><br><span class="line">|    24 | Xu Xian       |</span><br><span class="line">|    25 | Sun Dasheng   |</span><br><span class="line">|     1 | Song Jiang    |</span><br><span class="line">|     2 | Zhang Sanfeng |</span><br><span class="line">|     3 | Miejue Shitai |</span><br><span class="line">|     4 | Lin Chaoying  |</span><br><span class="line">+-------+---------------+</span><br><span class="line">29 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">显示自己想要显示的字段，加以别名显示</span><br><span class="line">MariaDB [hellodb]&gt; select stuid as 编号,name as 名字 from students union select tid,name from teachers;</span><br><span class="line">+--------+---------------+</span><br><span class="line">| 编号   | 名字          |</span><br><span class="line">+--------+---------------+</span><br><span class="line">|      1 | Shi Zhongyu   |</span><br><span class="line">|      2 | Shi Potian    |</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">如果两张表合并时，显示的字段相同，且有相同的记录信息，则不仅显示一条，因为select语句有重复的记录，union会去重</span><br><span class="line"></span><br><span class="line">去重小技巧：将同一个表中的相同字段去重</span><br><span class="line">方法1：自己和自己合并去重</span><br><span class="line">select * from 表 union select * from 表</span><br><span class="line">方法2：使用distinct,取唯一值</span><br><span class="line">select distinct * from 表</span><br></pre></td></tr></table></figure></p><p><code>横向合并</code>cross join<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br></pre></td><td class="code"><pre><span class="line">cross join 横向合并：笛卡尔乘积</span><br><span class="line">MariaDB [hellodb]&gt; select * from students cross join teachers;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID | TID | Name          | Age | Gender |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |       4 |         4 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |       4 |         4 |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |       4 |         4 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |       4 |         4 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |       3 |         1 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |       3 |         1 |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |       3 |         1 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |       3 |         1 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">100 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">意义不大：生产一般不用</span><br></pre></td></tr></table></figure></p><p><img src="/2019/02/20/mysql之select多表操作/1.png" alt=""><br><code>两表交集内连接</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br></pre></td><td class="code"><pre><span class="line">先查看两表的记录</span><br><span class="line">  学生表</span><br><span class="line">MariaDB [hellodb]&gt; select * from students;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |       4 |         4 |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |       3 |         1 |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">25 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">  讲师表</span><br><span class="line">MariaDB [hellodb]&gt; select * from teachers;</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">| TID | Name          | Age | Gender |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">|   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">学生表中的TeacherID和讲师表中的TID，可以作为交集的相等记录</span><br><span class="line">语法1：</span><br><span class="line">MariaDB [hellodb]&gt; select * from students,teachers <span class="built_in">where</span> students.teacherid=teachers.tid;</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">| StuID | Name        | Age | Gender | ClassID | TeacherID | TID | Name          | Age | Gender |</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">|     5 | Yu Yutong   |  26 | M      |       3 |         1 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     1 | Shi Zhongyu |  22 | M      |       2 |         3 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     4 | Ding Dian   |  32 | M      |       4 |         4 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">语法2：内连接inner join ..on</span><br><span class="line">MariaDB [hellodb]&gt; select * from students inner join teachers on students.teacherid=teachers.tid;</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">| StuID | Name        | Age | Gender | ClassID | TeacherID | TID | Name          | Age | Gender |</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">|     5 | Yu Yutong   |  26 | M      |       3 |         1 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    25 | Sun Dasheng | 100 | M      |    NULL |         1 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|     1 | Shi Zhongyu |  22 | M      |       2 |         3 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     4 | Ding Dian   |  32 | M      |       4 |         4 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line">可以将内连接后的查询结果再次进行查询</span><br><span class="line">（name 在此句中出现了两次，要指定表名）</span><br><span class="line">MariaDB [hellodb]&gt; select stuid,students.name,tid,teachers.name from students inner join teachers on students.teacherid=teachers.tid;</span><br><span class="line">+-------+-------------+-----+---------------+</span><br><span class="line">| stuid | name        | tid | name          |</span><br><span class="line">+-------+-------------+-----+---------------+</span><br><span class="line">|     5 | Yu Yutong   |   1 | Song Jiang    |</span><br><span class="line">|    25 | Sun Dasheng |   1 | Song Jiang    |</span><br><span class="line">|     1 | Shi Zhongyu |   3 | Miejue Shitai |</span><br><span class="line">|     4 | Ding Dian   |   4 | Lin Chaoying  |</span><br><span class="line">+-------+-------------+-----+---------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">此时虽然已经查询到了，但是为了区分name的含义，可以考虑添加别名</span><br><span class="line">MariaDB [hellodb]&gt; select stuid,students.name as 学生姓名,tid,teachers.name as 老师名字 from students inner join teachers on students.teacherid=teachers.tid;</span><br><span class="line">+-------+--------------+-----+---------------+</span><br><span class="line">| stuid | 学生姓名     | tid | 老师名字      |</span><br><span class="line">+-------+--------------+-----+---------------+</span><br><span class="line">|     5 | Yu Yutong    |   1 | Song Jiang    |</span><br><span class="line">|    25 | Sun Dasheng  |   1 | Song Jiang    |</span><br><span class="line">|     1 | Shi Zhongyu  |   3 | Miejue Shitai |</span><br><span class="line">|     4 | Ding Dian    |   4 | Lin Chaoying  |</span><br><span class="line">+-------+--------------+-----+---------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">为了简化也可以给表起别名</span><br><span class="line">MariaDB [hellodb]&gt; select stuid,s.name as student_name,tid,t.name teacher_name from students as s inner join teachers t on s.teacherid=t.tid;</span><br><span class="line">+-------+--------------+-----+---------------+</span><br><span class="line">| stuid | student_name | tid | teacher_name  |</span><br><span class="line">+-------+--------------+-----+---------------+</span><br><span class="line">|     5 | Yu Yutong    |   1 | Song Jiang    |</span><br><span class="line">|    25 | Sun Dasheng  |   1 | Song Jiang    |</span><br><span class="line">|     1 | Shi Zhongyu  |   3 | Miejue Shitai |</span><br><span class="line">|     4 | Ding Dian    |   4 | Lin Chaoying  |</span><br><span class="line">+-------+--------------+-----+---------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><code>取a表的所有记录，b表取于a表相同条件的记录 外连接</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">左外连接</span><br><span class="line">left outer join </span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; select * from students as s left outer join teachers t on s.teacherid=t.tid;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+------+---------------+------+--------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID | TID  | Name          | Age  | Gender |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+------+---------------+------+--------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |    3 | Miejue Shitai |   77 | F      |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     4 | Ding Dian     |  32 | M      |       4 |         4 |    4 | Lin Chaoying  |   93 | F      |</span><br><span class="line">|     5 | Yu Yutong     |  26 | M      |       3 |         1 |    1 | Song Jiang    |   45 | M      |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |         1 |    1 | Song Jiang    |   45 | M      |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+------+---------------+------+--------+</span><br><span class="line">25 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">右外链接</span><br><span class="line">right outer join</span><br><span class="line">MariaDB [hellodb]&gt; select * from students as s right outer join teachers t on s.teacherid=t.tid;</span><br><span class="line">+-------+-------------+------+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">| StuID | Name        | Age  | Gender | ClassID | TeacherID | TID | Name          | Age | Gender |</span><br><span class="line">+-------+-------------+------+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">|     1 | Shi Zhongyu |   22 | M      |       2 |         3 |   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|     4 | Ding Dian   |   32 | M      |       4 |         4 |   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">|     5 | Yu Yutong   |   26 | M      |       3 |         1 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|    25 | Sun Dasheng |  100 | M      |    NULL |         1 |   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|  NULL | NULL        | NULL | NULL   |    NULL |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">+-------+-------------+------+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">左外连接和右外连接 ，表的左右顺序很重要</span><br></pre></td></tr></table></figure></p><p><code>左外连接 变种：排除交集和b表</code>将右边的表全部不显示，仅显示a表中和b表不相同的记录<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; select * from students as s left outer join teachers t on s.teacherid=t.tid <span class="built_in">where</span> t.tid is null;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+------+------+------+--------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID | TID  | Name | Age  | Gender |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+------+------+------+--------+</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 | NULL | NULL | NULL | NULL   |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 | NULL | NULL | NULL | NULL   |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|     7 | Xi Ren        |  19 | F      |       3 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    10 | Yue Lingshan  |  19 | F      |       3 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    15 | Duan Yu       |  19 | M      |       4 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    20 | Diao Chan     |  19 | F      |       7 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    23 | Ma Chao       |  23 | M      |       4 |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL | NULL | NULL | NULL | NULL   |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+------+------+------+--------+</span><br><span class="line">21 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br><span class="line"></span><br><span class="line">右外连接的 变种</span><br><span class="line">MariaDB [hellodb]&gt; select * from students as s right outer join teachers t on s.teacherid=t.tid <span class="built_in">where</span> s.teacherid is null;</span><br><span class="line">+-------+------+------+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">| StuID | Name | Age  | Gender | ClassID | TeacherID | TID | Name          | Age | Gender |</span><br><span class="line">+-------+------+------+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">|  NULL | NULL | NULL | NULL   |    NULL |      NULL |   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">+-------+------+------+--------+---------+-----------+-----+---------------+-----+--------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><h2 id="子查询"><a href="#子查询" class="headerlink" title="子查询"></a>子查询</h2><p>查询语句中嵌入另外的语句查询<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">范例：查询老师年龄大于学生平均年龄的老师列表</span><br><span class="line">  查询学生的平均年龄</span><br><span class="line">MariaDB [hellodb]&gt; select avg(age) from students;</span><br><span class="line">+----------+</span><br><span class="line">| avg(age) |</span><br><span class="line">+----------+</span><br><span class="line">|  27.4000 |</span><br><span class="line">+----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看老师的表</span><br><span class="line">MariaDB [hellodb]&gt; select * from teachers;</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">| TID | Name          | Age | Gender |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">|   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">查询老师年龄大于学生平均年龄的老师列表</span><br><span class="line">MariaDB [hellodb]&gt; select * from teachers <span class="built_in">where</span> age &gt; (select avg(age) from students);</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">| TID | Name          | Age | Gender |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">|   1 | Song Jiang    |  45 | M      |</span><br><span class="line">|   2 | Zhang Sanfeng |  94 | M      |</span><br><span class="line">|   3 | Miejue Shitai |  77 | F      |</span><br><span class="line">|   4 | Lin Chaoying  |  93 | F      |</span><br><span class="line">+-----+---------------+-----+--------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><code>完全外连接</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">full outer join</span><br><span class="line"></span><br><span class="line">mysql数据库不支持</span><br><span class="line"></span><br><span class="line">变相逻辑实现</span><br><span class="line">使用左外连接和右外连接实现</span><br><span class="line">MariaDB [hellodb]&gt; select * from students as s left outer join teachers t on s.teacherid=t.tid</span><br><span class="line">    -&gt; union</span><br><span class="line">    -&gt; select * from students as s right outer join teachers t on s.teacherid=t.tid;</span><br><span class="line">+-------+---------------+------+--------+---------+-----------+------+---------------+------+--------+</span><br><span class="line">| StuID | Name          | Age  | Gender | ClassID | TeacherID | TID  | Name          | Age  | Gender |</span><br><span class="line">+-------+---------------+------+--------+---------+-----------+------+---------------+------+--------+</span><br><span class="line">|     1 | Shi Zhongyu   |   22 | M      |       2 |         3 |    3 | Miejue Shitai |   77 | F      |</span><br><span class="line">|     2 | Shi Potian    |   22 | M      |       1 |         7 | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     3 | Xie Yanke     |   53 | M      |       2 |        16 | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     4 | Ding Dian     |   32 | M      |       4 |         4 |    4 | Lin Chaoying  |   93 | F      |</span><br><span class="line">|     5 | Yu Yutong     |   26 | M      |       3 |         1 |    1 | Song Jiang    |   45 | M      |</span><br><span class="line">|     6 | Shi Qing      |   46 | M      |       5 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     7 | Xi Ren        |   19 | F      |       3 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     8 | Lin Daiyu     |   17 | F      |       7 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|     9 | Ren Yingying  |   20 | F      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    10 | Yue Lingshan  |   19 | F      |       3 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    11 | Yuan Chengzhi |   23 | M      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    12 | Wen Qingqing  |   19 | F      |       1 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    13 | Tian Boguang  |   33 | M      |       2 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    14 | Lu Wushuang   |   17 | F      |       3 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    15 | Duan Yu       |   19 | M      |       4 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    16 | Xu Zhu        |   21 | M      |       1 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    17 | Lin Chong     |   25 | M      |       4 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    18 | Hua Rong      |   23 | M      |       7 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    19 | Xue Baochai   |   18 | F      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    20 | Diao Chan     |   19 | F      |       7 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    21 | Huang Yueying |   22 | F      |       6 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    22 | Xiao Qiao     |   20 | F      |       1 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    23 | Ma Chao       |   23 | M      |       4 |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    24 | Xu Xian       |   27 | M      |    NULL |      NULL | NULL | NULL          | NULL | NULL   |</span><br><span class="line">|    25 | Sun Dasheng   |  100 | M      |    NULL |         1 |    1 | Song Jiang    |   45 | M      |</span><br><span class="line">|  NULL | NULL          | NULL | NULL   |    NULL |      NULL |    2 | Zhang Sanfeng |   94 | M      |</span><br><span class="line">+-------+---------------+------+--------+---------+-----------+------+---------------+------+--------+</span><br><span class="line">26 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>仅去除交集:两个都有的去除<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; select * from  (select stuid,s.name as student_name,s.age as student_age,s.gender as student_gender ,classid,teacherid,tid,t.name as teacher_name,t.age as teacher_age,t.gender as teacher_gedner </span><br><span class="line">    -&gt; from students as s  left outer join teachers  t on  s.teacherid=t.tid  </span><br><span class="line">    -&gt; union  </span><br><span class="line">    -&gt; select stuid,s.name,s.age,s.gender,classid,teacherid,tid,t.name,t.age,t.gender </span><br><span class="line">    -&gt; from students as s right outer join teachers  t on  s.teacherid=t.tid) </span><br><span class="line">    -&gt; as f  <span class="built_in">where</span> f.teacherid is null or f.tid is null;</span><br><span class="line">+-------+---------------+-------------+----------------+---------+-----------+------+---------------+-------------+----------------+</span><br><span class="line">| stuid | student_name  | student_age | student_gender | classid | teacherid | tid  | teacher_name  | teacher_age | teacher_gedner |</span><br><span class="line">+-------+---------------+-------------+----------------+---------+-----------+------+---------------+-------------+----------------+</span><br><span class="line">|     2 | Shi Potian    |          22 | M              |       1 |         7 | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|     3 | Xie Yanke     |          53 | M              |       2 |        16 | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|     6 | Shi Qing      |          46 | M              |       5 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|     7 | Xi Ren        |          19 | F              |       3 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|     8 | Lin Daiyu     |          17 | F              |       7 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|     9 | Ren Yingying  |          20 | F              |       6 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    10 | Yue Lingshan  |          19 | F              |       3 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    11 | Yuan Chengzhi |          23 | M              |       6 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    12 | Wen Qingqing  |          19 | F              |       1 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    13 | Tian Boguang  |          33 | M              |       2 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    14 | Lu Wushuang   |          17 | F              |       3 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    15 | Duan Yu       |          19 | M              |       4 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    16 | Xu Zhu        |          21 | M              |       1 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    17 | Lin Chong     |          25 | M              |       4 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    18 | Hua Rong      |          23 | M              |       7 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    19 | Xue Baochai   |          18 | F              |       6 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    20 | Diao Chan     |          19 | F              |       7 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    21 | Huang Yueying |          22 | F              |       6 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    22 | Xiao Qiao     |          20 | F              |       1 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    23 | Ma Chao       |          23 | M              |       4 |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|    24 | Xu Xian       |          27 | M              |    NULL |      NULL | NULL | NULL          |        NULL | NULL           |</span><br><span class="line">|  NULL | NULL          |        NULL | NULL           |    NULL |      NULL |    2 | Zhang Sanfeng |          94 | M              |</span><br><span class="line">+-------+---------------+-------------+----------------+---------+-----------+------+---------------+-------------+----------------+</span><br><span class="line">22 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>定义的char(3) 是三个字符的意思，非字节</p><p>不同的字符所占的字节是不同的。</p><p>ASCII码：</p><p>一个英文字母（不分大小写）占一个字节的空间，一个中文汉字占两个字节的空间。一个二进制数字序列，在计算机中作为一个数字单元，一般为8位二进制数，换算为十进制。最小值0，最大值255。如一个ASCII码就是一个字节。</p><p>UTF-8编码：</p><p>一个英文字符等于一个字节，一个中文（含繁体）等于三个字节。</p><p>Unicode编码：</p><p>一个英文等于两个字节，一个中文（含繁体）等于两个字节。</p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;mysql之select多表操作&quot;&gt;&lt;a href=&quot;#mysql之select多表操作&quot; class=&quot;headerlink&quot; title=&quot;mysql之select多表操作&quot;&gt;&lt;/a&gt;mysql之select多表操作&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/mysql之select多表操作/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://daizhe.net.cn/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://daizhe.net.cn/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysql之select单表操作</title>
    <link href="https://daizhe.net.cn/2019/02/20/mysql%E4%B9%8Bselect%E5%8D%95%E8%A1%A8%E6%93%8D%E4%BD%9C/"/>
    <id>https://daizhe.net.cn/2019/02/20/mysql之select单表操作/</id>
    <published>2019-02-20T06:45:14.673Z</published>
    <updated>2019-02-20T07:18:11.906Z</updated>
    
    <content type="html"><![CDATA[<h1 id="mysql之select单表操作"><a href="#mysql之select单表操作" class="headerlink" title="mysql之select单表操作"></a>mysql之select单表操作</h1><p><img src="/2019/02/20/mysql之select单表操作/标题.gif" alt=""><br><a id="more"></a></p><h2 id="DQL语句-select-查询"><a href="#DQL语句-select-查询" class="headerlink" title="DQL语句 select 查询"></a>DQL语句 select 查询</h2><p><code>挑选字段来显示</code><br>列的过滤<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">查询所有的字段信息：代表从student这个表中查询所有字段</span><br><span class="line">select * from student;</span><br><span class="line"></span><br><span class="line">挑选字段显示（定义显示的顺序由自己定义）</span><br><span class="line">MariaDB [studentdb]&gt; select id,name,age from student;</span><br><span class="line">+----+---------+------+</span><br><span class="line">| id | name    | age  |</span><br><span class="line">+----+---------+------+</span><br><span class="line">|  1 | aaaa    |   30 |</span><br><span class="line">|  2 | daizhe  |   20 |</span><br><span class="line">|  3 | laowang |   18 |</span><br><span class="line">+----+---------+------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">将显示的字段名称加以别名：此场景适用于挑选的字段过长，或者将字母转换为中文显示</span><br><span class="line">MariaDB [studentdb]&gt; select name as 姓名,age from student;</span><br><span class="line">+---------+------+</span><br><span class="line">| 姓名    | age  |</span><br><span class="line">+---------+------+</span><br><span class="line">| aaaa    |   30 |</span><br><span class="line">| daizhe  |   20 |</span><br><span class="line">| laowang |   18 |</span><br><span class="line">+---------+------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.01 sec)</span><br></pre></td></tr></table></figure></p><p><code>挑选特定的行来显示</code><br>行的过滤<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">范例：查看年龄为25岁以上的学员信息</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> age &gt; 25;</span><br><span class="line">+----+------+------+------+-------+---------+</span><br><span class="line">| id | name | sex  | age  | phone | address |</span><br><span class="line">+----+------+------+------+-------+---------+</span><br><span class="line">|  1 | aaaa | m    |   30 | 10086 | beijing |</span><br><span class="line">+----+------+------+------+-------+---------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">范例：查看年龄大于等于25 小于等于28</span><br><span class="line">方法1：</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> age &gt;= 25 and age &lt;= 28;</span><br><span class="line">方法2：between 在什么之间</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> age between 25 and 28;</span><br><span class="line"></span><br><span class="line">范例：查询年龄等于20 和等于30的人</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> age <span class="keyword">in</span> (20,30);</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">| id | name   | sex  | age  | phone | address  |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">|  1 | aaaa   | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe | m    |   20 | 10010 | tangshan |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">2 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">范例：查询班级表中手机号未知的人</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> phone is null;</span><br><span class="line"></span><br><span class="line">范例：查询班级手机号不为空的人</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> phone is not null;</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">| id | name   | sex  | age  | phone | address  |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br><span class="line">|  1 | aaaa   | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe | m    |   20 | 10010 | tangshan |</span><br><span class="line">+----+--------+------+------+-------+----------+</span><br></pre></td></tr></table></figure></p><p><code>模糊匹配</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">范例：包含a字母的人的姓名</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> name like <span class="string">'%a%'</span>;</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">| id | name    | sex  | age  | phone | address  |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">|  1 | aaaa    | m    |   30 | 10086 | beijing  |</span><br><span class="line">|  2 | daizhe  | m    |   20 | 10010 | tangshan |</span><br><span class="line">|  3 | laowang | m    |   18 | NULL  | tangshan |</span><br><span class="line">+----+---------+------+------+-------+----------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">范例：以a开头的人的姓名</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> name like <span class="string">'a%'</span>;</span><br></pre></td></tr></table></figure></p><p><code>正则表达式</code>rlike:正则表达式，索引失效，不建议使用<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">范例：使用正则表达式，匹配以a开头的人姓名</span><br><span class="line">MariaDB [studentdb]&gt; select * from student <span class="built_in">where</span> name rlike <span class="string">'^a'</span>;</span><br><span class="line">+----+------+------+------+-------+---------+</span><br><span class="line">| id | name | sex  | age  | phone | address |</span><br><span class="line">+----+------+------+------+-------+---------+</span><br><span class="line">|  1 | aaaa | m    |   30 | 10086 | beijing |</span><br><span class="line">+----+------+------+------+-------+---------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>如果执行结果由报警<br>可以执行show warnings; 查看报警信息  </p><p><code>去重distinct</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">范例：显示所有的性别，但不显示重复的性别信息</span><br><span class="line">MariaDB [studentdb]&gt; select distinct sex from student;</span><br><span class="line">+------+</span><br><span class="line">| sex  |</span><br><span class="line">+------+</span><br><span class="line">| m    |</span><br><span class="line">+------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p>范例：将范例数据信息导入数据库<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># mysql &lt; hellodb_innodb.sql </span></span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| hellodb            |</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; show tables;</span><br><span class="line">+-------------------+</span><br><span class="line">| Tables_in_hellodb |</span><br><span class="line">+-------------------+</span><br><span class="line">| classes           |</span><br><span class="line">| coc               |</span><br><span class="line">| courses           |</span><br><span class="line">| scores            |</span><br><span class="line">| students          |</span><br><span class="line">| teachers          |</span><br><span class="line">| toc               |</span><br><span class="line">+-------------------+</span><br></pre></td></tr></table></figure></p><p><code>group分组</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line">范例：统计一下班内所有的男生的平均年龄和女生的平均年龄</span><br><span class="line">  按性别分组</span><br><span class="line"></span><br><span class="line">  显示整个表有多少条记录</span><br><span class="line">MariaDB [hellodb]&gt; select count(*) from students;</span><br><span class="line">+----------+</span><br><span class="line">| count(*) |</span><br><span class="line">+----------+</span><br><span class="line">|       25 |</span><br><span class="line">+----------+</span><br><span class="line">  </span><br><span class="line">  按性别统计男生的个数和女生的个数 (gender是字段性别的意思)</span><br><span class="line">MariaDB [hellodb]&gt; select gender as 性别,count(*) as 人数 from students group by gender;</span><br><span class="line">+--------+--------+</span><br><span class="line">| 性别   | 人数   |</span><br><span class="line">+--------+--------+</span><br><span class="line">| F      |     10 |</span><br><span class="line">| M      |     15 |</span><br><span class="line">+--------+--------+</span><br><span class="line"></span><br><span class="line">统计平均年龄：函数 avg</span><br><span class="line">MariaDB [hellodb]&gt; select gender,avg(age) from students group by gender;+--------+----------+</span><br><span class="line">| gender | avg(age) |</span><br><span class="line">+--------+----------+</span><br><span class="line">| F      |  19.0000 |</span><br><span class="line">| M      |  33.0000 |</span><br><span class="line">+--------+----------+</span><br><span class="line"></span><br><span class="line">注意：后面 跟了group by 子句 ，在select 后面仅能出现两种内容，分组字段本身和聚合函数</span><br></pre></td></tr></table></figure></p><p><code>having</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">仅统计男生的平均年龄（在group by 后面加条件不能使用<span class="built_in">where</span> 要使用having 来判断条件）</span><br><span class="line">  先分组再过滤（先分完组再进行过滤）</span><br><span class="line">MariaDB [hellodb]&gt; select gender,avg(age) from students group by gender having gender = <span class="string">'M'</span>;</span><br><span class="line">+--------+----------+</span><br><span class="line">| gender | avg(age) |</span><br><span class="line">+--------+----------+</span><br><span class="line">| M      |  33.0000 |</span><br><span class="line">+--------+----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">  先过滤再分组(从过滤出的结果中再分组)</span><br><span class="line">MariaDB [hellodb]&gt; select gender,avg(age) from students <span class="built_in">where</span> gender= <span class="string">'M'</span> group by gender;</span><br><span class="line">+--------+----------+</span><br><span class="line">| gender | avg(age) |</span><br><span class="line">+--------+----------+</span><br><span class="line">| M      |  33.0000 |</span><br><span class="line">+--------+----------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure></p><p><code>多次分组</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">范例：针对不同性别不班级分别统计，每个班不同性别的最大年龄</span><br><span class="line">比如：一般的男生最大年龄，一般的女生的最大年龄，二班的男生的最大年龄和最大女生的年龄...</span><br><span class="line"></span><br><span class="line">max（）函数</span><br><span class="line"></span><br><span class="line">MariaDB [hellodb]&gt; select classid,gender,max(age) from students group by classid,gender;</span><br><span class="line">+---------+--------+----------+</span><br><span class="line">| classid | gender | max(age) |</span><br><span class="line">+---------+--------+----------+</span><br><span class="line">|    NULL | M      |      100 |</span><br><span class="line">|       1 | F      |       20 |</span><br><span class="line">|       1 | M      |       22 |</span><br><span class="line">|       2 | M      |       53 |</span><br><span class="line">|       3 | F      |       19 |</span><br><span class="line">|       3 | M      |       26 |</span><br><span class="line">|       4 | M      |       32 |</span><br><span class="line">|       5 | M      |       46 |</span><br><span class="line">|       6 | F      |       22 |</span><br><span class="line">|       6 | M      |       23 |</span><br><span class="line">|       7 | F      |       19 |</span><br><span class="line">|       7 | M      |       23 |</span><br><span class="line">+---------+--------+----------+</span><br></pre></td></tr></table></figure></p><p><code>order by根据指定的字段对查询结果进行排序</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line">排序：默认为从小到大排序</span><br><span class="line">范例：拿学生的年龄进行排序</span><br><span class="line">MariaDB [hellodb]&gt; select * from students order by age;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |</span><br><span class="line">|    14 | Lu Wushuang   |  17 | F      |       3 |      NULL |</span><br><span class="line">|    19 | Xue Baochai   |  18 | F      |       6 |      NULL |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |</span><br><span class="line"></span><br><span class="line">倒序排：从大到小排序</span><br><span class="line">MariaDB [hellodb]&gt; select * from students order by age desc;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |</span><br><span class="line">|     3 | Xie Yanke     |  53 | M      |       2 |        16 |</span><br><span class="line">|     6 | Shi Qing      |  46 | M      |       5 |      NULL |</span><br><span class="line">|    13 | Tian Boguang  |  33 | M      |       2 |      NULL |</span><br><span class="line"></span><br><span class="line">排序完可以查看年龄最小的3个</span><br><span class="line">MariaDB [hellodb]&gt; select * from students order by age <span class="built_in">limit</span> 3;</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name        | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+</span><br><span class="line">|     8 | Lin Daiyu   |  17 | F      |       7 |      NULL |</span><br><span class="line">|    14 | Lu Wushuang |  17 | F      |       3 |      NULL |</span><br><span class="line">|    19 | Xue Baochai |  18 | F      |       6 |      NULL |</span><br><span class="line">+-------+-------------+-----+--------+---------+-----------+</span><br><span class="line"></span><br><span class="line">跳过前第3个取后续4个</span><br><span class="line">ariaDB [hellodb]&gt; select * from students order by age <span class="built_in">limit</span> 3,4;</span><br><span class="line">+-------+--------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name         | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+--------------+-----+--------+---------+-----------+</span><br><span class="line">|    12 | Wen Qingqing |  19 | F      |       1 |      NULL |</span><br><span class="line">|    10 | Yue Lingshan |  19 | F      |       3 |      NULL |</span><br><span class="line">|     7 | Xi Ren       |  19 | F      |       3 |      NULL |</span><br><span class="line">|    15 | Duan Yu      |  19 | M      |       4 |      NULL |</span><br><span class="line">+-------+--------------+-----+--------+---------+-----------+</span><br></pre></td></tr></table></figure></p><p><code>多列排序</code><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">范例：先按班级排序，如果同一个班，再班级相同的情况下，在对年龄排序（班级为正序，年龄为倒序）</span><br><span class="line">MariaDB [hellodb]&gt; select * from students order by classid ,age desc;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |</span><br><span class="line"></span><br><span class="line"> 空值的优先级高，可以使得null值，放到最后</span><br><span class="line">MariaDB [hellodb]&gt; select * from students order by -classid desc;</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |</span><br><span class="line">|    22 | Xiao Qiao     |  20 | F      |       1 |      NULL |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |</span><br><span class="line">|    12 | Wen Qingqing  |  19 | F      |       1 |      NULL |</span><br><span class="line">.......</span><br><span class="line">|     8 | Lin Daiyu     |  17 | F      |       7 |      NULL |</span><br><span class="line">|    24 | Xu Xian       |  27 | M      |    NULL |      NULL |</span><br><span class="line">|    25 | Sun Dasheng   | 100 | M      |    NULL |      NULL |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br></pre></td></tr></table></figure></p><p>练习：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">(2) 以ClassID为分组依据，显示每组的平均年龄 </span><br><span class="line">(3) 显示第2题中平均年龄大于30的分组及平均年龄 </span><br><span class="line">MariaDB [hellodb]&gt; select classid,avg(age) from students group by classd having avg(age) &gt; 30;</span><br><span class="line">+---------+----------+</span><br><span class="line">| classid | avg(age) |</span><br><span class="line">+---------+----------+</span><br><span class="line">|    NULL |  63.5000 |</span><br><span class="line">|       2 |  36.0000 |</span><br><span class="line">|       5 |  46.0000 |</span><br><span class="line">+---------+----------+</span><br><span class="line">3 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">(7) 查询年龄大于等于20岁，小于等于25岁的同学的信</span><br><span class="line">方法1：</span><br><span class="line">MariaDB [hellodb]&gt; select * from students <span class="built_in">where</span> age between 20 and 25;+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |</span><br><span class="line">|    21 | Huang Yueying |  22 | F      |       6 |      NULL |</span><br><span class="line"></span><br><span class="line">方法2：</span><br><span class="line">MariaDB [hellodb]&gt; select * from students <span class="built_in">where</span> age &gt;=20 and age &lt;=25;+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">| StuID | Name          | Age | Gender | ClassID | TeacherID |</span><br><span class="line">+-------+---------------+-----+--------+---------+-----------+</span><br><span class="line">|     1 | Shi Zhongyu   |  22 | M      |       2 |         3 |</span><br><span class="line">|     2 | Shi Potian    |  22 | M      |       1 |         7 |</span><br><span class="line">|     9 | Ren Yingying  |  20 | F      |       6 |      NULL |</span><br><span class="line">|    11 | Yuan Chengzhi |  23 | M      |       6 |      NULL |</span><br><span class="line">|    16 | Xu Zhu        |  21 | M      |       1 |      NULL |</span><br><span class="line">|    17 | Lin Chong     |  25 | M      |       4 |      NULL |</span><br><span class="line">|    18 | Hua Rong      |  23 | M      |       7 |      NULL |</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;mysql之select单表操作&quot;&gt;&lt;a href=&quot;#mysql之select单表操作&quot; class=&quot;headerlink&quot; title=&quot;mysql之select单表操作&quot;&gt;&lt;/a&gt;mysql之select单表操作&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/mysql之select单表操作/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://daizhe.net.cn/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://daizhe.net.cn/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysql数据库和表管理理论及实操</title>
    <link href="https://daizhe.net.cn/2019/02/20/mysql%E6%95%B0%E6%8D%AE%E5%BA%93%E5%92%8C%E8%A1%A8%E7%AE%A1%E7%90%86%E7%90%86%E8%AE%BA%E5%8F%8A%E5%AE%9E%E6%93%8D/"/>
    <id>https://daizhe.net.cn/2019/02/20/mysql数据库和表管理理论及实操/</id>
    <published>2019-02-20T06:36:17.229Z</published>
    <updated>2019-02-20T07:18:25.689Z</updated>
    
    <content type="html"><![CDATA[<h1 id="mysql数据库和表管理理论及实操"><a href="#mysql数据库和表管理理论及实操" class="headerlink" title="mysql数据库和表管理理论及实操"></a>mysql数据库和表管理理论及实操</h1><p><img src="/2019/02/20/mysql数据库和表管理理论及实操/标题.gif" alt=""><br><a id="more"></a></p><h1 id="理论"><a href="#理论" class="headerlink" title="理论"></a>理论</h1><h2 id="数据库操作"><a href="#数据库操作" class="headerlink" title="数据库操作"></a><code>数据库操作</code></h2><p>创建数据库：<br>&ensp;&ensp;CREATE DATABASE|SCHEMA [IF NOT EXISTS] ‘DB_NAME’;<br>&ensp;&ensp;CHARACTER SET ‘character set name’<br>&ensp;&ensp;COLLATE ‘collate name’<br>删除数据库<br>&ensp;&ensp;DROP DATABASE|SCHEMA [IF EXISTS] ‘DB_NAME’;<br>查看支持所有字符集：<br>&ensp;&ensp;SHOW CHARACTER SET;<br>查看支持所有排序规则：<br>&ensp;&ensp;SHOW COLLATION;<br>获取命令使用帮助：<br>&ensp;&ensp;mysql&gt; HELP KEYWORD;<br>查看数据库列表：<br>&ensp;&ensp;mysql&gt; SHOW DATABASES;  </p><h2 id="表"><a href="#表" class="headerlink" title="表"></a>表</h2><p>表：二维关系<br>设计表：遵循规范<br>定义：字段，索引<br>&ensp;&ensp;字段：字段名，字段数据类型，修饰符<br>&ensp;&ensp;约束，索引：应该创建在经常用作查询条件的字段上    </p><h2 id="创建表"><a href="#创建表" class="headerlink" title="创建表"></a>创建表</h2><p>创建表：CREATE TABLE<br>(1) 直接创建<br>(2) 通过查询现存表创建；新表会被直接插入查询而来的数据<br>&ensp;&ensp;CREATE [TEMPORARY临时表] TABLE [IF NOT EXISTS存在则不创建] tbl_name    [(create_definition,…)创建表的定义]    [table_options] [partition_options]     select_statement<br>(3) 通过复制现存的表的表结构创建，但不复制数据<br>&ensp;&ensp;CREATE [TEMPORARY] TABLE [IF NOT EXISTS] tbl_name { LIKE old_tbl_name | (LIKE old_tbl_name) }<br>注意：<br>&ensp;&ensp;Storage Engine是指表类型，也即在表创建时指明其使用的存储引擎，同一 库中不同表可以使用不同的存储引擎<br>&ensp;&ensp;同一个库中表建议要使用同一种存储引擎类型   </p><p>CREATE TABLE [IF NOT EXISTS] ‘tbl_name’ (col1 type1 修饰符,  col2 type2 修饰符, …)<br>字段信息<br>&ensp;&ensp;col type1<br>&ensp;&ensp;PRIMARY KEY(col1,…)<br>&ensp;&ensp;INDEX(col1, …)<br>&ensp;&ensp;UNIQUE KEY(col1, …)<br>表选项：<br>ENGINE [=] engine_name<br>&ensp;&ensp;SHOW ENGINES;查看支持的engine类型<br>ROW_FORMAT [=] {DEFAULT|DYNAMIC|FIXED|COMPRESSED|REDUNDANT|  COMPACT}<br>获取帮助：mysql&gt; HELP CREATE TABLE;    </p><h2 id="表操作"><a href="#表操作" class="headerlink" title="表操作"></a>表操作</h2><p>查看所有的引擎：SHOW ENGINES<br>查看表：SHOW TABLES [FROM db_name]<br>查看表结构：DESC [db_name.]tb_name<br>删除表：DROP TABLE [IF EXISTS] tb_name<br>查看表创建命令：SHOW CREATE TABLE tbl_name<br>查看表状态：SHOW TABLE STATUS LIKE ‘tbl_name’<br>查看库中所有表状态：SHOW TABLE STATUS FROM db_name   </p><h2 id="数据类型"><a href="#数据类型" class="headerlink" title="数据类型"></a>数据类型</h2><p>数据类型：<br>&ensp;&ensp;数据长什么样<br>&ensp;&ensp;数据需要多少空间来存放   </p><p>系统内置数据类型和用户定义数据类型<br>MySql支持多种列类型：<br>&ensp;&ensp;数值类型<br>&ensp;&ensp;日期/时间类型<br>&ensp;&ensp;字符串(字符)类型<br>&ensp;&ensp;<a href="https://dev.mysql.com/doc/refman/5.5/en/data-types.html" target="_blank" rel="noopener">https://dev.mysql.com/doc/refman/5.5/en/data-types.html</a>   </p><p>选择正确的数据类型对于获得高性能至关重要，三大原则：<br>&ensp;&ensp;更小的通常更好，尽量使用可正确存储数据的最小数据类型<br>&ensp;&ensp;简单就好，简单数据类型的操作通常需要更少的CPU周期<br>&ensp;&ensp;尽量避免NULL，包含为NULL的列，对MySQL更难优化   </p><p><img src="/2019/02/20/mysql数据库和表管理理论及实操/mysql源码编译多实例和数据库管理/2.png" alt=""></p><p><code>数据类型</code><br><code>1、整型</code><br>&ensp;&ensp;tinyint(m)  1个字节 范围(-128~127)<br>&ensp;&ensp;smallint(m)  2个字节 范围(-32768~32767)<br>&ensp;&ensp;mediumint(m) 3个字节 范围(-8388608~8388607)<br>&ensp;&ensp;int(m)   4个字节 范围(-2147483648~2147483647)<br>&ensp;&ensp;bigint(m)  8个字节 范围(+-9.22*10的18次方)<br>加了unsigned，则最大值翻倍，如：tinyint unsigned的取值范围为(0~255) int(m)里的m是表示SELECT查询结果集中的显示宽度，并不影响实际的取值范 围，规定了MySQL的一些交互工具（例如MySQL命令行客户端）用来显示字符 的个数。对于存储和计算来说，Int(1)和Int(20)是相同的<br>BOOL，BOOLEAN：布尔型，是TINYINT(1)的同义词。zero值被视为假， 非zero值视为真 </p><p><code>2、浮点型(float和double)，近似值</code><br>&ensp;&ensp;float(m,d) 单精度浮点型 8位精度(4字节) m总个数，d小数位<br>&ensp;&ensp;double(m,d) 双精度浮点型16位精度(8字节) m总个数，d小数位<br>&ensp;&ensp;设一个字段定义为float(6,3)，如果插入一个数123.45678,实际数据库里存 的是123.457，但总个数还以实际为准，即6位    </p><p><code>3、定点数</code><br>&ensp;&ensp;在数据库中存放的是精确值,存为十进制<br>&ensp;&ensp;decimal(m,d) 参数m&lt;65 是总个数，d&lt;30且 d&lt;m 是小数位<br>&ensp;&ensp;MySQL5.0和更高版本将数字打包保存到一个二进制字符串中（每4个字节存 9个数字）。例如，decimal(18,9)小数点两边将各存储9个数字，一共使用9 个字节：小数点前的数字用4个字节，小数点后的数字用4个字节，小数点本 身占1个字节<br>浮点类型在存储同样范围的值时，通常比decimal使用更少的空间。float使 用4个字节存储。double占用8个字节<br>&ensp;&ensp;因为需要额外的空间和计算开销，所以应该尽量只在对小数进行精确计算时 才使用decimal——例如存储财务数据。但在数据量比较大的时候，可以考 虑使用bigint代替decimal  </p><p>4、字符串(char,varchar,_text)<br>&ensp;&ensp;char(n)  固定长度，最多255个字符<br>&ensp;&ensp;varchar(n) 可变长度，最多65535个字符<br>&ensp;&ensp;tinytext 可变长度，最多255个字符<br>&ensp;&ensp;text  可变长度，最多65535个字符<br>&ensp;&ensp;mediumtext  可变长度，最多2的24次方-1个字符<br>&ensp;&ensp;longtext 可变长度，最多2的32次方-1个字符<br>&ensp;&ensp;BINARY(M)  固定长度，可存二进制或字符，长度为0-M字节<br>&ensp;&ensp;VARBINARY(M) 可变长度，可存二进制或字符，允许长度为0-M字节<br>&ensp;&ensp;内建类型：ENUM枚举, SET集合    </p><p><code>char和varchar：</code><br>&ensp;&ensp;1.char(n) 若存入字符数小于n，则以空格补于其后，查询之时再将空格去掉， 所以char类型存储的字符串末尾不能有空格，varchar不限于此<br>&ensp;&ensp;2.char(n) 固定长度，char(4)不管是存入几个字符，都将占用4个字节，varchar 是存入的实际字符数+1个字节（n&lt; n&gt;255)，所以varchar(4),存入3个字符将 占用4个字节<br>&ensp;&ensp;3.char类型的字符串检索速度要比varchar类型的快<br><code>varchar和text：</code><br>&ensp;&ensp;1.varchar可指定n，text不能指定，内部存储varchar是存入的实际字符数+1个 字节（n&lt; n&gt;255)，text是实际字符数+2个字节  。<br>&ensp;&ensp;2.text类型不能有默认值<br>&ensp;&ensp;3.varchar可直接创建索引，text创建索引要指定前多少个字符。varchar查询速 度快于text   </p><p><code>5.二进制数据：BLOB</code><br>&ensp;&ensp;BLOB和text存储方式不同，TEXT以文本方式存储，英文存储区分大小写，而Blob是以二进制方式存储，不分大小写<br>&ensp;&ensp;BLOB存储的数据只能整体读出<br>&ensp;&ensp;TEXT可以指定字符集，BLOB不用指定字符集   </p><p><code>6.日期时间类型</code><br>&ensp;&ensp;date 日期 ‘2008-12-2’<br>&ensp;&ensp;time 时间 ‘12:25:36’<br>&ensp;&ensp;datetime 日期时间 ‘2008-12-2 22:06:44’<br>&ensp;&ensp;timestamp 自动存储记录修改时间<br>&ensp;&ensp;YEAR(2), YEAR(4)：年份<br>timestamp字段里的时间数据会随其他字段修改的时候自动刷新，这个数 据类型的字段可以存放这条记录最后被修改的时间   </p><h2 id="修饰符"><a href="#修饰符" class="headerlink" title="修饰符"></a><code>修饰符</code></h2><p>所有类型：<br>&ensp;&ensp;NULL       数据列可包含NULL值<br>&ensp;&ensp;NOT NULL   数据列不允许包含NULL值<br>&ensp;&ensp;DEFAULT    默认值<br>&ensp;&ensp;PRIMARY KEY    主键<br>&ensp;&ensp;UNIQUE KEY     唯一键<br>&ensp;&ensp;CHARACTER SET name 指定一个字符集<br>数值型<br>&ensp;&ensp;AUTO_INCREMENT     自动递增，适用于整数类型<br>&ensp;&ensp;UNSIGNED    无符号   </p><h2 id="表操作-1"><a href="#表操作-1" class="headerlink" title="表操作"></a>表操作</h2><p>DROP TABLE [IF EXISTS] ‘tbl_name’;<br>ALTER TABLE ‘tbl_name’<br>&ensp;&ensp;字段：<br>&ensp;&ensp;&ensp;&ensp;添加字段：add<br>&ensp;&ensp;&ensp;&ensp;ADD col1 data_type [FIRST|AFTER col_name]<br>&ensp;&ensp;&ensp;&ensp;删除字段：drop<br>&ensp;&ensp;&ensp;&ensp;修改字段：   alter（默认值）, change（字段名）, modify（字段属性）<br>&ensp;&ensp;索引:<br>&ensp;&ensp;&ensp;&ensp;添加索引：add index<br>&ensp;&ensp;&ensp;&ensp;删除索引：drop index<br>&ensp;&ensp;表选项<br>&ensp;&ensp;&ensp;&ensp;修改:<br>查看表上的索引：SHOW INDEXES FROM [db_name.]tbl_name;<br>查看帮助：Help ALTER TABLE  </p><h2 id="修改表示例"><a href="#修改表示例" class="headerlink" title="修改表示例"></a>修改表示例</h2><p>ALTER TABLE students ADD gender ENUM(‘m’,’f’)<br>ALETR TABLE students CHANGE id sid int UNSIGNED NOT NULL PRIMARY KEY;<br>ALTER TABLE students ADD UNIQUE KEY(name);<br>ALTER TABLE students  ADD INDEX(age);<br>DESC students;<br>SHOW INDEXES FROM students;<br>ALTER TABLE students DROP age;   </p><h2 id="DML语句"><a href="#DML语句" class="headerlink" title="DML语句"></a><code>DML语句</code></h2><p><code>DML: INSERT增加, DELETE删除, UPDATE  修改</code><br>INSERT：<br>一次插入一行或多行数据<br>语法<br>INSERT [L OW_PRIORITY | DELAYED | HIGH_PRIORITY]<br>[IGNORE]      [INTO] tbl_name [(col_name,…)]<br>{VALUES | VALUE} ({expr | DEFAULT},…),(…),…<br>[ ON DUPLICATE KEY UPDATE 如果重复更新之<br>col_name=expr<br>[, col_name=expr] … ]    </p><p>简化写法：  INSERT tbl_name [(col1,…)] VALUES (val1,…), (val21,…)   </p><p>INSERT [LOW_PRIORITY | DELAYED | HIGH_PRIORITY] [IGNORE]<br>SET col_name={expr | DEFAULT}, …<br>[ ON DUPLICATE KEY UPDATE<br>col_name=expr<br>[, col_name=expr] … ]   </p><p>INSERT [LOW_PRIORITY | HIGH_PRIORITY] [IGNORE]<br>[INTO] tbl_name [(col_name,…)]<br>SELECT …<br>[ ON DUPLICATE KEY UPDATE<br>col_name=expr<br>[, col_name=expr] … ]   </p><p>UPDATE：<br>UPDATE [LOW_PRIORITY] [IGNORE] table_reference<br>SET col_name1={expr1|DEFAULT} [, col_name2={expr2|DEFAULT}] …<br>[WHERE where_condition]<br>[ORDER BY …]<br>[LIMIT row_count]<br>注意：一定要有限制条件，否则将修改所有行的指定字段<br>限制条件：<br>WHERE<br>LIMIT<br>Mysql 选项：-U|–safe-updates| –i-am-a-dummy   </p><p>DELETE:<br>DELETE [LOW_PRIORITY] [QUICK] [IGNORE] FROM tbl_name<br>[WHERE where_condition]<br>[ORDER BY …]<br>[LIMIT row_count]<br>可先排序再指定删除的行数<br>注意：一定要有限制条件，否则将清空表中的所有数据<br>限制条件：<br>WHERE<br>LIMIT<br>TRUNCATE TABLE tbl_name; 清空表   </p><h2 id="DQL语句"><a href="#DQL语句" class="headerlink" title="DQL语句"></a>DQL语句</h2><p>SELECT<br>[ALL | DISTINCT | DISTINCTROW ]<br>[SQL_CACHE | SQL_NO_CACHE]<br>select_expr [, select_expr …]<br>[FROM table_references<br>[WHERE where_condition]<br>[GROUP BY {col_name | expr | position}<br>[ASC | DESC], … [WITH ROLLUP]]<br>[HAVING where_condition]<br>[ORDER BY {col_name | expr | position}<br>[ASC | DESC], …]<br>[LIMIT {[offset,] row_count | row_count OFFSET offset}<br>[FOR UPDATE | LOCK IN SHARE MODE]   </p><h2 id="SELECT"><a href="#SELECT" class="headerlink" title="SELECT"></a><code>SELECT</code></h2><p>字段显示可以使用别名：<br>&ensp;&ensp;col1 AS alias1, col2 AS alias2, …   </p><p>WHERE子句：指明过滤条件以实现“选择”的功能：<br>&ensp;&ensp;过滤条件：布尔型表达式<br>&ensp;&ensp;算术操作符：+, -, *, /, %<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [hellodb]&gt; select 2*3;</span><br><span class="line">+-----+</span><br><span class="line">| 2*3 |</span><br><span class="line">+-----+</span><br><span class="line">|   6 |</span><br><span class="line">+-----+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">不等于：&lt;&gt; 或者 !=</span><br><span class="line">（显示学生性别不为女的）</span><br><span class="line">MariaDB [hellodb]&gt; select * from students <span class="built_in">where</span> gender &lt;&gt; <span class="string">'F'</span>;</span><br></pre></td></tr></table></figure></p><p>&ensp;&ensp;比较操作符：=,&lt;=&gt;（相等或都为空）, &lt;&gt;, !=(非标准SQL), &gt;, &gt;=, &lt;, &lt;=<br>&ensp;&ensp;BETWEEN min_num AND max_num<br>&ensp;&ensp;IN (element1, element2, …)<br>&ensp;&ensp;IS NULL<br>&ensp;&ensp;IS NOT NULL   </p><p>DISTINCT 去除重复列<br>&ensp;&ensp;SELECT DISTINCT  gender FROM students; </p><p>like:<br>&ensp;&ensp;% 任意长度的任意字符<br>&ensp;&ensp;_ 任意单个字符   </p><p>RLIKE：正则表达式，索引失效，不建议使用<br>REGEXP：匹配字符串可用正则表达式书写模式，同上<br>逻辑操作符： NOT AND OR XO  </p><p><code>GROUP：</code>根据指定的条件把查询结果进行“分组”以用于做“聚合”运算 avg(), max(), min(), count(), sum() 总和<br>HAVING: 对分组聚合运算后的结果指定过滤条件   </p><p>ORDER BY: 根据指定的字段对查询结果进行排序<br>&ensp;&ensp;升序：ASC<br>&ensp;&ensp;降序：DESC<br>LIMIT [[offset,]row_count]：对查询的结果进行输出行数数量限制<br>对查询结果中的数据请求施加“锁”<br>&ensp;&ensp;FOR UPDATE: 写锁，独占或排它锁，只有一个读和写<br>&ensp;&ensp;LOCK IN SHARE MODE: 读锁，共享锁，同时多个读</p><h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><p>DESC students;<br>INSERT INTO students VALUES(1,’tom’，’m’),(2,’alice’,’f’);<br>INSERT INTO students(id,name) VALUES(3,’jack’),(4,’allen’);<br>SELECT <em> FROM students WHERE id &lt; 3;<br>SELECT </em> FROM students WHERE gender=’m’;<br>SELECT <em> FROM students WHERE gender IS NULL;<br>SELECT </em> FROM students WHERE gender IS NOT NULL;<br>SELECT <em> FROM students ORDER BY name DESC LIMIT 2;<br>SELECT </em> FROM students ORDER BY name DESC LIMIT 1,2;<br>SELECT <em> FROM students WHERE id &gt;=2 and id &lt;=4<br>SELECT </em> FROM students WHERE BETWEEN 2 AND 4<br>SELECT <em> FROM students WHERE name LIKE ‘t%’<br>SELECT </em> FROM students WHERE name RLIKE ‘.<em>[lo].</em>‘;<br>SELECT id stuid,name as stuname FROM students  </p><h2 id="多表操作"><a href="#多表操作" class="headerlink" title="多表操作"></a>多表操作</h2><h2 id="多表查询"><a href="#多表查询" class="headerlink" title="多表查询"></a>多表查询</h2><p>交叉连接：笛卡尔乘积<br>内连接：<br>&ensp;&ensp;等值连接：让表之间的字段以“等值”建立连接关系；<br>&ensp;&ensp;不等值连接<br>&ensp;&ensp;自然连接:去掉重复列的等值连接<br>&ensp;&ensp;自连接<br>外连接：<br>&ensp;&ensp;左外连接：   FROM tb1 LEFT JOIN tb2 ON tb1.col=tb2.col<br>&ensp;&ensp;右外连接:    FROM tb1 RIGHT JOIN tb2 ON tb1.col=tb2.col   </p><p>子查询：在查询语句嵌套着查询语句，性能较差<br>&ensp;&ensp;基于某语句的查询结果再次进行的查询<br>用在WHERE子句中的子查询<br>&ensp;&ensp;用于比较表达式中的子查询；子查询仅能返回单个值<br>&ensp;&ensp;&ensp;&ensp;SELECT Name,Age FROM students WHERE Age&gt;(SELECT avg(Age) FROM students);<br>&ensp;&ensp;用于IN中的子查询：子查询应该单键查询并返回一个或多个值从构成列表<br>&ensp;&ensp;&ensp;&ensp;SELECT Name,Age FROM students WHERE Age IN (SELECT Age FROM teachers);<br>&ensp;&ensp;用于EXISTS</p><p><img src="/2019/02/20/mysql数据库和表管理理论及实操/mysql源码编译多实例和数据库管理/1.png" alt=""></p><p>多表查询<br>用于FROM子句中的子查询<br>使用格式：<br>SELECT tb_alias.col1,… FROM (SELECT clause) AS tb_alias WHERE Clause;   </p><p>示例：  SELECT s.aage,s.ClassID FROM (SELECT avg(Age) AS aage,ClassID FROM students WHERE ClassID IS NOT NULL GROUP BY ClassID) AS s WHERE s.aage&gt;30; </p><p>联合查询：UNION<br>SELECT Name,Age FROM students UNION SELECT Name,Age FROM teachers; </p><h1 id="实操"><a href="#实操" class="headerlink" title="实操"></a>实操</h1><h2 id="创建数据库"><a href="#创建数据库" class="headerlink" title="创建数据库"></a>创建数据库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br></pre></td><td class="code"><pre><span class="line">查看目前已经创建好的数据库列表</span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |  特殊的数据库，并非再物理磁盘中，再内存中，再数据目录中看不到</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">4 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看具体命令的帮助说明</span><br><span class="line">MariaDB [(none)]&gt; <span class="built_in">help</span> create database;  （如果目标数据库不存在，则创建，如果存在则不创建）</span><br><span class="line"></span><br><span class="line">创建数据库</span><br><span class="line">MariaDB [(none)]&gt; cerate database +数据库名</span><br><span class="line"></span><br><span class="line">查看系统支持的字符集</span><br><span class="line">MariaDB [(none)]&gt; show character <span class="built_in">set</span>;</span><br><span class="line"></span><br><span class="line">创建数据库（数据库，表的集合）</span><br><span class="line">MariaDB [(none)]&gt; create database testdb;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">| testdb             |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /var/lib/mysql/testdb/db.opt </span></span><br><span class="line">default-character-set=latin1                默认的字符集</span><br><span class="line">default-collation=latin1_swedish_ci         排序规则</span><br><span class="line"></span><br><span class="line">查看系统自带的排序规则</span><br><span class="line">MariaDB [(none)]&gt; show collation;</span><br><span class="line">+--------------------------+----------+-----+---------+----------+---------+</span><br><span class="line">| Collation                | Charset  | Id  | Default | Compiled | Sortlen |</span><br><span class="line">+--------------------------+----------+-----+---------+----------+---------+</span><br><span class="line">| big5_chinese_ci          | big5     |   1 | Yes     | Yes      |       1 |</span><br><span class="line">| big5_bin                 | big5     |  84 |         | Yes      |       1 |</span><br><span class="line"></span><br><span class="line">查看数据库使用的字符集</span><br><span class="line">MariaDB [(none)]&gt; show create database testdb;</span><br><span class="line">+----------+-------------------------------------------------------------------+</span><br><span class="line">| Database | Create Database                                                   |</span><br><span class="line">+----------+-------------------------------------------------------------------+</span><br><span class="line">| testdb   | CREATE DATABASE `testdb` /*!40100 DEFAULT CHARACTER SET latin1 */ |</span><br><span class="line">+----------+-------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">创建数据库并指定此数据库使用的字符集</span><br><span class="line">MariaDB [(none)]&gt; create database db_utf8mb4 character <span class="built_in">set</span>=utf8mb4;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show create database db_utf8mb4;</span><br><span class="line">+------------+------------------------------------------------------------------------+</span><br><span class="line">| Database   | Create Database                                                        |</span><br><span class="line">+------------+------------------------------------------------------------------------+</span><br><span class="line">| db_utf8mb4 | CREATE DATABASE `db_utf8mb4` /*!40100 DEFAULT CHARACTER SET utf8mb4 */ |</span><br><span class="line">+------------+------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># cat /var/lib/mysql/db_utf8mb4/db.opt </span></span><br><span class="line">default-character-set=utf8mb4</span><br><span class="line">default-collation=utf8mb4_general_ci</span><br></pre></td></tr></table></figure><p>查看当前使用的信息包括字符集<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; status</span><br><span class="line">--------------</span><br><span class="line">mysql  Ver 15.1 Distrib 5.5.60-MariaDB, <span class="keyword">for</span> Linux (x86_64) using readline 5.1</span><br><span class="line"></span><br><span class="line">Connection id:4</span><br><span class="line">Current database:</span><br><span class="line">Current user:root@localhost</span><br><span class="line">SSL:Not <span class="keyword">in</span> use</span><br><span class="line">Current pager:stdout</span><br><span class="line">Using outfile:<span class="string">''</span></span><br><span class="line">Using delimiter:;</span><br><span class="line">Server:MariaDB</span><br><span class="line">Server version:5.5.60-MariaDB MariaDB Server</span><br><span class="line">Protocol version:10</span><br><span class="line">Connection:Localhost via UNIX socket</span><br><span class="line">Server characterset:latin1</span><br><span class="line">Db     characterset:latin1</span><br><span class="line">Client characterset:utf8</span><br><span class="line">Conn.  characterset:utf8</span><br><span class="line">UNIX socket:/var/lib/mysql/mysql.sock</span><br><span class="line">Uptime:58 min 31 sec</span><br><span class="line"></span><br><span class="line">Threads: 1  Questions: 16  Slow queries: 0  Opens: 4  Flush tables: 2  Open tables: 30  Queries per second avg: 0.004</span><br><span class="line">--------------</span><br></pre></td></tr></table></figure></p><h2 id="管理数据库"><a href="#管理数据库" class="headerlink" title="管理数据库"></a>管理数据库</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">删除数据库</span><br><span class="line">MariaDB [(none)]&gt; drop database testdb;</span><br><span class="line">Query OK, 0 rows affected (0.01 sec)</span><br><span class="line"></span><br><span class="line">MariaDB [(none)]&gt; show databases;</span><br><span class="line">+--------------------+</span><br><span class="line">| Database           |</span><br><span class="line">+--------------------+</span><br><span class="line">| information_schema |</span><br><span class="line">| db_utf8mb4         |</span><br><span class="line">| mysql              |</span><br><span class="line">| performance_schema |</span><br><span class="line">| <span class="built_in">test</span>               |</span><br><span class="line">+--------------------+</span><br><span class="line">5 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br></pre></td></tr></table></figure><h2 id="创建表-1"><a href="#创建表-1" class="headerlink" title="创建表"></a>创建表</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br></pre></td><td class="code"><pre><span class="line">创建一个模拟学生信息的数据库</span><br><span class="line">MariaDB [(none)]&gt; create database studentdb;</span><br><span class="line">Query OK, 1 row affected (0.00 sec)</span><br><span class="line">MariaDB [(none)]&gt; use studentdb</span><br><span class="line">Database changed</span><br><span class="line"></span><br><span class="line">MariaDB [studentdb]&gt; create table student (id int unsigned auto_increment primary key,name varchar(10) not null,sex enum(<span class="string">'f'</span>,<span class="string">'m'</span>) default <span class="string">'m'</span>,age tinyint unsigned ,phone char(11),address varchar(50));</span><br><span class="line">Query OK, 0 rows affected (0.02 sec)</span><br><span class="line"></span><br><span class="line">查看创建的表结构</span><br><span class="line">方法1：</span><br><span class="line">MariaDB [studentdb]&gt; desc student;</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| Field   | Type                | Null | Key | Default | Extra          |</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| id      | int(10) unsigned    | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name    | varchar(10)         | NO   |     | NULL    |                |</span><br><span class="line">| sex     | enum(<span class="string">'f'</span>,<span class="string">'m'</span>)       | YES  |     | m       |                |</span><br><span class="line">| age     | tinyint(3) unsigned | YES  |     | NULL    |                |</span><br><span class="line">| phone   | char(11)            | YES  |     | NULL    |                |</span><br><span class="line">| address | varchar(50)         | YES  |     | NULL    |                |</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">方法2：</span><br><span class="line">MariaDB [studentdb]&gt; show columns from student;</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| Field   | Type                | Null | Key | Default | Extra          |</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">| id      | int(10) unsigned    | NO   | PRI | NULL    | auto_increment |</span><br><span class="line">| name    | varchar(10)         | NO   |     | NULL    |                |</span><br><span class="line">| sex     | enum(<span class="string">'f'</span>,<span class="string">'m'</span>)       | YES  |     | m       |                |</span><br><span class="line">| age     | tinyint(3) unsigned | YES  |     | NULL    |                |</span><br><span class="line">| phone   | char(11)            | YES  |     | NULL    |                |</span><br><span class="line">| address | varchar(50)         | YES  |     | NULL    |                |</span><br><span class="line">+---------+---------------------+------+-----+---------+----------------+</span><br><span class="line">6 rows <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">常看定义表的步骤即定义表的详情</span><br><span class="line">MariaDB [studentdb]&gt; show create table student;</span><br><span class="line">+---------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| Table   | Create Table                                                                                                                                                                                                                                                                                                             |</span><br><span class="line">+---------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">| student | CREATE TABLE `student` (</span><br><span class="line">  `id` int(10) unsigned NOT NULL AUTO_INCREMENT,</span><br><span class="line">  `name` varchar(10) NOT NULL,</span><br><span class="line">  `sex` enum(<span class="string">'f'</span>,<span class="string">'m'</span>) DEFAULT <span class="string">'m'</span>,</span><br><span class="line">  `age` tinyint(3) unsigned DEFAULT NULL,</span><br><span class="line">  `phone` char(11) DEFAULT NULL,</span><br><span class="line">  `address` varchar(50) DEFAULT NULL,</span><br><span class="line">  PRIMARY KEY (`id`)</span><br><span class="line">) ENGINE=InnoDB DEFAULT CHARSET=latin1 |</span><br><span class="line">+---------+--------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看表的状态</span><br><span class="line">MariaDB [studentdb]&gt; show table status like <span class="string">'student'</span>\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">           Name: student</span><br><span class="line">         Engine: InnoDB  存储引擎</span><br><span class="line">        Version: 10</span><br><span class="line">     Row_format: Compact 紧致格式</span><br><span class="line">           Rows: 0</span><br><span class="line"> Avg_row_length: 0</span><br><span class="line">    Data_length: 16384</span><br><span class="line">Max_data_length: 0</span><br><span class="line">   Index_length: 0</span><br><span class="line">      Data_free: 10485760</span><br><span class="line"> Auto_increment: 1</span><br><span class="line">    Create_time: 2018-11-29 15:40:42 创建时间</span><br><span class="line">    Update_time: NULL</span><br><span class="line">     Check_time: NULL</span><br><span class="line">      Collation: latin1_swedish_ci 字符集</span><br><span class="line">       Checksum: NULL</span><br><span class="line"> Create_options: </span><br><span class="line">        Comment:                   描述</span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">查看当前使用的数据库中的所有的表结构</span><br><span class="line">SHOW TABLE STATUS FROM db_name</span><br></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line">询表中是否有索引（以及索引信息）</span><br><span class="line">MariaDB [studentdb]&gt; show indexes from student\G</span><br><span class="line">*************************** 1. row ***************************</span><br><span class="line">        Table: student</span><br><span class="line">   Non_unique: 0</span><br><span class="line">     Key_name: PRIMARY  主键索引</span><br><span class="line"> Seq_in_index: 1</span><br><span class="line">  Column_name: id</span><br><span class="line">    Collation: A</span><br><span class="line">  Cardinality: 0</span><br><span class="line">     Sub_part: NULL</span><br><span class="line">       Packed: NULL</span><br><span class="line">         Null: </span><br><span class="line">   Index_type: BTREE  </span><br><span class="line">      Comment: </span><br><span class="line">Index_comment: </span><br><span class="line">1 row <span class="keyword">in</span> <span class="built_in">set</span> (0.00 sec)</span><br><span class="line"></span><br><span class="line">建立主键自动建立索引：索引可以提高查询速度</span><br></pre></td></tr></table></figure>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;mysql数据库和表管理理论及实操&quot;&gt;&lt;a href=&quot;#mysql数据库和表管理理论及实操&quot; class=&quot;headerlink&quot; title=&quot;mysql数据库和表管理理论及实操&quot;&gt;&lt;/a&gt;mysql数据库和表管理理论及实操&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/mysql数据库和表管理理论及实操/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://daizhe.net.cn/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://daizhe.net.cn/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>mysql源码编译多实例和数据库管理</title>
    <link href="https://daizhe.net.cn/2019/02/20/mysql%E6%BA%90%E7%A0%81%E7%BC%96%E8%AF%91%E5%A4%9A%E5%AE%9E%E4%BE%8B%E5%92%8C%E6%95%B0%E6%8D%AE%E5%BA%93%E7%AE%A1%E7%90%86/"/>
    <id>https://daizhe.net.cn/2019/02/20/mysql源码编译多实例和数据库管理/</id>
    <published>2019-02-20T06:33:42.655Z</published>
    <updated>2019-02-20T07:18:18.364Z</updated>
    
    <content type="html"><![CDATA[<h1 id="mysql源码编译多实例和数据库管理"><a href="#mysql源码编译多实例和数据库管理" class="headerlink" title="mysql源码编译多实例和数据库管理"></a>mysql源码编译多实例和数据库管理</h1><p><img src="/2019/02/20/mysql源码编译多实例和数据库管理/标题.gif" alt=""><br><a id="more"></a></p><h2 id="多实例（基于yum安装配置多实例）"><a href="#多实例（基于yum安装配置多实例）" class="headerlink" title="多实例（基于yum安装配置多实例）"></a>多实例（基于yum安装配置多实例）</h2><p>多用于测试环境<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br></pre></td><td class="code"><pre><span class="line">实验准备：</span><br><span class="line">1.基于yum安装mairiadb-server   Version     : 5.5.56</span><br><span class="line">2.基于网络通讯，每个实例使用不同的端口号：3306：3307：3308</span><br><span class="line">3.准备不同存放数据库数据文件的路径：</span><br><span class="line">   /data/mysql/3306</span><br><span class="line">   /data/mysql/3307</span><br><span class="line">   /data/mysql/3308</span><br><span class="line">4.将数据库程序文件单独防止</span><br><span class="line">   /data/mysql/3306&#123;etc,<span class="built_in">log</span>,data,pid,bin&#125;</span><br><span class="line">   /data/mysql/3307&#123;etc,<span class="built_in">log</span>,data,pid,bin&#125;</span><br><span class="line">   /data/mysql/3308&#123;etc,<span class="built_in">log</span>,data,pid,bin&#125;</span><br><span class="line"></span><br><span class="line">范例：基于yum源安装mysql数据库</span><br><span class="line">第一步：安装数据库（安装好，系统默认已经创建好了账号）</span><br><span class="line">[root@centos7 ~]<span class="comment"># yum install mariadb-server -y</span></span><br><span class="line"></span><br><span class="line">第二步：根据规划创建相应的数据文件，并修改属性（可以参照安装好的文件属性修改）</span><br><span class="line">[root@centos7 ~]<span class="comment"># cd /data</span></span><br><span class="line">[root@centos7 data]<span class="comment"># mkdir -p  mysql/&#123;3306,3307,3308&#125;/&#123;etc,data,socket,log,pid,bin&#125;</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># tree /data/mysql/</span></span><br><span class="line">/data/mysql/</span><br><span class="line">├── 3306</span><br><span class="line">│   ├── bin  二进制文件</span><br><span class="line">│   ├── data 二进制数据</span><br><span class="line">│   ├── etc  主配置文件</span><br><span class="line">│   ├── <span class="built_in">log</span>  日志为文件</span><br><span class="line">│   ├── pid  pid文件</span><br><span class="line">│   └── socket 套接字文件</span><br><span class="line">├── 3307</span><br><span class="line">│   ├── bin</span><br><span class="line">│   ├── data</span><br><span class="line">│   ├── etc</span><br><span class="line">│   ├── <span class="built_in">log</span></span><br><span class="line">│   ├── pid</span><br><span class="line">│   └── socket</span><br><span class="line">└── 3308</span><br><span class="line">    ├── bin</span><br><span class="line">    ├── data</span><br><span class="line">    ├── etc</span><br><span class="line">    ├── <span class="built_in">log</span></span><br><span class="line">    ├── pid</span><br><span class="line">    └── socket</span><br><span class="line">[root@centos7 ~]<span class="comment"># cd /data</span></span><br><span class="line">[root@centos7 data]<span class="comment"># ls</span></span><br><span class="line">mysql</span><br><span class="line">[root@centos7 data]<span class="comment"># chown -R mysql:mysql mysql/</span></span><br><span class="line"></span><br><span class="line">第三步：通过yum安装好的数据库程序脚本，生成规划好的数据库数据文件</span><br><span class="line">[root@centos7 ~]<span class="comment"># /usr/bin/mysql_install_db --datadir=/data/mysql/3306/data --user=mysql</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># /usr/bin/mysql_install_db --datadir=/data/mysql/3307/data --user=mysql</span></span><br><span class="line"></span><br><span class="line">[root@centos7 ~]<span class="comment"># /usr/bin/mysql_install_db --datadir=/data/mysql/3308/data --user=mysql</span></span><br><span class="line"></span><br><span class="line">第四步：准备相应的配置文件：并根据自定义的路径进行修改</span><br><span class="line">3306的主配置文件</span><br><span class="line">[root@centos7 ~]<span class="comment"># cp /etc/my.cnf /data/mysql/3306/etc/</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /data/mysql/3306/etc/my.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">port=3306</span><br><span class="line">datadir=/data/mysql/3306/data</span><br><span class="line">socket=/data/mysql/3306/socket/mysql.sock</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="comment"># Settings user and group are ignored when systemd is used.</span></span><br><span class="line"><span class="comment"># If you need to run mysqld under a different user or group,</span></span><br><span class="line"><span class="comment"># customize your systemd unit file for mariadb according to the</span></span><br><span class="line"><span class="comment"># instructions in http://fedoraproject.org/wiki/Systemd</span></span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="built_in">log</span>-error=/data/mysql/3306/<span class="built_in">log</span>/mariadb.log</span><br><span class="line">pid-file=/data/mysql/3306/pid/mariadb.pid</span><br><span class="line"><span class="comment"># include all files from the config directory</span></span><br><span class="line"><span class="comment">#!includedir /etc/my.cnf.d 此行加注释</span></span><br><span class="line"></span><br><span class="line">3307的主配置文件(可以在vim编辑器中使用替换的功能：%s/6/8/)</span><br><span class="line">[root@centos7 ~]<span class="comment"># cp /data/mysql/3306/etc/my.cnf /data/mysql/3307/etc/my.cnf</span></span><br><span class="line">[mysqld]</span><br><span class="line">port=3307</span><br><span class="line">datadir=/data/mysql/3307/data</span><br><span class="line">socket=/data/mysql/3307/socket/mysql.sock</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="comment"># Settings user and group are ignored when systemd is used.</span></span><br><span class="line"><span class="comment"># If you need to run mysqld under a different user or group,</span></span><br><span class="line"><span class="comment"># customize your systemd unit file for mariadb according to the</span></span><br><span class="line"><span class="comment"># instructions in http://fedoraproject.org/wiki/Systemd</span></span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="built_in">log</span>-error=/data/mysql/3307/<span class="built_in">log</span>/mariadb.log</span><br><span class="line">pid-file=/data/mysql/3307/pid/mariadb.pid</span><br><span class="line"><span class="comment"># include all files from the config directory</span></span><br><span class="line"><span class="comment">#!includedir /etc/my.cnf.d</span></span><br><span class="line"></span><br><span class="line">3308的主配置</span><br><span class="line">[root@centos7 ~]<span class="comment"># cp /data/mysql/3306/etc/my.cnf /data/mysql/3308/etc/my.cnf</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /data/mysql/3308/etc/my.cnf </span></span><br><span class="line">[mysqld]</span><br><span class="line">port=3308</span><br><span class="line">datadir=/data/mysql/3308/data</span><br><span class="line">socket=/data/mysql/3308/socket/mysql.sock</span><br><span class="line"><span class="comment"># Disabling symbolic-links is recommended to prevent assorted security risks</span></span><br><span class="line">symbolic-links=0</span><br><span class="line"><span class="comment"># Settings user and group are ignored when systemd is used.</span></span><br><span class="line"><span class="comment"># If you need to run mysqld under a different user or group,</span></span><br><span class="line"><span class="comment"># customize your systemd unit file for mariadb according to the</span></span><br><span class="line"><span class="comment"># instructions in http://fedoraproject.org/wiki/Systemd</span></span><br><span class="line">[mysqld_safe]</span><br><span class="line"><span class="built_in">log</span>-error=/data/mysql/3308/<span class="built_in">log</span>/mariadb.log</span><br><span class="line">pid-file=/data/mysql/3308/pid/mariadb.pid</span><br><span class="line"><span class="comment"># include all files from the config directory</span></span><br><span class="line"><span class="comment">#!includedir /etc/my.cnf.d</span></span><br><span class="line"></span><br><span class="line">第五步：准备启动程序的脚本</span><br><span class="line">手写启动脚本</span><br><span class="line">[root@centos7 ~]<span class="comment"># cat mysqld.sh </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">port=3307</span><br><span class="line">mysql_user=<span class="string">"root"</span></span><br><span class="line">mysql_basedir=<span class="string">"/data/mysql"</span></span><br><span class="line">mysql_sock=<span class="string">"<span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/socket/mysql.sock"</span></span><br><span class="line"></span><br><span class="line">function_start_mysql()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$mysql_sock</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"Starting mysql...\n"</span></span><br><span class="line">        <span class="variable">$&#123;cmd_path&#125;</span>/mysql_safe --defaults-file=<span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/etc/my.cnf &amp;&gt; /dev/null &amp;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"mysql is running...\n"</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function_stop_mysql()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$mysql_sock</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"mysql is stopped...\n"</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"stoping mysql...\n"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function_restart_mysql()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">print</span> <span class="string">"restarting mysql...\n"</span></span><br><span class="line">        function_stop_mysql</span><br><span class="line">        sleep 2</span><br><span class="line">        function_start_mysql</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">        function_start_mysql</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">        function_stop_mysql</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line">        function_restart_mysql</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">        <span class="built_in">print</span> <span class="string">"Usage: <span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/bin/mysqld &#123;start|stop|restart&#125;\n"</span></span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改启动脚本</span><br><span class="line">3306</span><br><span class="line">[root@centos7 ~]<span class="comment"># cp mysqld.sh /data/mysql/3306/bin/mysqld</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /data/mysql/3306/bin/mysqld</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /data/mysql/3307/bin/mysqld </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">port=3306</span><br><span class="line">mysql_user=<span class="string">"root"</span></span><br><span class="line">mysql_basedir=<span class="string">"/data/mysql"</span></span><br><span class="line">mysql_sock=<span class="string">"<span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/socket/mysql.sock"</span></span><br><span class="line"></span><br><span class="line">function_start_mysql()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$mysql_sock</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"Starting mysql...\n"</span></span><br><span class="line">        <span class="variable">$&#123;cmd_path&#125;</span>/mysql_safe --defaults-file=<span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/etc/my.cnf &amp;&gt; /dev/null &amp;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"mysql is running...\n"</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function_stop_mysql()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$mysql_sock</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"mysql is stopped...\n"</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"stoping mysql...\n"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function_restart_mysql()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"restarting mysql...\n"</span></span><br><span class="line">        function_stop_mysql</span><br><span class="line">        sleep 2</span><br><span class="line">        function_start_mysql</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">        function_start_mysql</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">        function_stop_mysql</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line">        function_restart_mysql</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"Usage: <span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/bin/mysqld &#123;start|stop|restart&#125;\n"</span></span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">3307</span><br><span class="line">[root@centos7 ~]<span class="comment"># cp /data/mysql/3306/bin/mysqld /data/mysql/3307/bin/</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /data/mysql/3307/bin/mysqld </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">port=3307</span><br><span class="line">mysql_user=<span class="string">"root"</span></span><br><span class="line">mysql_basedir=<span class="string">"/data/mysql"</span></span><br><span class="line">mysql_sock=<span class="string">"<span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/socket/mysql.sock"</span></span><br><span class="line"></span><br><span class="line">function_start_mysql()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$mysql_sock</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"Starting mysql...\n"</span></span><br><span class="line">        <span class="variable">$&#123;cmd_path&#125;</span>/mysql_safe --defaults-file=<span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/etc/my.cnf &amp;&gt; /dev/null &amp;</span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"mysql is running...\n"</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function_stop_mysql()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$mysql_sock</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"mysql is stopped...\n"</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"stoping mysql...\n"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function_restart_mysql()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"restarting mysql...\n"</span></span><br><span class="line">        function_stop_mysql</span><br><span class="line">        sleep 2</span><br><span class="line">        function_start_mysql</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">        function_start_mysql</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">        function_stop_mysql</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line">        function_restart_mysql</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"Usage: <span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/bin/mysqld &#123;start|stop|restart&#125;\n"</span></span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">3308</span><br><span class="line">[root@centos7 ~]<span class="comment"># vim /data/mysql/3308/bin/mysqld </span></span><br><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">port=3308</span><br><span class="line">mysql_user=<span class="string">"root"</span></span><br><span class="line">mysql_basedir=<span class="string">"/data/mysql"</span></span><br><span class="line">mysql_sock=<span class="string">"<span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/socket/mysql.sock"</span></span><br><span class="line"></span><br><span class="line">function_start_mysql()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$mysql_sock</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"Starting mysql...\n"</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"mysql is running...\n"</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function_stop_mysql()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="keyword">if</span> [ ! -e <span class="string">"<span class="variable">$mysql_sock</span>"</span> ];<span class="keyword">then</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"mysql is stopped...\n"</span></span><br><span class="line">        <span class="built_in">exit</span></span><br><span class="line">        <span class="keyword">else</span></span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"stoping mysql...\n"</span></span><br><span class="line">        <span class="keyword">fi</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">function_restart_mysql()</span><br><span class="line">&#123;</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"restarting mysql...\n"</span></span><br><span class="line">        function_stop_mysql</span><br><span class="line">        sleep 2</span><br><span class="line">        function_start_mysql</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">case</span> <span class="variable">$1</span> <span class="keyword">in</span></span><br><span class="line">start)</span><br><span class="line">        function_start_mysql</span><br><span class="line">;;</span><br><span class="line">stop)</span><br><span class="line">        function_stop_mysql</span><br><span class="line">;;</span><br><span class="line">restart)</span><br><span class="line">        function_restart_mysql</span><br><span class="line">;;</span><br><span class="line">*)</span><br><span class="line">        <span class="built_in">printf</span> <span class="string">"Usage: <span class="variable">$&#123;mysql_basedir&#125;</span>/<span class="variable">$&#123;port&#125;</span>/bin/mysqld &#123;start|stop|restart&#125;\n"</span></span><br><span class="line"><span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">第六步：给执行程序添加执行权限</span><br><span class="line">[root@centos7 ~]<span class="comment"># chmod +x /data/mysql/3306/bin/mysqld </span></span><br><span class="line">[root@centos7 ~]<span class="comment"># chmod +x /data/mysql/3307/bin/mysqld </span></span><br><span class="line">[root@centos7 ~]<span class="comment"># chmod +x /data/mysql/3308/bin/mysqld </span></span><br><span class="line"></span><br><span class="line">启动：</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;mysql源码编译多实例和数据库管理&quot;&gt;&lt;a href=&quot;#mysql源码编译多实例和数据库管理&quot; class=&quot;headerlink&quot; title=&quot;mysql源码编译多实例和数据库管理&quot;&gt;&lt;/a&gt;mysql源码编译多实例和数据库管理&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/20/mysql源码编译多实例和数据库管理/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="mysql" scheme="https://daizhe.net.cn/categories/mysql/"/>
    
    
      <category term="mysql" scheme="https://daizhe.net.cn/tags/mysql/"/>
    
  </entry>
  
  <entry>
    <title>ELK之Logstash收集系统日志及tomcat的json日志</title>
    <link href="https://daizhe.net.cn/2019/02/19/ELK%E4%B9%8BLogstash%E6%94%B6%E9%9B%86%E7%B3%BB%E7%BB%9F%E6%97%A5%E5%BF%97%E5%8F%8Atomcat%E7%9A%84json%E6%97%A5%E5%BF%97/"/>
    <id>https://daizhe.net.cn/2019/02/19/ELK之Logstash收集系统日志及tomcat的json日志/</id>
    <published>2019-02-19T11:55:32.161Z</published>
    <updated>2019-02-20T12:29:16.604Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ELK之Logstash收集系统日志json格式的tomcat日志"><a href="#ELK之Logstash收集系统日志json格式的tomcat日志" class="headerlink" title="ELK之Logstash收集系统日志json格式的tomcat日志"></a>ELK之Logstash收集系统日志json格式的tomcat日志</h1><p><img src="/2019/02/19/ELK之Logstash收集系统日志及tomcat的json日志/标题.gif" alt=""><br><a id="more"></a></p><h2 id="通过logtsash收集tomcat和java日志："><a href="#通过logtsash收集tomcat和java日志：" class="headerlink" title="通过logtsash收集tomcat和java日志："></a>通过logtsash收集tomcat和java日志：</h2><ul><li>收集Tomcat服务器的访问日志以及Tomcat错误日志进行实时统计，在kibana页面进行搜索展现，每台Tomcat服务器要安装logstash负责收集日志，然后将日志转发给elasticsearch进行分析，在通过kibana在前端展现，配置过程如下：</li></ul><p><img src="/2019/02/19/ELK之Logstash收集系统日志及tomcat的json日志/1.png" alt=""></p><p>1：安装tomcat(logstash必须和tomcat在同一台主机上才能收集tomcat的日志)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line">验证java JDK版本信息</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># java -version</span></span><br><span class="line">  java version <span class="string">"1.8.0_192"</span></span><br><span class="line">  Java(TM) SE Runtime Environment (build 1.8.0_192-b12)</span><br><span class="line">  Java HotSpot(TM) 64-Bit Server VM (build 25.192-b12, mixed mode)</span><br><span class="line"></span><br><span class="line">安装tomcat</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># wget http://mirrors.hust.edu.cn/apache/tomcat/tomcat-8/v8.5.37/bin/apache-tomcat-8.5.37.tar.gz</span></span><br><span class="line">  ~]<span class="comment"># tar xvf apache-tomcat-8.5.37.tar.gz -C /usr/local/</span></span><br><span class="line">  ~]<span class="comment"># ln -vs /usr/local/apache-tomcat-8.5.37 /usr/local/tomcat （链接形式方便升级）</span></span><br><span class="line"></span><br><span class="line">tomcat不可使用root用户运行</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># useradd tomcat</span></span><br><span class="line">  ~]<span class="comment"># chown -R tomcat.tomcat /usr/local/tomcat/</span></span><br><span class="line">  ~]<span class="comment"># chown -R tomcat.tomcat /usr/local/tomcat/*</span></span><br><span class="line">  ~]<span class="comment"># su - tomcat -c "/usr/local/tomcat/bin/catalina.sh start"</span></span><br><span class="line">    Using CATALINA_BASE:   /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">    Using CATALINA_HOME:   /usr/<span class="built_in">local</span>/tomcat</span><br><span class="line">    Using CATALINA_TMPDIR: /usr/<span class="built_in">local</span>/tomcat/temp</span><br><span class="line">    Using JRE_HOME:        /usr/bin/default</span><br><span class="line">    Using CLASSPATH:       /usr/<span class="built_in">local</span>/tomcat/bin/bootstrap.jar:/u</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">    LISTEN      0      100             :::8009  (ajp)                                 </span><br><span class="line">    LISTEN      0      100            127.0.0.1:8005  (管理接口)    </span><br><span class="line">    LISTEN      0      100             :::8080 （http）</span><br><span class="line"></span><br><span class="line">tomcat两个重要的日志文件</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># ll /usr/local/tomcat/logs/host-manager.2019-02-19.log   #每天滚动的日志</span></span><br><span class="line">  ~]<span class="comment"># ll /usr/local/tomcat/logs/catalina.out</span></span><br></pre></td></tr></table></figure></p><p>2：配置编辑logstash配置文件来收集tomcat日志文件catalina.out<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br></pre></td><td class="code"><pre><span class="line">  ~]<span class="comment"># cd /etc/logstash/conf.d/</span></span><br><span class="line"></span><br><span class="line">  conf.d]<span class="comment"># vim tomcatlog.conf </span></span><br><span class="line"></span><br><span class="line">  input &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/usr/local/tomcat/logs/catalina.out"</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"tomcatlog"</span></span><br><span class="line">    start_position =&gt; <span class="string">"beginning"</span></span><br><span class="line">    stat_interval =&gt; <span class="string">"3"</span></span><br><span class="line">  &#125; </span><br><span class="line">  </span><br><span class="line">  &#125; </span><br><span class="line"></span><br><span class="line">  output &#123;</span><br><span class="line"> <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"tomcatlog"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [<span class="string">"172.18.135.1:9200"</span>]</span><br><span class="line">      index =&gt; <span class="string">"tomcat-log-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">    &#125;&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改收集日志的权限也可以将logstash运行身份修改为root，可以在启动脚本中进行修改</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/systemd/system/logstash.service </span></span><br><span class="line"></span><br><span class="line">  [Unit]</span><br><span class="line">  Description=logstash</span><br><span class="line">  [Service]</span><br><span class="line">  Type=simple</span><br><span class="line">  User=root</span><br><span class="line">  Group=root</span><br><span class="line">  EnvironmentFile=-/etc/default/logstash</span><br><span class="line">  EnvironmentFile=-/etc/sysconfig/logstash</span><br><span class="line">  ExecStart=/usr/share/logstash/bin/logstash <span class="string">"--path.settings"</span> <span class="string">"/etc/logstash"</span></span><br><span class="line">  Restart=always</span><br><span class="line">  WorkingDirectory=/</span><br><span class="line">  Nice=19</span><br><span class="line">  LimitNOFILE=16384</span><br><span class="line"></span><br><span class="line">  [Install]</span><br><span class="line">  WantedBy=multi-user.target</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置文件语法检查</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/tomcatlog.conf -t</span></span><br><span class="line"></span><br><span class="line">重启logstash</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart logstash</span></span><br><span class="line">  ~]<span class="comment"># systemctl enable logstash</span></span><br></pre></td></tr></table></figure></p><p>3：web界面确认tomcat可以访问<br><img src="/2019/02/19/ELK之Logstash收集系统日志及tomcat的json日志/2.png" alt=""></p><p>4:将日志索引在kibana中进行图形化展示<br><img src="/2019/02/19/ELK之Logstash收集系统日志及tomcat的json日志/3.png" alt=""></p><p>5:查看是否记录数据<br><img src="/2019/02/19/ELK之Logstash收集系统日志及tomcat的json日志/4.png" alt=""></p><h2 id="将tomcat的日志格式打印为json格式"><a href="#将tomcat的日志格式打印为json格式" class="headerlink" title="将tomcat的日志格式打印为json格式"></a>将tomcat的日志格式打印为json格式</h2><p>1：将tomcat的日志修改为json格式的日志格式</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">编辑tomcat的主配置文件</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/tomcat/server.xml </span></span><br><span class="line"></span><br><span class="line">  137~140源文件</span><br><span class="line">  &lt;Valve className=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> directory=<span class="string">"logs"</span></span><br><span class="line">               prefix=<span class="string">"localhost_access_log."</span> suffix=<span class="string">".txt"</span></span><br><span class="line">               pattern=<span class="string">"%h %l %u %t &amp;quot;%r&amp;quot; %s %b"</span> /&gt;</span><br><span class="line"></span><br><span class="line">  修改为</span><br><span class="line"></span><br><span class="line">  &lt;Valve className=<span class="string">"org.apache.catalina.valves.AccessLogValve"</span> directory=<span class="string">"logs"</span></span><br><span class="line">                prefix=<span class="string">"tomcat_access_log"</span> suffix=<span class="string">".log"</span></span><br><span class="line">                pattern=<span class="string">"&#123;&amp;quot;clientip&amp;quot;:&amp;quot;%h&amp;quot;,&amp;quot;ClientUser&amp;quot;:&amp;quot;%l&amp;quot;,&amp;quot;authenticated&amp;quot;:&amp;quot;%u&amp;quot;,&amp;quot;AccessTime&amp;quot;:&amp;quot;%t&amp;quot;,&amp;quot;method&amp;quot;:&amp;quot;%r&amp;quot;,&amp;quot;status&amp;quot;:&amp;quot;%s&amp;quot;,&amp;quot;SendBytes&amp;quot;:&amp;quot;%b&amp;quot;,&amp;quot;Query?string&amp;quot;:&amp;quot;%q&amp;quot;,&amp;quot;partner&amp;quot;:&amp;quot;%&#123;Referer&#125;i&amp;quot;,&amp;quot;AgentVersion&amp;quot;:&amp;quot;%&#123;User-Agent&#125;i&amp;quot;&#125;"</span>/&gt;</span><br><span class="line"></span><br><span class="line">重启启动tomcat并访问tomcat页面查看是否生成日志</span><br><span class="line">  ~]<span class="comment"># systemctl resatrt tomcat</span></span><br><span class="line"></span><br><span class="line">  访问tomcat</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># curl 172.20.101.221:8080</span></span><br><span class="line"></span><br><span class="line">  查看日志格式</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cd /var/log/tomcat/</span></span><br><span class="line">  tomcat]<span class="comment"># ls</span></span><br><span class="line">  tomcat_access_log2019-02-20.log</span><br><span class="line">  &#123;<span class="string">"clientip"</span>:<span class="string">"172.20.101.221"</span>,<span class="string">"ClientUser"</span>:<span class="string">"-"</span>,<span class="string">"authenticated"</span>:<span class="string">"-"</span>,<span class="string">"AccessTime"</span>:<span class="string">"[20/Feb/2019:20:13:37 +0800]"</span>,<span class="string">"method"</span>:<span class="string">"GET / HTTP/1.1"</span>,<span class="string">"status"</span>:<span class="string">"200"</span>,<span class="string">"SendBytes"</span>:<span class="string">"11217"</span>,<span class="string">"Query?string"</span>:<span class="string">""</span>,<span class="string">"partner"</span>:<span class="string">"-"</span>,<span class="string">"AgentVersion"</span>:<span class="string">"curl/7.29.0"</span>&#125;</span><br></pre></td></tr></table></figure><p>重启查看日志<br><img src="/2019/02/19/ELK之Logstash收集系统日志及tomcat的json日志/5.png" alt=""></p><p>验证日志是否json格式：<br><a href="http://www.kjson.com/" target="_blank" rel="noopener">http://www.kjson.com/</a></p><p>2：配置编辑logstash配置文件来收集tomcat日志文件catalina.out 和自己定义的日志tomcat_access_log(json格式)<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/logstash/conf.d/tomcatlog.conf </span></span><br><span class="line"></span><br><span class="line">input &#123;</span><br><span class="line">    file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/var/log/tomcat/catalina.out"</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"tomcatlog"</span></span><br><span class="line">    start_position =&gt; <span class="string">"beginning"</span></span><br><span class="line">    stat_interval =&gt; <span class="string">"3"</span></span><br><span class="line">  &#125;</span><br><span class="line">   file &#123;</span><br><span class="line">  <span class="comment">#此处做统配匹配日志。因为定义的日志为每天更新，文件格式以日期格式命令</span></span><br><span class="line">   path =&gt; <span class="string">"/var/log/tomcat_access_log.*.log"</span> </span><br><span class="line">   <span class="built_in">type</span> =&gt; <span class="string">"accesslog"</span></span><br><span class="line">   start_psition =&gt; <span class="string">"beginning"</span></span><br><span class="line">   stat_interval =&gt; <span class="string">"3"</span></span><br><span class="line">   codec =&gt; json    <span class="comment">#声明收集的此日志的格式为json格式</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123;</span><br><span class="line"> <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"tomcatlog"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [<span class="string">"172.18.135.1:9200"</span>]</span><br><span class="line">      index =&gt; <span class="string">"tomcat-log-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">    &#125;&#125;</span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"accesslog"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">     hosts =&gt; [<span class="string">"172.18.135.1:9200"</span>]</span><br><span class="line">     index =&gt; <span class="string">"access-tomcat-log-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">  &#125;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">重启logstash</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p><p>3.定义kibana按索引的名称做日志收集并添图形展示界面<br><img src="/2019/02/19/ELK之Logstash收集系统日志及tomcat的json日志/6.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ELK之Logstash收集系统日志json格式的tomcat日志&quot;&gt;&lt;a href=&quot;#ELK之Logstash收集系统日志json格式的tomcat日志&quot; class=&quot;headerlink&quot; title=&quot;ELK之Logstash收集系统日志json格式的tomcat日志&quot;&gt;&lt;/a&gt;ELK之Logstash收集系统日志json格式的tomcat日志&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/19/ELK之Logstash收集系统日志及tomcat的json日志/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>ELK之Kibana安装部署</title>
    <link href="https://daizhe.net.cn/2019/02/19/ELK%E4%B9%8BKibana%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/"/>
    <id>https://daizhe.net.cn/2019/02/19/ELK之Kibana安装部署/</id>
    <published>2019-02-19T07:02:27.052Z</published>
    <updated>2019-02-20T07:25:54.260Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ELK之Kibana安装部署"><a href="#ELK之Kibana安装部署" class="headerlink" title="ELK之Kibana安装部署"></a>ELK之Kibana安装部署</h1><p><img src="/2019/02/19/ELK之Kibana安装部署/标题.gif" alt=""><br><a id="more"></a></p><h2 id="一句话介绍kibana"><a href="#一句话介绍kibana" class="headerlink" title="一句话介绍kibana"></a>一句话介绍kibana</h2><ul><li>kibana 可以通过图形界面友好的展示你在es中的数据</li></ul><p><img src="/2019/02/19/ELK之Kibana安装部署/1.png" alt=""></p><h2 id="Host4主机-kibana部署及日志收集："><a href="#Host4主机-kibana部署及日志收集：" class="headerlink" title="Host4主机 kibana部署及日志收集："></a>Host4主机 kibana部署及日志收集：</h2><p>1.安装并配置kibana：<br>可以通过rpm包或者二进制的方式进行安装<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># ls</span></span><br><span class="line">kibana-5.6.13-x86_64.rpm </span><br><span class="line">~]<span class="comment"># rpm -ivh kibana-5.6.13-x86_64.rpm</span></span><br></pre></td></tr></table></figure></p><p>2.编辑Kibana配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="comment">#端口默认5601</span></span><br><span class="line">2 server.port: 5601 </span><br><span class="line"></span><br><span class="line"><span class="comment">#指定监听本机的地址</span></span><br><span class="line">7 server.host: <span class="string">"0.0.0.0"</span></span><br><span class="line"></span><br><span class="line"><span class="comment">#指定ES主机的客户端监听地址</span></span><br><span class="line">21 elasticsearch.url: <span class="string">"http://Host1主机或者Host2主机:9200"</span></span><br></pre></td></tr></table></figure></p><p>3.启动host4主机上的kibana服务<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># systemctl start kibana</span></span><br><span class="line">~]<span class="comment"># systemctl enable kibana</span></span><br><span class="line">~]<span class="comment"># ss -tnl</span></span><br><span class="line">*:5601</span><br></pre></td></tr></table></figure></p><p>4.测试Host3主机Logstash输出到Host1主机elasticsearch<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">Logstash收集本机的日志将日志输出至ES服务器上</span><br><span class="line"></span><br><span class="line">方法1：</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash   -e 'input &#123;  stdin&#123;&#125; &#125; output &#123; elasticsearch &#123;hosts =&gt; ["host1:9200"] index =&gt; "mytest-%&#123;+YYYY.MM.dd&#125;" &#125;&#125;'</span></span><br><span class="line"></span><br><span class="line">方法2：不指定存入ES主机的名称默认为[logstash-]YYYY.MM.DD</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash   -e 'input &#123;  stdin&#123;&#125; &#125; output &#123; elasticsearch &#123;hosts =&gt; ["172.18.135.1:9200"] &#125;&#125;'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">ES主机ES-host1查看是否已经收集到Lsgstash过滤发送来的日志信息</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># ls /data/esdata/nodes/0/indices/</span></span><br><span class="line">-gghAdfzRDqtsflB0i-Ajw  <span class="comment">#名称为随机生成的名称</span></span><br></pre></td></tr></table></figure></p><p>5.web界面访问Host4地址的5601端口<br>第四步方法1：<br><img src="/2019/02/19/ELK之Kibana安装部署/2.png" alt=""><br><img src="/2019/02/19/ELK之Kibana安装部署/3.png" alt=""></p><p>第四步方法2：<br><img src="/2019/02/19/ELK之Kibana安装部署/4.png" alt=""><br><img src="/2019/02/19/ELK之Kibana安装部署/5.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ELK之Kibana安装部署&quot;&gt;&lt;a href=&quot;#ELK之Kibana安装部署&quot; class=&quot;headerlink&quot; title=&quot;ELK之Kibana安装部署&quot;&gt;&lt;/a&gt;ELK之Kibana安装部署&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/19/ELK之Kibana安装部署/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>ELK之Logstash安装及基本语法</title>
    <link href="https://daizhe.net.cn/2019/02/19/ELK%E4%B9%8BLogstash%E5%AE%89%E8%A3%85%E5%8F%8A%E5%9F%BA%E6%9C%AC%E8%AF%AD%E6%B3%95/"/>
    <id>https://daizhe.net.cn/2019/02/19/ELK之Logstash安装及基本语法/</id>
    <published>2019-02-19T02:38:23.001Z</published>
    <updated>2019-02-20T11:24:54.335Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ELK之Logstash安装及基本语法"><a href="#ELK之Logstash安装及基本语法" class="headerlink" title="ELK之Logstash安装及基本语法"></a>ELK之Logstash安装及基本语法</h1><p><img src="/2019/02/19/ELK之Logstash安装及基本语法/标题.gif" alt=""><br><a id="more"></a></p><h1 id="ELK–-gt-logstash"><a href="#ELK–-gt-logstash" class="headerlink" title="ELK–&gt;logstash"></a>ELK–&gt;logstash</h1><h2 id="Logstash介绍"><a href="#Logstash介绍" class="headerlink" title="Logstash介绍"></a>Logstash介绍</h2><p>官方站点：<a href="https://www.elastic.co/cn/products/logstash" target="_blank" rel="noopener">https://www.elastic.co/cn/products/logstash</a></p><ul><li><p>集中、转换和存储数据</p><ul><li>Logstash 是开源的服务器端数据处理管道，能够同时从多个来源采集数据，转换数据，然后将数据发送到您最喜欢的 “存储库” 中。（我们的存储库当然是 Elasticsearch。）</li></ul></li><li><p>输入</p><ul><li>采集各种样式、大小和来源的数据<ul><li>数据往往以各种各样的形式，或分散或集中地存在于很多系统中。 Logstash 支持各种输入选择 ，可以在同一时间从众多常用来源捕捉事件。能够以连续的流式传输方式，轻松地从您的日志、指标、Web 应用、数据存储以及各种 AWS 服务采集数据。</li></ul></li></ul></li><li><p>过滤器</p><ul><li>实时解析和转换数据<ul><li>数据从源传输到存储库的过程中，Logstash 过滤器能够解析各个事件，识别已命名的字段以构建结构，并将它们转换成通用格式，以便更轻松、更快速地分析和实现商业价值。</li><li>利用 Grok 从非结构化数据中派生出结构</li><li>从 IP 地址破译出地理坐标</li><li>将 PII 数据匿名化，完全排除敏感字段</li><li>简化整体处理，不受数据源、格式或架构的影响</li></ul></li></ul></li><li><p>输出</p><ul><li>选择您的存储库，导出您的数据<ul><li>尽管 Elasticsearch 是我们的首选输出方向，能够为我们的搜索和分析带来无限可能，但它并非唯一选择。</li><li>Logstash 提供众多输出选择，您可以将数据发送到您要指定的地方，并且能够灵活地解锁众多下游用例。</li></ul></li></ul></li><li><p>即插即用</p><ul><li>使用 Elastic Stack 更快获得洞察<ul><li>Logstash 模块通过热门的数据源（如 ArcSight 和 Netflow ）呈现瞬间可视化的体验。通过立即部署摄入管道和复杂的仪表板，您在短短几分钟内便可开始数据探索。</li></ul></li></ul></li><li><p>可扩展</p><ul><li>以您自己的方式创建和配置管道<ul><li>Logstash 采用可插拔框架，拥有 200 多个插件。您可以将不同的输入选择、过滤器和输出选择混合搭配、精心安排，让它们在管道中和谐地运行。</li><li>从自定义应用程序采集数据？没有看到所需的插件？Logstash 插件很容易构建。我们有一个极好的插件开发 API 和插件生成器，可帮助您开始和分享您的创作。</li></ul></li></ul></li><li><p>可靠性与安全性</p><ul><li>构建可信的交付管道<ul><li>假如 Logstash 节点发生故障，Logstash 会通过持久化队列来保证至少将运行中的事件送达一次。那些未被正常处理的消息会被送往死信队列（dead letter queue）以便做进一步处理。由于具备了这种吸收吞吐量的能力，现在您无需采用额外的队列层，Logstash 就能平稳度过高峰期。</li><li>我们让您能够全方位地保护您的数据加工管道，不管您是运行 10 个还是 1000 个 Logstash 实例。来自 Beats 的数据和其他数据输入一同在网络层被加密传输，并且与安全的 Elasticsearch 集群完整集成。</li></ul></li></ul></li><li><p>监控</p><ul><li>全方位监视您的部署<ul><li>Logstash 管道通常服务于多种用途，会变得非常复杂，因此充分了解管道性能、可用性和瓶颈异常重要。借助 Elastic Stack 的监控功能，您可以轻松观察和研究处于活动状态的 Logstash 节点或整个部署。</li></ul></li></ul></li><li><p>管理和治理</p><ul><li>使用单个 UI 集中式管理部署<ul><li>借助 Pipeline 管理图形界面来管理 Logstash 的部署，您可以轻而易举地治理数据加工管道。此外，此项管理功能也与 Elastic Stack 内置的安全特性无缝集成，用以避免任何意外操作。</li></ul></li></ul></li></ul><p><img src="/2019/02/19/ELK之Logstash安装及基本语法/2.png" alt=""></p><h2 id="补充"><a href="#补充" class="headerlink" title="补充"></a>补充</h2><ul><li>logstash 可以被消息队列kafka 代替，收取的数据存储在es中就好 </li><li>logstash 支持多种数据获取机制，可以通过TCP／UDP协议，文件、syslog、- windows EVENTlog 等</li><li>logstash 获取到数据后，执行对数据执行过滤，修改等操作(filter插件)</li><li>logstash 是使用Jruby 语言研发的，所以需要使用JVM虚拟机，需要java支持</li><li>logstash 如果agent端过多，数据量多大，我们需要在logstash客户端 与  server 端部署消息队列 <ul><li>一般使用redis，支持发布订阅等功能 </li></ul></li></ul><p><img src="/2019/02/19/ELK之Logstash安装及基本语法/3.png" alt=""></p><h2 id="Host3主机部署Logstash：（logstash-java环境）"><a href="#Host3主机部署Logstash：（logstash-java环境）" class="headerlink" title="Host3主机部署Logstash：（logstash+java环境）"></a>Host3主机部署Logstash：（logstash+java环境）</h2><p><img src="/2019/02/19/ELK之Logstash安装及基本语法/1.png" alt=""></p><p>官方帮助文档：<a href="https://www.elastic.co/guide/index.html" target="_blank" rel="noopener">https://www.elastic.co/guide/index.html</a></p><p>1：logstash环境准备及安装：</p><ul><li>Logstash是一个开源的数据收集引擎，可以水平伸缩，而且logstash整个ELK当中拥有最多插件的一个组件，其可以接收来自不同来源的数据并统一输出到指定的且可以是多个不同目的地。</li></ul><p>2.rpm安装Logstash+java环境<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">环境准备：</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># ls</span></span><br><span class="line">  logstash-5.6.13.rpm   jdk-8u192-linux-x64.rpm </span><br><span class="line"></span><br><span class="line">关闭防火墙和selinux，并且安装java环境</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl  stop firewalld</span></span><br><span class="line">  ~]<span class="comment"># systemctl  disable  firewalld</span></span><br><span class="line">  ~]<span class="comment"># sed -i '/SELINUX/s/enforcing/disabled/' /etc/selinux/config</span></span><br><span class="line">  ~]<span class="comment"># rpm -ivh jdk-8u192-linux-x64.rpm </span></span><br><span class="line">  ~]<span class="comment"># java -version</span></span><br><span class="line">  java version <span class="string">"1.8.0_121"</span></span><br><span class="line">  Java(TM) SE Runtime Environment (build 1.8.0_121-b13)</span><br><span class="line">  Java HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)</span><br><span class="line"></span><br><span class="line">安装logstash</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment">#  ~]# rpm -ivh logstash-5.6.13.rpm </span></span><br><span class="line">    <span class="comment">#权限更改为logstash用户和组，否则启动的时候日志报错</span></span><br><span class="line">  ~]<span class="comment"># chown  logstash.logstash /usr/share/logstash/data/queue –R</span></span><br></pre></td></tr></table></figure></p><hr><h2 id="测试Logstash："><a href="#测试Logstash：" class="headerlink" title="测试Logstash："></a>测试Logstash：</h2><p>1：测试标准输入和输出：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">  ~]<span class="comment"># /usr/share/logstash/bin/logstash   -e 'input &#123;  stdin&#123;&#125; &#125; output &#123; stdout&#123;  codec =&gt; rubydebug &#125;&#125;' </span></span><br><span class="line">    WARNING: Could not find logstash.yml <span class="built_in">which</span> is typically located <span class="keyword">in</span> <span class="variable">$LS_HOME</span>/config or /etc/logstash. You can specify the path using --path.settings. Continuing using the defaults</span><br><span class="line">    Could not find log4j2 configuration at path /usr/share/logstash/config/log4j2.properties. Using default config <span class="built_in">which</span> logs errors to the console</span><br><span class="line">    The stdin plugin is now waiting <span class="keyword">for</span> input:</span><br><span class="line"></span><br><span class="line">    hellow word</span><br><span class="line"></span><br><span class="line">  &#123;</span><br><span class="line">      <span class="string">"@version"</span> =&gt; <span class="string">"1"</span>,                    <span class="comment">#一个事件的第几个版本</span></span><br><span class="line">          <span class="string">"host"</span> =&gt; <span class="string">"host-192-168-35-103"</span>,  <span class="comment">#当前主机名，此日志是在哪台主机上产生的</span></span><br><span class="line">    <span class="string">"@timestamp"</span> =&gt; 2019-02-19T04:04:01.351Z, <span class="comment">#时间戳</span></span><br><span class="line">       <span class="string">"message"</span> =&gt; <span class="string">"hellow word"</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">一个最简单的配置文件：标准输入，标准输出</span><br><span class="line">（和上述命令行指定的含义相同）</span><br><span class="line"></span><br><span class="line">input&#123;</span><br><span class="line">stdin &#123;&#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output&#123;</span><br><span class="line">        stdout&#123;</span><br><span class="line">                codec  =&gt; rubydebug</span><br><span class="line">        &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2.查看Logsstash的模块<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash-plugin --help #查看帮助</span></span><br><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash-plugin list  #列出已经安装的模块</span></span><br><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash-plugin install #加载新的模块+模块名称</span></span><br><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash-plugin update #更新模块</span></span><br><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash-plugin remove #删除哪个模块</span></span><br></pre></td></tr></table></figure></p><p>2.配置文件声明<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">配置文件说明：</span><br><span class="line">logstash 开始是没有配置文件的，配置文件一般是由以下组成 </span><br><span class="line"></span><br><span class="line"></span><br><span class="line">input&#123;</span><br><span class="line">规则</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">filter&#123;</span><br><span class="line">规则</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output&#123;</span><br><span class="line">规则</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><hr><h2 id="Logstash常用的Input-output插件："><a href="#Logstash常用的Input-output插件：" class="headerlink" title="Logstash常用的Input/output插件："></a>Logstash常用的Input/output插件：</h2><p>file插件详细介绍</p><ul><li>path字段的说明<ul><li>path 是指定输入文件的路径，你可以使用/var/log/*.log，必须是绝对路径，不能是相对路径</li><li>你也可以指定多个路径<ul><li>例如 path =&gt; [ “/var/log/messages”, “/var/log/s.log” ]</li><li>首先你可以看到 path 是 required yes的状态，那就是说你只要使用file这个input插件，那么file里面一定要定义path</li></ul></li></ul></li></ul><p>1:指定输入查询的文件，输出为标准出<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash   -e 'input &#123;  file &#123; path =&gt; "/var/log/message" &#125; &#125; output &#123; stdout&#123;  &#125;&#125;'</span></span><br></pre></td></tr></table></figure></p><p>2.指定标准输入，和输出到指定的文件中<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash   -e 'input &#123;  stdin&#123;&#125; &#125; output &#123; file &#123; path =&gt; "/tmp/log-%&#123;+YYYY.MM.dd&#125;messages.gz"&#125;&#125;</span></span><br></pre></td></tr></table></figure></p><p>3.指定输入的文件，和输出的文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash   -e 'input &#123;  file &#123; path =&gt; "/var/log/message" &#125; &#125; output &#123; file &#123; path =&gt; "/data/eslogs.conf" &#125;&#125;'</span></span><br></pre></td></tr></table></figure></p><hr><h2 id="测试输出到elasticsearch"><a href="#测试输出到elasticsearch" class="headerlink" title="测试输出到elasticsearch"></a>测试输出到elasticsearch</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Logstash收集本机的日志将日志输出至ES服务器上</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash   -e 'input &#123;  stdin&#123;&#125; &#125; output &#123; elasticsearch &#123;hosts =&gt; ["host1:9200"] index =&gt; "mytest-%&#123;+YYYY.MM.dd&#125;" &#125;&#125;'</span></span><br><span class="line"></span><br><span class="line">ES主机ES-host1查看是否已经收集到Lsgstash过滤发送来的日志信息</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># ls /data/esdata/nodes/0/indices/</span></span><br><span class="line">-gghAdfzRDqtsflB0i-Ajw  <span class="comment">#名称为随机生成的名称</span></span><br></pre></td></tr></table></figure><hr><h2 id="Kibana"><a href="#Kibana" class="headerlink" title="Kibana"></a>Kibana</h2><p>笔记地址：<a href="https://www.daizhe.net.cn/2019/02/19/ELK%E4%B9%8BKibana%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/#more" target="_blank" rel="noopener">https://www.daizhe.net.cn/2019/02/19/ELK%E4%B9%8BKibana%E5%AE%89%E8%A3%85%E9%83%A8%E7%BD%B2/#more</a></p><hr><h2 id="通过logstash收集日志："><a href="#通过logstash收集日志：" class="headerlink" title="通过logstash收集日志："></a>通过logstash收集日志：</h2><p>1：收集单个系统日志并输出至ES服务器中：（标准输入为/var/logmesssage 标准输出到ES）<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line">前提需要logstash用户对被收集的日志文件有读的权限并对写入的文件有写权限。</span><br><span class="line"></span><br><span class="line">将此前的命令行实现的方式放置在logstash配置文件实现</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cd /etc/logstash/conf.d/  #logstash默认找配置文件的目录</span></span><br><span class="line">  conf.d]<span class="comment"># vim systemlog.conf</span></span><br><span class="line"></span><br><span class="line">  input &#123;</span><br><span class="line">        file &#123;</span><br><span class="line">        path =&gt; <span class="string">"/var/log/messages"</span></span><br><span class="line">        &#125;</span><br><span class="line">  &#125;       </span><br><span class="line"></span><br><span class="line">  output &#123;</span><br><span class="line">        elasticsearch &#123;</span><br><span class="line">        hosts =&gt; <span class="string">"172.18.135.1:9200"</span>&#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">修改/var/<span class="built_in">log</span>/message文件的权限</span><br><span class="line"><span class="comment">#默认启动logstash程序使用的是logstash用户启动的，而/var/log/message此文件属主属组为root所以要修改其权限，也可以将logstash运行身份修改为root，可以在启动脚本中进行修改</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># chmod 644 /var/log/messages</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">配置文件语法检测</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/systemlog.conf -t</span></span><br><span class="line">  Configuration OK</span><br><span class="line"></span><br><span class="line">启动logstash</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/systemlog.conf </span></span><br><span class="line"></span><br><span class="line">logstash主机在本机的/var/<span class="built_in">log</span>/message文件中模拟日志存入</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># echo "test" &gt;&gt; /var/log/messages </span></span><br><span class="line"></span><br><span class="line">查看logstash日志文件</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># ls /var/log/logstash/</span></span><br><span class="line">  logstash-plain.log</span><br></pre></td></tr></table></figure></p><p>Kibana主机上查看日志是否收集<br><img src="/2019/02/19/ELK之Logstash安装及基本语法/4.png" alt=""></p><p>2：logstash收集日志指定开始收集的位置<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">~]<span class="comment"># cat /etc/logstash/conf.d/system-log.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"messagelog"</span></span><br><span class="line">    path =&gt; <span class="string">"/var/log/messages"</span></span><br><span class="line">start_position =&gt; <span class="string">"beginning"</span> <span class="comment">#第一次从头收集，之后从新添加的日志收集</span></span><br><span class="line"></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123; </span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/tmp/%&#123;type&#125;.%&#123;+yyyy.MM.dd&#125;"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># chmod  644 /var/log/messages</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># systemctl restart logstash</span></span><br></pre></td></tr></table></figure></p><p>3：通过logstash收集多个日志文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">Logstash配置：</span><br><span class="line"></span><br><span class="line">logstash]<span class="comment"># cat /etc/logstash/conf.d/system-log.conf </span></span><br><span class="line">input &#123;</span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/var/log/messages"</span> <span class="comment">#日志路径</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"systemlog"</span> <span class="comment">#事件的唯一类型</span></span><br><span class="line">    start_position =&gt; <span class="string">"beginning"</span> <span class="comment">#第一次收集日志的位置</span></span><br><span class="line">    stat_interval =&gt; <span class="string">"3"</span> <span class="comment">#日志收集的间隔时间，默认的间隔事件为1秒钟</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  file &#123;</span><br><span class="line">    path =&gt; <span class="string">"/var/log/secure"</span></span><br><span class="line">    <span class="built_in">type</span> =&gt; <span class="string">"securelog"</span></span><br><span class="line">    start_position =&gt; <span class="string">"beginning"</span></span><br><span class="line">    stat_interval =&gt; <span class="string">"3"</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">output &#123; </span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"systemlog"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [<span class="string">"192.168.15.11:9200"</span>]</span><br><span class="line">      index =&gt; <span class="string">"system-log-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">    &#125;&#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> [<span class="built_in">type</span>] == <span class="string">"securelog"</span> &#123;</span><br><span class="line">    elasticsearch &#123;</span><br><span class="line">      hosts =&gt; [<span class="string">"192.168.15.11:9200"</span>]</span><br><span class="line">      index =&gt; <span class="string">"secury-log-%&#123;+YYYY.MM.dd&#125;"</span></span><br><span class="line">    &#125;&#125;    </span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">修改权限 因为此文件默认属主和属组为root，也可以将logstash运行身份修改为root，可以在启动脚本中进行修改</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># chmod  644 /var/log/secure</span></span><br><span class="line">~]<span class="comment"># chmod  644 /var/log/messages</span></span><br><span class="line"></span><br><span class="line">检测配置文件语法</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># /usr/share/logstash/bin/logstash -f /etc/logstash/conf.d/systemlog.conf -t</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># systemctl restart logstash</span></span><br><span class="line"></span><br><span class="line">模拟日志增加</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># echo "123" &gt;&gt; /var/log/messages </span></span><br><span class="line">~]<span class="comment"># echo "123" &gt;&gt; /var/log/secure</span></span><br></pre></td></tr></table></figure></p><p>在kibana界面添加system-log索引和secury-log索引:<br><img src="/2019/02/19/ELK之Logstash安装及基本语法/5.png" alt=""></p><p>kibana展示<br><img src="/2019/02/19/ELK之Logstash安装及基本语法/6.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ELK之Logstash安装及基本语法&quot;&gt;&lt;a href=&quot;#ELK之Logstash安装及基本语法&quot; class=&quot;headerlink&quot; title=&quot;ELK之Logstash安装及基本语法&quot;&gt;&lt;/a&gt;ELK之Logstash安装及基本语法&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/19/ELK之Logstash安装及基本语法/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>ELK介绍及ES集群安装</title>
    <link href="https://daizhe.net.cn/2019/02/19/ELK%E4%BB%8B%E7%BB%8D%E5%8F%8AES%E9%9B%86%E7%BE%A4%E5%AE%89%E8%A3%85/"/>
    <id>https://daizhe.net.cn/2019/02/19/ELK介绍及ES集群安装/</id>
    <published>2019-02-19T02:29:35.219Z</published>
    <updated>2019-02-20T07:25:58.646Z</updated>
    
    <content type="html"><![CDATA[<h1 id="ELK介绍及集群安装"><a href="#ELK介绍及集群安装" class="headerlink" title="ELK介绍及集群安装"></a>ELK介绍及集群安装</h1><p><img src="/2019/02/19/ELK介绍及ES集群安装/标题.gif" alt=""><br><a id="more"></a></p><h1 id="介绍ELK"><a href="#介绍ELK" class="headerlink" title="介绍ELK"></a>介绍ELK</h1><h2 id="什么是ELK？"><a href="#什么是ELK？" class="headerlink" title="什么是ELK？"></a>什么是ELK？</h2><ul><li>通俗来讲，ELK是由Elasticsearch、Logstash、Kibana 、filebeat三个开源软件的组成的一个组合体，这三个软件当中，每个软件用于完成不同的功能，ELK 又称为ELK stack，官方域名为stactic.co，ELK stack的主要优点有如下几个：<ul><li><code>1.处理方式灵活： elasticsearch是实时全文索引，具有强大的搜索功能</code></li><li><code>2.配置相对简单：elasticsearch全部使用JSON 接口，logstash使用模块配置，kibana的配置文件部分更简单。</code></li><li><code>3.检索性能高效：基于优秀的设计，虽然每次查询都是实时，但是也可以达到百亿级数据的查询秒级响应。</code></li><li><code>4.集群线性扩展：elasticsearch和logstash都可以灵活线性扩展</code></li><li><code>5.前端操作绚丽：kibana的前端设计比较绚丽，而且操作简单（前端前端展示界面）</code></li></ul></li></ul><h2 id="什么是Elasticsearch："><a href="#什么是Elasticsearch：" class="headerlink" title="什么是Elasticsearch："></a>什么是Elasticsearch：</h2><ul><li>是一个高度可扩展的开源全文搜索和分析引擎，它可实现数据的实时全文搜索搜索、支持分布式可实现高可用、提供API接口，可以处理大规模日志数据，比如Nginx、Tomcat、系统日志等功能。</li></ul><p><img src="/2019/02/19/ELK介绍及ES集群安装/1.png" alt=""></p><h2 id="什么是Logstash"><a href="#什么是Logstash" class="headerlink" title="什么是Logstash"></a>什么是Logstash</h2><ul><li>可以通过插件实现日志收集和转发，支持日志过滤，支持普通log、自定义json格式的日志解析。</li></ul><p><img src="/2019/02/19/ELK介绍及ES集群安装/2.png" alt=""></p><h2 id="什么是kibana："><a href="#什么是kibana：" class="headerlink" title="什么是kibana："></a>什么是kibana：</h2><ul><li>主要是通过接口调用elasticsearch的数据，并进行前端数据可视化的展现。</li></ul><p><img src="/2019/02/19/ELK介绍及ES集群安装/3.png" alt=""></p><h2 id="为什么使用-ELK？"><a href="#为什么使用-ELK？" class="headerlink" title="为什么使用 ELK？"></a>为什么使用 ELK？</h2><ul><li><p>ELK组件在海量日志系统的运维中，可用于解决以下主要问题：</p><ul><li>分布式日志数据统一收集，实现集中式查询和管理</li><li>故障排查</li><li>安全信息和事件管理</li><li>报表功能</li></ul></li><li><p>ELK组件在大数据运维系统中，主要可解决的问题如下：</p><ul><li>日志查询，问题排查，故障恢复，故障自愈</li><li>应用日志分析，错误报警</li><li>性能分析，用户行为分析</li></ul></li></ul><hr><h2 id="ELK使用场景"><a href="#ELK使用场景" class="headerlink" title="ELK使用场景"></a>ELK使用场景</h2><p><img src="/2019/02/19/ELK介绍及ES集群安装/4.png" alt=""></p><hr><h1 id="ELK–-gt-elasticsearch（ES）"><a href="#ELK–-gt-elasticsearch（ES）" class="headerlink" title="ELK–&gt;elasticsearch（ES）"></a>ELK–&gt;elasticsearch（ES）</h1><h2 id="Host1和Host2主机-elasticsearch（ES）部署：（es-java环境）"><a href="#Host1和Host2主机-elasticsearch（ES）部署：（es-java环境）" class="headerlink" title="Host1和Host2主机 elasticsearch（ES）部署：（es+java环境）"></a>Host1和Host2主机 elasticsearch（ES）部署：（es+java环境）</h2><p><img src="/2019/02/19/ELK介绍及ES集群安装/19.png" alt=""></p><p>1：环境初始化：</p><ul><li>最小化安装 Centos 7.2 x86_64操作系统的虚拟机，vcpu 2，内存4G或更多，操作系统盘50G，主机名设置规则为linux-hostX.exmaple.com，其中host1和host2为elasticsearch服务器，为保证效果特额外添加一块单独的数据磁盘大小为50G并格式化挂载。</li></ul><p>2：host1和host2添加磁盘格式化挂载：</p><p><img src="/2019/02/19/ELK介绍及ES集群安装/5.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">查看原有磁盘数量</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># lsblk</span></span><br><span class="line">    NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">    sda      8:0    0  200G  0 disk </span><br><span class="line"></span><br><span class="line">新添加的磁盘在不重启主机的情况下扫描发现新的磁盘</span><br><span class="line">    ~]<span class="comment"># echo "- - -" &gt; /sys/class/scsi_host/host0(TAB)/scan</span></span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># lsblk</span></span><br><span class="line">    NAME   MAJ:MIN RM  SIZE RO TYPE MOUNTPOINT</span><br><span class="line">    sda      8:0    0  200G  0 disk </span><br><span class="line">    sdb      8:16   0   50G  0 disk</span><br><span class="line"></span><br><span class="line">格式化新的磁盘（用于存放收集的日志）</span><br><span class="line">    </span><br><span class="line">    ~]<span class="comment"># mkfs.xfs /dev/sdb </span></span><br><span class="line"></span><br><span class="line">挂载新的磁盘，/data/esdata目录用来存放elasticsearch存储数据</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># mkdir -p /data/&#123;esdata,eslogs&#125;</span></span><br><span class="line">    ~]<span class="comment"># mount /dev/sdb /data/</span></span><br><span class="line">    ~]<span class="comment"># lsblk</span></span><br><span class="line">    sdb      8:16   0   50G  0 disk /data/</span><br><span class="line"></span><br><span class="line">设置开机自动挂载</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># vim /etc/fstab </span></span><br><span class="line">    <span class="comment">#最好使用uuid进行挂载。使用blkid /dev/sdb查看磁盘的uuid</span></span><br><span class="line">    /dev/sdb /data xfs defaults 0 0</span><br></pre></td></tr></table></figure><p>3：host1和host2防火墙和selinux：</p><ul><li>关闭防所有服务器的火墙和selinux，包括web服务器、redis和logstash服务器的防火墙和selinux全部关闭，此步骤是为了避免出现因为防火墙策略或selinux安全权限引起的各种未知问题，以下只显示了host1和host2的命令，但是其他服务器都要执行。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># systemctl  disable  firewalld</span></span><br><span class="line">~]<span class="comment"># systemctl  disable NetworkManager</span></span><br><span class="line">~]<span class="comment"># sed -i '/SELINUX/s/enforcing/disabled/' /etc/selinux/config</span></span><br><span class="line">~]<span class="comment"># echo "* soft nofile 65536" &gt;&gt; /etc/security/limits.conf</span></span><br><span class="line">~]<span class="comment"># echo "* hard nofile 65536" &gt;&gt; /etc/security/limits.conf</span></span><br></pre></td></tr></table></figure></li></ul><p>4：host1和host2设置epel源、安装基本操作命令并同步时间以及各服务器配置本地域名解析：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">各服务器配置本地域名解析</span><br><span class="line"></span><br><span class="line">主机名立即生效</span><br><span class="line">~]<span class="comment">#vim /etc/hostname</span></span><br><span class="line">~]<span class="comment">#hostname es1.com #退出重新登陆则生效</span></span><br><span class="line"></span><br><span class="line">host1和host2 ~]<span class="comment"># vim /etc/hosts</span></span><br><span class="line">192.168.15.11 linux-host1.exmaple.com</span><br><span class="line">192.168.15.12 linux-host2.exmaple.com</span><br><span class="line">192.168.15.13 linux-host3.exmaple.com</span><br><span class="line">192.168.15.14 linux-host4.exmaple.com</span><br><span class="line">192.168.15.15 linux-host5.exmaple.com</span><br><span class="line">192.168.15.16 linux-host6.exmaple.com</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">获取epel源</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># wget -O /etc/yum.repos.d/epel.repo http://mirrors.aliyun.com/repo/epel-7.repo</span></span><br><span class="line"></span><br><span class="line">安装依赖包</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># yum install -y net-tools vim lrzsz tree screen lsof tcpdump wget ntpdate</span></span><br><span class="line"></span><br><span class="line">设置时间同步并设置计划任务定时同步时间</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># cp /usr/share/zoneinfo/Asia/Shanghai  /etc/localtime </span></span><br><span class="line">    ~]<span class="comment"># echo "*/5 * * * *  ntpdate time1.aliyun.com &amp;&gt; /dev/null &amp;&amp; hwclock -w" &gt;&gt; /var/spool/cron/root</span></span><br><span class="line">    ~]<span class="comment"># systemctl  restart crond</span></span><br><span class="line">    ~]<span class="comment"># reboot  #重启检查各项配置是否生效，没有问题的话给虚拟机做快照以方便后期还原</span></span><br></pre></td></tr></table></figure></p><hr><p>5：在host1和host2分别安装elasticsearch：</p><p>5.1：在两台服务器准备java环境：</p><ul><li>因为elasticsearch服务运行需要java环境，因此两台elasticsearch服务器需要安装java环境，可以使用以下方式安装：</li></ul><p>方式一：直接使用yum安装openjdk<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># yum install  java-1.8.0*</span></span><br></pre></td></tr></table></figure></p><p>方式二：本地安装在oracle官网下载rpm安装包：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># yum  localinstall jdk-8u92-linux-x64.rpm</span></span><br></pre></td></tr></table></figure></p><p>方式三：下载二进制包自定义profile环境变量：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">下载地址：http://www.oracle.com/technetwork/java/javase/downloads/jdk8-downloads-2133151.html</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># tar xvf jdk-8u121-linux-x64.tar.gz  -C /usr/local/</span></span><br><span class="line">    ~]<span class="comment"># ln -sv /usr/local/jdk1.8.0_121 /usr/local/jdk</span></span><br><span class="line">    ~]<span class="comment"># vim /etc/profile</span></span><br><span class="line">    <span class="built_in">export</span> HISTTIMEFORMAT=<span class="string">"%F %T `whoami` "</span></span><br><span class="line">    <span class="built_in">export</span> JAVA_HOME=/usr/<span class="built_in">local</span>/jdk</span><br><span class="line">    <span class="built_in">export</span> CLASSPATH=.:<span class="variable">$JAVA_HOME</span>/jre/lib/rt.jar:<span class="variable">$JAVA_HOME</span>/lib/dt.jar:<span class="variable">$JAVA_HOME</span>/lib/tools.jar</span><br><span class="line">    <span class="built_in">export</span> PATH=<span class="variable">$PATH</span>:<span class="variable">$JAVA_HOME</span>/bin</span><br><span class="line">    ~]<span class="comment"># source  /etc/profile</span></span><br><span class="line">    ~]<span class="comment"># java -version</span></span><br><span class="line">    java version <span class="string">"1.8.0_121"</span> <span class="comment">#确认可以出现当前的java版本号</span></span><br><span class="line">    Java(TM) SE Runtime Environment (build 1.8.0_121-b13)</span><br><span class="line">    Java HotSpot(TM) 64-Bit Server VM (build 25.121-b13, mixed mode)</span><br></pre></td></tr></table></figure></p><p>这里采用rpm包方式安装JDK<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># ls</span></span><br><span class="line">jdk-8u192-linux-x64.rpm </span><br><span class="line">~]<span class="comment"># rpm -ivh jdk-8u192-linux-x64.rpm</span></span><br></pre></td></tr></table></figure></p><hr><p>5.2：官网下载elasticsearch RPM包并安装：<br>下载地址：<a href="https://www.elastic.co/downloads/elasticsearch，当前最新版本5.3.0" target="_blank" rel="noopener">https://www.elastic.co/downloads/elasticsearch，当前最新版本5.3.0</a></p><p>host1和host2两台服务器分别安装elasticsearch:<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># rpm -ivh elasticsearch-5.6.13.rpm </span></span><br><span class="line">~]<span class="comment"># rpm -ql elasticsearch </span></span><br><span class="line"><span class="comment">#主配置文件</span></span><br><span class="line">/etc/elasticsearch/elasticsearch.yml    </span><br><span class="line"><span class="comment">#调优的配置文件</span></span><br><span class="line">/etc/elasticsearch/jvm.options</span><br><span class="line"><span class="comment">#启动程序文件（默认定义的启动程序的身份为elasticsearch用户）</span></span><br><span class="line">/usr/lib/systemd/system/elasticsearch.service   </span><br><span class="line"></span><br><span class="line"><span class="comment">#主要使用.jar文件实现模块化的扩展</span></span><br></pre></td></tr></table></figure></p><p>6：目录权限更改：<br>host1和host2各服务器创建数据和日志目录并修改目录权限为elasticsearch：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># mkdir /data/&#123;esdata,eslogs&#125;</span></span><br><span class="line">~]<span class="comment"># chown -R elasticsearch.elasticsearch /data</span></span><br></pre></td></tr></table></figure></p><p>7：编辑host1和host2各elasticsearch服务器的服务配置文件解析：<br>配置的官方帮助文档：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/index.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/index.html</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#未特殊标注的host1和host2主机的配置相同</span></span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># vim /etc/elasticsearch/elasticsearch.yml </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#ELK的集群名称，名称相同即属于是同一个集群（集群名称是各个ES服务端一致的）</span></span><br><span class="line">    17 cluster.name: ELK-Cluster    <span class="comment">#将host1节点和host2节点集群名称保持一致</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#本机在集群内的节点名称（各ES节点的node.name不可重复）</span></span><br><span class="line">    23 node.name: elk-node1    <span class="comment">#host1名称elk-node1 #host2名称elk-node2</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#数据保存目录</span></span><br><span class="line">    33 path.data: /data/esdata </span><br><span class="line"></span><br><span class="line">    <span class="comment">#日志保存目录 </span></span><br><span class="line">    37 path.logs: /data/eslogs</span><br><span class="line"></span><br><span class="line">    <span class="comment">#服务启动的时候锁定足够的内存，防止数据写入swap   </span></span><br><span class="line">    <span class="comment">#43 bootstrap.memory_lock: true </span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#监听IP，默认监听本机的所有地址</span></span><br><span class="line">    55 network.host: 0.0.0.0 </span><br><span class="line"></span><br><span class="line">    <span class="comment">#客户端端口，提供Logstash向elasticsearch写上缴日志数据时使用(还有一个9300,elasticsearch集群中同步数据以及集群间状态选举通讯使用)</span></span><br><span class="line">    59 http.port: 9200 </span><br><span class="line"></span><br><span class="line">    <span class="comment">#集群几点状态发现使用，默认在整个网段中做广播，改为组播的方式，指定哪些机器发送数据包（设置尽在host1主机和host2主机间发送组播）</span></span><br><span class="line">    68 discovery.zen.ping.unicast.hosts: [<span class="string">"host1地址"</span>, <span class="string">"host2地址"</span>]</span><br><span class="line"></span><br><span class="line">    生产参考配置项</span><br><span class="line"></span><br><span class="line">    <span class="comment">#discovery.zen.minimum_master_nodes: 3    </span></span><br><span class="line">    <span class="comment">#设置这个参数来保证集群中的节点可以知道其它N个有</span></span><br><span class="line">    <span class="comment">#master资格的节点，默认为1，当集群多余三个节点时，可以设置大一点的值(2-4)</span></span><br><span class="line"></span><br><span class="line">    生产配置项：了解即可</span><br><span class="line"></span><br><span class="line">    <span class="comment">#gateway.recover_after_nodes: 3    </span></span><br><span class="line">    <span class="comment">#在完全重新启动集群后阻塞初始恢复，直到启动N个节点:</span></span><br><span class="line">    </span><br><span class="line">    <span class="comment">#node.max_local_storage_nodes: 1</span></span><br><span class="line">    <span class="comment">#默认情况下，多个节点可以在同一个安装路径启动，如果你想让你的Elasticsearch只启动一个节点，在这合理设置。</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">#设置是否可以通过正则或者_all删除或者关闭索引。</span></span><br><span class="line">    <span class="comment">#action.destructive_requires_name: true</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">host1配置主文件</span><br><span class="line">    ~]<span class="comment"># grep "^[a-Z]" /etc/elasticsearch/elasticsearch.yml</span></span><br><span class="line">    cluster.name: ELK-Cluster</span><br><span class="line">    node.name: elk-node1</span><br><span class="line">    path.data: /data/esdata</span><br><span class="line">    path.logs: /data/eslogs</span><br><span class="line">    network.host: 0.0.0.0</span><br><span class="line">    http.port: 9200</span><br><span class="line">    discovery.zen.ping.unicast.hosts: [<span class="string">"host1地址"</span>, <span class="string">"host2地址"</span>]</span><br><span class="line"></span><br><span class="line">host2配置文件</span><br><span class="line">    ~]<span class="comment"># grep "^[a-Z]" /etc/elasticsearch/elasticsearch.yml</span></span><br><span class="line">    cluster.name: ELK-Cluster</span><br><span class="line">    node.name: elk-node2</span><br><span class="line">    path.data: /data/esdata</span><br><span class="line">    path.logs: /data/eslogs</span><br><span class="line">    bootstrap.memory_lock: <span class="literal">true</span></span><br><span class="line">    network.host: 0.0.0.0</span><br><span class="line">    http.port: 9200</span><br><span class="line">    discovery.zen.ping.unicast.hosts: [<span class="string">"host1地址"</span>, <span class="string">"host2地址"</span>]</span><br></pre></td></tr></table></figure></p><p>8：host1和host2启动elasticsearch服务并验证，端口监听是否成功：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># systemctl  restart elasticsearch</span></span><br><span class="line">~]<span class="comment"># systemctl  enable elasticsearch</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># tail -f /data/eslogs/ELK-Cluster.log </span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># ss -tnl</span></span><br><span class="line">:::9200       <span class="comment">#用户访问的接口                                               </span></span><br><span class="line">:::9300       <span class="comment">#集群内部通讯的端口</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># ps -ef | grep elasticsearch</span></span><br><span class="line"><span class="comment">#默认的可使用的最大内存和最小内存未2G</span></span><br><span class="line">elastic+  15756      1 10 14:04 ?        00:00:31 /bin/java -Xms2g -Xmx2g</span><br></pre></td></tr></table></figure></p><p>9：通过浏览器访问elasticsearch服务端口：</p><p>9.1：访问host1主机</p><p><img src="/2019/02/19/ELK介绍及ES集群安装/6.png" alt=""></p><p>9.2：访问host2主机</p><p><img src="/2019/02/19/ELK介绍及ES集群安装/7.png" alt=""></p><hr><p>10：host1和host2修改启动脚本，修改内存限制，并同步配置文件：</p><h4 id="这里为测试场景不需要修改"><a href="#这里为测试场景不需要修改" class="headerlink" title="这里为测试场景不需要修改"></a>这里为测试场景不需要修改</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">编辑elasticsearch启动脚本声明启动时都内存不做限制</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># vim /usr/lib/systemd/system/elasticsearch.service #修改内存限制</span></span><br><span class="line">    40 LimitMEMLOCK=infinity  <span class="comment">#最大化使用内存</span></span><br><span class="line"></span><br><span class="line">编辑修改elasticsearch节点中的内存限制配置文件</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># vim /etc/elasticsearch/jvm.options </span></span><br><span class="line">    22 -Xms2g</span><br><span class="line">    23 -Xmx2g <span class="comment">#最小和最大内存限制，为什么最小和最大设置一样大？(不可设置为浮点数，只可以设置为整数)</span></span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">    ~]<span class="comment"># systemctl  start elasticsearch</span></span><br></pre></td></tr></table></figure><p>官方配置文档最大建议30G以内：<a href="https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html" target="_blank" rel="noopener">https://www.elastic.co/guide/en/elasticsearch/reference/current/heap-size.html</a></p><h4 id="后面安装elasticsearch插件之head-由于宿主机内存不足，系统内核会将占用内存最大的进程强制kill掉，以保证系统的正常运行以及其他服务的正常运行。"><a href="#后面安装elasticsearch插件之head-由于宿主机内存不足，系统内核会将占用内存最大的进程强制kill掉，以保证系统的正常运行以及其他服务的正常运行。" class="headerlink" title="后面安装elasticsearch插件之head,由于宿主机内存不足，系统内核会将占用内存最大的进程强制kill掉，以保证系统的正常运行以及其他服务的正常运行。"></a>后面安装elasticsearch插件之head,由于宿主机内存不足，系统内核会将占用内存最大的进程强制kill掉，以保证系统的正常运行以及其他服务的正常运行。</h4><p><img src="/2019/02/19/ELK介绍及ES集群安装/8.png" alt=""><br><img src="/2019/02/19/ELK介绍及ES集群安装/9.png" alt=""></p><hr><h1 id="ES插件"><a href="#ES插件" class="headerlink" title="ES插件"></a>ES插件</h1><h2 id="安装elasticsearch插件之head"><a href="#安装elasticsearch插件之head" class="headerlink" title="安装elasticsearch插件之head"></a>安装elasticsearch插件之head</h2><p>1：安装elasticsearch插件之head：</p><ul><li>插件是为了完成不同的功能，官方提供了一些插件但大部分是收费的，另外也有一些开发爱好者提供的插件，可以实现对elasticsearch集群的状态监控与管理配置等功能。<br>1.4.1：安装5.x版本的head插件： </li><li>在elasticsearch 5.x版本以后不再支持直接安装head插件，而是需要通过启动一个服务方式，</li><li>github托管地址：<a href="https://github.com/mobz/elasticsearch-head" target="_blank" rel="noopener">https://github.com/mobz/elasticsearch-head</a></li></ul><p>2：host1和host2服务放置安装elasticsearch插件之head<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># yum install -y npm</span></span><br><span class="line"><span class="comment"># NPM的全称是Node Package Manager，是随同NodeJS一起安装的包管理和分发工具，它很方便让JavaScript开发者下载、安装、上传以及管理已经安装的包。</span></span><br><span class="line">~]<span class="comment"># cd /usr/local/src/</span></span><br><span class="line">src]<span class="comment">#git clone git://github.com/mobz/elasticsearch-head.git </span></span><br><span class="line">src]<span class="comment"># cd elasticsearch-head/</span></span><br><span class="line">elasticsearch-head]<span class="comment"># yum install npm -y</span></span><br><span class="line">elasticsearch-head]<span class="comment"># npm install grunt -save</span></span><br><span class="line">elasticsearch-head]<span class="comment"># ll node_modules/grunt  #确认生成文件</span></span><br><span class="line">elasticsearch-head]<span class="comment"># npm install #执行安装</span></span><br><span class="line"> </span><br><span class="line">elasticsearch-head]<span class="comment"># npm run start  &amp;  #后台启动服务</span></span><br></pre></td></tr></table></figure></p><p>2.1：host1和host2修改elasticsearch服务配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">开启跨域访问支持，然后重启elasticsearch服务：</span><br><span class="line">    ~]<span class="comment"># vim /etc/elasticsearch/elasticsearch.yml </span></span><br><span class="line">    http.cors.enabled: <span class="literal">true</span> </span><br><span class="line">    http.cors.allow-origin: <span class="string">"*"</span></span><br><span class="line">    ~]<span class="comment"># /etc/init.d/elasticsearch  restart</span></span><br></pre></td></tr></table></figure></p><hr><p>3：host1和host2docker安装elasticsearch插件之head<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line">安装docker</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># cd /etc/yum.repos.d/</span></span><br><span class="line">    yum.repos.d]<span class="comment"># wget https://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span><br><span class="line"></span><br><span class="line">安装时如果报这种错误并解决</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># yum install docker-ce -y</span></span><br><span class="line">    You could try using --skip-broken to work around the problem</span><br><span class="line">    You could try running: rpm -Va --nofiles --nodigest</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># yum install http://vault.centos.org/centos/7.3.1611/extras/x86_64/Packages/container-selinux-2.9-4.el7.noarch.rpm</span></span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># yum install docker-ce -y</span></span><br><span class="line"></span><br><span class="line">启动docker并加入开机启动项</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># systemctl  start docker &amp;&amp; systemctl  enable docker</span></span><br><span class="line"></span><br><span class="line">使用dicker 下载head镜像</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># docker pull mobz/elasticsearch-head:5</span></span><br><span class="line"></span><br><span class="line">以容器的方式运行elasticsearch插件head，并映射端口到宿主机</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># docker run -d  -p 9100:9100 mobz/elasticsearch-head:5</span></span><br><span class="line"></span><br><span class="line">查看容器的状态</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># docker ps -a</span></span><br><span class="line">    CONTAINER ID        IMAGE                       COMMAND                  CREATED             STATUS              PORTS                    NAMES</span><br><span class="line">    ca48d7d13e87        mobz/elasticsearch-head:5   <span class="string">"/bin/sh -c 'grunt s…"</span>   34 seconds ago      Up 31 seconds       0.0.0.0:9100-&gt;9100/tcp   compassionate_williamson</span><br></pre></td></tr></table></figure></p><p>3.1：host1和host2修改elasticsearch服务配置文件：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">开启跨域访问支持，然后重启elasticsearch服务：</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># vim /etc/elasticsearch/elasticsearch.yml </span></span><br><span class="line">    <span class="comment">#可以添加至配置文件的最后一行中</span></span><br><span class="line">    http.cors.enabled: <span class="literal">true</span> </span><br><span class="line">    http.cors.allow-origin: <span class="string">"*"</span></span><br><span class="line"></span><br><span class="line">重启启动elasticsearch</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># systemctl restart elasticsearch.service</span></span><br></pre></td></tr></table></figure></p><p>4：通过浏览器访问host1和host2主机elasticsearch组件head,映射宿主机的端口为9100<br><img src="/2019/02/19/ELK介绍及ES集群安装/10.png" alt=""></p><p>5：Master与Slave的区别：</p><ul><li>Master的职责：<ul><li>统计各node节点状态信息、集群状态信息统计、索引的创建和删除、索引分配的管理、关闭node节点等</li></ul></li><li>Slave的职责：<ul><li>从master同步数据、等待机会成为Master</li></ul></li></ul><hr><p>6：导入本地的docker镜像：</p><h4 id="本章外"><a href="#本章外" class="headerlink" title="本章外"></a>本章外</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># docker save docker.io/mobz/elasticsearch-head &gt; /opt/elasticsearch-head-docker.tar.gz #导出镜像</span></span><br><span class="line">src]<span class="comment"># docker load &lt; /opt/elasticsearch-head-docker.tar.gz #导入</span></span><br><span class="line">src]<span class="comment"># docker images#验证</span></span><br><span class="line">REPOSITORY                          TAG                 IMAGE ID            CREATED             SIZE</span><br><span class="line">docker.io/mobz/elasticsearch-head   5                   b19a5c98e43b        4 months ago        823.9 MB</span><br><span class="line">src]<span class="comment"># docker run -d  -p 9100:9100 --name elastic docker.io/mobz/elasticsearch-head:5  #从本地docker images 启动容器</span></span><br></pre></td></tr></table></figure><hr><h2 id="1-4-2：elasticsearch插件之kopf"><a href="#1-4-2：elasticsearch插件之kopf" class="headerlink" title="1.4.2：elasticsearch插件之kopf"></a>1.4.2：elasticsearch插件之kopf</h2><p>1：elasticsearch插件之kopf：<br>2：kopf(已经无人维护)：</p><ul><li>Git地址:<a href="https://github.com/lmenezes/elasticsearch-kopf" target="_blank" rel="noopener">https://github.com/lmenezes/elasticsearch-kopf</a></li><li>但是目前还不支持5.x版本的elasticsearch，但是可以安装在elasticsearc 1.x或2.x的版本安装。</li></ul><hr><h1 id="ELK集群监控"><a href="#ELK集群监控" class="headerlink" title="ELK集群监控"></a>ELK集群监控</h1><h2 id="使用AIP接口（curl）状态查看"><a href="#使用AIP接口（curl）状态查看" class="headerlink" title="使用AIP接口（curl）状态查看"></a>使用AIP接口（curl）状态查看</h2><p>1：监控elasticsearch集群状态：<br>2：通过shell命令/python脚本获取集群状态（使用zabbix监控集群状态结合python脚本）：</p><ul><li>获取到的是一个json格式的返回值，那就可以通过python对其中的信息进行分析，例如对status进行分析，如果等于green(绿色)就是运行在正常，等于yellow(黄色)表示副本分片丢失，red(红色)表示主分片丢失</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">curl -sXGET  http://192.168.15.211:9200/_cluster/health?pretty=<span class="literal">true</span></span><br></pre></td></tr></table></figure><p><img src="/2019/02/19/ELK介绍及ES集群安装/12.png" alt=""></p><h2 id="对elasticsearch集群状态监控，并结合zabbix实现报警，原理为通过python脚本获取到elasticsearch集群的运行状态并取出status的值，如果状态为green表示正常的值就传递给zabbix一个值为100，如果是其他状态就返回值为50，zabbix根据最后一个值的结果判断，如果不是100就报警，设置如下："><a href="#对elasticsearch集群状态监控，并结合zabbix实现报警，原理为通过python脚本获取到elasticsearch集群的运行状态并取出status的值，如果状态为green表示正常的值就传递给zabbix一个值为100，如果是其他状态就返回值为50，zabbix根据最后一个值的结果判断，如果不是100就报警，设置如下：" class="headerlink" title="对elasticsearch集群状态监控，并结合zabbix实现报警，原理为通过python脚本获取到elasticsearch集群的运行状态并取出status的值，如果状态为green表示正常的值就传递给zabbix一个值为100，如果是其他状态就返回值为50，zabbix根据最后一个值的结果判断，如果不是100就报警，设置如下："></a>对elasticsearch集群状态监控，并结合zabbix实现报警，原理为通过python脚本获取到elasticsearch集群的运行状态并取出status的值，如果状态为green表示正常的值就传递给zabbix一个值为100，如果是其他状态就返回值为50，zabbix根据最后一个值的结果判断，如果不是100就报警，设置如下：</h2><p>1.python脚本：取出集群的状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">[root@linux-host1 ~]<span class="comment"># cat  els-cluster-monitor.py </span></span><br><span class="line">[root@es1 ~]<span class="comment"># cat  es.py</span></span><br><span class="line"><span class="comment">#!/usr/bin/env python</span></span><br><span class="line"><span class="comment">#coding:utf-8</span></span><br><span class="line"><span class="comment">#Author Zhang Jie</span></span><br><span class="line"></span><br><span class="line">import smtplib</span><br><span class="line">from email.mime.text import MIMEText</span><br><span class="line">from email.utils import formataddr</span><br><span class="line">import subprocess</span><br><span class="line">body = <span class="string">""</span></span><br><span class="line"><span class="literal">false</span>=<span class="string">"false"</span></span><br><span class="line">obj = subprocess.Popen((<span class="string">"curl -sXGET http://192.168.15.211:9200/_cluster/health?pretty=true"</span>),shell=True, stdout=subprocess.PIPE)</span><br><span class="line">data =  obj.stdout.read()</span><br><span class="line">data1 = <span class="built_in">eval</span>(data)</span><br><span class="line">status = data1.get(<span class="string">"status"</span>)</span><br><span class="line"><span class="keyword">if</span> status == <span class="string">"green"</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"50"</span>)</span><br><span class="line"><span class="keyword">else</span>:</span><br><span class="line">    <span class="built_in">print</span>(<span class="string">"100"</span>)</span><br><span class="line"></span><br><span class="line">[root@elk-s1 ~]<span class="comment"># chmod  a+x /etc/zabbix/zabbix_agentd.d/els_status.py</span></span><br><span class="line"></span><br><span class="line">脚本执行结果：</span><br><span class="line">~]<span class="comment"># python els-cluster-monitor.py </span></span><br><span class="line">50</span><br></pre></td></tr></table></figure></p><p>2.zabbix 添加监控<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">配置zabbix-agent配置文件导入自定义配置文件：</span><br><span class="line"></span><br><span class="line">[root@elk-s1 ~]<span class="comment"># vim /etc/zabbix/zabbix_agentd.conf</span></span><br><span class="line">Include=/etc/zabbix/zabbix_agentd.d/*.conf</span><br><span class="line"></span><br><span class="line">自定义配置文件：</span><br><span class="line"></span><br><span class="line">[root@elk-s1 ~]<span class="comment"># vim /etc/zabbix/zabbix_agentd.d/els_status.conf</span></span><br><span class="line"></span><br><span class="line">UserParameter=els.status,/usr/bin/python /etc/zabbix/zabbix_agentd.d/els_status.py</span><br><span class="line"></span><br><span class="line">[root@elk-s1 ~]<span class="comment"># systemctl  restart zabbix-agent</span></span><br></pre></td></tr></table></figure></p><p>3.zabbix-server端测试能否获取到值，获取到100表示集群正常运行，否则表示出现问题需要排查：<br><img src="/2019/02/19/ELK介绍及ES集群安装/ELK介绍及集群安装/13.png" alt=""></p><p>4.在zabbix-serve的对应的elasticsearch服务器r端添加监控项：<br><img src="/2019/02/19/ELK介绍及ES集群安装/14.png" alt=""></p><p>5.创建触发器<br><img src="/2019/02/19/ELK介绍及ES集群安装/15.png" alt=""></p><p>6.创建图形<br><img src="/2019/02/19/ELK介绍及ES集群安装/16.png" alt=""></p><p>7.查看图形<br><img src="/2019/02/19/ELK介绍及ES集群安装/17.png" alt=""></p><p>8.关闭一个elasticsearch服务器测试能否触发邮件报警：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">[root@els-s2 tianqi]<span class="comment"># systemctl   stop  elasticsearch #在elasticsearch服务器关闭</span></span><br><span class="line">[root@Zabbix tianqi]<span class="comment"># zabbix_get  -s 192.168.0.33  -k els.status #在zabbix-server测试获取的返回值是否为50</span></span><br><span class="line">50</span><br></pre></td></tr></table></figure></p><p><img src="/2019/02/19/ELK介绍及ES集群安装/18.png" alt=""></p><p>9.关于elasticsearch存储index的定期删除，elasticsearch存储的日志较多的时候会影响搜索性能，因此建议定期清理，脚本如下，这次是shell脚本：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line">DATE=`date -d <span class="string">"2 days ago"</span> +%Y.%m.%d`</span><br><span class="line">LOG_NAME=<span class="string">"api4-systemlog"</span></span><br><span class="line">FILE_NAME=<span class="variable">$&#123;LOG_NAME&#125;</span>-<span class="variable">$&#123;DATE&#125;</span></span><br><span class="line">curl -XDELETE  http://hfelk.chinacloudapp.cn:9200/<span class="variable">$&#123;FILE_NAME&#125;</span></span><br><span class="line"><span class="built_in">echo</span> <span class="string">"<span class="variable">$&#123;FILE_NAME&#125;</span> delete success"</span></span><br><span class="line"></span><br><span class="line">[root@els-s2 ~]<span class="comment"># chmod  a+x /root/els_delete.sh </span></span><br><span class="line"></span><br><span class="line">测试执行：</span><br><span class="line"></span><br><span class="line">[root@els-s2 ~]<span class="comment"># bash -x /root/els_delete.sh</span></span><br><span class="line">++ date -d <span class="string">'30 days ago'</span> +%Y.%m.%d</span><br><span class="line">+ DATE=2016.08.05</span><br><span class="line">+ LOG_NAME=api4-systemlog</span><br><span class="line">+ FILE_NAME=api4-systemlog-2016.08.05</span><br><span class="line">+ curl -XDELETE http://hfelk.chinacloudapp.cn:9200/api4-systemlog-2016.08.05</span><br><span class="line">&#123;<span class="string">"acknowledged"</span>:<span class="literal">true</span>&#125;+ <span class="built_in">echo</span> <span class="string">'api4-systemlog-2016.08.05 delete success'</span></span><br><span class="line">api4-systemlog-2016.08.05 delete success</span><br><span class="line"></span><br><span class="line">添加任务计定期执行即可：</span><br><span class="line"></span><br><span class="line">[root@els-s2 ~]<span class="comment"># crontab  -e</span></span><br><span class="line">1 * * * * /root/els_delete.sh <span class="comment">#每天凌晨一点清除一月之前的日志</span></span><br></pre></td></tr></table></figure></p><hr><p>列出集群中所有节点：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># curl -X  GET "http://172.18.135.1:9200/_cat/nodes "</span></span><br><span class="line">172.18.135.1  9 70 1 0.00 0.05 0.16 mdi * es1.com</span><br><span class="line">172.18.135.2 15 52 0 0.04 0.31 0.59 mdi - es2.com   <span class="comment"># mdi m es2.com此处的m表示可以成为备用master节点</span></span><br></pre></td></tr></table></figure></p><p>查看集群索引状态：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment">#  curl -X  GET "http://172.18.135.1:9200/_cat/nodes?v"</span></span><br><span class="line">ip           heap.percent ram.percent cpu load_1m load_5m load_15m node.role master name</span><br><span class="line">172.18.135.1           10          81   0    0.03    0.07     0.13 mdi       *      es1.com</span><br><span class="line">172.18.135.2           15          52   1    0.33    0.22     0.40 mdi       -      es2.com</span><br></pre></td></tr></table></figure></p><p>查看现在集群中哪个是主节点<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># curl -X  GET "http://172.18.135.1:9200/_cat/master"</span></span><br><span class="line">u5qBvduFQ3GOa5CjROsWOQ 172.18.135.1 172.18.135.1 es1.com</span><br></pre></td></tr></table></figure></p><p>_cat API来查看集群状态：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">集群状态：</span><br><span class="line">    green  正常</span><br><span class="line">    red    不可用</span><br><span class="line">    yellow  修复状态</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># curl -X  GET http://172.18.135.1:9200/_cat/health</span></span><br><span class="line">1550496241 21:24:01 ES green 2 2 0 0 0 0 0 0 - 100.0%</span><br></pre></td></tr></table></figure></p><p>_cat API帮助：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># curl -X  GET http://172.18.135.1:9200/_cat/nodes?help</span></span><br><span class="line"><span class="built_in">help</span>下面你发现了好多可选，比如说我想看<span class="built_in">help</span>下的 uptime，我应该用h= uptime的语法来看 </span><br><span class="line">~]<span class="comment"># curl -X  GET http://172.18.135.1:9200/_cat/nodes?h=uptime</span></span><br><span class="line">27.2m</span><br><span class="line">23.8m</span><br></pre></td></tr></table></figure></p><h3 id="1-5-2-cluster-API-分类总结"><a href="#1-5-2-cluster-API-分类总结" class="headerlink" title="1.5.2:cluster API 分类总结"></a>1.5.2:cluster API 分类总结</h3><p>1）_cluster/health 来显示集群状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># curl -X  GET "172.18.135.1:9200/_cluster/health?pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"ES"</span>,</span><br><span class="line">  <span class="string">"status"</span> : <span class="string">"green"</span>,</span><br><span class="line">  <span class="string">"timed_out"</span> : <span class="literal">false</span>,</span><br><span class="line">  <span class="string">"number_of_nodes"</span> : 2,</span><br><span class="line">  <span class="string">"number_of_data_nodes"</span> : 2,</span><br><span class="line">  <span class="string">"active_primary_shards"</span> : 0,</span><br><span class="line">  <span class="string">"active_shards"</span> : 0,</span><br><span class="line">  <span class="string">"relocating_shards"</span> : 0,</span><br><span class="line">  <span class="string">"initializing_shards"</span> : 0,</span><br><span class="line">  <span class="string">"unassigned_shards"</span> : 0,</span><br><span class="line">  <span class="string">"delayed_unassigned_shards"</span> : 0,</span><br><span class="line">  <span class="string">"number_of_pending_tasks"</span> : 0,</span><br><span class="line">  <span class="string">"number_of_in_flight_fetch"</span> : 0,</span><br><span class="line">  <span class="string">"task_max_waiting_in_queue_millis"</span> : 0,</span><br><span class="line">  <span class="string">"active_shards_percent_as_number"</span> : 100.0</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>2)  _cluster/state API  查看状态<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment">#  curl -XGET "http://172.18.135.1:9200/_cluster/state/nodes?pretty"</span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"ES"</span>,</span><br><span class="line">  <span class="string">"nodes"</span> : &#123;</span><br><span class="line">    <span class="string">"u5qBvduFQ3GOa5CjROsWOQ"</span> : &#123;</span><br><span class="line">      <span class="string">"name"</span> : <span class="string">"es1.com"</span>,</span><br><span class="line">      <span class="string">"ephemeral_id"</span> : <span class="string">"t7qVHOZSTuyjMa1d7Zhm7w"</span>,</span><br><span class="line">      <span class="string">"transport_address"</span> : <span class="string">"172.18.135.1:9300"</span>,</span><br><span class="line">      <span class="string">"attributes"</span> : &#123; &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"2jAXgTrdQfmZrsaLnDQATA"</span> : &#123;</span><br><span class="line">      <span class="string">"name"</span> : <span class="string">"es2.com"</span>,</span><br><span class="line">      <span class="string">"ephemeral_id"</span> : <span class="string">"BjSFicySSQGsF_X9Aqk0ng"</span>,</span><br><span class="line">      <span class="string">"transport_address"</span> : <span class="string">"172.18.135.2:9300"</span>,</span><br><span class="line">      <span class="string">"attributes"</span> : &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><p>3) _cluster/stats  API（统计）  统计数据<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br></pre></td><td class="code"><pre><span class="line">主要来查看索引、分片等</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># curl -XGET "http://172.18.135.1:9200/_cluster/stats?pretty" </span></span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">"_nodes"</span> : &#123;</span><br><span class="line">    <span class="string">"total"</span> : 2,</span><br><span class="line">    <span class="string">"successful"</span> : 2,</span><br><span class="line">    <span class="string">"failed"</span> : 0</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"cluster_name"</span> : <span class="string">"ES"</span>,</span><br><span class="line">  <span class="string">"timestamp"</span> : 1550496718730,</span><br><span class="line">  <span class="string">"status"</span> : <span class="string">"green"</span>,</span><br><span class="line">  <span class="string">"indices"</span> : &#123;</span><br><span class="line">    <span class="string">"count"</span> : 0,</span><br><span class="line">    <span class="string">"shards"</span> : &#123; &#125;,</span><br><span class="line">    <span class="string">"docs"</span> : &#123;</span><br><span class="line">      <span class="string">"count"</span> : 0,</span><br><span class="line">      <span class="string">"deleted"</span> : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"store"</span> : &#123;</span><br><span class="line">      <span class="string">"size_in_bytes"</span> : 0,</span><br><span class="line">      <span class="string">"throttle_time_in_millis"</span> : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"fielddata"</span> : &#123;</span><br><span class="line">      <span class="string">"memory_size_in_bytes"</span> : 0,</span><br><span class="line">      <span class="string">"evictions"</span> : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"query_cache"</span> : &#123;</span><br><span class="line">      <span class="string">"memory_size_in_bytes"</span> : 0,</span><br><span class="line">      <span class="string">"total_count"</span> : 0,</span><br><span class="line">      <span class="string">"hit_count"</span> : 0,</span><br><span class="line">      <span class="string">"miss_count"</span> : 0,</span><br><span class="line">      <span class="string">"cache_size"</span> : 0,</span><br><span class="line">      <span class="string">"cache_count"</span> : 0,</span><br><span class="line">      <span class="string">"evictions"</span> : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"completion"</span> : &#123;</span><br><span class="line">      <span class="string">"size_in_bytes"</span> : 0</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"segments"</span> : &#123;</span><br><span class="line">      <span class="string">"count"</span> : 0,</span><br><span class="line">      <span class="string">"memory_in_bytes"</span> : 0,</span><br><span class="line">      <span class="string">"terms_memory_in_bytes"</span> : 0,</span><br><span class="line">      <span class="string">"stored_fields_memory_in_bytes"</span> : 0,</span><br><span class="line">      <span class="string">"term_vectors_memory_in_bytes"</span> : 0,</span><br><span class="line">      <span class="string">"norms_memory_in_bytes"</span> : 0,</span><br><span class="line">      <span class="string">"points_memory_in_bytes"</span> : 0,</span><br><span class="line">      <span class="string">"doc_values_memory_in_bytes"</span> : 0,</span><br><span class="line">      <span class="string">"index_writer_memory_in_bytes"</span> : 0,</span><br><span class="line">      <span class="string">"version_map_memory_in_bytes"</span> : 0,</span><br><span class="line">      <span class="string">"fixed_bit_set_memory_in_bytes"</span> : 0,</span><br><span class="line">      <span class="string">"max_unsafe_auto_id_timestamp"</span> : -9223372036854775808,</span><br><span class="line">      <span class="string">"file_sizes"</span> : &#123; &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="string">"nodes"</span> : &#123;</span><br><span class="line">    <span class="string">"count"</span> : &#123;</span><br><span class="line">      <span class="string">"total"</span> : 2,</span><br><span class="line">      <span class="string">"data"</span> : 2,</span><br><span class="line">      <span class="string">"coordinating_only"</span> : 0,</span><br><span class="line">      <span class="string">"master"</span> : 2,</span><br><span class="line">      <span class="string">"ingest"</span> : 2</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"versions"</span> : [</span><br><span class="line">      <span class="string">"5.6.13"</span></span><br><span class="line">    ],</span><br><span class="line">    <span class="string">"os"</span> : &#123;</span><br><span class="line">      <span class="string">"available_processors"</span> : 4,</span><br><span class="line">      <span class="string">"allocated_processors"</span> : 4,</span><br><span class="line">      <span class="string">"names"</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"name"</span> : <span class="string">"Linux"</span>,</span><br><span class="line">          <span class="string">"count"</span> : 2</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"mem"</span> : &#123;</span><br><span class="line">        <span class="string">"total_in_bytes"</span> : 6144528384,</span><br><span class="line">        <span class="string">"free_in_bytes"</span> : 2384535552,</span><br><span class="line">        <span class="string">"used_in_bytes"</span> : 3759992832,</span><br><span class="line">        <span class="string">"free_percent"</span> : 39,</span><br><span class="line">        <span class="string">"used_percent"</span> : 61</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"process"</span> : &#123;</span><br><span class="line">      <span class="string">"cpu"</span> : &#123;</span><br><span class="line">        <span class="string">"percent"</span> : 1</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"open_file_descriptors"</span> : &#123;</span><br><span class="line">        <span class="string">"min"</span> : 160,</span><br><span class="line">        <span class="string">"max"</span> : 161,</span><br><span class="line">        <span class="string">"avg"</span> : 160</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"jvm"</span> : &#123;</span><br><span class="line">      <span class="string">"max_uptime_in_millis"</span> : 1998393,</span><br><span class="line">      <span class="string">"versions"</span> : [</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"version"</span> : <span class="string">"1.8.0_131"</span>,</span><br><span class="line">          <span class="string">"vm_name"</span> : <span class="string">"OpenJDK 64-Bit Server VM"</span>,</span><br><span class="line">          <span class="string">"vm_version"</span> : <span class="string">"25.131-b12"</span>,</span><br><span class="line">          <span class="string">"vm_vendor"</span> : <span class="string">"Oracle Corporation"</span>,</span><br><span class="line">          <span class="string">"count"</span> : 1</span><br><span class="line">        &#125;,</span><br><span class="line">        &#123;</span><br><span class="line">          <span class="string">"version"</span> : <span class="string">"1.8.0_161"</span>,</span><br><span class="line">          <span class="string">"vm_name"</span> : <span class="string">"OpenJDK 64-Bit Server VM"</span>,</span><br><span class="line">          <span class="string">"vm_version"</span> : <span class="string">"25.161-b14"</span>,</span><br><span class="line">          <span class="string">"vm_vendor"</span> : <span class="string">"Oracle Corporation"</span>,</span><br><span class="line">          <span class="string">"count"</span> : 1</span><br><span class="line">        &#125;</span><br><span class="line">      ],</span><br><span class="line">      <span class="string">"mem"</span> : &#123;</span><br><span class="line">        <span class="string">"heap_used_in_bytes"</span> : 301069112,</span><br><span class="line">        <span class="string">"heap_max_in_bytes"</span> : 2112618496</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"threads"</span> : 58</span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"fs"</span> : &#123;</span><br><span class="line">      <span class="string">"total_in_bytes"</span> : 75125227520,</span><br><span class="line">      <span class="string">"free_in_bytes"</span> : 75057504256,</span><br><span class="line">      <span class="string">"available_in_bytes"</span> : 75057504256,</span><br><span class="line">      <span class="string">"spins"</span> : <span class="string">"true"</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="string">"plugins"</span> : [ ],</span><br><span class="line">    <span class="string">"network_types"</span> : &#123;</span><br><span class="line">      <span class="string">"transport_types"</span> : &#123;</span><br><span class="line">        <span class="string">"netty4"</span> : 2</span><br><span class="line">      &#125;,</span><br><span class="line">      <span class="string">"http_types"</span> : &#123;</span><br><span class="line">        <span class="string">"netty4"</span> : 2</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p><hr><h3 id="补充了解"><a href="#补充了解" class="headerlink" title="补充了解"></a>补充了解</h3><p>_cluster系列<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">1、查询设置集群状态 </span><br><span class="line">curl -XGET localhost:9200/_cluster/health?pretty=<span class="literal">true</span> </span><br><span class="line">pretty=<span class="literal">true</span>表示格式化输出 </span><br><span class="line">level=indices 表示显示索引状态 </span><br><span class="line">level=shards 表示显示分片信息 </span><br><span class="line">2、curl -XGET localhost:9200/_cluster/stats?pretty=<span class="literal">true</span> </span><br><span class="line">显示集群系统信息，包括CPU JVM等等 </span><br><span class="line">3、curl -XGET localhost:9200/_cluster/state?pretty=<span class="literal">true</span> </span><br><span class="line">集群的详细信息。包括节点、分片等。 </span><br><span class="line">3、curl -XGET localhost:9200/_cluster/pending_tasks?pretty=<span class="literal">true</span> </span><br><span class="line">获取集群堆积的任务 </span><br><span class="line">3、修改集群配置 </span><br><span class="line">举例：</span><br><span class="line"></span><br><span class="line">curl -XPUT localhost:9200/_cluster/settings -d ‘&#123; </span><br><span class="line">“persistent” : &#123; </span><br><span class="line">“discovery.zen.minimum_master_nodes” : 2 </span><br><span class="line">&#125; </span><br><span class="line">&#125;’ </span><br><span class="line">transient 表示临时的，persistent表示永久的 </span><br><span class="line">4、curl -XPOST ‘localhost:9200/_cluster/reroute’ -d ‘xxxxxx’ </span><br><span class="line">对shard的手动控制，参考http://zhaoyanblog.com/archives/687.html </span><br><span class="line">5、关闭节点 </span><br><span class="line">关闭指定192.168.1.1节点 </span><br><span class="line">curl -XPOST ‘http://192.168.1.1:9200/_cluster/nodes/_local/_shutdown’ </span><br><span class="line">curl -XPOST ‘http://localhost:9200/_cluster/nodes/192.168.1.1/_shutdown’ </span><br><span class="line">关闭主节点 </span><br><span class="line">curl -XPOST ‘http://localhost:9200/_cluster/nodes/_master/_shutdown’ </span><br><span class="line">关闭整个集群 </span><br><span class="line">$ curl -XPOST ‘http://localhost:9200/_shutdown?delay=10s’ </span><br><span class="line">$ curl -XPOST ‘http://localhost:9200/_cluster/nodes/_shutdown’ </span><br><span class="line">$ curl -XPOST ‘http://localhost:9200/_cluster/nodes/_all/_shutdown’ </span><br><span class="line">delay=10s表示延迟10秒关闭</span><br></pre></td></tr></table></figure></p><p>_nodes系列<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">1、查询节点的状态 </span><br><span class="line">curl -XGET ‘http://localhost:9200/_nodes/stats?pretty=<span class="literal">true</span>’ </span><br><span class="line">curl -XGET ‘http://localhost:9200/_nodes/192.168.1.2/stats?pretty=<span class="literal">true</span>’ </span><br><span class="line">curl -XGET ‘http://localhost:9200/_nodes/process’ </span><br><span class="line">curl -XGET ‘http://localhost:9200/_nodes/_all/process’ </span><br><span class="line">curl -XGET ‘http://localhost:9200/_nodes/192.168.1.2,192.168.1.3/jvm,process’ </span><br><span class="line">curl -XGET ‘http://localhost:9200/_nodes/192.168.1.2,192.168.1.3/info/jvm,process’ </span><br><span class="line">curl -XGET ‘http://localhost:9200/_nodes/192.168.1.2,192.168.1.3/_all </span><br><span class="line">curl -XGET ‘http://localhost:9200/_nodes/hot_threads</span><br></pre></td></tr></table></figure></p><p>索引操作<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">1、获取索引 </span><br><span class="line">curl -XGET ‘http://localhost:9200/&#123;index&#125;/&#123;<span class="built_in">type</span>&#125;/&#123;id&#125;’ </span><br><span class="line">2、索引数据 </span><br><span class="line">curl -XPOST ‘http://localhost:9200/&#123;index&#125;/&#123;<span class="built_in">type</span>&#125;/&#123;id&#125;’ -d’&#123;“a”:”avalue”,”b”:”bvalue”&#125;’ </span><br><span class="line">3、删除索引 </span><br><span class="line">curl -XDELETE ‘http://localhost:9200/&#123;index&#125;/&#123;<span class="built_in">type</span>&#125;/&#123;id&#125;’ </span><br><span class="line">4、设置mapping</span><br><span class="line"></span><br><span class="line">curl -XPUT http://localhost:9200/&#123;index&#125;/&#123;<span class="built_in">type</span>&#125;/_mapping -d ‘&#123; </span><br><span class="line">“&#123;<span class="built_in">type</span>&#125;” : &#123; </span><br><span class="line">“properties” : &#123; </span><br><span class="line">“date” : &#123; </span><br><span class="line">“<span class="built_in">type</span>” : “long” </span><br><span class="line">&#125;, </span><br><span class="line">“name” : &#123; </span><br><span class="line">“<span class="built_in">type</span>” : “string”, </span><br><span class="line">“index” : “not_analyzed” </span><br><span class="line">&#125;, </span><br><span class="line">“status” : &#123; </span><br><span class="line">“<span class="built_in">type</span>” : “<span class="built_in">integer</span>” </span><br><span class="line">&#125;, </span><br><span class="line">“<span class="built_in">type</span>” : &#123; </span><br><span class="line">“<span class="built_in">type</span>” : “<span class="built_in">integer</span>” </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line">&#125; </span><br><span class="line">&#125;’ </span><br><span class="line">5、获取mapping </span><br><span class="line">curl -XGET http://localhost:9200/&#123;index&#125;/&#123;<span class="built_in">type</span>&#125;/_mapping </span><br><span class="line">6、搜索</span><br><span class="line"></span><br><span class="line">curl -XGET ‘http://localhost:9200/&#123;index&#125;/&#123;<span class="built_in">type</span>&#125;/_search’ -d ‘&#123; </span><br><span class="line">“query” : &#123; </span><br><span class="line">“term” : &#123; “user” : “kimchy” &#125; //查所有 “match_all”: &#123;&#125; </span><br><span class="line">&#125;, </span><br><span class="line">“sort” : [&#123; “age” : &#123;“order” : “asc”&#125;&#125;,&#123; “name” : “desc” &#125; ], </span><br><span class="line">“from”:0, </span><br><span class="line">“size”:100 </span><br><span class="line">&#125; </span><br><span class="line">curl -XGET ‘http://localhost:9200/&#123;index&#125;/&#123;<span class="built_in">type</span>&#125;/_search’ -d ‘&#123; </span><br><span class="line">“filter”: &#123;“and”:&#123;“filters”:[&#123;“term”:&#123;“age”:”123”&#125;&#125;,&#123;“term”:&#123;“name”:”张三”&#125;&#125;]&#125;, </span><br><span class="line">“sort” : [&#123; “age” : &#123;“order” : “asc”&#125;&#125;,&#123; “name” : “desc” &#125; ], </span><br><span class="line">“from”:0, </span><br><span class="line">“size”:100 </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;ELK介绍及集群安装&quot;&gt;&lt;a href=&quot;#ELK介绍及集群安装&quot; class=&quot;headerlink&quot; title=&quot;ELK介绍及集群安装&quot;&gt;&lt;/a&gt;ELK介绍及集群安装&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/19/ELK介绍及ES集群安装/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/categories/ELK-Stack/"/>
    
    
      <category term="ELK Stack" scheme="https://daizhe.net.cn/tags/ELK-Stack/"/>
    
  </entry>
  
  <entry>
    <title>Gitlab介绍及配置</title>
    <link href="https://daizhe.net.cn/2019/02/16/Gitlab%E4%BB%8B%E7%BB%8D%E5%8F%8A%E9%85%8D%E7%BD%AE/"/>
    <id>https://daizhe.net.cn/2019/02/16/Gitlab介绍及配置/</id>
    <published>2019-02-16T07:26:06.874Z</published>
    <updated>2019-02-20T07:25:38.396Z</updated>
    
    <content type="html"><![CDATA[<h1 id="Gitlab介绍及配置"><a href="#Gitlab介绍及配置" class="headerlink" title="Gitlab介绍及配置"></a>Gitlab介绍及配置</h1><p><img src="/2019/02/16/Gitlab介绍及配置/标题.gif" alt=""><br><a id="more"></a></p><h2 id="一：DevOps简介："><a href="#一：DevOps简介：" class="headerlink" title="一：DevOps简介："></a>一：DevOps简介：</h2><ul><li>DevOps 是Development和Operations的组合，也就是开发和运维的简写。</li><li>DevOps 是针对企业中的研发人员、运维人员和测试人员的工作理念，是他们在应用开发、代码部署和质量测试等整条生命周期中协作和沟通的最佳实践，DevOps 强调整个组织的合作以及交付和基础设施变更的自动化、从而实现持续集成、持续部署和持续交付。</li><li>DevOps 四大平台：代码托管(gitlab/svn)、项目管理(jira)、运维平台(腾讯蓝鲸/开源平台)、持续交付(Jenkins/gitlab)</li></ul><h3 id="1-1：什么是DevOps："><a href="#1-1：什么是DevOps：" class="headerlink" title="1.1：什么是DevOps："></a>1.1：什么是DevOps：</h3><p><img src="/2019/02/16/Gitlab介绍及配置/1.png" alt=""></p><h3 id="1-2：为什么要推广DevOps？"><a href="#1-2：为什么要推广DevOps？" class="headerlink" title="1.2：为什么要推广DevOps？"></a>1.2：为什么要推广DevOps？</h3><ul><li>DevOps 强调团队协作、相互协助、持续发展，然而传统的模式是开发人员只顾开发程序，运维只负责基础环境管理和代码部署及监控等，其并不是为了一个共同的目标而共同实现最终的目的，而DevOps 则实现团队作战，即无论是开发、运维还是测试，都为了最终的代码发布、持续部署和业务稳定而付出各自的努力，从而实现产品设计、开发、测试和部署的良性循环，实现产品的最终持续交付。</li></ul><p><img src="/2019/02/16/Gitlab介绍及配置/2.png" alt=""></p><h3 id="1-3：传统技术团队："><a href="#1-3：传统技术团队：" class="headerlink" title="1.3：传统技术团队："></a>1.3：传统技术团队：</h3><p><img src="/2019/02/16/Gitlab介绍及配置/3.png" alt=""></p><h3 id="1-4：DevOps技术团队："><a href="#1-4：DevOps技术团队：" class="headerlink" title="1.4：DevOps技术团队："></a>1.4：DevOps技术团队：</h3><p><img src="/2019/02/16/Gitlab介绍及配置/4.png" alt=""></p><h3 id="1-5：什么是持续集成-CI-Continuous-integration"><a href="#1-5：什么是持续集成-CI-Continuous-integration" class="headerlink" title="1.5：什么是持续集成(CI-Continuous integration)"></a>1.5：什么是持续集成(CI-Continuous integration)</h3><ul><li>持续集成是指多名开发者在开发不同功能代码的过程当中，可以频繁的将代码行合并到一起并切相互不影响工作。</li></ul><h3 id="1-6：什么是持续部署-CD-continuous-deployment"><a href="#1-6：什么是持续部署-CD-continuous-deployment" class="headerlink" title="1.6：什么是持续部署(CD-continuous deployment)"></a>1.6：什么是持续部署(CD-continuous deployment)</h3><ul><li>是基于某种工具或平台实现代码自动化的构建、测试和部署到线上环境以实现交付高质量的产品,持续部署在某种程度上代表了一个开发团队的更新迭代速率。</li></ul><h3 id="1-7：什么是持续交付-Continuous-Delivery"><a href="#1-7：什么是持续交付-Continuous-Delivery" class="headerlink" title="1.7：什么是持续交付(Continuous Delivery)"></a>1.7：什么是持续交付(Continuous Delivery)</h3><ul><li>持续交付是在持续部署的基础之上，将产品交付到线上环境，因此持续交付是产品价值的一种交付，是产品价值的一种盈利的实现。</li></ul><p><img src="/2019/02/16/Gitlab介绍及配置/5.png" alt=""></p><h3 id="1-8：常见的部署方式："><a href="#1-8：常见的部署方式：" class="headerlink" title="1.8：常见的部署方式："></a>1.8：常见的部署方式：</h3><ul><li>开发自己上传–最原始的方案</li><li>开发给运维手动上传–运维自己手动部署</li><li>运维使用脚本复制–半自动化</li><li>结合web界面一键部署–自动化</li></ul><h3 id="1-9：常见的持续集成开源工具："><a href="#1-9：常见的持续集成开源工具：" class="headerlink" title="1.9：常见的持续集成开源工具："></a>1.9：常见的持续集成开源工具：</h3><ul><li>在公司的服务器安装某种程序，该程序用于按照特定格式和方式记录和保存公司多名开发人员不定期提交的源代码，且后期可以按照某种标记及方式对用户提交的数据进行还原。</li></ul><h4 id="1-9-1：CVS-Concurrent-Version-System-："><a href="#1-9-1：CVS-Concurrent-Version-System-：" class="headerlink" title="1.9.1：CVS(Concurrent Version System)："></a>1.9.1：CVS(Concurrent Version System)：</h4><ul><li>早期的集中式版本控制系统，现已基本淘汰<br>会出现数据提交后不完整的情况</li></ul><h4 id="1-9-2：SVN-Subversion-–集中式版本控制系统"><a href="#1-9-2：SVN-Subversion-–集中式版本控制系统" class="headerlink" title="1.9.2：SVN(Subversion)–集中式版本控制系统"></a>1.9.2：SVN(Subversion)–集中式版本控制系统</h4><ul><li>2000年开始开发，目标就是替代CVS集中式管理，依赖于网络，一台服务器集中管理目前依然有部分公司在使用</li></ul><h4 id="1-9-3：Gitlib—分布式版本控制系统"><a href="#1-9-3：Gitlib—分布式版本控制系统" class="headerlink" title="1.9.3：Gitlib—分布式版本控制系统"></a>1.9.3：Gitlib—分布式版本控制系统</h4><ul><li>Linus在1991年创建了开源的Linux内核，从此Linux便不断快速发展，不过 Linux的壮大是离不开全世界的开发者的参与，这么多人在世界各地为Linux编写代码，那Linux内核的代码是如何管理的呢？事实是，在2002年以前，世界各地的志愿者把源代码文件通过diff的方式发给Linus，然后由Linus本人通过手工方式合并代码！你也许会想，为什么Linus不把Linux代码放到版本控制系统里呢？不是有CVS、SVN这些免费的版本控制系统吗？因为Linus坚定地反对CVS和SVN，这些集中式的版本控制系统不但速度慢，且必须联网才能使用，但是也有一些商用的版本控制系统，虽然比CVS、SVN好用，但那是付费的，和Linux的开源精神不符,不过，到了2002年，Linux系统已经发展了十年了，代码库之大让Linus很难继续通过手工方式管理了，社区的弟兄们也对这种方式表达了强烈不满，于是Linus选择了一个商业的版本控制系统BitKeeper，BitKeeper的东家BitMover公司出于人道主义精神，授权Linux社区免费使用这个版本控制系统,但是安定团结的大好局面在2005年就被打破了，原因是Linux社区牛人聚集，不免沾染了一些梁山好汉的江湖习气，开发Samba的Andrew试图破解BitKeeper的协议（这么干的其实也不只他一个），被BitMover公司发现了（监控工作做得不错！），于是BitMover公司怒了，要收回Linux社区的免费使用权,这时候其实Linus可以向BitMover公司道个歉，保证以后严格管教弟兄们，但这是不可能的，而且实际情况是Linus自己花了两周时间自己用C写了一个分布式版本控制系统，这就是Git！一个月之内，Linux内核的源码已经由Git管理了！牛是怎么定义的呢？大家可以体会一下,然后Git迅速成为最流行的分布式版本控制系统，尤其是2008年，GitHub网站上线了，它为开源项目免费提供Git存储，无数开源项目开始迁移至GitHub，包括jQuery，PHP，Ruby等等。</li></ul><h3 id="1-10：版本控制系统分类："><a href="#1-10：版本控制系统分类：" class="headerlink" title="1.10：版本控制系统分类："></a>1.10：版本控制系统分类：</h3><h4 id="1-10-1：集中式版本控制系统："><a href="#1-10-1：集中式版本控制系统：" class="headerlink" title="1.10.1：集中式版本控制系统："></a>1.10.1：集中式版本控制系统：</h4><ul><li>任何的提交和回滚都依赖于连接服务器SVN服务器是单点</li></ul><p><img src="/2019/02/16/Gitlab介绍及配置/6.png" alt=""></p><h4 id="1-10-2：分布式版本控制系统："><a href="#1-10-2：分布式版本控制系统：" class="headerlink" title="1.10.2：分布式版本控制系统："></a>1.10.2：分布式版本控制系统：</h4><ul><li>Git在每个用户都有一个完整的服务器，然后在有一个中央服务器，用户可以先将代码提交到本    地，没有网络也可以先提交到本地，然后在有网络的时候再提交到中央服务器，这样就大大方便了开发者，而相比CVS和SVN都是集中式的版本控制系统，工作的时候需要先从中央服务器获 取最新的代码，改完之后需要提交，如果是一个比较大的文件则需要足够快的网络才能快速提交完成，而使用分布式的版本控制系统，每个用户都是一个完整的版本库，即使没有中央服务器也可以提交代码或者回滚，最终再把改好的代码提交至中央服务器进行合并即可。</li></ul><p><img src="/2019/02/16/Gitlab介绍及配置/7.png" alt=""></p><hr><p>避免混淆的名称</p><ul><li>gitlab–&gt;应用软件</li><li>git–&gt;命令行的客户端</li><li>github–&gt;代码托管网站</li></ul><hr><h2 id="二：Gitlab部署与使用："><a href="#二：Gitlab部署与使用：" class="headerlink" title="二：Gitlab部署与使用："></a>二：Gitlab部署与使用：</h2><h3 id="2-1：下载并部署gitlab："><a href="#2-1：下载并部署gitlab：" class="headerlink" title="2.1：下载并部署gitlab："></a>2.1：下载并部署gitlab：</h3><p>官方站点：<a href="https://about.gitlab.com/" target="_blank" rel="noopener">https://about.gitlab.com/</a></p><h4 id="2-1-1：Centos-系统环境在准备："><a href="#2-1-1：Centos-系统环境在准备：" class="headerlink" title="2.1.1：Centos 系统环境在准备："></a>2.1.1：Centos 系统环境在准备：</h4><h4 id="2-1-2：gitlab安装及使用"><a href="#2-1-2：gitlab安装及使用" class="headerlink" title="2.1.2：gitlab安装及使用"></a>2.1.2：gitlab安装及使用</h4><ul><li>安装包下载地址：<a href="https://packages.gitlab.com/gitlab/gitlab-ce" target="_blank" rel="noopener">https://packages.gitlab.com/gitlab/gitlab-ce</a>   </li><li>rpm包国内下载地址：<a href="https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/" target="_blank" rel="noopener">https://mirrors.tuna.tsinghua.edu.cn/gitlab-ce/yum/</a> </li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;Gitlab介绍及配置&quot;&gt;&lt;a href=&quot;#Gitlab介绍及配置&quot; class=&quot;headerlink&quot; title=&quot;Gitlab介绍及配置&quot;&gt;&lt;/a&gt;Gitlab介绍及配置&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/16/Gitlab介绍及配置/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/categories/HAproxy/"/>
    
    
      <category term="HAproxy" scheme="https://daizhe.net.cn/tags/HAproxy/"/>
    
  </entry>
  
  <entry>
    <title>zabbix分布式监控与性能优化</title>
    <link href="https://daizhe.net.cn/2019/02/15/zabbix%E5%88%86%E5%B8%83%E5%BC%8F%E7%9B%91%E6%8E%A7%E4%B8%8E%E6%80%A7%E8%83%BD%E4%BC%98%E5%8C%96/"/>
    <id>https://daizhe.net.cn/2019/02/15/zabbix分布式监控与性能优化/</id>
    <published>2019-02-15T08:04:21.104Z</published>
    <updated>2019-02-20T07:25:17.199Z</updated>
    
    <content type="html"><![CDATA[<h1 id="第五章：-zabbix分布式监控与性能优化"><a href="#第五章：-zabbix分布式监控与性能优化" class="headerlink" title="第五章： zabbix分布式监控与性能优化"></a>第五章： zabbix分布式监控与性能优化</h1><p><img src="/2019/02/15/zabbix分布式监控与性能优化/标题.gif" alt=""><br><a id="more"></a></p><h2 id="zabbix-proxy分布式概述"><a href="#zabbix-proxy分布式概述" class="headerlink" title="zabbix-proxy分布式概述"></a>zabbix-proxy分布式概述</h2><p><img src="/2019/02/15/zabbix分布式监控与性能优化/1.png" alt=""></p><p>zabbix-proxy官方文档 <a href="https://www.zabbix.com/documentation/3.4/manual/distributed_monitoring/proxies" target="_blank" rel="noopener">https://www.zabbix.com/documentation/3.4/manual/distributed_monitoring/proxies</a></p><ul><li><p>概观</p><ul><li>Zabbix代理可以代表Zabbix服务器收集性能和可用性数据。这样，代理可以承担一些收集数据和卸载Zabbix服务器的负担。</li><li>此外，当所有代理和代理向一个Zabbix服务器报告并且集中收集所有数据时，使用代理是实现集中式和分布式监视的最简单方法。</li></ul></li><li><p>Zabbix-proxy使用场景：</p><ul><li>监控远程位置，解决跨机房</li><li>监控主机多，性能跟不上，延迟大</li><li>解决网络不稳定</li></ul></li></ul><hr><h3 id="zabbix-proxy特征"><a href="#zabbix-proxy特征" class="headerlink" title="zabbix-proxy特征"></a>zabbix-proxy特征</h3><p><img src="/2019/02/15/zabbix分布式监控与性能优化/2.png" alt=""></p><ul><li>proxy不支持图形</li><li>proxy不支持报警</li><li>proxy需要数据库</li><li>proxy不能和server装在一起</li></ul><hr><h2 id="zabbix-proxy分布式图解"><a href="#zabbix-proxy分布式图解" class="headerlink" title="zabbix-proxy分布式图解"></a>zabbix-proxy分布式图解</h2><p>环境：<br><img src="/2019/02/15/zabbix分布式监控与性能优化/3.png" alt=""></p><p>部署：</p><p>1.安装zabbix-server<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br></pre></td><td class="code"><pre><span class="line">1.安装</span><br><span class="line">  ~]<span class="comment"># rpm -Uvh https://repo.zabbix.com/zabbix/4.0/rhel/7/x86_64/zabbix-release-4.0-1.el7.noarch.rpm</span></span><br><span class="line"></span><br><span class="line">2.安装Zabbix服务器，前端，代理（zabbix要连接数据库）解决的依赖关系，安装了php、httpd</span><br><span class="line">zabbix-agent ： zabbix客户端</span><br><span class="line">  ~]<span class="comment"># yum install zabbix-server-mysql zabbix-web-mysql zabbix-agent -y</span></span><br><span class="line"></span><br><span class="line">3.安装数据库</span><br><span class="line">  ~]<span class="comment"># yum install mariadb-server -y</span></span><br><span class="line"></span><br><span class="line">4.创建zabbix数据库以及用户</span><br><span class="line">  <span class="comment">#启动数据库，加入开机启动项</span></span><br><span class="line">  ~]<span class="comment"># systemctl start mariadb</span></span><br><span class="line">  ~]<span class="comment"># systemctl enable mariadb</span></span><br><span class="line">  <span class="comment">#创建数据库并授权</span></span><br><span class="line">  ~]<span class="comment"># mysql -uroot</span></span><br><span class="line">  mysql&gt; create database zabbix character <span class="built_in">set</span> utf8 collate utf8_bin;</span><br><span class="line">  mysql&gt; grant all privileges on zabbix.* to zabbix@localhost identified by <span class="string">'centos'</span>;</span><br><span class="line">  mysql&gt; quit;</span><br><span class="line"></span><br><span class="line">5.导入初始架构和数据。系统将提示您输入新创建的密码（）</span><br><span class="line">  ~]<span class="comment"># cd /usr/share/doc/zabbix-server-mysql-4.0.4/</span></span><br><span class="line">  <span class="comment">#查看压缩包的内容不解压zcat</span></span><br><span class="line">  <span class="comment">#导入到zabbix库中</span></span><br><span class="line">  zabbix-server-mysql-4.0.4]<span class="comment">#  zcat /usr/share/doc/zabbix-server-mysql*/create.sql.gz | mysql -uroot zabbix(zabbix为前面创建的数据库名称)</span></span><br><span class="line"></span><br><span class="line">6.启动zabbix server进程</span><br><span class="line">  <span class="comment">#在zabbix_server.conf中编辑配置数据库配置</span></span><br><span class="line">  ~]<span class="comment"># vim /etc/zabbix/zabbix_server.conf </span></span><br><span class="line">  91行</span><br><span class="line">  <span class="comment"># DBHost=localhost    </span></span><br><span class="line">  <span class="comment">#数据库的地址，这里演示的为单机模式，默认也是localhost</span></span><br><span class="line">  100行</span><br><span class="line">  DBName=zabbix   </span><br><span class="line">  <span class="comment">#数据库的名称，这里演示创建的数据库的名称也为zabbix</span></span><br><span class="line">  116行</span><br><span class="line">  DBUser=zabbix</span><br><span class="line">  <span class="comment">#授权的数据库的用户</span></span><br><span class="line">  124行</span><br><span class="line">  DBPassword=centos</span><br><span class="line">  <span class="comment">#数据库的密码</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#启动前关闭selinux</span></span><br><span class="line">  ~]<span class="comment"># systemctl start zabbix-server</span></span><br><span class="line">  ~]<span class="comment"># systemctl enable zabbix-server</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#保证80端口为安装zabbix时安装的依赖的httpd使用</span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">    *:10051 </span><br><span class="line">    *:3306</span><br><span class="line">    *:80</span><br><span class="line">     </span><br><span class="line"></span><br><span class="line">7.编辑zabbix前端的PHP配置</span><br><span class="line">  <span class="comment">#zabbix前端的apache配置文件位于/etc/httpd/conf.d/zabbix.conf 一些php设置已经完成了配置</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#依据所在的时区，设置时间，更改配置文件后，重启Apache服务器</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/httpd/conf.d/zabbix.conf </span></span><br><span class="line">  Alias /zabbix /usr/share/zabbix   <span class="comment">#如果访问uri路径为/zabbix 则调度到/usr/share/zabbix 路径下，别名意思</span></span><br><span class="line">  &lt;Directory <span class="string">"/usr/share/zabbix"</span>&gt;</span><br><span class="line">    Options FollowSymLinks</span><br><span class="line">    AllowOverride None</span><br><span class="line">    Require all granted</span><br><span class="line"></span><br><span class="line">    &lt;IfModule mod_php5.c&gt;</span><br><span class="line">    ...</span><br><span class="line">  20行修改为(仅一处修改即可)</span><br><span class="line">        php_value date.timezone Asia/Shanghai</span><br><span class="line">    &lt;/IfModule&gt;</span><br><span class="line">    ...</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart httpd</span></span><br><span class="line">  ~]<span class="comment"># systemctl enable httpd</span></span><br></pre></td></tr></table></figure></p><p>2.安装、配置 zabbix-proxy（proxy端的版本和proxy端以及zabbix-agent端的版本要一致）<br>阿里云仓库：<a href="https://mirrors.aliyun.com/zabbix/zabbix/3.4/rhel/7/x86_64/" target="_blank" rel="noopener">https://mirrors.aliyun.com/zabbix/zabbix/3.4/rhel/7/x86_64/</a><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">配置好epel源</span><br><span class="line"></span><br><span class="line">安装zabbix-proxy</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># yum localinstall https://mirrors.aliyun.com/zabbix/zabbix/3.4/rhel/7/x86_64/zabbix-proxy-mysql-3.4.12-1.el7.x86_64.rpm</span></span><br><span class="line"></span><br><span class="line">安装数据库</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># yum install mariadb-server -y</span></span><br><span class="line"></span><br><span class="line">创建zabbix数据库以及用户</span><br><span class="line"></span><br><span class="line">  <span class="comment">#启动数据库，加入开机启动项</span></span><br><span class="line">  ~]<span class="comment"># systemctl start mariadb</span></span><br><span class="line">  ~]<span class="comment"># systemctl enable mariadb</span></span><br><span class="line"></span><br><span class="line">创建数据库并授权</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># mysql -uroot</span></span><br><span class="line">  mysql&gt; create database zabbix_proxy character <span class="built_in">set</span> utf8 collate utf8_bin;</span><br><span class="line">  mysql&gt; grant all privileges on zabbix_proxy.* to zabbix_proxy@localhost identified by <span class="string">'centos'</span>;</span><br><span class="line">  mysql&gt; quit;</span><br><span class="line"></span><br><span class="line">配置zabbix-proxy</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/zabbix/zabbix_proxy.conf </span></span><br><span class="line">  <span class="comment">#定义的使用zabbix-proxy主动模式还是被动模式（默认使用的是主动模式）</span></span><br><span class="line">  6 <span class="comment">### Option: ProxyMode</span></span><br><span class="line">  7 <span class="comment">#       Proxy operating mode.</span></span><br><span class="line">  8 <span class="comment">#       0 - proxy in the active mode</span></span><br><span class="line">  9 <span class="comment">#       1 - proxy in the passive mode</span></span><br><span class="line">  10 <span class="comment">#</span></span><br><span class="line">  11 <span class="comment"># Mandatory: no</span></span><br><span class="line">  12 <span class="comment"># Default:</span></span><br><span class="line">  13 <span class="comment"># ProxyMode=0</span></span><br><span class="line"></span><br><span class="line">  24 Server=zabbix-server地址</span><br><span class="line"></span><br><span class="line">  43 Hostname=Zabbix proxy  <span class="comment">#此主机名很重要是zabbix-server定义代理的名称</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#zabbix-proxy在内网中人为自己就是老大（所以zabbix-server和zabbix-proxy不能安装在同一台主机上）</span></span><br><span class="line">  59 <span class="comment"># ListenPort=10051  </span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#定义zabbix-proxy数据保存的数据库的位置，这里zabbix-proxy的数据库和安装在同一台主机上</span></span><br><span class="line">  151 <span class="comment"># DBHost=localhost</span></span><br><span class="line"></span><br><span class="line">  <span class="comment">#填写zabbix-proxy主机上安装数据库的名称</span></span><br><span class="line">  167 DBName=zabbix_proxy</span><br><span class="line"></span><br><span class="line">  <span class="comment">#授权的zabbix-proxy上数据库中数据库的用户</span></span><br><span class="line">  182 DBUser=zabbix_proxy</span><br><span class="line"></span><br><span class="line">  <span class="comment">#定义zabbix-proxy上数据库中数据库的用户的密码</span></span><br><span class="line">  190 DBPassword=centos</span><br></pre></td></tr></table></figure></p><p><img src="/2019/02/15/zabbix分布式监控与性能优化/4.png" alt=""></p><p>2.将zabbix-proxy导入mysql初始架构和数据。系统将提示您输入新创建的数据库以及新建的用户的密码<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">查看安装zabbix-proxy安装包的文件</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># rpm -q zabbix-proxy-mysql </span></span><br><span class="line">  zabbix-proxy-mysql-3.4.12-1.el7.x86_64</span><br><span class="line">  ~]<span class="comment"># rpm -q zabbix-proxy-mysql </span></span><br><span class="line">  /usr/share/doc/zabbix-proxy-mysql-3.4.12/schema.sql.gz</span><br><span class="line"></span><br><span class="line">将zabbix-proxy导入mysql初始架构和数据。系统将提示您输入新创建的密码（）</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cd /usr/share/doc/zabbix-proxy-mysql-3.4.12/</span></span><br><span class="line">  zabbix-proxy-mysql-3.4.12]<span class="comment"># zcat schema.sql.gz | mysql -uzabbix_proxy -pcentos zabbix_proxy</span></span><br></pre></td></tr></table></figure></p><p>3.登陆zabbix-proxy上安装的数据库查看是否将zabbix-proxy中的<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">MariaDB [(none)]&gt; use zabbix_proxy;</span><br><span class="line">MariaDB [zabbix_proxy]&gt; show tables;</span><br><span class="line">MariaDB [zabbix_proxy]&gt; <span class="built_in">exit</span></span><br></pre></td></tr></table></figure></p><p>4.启动zabbix-proxy<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># systemctl start zabbix-proxy</span></span><br><span class="line">~]<span class="comment"># systemctl enable zabbix-proxy</span></span><br><span class="line">~]<span class="comment"># ss -tnl</span></span><br><span class="line">*:10051  </span><br><span class="line">*:3306</span><br></pre></td></tr></table></figure></p><p>5.配置内网中的zabbix-agent客户端指向内网中zabbix-proxy<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">安装zabbix-agent客户端</span><br><span class="line"></span><br><span class="line">  ~] <span class="comment"># rpm -ivh https://mirrors.aliyun.com/zabbix/zabbix/3.4/rhel/7/x86_64/zabbix-agent-3.4.3-1.el7.x86_64.rpm</span></span><br><span class="line"></span><br><span class="line">配置zabbix-agent客户端的配置文件指定允许服务端监控的地址</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/zabbix/zabbix_agentd.conf </span></span><br><span class="line">  97  Server=zabbix-proxy地址</span><br><span class="line">  138 ServerActive=zabbix-proxy地址 （允许zabbix-proxy自动发现zabbix-agent）</span><br><span class="line">  149 Hostname=agent-01-172.18.139.71</span><br><span class="line"></span><br><span class="line">重启zabbix-agent并加入开启启动项</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart zabbix-agent</span></span><br><span class="line">  ~]<span class="comment"># systemctl enable zabbix-agent</span></span><br></pre></td></tr></table></figure></p><p>6.使用zabbix-server中的zabbix-web界面链接zabbix-proxy</p><p>6.1创建代理<br><img src="/2019/02/15/zabbix分布式监控与性能优化/5.png" alt=""><br><img src="/2019/02/15/zabbix分布式监控与性能优化/6.png" alt=""></p><p>6.2zabbix-server的wab界面中链接内网中的zabbix-agent主机，链接时并配置代理<br><img src="/2019/02/15/zabbix分布式监控与性能优化/7.png" alt=""></p><ul><li>代理只需要一个到Zabbix服务器的TCP连接。这样就可以更容易地绕过防火墙，因为您只需要配置一个防火墙规则。</li><li>代理收集的所有数据在将其传输到服务器之前存储在本地。这样，由于服务器的任何临时通信问题，都不会丢失数据。代理配置文件中的ProxyLocalBuffer和ProxyOfflineBuffer参数控制数据在本地保存多长时间。</li></ul><h2 id="性能调优"><a href="#性能调优" class="headerlink" title="性能调优"></a>性能调优</h2><ul><li>1.针对于mysql，zabbix-server和mysql拆分架构，写多读少</li><li>2.去掉无用监控项，增加监控项的取值间隔，减少历史数据保存周期（housekeeper）</li><li>3.把被动模式修改为主动模式，增加zabbix-porxy</li><li>4.针对于zabbix-server进行进行调优，就加大它的进行数</li><li>5.针对于zabbix-server缓存调优，谁的剩余内存少，就加大它的缓存值</li><li>定义监控项时，设置历史数据保留时长，（30天~60天）<ul><li>如果监控的数据的之大于30天，则会被zabbix-server中的程序清理<ul><li>手动执行数据清理<ul><li>zabbix-server -R housekeeper_execute</li></ul></li></ul></li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;第五章：-zabbix分布式监控与性能优化&quot;&gt;&lt;a href=&quot;#第五章：-zabbix分布式监控与性能优化&quot; class=&quot;headerlink&quot; title=&quot;第五章： zabbix分布式监控与性能优化&quot;&gt;&lt;/a&gt;第五章： zabbix分布式监控与性能优化&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/15/zabbix分布式监控与性能优化/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="zabbix_老男孩" scheme="https://daizhe.net.cn/categories/zabbix-%E8%80%81%E7%94%B7%E5%AD%A9/"/>
    
    
      <category term="zabbix_老男孩" scheme="https://daizhe.net.cn/tags/zabbix-%E8%80%81%E7%94%B7%E5%AD%A9/"/>
    
  </entry>
  
  <entry>
    <title>zabbix自动化监控深入实践</title>
    <link href="https://daizhe.net.cn/2019/02/14/zabbix%E8%87%AA%E5%8A%A8%E5%8C%96%E7%9B%91%E6%8E%A7%E6%B7%B1%E5%85%A5%E5%AE%9E%E8%B7%B5/"/>
    <id>https://daizhe.net.cn/2019/02/14/zabbix自动化监控深入实践/</id>
    <published>2019-02-14T11:26:27.519Z</published>
    <updated>2019-02-20T07:24:33.111Z</updated>
    
    <content type="html"><![CDATA[<h1 id="第四章：-zabbix自动化监控（自动发现-主动注册-主动模式被动模式）"><a href="#第四章：-zabbix自动化监控（自动发现-主动注册-主动模式被动模式）" class="headerlink" title="第四章： zabbix自动化监控（自动发现|主动注册|主动模式被动模式）"></a>第四章： zabbix自动化监控（自动发现|主动注册|主动模式被动模式）</h1><p><img src="/2019/02/14/zabbix自动化监控深入实践/标题.gif" alt=""><br><a id="more"></a></p><p><img src="/2019/02/14/zabbix自动化监控深入实践/1.png" alt=""></p><ul><li>web网站可用性监控<ul><li>1.使用命令行实现网站的登陆（curl登陆discuz,需要关闭discuz的验证码）</li><li>2.使用curl模型登陆zabix_web</li></ul></li></ul><ul><li>扩展知识<ul><li>静态页面：纯静态网站就是服务器的源代码和客户端的源代码一致。（HTML标记语言）</li><li>动态页面：&lt;?php phpinfo()?&gt;</li><li>每次用户访问的时候，html都是在内存中动态生成的，支持登陆，支持用户交互</li><li>动态网站需要有东西存下来<ul><li>服务端：session</li><li>客户端：cookie</li></ul></li></ul></li></ul><hr><ul><li>当用户第一次访问网站，肯定不会携带cookie信息，服务端返回网页的时候，给该客户分配一个sessionID</li><li>当用户第二次访问网站的时候，会携带cookie访问，服务端就会通过session验证用户的sookie进行验证<ul><li>模拟登陆：curl -L -c cook -b cook -d ‘原始数据’ 请求url</li><li>登陆成功后，使用curl -c cook -b cook url 访问想要访问 的内容，然后追加至一个html文件中，验证是否成功</li></ul></li></ul><hr><h2 id="自动发现（server端轮询网段扫描发现agent）：被动模式"><a href="#自动发现（server端轮询网段扫描发现agent）：被动模式" class="headerlink" title="自动发现（server端轮询网段扫描发现agent）：被动模式"></a>自动发现（server端轮询网段扫描发现agent）：被动模式</h2><ul><li><p>zabbbix-server段主动去发现此网段中主机上安装zabbix-agent客户端并且agent配置文件中server地址指向的是zabbix-server的主机的地址的主机，则可以被zabbix-server主机扫描到添加到监控的主机中</p></li><li><p>zabbix自动发现和主机注册(重要)</p></li></ul><p>操作步骤：</p><ul><li>1.自动发现，自动添加监控给主机<ul><li>配置–&gt;自动发现–&gt;选择扫描的主机端</li><li>配置–&gt;动作–&gt;事件源–&gt;自动发现–&gt;定制消息</li></ul></li><li>自动发现问题：server每60s扫描一次小弟，资源开销厉害</li></ul><p>演示：</p><p>1.zabbix-web开启配置中的自动发现默认规则<br><img src="/2019/02/14/zabbix自动化监控深入实践/2.png" alt=""></p><p>2.zabbix-web端默认的发现规则的检测规则<br><img src="/2019/02/14/zabbix自动化监控深入实践/4.png" alt=""><br><img src="/2019/02/14/zabbix自动化监控深入实践/5.png" alt=""></p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># zabbix_get -s 172.18.139.70 -k "system.uname"</span></span><br><span class="line">Linux centos7.com 3.10.0-693.el7.x86_64 <span class="comment">#1 SMP Tue Aug 22 21:09:27 UTC 2017 x86_64</span></span><br></pre></td></tr></table></figure><p>3.验证自动发现<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">重新创建一个zabbix-agent端</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># rpm -ivh https://mirrors.aliyun.com/zabbix/zabbix/3.4/rhel/7/x86_64/zabbix-agent-3.4.3-1.el7.x86_64.rpm</span></span><br><span class="line"></span><br><span class="line">定义agent端的配置文件中的server（允许那台server监控此agent端）</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># vim /etc/zabbix/zabbix_agentd.conf </span></span><br><span class="line">    Server=172.18.139.69    <span class="comment">#填写zabbix-server端的地址</span></span><br><span class="line">    ~]<span class="comment"># systemctl restart zabbix-agent</span></span><br></pre></td></tr></table></figure></p><p>4.zabbix-web开启自动发现的动作<br><img src="/2019/02/14/zabbix自动化监控深入实践/6.png" alt=""></p><p>5.zabbix-web配置自动发现zabbix-agent-动作<br><img src="/2019/02/14/zabbix自动化监控深入实践/7.png" alt=""></p><p>6.zabbix-web配置自动发现zabbix-agent-操作<br><img src="/2019/02/14/zabbix自动化监控深入实践/8.png" alt=""></p><p>7.刷新zabbix-web界面查看自动检测的主机是否被zabbix-server监控<br><img src="/2019/02/14/zabbix自动化监控深入实践/9.png" alt=""></p><hr><ul><li>自动发现：ip、ftp、ssh、web、pop3、imap、tcp</li><li><p>ip范文自动发现（两个阶段：发现–&gt;动作）</p></li><li><p>自动发现所执行的动作</p><ul><li>发送消息</li><li>添加/删除主机</li><li>启用/禁用主机</li><li>添加主机到组</li><li>从组中删除主机</li><li>将主机链接到模板/从模板中取消链接</li><li>执行远程脚本命令</li></ul></li></ul><h4 id="定义操作-即发送邮件的信息"><a href="#定义操作-即发送邮件的信息" class="headerlink" title="定义操作-即发送邮件的信息"></a>定义操作-即发送邮件的信息</h4><ul><li><p>可以使用系统自带的宏变量设置</p><ul><li>官方站点：<a href="https://www.zabbix.com/documentation/3.4/manual/appendix/macros/supported_by_location" target="_blank" rel="noopener">https://www.zabbix.com/documentation/3.4/manual/appendix/macros/supported_by_location</a></li></ul></li><li><p>{} DISCOVERY.DEVICE.IPADDRESS    </p><ul><li>→发现通知    <ul><li>已发现设备的IP地址。始终可用，不依赖于添加的主机。</li></ul></li></ul></li><li>{DISCOVERY.DEVICE。DNS }    <ul><li>→发现通知    <ul><li>已发现设备的DNS名称。始终可用，不依赖于添加的主机。</li></ul></li></ul></li><li>{} DISCOVERY.DEVICE.STATUS    <ul><li>→发现通知    <ul><li>已发现设备的状态：可以是UP或DOWN。</li></ul></li></ul></li><li>{} DISCOVERY.DEVICE.UPTIME    <ul><li>→发现通知    <ul><li>自上次更改特定设备的发现状态以来的时间。对于状态为DOWN的设备，这是其停机时间。</li></ul></li></ul></li><li>{} DISCOVERY.RULE.NAME    <ul><li>→发现通知    <ul><li>发现设备或服务存在与否的发现规则的名称。</li></ul></li></ul></li><li>{} DISCOVERY.SERVICE.NAME    <ul><li>→发现通知    <ul><li>发现的服务的名称。例如：HTTP。</li></ul></li></ul></li><li>{} DISCOVERY.SERVICE.PORT    <ul><li>→发现通知    <ul><li>发现的服务的端口。例如：80。</li></ul></li></ul></li><li>{} DISCOVERY.SERVICE.STATUS    <ul><li>→发现通知    <ul><li>已发现服务的状态：可以是UP或DOWN。</li></ul></li></ul></li><li>{} DISCOVERY.SERVICE.UPTIME    <ul><li>→发现通知    <ul><li>自上次更改特定服务的发现状态以来的时间。例如：1小时29分钟。对于状态为DOWN的服务，这是他们停机的时间段。</li></ul></li></ul></li></ul><p><img src="/2019/02/14/zabbix自动化监控深入实践/10.png" alt=""></p><hr><h2 id="主机注册（agent端主动告诉server端请求加入）：主动模式"><a href="#主机注册（agent端主动告诉server端请求加入）：主动模式" class="headerlink" title="主机注册（agent端主动告诉server端请求加入）：主动模式"></a>主机注册（agent端主动告诉server端请求加入）：主动模式</h2><p>操作步骤：</p><ul><li><p>主机注册</p><ul><li>#修改配置文件</li><li>vim /etc/zabbix/zabbix_agent.conf<ul><li>ServerActive=</li><li>Hostname=</li></ul></li><li>systemctl restart zabbix-agent</li></ul></li><li><p>#Web界面</p><ul><li>1.配置–&gt;动作–&gt;事件源–&gt;自动注册–&gt;创建</li><li>2.动作–&gt;名称–&gt;触发条件</li><li>3.操作–&gt;操作细节–&gt;关联模板–&gt;发送消息</li></ul></li></ul><p>演示：</p><p>1.zabbix-agent端修改配置文件<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># vim /etc/zabbix/zabbix_agentd.conf</span></span><br><span class="line">97行</span><br><span class="line">Server=172.18.139.69        <span class="comment">#zabbix-server 端的地址（允许哪台server主机监控）</span></span><br><span class="line">138行</span><br><span class="line">ServerActive=172.18.139.69      <span class="comment">#zabbix-server 端的地址  （向哪台server主机提请注册）  </span></span><br><span class="line">149行</span><br><span class="line">Hostname=agent-01-172.18.139.71 <span class="comment">#定义主机可以选择和系统主机名称保持一致</span></span><br><span class="line"></span><br><span class="line">重启</span><br><span class="line"></span><br><span class="line">~]<span class="comment"># systemctl restart zabbix-agent.service</span></span><br></pre></td></tr></table></figure></p><p>2.zabbix-web界面配置创建自动注册机制<br><img src="/2019/02/14/zabbix自动化监控深入实践/11.png" alt=""></p><p>3.zabbix-web界面配置创建自动注册触发动作（主机名称包含agent则触发动作）<br><img src="/2019/02/14/zabbix自动化监控深入实践/12.png" alt=""></p><p>4.zabbix-web界面配置创建自动注册操作细节（关联模板+发送邮件）<br><img src="/2019/02/14/zabbix自动化监控深入实践/13.png" alt=""></p><p>5.zabbix-web关闭自动发现功能<br><img src="/2019/02/14/zabbix自动化监控深入实践/14.png" alt=""></p><p>6.刷新界面查看agent是否被server端发现<br><img src="/2019/02/14/zabbix自动化监控深入实践/15.png" alt=""></p><hr><h2 id="主动模式被动模式"><a href="#主动模式被动模式" class="headerlink" title="主动模式被动模式"></a>主动模式被动模式</h2><p><code>主动模式与被动模式主要是站在zabbix-agent身份来说</code></p><ul><li>1.被动模式（zabbix-server轮询检测zabbix-agent）</li><li>2.主动模式（zabbix-agent主动上报给zabbix-server）优</li></ul><p><code>zabbix主动模式与被动模式选择</code></p><ul><li>1.当（Queue）队列中有大量的延迟监控项</li><li>2.当监控主机超过300+ ,建议使用主动模式</li></ul><p>zabbix默认是被动模式</p><ul><li>被动模式100个监控，需要100个回合</li><li>主动模式100个监控，需要1个回合</li></ul><p><img src="/2019/02/14/zabbix自动化监控深入实践/16.png" alt=""></p><hr><h3 id="zabbix被动模式（默认）"><a href="#zabbix被动模式（默认）" class="headerlink" title="zabbix被动模式（默认）"></a>zabbix被动模式（默认）</h3><p><img src="/2019/02/14/zabbix自动化监控深入实践/17.png" alt=""><br><img src="/2019/02/14/zabbix自动化监控深入实践/19.png" alt=""></p><hr><h3 id="zabbix主动模式（优）"><a href="#zabbix主动模式（优）" class="headerlink" title="zabbix主动模式（优）"></a>zabbix主动模式（优）</h3><p><img src="/2019/02/14/zabbix自动化监控深入实践/18.png" alt=""><br><img src="/2019/02/14/zabbix自动化监控深入实践/20.png" alt=""></p><hr><h2 id="主动模式演示"><a href="#主动模式演示" class="headerlink" title="主动模式演示"></a>主动模式演示</h2><ul><li>1.zabbix-agent修改配置文件</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">vim /etc/zabbix/zabbix_agentd.conf</span><br><span class="line">    Server=zabbix-server端地址  </span><br><span class="line">    ServerActive=zabbix-server端地址</span><br><span class="line">    Hostname=定义主机</span><br></pre></td></tr></table></figure><ul><li><p>2.添加主机（自动注册）</p></li><li><p>3.zabbix—web需要将模板修改为主动模式</p><ul><li>1.全克隆默认被动模式的模板–&gt;改名–&gt;主动模式的模板</li><li>2.修改克隆好的模板，进行监控项的修改，修改为主动模式</li><li>3.主机引用，先取消被动模式使用的模板（取消链接并清理），然后链接新的模板</li></ul></li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;第四章：-zabbix自动化监控（自动发现-主动注册-主动模式被动模式）&quot;&gt;&lt;a href=&quot;#第四章：-zabbix自动化监控（自动发现-主动注册-主动模式被动模式）&quot; class=&quot;headerlink&quot; title=&quot;第四章： zabbix自动化监控（自动发现|主动注册|主动模式被动模式）&quot;&gt;&lt;/a&gt;第四章： zabbix自动化监控（自动发现|主动注册|主动模式被动模式）&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/14/zabbix自动化监控深入实践/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="zabbix_老男孩" scheme="https://daizhe.net.cn/categories/zabbix-%E8%80%81%E7%94%B7%E5%AD%A9/"/>
    
    
      <category term="zabbix_老男孩" scheme="https://daizhe.net.cn/tags/zabbix-%E8%80%81%E7%94%B7%E5%AD%A9/"/>
    
  </entry>
  
  <entry>
    <title>zabbix应用服务器监控之php-fpm服务状态</title>
    <link href="https://daizhe.net.cn/2019/02/13/zabbix%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E4%B9%8Bphp-fpm%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81/"/>
    <id>https://daizhe.net.cn/2019/02/13/zabbix应用服务监控之php-fpm服务状态/</id>
    <published>2019-02-13T07:51:47.205Z</published>
    <updated>2019-02-20T07:25:03.911Z</updated>
    
    <content type="html"><![CDATA[<h1 id="第三章：zabbix应用服务器监控之php-fpm服务状态"><a href="#第三章：zabbix应用服务器监控之php-fpm服务状态" class="headerlink" title="第三章：zabbix应用服务器监控之php-fpm服务状态"></a>第三章：zabbix应用服务器监控之php-fpm服务状态</h1><p><img src="/2019/02/13/zabbix应用服务监控之php-fpm服务状态/zabbix应用服务器监控之php-fpm服务状态/标题.gif" alt=""><br><a id="more"></a></p><h2 id="PHP-FPM服务状态监控"><a href="#PHP-FPM服务状态监控" class="headerlink" title="PHP-FPM服务状态监控"></a>PHP-FPM服务状态监控</h2><h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><ul><li>1.在nginx配置文件开启php-fpm状态显示</li><li>2.编写脚本对php-fpm状态数据进行采集</li><li>3.在zabbix agent设置用户的自定义参数</li><li>4.重启zabbix-agent服务使配置生效</li><li>5.在zabbix服务端添加item</li><li>6.创建监控图形</li><li>7.创建事件触发器</li><li>8.创建模板以方便后期配置其他主机</li></ul><h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>1.zabbix-server端已经安装好</p><p>2.zabbix-agent端安装zabbix-agent和php-fpm并开启状态页面</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line">agent端安装php-fpm以及zabbix-agent</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># rpm -ivh https://mirrors.aliyun.com/zabbix/zabbix/3.4/rhel/7/x86_64/zabbix-agent-3.4.3-1.el7.x86_64.rpm</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># yum install php-fpm php -y</span></span><br><span class="line"></span><br><span class="line">配置zabbix-agent配置文件定义zabbix-server的地址</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/zabbix/zabbix_agentd.conf </span></span><br><span class="line">  Server=172.18.139.69  <span class="comment">#zabbix-server端的地址</span></span><br><span class="line">  ~]<span class="comment"># systemctl start zabbix-agent.service </span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  10050 </span><br><span class="line"></span><br><span class="line">php-fpm 开启状态模块</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/php-fpm.d/www.conf </span></span><br><span class="line">  121行</span><br><span class="line">  pm.status_path = /phpfpm_status</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl start php-fpm</span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  127.0.0.1:9000 </span><br><span class="line"></span><br><span class="line">此时用户不可直接访问php-fpm的状态页面查看，去要借助nginx去做请求</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># yum install nginx</span></span><br><span class="line">  ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">  server &#123;</span><br><span class="line">      listen 80;</span><br><span class="line"></span><br><span class="line">        location ~ /(phpfpm_status)$ &#123;</span><br><span class="line">        include fastcgi_params;</span><br><span class="line">        fastcgi_pass 127.0.0.1:9000;</span><br><span class="line">        fastcgi_param SCRIPT_FILENAME <span class="variable">$document_root</span><span class="variable">$fastcgi_script_name</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">  ~]<span class="comment"># nginx -t</span></span><br><span class="line">  ~]<span class="comment"># nginx -s reload</span></span><br><span class="line"></span><br><span class="line">访问指定路径查看php-fpm状态信息</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># curl -s 172.18.139.71:80/phpfpm_status</span></span><br><span class="line">  pool:                 www</span><br><span class="line">  process manager:      dynamic</span><br><span class="line">  start time:           13/Feb/2019:16:29:34 +0800</span><br><span class="line">  start since:          703</span><br><span class="line">  accepted conn:        1</span><br><span class="line">  listen queue:         0</span><br><span class="line">  max listen queue:     0</span><br><span class="line">  listen queue len:     128</span><br><span class="line">  idle processes:       4</span><br><span class="line">  active processes:     1</span><br><span class="line">  total processes:      5</span><br><span class="line">  max active processes: 1</span><br><span class="line">  max children reached: 0</span><br><span class="line">  slow requests:        0</span><br></pre></td></tr></table></figure><hr><p>补充回顾：</p><ul><li>pool – fpm池子名称，大多数为www</li><li>process manager – 进程管理方式,值：static(静态), dynamic or ondemand. dynamic（动态）</li><li>start time – 启动日期,如果reload了php-fpm，时间会更新</li><li>start since – 运行时长</li><li>accepted conn – 当前池子接受的请求数</li><li>listen queue – 请求等待队列，如果这个值不为0，那么要增加FPM的进程数量</li><li>max listen queue – 请求等待队列最高的数量</li><li>listen queue len – socket等待队列长度</li><li>idle processes – 空闲进程数量</li><li>active processes – 活跃进程数量</li><li>total processes – 总进程数量</li><li>max active processes – 最大的活跃进程数量（FPM启动开始算）</li><li>max children reached - 大道进程最大数量限制的次数，如果这个数量不为0，那说明你的最大进程数量太小了，请改大一点。</li><li>slow requests – 启用了php-fpm slow-log，缓慢请求的数量</li></ul><hr><p>3.zabbix-agent端(php-fpm)文件中定义监控项，调用脚本或者命令</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br></pre></td><td class="code"><pre><span class="line">创建一个目录作为以后存放zabbix-agent的调用脚本的目录</span><br><span class="line"></span><br><span class="line">创建目录</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># mkdir /etc/zabbix/scripts</span></span><br><span class="line"></span><br><span class="line">在此目录下创建取nginx状态键值的脚本</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cd /etc/zabbix/scripts/</span></span><br><span class="line">  scripts]<span class="comment"># cat php_fpm_status.sh </span></span><br><span class="line">  <span class="comment">#!/bin/bash</span></span><br><span class="line">  <span class="comment">############################################</span></span><br><span class="line">  <span class="comment">#$name:nginx_status.sh</span></span><br><span class="line">  <span class="comment">#author:daizhe</span></span><br><span class="line">  <span class="comment">#Create Date:2019-02-13</span></span><br><span class="line">  <span class="comment">############################################</span></span><br><span class="line"></span><br><span class="line">  PHPFPM_COMMAND=<span class="variable">$1</span></span><br><span class="line">  PHPFPM_PORT=80 <span class="comment">#根据监听不同端口进行调整</span></span><br><span class="line">  <span class="function"><span class="title">start_since</span></span>()&#123;</span><br><span class="line">  /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$PHPFPM_PORT</span><span class="string">"/phpfpm_status"</span> |awk <span class="string">'/^start since:/ &#123;print $NF&#125;'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">accepted_conn</span></span>()&#123;</span><br><span class="line">  /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$PHPFPM_PORT</span><span class="string">"/phpfpm_status"</span> |awk <span class="string">'/^accepted conn:/ &#123;print $NF&#125;'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">listen_queue</span></span>()&#123;</span><br><span class="line">  /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$PHPFPM_PORT</span><span class="string">"/phpfpm_status"</span> |awk <span class="string">'/^listen queue:/ &#123;print $NF&#125;'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">max_listen_queue</span></span>()&#123;</span><br><span class="line">  /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$PHPFPM_PORT</span><span class="string">"/phpfpm_status"</span> |awk <span class="string">'/^max listen queue:/ &#123;print $NF&#125;'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">listen_queue_len</span></span>()&#123;</span><br><span class="line">  /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$PHPFPM_PORT</span><span class="string">"/phpfpm_status"</span> |awk <span class="string">'/^listen queue len:/ &#123;print $NF&#125;'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">idle_processes</span></span>()&#123;</span><br><span class="line">  /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$PHPFPM_PORT</span><span class="string">"/phpfpm_status"</span> |awk <span class="string">'/^idle processes:/ &#123;print $NF&#125;'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">active_processes</span></span>()&#123;</span><br><span class="line">  /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$PHPFPM_PORT</span><span class="string">"/phpfpm_status"</span> |awk <span class="string">'/^active processes:/ &#123;print $NF&#125;'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">total_processes</span></span>()&#123;</span><br><span class="line">  /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$PHPFPM_PORT</span><span class="string">"/phpfpm_status"</span> |awk <span class="string">'/^total processes:/ &#123;print $NF&#125;'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">max_active_processes</span></span>()&#123;</span><br><span class="line">  /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$PHPFPM_PORT</span><span class="string">"/phpfpm_status"</span> |awk <span class="string">'/^max active processes:/ &#123;print $NF&#125;'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">max_children_reached</span></span>()&#123;</span><br><span class="line">  /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$PHPFPM_PORT</span><span class="string">"/phpfpm_status"</span> |awk <span class="string">'/^max children reached:/ &#123;print $NF&#125;'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">slow_requests</span></span>()&#123;</span><br><span class="line">  /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$PHPFPM_PORT</span><span class="string">"/phpfpm_status"</span> |awk <span class="string">'/^slow requests:/ &#123;print $NF&#125;'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">case</span> <span class="variable">$PHPFPM_COMMAND</span> <span class="keyword">in</span></span><br><span class="line">  start_since)</span><br><span class="line">  start_since;</span><br><span class="line">  ;;</span><br><span class="line">  accepted_conn)</span><br><span class="line">  accepted_conn;</span><br><span class="line">  ;;</span><br><span class="line">  listen_queue)</span><br><span class="line">  listen_queue;</span><br><span class="line">  ;;</span><br><span class="line">  max_listen_queue)</span><br><span class="line">  max_listen_queue;</span><br><span class="line">  ;;</span><br><span class="line">  listen_queue_len)</span><br><span class="line">  listen_queue_len;</span><br><span class="line">  ;;</span><br><span class="line">  idle_processes)</span><br><span class="line">  idle_processes;</span><br><span class="line">  ;;</span><br><span class="line">  active_processes)</span><br><span class="line">  active_processes;</span><br><span class="line">  ;;</span><br><span class="line">  total_processes)</span><br><span class="line">  total_processes;</span><br><span class="line">  ;;</span><br><span class="line">  max_active_processes)</span><br><span class="line">  max_active_processes;</span><br><span class="line">  ;;</span><br><span class="line">  max_children_reached)</span><br><span class="line">  max_children_reached;</span><br><span class="line">  ;;</span><br><span class="line">  slow_requests)</span><br><span class="line">  slow_requests;</span><br><span class="line">  ;;</span><br><span class="line">  *)</span><br><span class="line">  <span class="built_in">echo</span> $<span class="string">"USAGE:<span class="variable">$0</span> &#123;start_since|accepted_conn|listen_queue|max_listen_queue|listen_queue_len|idle_processes|active_processes|total_processes|max_active_processes|max_children_reached&#125;"</span></span><br><span class="line">  <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">将脚本添加执行权</span><br><span class="line"></span><br><span class="line">  scripts]<span class="comment"># chmod +x php_fpm_status.sh </span></span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">执行脚本测试验证是否可以取值</span><br><span class="line"></span><br><span class="line">  scripts]<span class="comment"># sh php_fpm_status.sh max_listen_queue</span></span><br><span class="line">  0</span><br></pre></td></tr></table></figure><p>4.zabbix-agent端文件中定义键值，调用脚本或者命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">进入zabbix-agent定义键值的路径下</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cd /etc/zabbix/zabbix_agentd.d/</span></span><br><span class="line"></span><br><span class="line">在此处添加取键值的文件</span><br><span class="line"></span><br><span class="line">  zabbix_agentd.d]<span class="comment"># vim php_fpm_status.conf </span></span><br><span class="line">  UserParameter=php_fpm_status[*],/bin/bash /etc/zabbix/scripts/php_fpm_status.sh <span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line"></span><br><span class="line">重启zabbix-agent</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart zabbix-agent</span></span><br><span class="line"></span><br><span class="line">zabbix-agent端过滤是否有php_fpm_status监控项</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># zabbix_agentd -p | grep php_fpm_status</span></span><br><span class="line">  php_fpm_status                                [t|USAGE:/etc/zabbix/scripts/php_fpm_status.sh &#123;start_since|accepted_conn|listen_queue|max_listen_queue|listen_queue_len|idle_processes|active_processes|total_processes|max_active_processes|max_children_reached&#125;]</span><br></pre></td></tr></table></figure></p><p>5.zabbix-server端验证zabbix-agent取值是否可以正常取值<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">验证zabbix-server端是否可以正常采取zabbix-agent端的键值</span><br><span class="line"></span><br><span class="line">执行不添加参数提示怎么使用及参数选项</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># zabbix_get -s 172.18.139.71 -k php_fpm_status</span></span><br><span class="line">  USAGE:/etc/zabbix/scripts/php_fpm_status.sh &#123;start_since|accepted_conn|listen_queue|max_listen_queue|listen_queue_len|idle_processes|active_processes|total_processes|max_active_processes|max_children_reached&#125;</span><br><span class="line"></span><br><span class="line">指定验证是否可以正常采取</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># zabbix_get -s 172.18.139.71 -k php_fpm_status[listen_queue]</span></span><br><span class="line">  0</span><br></pre></td></tr></table></figure></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;第三章：zabbix应用服务器监控之php-fpm服务状态&quot;&gt;&lt;a href=&quot;#第三章：zabbix应用服务器监控之php-fpm服务状态&quot; class=&quot;headerlink&quot; title=&quot;第三章：zabbix应用服务器监控之php-fpm服务状态&quot;&gt;&lt;/a&gt;第三章：zabbix应用服务器监控之php-fpm服务状态&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/13/zabbix应用服务监控之php-fpm服务状态/zabbix应用服务器监控之php-fpm服务状态/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="zabbix_老男孩" scheme="https://daizhe.net.cn/categories/zabbix-%E8%80%81%E7%94%B7%E5%AD%A9/"/>
    
    
      <category term="zabbix_老男孩" scheme="https://daizhe.net.cn/tags/zabbix-%E8%80%81%E7%94%B7%E5%AD%A9/"/>
    
  </entry>
  
  <entry>
    <title>zabbix应用服务器监控之nginx服务状态</title>
    <link href="https://daizhe.net.cn/2019/02/13/zabbix%E5%BA%94%E7%94%A8%E6%9C%8D%E5%8A%A1%E7%9B%91%E6%8E%A7%E4%B9%8Bnginx%E6%9C%8D%E5%8A%A1%E7%8A%B6%E6%80%81/"/>
    <id>https://daizhe.net.cn/2019/02/13/zabbix应用服务监控之nginx服务状态/</id>
    <published>2019-02-13T02:54:22.816Z</published>
    <updated>2019-02-20T07:25:07.946Z</updated>
    
    <content type="html"><![CDATA[<h1 id="第三章：zabbix应用服务器监控之nginx服务状态"><a href="#第三章：zabbix应用服务器监控之nginx服务状态" class="headerlink" title="第三章：zabbix应用服务器监控之nginx服务状态"></a>第三章：zabbix应用服务器监控之nginx服务状态</h1><p><img src="/2019/02/13/zabbix应用服务监控之nginx服务状态/标题.gif" alt=""><br><a id="more"></a></p><h2 id="基础模板"><a href="#基础模板" class="headerlink" title="基础模板"></a>基础模板</h2><ul><li>自定义监控项</li><li>自定义触发器</li><li>自定义报警（邮件|微信）</li><li>自定义图形、聚合图形、幻灯片</li><li>自定义模板（给主机添加）</li></ul><h2 id="服务监控"><a href="#服务监控" class="headerlink" title="服务监控"></a>服务监控</h2><ul><li><p>1.对应的服务本身都具备打开状态页面（服务要有对应的信息展示功能），针对状态页面取值，定义监控项，传递给zabbix-agent</p></li><li><p>2.在zabbixweb添加对应的key和主机，zabbix-server抓取zabbix-agent上的数据</p></li><li><p>nginx</p></li><li>PHP-fpm</li><li>mysql</li><li>tomcat</li><li>redis</li></ul><h2 id="nginx服务状态监控"><a href="#nginx服务状态监控" class="headerlink" title="nginx服务状态监控"></a>nginx服务状态监控</h2><h3 id="过程"><a href="#过程" class="headerlink" title="过程"></a>过程</h3><ul><li>1.在nginx配置文件开启Nginx状态显示</li><li>2.编写脚本对nginx状态数据进行采集</li><li>3.在zabbix agent设置用户的自定义参数</li><li>4.重启zabbix-agent服务使配置生效</li><li>5.在zabbix服务端添加item</li><li>6.创建监控图形</li><li>7.创建事件触发器</li><li>8.创建模板以方便后期配置其他主机</li></ul><h3 id="实战"><a href="#实战" class="headerlink" title="实战"></a>实战</h3><p>1.zabbix-server端已经安装好</p><p>2.zabbix-agent端安装zabbix-agent和nginx并开启状态页面</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br></pre></td><td class="code"><pre><span class="line">agent端安装nginx以及zabbix-agent</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># rpm -ivh https://mirrors.aliyun.com/zabbix/zabbix/3.4/rhel/7/x86_64/zabbix-agent-3.4.3-1.el7.x86_64.rpm</span></span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># yum install nginx -y</span></span><br><span class="line"></span><br><span class="line">配置zabbix-agent配置文件定义zabbix-server的地址</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/zabbix/zabbix_agentd.conf </span></span><br><span class="line">  Server=172.18.139.69  <span class="comment">#zabbix-server端的地址</span></span><br><span class="line">  ~]<span class="comment"># systemctl start zabbix-agent.service </span></span><br><span class="line">  ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  10050 </span><br><span class="line"></span><br><span class="line">nginx开启状态页面</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># vim /etc/nginx/nginx.conf</span></span><br><span class="line">  server &#123;</span><br><span class="line">      listen 80;</span><br><span class="line">      ....</span><br><span class="line">     location /status &#123;                </span><br><span class="line">        stub_status;</span><br><span class="line">        access_log off;</span><br><span class="line">        <span class="comment">#allow 允许的主机的地址;   #仅允许此台机器访问此uri</span></span><br><span class="line">        <span class="comment">#deny all;</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># nginx -t</span></span><br><span class="line">  ~]<span class="comment"># nginx -s reload</span></span><br><span class="line"></span><br><span class="line">访问指定路径查看nginx状态信息</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># curl 172.18.139.71:80/status</span></span><br><span class="line">  Active connections: 1 </span><br><span class="line">  server accepts handled requests</span><br><span class="line">  12 12 12 </span><br><span class="line">  Reading: 0 Writing: 1 Waiting: 0 </span><br><span class="line"></span><br><span class="line">```</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">补充回顾：</span><br><span class="line">- Active connections: 291 </span><br><span class="line">- server accepts handled requests</span><br><span class="line">- 16630948 16630948 31070465 </span><br><span class="line">- Reading: 6 Writing: 179 Waiting: 106 </span><br><span class="line"></span><br><span class="line">- Active connections: 活动状态的连接数；</span><br><span class="line">- accepts：已经接受的客户端请求的总数；</span><br><span class="line">- handled：已经处理完成的客户端请求的总数；</span><br><span class="line">- requests：客户端发来的总的请求数；</span><br><span class="line">- Reading：处于读取客户端请求报文首部的连接的连接数；</span><br><span class="line">- Writing：处于向客户端发送响应报文过程中的连接数；</span><br><span class="line">- Waiting：处于等待客户端发出请求的空闲连接数；</span><br><span class="line"></span><br><span class="line">---</span><br><span class="line"></span><br><span class="line">3.zabbix-agent端（nginx）文件中定义监控项，调用脚本或者命令</span><br><span class="line">```bash</span><br><span class="line">创建一个目录作为以后存放zabbix-agent的调用脚本的目录</span><br><span class="line"></span><br><span class="line">创建目录</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># mkdir /etc/zabbix/scripts</span></span><br><span class="line"></span><br><span class="line">在此目录下创建取nginx状态键值的脚本</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cd /etc/zabbix/scripts/</span></span><br><span class="line">  scripts]<span class="comment"># ls</span></span><br><span class="line">  nginx_status.sh</span><br><span class="line">  scripts]<span class="comment"># cat nginx_status.sh </span></span><br><span class="line">  <span class="comment">############################################</span></span><br><span class="line">  <span class="comment">#$name:nginx_status.sh</span></span><br><span class="line">  <span class="comment">#author:daizhe</span></span><br><span class="line">  <span class="comment">#Create Date:2019-02-13</span></span><br><span class="line">  <span class="comment">############################################</span></span><br><span class="line">  NGINX_PORT=80   <span class="comment">#端口根据nginx的端口进行修改</span></span><br><span class="line">  NGINX_COMMAND=<span class="variable">$1</span></span><br><span class="line">  <span class="function"><span class="title">nginx_active</span></span>()&#123;</span><br><span class="line">    /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$NGINX_PORT</span><span class="string">"/status/"</span> |awk <span class="string">'/Active/ &#123;print $NF&#125;'</span>   <span class="comment">#/status/路径根据 nginx配置文件定义状态页面的路径进行修改</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">nginx_reading</span></span>()&#123;</span><br><span class="line">    /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$NGINX_PORT</span><span class="string">"/status/"</span> |awk <span class="string">'/Reading/ &#123;print $2&#125;'</span></span><br><span class="line">  &#125;</span><br><span class="line">  <span class="function"><span class="title">nginx_writing</span></span>()&#123;</span><br><span class="line">    /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$NGINX_PORT</span><span class="string">"/status/"</span> |awk <span class="string">'/Writing/ &#123;print $4&#125;'</span></span><br><span class="line">       &#125;</span><br><span class="line">  <span class="function"><span class="title">nginx_waiting</span></span>()&#123;</span><br><span class="line">    /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$NGINX_PORT</span><span class="string">"/status/"</span> |awk <span class="string">'/Waiting/ &#123;print $6&#125;'</span></span><br><span class="line">       &#125;</span><br><span class="line">  <span class="function"><span class="title">nginx_accepts</span></span>()&#123;</span><br><span class="line">    /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$NGINX_PORT</span><span class="string">"/status/"</span> |awk <span class="string">'NR==3 &#123;print $1&#125;'</span></span><br><span class="line">       &#125;</span><br><span class="line">  <span class="function"><span class="title">nginx_handled</span></span>()&#123;</span><br><span class="line">    /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$NGINX_PORT</span><span class="string">"/status/"</span> |awk <span class="string">'NR==3 &#123;print $2&#125;'</span></span><br><span class="line">       &#125;</span><br><span class="line">  <span class="function"><span class="title">nginx_requests</span></span>()&#123;</span><br><span class="line">    /usr/bin/curl -s <span class="string">"http://127.0.0.1:"</span><span class="variable">$NGINX_PORT</span><span class="string">"/status/"</span> |awk <span class="string">'NR==3 &#123;print $3&#125;'</span></span><br><span class="line">       &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">case</span> <span class="variable">$NGINX_COMMAND</span> <span class="keyword">in</span></span><br><span class="line">  active)</span><br><span class="line">    nginx_active;</span><br><span class="line">    ;;</span><br><span class="line">  reading)</span><br><span class="line">    nginx_reading;</span><br><span class="line">    ;;</span><br><span class="line">  writing)</span><br><span class="line">    nginx_writing;</span><br><span class="line">    ;;</span><br><span class="line">  waiting)</span><br><span class="line">    nginx_waiting;</span><br><span class="line">    ;;</span><br><span class="line">  accepts)</span><br><span class="line">    nginx_accepts;</span><br><span class="line">    ;;</span><br><span class="line">  handled)</span><br><span class="line">    nginx_handled;</span><br><span class="line">    ;;</span><br><span class="line">  requests)</span><br><span class="line">    nginx_requests;</span><br><span class="line">    ;;</span><br><span class="line">  *)</span><br><span class="line">    <span class="built_in">echo</span> $<span class="string">"USAGE:<span class="variable">$0</span> &#123;active|reading|writing|waiting|accepts|handled|requests&#125;"</span></span><br><span class="line">    <span class="keyword">esac</span></span><br><span class="line"></span><br><span class="line">将脚本添加执行权</span><br><span class="line"></span><br><span class="line">  scripts]<span class="comment"># chmod +x nginx_status.sh </span></span><br><span class="line"></span><br><span class="line">执行脚本测试验证是否可以取值（范例为：活动状态连接数）</span><br><span class="line"></span><br><span class="line">  scripts]<span class="comment"># sh nginx_status.sh active</span></span><br><span class="line">  1</span><br></pre></td></tr></table></figure><p>4.zabbix-agent端文件中定义键值，调用脚本或者命令<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">进入zabbix-agent定义键值的路径下</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># cd /etc/zabbix/zabbix_agentd.d/</span></span><br><span class="line"></span><br><span class="line">在此处添加取键值的文件</span><br><span class="line"></span><br><span class="line">  zabbix_agentd.d]<span class="comment"># vim nginx_status.conf</span></span><br><span class="line">  UserParameter=nginx_status[*],/bin/bash /etc/zabbix/scripts/nginx_status.sh <span class="string">"<span class="variable">$1</span>"</span>    <span class="comment">#此路径根据定义的取值脚本路径填写</span></span><br><span class="line"></span><br><span class="line">重启zabbix-agent</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># systemctl restart zabbix-agent</span></span><br><span class="line"></span><br><span class="line">zabbix-agent端过滤是否有nginx_status监控项</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># zabbix_agentd -p | grep nginx_status</span></span><br><span class="line">  nginx_status     [t|USAGE:/etc/zabbix/scripts/nginx_status.sh &#123;active|reading|writing|waiting|accepts|handled|requests&#125;]</span><br></pre></td></tr></table></figure></p><p>5.zabbix-server端验证zabbix-agent取值是否可以正常取值<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">验证zabbix-server端是否可以正常采取zabbix-agent端的键值</span><br><span class="line"></span><br><span class="line">执行不添加参数提示怎么使用及参数选项</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># zabbix_get -s 172.18.139.71 -k nginx_status</span></span><br><span class="line">  USAGE:/etc/zabbix/scripts/nginx_status.sh &#123;active|reading|writing|waiting|accepts|handled|requests&#125;</span><br><span class="line"></span><br><span class="line">指定验证是否可以正常采取</span><br><span class="line"></span><br><span class="line">  ~]<span class="comment"># zabbix_get -s 172.18.139.71 -k nginx_status[active]</span></span><br><span class="line">  1</span><br><span class="line">  ~]<span class="comment"># zabbix_get -s 172.18.139.71 -k nginx_status[handled]</span></span><br><span class="line">  39</span><br></pre></td></tr></table></figure></p><p>6.zabbix-web界面添加监控的zabbix-agent客户端主机<br><img src="/2019/02/13/zabbix应用服务监控之nginx服务状态/1.png" alt=""></p><p>7.创建新的应用集，将监控项关联至应用集（将所有的监控项添加到应用集中）<br><img src="/2019/02/13/zabbix应用服务监控之nginx服务状态/2.png" alt=""><br><img src="/2019/02/13/zabbix应用服务监控之nginx服务状态/3.png" alt=""></p><p>8.应用监控项<br><img src="/2019/02/13/zabbix应用服务监控之nginx服务状态/4.png" alt=""><br><img src="/2019/02/13/zabbix应用服务监控之nginx服务状态/5.png" alt=""></p><hr><p>1.添加监听nginx服务器是否存活（zabbix-agent）<br><img src="/2019/02/13/zabbix应用服务监控之nginx服务状态/6.png" alt=""></p><p>2.查看监控状态<br><img src="/2019/02/13/zabbix应用服务监控之nginx服务状态/7.png" alt=""></p><p>3.可以定义触发器进行监控</p><h2 id="实战经验总结："><a href="#实战经验总结：" class="headerlink" title="实战经验总结："></a>实战经验总结：</h2><ul><li>1.先查看文档中有没有对应的脚本和xml模板</li><li>2.在服务端导入模板，查看对应的监控项名称</li><li>3.测试脚本是否能取值，并存放置于/etc/zabbix/scripts目录下，一定要增加执行权限</li><li>4.编写xx.conf文件，里面主要存放的是如何定义监控项</li><li>5.最后重启zabbix-agent</li><li>6.使用服务端zabbix-get 获取 zabbix-agent对应的监控项的数据</li></ul>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;第三章：zabbix应用服务器监控之nginx服务状态&quot;&gt;&lt;a href=&quot;#第三章：zabbix应用服务器监控之nginx服务状态&quot; class=&quot;headerlink&quot; title=&quot;第三章：zabbix应用服务器监控之nginx服务状态&quot;&gt;&lt;/a&gt;第三章：zabbix应用服务器监控之nginx服务状态&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/13/zabbix应用服务监控之nginx服务状态/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="zabbix_老男孩" scheme="https://daizhe.net.cn/categories/zabbix-%E8%80%81%E7%94%B7%E5%AD%A9/"/>
    
    
      <category term="zabbix_老男孩" scheme="https://daizhe.net.cn/tags/zabbix-%E8%80%81%E7%94%B7%E5%AD%A9/"/>
    
  </entry>
  
  <entry>
    <title>zabbix自定义内容报警图形及模板</title>
    <link href="https://daizhe.net.cn/2019/02/12/zabbix%E8%87%AA%E5%AE%9A%E4%B9%89%E5%86%85%E5%AE%B9%E6%8A%A5%E8%AD%A6%E5%9B%BE%E5%BD%A2%E5%8F%8A%E6%A8%A1%E6%9D%BF/"/>
    <id>https://daizhe.net.cn/2019/02/12/zabbix自定义内容报警图形及模板/</id>
    <published>2019-02-12T04:49:18.535Z</published>
    <updated>2019-02-20T07:24:37.261Z</updated>
    
    <content type="html"><![CDATA[<h1 id="第二章：zabbix自定义内容报警图形及模板"><a href="#第二章：zabbix自定义内容报警图形及模板" class="headerlink" title="第二章：zabbix自定义内容报警图形及模板"></a>第二章：zabbix自定义内容报警图形及模板</h1><p><img src="/2019/02/12/zabbix自定义内容报警图形及模板/标题.gif" alt=""><br><a id="more"></a></p><h2 id="报警内容实战"><a href="#报警内容实战" class="headerlink" title="报警内容实战"></a>报警内容实战</h2><ul><li>告警消息内容</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">报警主机 ：&#123;HOST.NAME1&#125;</span><br><span class="line">报警服务 ：&#123;ITEM.NAME1&#125;</span><br><span class="line">报警KEY1  : &#123;ITEM.KEY1&#125;: &#123;ITEM.VALUE1&#125;    <span class="comment">#依据自己报警项数量进行定义</span></span><br><span class="line">报警KEY2  : &#123;ITEM.KEY2&#125;: &#123;ITEM.VALUE2&#125;</span><br><span class="line">严重级别 ： &#123;TRIGGER.SEVERITY&#125;</span><br></pre></td></tr></table></figure><ul><li>恢复消息内容</li></ul><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">恢复主机 ：&#123;HOST.NAME1&#125;</span><br><span class="line">恢复服务 ：&#123;ITEM.NAME1&#125;</span><br><span class="line">恢复KEY1 : &#123;ITEM.KEY1&#125;: &#123;ITEM.VALUE1&#125;   <span class="comment">#依据自己报警项数量进行定义</span></span><br><span class="line">恢复KEY2 : &#123;ITEM.KEY2&#125;: &#123;ITEM.VALUE2&#125;</span><br></pre></td></tr></table></figure><p>故障报警<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/1.png" alt=""></p><p>恢复报警操作<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/2.png" alt=""></p><hr><h2 id="自定义图形实战"><a href="#自定义图形实战" class="headerlink" title="自定义图形实战"></a>自定义图形实战</h2><p>1.自定义图形监控项（应用集–&gt;监控项–&gt;基于监控项创建触发器–&gt;基于监控项创建图形）<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/3.png" alt=""></p><p>2.设置图形名称及大小<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/4.png" alt=""></p><p>3.预览查看<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/5.png" alt=""></p><p>4.保存设置的图形监控查看<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/6.png" alt=""></p><hr><h2 id="自定义聚合图形"><a href="#自定义聚合图形" class="headerlink" title="自定义聚合图形"></a>自定义聚合图形</h2><ul><li>聚合图形–&gt;将多张图整合起来，合并为一张图</li></ul><p>1.常见聚合图形<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/7.png" alt=""><br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/8.png" alt=""></p><p>2.在聚合图形中构造函数<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/9.png" alt=""><br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/10.png" alt=""></p><p>3.成品<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/11.png" alt=""></p><hr><h2 id="自定义聚合图形幻灯片"><a href="#自定义聚合图形幻灯片" class="headerlink" title="自定义聚合图形幻灯片"></a>自定义聚合图形幻灯片</h2><p>1.创建幻灯片<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/12.png" alt=""></p><p>2.将监控的聚合图形添加到幻灯片<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/13.png" alt=""></p><p>3.查看幻灯片/聚合图形<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/14.png" alt=""></p><hr><h2 id="自定义图形Graphtree"><a href="#自定义图形Graphtree" class="headerlink" title="自定义图形Graphtree"></a>自定义图形Graphtree</h2><ul><li>功能<ul><li>1、集中展示所有分组设备</li><li>2、集中展示一个分组图像</li><li>3、集中展示一个设备图像</li><li>4、展示设备下的Application</li><li>5、展示每个Application下的图像</li><li>6、展示每个Application下的日志</li><li>7、对原生无图的监控项进行绘图</li></ul></li><li>注意问题:<ul><li>在组和主机级别，默认只显示系统配置的graph<br>点击application后，会显示3种数据：</li><li>1.系统默认有graph的；</li><li>2.系统默认无graph的；</li><li>3.日志类的</li></ul></li><li>githun解释文档及手册：<a href="https://github.com/OneOaaS/graphtrees" target="_blank" rel="noopener">https://github.com/OneOaaS/graphtrees</a></li></ul><p>安装:如果您已经安装了zabbix web RPM repo  ＃从未使用过3.0.1的补丁<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">zabbix-server端</span><br><span class="line"></span><br><span class="line">    安装Graphtree</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># cd /usr/share/zabbix</span></span><br><span class="line">    zabbix]<span class="comment"># wget https://raw.githubusercontent.com/OneOaaS/graphtrees/master/graphtree3.0.4.patch</span></span><br><span class="line">    ~]<span class="comment"># yum install -y patch</span></span><br><span class="line"></span><br><span class="line">    导入补丁包</span><br><span class="line"></span><br><span class="line">    zabbix]<span class="comment"># patch  -Np0 &lt;graphtree3.0.4.patch </span></span><br><span class="line">    zabbix]<span class="comment"># chown -R apache.apache oneoaas</span></span><br><span class="line"></span><br><span class="line">    修改apache配置文件</span><br><span class="line"></span><br><span class="line">    ~]<span class="comment"># vim /etc/httpd/conf.d/zabbix.conf</span></span><br><span class="line">    最后一行添加</span><br><span class="line">    Alias /oneoaas /usr/share/zabbix/oneoaas</span><br><span class="line">    Alias /zabbix /user/share/zabbix</span><br><span class="line"></span><br><span class="line">    重启apache</span><br><span class="line">    ~]<span class="comment"># systemctl restart httpd</span></span><br></pre></td></tr></table></figure></p><p>刷新zabbix-web查看</p><p><img src="/2019/02/12/zabbix自定义内容报警图形及模板/15.png" alt=""><br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/16.png" alt=""></p><hr><h2 id="自定义模板"><a href="#自定义模板" class="headerlink" title="自定义模板"></a>自定义模板</h2><ul><li>1.模板是支持导入与导出（模板里面的监控项是由脚本支撑，所有脚本需一起打包）</li><li>2.zabbix-agent端.conf的文件中定义监控项及对应的键值，调用脚本或者命令</li><li><p>2.如果希望将之前定义的监控项做成模板，找到监控项–&gt;全选–&gt;复制</p></li><li><p>自定义模板的好处：可以将监控项重复的使用</p></li></ul><p>1.创建模板<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/17.png" alt=""><br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/18.png" alt=""></p><p>2.将原模板的监控项（键值）复制到新的模板中<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/19.png" alt=""><br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/20.png" alt=""></p><p>3.查看自定义的模板中是否存在复制的监控项<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/21.png" alt=""></p><h3 id="将定义的模板关联到其他主机上（这里将此模板关联到zabbix-server主机上，此时server端扮演zabbix-sgent身份）"><a href="#将定义的模板关联到其他主机上（这里将此模板关联到zabbix-server主机上，此时server端扮演zabbix-sgent身份）" class="headerlink" title="将定义的模板关联到其他主机上（这里将此模板关联到zabbix-server主机上，此时server端扮演zabbix-sgent身份）"></a>将定义的模板关联到其他主机上（这里将此模板关联到zabbix-server主机上，此时server端扮演zabbix-sgent身份）</h3><p>1.被关联模板的主机必须要定义监控项和对应的取值脚本<br>1.1<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">被监控的主机，安装zabbix客户端：zabbix-agent</span><br><span class="line">    ~]<span class="comment"># rpm -ivh https://mirrors.aliyun.com/zabbix/zabbix/3.4/rhel/7/x86_64/zabbix-agent-3.4.3-1.el7.x86_64.rpm</span></span><br><span class="line"></span><br><span class="line">配置客户端（设置允许zabbix_server端的地址，声明此客户端允许那台服务端进行监控）</span><br><span class="line">    ~]<span class="comment"># vim /etc/zabbix/zabbix_agentd.conf </span></span><br><span class="line">    97行（填写server端的ip/主机名）</span><br><span class="line">    Server=192.168.52.202</span><br><span class="line"></span><br><span class="line">启动zabbix-agent客户端</span><br><span class="line">    ~]<span class="comment"># systemctl start zabbix-agent</span></span><br><span class="line">    ~]<span class="comment"># systemctl enable zabbix-agent</span></span><br><span class="line"></span><br><span class="line">server端平滑重新加载</span><br><span class="line">    ~]<span class="comment"># zabbix_server -R config_cache_reload</span></span><br></pre></td></tr></table></figure></p><p>1.2查看想要被模板连接的主机（agent端）是否被server端监控<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/22.png" alt=""></p><p>2.将原模板添加到应用集中<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/25.png" alt=""><br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/26.png" alt=""></p><p>2.被关联的主机上导入模板<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/23.png" alt=""><br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/24.png" alt=""></p><p>3.zabbix-server端验证是否添加应用集，应用集中是有监控项键值（但是此时出现红色感叹号！说明server端获取不到agent的键值）<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/27.png" alt=""></p><p>4.在agent端设置对应的应用集（将原agent端定义应用集文件scp到新的agent端）</p><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">~]<span class="comment"># cat /etc/zabbix/zabbix_agentd.d/iostart.conf </span></span><br><span class="line">UserParameter=IO,iostat | awk <span class="string">'/^sda/&#123;print $2&#125;'</span></span><br><span class="line">UserParameter=TCP_STATUS_[*],netstat -an | grep -c <span class="string">"<span class="variable">$1</span>"</span></span><br><span class="line">UserParameter=Mem_pre,free -m | awk <span class="string">'/Mem/&#123;print $NF*100/$2&#125;'</span></span><br><span class="line">UserParameter=SWAP_pre,free -m | awk <span class="string">'/Swap/&#123;print $3*100/$2&#125;'</span></span><br><span class="line"></span><br><span class="line">~]<span class="comment"># systemctl restart zabbix-agent.service</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">#刷新不支持的key默认刷新时间间隔为10m</span></span><br><span class="line"><span class="comment">#如何修改</span></span><br><span class="line"><span class="comment">#管理--&gt;一般--&gt;其他--&gt;修改刷新不支持的项目时间</span></span><br></pre></td></tr></table></figure><p>5.查看模板是否导入成功<br><img src="/2019/02/12/zabbix自定义内容报警图形及模板/28.png" alt=""></p>]]></content>
    
    <summary type="html">
    
      &lt;h1 id=&quot;第二章：zabbix自定义内容报警图形及模板&quot;&gt;&lt;a href=&quot;#第二章：zabbix自定义内容报警图形及模板&quot; class=&quot;headerlink&quot; title=&quot;第二章：zabbix自定义内容报警图形及模板&quot;&gt;&lt;/a&gt;第二章：zabbix自定义内容报警图形及模板&lt;/h1&gt;&lt;p&gt;&lt;img src=&quot;/2019/02/12/zabbix自定义内容报警图形及模板/标题.gif&quot; alt=&quot;&quot;&gt;&lt;br&gt;&lt;/p&gt;
    
    </summary>
    
      <category term="zabbix_老男孩" scheme="https://daizhe.net.cn/categories/zabbix-%E8%80%81%E7%94%B7%E5%AD%A9/"/>
    
    
      <category term="zabbix_老男孩" scheme="https://daizhe.net.cn/tags/zabbix-%E8%80%81%E7%94%B7%E5%AD%A9/"/>
    
  </entry>
  
</feed>
