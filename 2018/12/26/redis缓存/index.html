<!DOCTYPE html>













<html class="theme-next pisces" lang="zh-CN">
<head><meta name="generator" content="Hexo 3.8.0">
  <meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<script src="//cdn.bootcss.com/pace/1.0.2/pace.min.js"></script>
<link href="//cdn.bootcss.com/pace/1.0.2/themes/pink/pace-theme-flash.css" rel="stylesheet">
<style>
    .pace .pace-progress {
        background: #1E92FB; /*进度条颜色*/
        height: 3px;
    }
    .pace .pace-progress-inner {
         box-shadow: 0 0 10px #1E92FB, 0 0 5px     #1E92FB; /*阴影颜色*/
    }
    .pace .pace-activity {
        border-top-color: #1E92FB;    /*上边框颜色*/
        border-left-color: #1E92FB;    /*左边框颜色*/
    }
</style>

<meta name="theme-color" content="#222">






  
  
    
    
  <script src="/lib/pace/pace.min.js?v=1.0.2"></script>
  <link href="/lib/pace/pace-theme-minimal.min.css?v=1.0.2" rel="stylesheet">







<meta http-equiv="Cache-Control" content="no-transform">
<meta http-equiv="Cache-Control" content="no-siteapp">





















<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css">

<link href="/css/main.css?v=6.6.0" rel="stylesheet" type="text/css">


  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png?v=6.6.0">


  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon.ico?v=6.6.0">


  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png?v=6.6.0">


  <link rel="mask-icon" href="/images/logo.svg?v=6.6.0" color="#222">









<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    version: '6.6.0',
    sidebar: {"position":"left","display":"post","offset":12,"b2t":false,"scrollpercent":true,"onmobile":false},
    fancybox: false,
    fastclick: false,
    lazyload: false,
    tabs: true,
    motion: {"enable":false,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}},
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>


  




  <script>
  (function(i,s,o,g,r,a,m){i["DaoVoiceObject"]=r;i[r]=i[r]||function(){(i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;a.charset="utf-8";m.parentNode.insertBefore(a,m)})(window,document,"script",('https:' == document.location.protocol ? 'https:' : 'http:') + "//widget.daovoice.io/widget/0f81ff2f.js","daovoice")
  daovoice('init', {
      app_id: "Infinity"
    });
  daovoice('update');
  </script>

  <meta name="description" content="redis缓存及架构">
<meta name="keywords" content="redis缓存">
<meta property="og:type" content="article">
<meta property="og:title" content="redis缓存">
<meta property="og:url" content="https://daizhe.net.cn/2018/12/26/redis缓存/index.html">
<meta property="og:site_name" content="Dai zhe&#39;s notes">
<meta property="og:description" content="redis缓存及架构">
<meta property="og:locale" content="zh-CN">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/标题.gif">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/chrome浏览器缓存.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/最后修改时间.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/etag标记.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/过期时间.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/用户请求CDN流程.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/redis简介.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/编译安装redis.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/生产者消费者模式.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/队列介绍.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/发布者订阅模式.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/分布式缓存.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/配置redis主从.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/同步日志.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/当前slave状态.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/验证slave.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/同步过程.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/同步过程日志.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/master同步日志.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/从节点再有从节点.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/master密码不对.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/版本不一致报错.png">
<meta property="og:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/远程无法连接.png">
<meta property="og:updated_time" content="2019-02-04T08:38:45.933Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="redis缓存">
<meta name="twitter:description" content="redis缓存及架构">
<meta name="twitter:image" content="https://daizhe.net.cn/2018/12/26/redis缓存/标题.gif">



  <link rel="alternate" href="/atom.xml" title="Dai zhe's notes" type="application/atom+xml">




  <link rel="canonical" href="https://daizhe.net.cn/2018/12/26/redis缓存/">



<script type="text/javascript" id="page.configurations">
  CONFIG.page = {
    sidebar: "",
  };
</script>

  <title>redis缓存 | Dai zhe's notes</title>
  











  <noscript>
  <style type="text/css">
    .use-motion .motion-element,
    .use-motion .brand,
    .use-motion .menu-item,
    .sidebar-inner,
    .use-motion .post-block,
    .use-motion .pagination,
    .use-motion .comments,
    .use-motion .post-header,
    .use-motion .post-body,
    .use-motion .collection-title { opacity: initial; }

    .use-motion .logo,
    .use-motion .site-title,
    .use-motion .site-subtitle {
      opacity: initial;
      top: initial;
    }

    .use-motion {
      .logo-line-before i { left: initial; }
      .logo-line-after i { right: initial; }
    }
  </style>
</noscript>

</head>

<body itemscope="" itemtype="http://schema.org/WebPage" lang="zh-CN">
<link rel="stylesheet" href="/dist/APlayer.min.css">
<div id="aplayer"></div>
<script type="text/javascript" src="/dist/APlayer.min.js"></script>
<script type="text/javascript" src="/dist/music.js"></script>
  
  
    
  

  <div class="container sidebar-position-left page-post-detail">
    <div class="headband"></div>
    <header id="header" class="header" itemscope="" itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/" class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">Dai zhe's notes</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
    
      
        <p class="site-subtitle">Just Du It</p>
      
    
  </div>

  <div class="site-nav-toggle">
    <button aria-label="切换导航栏">
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>



<nav class="site-nav">
  
    <ul id="menu" class="menu">
      
        
        
        
          
          <li class="menu-item menu-item-home">

    
    
    
      
    

    
      
    

    <a href="/" rel="section"><i class="menu-item-icon fa fa-fw fa-home"></i> <br>首页</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-about">

    
    
    
      
    

    
      
    

    <a href="/about/" rel="section"><i class="menu-item-icon fa fa-fw fa-address-card"></i> <br>关于</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-tags">

    
    
    
      
    

    
      
    

    <a href="/tags/" rel="section"><i class="menu-item-icon fa fa-fw fa-tags"></i> <br>标签<span class="badge">19</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-categories">

    
    
    
      
    

    
      
    

    <a href="/categories/" rel="section"><i class="menu-item-icon fa fa-fw fa-th"></i> <br>分类<span class="badge">17</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-archives">

    
    
    
      
    

    
      
    

    <a href="/archives/" rel="section"><i class="menu-item-icon fa fa-fw fa-archive"></i> <br>归档<span class="badge">70</span></a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-相册">

    
    
    
      
    

    
      
    

    <a href="/photos/" rel="section"><i class="menu-item-icon fa fa-fw fa-camera-retro"></i> <br>相册</a>

  </li>
        
        
        
          
          <li class="menu-item menu-item-书单&music">

    
    
    
      
    

    
      
    

    <a href="/shudan/" rel="section"><i class="menu-item-icon fa fa-fw fa-gratipay"></i> <br>书单&music</a>

  </li>

      
      
        <li class="menu-item menu-item-search">
          
            <a href="javascript:;" class="popup-trigger">
          
            
              <i class="menu-item-icon fa fa-search fa-fw"></i> <br>搜索</a>
        </li>
      
    </ul>
  

  

  
    <div class="site-search">
      
  <div class="popup search-popup local-search-popup">
  <div class="local-search-header clearfix">
    <span class="search-icon">
      <i class="fa fa-search"></i>
    </span>
    <span class="popup-btn-close">
      <i class="fa fa-times-circle"></i>
    </span>
    <div class="local-search-input-wrapper">
      <input autocomplete="off" placeholder="搜索..." spellcheck="false" type="text" id="local-search-input">
    </div>
  </div>
  <div id="local-search-result"></div>
</div>



    </div>
  
</nav>



  


</div>
    </header>

    <a href="https://github.com/Dz6666" class="github-corner" target="_blank" title="Follow me on GitHub" aria-label="Follow me on GitHub">
      <svg width="80" height="80" viewbox="0 0 250 250" style="fill:#222; color:#fff; position: absolute; top: 0; border: 0; right: 0;" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"/><path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2" fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"/>
    <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z" fill="currentColor" class="octo-body"/>
      </svg>
      </a>

    


    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          
            

          
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  

  <article class="post post-type-normal" itemscope="" itemtype="http://schema.org/Article">
  
  
  
  <div class="post-block">
    <link itemprop="mainEntityOfPage" href="https://daizhe.net.cn/2018/12/26/redis缓存/">

    <span hidden itemprop="author" itemscope="" itemtype="http://schema.org/Person">
      <meta itemprop="name" content="哆啦A梦">
      <meta itemprop="description" content="More than that">
      <meta itemprop="image" content="/images/haha.gif">
    </span>

    <span hidden itemprop="publisher" itemscope="" itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Dai zhe's notes">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">redis缓存
              
            
          </h1>
        

        <div class="post-meta">
                  
          <span class="post-time">

            
            
            

            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              

              
                
              

              <time title="创建时间：2018-12-26 20:22:34" itemprop="dateCreated datePublished" datetime="2018-12-26T20:22:34+08:00">2018-12-26</time>
            

            
          </span>

          
            <span class="post-category">
            
              <span class="post-meta-divider">|</span>
            
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              
                <span class="post-meta-item-text">分类于</span>
              
              
                <span itemprop="about" itemscope="" itemtype="http://schema.org/Thing"><a href="/categories/redis/" itemprop="url" rel="index"><span itemprop="name">redis</span></a></span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2018/12/26/redis缓存/#comments" itemprop="discussionUrl">
                  <span class="post-meta-item-text">评论数：</span> <span class="post-comments-count valine-comment-count" data-xid="/2018/12/26/redis缓存/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          
            <div class="post-symbolscount">
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-file-word-o"></i>
                </span>
                
                  <span class="post-meta-item-text">本文字数：</span>
                
                <span title="本文字数">31k</span>
              

              
                <span class="post-meta-divider">|</span>
              

              
                <span class="post-meta-item-icon">
                  <i class="fa fa-clock-o"></i>
                </span>
                
                  <span class="post-meta-item-text">阅读时长 &asymp;</span>
                
                <span title="阅读时长">28 分钟</span>
              
            </div>
          

          

        </div>
      </header>
    

    
    
    
    <div class="post-body" itemprop="articleBody">

      
      

      
        <h1 id="redis缓存及架构"><a href="#redis缓存及架构" class="headerlink" title="redis缓存及架构"></a>redis缓存及架构</h1><p><img src="/2018/12/26/redis缓存/标题.gif" alt=""><br><a id="more"></a></p>
<h2 id="一：-缓存概念："><a href="#一：-缓存概念：" class="headerlink" title="一： 缓存概念："></a>一： 缓存概念：</h2><ul>
<li>缓存概念<ul>
<li>缓存是为了调节速度不一致的两个或多个不同的物质的速度，在中间对速度较快的一方起到一个加速访问速度较慢的一方的作用，比如CPU的一级、二级缓存是保存了CPU最近经常访问的数据，内存是保存CPU经常访问硬盘的数据，而且硬盘也有大小不一的缓存，甚至是物理服务器的raid 卡有也缓存，都是为了起到加速CPU 访问硬盘数据的目的，因为CPU的速度太快了，CPU需要的数据硬盘往往不能在短时间内满足CPU的需求，因此PCU缓存、内存、Raid 卡以及硬盘缓存就在一定程度上满足了CPU的数据需求，即CPU 从缓存读取数据可以大幅提高CPU的工作效率。</li>
</ul>
</li>
<li><p>系统缓存</p>
<ul>
<li>1.buffer与cache：<br>buffer：缓冲也叫写缓冲，一般用于写操作，可以将数据先写入内存在写入磁盘，buffer 一般用于写缓冲，用于解决不同介质的速度不一致的缓冲，先将数据临时写入到里自己最近的地方，以提高写入速度，CPU会把数据线写到内存的磁盘缓冲区，然后就认为数据已经写入完成看，然后内核的线程在后面的时间在写入磁盘，所以服务器突然断电会丢失内存中的部分数据。<br>cache：缓存也叫读缓存，一般用于读操作，CPU读文件从内存读，如果内存没有就先从硬盘读到内存再读到CPU，将需要频繁读取的数据放在里自己最近的缓存区域，下次读取的时候即可快速读取。</li>
<li><p>2.cache的保存位置：</p>
<ul>
<li>客户端：浏览器</li>
<li>内存：本地服务器、远程服务器</li>
<li>硬盘：本机硬盘、远程服务器硬盘</li>
<li>速度对比：</li>
<li>客户端浏览器-内存-远程内存-硬盘-远程硬盘。</li>
</ul>
</li>
<li><p>3.cache的特性：</p>
<ul>
<li>过期时间</li>
<li>强制过期，源网站更新图片后CDN是不会更新的，需要强制是图片缓存过期</li>
<li>命中率，即缓存的读取命中率</li>
</ul>
</li>
</ul>
</li>
<li><p>用户层缓存：</p>
<ul>
<li>1.DNS缓存：<ul>
<li>默认为60秒，即60秒之内在访问同一个域名就不在进行 </li>
<li>DNS解析：</li>
<li>查看chrome浏览器的DNS缓存：</li>
<li>chrome://net-internals/#dns</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/2018/12/26/redis缓存/chrome浏览器缓存.png" alt=""></p>
<ul>
<li>浏览器缓存过期机制：<ul>
<li>最后修改时间：<ul>
<li>系统调用会获取文件的最后修改时间，如果没有发生变化就返回给浏览器304的状态码，表示没有发生变化，然后浏览器就使用的本地的缓存展示资源，</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/2018/12/26/redis缓存/最后修改时间.png" alt=""></p>
<ul>
<li>Etag标记：<ul>
<li>基于Etag标记是否一致做判断页面是否发生过变化</li>
</ul>
</li>
</ul>
<p><img src="/2018/12/26/redis缓存/etag标记.png" alt=""></p>
<ul>
<li>过期时间：<ul>
<li>以上两种都需要发送请求，即不管资源是否过期都要发送请求进行协商，这样会消耗不必要的时间，因此有了缓存的过期时间，即第一次请求资源的时候带一个资源的过期时间，默认为30天，当前这种方式使用的比表较多，但是无法保证客户的时间都是准确并且一致的，因此假如一个最大生存周期，使用用户本地的时间计算缓存数据是否超过多少天，下面的过期时间为2027年，但是缓存的最大生存周期计算为天等于3650天即10年，过期时间如下：</li>
</ul>
</li>
</ul>
<p><img src="/2018/12/26/redis缓存/过期时间.png" alt=""></p>
<ul>
<li><p>CDN缓存：</p>
<ul>
<li>什么是CND：<ul>
<li>内容分发网络（Content Delivery Network），通过将服务内容分发至全网加速节点，利用全球调度系统使用户能够就近获取，有效降低访问延迟，提升服务可用性，CDN 第一降低机房的使用带宽，因为很多资源通过CDN就直接返回用户了，第二解决不同运营商之间的互联，因为可以让联通的网络访问联通让电信的网络访问电信，起到加速用户访问的目的， 第三：解决用户访问的地域问题，就近返回用户资源。    </li>
<li>百度CDN：<a href="https://cloud.baidu.com/product/cdn.html" target="_blank" rel="noopener">https://cloud.baidu.com/product/cdn.html</a> </li>
<li>阿里CDN：<a href="https://www.aliyun.com/product/cdn?spm=5176.8269123.416540.50.728y8n" target="_blank" rel="noopener">https://www.aliyun.com/product/cdn?spm=5176.8269123.416540.50.728y8n</a> </li>
<li>腾讯CDN：<a href="https://www.qcloud.com/product/cdn" target="_blank" rel="noopener">https://www.qcloud.com/product/cdn</a> </li>
</ul>
</li>
</ul>
</li>
<li><p>用户请求CDN流程：</p>
<ul>
<li>提前对静态内容进行预缓存，避免大量的请求回源，导致主站网络带宽被打满而导致数据无法更新，另外CDN可以将数据根据访问的热度不同而进行不同级别的缓存，例如访问量最高的资源访问CDN 边缘节点的内存，其次的放在SSD或者SATA，再其次的放在云存储，这样兼顾了速度与成本。</li>
</ul>
</li>
</ul>
<p><img src="/2018/12/26/redis缓存/用户请求CDN流程.png" alt=""></p>
<ul>
<li><p>CDN主要优势：</p>
<ul>
<li>提前对静态内容进行预缓存，避免大量的请求回源，导致主站网络带宽被打满而导致数据无法更新，另外CDN可以将数据根据访问的热度不通而进行不通级别的缓存，例如访问量最高的资源访问CDN 边缘节点的内存，其次的放在SSD或者SATA，再其次的放在云存储，这样兼顾了速度与成本。缓存-缓存到最快的地方如内存，缓存的数据准确命中率高，访问速度就快</li>
<li>调度准确-将用户调度到最近的边缘节点</li>
<li>性能优化-CDN 专门用于缓存响应速度快</li>
<li>安全相关-抵御攻击</li>
<li>节省带宽：由于用户请求由边缘节点响应，因此大幅降低到源站带宽。</li>
</ul>
</li>
<li><p>应用层缓存：</p>
<ul>
<li>Nginx、PHP等web服务可以设置应用缓存以加速响应用户请求，另外有些解释性语言比如PHP/Python不能直接运行，需要先编译成字节码，但字节码需要解释器解释为机器码之后才能执行，因此字节码也是一种缓存，有时候会出现程序代码上线后字节码没有更新的现象。</li>
</ul>
</li>
<li><p>其他层面缓存：</p>
<ul>
<li>CPU缓存(L1的数据缓存和L1的指令缓存)、二级缓存、三级缓存</li>
<li>磁盘缓存</li>
<li>RAID卡</li>
<li>分布式缓存：redis、memcache</li>
<li># MegaCli64 -LDinfo -Lall -aAll</li>
</ul>
</li>
</ul>
<h2 id="二：-redis部署与使用："><a href="#二：-redis部署与使用：" class="headerlink" title="二： redis部署与使用："></a>二： redis部署与使用：</h2><ul>
<li><p>redis基础：</p>
<ul>
<li>官网地址：<a href="https://redis.io/" target="_blank" rel="noopener">https://redis.io/</a> </li>
<li>Redis和Memcached是非关系型数据库也成为NoSQL，MySQL、Mariadb、SQL Server、PostgreSQL、Oracle 数据库属于关系型数据(RDBMS, Relational Database Management System)</li>
</ul>
</li>
<li><p>redis简介：</p>
<ul>
<li>Redis(Remote Dictionary Server)在2009年发布，开发者Salvatore Sanfilippo是意大利开发者，他本想为自己的公司开发一个用于替换MySQL的产品Redis，但是没有想到他把Redis开源后大受欢迎，短短几年，Redis就有了很大的用户群体，目前国内外使用的公司有知乎网、新浪微博、GitHub等</li>
<li>redis是一个开源的、遵循BSD协议的、基于内存的而且目前比较流行的键值数据库(key-value database)，是一个非关系型数据库，redis提供将内存通过网络远程共享的一种服务，提供类似功能的还有memcache，但相比memcache，redis还提供了易扩展、高性能、具备数据持久性等功能。<br>Redis在高并发、低延迟环境要求比较高的环境使用量非常广泛，目前redis在DB-Engine月排行榜<a href="https://db-engines.com/en/ranking" target="_blank" rel="noopener">https://db-engines.com/en/ranking</a> 中一直比较靠前，而且一直是键值型存储类的首位。</li>
</ul>
</li>
</ul>
<p><img src="/2018/12/26/redis缓存/redis简介.png" alt=""></p>
<ul>
<li><p>redis对比memcached：</p>
<ul>
<li>支持数据的持久化：可以将内存中的数据保持在磁盘中，重启redis服务或者服务器之后可以从备份文件中恢复数据到内存继续使用。</li>
<li>支持更多的数据类型：支持string(字符串)、hash(哈希数据)、list(列表)、set(集合)、zet(有序集合)</li>
<li>支持数据的备份：可以实现类似于数据的master-slave模式的数据备份，另外也支持使用快照+AOF。</li>
<li>支持更大的value数据：memcache单个key value最大，支持1MB，而redis最大支持512MB。</li>
<li>Redis 是单线程，而memcache是多线程，所以单机情况下没有memcache并发高，但redis 支持分布式集群以实现更高的并发，单Redis实例可以实现数万并发。</li>
<li>支持集群横向扩展：基于redis cluster的横向扩展，可以实现分布式集群，大幅提升性能和数据安全性。</li>
<li>都是基于C语言开发。</li>
</ul>
</li>
<li><p>redis 典型应用场景：</p>
<ul>
<li>Session 共享：常见于web集群中的Tomcat或者PHP中多web服务器session共享</li>
<li>消息队列：ELK的日志缓存、部分业务的订阅发布系统</li>
<li>计数器：访问排行榜、商品浏览数等和次数相关的场景</li>
<li>缓存：数据查询、电商网站商品信息、新闻内容</li>
<li>微博/微信社交场合：共同好友、点赞评论等</li>
</ul>
</li>
<li><p><code>Redis安装及使用：</code></p>
<ul>
<li>官方下载地址：<a href="http://download.redis.io/releases/" target="_blank" rel="noopener">http://download.redis.io/releases/</a></li>
</ul>
</li>
<li><p><code>yum安装redis</code></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7 ~]<span class="comment"># yum list redis</span></span><br><span class="line">Loaded plugins: fastestmirror, langpacks</span><br><span class="line">Loading mirror speeds from cached hostfile</span><br><span class="line">Available Packages</span><br><span class="line">redis.x86_64                            3.2.12-2.el7    </span><br><span class="line">[root@centos7 ~]<span class="comment"># yum install redis -y</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># systemctl start redis &amp;&amp; systemctl enable redis</span></span><br><span class="line">[root@centos7 ~]<span class="comment"># redis-cli</span></span><br><span class="line">127.0.0.1:6379&gt;</span><br></pre></td></tr></table></figure>
</li>
<li><p><code>编译安装redis</code></p>
</li>
</ul>
<p><img src="/2018/12/26/redis缓存/编译安装redis.png" alt=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line">官方的安装命令：</span><br><span class="line">  https://redis.io/download </span><br><span class="line"></span><br><span class="line">创建一个适合自己程序防止路径</span><br><span class="line">  [root@centos7 ~]<span class="comment"># mkdir -pv /usr/local/src</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># cd !$</span></span><br><span class="line">  <span class="built_in">cd</span> /usr/<span class="built_in">local</span>/src</span><br><span class="line">  [root@centos7 src]<span class="comment"># pwd</span></span><br><span class="line">  /usr/<span class="built_in">local</span>/src</span><br><span class="line">  [root@centos7 src]<span class="comment"># ls</span></span><br><span class="line">  redis-5.0.3.tar.gz</span><br><span class="line"></span><br><span class="line">解压</span><br><span class="line">  [root@centos7 src]<span class="comment"># tar xvf redis-5.0.3.tar.gz </span></span><br><span class="line">  </span><br><span class="line">安装开发包组</span><br><span class="line">  [root@centos7 redis-5.0.3]<span class="comment"># yum groupinstall "Development Tools"</span></span><br><span class="line"></span><br><span class="line">编译安装（大小写敏感）</span><br><span class="line">  [root@centos7 redis-5.0.3]<span class="comment"># make PREFIX=/usr/local/redis install</span></span><br><span class="line"></span><br><span class="line">  [root@centos7 redis]<span class="comment"># cd /usr/local/redis/bin/</span></span><br><span class="line">  [root@centos7 bin]<span class="comment"># ls</span></span><br><span class="line">  redis-benchmark  redis-check-rdb  redis-sentinel</span><br><span class="line">  redis-check-aof  redis-cli        redis-server</span><br><span class="line"></span><br><span class="line">创建主配置文件以及程序文件</span><br><span class="line">  [root@centos7 ~]<span class="comment"># cd /usr/local/redis/</span></span><br><span class="line">  [root@centos7 redis]<span class="comment"># ls</span></span><br><span class="line">  bin</span><br><span class="line">  [root@centos7 redis]<span class="comment"># mkdir etc logs run data</span></span><br><span class="line">  root@centos7 redis]<span class="comment"># cp /usr/local/src/redis-5.0.3/redis.conf /usr/local/redis/etc/</span></span><br><span class="line">  [root@centos7 redis]<span class="comment"># ln -sv /usr/local/redis/bin/* /usr/bin/</span></span><br><span class="line"></span><br><span class="line">初次启动解决当前警报启动</span><br><span class="line">  [root@centos7 redis]<span class="comment"># redis-server /usr/local/redis/etc/redis.conf </span></span><br><span class="line">  34186:C 26 Dec 2018 22:10:01.659 <span class="comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line">  34186:C 26 Dec 2018 22:10:01.659 <span class="comment"># Redis version=5.0.3, bits=64, commit=00000000, modified=0, pid=34186, just started</span></span><br><span class="line">  34186:C 26 Dec 2018 22:10:01.659 <span class="comment"># Configuration loaded</span></span><br><span class="line">  34186:M 26 Dec 2018 22:10:01.660 * Increased maximum number of open files to 10032 (it was originally <span class="built_in">set</span> to 1024).</span><br><span class="line">                  _._                                                  </span><br><span class="line">             _.-``__ <span class="string">''</span>-._                                             </span><br><span class="line">        _.-``    `.  `_.  <span class="string">''</span>-._           Redis 5.0.3 (00000000/0) 64 bit</span><br><span class="line">    .-`` .-```.  ```\/    _.,_ <span class="string">''</span>-._                                   </span><br><span class="line">   (    <span class="string">'      ,       .-`  | `,    )     Running in standalone mode</span></span><br><span class="line"><span class="string">   |`-._`-...-` __...-.``-._|'</span>` _.-<span class="string">'|     Port: 6379</span></span><br><span class="line"><span class="string">   |    `-._   `._    /     _.-'</span>    |     PID: 34186</span><br><span class="line">    `-._    `-._  `-./  _.-<span class="string">'    _.-'</span>                                   </span><br><span class="line">   |`-._`-._    `-.__.-<span class="string">'    _.-'</span>_.-<span class="string">'|                                  </span></span><br><span class="line"><span class="string">   |    `-._`-._        _.-'</span>_.-<span class="string">'    |           http://redis.io        </span></span><br><span class="line"><span class="string">    `-._    `-._`-.__.-'</span>_.-<span class="string">'    _.-'</span>                                   </span><br><span class="line">   |`-._`-._    `-.__.-<span class="string">'    _.-'</span>_.-<span class="string">'|                                  </span></span><br><span class="line"><span class="string">   |    `-._`-._        _.-'</span>_.-<span class="string">'    |                                  </span></span><br><span class="line"><span class="string">    `-._    `-._`-.__.-'</span>_.-<span class="string">'    _.-'</span>                                   </span><br><span class="line">       `-._    `-.__.-<span class="string">'    _.-'</span>                                       </span><br><span class="line">           `-._        _.-<span class="string">'                                           </span></span><br><span class="line"><span class="string">               `-.__.-'</span>                                               </span><br><span class="line">  34186:M 26 Dec 2018 22:10:01.662 <span class="comment"># WARNING: The TCP backlog setting of 511 cannot be enforced because /proc/sys/net/core/somaxconn is set to the lower value of 128.</span></span><br><span class="line">  34186:M 26 Dec 2018 22:10:01.662 <span class="comment"># Server initialized</span></span><br><span class="line">  34186:M 26 Dec 2018 22:10:01.662 <span class="comment"># WARNING overcommit_memory is set to 0! Background save may fail under low memory condition. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.</span></span><br><span class="line">  34186:M 26 Dec 2018 22:10:01.662 <span class="comment"># WARNING you have Transparent Huge Pages (THP) support enabled in your kernel. This will create latency and memory usage issues with Redis. To fix this issue run the command 'echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled' as root, and add it to your /etc/rc.local in order to retain the setting after a reboot. Redis must be restarted after THP is disabled.</span></span><br><span class="line">  34186:M 26 Dec 2018 22:10:01.662 * Ready to accept connections</span><br><span class="line"></span><br><span class="line">解决第一次启动出现的三个报警</span><br><span class="line">  [root@centos7 ~]<span class="comment"># vim /etc/sysctl.conf </span></span><br><span class="line">  net.core.somaxconn = 512</span><br><span class="line">  vm.overcommit_memory = 1</span><br><span class="line">  [root@centos7 ~]<span class="comment"># sysctl -p</span></span><br><span class="line">  net.core.somaxconn = 512</span><br><span class="line">  vm.overcommit_memory = 1</span><br><span class="line">  [root@centos7 ~]<span class="comment"># echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span></span><br><span class="line">  永久生效写进配置文件间，开机自动加载</span><br><span class="line">  vim /etc/rc.d/rc.local </span><br><span class="line">  <span class="built_in">echo</span> never &gt; /sys/kernel/mm/transparent_hugepage/enabled</span><br><span class="line">  chmod a+x /etc/rc.d/rc.local</span><br><span class="line"></span><br><span class="line">再次启动则无报警</span><br><span class="line">  [root@centos7 ~]<span class="comment"># /usr/local/redis/bin/redis-server  /usr/local/redis/etc/redis.conf </span></span><br><span class="line">  35112:C 27 Dec 2018 10:17:12.662 <span class="comment"># oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo</span></span><br><span class="line">  35112:C 27 Dec 2018 10:17:12.662 <span class="comment"># Redis version=5.0.3, bits=64, commit=00000000, modified=0, pid=35112, just started</span></span><br><span class="line">  35112:C 27 Dec 2018 10:17:12.662 <span class="comment"># Configuration loaded</span></span><br><span class="line">  35112:M 27 Dec 2018 10:17:12.663 * Increased maximum number of open files to 10032 (it was originally <span class="built_in">set</span> to 1024).</span><br><span class="line">                  _._                                                  </span><br><span class="line">             _.-``__ <span class="string">''</span>-._                                             </span><br><span class="line">        _.-``    `.  `_.  <span class="string">''</span>-._           Redis 5.0.3 (00000000/0) 64 bit</span><br><span class="line">    .-`` .-```.  ```\/    _.,_ <span class="string">''</span>-._                                   </span><br><span class="line">   (    <span class="string">'      ,       .-`  | `,    )     Running in standalone mode</span></span><br><span class="line"><span class="string">   |`-._`-...-` __...-.``-._|'</span>` _.-<span class="string">'|     Port: 6379</span></span><br><span class="line"><span class="string">   |    `-._   `._    /     _.-'</span>    |     PID: 35112</span><br><span class="line">    `-._    `-._  `-./  _.-<span class="string">'    _.-'</span>                                   </span><br><span class="line">   |`-._`-._    `-.__.-<span class="string">'    _.-'</span>_.-<span class="string">'|                                  </span></span><br><span class="line"><span class="string">   |    `-._`-._        _.-'</span>_.-<span class="string">'    |           http://redis.io        </span></span><br><span class="line"><span class="string">    `-._    `-._`-.__.-'</span>_.-<span class="string">'    _.-'</span>                                   </span><br><span class="line">   |`-._`-._    `-.__.-<span class="string">'    _.-'</span>_.-<span class="string">'|                                  </span></span><br><span class="line"><span class="string">   |    `-._`-._        _.-'</span>_.-<span class="string">'    |                                  </span></span><br><span class="line"><span class="string">    `-._    `-._`-.__.-'</span>_.-<span class="string">'    _.-'</span>                                   </span><br><span class="line">       `-._    `-.__.-<span class="string">'    _.-'</span>                                       </span><br><span class="line">            `-._        _.-<span class="string">'                                           </span></span><br><span class="line"><span class="string">                `-.__.-'</span>                                               </span><br><span class="line">  35112:M 27 Dec 2018 10:17:12.667 <span class="comment"># Server initialized</span></span><br><span class="line">  35112:M 27 Dec 2018 10:17:12.667 * Ready to accept connections</span><br></pre></td></tr></table></figure></p>
<ul>
<li><p><code>解决当前的警告提示：</code></p>
<ul>
<li><p>警报：tcp-backlog：</p>
<ul>
<li>backlog参数控制的是三次握手的时候server端收到client ack确认号之后的队列值。</li>
<li>net.core.somaxconn = 512</li>
</ul>
</li>
<li><p>警报：vm.overcommit_memory：</p>
<ul>
<li>0、表示内核将检查是否有足够的可用内存供应用进程使用；如果有足够的可用内存，内存申请允许；否则，内存申请失败，并把错误返回给应用进程。</li>
<li>1、表示内核允许分配所有的物理内存，而不管当前的内存状态如何。</li>
<li>2、表示内核允许分配超过所有物理内存和交换空间总和的内存</li>
<li>vm.overcommit_memory = 1</li>
</ul>
</li>
<li>警报：transparent hugepage：<ul>
<li>开启大页内存动态分配，需要关闭让redis 负责内存管理。<ul>
<li>临时生效</li>
</ul>
</li>
<li>echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled<ul>
<li>永久生效写进配置文件间，开机自动加载</li>
</ul>
</li>
<li>vim /etc/rc.d/rc.local <ul>
<li>echo never &gt; /sys/kernel/mm/transparent_hugepage/enabled</li>
</ul>
</li>
<li>chmod a+x /etc/rc.d/rc.local<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br></pre></td><td class="code"><pre><span class="line">redis启动默认使再前台工作，编写启动脚本将服务的启动送往后台执行</span><br><span class="line"></span><br><span class="line">服务启动对应的端口已经默认监听的端口</span><br><span class="line">  [root@centos7 ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  LISTEN      0      511    127.0.0.1:6379    </span><br><span class="line"></span><br><span class="line">编辑redis服务启动脚本</span><br><span class="line">  服务的配置文件放在了/usr/<span class="built_in">local</span>/redis/bin/redis-servier</span><br><span class="line">  服务的主配置文件放在了/usr/<span class="built_in">local</span>/redis/etc/redis.conf</span><br><span class="line"></span><br><span class="line">  [root@centos7 ~]<span class="comment"># vim /usr/lib/systemd/system/redis.service</span></span><br><span class="line">  [Unit]</span><br><span class="line">  Description=Redis persistent key-value database</span><br><span class="line">  After=network.target</span><br><span class="line">  After=network-online.target</span><br><span class="line">  Wants=network-online.target</span><br><span class="line"></span><br><span class="line">  [Service]</span><br><span class="line">  ExecStart=/usr/<span class="built_in">local</span>/redis/bin/redis-server /usr/<span class="built_in">local</span>/redis/etc/redis.conf  --supervised systemd</span><br><span class="line">  ExecReload=/bin/<span class="built_in">kill</span> -s HUP <span class="variable">$MAINPID</span></span><br><span class="line">  ExecStop=/bin/<span class="built_in">kill</span> -s QUIT <span class="variable">$MAINPID</span></span><br><span class="line">  Type=notify</span><br><span class="line">  User=redis</span><br><span class="line">  Group=redis</span><br><span class="line">  RuntimeDirectory=redis</span><br><span class="line">  RuntimeDirectoryMode=0755</span><br><span class="line"></span><br><span class="line">  [Install]</span><br><span class="line">  WantedBy=multi-user.target</span><br><span class="line">编辑主配置文件</span><br><span class="line">  vim /usr/<span class="built_in">local</span>/redis/etc/redis.conf </span><br><span class="line">  daemonize yes <span class="comment">#让redis作为守护进程运行</span></span><br><span class="line"></span><br><span class="line">创建redis 用户和数据目录：</span><br><span class="line">  [root@centos7 ~]<span class="comment"># useradd redis -s /sbin/nologin </span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># chown -R redis.redis /usr/local/redis/</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># systemctl daemon-reload</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># systemctl start redis.service </span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># ss -tnl</span></span><br><span class="line">  LISTEN      0      511    127.0.0.1:6379  </span><br><span class="line"></span><br><span class="line">创建命令软连接</span><br><span class="line">  [root@centos7 ~]<span class="comment"># ln -sv /usr/local/redis/bin/* /usr/bin/</span></span><br><span class="line"></span><br><span class="line">修改服务器的监听端口，默认监听在本机的127.0.0.1</span><br><span class="line">  [root@centos7 ~]<span class="comment"># vim /usr/local/redis/etc/redis.conf </span></span><br><span class="line">  <span class="built_in">bind</span> 127.0.0.1 172.18.135.1   (<span class="built_in">bind</span> 地址绑定到本机哪个地址供谁可以访问0.0.0.0代表本机监听在本机的所有的地址)</span><br><span class="line"></span><br><span class="line">使用客户端连接本机的redis服务器</span><br><span class="line">  [root@centos7 ~]<span class="comment"># redis-cli -h 172.18.135.1 -p 6379</span></span><br><span class="line">  172.18.135.1:6379&gt; info</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
</li>
<li><p><code>编译安装后的命令：</code></p>
<ul>
<li>[root@redis-s1 ~]# ll /usr/local/redis/bin/<br>total 32656</li>
<li>-rwxr-xr-x 1 redis redis 4365488 Dec 13 09:21 redis-benchmark #redis性能测试工具</li>
<li>-rwxr-xr-x 1 redis redis 8088920 Dec 13 09:21 redis-check-aof #AOF文件检查工具</li>
<li>-rwxr-xr-x 1 redis redis 8088920 Dec 13 09:21 redis-check-rdb #RDB文件检查工具</li>
<li>-rwxr-xr-x 1 redis redis 4800752 Dec 13 09:21 redis-cli #redis #客户端工具</li>
<li>lrwxrwxrwx 1 redis redis   12 Dec 13 09:21 redis-sentinel -&gt; redis-server #哨兵，软连接到</li>
</ul>
</li>
<li><p><code>使用客户端连接redis：</code></p>
<ul>
<li>#/usr/local/redis/bin/redis-cli  -h  IP/HOSTNAME -p PORT -a PASSWORD</li>
</ul>
</li>
<li><p><code>redis配置文件：</code></p>
</li>
<li><p>redis主要配置项：</p>
<ul>
<li>bind 0.0.0.0  #监听地址，可以用空格隔开后多个监听IP</li>
<li>protected-mode yes  #redis3.2 之后加入的新特性，在没有设置bind IP和密码的时候只允许访问127.0.0.1:6379</li>
<li>port 6379 #监听端口</li>
<li>tcp-backlog 511  #三次握手的时候server端收到client ack确认号之后的队列值。</li>
<li>timeout 0 #客户端和Redis服务端的连接超时时间，默认是0，表示永不超时。 </li>
<li>tcp-keepalive 300  #tcp 会话保持时间</li>
<li>daemonize no  #认情况下 redis 不是作为守护进程运行的，如果你想让它在后台运行，你就把它改成 yes,当redis作为守护进程运行的时候，它会写一个 pid 到 /var/run/redis.pid 文件里面</li>
<li>supervised no  #和操作系统相关参数，可以设置通过upstart和systemd管理Redis守护进程，centos 7以后都使用systemd</li>
<li>pidfile /var/run/redis_6379.pid  #pid文件路径,确定生成的日志目录是有权限的，实际上存放的就是进程号。</li>
<li>loglevel notice #日志级别</li>
<li>logfile “” #日志路径</li>
<li>databases 16  #设置db 库数量，默认16个库，可以连接到redis后使用select # ,切换库</li>
<li>always-show-logo yes #在启动redis 时是否显示log</li>
<li>save 900 1   #在900秒内有一个键内容发生更改就出就快照机制</li>
<li>save 300 10</li>
<li>save 60 10000</li>
<li>stop-writes-on-bgsave-error yes  #快照出错时是否禁止redis 写入操作（默认为yes，建议使用no，出错的原因，磁盘满了，权限问题，改为no的原因是系统是由监控的，所以不会等磁盘满了防止数据丢失）</li>
<li>rdbcompression yes     #持久化到RDB文件时，是否压缩，”yes”为压缩，”no”则反之</li>
<li>rdbchecksum yes      #是否开启RC64校验，默认是开启（检查RDB文件是否完整）</li>
<li>dbfilename dump.rdb #快照文件名</li>
<li>dir ./                  #快照文件保存路径</li>
<li>replica-serve-stale-data yes #当从库同主库失去连接或者复制正在进行，从机库有两种运行方式：1) 如果replica-serve-stale-data设置为yes(默认设置)，从库会继续响应客户端的请求。2) 如果replica-serve-stale-data设置为no，除去指定的命令之外的任何请求都会返回一个错误”SYNC with master in progress”。</li>
<li>replica-read-only yes #是否设置从库只读</li>
<li><p>repl-diskless-sync no #是否使用socket方式复制数据，目前redis复制提供两种方式，disk和socket，如果新的slave连上来或者重连的slave无法部分同步，就会执行全量同步，master会生成rdb文件，有2种方式：disk方式是master创建一个新的进程把rdb文件保存到磁盘，再把磁盘上的rdb文件传递给slave，socket是master创建一个新的进程，直接把rdb文件以socket的方式发给slave，disk方式的时候，当一个rdb保存的过程中，多个slave都能共享这个rdb文件，socket的方式就是一个个slave顺序复制，只有在磁盘速度缓慢但是网络相对较快的情况下才使用socket方式，否则使用默认的disk方式</p>
</li>
<li><p>repl-diskless-sync-delay 5  #diskless复制的延迟时间，设置0为关闭，一旦复制开始还没有结束之前，master节点不会再接收新slave的复制请求，直到下一次开始</p>
</li>
<li>repl-ping-slave-period 10 #slave根据master指定的时间进行周期性的PING 监测</li>
<li>repl-timeout 60 #复制链接超时时间，需要大于repl-ping-slave-period，否则会经常报超时</li>
<li>repl-disable-tcp-nodelay no #在socket模式下是否slave套接字发送SYNC之后禁用 TCP_NODELAY，<br>如果你选择“yes”Redis将使用更少的TCP包和带宽来向slaves发送数据。但是这将使数据传输到slave上有延迟，Linux内核的默认配置会达到40毫秒，如果你选择了 “no” 数据传输到salve的延迟将会减少但要使用更多的带宽</li>
<li>repl-backlog-size 1mb #复制缓冲区大小，只有在slave连接之后才分配内存。 </li>
<li>repl-backlog-ttl 3600 #多次时间master没有slave连接，就清空backlog缓冲区。</li>
<li>replica-priority 100 #当master不可用，Sentinel会根据slave的优先级选举一个master。最低的优先级的slave，当选master。而配置成0，永远不会被选举。</li>
<li>requirepass foobared #设置redis 连接密码</li>
<li>rename-command #重命名一些高危命令</li>
<li>maxclients 10000 #最大连接客户端（根据生产进行调整）</li>
<li>maxmemory #最大内存，单位为bytes字节，8G内存的计算方式8(G)<em>1024(MB)</em>1024(KB)*1024(Kbyte)，需要注意的是slave的输出缓冲区是不计算在maxmemory内。（如果不限制，则redis无限使用物理内存，最后将服务器的进程kill掉，最好给予系统内存的一半，生产使用redis建议服务器16G给redis服务器8G）</li>
</ul>
</li>
</ul>
<ul>
<li>appendonly no #是否开启AOF日志记录，默认redis使用的是rdb方式持久化，这种方式在许多应用中已经足够用了。但是redis如果中途宕机，会导致可能有几分钟的数据丢失，根据save来策略进行持久化，Append Only File是另一种持久化方式，可以提供更好的持久化特性。Redis会把每次写入的数据在接收后都写入 appendonly.aof 文件，每次启动时Redis都会先把这个文件的数据读入内存里，先忽略RDB文件。</li>
<li>appendfilename “appendonly.aof” #AOF文件名</li>
<li>appendfsync everysec  #aof持久化策略的配置,no表示不执行fsync,由操作系统保证数据同步到磁盘,always表示每次写入都执行fsync，以保证数据同步到磁盘,everysec表示每秒执行一次fsync，可能会导致丢失这1s数据。</li>
<li>no-appendfsync-on-rewrite no在aof rewrite期间,是否对aof新记录的append暂缓使用文件同步策略,主要考虑磁盘IO开支和请求阻塞时间。默认为no,表示”不暂缓”,新的aof记录仍然会被立即同步，Linux的默认fsync策略是30秒，如果为yes 可能丢失30秒数据，但由于yes性能较好而且会避免出现阻塞因此比较推荐。</li>
<li>auto-aof-rewrite-percentage 100 # 当Aof log增长超过指定比例时，重写log file， 设置为0表示不自动重写Aof 日志，重写是为了使aof体积保持最小，而确保保存最完整的数据。</li>
<li>auto-aof-rewrite-min-size 64mb #触发aof rewrite的最小文件尺寸</li>
<li>aof-load-truncated yes #是否加载由于其他原因导致的末尾异常的AOF文件(主进程被kill/断电等)</li>
<li>aof-use-rdb-preamble yes #redis4.0新增RDB-AOF混合持久化格式，在开启了这个功能之后，AOF重写产生的文件将同时包含RDB格式的内容和AOF格式的内容，其中RDB格式的内容用于记录已有的数据，而AOF格式的内存则用于记录最近发生了变化的数据，这样Redis就可以同时兼有RDB持久化和AOF持久化的优点（既能够快速地生成重写文件，也能够在出现问题时，快速地载入数据）。</li>
</ul>
<ul>
<li>lua-time-limit 5000 #lua脚本的最大执行时间，单位为毫秒</li>
<li>cluster-enabled yes #是否开启集群模式，默认是单机模式</li>
<li>cluster-config-file nodes-6379.conf #由node节点自动生成和的集群配置文件</li>
<li>cluster-node-timeout 15000 #集群中node节点连接超时时间</li>
<li>cluster-replica-validity-factor 10 #在执行故障转移的时候可能有些节点和master断开一段时间数据比较旧，这些节点就不适用于选举为master，超过这个时间的就不会被进行故障转移</li>
<li>cluster-migration-barrier 1  #一个主节点拥有的至少正常工作的从节点，即如果主节点的slave节点故障后会将多余的从节点分配到当前主节点成为其新的从节点。</li>
<li>cluster-require-full-coverage yes #集群槽位覆盖，如果一个主库宕机且没有备库就会出现集群槽位不全，那么yes情况下redis集群槽位验证不全就不再对外提供服务，而no则可以继续使用但是会出现查询数据查不到的情况(因为有数据丢失)。</li>
<li>cluster-replica-no-failover no#Slow log 是 Redis 用来记录查询执行时间的日志系统，slow log 保存在内存里面，读写速度非常快，因此你可以放心地使用它，不必担心因为开启 slow log 而损害 Redis 的速度。</li>
<li>slowlog-log-slower-than 10000 #以微秒为单位的慢日志记录，为负数会禁用慢日志，为0会记录每个命令操作。</li>
<li>slowlog-max-len 128 #记录多少条慢日志保存在队列，超出后会删除最早的，以此滚动删除</li>
</ul>
<h2 id="三：-redis持久化："><a href="#三：-redis持久化：" class="headerlink" title="三： redis持久化："></a>三： redis持久化：</h2><ul>
<li>redis 虽然是一个内存级别的缓存程序，即redis 是使用内存进行数据的缓存的，但是其可以将内存的数据按照一定的策略保存到硬盘上，从而实现数据持久保存的目的，redis支持两种不同方式的数据持久化保存机制，分别是RDB和AOF</li>
<li><p><code>RDB模式：</code></p>
<ul>
<li>RDB：基于时间的快照，只保留当前最新的一次快照，特点是执行速度比较快，缺点是可能会丢失从上次快照到当前快照未完成之间的数据。</li>
<li><p>RDB实现的具体过程Redis从主进程先fork出一个子进程，使用写时复制机制，子进程将内存的数据保存为一个临时文件，比如dump.rdb.temp，当数据保存完成之后再将上一次保存的RDB文件替换掉，然后关闭子进程，这样可以保存每一次做RDB快照的时候保存的数据都是完整的，因为直接替换RDB文件的时候可能会出现突然断电等问题而导致RDB文件还没有保存完整就突然关机停止保存而导致数据丢失的情况，可以手动将每次生成的RDB文件进程备份，这样可以最大化保存历史数据。</p>
</li>
<li><p>RDB模式的优缺点：</p>
</li>
<li>优点：<ul>
<li>RDB快照保存了某个时间点的数据，可以通过脚本执行bgsave(非阻塞)或者save(阻塞)命令自定义时间点北备份，可以保留多个备份，当出现问题可以恢复到不同时间点的版本。</li>
<li>可以最大化o的性能，因为父进程在保存RDB 文件的时候唯一要做的是fork出一个子进程，然后的-操作都会有这个子进程操作，父进程无需任何的IO操作</li>
<li>RDB在大量数据比如几个G的数据，恢复的速度比AOF的快</li>
</ul>
</li>
<li>缺点：<ul>
<li>不能时时的保存数据，会丢失自上一次执行RDB备份到当前的内存数据</li>
<li>数据量非常大的时候，从父进程fork的时候需要一点时间，可能是毫秒或者秒</li>
</ul>
</li>
</ul>
</li>
<li><p><code>AOF模式：</code></p>
<ul>
<li>AOF:按照操作顺序依次将操作添加到指定的日志文件当中，特点是数据安全性相对较高，缺点是即使有些操作是重复的也会全部记录。</li>
<li>AOF和RDB一样使用了写时复制机制，AOF默认为每秒钟fsync一次，即将执行的命令保存到AOF文件当中，这样即使redis服务器发生故障的话顶多也就丢失1秒钟之内的数据，也可以设置不同的fsync策略，或者设置每次执行命令的时候执行fsync，fsync会在后台执行线程，所以主线程可以继续处理用户的正常请求而不受到写入AOF文件的IO影响</li>
</ul>
<ul>
<li>AOF模式优缺点：<ul>
<li>AOF的文件大小要大于RDB格式的文件<ul>
<li>根据所使用的fsync策略(fsync是同步内存中redis所有已经修改的文件到存储设备)，默认是appendfsync everysec即每秒执行一次fsync</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="四：-redis-数据类型："><a href="#四：-redis-数据类型：" class="headerlink" title="四： redis 数据类型："></a>四： redis 数据类型：</h2><ul>
<li><p>1.字符串(string)：</p>
<ul>
<li>字符串是所有编程语言中最常见的和最常用的数据类型，而且也是redis最基本的数据类型之一，而且redis中所有的key的类型都是字符串。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br></pre></td><td class="code"><pre><span class="line">连接redis</span><br><span class="line">  [root@centos7 ~]<span class="comment"># redis-cli -h 172.18.135.1 -p 6379</span></span><br><span class="line">  172.18.135.1:6379&gt; </span><br><span class="line"></span><br><span class="line">添加一个key</span><br><span class="line">  172.18.135.1:6379&gt; <span class="built_in">set</span> key1 value1  （后面可以添加过期时间，如果不加则永不过期）</span><br><span class="line">  OK</span><br><span class="line"></span><br><span class="line">查看key对应的值</span><br><span class="line">  172.18.135.1:6379&gt; get key1</span><br><span class="line">  <span class="string">"value1"</span></span><br><span class="line"></span><br><span class="line">查看key的类型</span><br><span class="line">  172.18.135.1:6379&gt; <span class="built_in">type</span> key1</span><br><span class="line">  string（字符串）</span><br><span class="line"></span><br><span class="line">删除key的值 （DEL可以删除任何类型的key）</span><br><span class="line">  172.18.135.1:6379&gt; DEL key1</span><br><span class="line">  (<span class="built_in">integer</span>) 1       (返回值为1，则表示成功，0表示不成功)</span><br><span class="line">  172.18.135.1:6379&gt; get key1</span><br><span class="line">  (nil)</span><br><span class="line"></span><br><span class="line">批量创建多个key</span><br><span class="line">  172.18.135.1:6379&gt; mset key1 value1 key2 value2  ....</span><br><span class="line">  OK</span><br><span class="line"></span><br><span class="line">批量获取多个key的值</span><br><span class="line">  172.18.135.1:6379&gt; mget key1 key2 </span><br><span class="line">  1) <span class="string">"value1"</span></span><br><span class="line">  2) <span class="string">"value2"</span></span><br><span class="line"></span><br><span class="line">批量删除多个key</span><br><span class="line">  172.18.135.1:6379&gt; del key1 key2 </span><br><span class="line">  (<span class="built_in">integer</span>) 2</span><br><span class="line">  172.18.135.1:6379&gt; mget key1 key2 </span><br><span class="line">  1) (nil)</span><br><span class="line">  2) (nil)</span><br><span class="line"></span><br><span class="line">清空当前库的所有数据</span><br><span class="line">  172.18.135.1:6379&gt; flushdb</span><br><span class="line">  OK</span><br><span class="line"></span><br><span class="line">查看当前数据库的所有key值</span><br><span class="line">  172.18.135.1:6379&gt; keys *</span><br><span class="line">  (empty list or <span class="built_in">set</span>)</span><br><span class="line"></span><br><span class="line">清空所有数据库的key</span><br><span class="line">  172.18.135.1:6379&gt; FLUSHALL</span><br><span class="line"></span><br><span class="line">数值递增：（必须是数字且数个整数）</span><br><span class="line">  172.18.135.1:6379&gt; SET num 0</span><br><span class="line">  OK</span><br><span class="line">  172.18.135.1:6379&gt; INCR num</span><br><span class="line">  (<span class="built_in">integer</span>) 1</span><br><span class="line">  172.18.135.1:6379&gt; GET num</span><br><span class="line">  <span class="string">"1"</span></span><br><span class="line"></span><br><span class="line">数值递减</span><br><span class="line">  172.18.135.1:6379&gt; INCR num</span><br><span class="line">  (<span class="built_in">integer</span>) 2</span><br><span class="line">  172.18.135.1:6379&gt; GET num</span><br><span class="line">  <span class="string">"2"</span></span><br><span class="line">  172.18.135.1:6379&gt; DECR num</span><br><span class="line">  (<span class="built_in">integer</span>) 1</span><br><span class="line">  172.18.135.1:6379&gt; GET num</span><br><span class="line">  <span class="string">"1"</span></span><br><span class="line"></span><br><span class="line">向列表追加数据：</span><br><span class="line">  127.0.0.1:6379&gt; LPUSH list1 tom</span><br><span class="line">  (<span class="built_in">integer</span>) 2</span><br><span class="line">  127.0.0.1:6379&gt; RPUSH list1 jack</span><br><span class="line">  (<span class="built_in">integer</span>) 3</span><br><span class="line"></span><br><span class="line">获取列表长度：</span><br><span class="line">  127.0.0.1:6379&gt; LLEN list1</span><br><span class="line">  (<span class="built_in">integer</span>) 3</span><br><span class="line"></span><br><span class="line">移除列表数据：</span><br><span class="line">  127.0.0.1:6379&gt; RPOP list1 <span class="comment">#最后一个</span></span><br><span class="line">  <span class="string">"jack"</span></span><br><span class="line">  127.0.0.1:6379&gt; LPOP list1 <span class="comment">#第一个</span></span><br><span class="line">  <span class="string">"tom"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>2.集合(set)：</p>
<ul>
<li>Set 是 String 类型的无序集合。集合成员是唯一的，这就意味着集合中不能出现重复的数据。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">生成集合key:</span><br><span class="line">SADD：无序集合</span><br><span class="line">  127.0.0.1:6379&gt; SADD set1 v1 </span><br><span class="line">  (<span class="built_in">integer</span>) 1</span><br><span class="line">  127.0.0.1:6379&gt; SADD set2 v2 v4</span><br><span class="line">  (<span class="built_in">integer</span>) 2</span><br><span class="line">  127.0.0.1:6379&gt; TYPE set1</span><br><span class="line">  <span class="built_in">set</span></span><br><span class="line">  127.0.0.1:6379&gt; TYPE set2</span><br><span class="line">  <span class="built_in">set</span></span><br><span class="line"></span><br><span class="line">查看集合中的所有值</span><br><span class="line">  127.0.0.1:6379&gt; SMEMBERS set1</span><br><span class="line"></span><br><span class="line">追加数值：</span><br><span class="line">追加的时候不能追加已经存在的数值</span><br><span class="line">  127.0.0.1:6379&gt; SADD set1 v2 v3 v4</span><br><span class="line">  (<span class="built_in">integer</span>) 3</span><br><span class="line">  127.0.0.1:6379&gt; SADD set1 v2 <span class="comment">#没有追加成功</span></span><br><span class="line">  (<span class="built_in">integer</span>) 0</span><br><span class="line">  127.0.0.1:6379&gt; TYPE set1</span><br><span class="line">  <span class="built_in">set</span></span><br><span class="line">  127.0.0.1:6379&gt; TYPE set2</span><br><span class="line">  <span class="built_in">set</span></span><br><span class="line"></span><br><span class="line">查看集合的所有数据：</span><br><span class="line">同<span class="built_in">set</span>的值不可重复，不同 <span class="built_in">set</span>的值可以相同</span><br><span class="line">  127.0.0.1:6379&gt; SMEMBERS set1</span><br><span class="line">  1) <span class="string">"v4"</span></span><br><span class="line">  2) <span class="string">"v1"</span></span><br><span class="line">  3) <span class="string">"v3"</span></span><br><span class="line">  4) <span class="string">"v2"</span></span><br><span class="line">  127.0.0.1:6379&gt; SMEMBERS set2</span><br><span class="line">  1) <span class="string">"v4"</span></span><br><span class="line">  2) <span class="string">"v2"</span></span><br><span class="line"></span><br><span class="line">获取集合的差集：</span><br><span class="line">差集：已属于A而不属于B的元素称为A与B的（差集）</span><br><span class="line">  127.0.0.1:6379&gt; SDIFF set1 set2</span><br><span class="line">  1) <span class="string">"v1"</span></span><br><span class="line">  2) <span class="string">"v3"</span></span><br><span class="line"></span><br><span class="line">获取集合的交集：</span><br><span class="line">交集：已属于A且属于B的元素称为A与B的(交集）</span><br><span class="line">  127.0.0.1:6379&gt; SINTER set1 set2</span><br><span class="line">  1) <span class="string">"v4"</span></span><br><span class="line">  2) <span class="string">"v2"</span></span><br><span class="line"></span><br><span class="line">获取集合的并集：</span><br><span class="line">并集：已属于A或属于B的元素为称为A与B的(并集）</span><br><span class="line">  127.0.0.1:6379&gt; SUNION  set1 set2</span><br><span class="line">  1) <span class="string">"v2"</span></span><br><span class="line">  2) <span class="string">"v4"</span></span><br><span class="line">  3) <span class="string">"v1"</span></span><br><span class="line">  4) <span class="string">"v3"</span></span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>3.sorted set(有序集合):</p>
<ul>
<li>Redis 有序集合和集合一样也是string类型元素的集合,且不允许重复的成员，不同的是每个元素都会关联一个double(双精度浮点型)类型的分数，redis正是通过分数来为集合中的成员进行从小到大的排序，序集合的成员是唯一的,但分数(score)却可以重复，集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是O(1)， 集合中最大的成员数为 232 - 1 (4294967295, 每个集合可存储40多亿个成员)。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line">生成有序集合：</span><br><span class="line">  127.0.0.1:6379&gt; ZADD zset1 1 v1 </span><br><span class="line">  (<span class="built_in">integer</span>) 1</span><br><span class="line">  127.0.0.1:6379&gt; ZADD zset1 2 v2</span><br><span class="line">  (<span class="built_in">integer</span>) 1</span><br><span class="line">  127.0.0.1:6379&gt; ZADD zset1 2 v3</span><br><span class="line">  (<span class="built_in">integer</span>) 1</span><br><span class="line">  127.0.0.1:6379&gt; ZADD zset1 3 v4</span><br><span class="line">  (<span class="built_in">integer</span>) 1</span><br><span class="line">  127.0.0.1:6379&gt; TYPE zset1</span><br><span class="line">  zset</span><br><span class="line">  127.0.0.1:6379&gt; TYPE zset2</span><br><span class="line">  zset</span><br><span class="line"></span><br><span class="line">排行案例：</span><br><span class="line">  192.168.7.104:6379&gt; ZADD paihangbang 10 key1 20 key2 30 key3</span><br><span class="line">  (<span class="built_in">integer</span>) 3</span><br><span class="line">  192.168.7.104:6379&gt; ZREVRANGE paihangbang 0 -1 withscores</span><br><span class="line">  1) <span class="string">"key3"</span></span><br><span class="line">  2) <span class="string">"30"</span></span><br><span class="line">  3) <span class="string">"key2"</span></span><br><span class="line">  4) <span class="string">"20"</span></span><br><span class="line">  5) <span class="string">"key1"</span></span><br><span class="line">  6) <span class="string">"10"</span></span><br><span class="line"></span><br><span class="line">批量添加多个数值：</span><br><span class="line">  127.0.0.1:6379&gt; ZADD zset2 1 v1 2 v2 4 v3 5 v5</span><br><span class="line">  (<span class="built_in">integer</span>) 4</span><br><span class="line"></span><br><span class="line">获取集合的长度数：</span><br><span class="line">  127.0.0.1:6379&gt; ZCARD zset1 </span><br><span class="line">  (<span class="built_in">integer</span>) 4</span><br><span class="line">  127.0.0.1:6379&gt; ZCARD zset2</span><br><span class="line">  (<span class="built_in">integer</span>) 4</span><br><span class="line"></span><br><span class="line">基于索引返回数值：</span><br><span class="line">  127.0.0.1:6379&gt; ZRANGE zset1 1 3</span><br><span class="line">  1) <span class="string">"v2"</span></span><br><span class="line">  2) <span class="string">"v3"</span></span><br><span class="line">  3) <span class="string">"v4"</span></span><br><span class="line">  127.0.0.1:6379&gt; ZRANGE zset1 0 2</span><br><span class="line">  1) <span class="string">"v1"</span></span><br><span class="line">  2) <span class="string">"v2"</span></span><br><span class="line">  3) <span class="string">"v3"</span></span><br><span class="line"></span><br><span class="line">返回某个数值的索引：</span><br><span class="line">  127.0.0.1:6379&gt; ZRANK zset1 v2</span><br><span class="line">  (<span class="built_in">integer</span>) 1</span><br><span class="line">  127.0.0.1:6379&gt; ZRANK zset1 v3</span><br><span class="line">  (<span class="built_in">integer</span>) 2</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
<li><p>4.哈希(hash)：</p>
<ul>
<li>hash 是一个string类型的field和value的映射表，hash特别适合用于存储对象,Redis 中每个 hash 可以存储 232 - 1 键值对（40多亿）。<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">生成<span class="built_in">hash</span> key：</span><br><span class="line">  127.0.0.1:6379&gt; HSET hset1 name tom  age 18</span><br><span class="line">  (<span class="built_in">integer</span>) 1</span><br><span class="line">  127.0.0.1:6379&gt; TYPE hset1</span><br><span class="line">  <span class="built_in">hash</span></span><br><span class="line"></span><br><span class="line">获取<span class="built_in">hash</span> key字段值：</span><br><span class="line">  127.0.0.1:6379&gt; HGET hset1 name</span><br><span class="line">  <span class="string">"tom"</span></span><br><span class="line">  127.0.0.1:6379&gt; HGET hset1  age</span><br><span class="line">  <span class="string">"18"</span></span><br><span class="line"></span><br><span class="line">删除一个<span class="built_in">hash</span> key的字段：</span><br><span class="line">  127.0.0.1:6379&gt; HDEL hset1 age</span><br><span class="line">  (<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line">获取所有<span class="built_in">hash</span>表中的字段：</span><br><span class="line">  127.0.0.1:6379&gt; HSET hset1 name tom age 19</span><br><span class="line">  (<span class="built_in">integer</span>) 1</span><br><span class="line">  127.0.0.1:6379&gt; HKEYS hset1</span><br><span class="line">  1) <span class="string">"name"</span></span><br><span class="line">  2) <span class="string">"age"</span></span><br><span class="line"></span><br><span class="line">设定key的过期时间</span><br><span class="line">  127.0.0.1:6379&gt;  <span class="built_in">set</span> test1 value1 ex 5   <span class="comment">#设定这个key的过期时间，43200半天时间，g根据用户需求设定</span></span><br><span class="line"></span><br><span class="line">查看key的过期时长</span><br><span class="line">  127.0.0.1:6379&gt; TTL key1</span><br></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<h2 id="五：-消息队列："><a href="#五：-消息队列：" class="headerlink" title="五： 消息队列："></a>五： 消息队列：</h2><p>消息队列主要分为两种，分别是生产者消费者模式和发布者订阅者模式，这两种模式Redis都支持</p>
<h3 id="生产者消费者模式："><a href="#生产者消费者模式：" class="headerlink" title="生产者消费者模式："></a>生产者消费者模式：</h3><ul>
<li>1.在生产者消费者(Producer/Consumer)模式下，上层应用接收到的外部请求后开始处理其当前步骤的操作，在执行完成后将已经完成的操作发送至指定的频道(channel)当中，并由其下层的应用监听该频道并继续下一步的操作，如果其处理完成后没有下一步的操作就直接返回数据给外部请求，如果还有下一步的操作就再将任务发布到另外一个频道，由另外一个消费者继续监听和处理。</li>
<li>2.模式介绍：<ul>
<li>生产者消费者模式下，多个消费者同时监听一个队里，但是一个消息只能被最先抢到消息的消费者消费，即消息任务是一次性读取和处理，此模式在分布式业务架构中非常常用，比较常用的软件还有 RabbitMQ、Kafka、RocketMQ、ActiveMQ等</li>
</ul>
</li>
</ul>
<p><img src="/2018/12/26/redis缓存/生产者消费者模式.png" alt=""></p>
<ul>
<li>3.队列介绍：<ul>
<li>队列当中的 消息由不同的生产者写入也会有不同的消费者取出进行消费处理，但是买一个消息一定是只能被取出一次也就是被消费一次。</li>
</ul>
</li>
</ul>
<p><img src="/2018/12/26/redis缓存/队列介绍.png" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">生产者发布消息：</span><br><span class="line">  [root@redis-s4 ~]<span class="comment"># redis-cli</span></span><br><span class="line">  127.0.0.1:6379&gt; AUTH 123456</span><br><span class="line">  OK</span><br><span class="line">  127.0.0.1:6379&gt; LPUSH channel1 msg1 <span class="comment">#从管道的左侧写入</span></span><br><span class="line">  (<span class="built_in">integer</span>) 1</span><br><span class="line">  127.0.0.1:6379&gt; LPUSH channel1 msg2</span><br><span class="line">  (<span class="built_in">integer</span>) 2</span><br><span class="line">  127.0.0.1:6379&gt; LPUSH channel1 msg3</span><br><span class="line">  (<span class="built_in">integer</span>) 3</span><br><span class="line">  127.0.0.1:6379&gt; LPUSH channel1 msg4</span><br><span class="line">  (<span class="built_in">integer</span>) 4</span><br><span class="line">  127.0.0.1:6379&gt; LPUSH channel1 msg5</span><br><span class="line">  (<span class="built_in">integer</span>) 5</span><br><span class="line"></span><br><span class="line">切换终端模拟消费者，查看队列所有消息：<span class="comment">#（0，-1代表查看所有的消息）</span></span><br><span class="line">  127.0.0.1:6379&gt; LRANGE channel1  0  -1  <span class="comment">#切换其他客户端查看则已经看不到此条消息队列，因为已经被当前客户端取走</span></span><br><span class="line">  1) <span class="string">"msg5"</span></span><br><span class="line">  2) <span class="string">"msg4"</span></span><br><span class="line">  3) <span class="string">"msg3"</span></span><br><span class="line">  4) <span class="string">"msg2"</span></span><br><span class="line">  5) <span class="string">"msg1"</span></span><br><span class="line"></span><br><span class="line">消费者消费消息：</span><br><span class="line">  127.0.0.1:6379&gt; RPOP channel1 <span class="comment">#从管道的右侧消费</span></span><br><span class="line">  <span class="string">"msg1"</span></span><br><span class="line">  127.0.0.1:6379&gt; RPOP channel1</span><br><span class="line">  <span class="string">"msg2"</span></span><br><span class="line">  127.0.0.1:6379&gt; RPOP channel1</span><br><span class="line">  <span class="string">"msg3"</span></span><br><span class="line">  127.0.0.1:6379&gt; RPOP channel1</span><br><span class="line">  <span class="string">"msg4"</span></span><br><span class="line">  127.0.0.1:6379&gt; RPOP channel1</span><br><span class="line">  <span class="string">"msg5"</span></span><br><span class="line">  127.0.0.1:6379&gt; RPOP channel1</span><br><span class="line">  (nil)</span><br><span class="line"></span><br><span class="line">切换主机模拟消费者，再次验证队列消息：</span><br><span class="line">  127.0.0.1:6379&gt;  LRANGE channel1  0  -1 </span><br><span class="line">  (empty list or <span class="built_in">set</span>)  <span class="comment">#队列中的消息已经被已全部消费完毕</span></span><br></pre></td></tr></table></figure>
<h3 id="发布者订阅模式："><a href="#发布者订阅模式：" class="headerlink" title="发布者订阅模式："></a>发布者订阅模式：</h3><ul>
<li>1.模式简介：<ul>
<li>在发布者订阅者模式下，发布者将消息发布到指定的channel里面，凡是监听该channel的消费者都会收到同样的一份消息，这种模式类似于是收音机模式，即凡是收听某个频道的听众都会收到主持人发布的相同的消息内容。</li>
<li>此模式常用语群聊天、群通知、群公告等场景。<ul>
<li>Subscriber：订阅者</li>
<li>Publisher：发布者</li>
<li>Channel：频道</li>
</ul>
</li>
</ul>
</li>
</ul>
<p><img src="/2018/12/26/redis缓存/发布者订阅模式.png" alt=""></p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">订阅者监听频道：</span><br><span class="line">  [root@redis-s4 ~]<span class="comment"># redis-cli </span></span><br><span class="line">  127.0.0.1:6379&gt; AUTH 123456</span><br><span class="line">  OK</span><br><span class="line">  127.0.0.1:6379&gt; SUBSCRIBE channel1  <span class="comment">#订阅者订阅指定的频道,也就是客户端监听服务端的频道，此时可以模拟多个客户端监听服务端的此频道</span></span><br><span class="line">  Reading messages... (press Ctrl-C to quit)</span><br><span class="line">  1) <span class="string">"subscribe"</span></span><br><span class="line">  2) <span class="string">"channel1"</span></span><br><span class="line">  3) (<span class="built_in">integer</span>) 1</span><br><span class="line"></span><br><span class="line">发布者发布消息：<span class="comment">#服务端在此频道发布消息，此时客户端监听在服务端的此频道，都会接受到消息</span></span><br><span class="line">  127.0.0.1:6379&gt; PUBLISH channel1 test1 <span class="comment">#发布者发布消息</span></span><br><span class="line">  (<span class="built_in">integer</span>) 2</span><br><span class="line">  127.0.0.1:6379&gt; PUBLISH channel1 test2</span><br><span class="line">  (<span class="built_in">integer</span>) 2</span><br><span class="line">  127.0.0.1:6379&gt;</span><br><span class="line"></span><br><span class="line">订阅多个频道：</span><br><span class="line">订阅指定的多个频道</span><br><span class="line">  127.0.0.1:6379&gt;  SUBSCRIBE channel1 channel2 </span><br><span class="line"></span><br><span class="line">订阅所有频道：</span><br><span class="line">  127.0.0.1:6379&gt; PSUBSCRIBE *</span><br><span class="line"></span><br><span class="line">订阅匹配的频道：</span><br><span class="line">  127.0.0.1:6379&gt; PSUBSCRIBE chann* <span class="comment">#匹配订阅多个频道</span></span><br></pre></td></tr></table></figure>
<h2 id="六：-redis其他命令："><a href="#六：-redis其他命令：" class="headerlink" title="六： redis其他命令："></a>六： redis其他命令：</h2><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">CONFIG：</span><br><span class="line">  config 命令用于查看当前redis配置、以及不重启更改redis配置等</span><br><span class="line">  127.0.0.1:6379&gt;config get * <span class="comment">#获取config的命令配置帮助,或当前配置</span></span><br><span class="line"></span><br><span class="line">更改最大内存：</span><br><span class="line">  127.0.0.1:6379&gt; CONFIG <span class="built_in">set</span> maxmemory 8589934592</span><br><span class="line">  OK</span><br><span class="line">  127.0.0.1:6379&gt; CONFIG get maxmemory <span class="comment">#获取此配置项的值</span></span><br><span class="line">  1) <span class="string">"maxmemory"</span></span><br><span class="line">  2) <span class="string">"8589934592"</span></span><br><span class="line"></span><br><span class="line">设置连接密码：(可以先修改配置文件再动态命令行设置，这样避免重启服务生效)</span><br><span class="line">  127.0.0.1:6379&gt; CONFIG SET requirepass 123456</span><br><span class="line">  OK        <span class="comment">#通过CONFIG设置密码后立即生效</span></span><br><span class="line">  重现连接测试</span><br><span class="line">  172.18.135.1:6379&gt; CONFIG SET requirepass 123456</span><br><span class="line">  OK</span><br><span class="line">  172.18.135.1:6379&gt; <span class="built_in">exit</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># redis-cli -h 172.18.135.1 -p 6379</span></span><br><span class="line">  172.18.135.1:6379&gt; keys *</span><br><span class="line">  (error) NOAUTH Authentication required.</span><br><span class="line">  172.18.135.1:6379&gt; auth 123456  <span class="comment">#auth认证连接</span></span><br><span class="line">  OK</span><br><span class="line">  172.18.135.1:6379&gt; keys *</span><br><span class="line">  1) <span class="string">"key1"</span></span><br><span class="line"></span><br><span class="line">编辑配置文件设置连接redis的密码永久生效</span><br><span class="line">  <span class="comment">#可以先在redis动态控制台设置完再在配置文件中修改这样会避免重启服务器代来不必要的损失</span></span><br><span class="line">  [root@centos7 ~]<span class="comment"># vim /usr/local/redis/etc/redis.conf </span></span><br><span class="line">  507行</span><br><span class="line">  requirepass 123456</span><br><span class="line"></span><br><span class="line">info：</span><br><span class="line">显示当前节点redis运行状态信息</span><br><span class="line">  172.18.135.1:6379&gt; info </span><br><span class="line"></span><br><span class="line">SELECT：</span><br><span class="line">切换数据库</span><br><span class="line">  172.18.135.1:6379&gt; </span><br><span class="line"></span><br><span class="line">keys:</span><br><span class="line">查看当前库下的所有key：<span class="comment">#keys * 慎用，相当于将数据库中的所有数据拿出，如果数据较多全部显示则会把机器卡死</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">BGSAVE：</span><br><span class="line">手动在后台执行RDB持久化操作</span><br><span class="line">  172.18.135.1:6379&gt; BGSAVE</span><br><span class="line"></span><br><span class="line">DBSIZE：</span><br><span class="line">返回当前库下的所有key 数量</span><br><span class="line">  172.18.135.1:6379&gt; DBSIZE</span><br><span class="line"></span><br><span class="line">FLUSHDB：</span><br><span class="line">强制清空当前库中的所有key</span><br><span class="line">  172.18.135.1:6379&gt; FLUSHDB</span><br><span class="line"></span><br><span class="line">FLUSHALL：</span><br><span class="line">强制清空当前redis服务器所有数据库中的所有key，即删除所有数据</span><br><span class="line">  172.18.135.1:6379&gt; FLUSHALL</span><br></pre></td></tr></table></figure>
<h2 id="七：-redis高可用于集群——配置redis主从"><a href="#七：-redis高可用于集群——配置redis主从" class="headerlink" title="七： redis高可用于集群——配置redis主从"></a>七： redis高可用于集群——配置redis主从</h2><ul>
<li>虽然Redis可以实现单机的数据持久化，但无论是RDB也好或者AOF也好，都解决不了单点宕机问题，即一旦redis服务器本身出现系统故障、硬件故障等问题后，就会直接造成数据的丢失，因此需要使用另外的技术来解决单点问题。</li>
<li>配置reids 主从：<ul>
<li>主备模式，可以实现Redis数据的跨主机备份。</li>
<li>程序端连接到高可用负载的VIP，然后连接到负载服务器设置的Redis后端real server，此模式不需要在程序里面配置Redis服务器的真实IP地址，当后期Redis服务器IP地址发生变更只需要更改redis 相应的后端real server即可，可避免更改程序中的IP地址设置。</li>
</ul>
</li>
</ul>
<p><img src="/2018/12/26/redis缓存/分布式缓存.png" alt=""><br><img src="/2018/12/26/redis缓存/配置redis主从.png" alt=""></p>
<ul>
<li><code>Slave主要配置：</code><ul>
<li>Redis Slave 也要开启持久化（RDB\AOF）并设置和master同样的连接密码，因为后期slave会有提升为master的可能,Slave端切换master同步后会丢失之前的所有数据。（最好将slave的配置于master相同，密码相同为了master宕机提升slave为新的主，如果开始同步，从节点上的原有的值则被清空，所以最好是要当从节点的服务器为干净的redis服务系统，后期如果将从节点强制和主节点断开的话则从节点的数据不会丢失）</li>
<li>一旦某个Slave成为一个master的slave，Redis Slave服务会清空当前redis服务器上的所有数据并将master的数据导入到自己的内存，但是断开同步关系后不会删除当前已经同步过的数据。</li>
</ul>
</li>
</ul>
<h3 id="命令行配置"><a href="#命令行配置" class="headerlink" title="命令行配置"></a>命令行配置</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">方法1：从节点命令行方式将称为主节点的slave</span><br><span class="line">  当前状态为master，需要转换为slave角色并指向master服务器的IP+PORT+Password</span><br><span class="line">  192.168.7.104:6379&gt; SLAVEOF 192.168.7.103 6379</span><br><span class="line">  OK</span><br><span class="line">  192.168.7.104:6379&gt; CONFIG SET masterauth 123456</span><br><span class="line">  OK</span><br><span class="line">  关闭从节点的从属性</span><br><span class="line">  127.0.0.1:6379&gt; SLAVEOF NO ONE </span><br><span class="line"></span><br><span class="line">在终端配置文件主从选项在重启服务后失效</span><br></pre></td></tr></table></figure>
<p><img src="/2018/12/26/redis缓存/同步日志.png" alt=""><br><img src="/2018/12/26/redis缓存/当前slave状态.png" alt=""></p>
<h3 id="保存在配置文件中"><a href="#保存在配置文件中" class="headerlink" title="保存在配置文件中"></a>保存在配置文件中</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">方法2:</span><br><span class="line">此配置文件是编译安装的配置文件</span><br><span class="line">vim /usr/<span class="built_in">local</span>/redis/etc/redis.conf </span><br><span class="line">replicaof 192.168.7.103 6379</span><br><span class="line">masterauth 123456   <span class="comment">#master如果密码需要设置，这里设置的密码为主节点的密码</span></span><br><span class="line"></span><br><span class="line">从节点查看</span><br><span class="line">  重启服务查看</span><br><span class="line">  127.0.0.1:6379&gt; info</span><br></pre></td></tr></table></figure>
<p><img src="/2018/12/26/redis缓存/验证slave.png" alt=""><br><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">验证slave数据：确定slave的数据是不是从主节点的数据同步来的，可以一致观察这从节点的日志</span><br><span class="line">  127.0.0.1:6379&gt; KEYS *</span><br><span class="line">  1) <span class="string">"num"</span></span><br><span class="line">  2) <span class="string">"hset1"</span></span><br><span class="line">  3) <span class="string">"key1"</span></span><br><span class="line">  4) <span class="string">"name1"</span></span><br><span class="line">  5) <span class="string">"zset2"</span></span><br><span class="line">  6) <span class="string">"key2"</span></span><br><span class="line">  7) <span class="string">"zset1"</span></span><br><span class="line">  8) <span class="string">"set2"</span></span><br><span class="line">slave 状态只读无法写入数据，</span><br></pre></td></tr></table></figure></p>
<h3 id="主从复制过程："><a href="#主从复制过程：" class="headerlink" title="主从复制过程："></a><code>主从复制过程：</code></h3><ul>
<li>Redis支持主从复制分为全量同步和增量同步，首次同步是全量同步，主从同步可以让从服务器从主服务器备份数据，而且从服务器还可与有从服务器，即另外一台redis服务器可以从一台从服务器进行数据同步，redis 的主从同步是非阻塞的，其收到从服务器的sync(2.8版本之前是PSYNC)命令会fork一个子进程在后台执行bgsave命令，并将新写入的数据写入到一个缓冲区里面，bgsave执行完成之后并生成的将RDB文件发送给客户端，客户端将收到后的RDB文件载入自己的内存，然后主redis将缓冲区的内容在全部发送给从redis，之后的同步从服务器会发送一个offset的位置(等同于MySQL的binlog的位置)给主服务器，主服务器检查后位置没有错误将此位置之后的数据包括写在缓冲区的积压数据发送给redis从服务器，从服务器将主服务器发送的挤压数据写入内存，这样一次完整的数据同步，再之后再同步的时候从服务器只要发送当前的offset位 置给主服务器，然后主服务器根据响应的位置将之后的数据发送给从服务器保存到其内存即可。</li>
<li>Redis全量复制一般发生在Slave初始化阶段，这时Slave需要将Master上的所有数据都复制一份。具体步骤如下： <ul>
<li>1）从服务器连接主服务器，发送SYNC命令； </li>
<li>2）主服务器接收到SYNC命名后，开始执行BGSAVE命令生成RDB快照文件并使用缓冲区记录此后执行的所有写命令； </li>
<li>3）主服务器BGSAVE执行完后，向所有从服务器发送快照文件，并在发送期间继续记录被执行的写命令； </li>
<li>4）从服务器收到快照文件后丢弃所有旧数据，载入收到的快照； </li>
<li>5）主服务器快照发送完毕后开始向从服务器发送缓冲区中的写命令； </li>
<li>6）从服务器完成对快照的载入，开始接收命令请求，并执行来自主服务器缓冲区的写命令；</li>
<li>7）后期同步会先发送自己slave_repl_offset位置，只同步新增加的数据，不再全量同步。</li>
</ul>
</li>
</ul>
<p><img src="/2018/12/26/redis缓存/同步过程.png" alt=""></p>
<h3 id="主从同步优化："><a href="#主从同步优化：" class="headerlink" title="主从同步优化："></a><code>主从同步优化：</code></h3><ul>
<li>Redis在2.8版本之前没有提供增量部分复制的功能，当网络闪断或者slave Redis重启之后会导致主从之间的全量同步，即从2.8版本开始增加了部分复制的功能。<br>repl-diskless-sync  no #yes为支持disk，master将RDB文件先保存到磁盘在发送给slave，no为maste直接将RDB文件发送给slave，默认即为使用no，Master RDB文件不需要与磁盘交互。<ul>
<li>repl-diskless-sync-delay 5  #Master准备好RDB文件后等等待传输时间</li>
<li>repl-ping-slave-period 10 #slave端向server端发送pings的时间区间设置，默认为10秒 </li>
<li>repl-timeout 60 #设置超时时间</li>
<li>repl-disable-tcp-nodelay no #是否启用TCP_NODELAY，如设置成yes，则redis会合并小的TCP包从而节省带宽，但会增加同步延迟（40ms），造成master与slave数据不一致，假如设置成no，则redis master会立即发送同步数据，没有延迟，前者关注性能，后者关注一致性</li>
<li>repl-backlog-size 1mb  #master的写入数据缓冲区，用于记录自上一次同步后到下一次同步过程中间的写入命令，计算公式：b repl-backlog-size = 允许从节点最大中断时长 <em> 主实例offset每秒写入量，比如master每秒最大写入64mb，最大允许60秒，那么就要设置为64mb</em>60秒=3840mb(3.8G)=</li>
<li>repl-backlog-ttl 3600 #如果一段时间后没有slave连接到master，则backlog size的内存将会被释放。如果值为0则表示永远不释放这部份内存。 </li>
<li>slave-priority 100 #slave端的优先级设置，值是一个整数，数字越小表示优先级越高。当master故障时将会按照优先级来选择slave端进行恢复，如果值设置为0，则表示该slave永远不会被选择。 </li>
<li>#min-slaves-to-write 0 # </li>
<li>#min-slaves-max-lag 10 #设置当一个master端的可用slave少于N个，延迟时间大于M秒时，不接收写操作。</li>
<li>\Master的重启会导致master_replid发生变化，slave之前的master_replid就和master不一致从而会引发所有slave的全量同步。</li>
</ul>
</li>
</ul>
<p>Slave同步过程日志：<br><img src="/2018/12/26/redis缓存/同步过程日志.png" alt=""><br>master同步日志：<br><img src="/2018/12/26/redis缓存/master同步日志.png" alt=""></p>
<h3 id="slave切换master："><a href="#slave切换master：" class="headerlink" title="slave切换master："></a><code>slave切换master：</code></h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line">当前状态：</span><br><span class="line">  从节点的状态信息</span><br><span class="line">  192.168.7.101:6379&gt; info Replication</span><br><span class="line">  <span class="comment"># Replication</span></span><br><span class="line">  role:slave</span><br><span class="line">  master_host:192.168.7.103</span><br><span class="line">  master_port:6379</span><br><span class="line">  master_link_status:up</span><br><span class="line">  master_last_io_seconds_ago:8</span><br><span class="line">  master_sync_in_progress:0</span><br><span class="line"></span><br><span class="line">停止slave同步并查看当前状态：</span><br><span class="line">  192.168.7.101:6379&gt; SLAVEOF no one</span><br><span class="line">  OK</span><br><span class="line">  192.168.7.101:6379&gt; info Replication</span><br><span class="line">  <span class="comment"># Replication</span></span><br><span class="line">  role:master</span><br><span class="line">  connected_slaves:0</span><br><span class="line">  master_replid:ac3475e5e4fae8c5f47711a643e465b9520c4182</span><br><span class="line">  master_replid2:8ee6bc1ac452fd4d2ccbaa660a219f78d218399a</span><br><span class="line">  master_repl_offset:8840</span><br><span class="line">  second_repl_offset:8841</span><br><span class="line">  repl_backlog_active:1</span><br><span class="line">  repl_backlog_size:1048576</span><br><span class="line">  repl_backlog_first_byte_offset:8547</span><br><span class="line">  repl_backlog_histlen:294</span><br><span class="line"></span><br><span class="line">测试能从节点否写入数据：</span><br><span class="line">  192.168.7.101:6379&gt; <span class="built_in">set</span> key1 value1 <span class="comment">#从节点停止主从结构时就是本机的自己的主，所以自然可以都自己的值进行写入</span></span><br><span class="line">  OK</span><br><span class="line">  192.168.7.101:6379&gt;</span><br><span class="line"></span><br><span class="line">虽然从节点脱离了主从结构，但是从节点的数据，依然保留着主节点同步时的数据。</span><br></pre></td></tr></table></figure>
<h3 id="Slave节点再有Slave："><a href="#Slave节点再有Slave：" class="headerlink" title="Slave节点再有Slave："></a><code>Slave节点再有Slave：</code></h3><p><img src="/2018/12/26/redis缓存/从节点再有从节点.png" alt=""></p>
<ul>
<li><code>在有slave的”master”查看状态：</code><ul>
<li># Replication</li>
<li>role:slave</li>
<li>master_host:192.168.7.102</li>
<li>master_port:6379</li>
<li>master_link_status:up</li>
<li>master_last_io_seconds_ago:9 #最近一次与master通信已经过去多少秒。</li>
<li>master_sync_in_progress:0  #是否正在与master通信。</li>
<li>slave_repl_offset:5334 #当前同步的偏移量。</li>
<li>slave_priority:100 #slave优先级，master故障后值越小越优先同步，一半设置相同的数值让它同时同步。</li>
<li>slave_read_only:1</li>
<li>connected_slaves:1</li>
<li>slave0:ip=192.168.7.104,port=6379,state=online,  </li>
<li>offset=5334,lag=1</li>
<li>master_replid:0f0318c25a022add7fd51d4438c470cf608631f9</li>
<li>master_replid2:0000000000000000000000000000000000000000</li>
<li>master_repl_offset:5334</li>
<li>second_repl_offset:-1</li>
<li>repl_backlog_active:1</li>
<li>repl_backlog_size:1048576</li>
<li>repl_backlog_first_byte_offset:1</li>
<li>repl_backlog_histlen:5334</li>
</ul>
</li>
</ul>
<h3 id="常见问题汇总："><a href="#常见问题汇总：" class="headerlink" title="常见问题汇总："></a><code>常见问题汇总：</code></h3><ul>
<li>master密码不对：<ul>
<li>即配置的master密码不对，导致验证不通过而无法建立主从同步关系。</li>
</ul>
</li>
</ul>
<p><img src="/2018/12/26/redis缓存/master密码不对.png" alt=""></p>
<ul>
<li><p>Redis版本不一致：</p>
<ul>
<li>不同的redis 版本之间存在兼容性问题，因此各master和slave之间必须保持版本一致。<br><img src="/2018/12/26/redis缓存/版本不一致报错.png" alt=""></li>
</ul>
</li>
<li><p>无法远程连接：</p>
<ul>
<li>在开启了安全模式情况下，没有设置bind地址和密码</li>
</ul>
</li>
</ul>
<p><img src="/2018/12/26/redis缓存/远程无法连接.png" alt=""></p>

      
    </div>

    

    
    
    

<div>
  
      <div>
    
        <div style="text-align:center;color: #FF0000;font-size:16px;">-------------------码字不易<i class="fa fa-heart"></i>尊重原创<i class="fa fa-heart"></i>转载标注<i class="fa fa-heart"></i>不胜感激-------------------</div>
    
</div>
  
</div>
<div>
      
        
      
</div>
    

    
       
    
    
      <div>
        <div style="padding: 10px 0; margin: 20px auto; width: 90%; text-align: center;">
  <div>Yes or no？</div>
  <button id="rewardButton" disable="enable" onclick="var qr = document.getElementById('QR'); if (qr.style.display === 'none') {qr.style.display='block';} else {qr.style.display='none'}">
    <span>打赏</span>
  </button>
  <div id="QR" style="display: none;">

    
      <div id="wechat" style="display: inline-block">
        <img id="wechat_qr" src="/images/wechatpay.jpg" alt="哆啦A梦 微信支付">
        <p>微信支付</p>
      </div>
    

    
      <div id="alipay" style="display: inline-block">
        <img id="alipay_qr" src="/images/alipay.jpg" alt="哆啦A梦 支付宝">
        <p>支付宝</p>
      </div>
    

    

  </div>
</div>

      </div>
    

    

    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/redis缓存/" rel="tag"># redis缓存</a>
          
        </div>
      

      
      
        <div class="post-widgets">
        

        

        
          
          <div class="social_share">
            
               <div>
                 
  <div class="bdsharebuttonbox">
    <a href="#" class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a>
    <a href="#" class="bds_douban" data-cmd="douban" title="分享到豆瓣网"></a>
    <a href="#" class="bds_sqq" data-cmd="sqq" title="分享到QQ好友"></a>
    <a href="#" class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a>
    <a href="#" class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
    <a href="#" class="bds_tieba" data-cmd="tieba" title="分享到百度贴吧"></a>
    <a href="#" class="bds_twi" data-cmd="twi" title="分享到Twitter"></a>
    <a href="#" class="bds_fbook" data-cmd="fbook" title="分享到Facebook"></a>
    <a href="#" class="bds_more" data-cmd="more"></a>
    <a class="bds_count" data-cmd="count"></a>
  </div>
  <script>
    window._bd_share_config = {
      "common": {
        "bdText": "",
        "bdMini": "2",
        "bdMiniList": false,
        "bdPic": ""
      },
      "share": {
        "bdSize": "16",
        "bdStyle": "0"
      },
      "image": {
        "viewList": ["tsina", "douban", "sqq", "qzone", "weixin", "twi", "fbook"],
        "viewText": "分享到：",
        "viewSize": "16"
      }
    }
  </script>

<script>
  with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='//bdimg.share.baidu.com/static/api/js/share.js?cdnversion='+~(-new Date()/36e5)];
</script>

               </div>
            
            
          </div>
        
        </div>
      
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2018/12/25/KVM-virsh命令使用入门/" rel="next" title="KVM.virsh命令使用入门">
                <i class="fa fa-chevron-left"></i> KVM.virsh命令使用入门
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2018/12/28/redis缓存2/" rel="prev" title="redis集群">
                redis集群 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </div>
  
  
  
  </article>


  </div>


          </div>
          

  
    <div class="comments" id="comments">
    </div>

  



        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    
    <div class="sidebar-inner">

      

      
        <ul class="sidebar-nav motion-element">
          <li class="sidebar-nav-toc sidebar-nav-active" data-target="post-toc-wrap">
            文章目录
          </li>
          <li class="sidebar-nav-overview" data-target="site-overview-wrap">
            站点概览
          </li>
        </ul>
      

      <section class="site-overview-wrap sidebar-panel">
        <div class="site-overview">
          <div class="site-author motion-element" itemprop="author" itemscope="" itemtype="http://schema.org/Person">
            
              <img class="site-author-image" itemprop="image" src="/images/haha.gif" alt="哆啦A梦">
            
              <p class="site-author-name" itemprop="name">哆啦A梦</p>
              <p class="site-description motion-element" itemprop="description">More than that</p>
          </div>

          
            <nav class="site-state motion-element">
              
                <div class="site-state-item site-state-posts">
                
                  <a href="/archives/">
                
                    <span class="site-state-item-count">70</span>
                    <span class="site-state-item-name">日志</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-categories">
                  <a href="/categories/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">17</span>
                    <span class="site-state-item-name">分类</span>
                  </a>
                </div>
              

              
                
                
                <div class="site-state-item site-state-tags">
                  <a href="/tags/index.html">
                    
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                      
                    
                    <span class="site-state-item-count">19</span>
                    <span class="site-state-item-name">标签</span>
                  </a>
                </div>
              
            </nav>
          

          
            <div class="feed-link motion-element">
              <a href="/atom.xml" rel="alternate">
                <i class="fa fa-rss"></i>
                RSS
              </a>
            </div>
          

          
            <div class="links-of-author motion-element">
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://weibo.com/5645211828/profile?rightmod=1&wvr=6&mod=personinfo" title="Weibo &rarr; https://weibo.com/5645211828/profile?rightmod=1&wvr=6&mod=personinfo" rel="noopener" target="_blank"><i class="fa fa-fw fa-weibo"></i>Weibo</a>
                </span>
              
                <span class="links-of-author-item">
                  
                  
                    
                  
                  
                    
                  
                  <a href="https://music.163.com/#/user/home?id=1301458825" title="CloudMusic &rarr; https://music.163.com/#/user/home?id=1301458825" rel="noopener" target="_blank"><i class="fa fa-fw fa-music"></i>CloudMusic</a>
                </span>
              
            </div>
          

          

          
          
          
            
          
          

        </div>
      </section>

      
      <!--noindex-->
        <section class="post-toc-wrap motion-element sidebar-panel sidebar-panel-active">
          <div class="post-toc">

            
              
            

            
              <div class="post-toc-content"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#redis缓存及架构"><span class="nav-number">1.</span> <span class="nav-text">redis缓存及架构</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#一：-缓存概念："><span class="nav-number">1.1.</span> <span class="nav-text">一： 缓存概念：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#二：-redis部署与使用："><span class="nav-number">1.2.</span> <span class="nav-text">二： redis部署与使用：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#三：-redis持久化："><span class="nav-number">1.3.</span> <span class="nav-text">三： redis持久化：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#四：-redis-数据类型："><span class="nav-number">1.4.</span> <span class="nav-text">四： redis 数据类型：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#五：-消息队列："><span class="nav-number">1.5.</span> <span class="nav-text">五： 消息队列：</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#生产者消费者模式："><span class="nav-number">1.5.1.</span> <span class="nav-text">生产者消费者模式：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#发布者订阅模式："><span class="nav-number">1.5.2.</span> <span class="nav-text">发布者订阅模式：</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#六：-redis其他命令："><span class="nav-number">1.6.</span> <span class="nav-text">六： redis其他命令：</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#七：-redis高可用于集群——配置redis主从"><span class="nav-number">1.7.</span> <span class="nav-text">七： redis高可用于集群——配置redis主从</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#命令行配置"><span class="nav-number">1.7.1.</span> <span class="nav-text">命令行配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#保存在配置文件中"><span class="nav-number">1.7.2.</span> <span class="nav-text">保存在配置文件中</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主从复制过程："><span class="nav-number">1.7.3.</span> <span class="nav-text">主从复制过程：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#主从同步优化："><span class="nav-number">1.7.4.</span> <span class="nav-text">主从同步优化：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#slave切换master："><span class="nav-number">1.7.5.</span> <span class="nav-text">slave切换master：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#Slave节点再有Slave："><span class="nav-number">1.7.6.</span> <span class="nav-text">Slave节点再有Slave：</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#常见问题汇总："><span class="nav-number">1.7.7.</span> <span class="nav-text">常见问题汇总：</span></a></li></ol></li></ol></li></ol></div>
            

          </div>
        </section>
      <!--/noindex-->
      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright">&copy; 2018 – <span itemprop="copyrightYear">2019</span>
  <span class="with-love" id="animate">
    <i class="fa fa-child"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">哆啦A梦</span>

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-area-chart"></i>
    </span>
    
      <span class="post-meta-item-text">站点总字数：</span>
    
    <span title="站点总字数">615k</span>
  

  
    <span class="post-meta-divider">|</span>
    <span class="post-meta-item-icon">
      <i class="fa fa-coffee"></i>
    </span>
    
      <span class="post-meta-item-text">站点阅读时长 &asymp;</span>
    
    <span title="站点阅读时长">9:19</span>
  
</div>








<center>
                <font size="4" color="#FF0000">哆啦A梦已经奔跑:<span id="run_time" style="color:#DB70DB"></span></font>
            </center>

            <script>
                function runTime() {
                    var d = new Date(), str = '';
                    BirthDay = new Date("December 01,2017");
                    today = new Date();
                    timeold = (today.getTime() - BirthDay.getTime());
                    sectimeold = timeold / 1000
                    secondsold = Math.floor(sectimeold);
                    msPerDay = 24 * 60 * 60 * 1000
                    msPerYear = 365 * 24 * 60 * 60 * 1000
                    e_daysold = timeold / msPerDay
                    e_yearsold = timeold / msPerYear
                    daysold = Math.floor(e_daysold);
                    yearsold = Math.floor(e_yearsold);
                    str = yearsold + "年";
                    str += daysold-365 + "天";
                    str += d.getHours() + '时';
                    str += d.getMinutes() + '分';
                    str += d.getSeconds() + '秒';
                    return str;
                }
                setInterval(function () { $('#run_time').html(runTime()) }, 1000);
            </script>
        








        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
          <span id="scrollpercent"><span>0</span>%</span>
        
      </div>
    

    
	
    

    
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>














  
    
      
  
  <script type="text/javascript" color="255,0,0" opacity="1" zindex="-1" count="230" src="/lib/canvas-nest/canvas-nest.min.js"></script>













  
  
    <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>
  

  
  
    <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>
  


  


  <script type="text/javascript" src="/js/src/utils.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=6.6.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=6.6.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=6.6.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=6.6.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=6.6.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=6.6.0"></script>



  



  








  <script src="//cdn1.lncld.net/static/js/3.0.4/av-min.js"></script>
  
  
  <script src="//unpkg.com/valine/dist/Valine.min.js"></script>
  
  <script type="text/javascript">
    var GUEST = ['nick','mail','link'];
    var guest = 'nick,mail';
    guest = guest.split(',').filter(function (item) {
      return GUEST.indexOf(item)>-1;
    });
    new Valine({
        el: '#comments' ,
        verify: true,
        notify: false,
        appId: 'dSJsYJFvGkHjdapdMEMXCnfL-gzGzoHsz',
        appKey: 'yOLhPLlsxYBFYhhzjWECUdsf',
        placeholder: '来了老弟！！！',
        avatar:'monsterid',
        meta:guest,
        pageSize:'10' || 10,
        visitor: false
    });
  </script>



  

  <script type="text/javascript">
    // Popup Window;
    var isfetched = false;
    var isXml = true;
    // Search DB path;
    var search_path = "search.xml";
    if (search_path.length === 0) {
      search_path = "search.xml";
    } else if (/json$/i.test(search_path)) {
      isXml = false;
    }
    var path = "/" + search_path;
    // monitor main search box;

    var onPopupClose = function (e) {
      $('.popup').hide();
      $('#local-search-input').val('');
      $('.search-result-list').remove();
      $('#no-result').remove();
      $(".local-search-pop-overlay").remove();
      $('body').css('overflow', '');
    }

    function proceedsearch() {
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay"></div>')
        .css('overflow', 'hidden');
      $('.search-popup-overlay').click(onPopupClose);
      $('.popup').toggle();
      var $localSearchInput = $('#local-search-input');
      $localSearchInput.attr("autocapitalize", "none");
      $localSearchInput.attr("autocorrect", "off");
      $localSearchInput.focus();
    }

    // search function;
    var searchFunc = function(path, search_id, content_id) {
      'use strict';

      // start loading animation
      $("body")
        .append('<div class="search-popup-overlay local-search-pop-overlay">' +
          '<div id="search-loading-icon">' +
          '<i class="fa fa-spinner fa-pulse fa-5x fa-fw"></i>' +
          '</div>' +
          '</div>')
        .css('overflow', 'hidden');
      $("#search-loading-icon").css('margin', '20% auto 0 auto').css('text-align', 'center');

      
        // ref: https://github.com/ForbesLindesay/unescape-html
        var unescapeHtml = function(html) {
          return String(html)
            .replace(/&quot;/g, '"')
            .replace(/&#39;/g, '\'')
            .replace(/&#x3A;/g, ':')
            // replace all the other &#x; chars
            .replace(/&#(\d+);/g, function (m, p) { return String.fromCharCode(p); })
            .replace(/&lt;/g, '<')
            .replace(/&gt;/g, '>')
            .replace(/&amp;/g, '&');
        };
      

      $.ajax({
        url: path,
        dataType: isXml ? "xml" : "json",
        async: true,
        success: function(res) {
          // get the contents from search data
          isfetched = true;
          $('.popup').detach().appendTo('.header-inner');
          var datas = isXml ? $("entry", res).map(function() {
            return {
              title: $("title", this).text(),
              content: $("content",this).text(),
              url: $("url" , this).text()
            };
          }).get() : res;
          var input = document.getElementById(search_id);
          var resultContent = document.getElementById(content_id);
          var inputEventFunction = function() {
            var searchText = input.value.trim().toLowerCase();
            var keywords = searchText.split(/[\s\-]+/);
            if (keywords.length > 1) {
              keywords.push(searchText);
            }
            var resultItems = [];
            if (searchText.length > 0) {
              // perform local searching
              datas.forEach(function(data) {
                var isMatch = false;
                var hitCount = 0;
                var searchTextCount = 0;
                var title = data.title.trim();
                var titleInLowerCase = title.toLowerCase();
                var content = data.content.trim().replace(/<[^>]+>/g,"");
                
                content = unescapeHtml(content);
                
                var contentInLowerCase = content.toLowerCase();
                var articleUrl = decodeURIComponent(data.url);
                var indexOfTitle = [];
                var indexOfContent = [];
                // only match articles with not empty titles
                if(title != '') {
                  keywords.forEach(function(keyword) {
                    function getIndexByWord(word, text, caseSensitive) {
                      var wordLen = word.length;
                      if (wordLen === 0) {
                        return [];
                      }
                      var startPosition = 0, position = [], index = [];
                      if (!caseSensitive) {
                        text = text.toLowerCase();
                        word = word.toLowerCase();
                      }
                      while ((position = text.indexOf(word, startPosition)) > -1) {
                        index.push({position: position, word: word});
                        startPosition = position + wordLen;
                      }
                      return index;
                    }

                    indexOfTitle = indexOfTitle.concat(getIndexByWord(keyword, titleInLowerCase, false));
                    indexOfContent = indexOfContent.concat(getIndexByWord(keyword, contentInLowerCase, false));
                  });
                  if (indexOfTitle.length > 0 || indexOfContent.length > 0) {
                    isMatch = true;
                    hitCount = indexOfTitle.length + indexOfContent.length;
                  }
                }

                // show search results

                if (isMatch) {
                  // sort index by position of keyword

                  [indexOfTitle, indexOfContent].forEach(function (index) {
                    index.sort(function (itemLeft, itemRight) {
                      if (itemRight.position !== itemLeft.position) {
                        return itemRight.position - itemLeft.position;
                      } else {
                        return itemLeft.word.length - itemRight.word.length;
                      }
                    });
                  });

                  // merge hits into slices

                  function mergeIntoSlice(text, start, end, index) {
                    var item = index[index.length - 1];
                    var position = item.position;
                    var word = item.word;
                    var hits = [];
                    var searchTextCountInSlice = 0;
                    while (position + word.length <= end && index.length != 0) {
                      if (word === searchText) {
                        searchTextCountInSlice++;
                      }
                      hits.push({position: position, length: word.length});
                      var wordEnd = position + word.length;

                      // move to next position of hit

                      index.pop();
                      while (index.length != 0) {
                        item = index[index.length - 1];
                        position = item.position;
                        word = item.word;
                        if (wordEnd > position) {
                          index.pop();
                        } else {
                          break;
                        }
                      }
                    }
                    searchTextCount += searchTextCountInSlice;
                    return {
                      hits: hits,
                      start: start,
                      end: end,
                      searchTextCount: searchTextCountInSlice
                    };
                  }

                  var slicesOfTitle = [];
                  if (indexOfTitle.length != 0) {
                    slicesOfTitle.push(mergeIntoSlice(title, 0, title.length, indexOfTitle));
                  }

                  var slicesOfContent = [];
                  while (indexOfContent.length != 0) {
                    var item = indexOfContent[indexOfContent.length - 1];
                    var position = item.position;
                    var word = item.word;
                    // cut out 100 characters
                    var start = position - 20;
                    var end = position + 80;
                    if(start < 0){
                      start = 0;
                    }
                    if (end < position + word.length) {
                      end = position + word.length;
                    }
                    if(end > content.length){
                      end = content.length;
                    }
                    slicesOfContent.push(mergeIntoSlice(content, start, end, indexOfContent));
                  }

                  // sort slices in content by search text's count and hits' count

                  slicesOfContent.sort(function (sliceLeft, sliceRight) {
                    if (sliceLeft.searchTextCount !== sliceRight.searchTextCount) {
                      return sliceRight.searchTextCount - sliceLeft.searchTextCount;
                    } else if (sliceLeft.hits.length !== sliceRight.hits.length) {
                      return sliceRight.hits.length - sliceLeft.hits.length;
                    } else {
                      return sliceLeft.start - sliceRight.start;
                    }
                  });

                  // select top N slices in content

                  var upperBound = parseInt('1');
                  if (upperBound >= 0) {
                    slicesOfContent = slicesOfContent.slice(0, upperBound);
                  }

                  // highlight title and content

                  function highlightKeyword(text, slice) {
                    var result = '';
                    var prevEnd = slice.start;
                    slice.hits.forEach(function (hit) {
                      result += text.substring(prevEnd, hit.position);
                      var end = hit.position + hit.length;
                      result += '<b class="search-keyword">' + text.substring(hit.position, end) + '</b>';
                      prevEnd = end;
                    });
                    result += text.substring(prevEnd, slice.end);
                    return result;
                  }

                  var resultItem = '';

                  if (slicesOfTitle.length != 0) {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + highlightKeyword(title, slicesOfTitle[0]) + "</a>";
                  } else {
                    resultItem += "<li><a href='" + articleUrl + "' class='search-result-title'>" + title + "</a>";
                  }

                  slicesOfContent.forEach(function (slice) {
                    resultItem += "<a href='" + articleUrl + "'>" +
                      "<p class=\"search-result\">" + highlightKeyword(content, slice) +
                      "...</p>" + "</a>";
                  });

                  resultItem += "</li>";
                  resultItems.push({
                    item: resultItem,
                    searchTextCount: searchTextCount,
                    hitCount: hitCount,
                    id: resultItems.length
                  });
                }
              })
            };
            if (keywords.length === 1 && keywords[0] === "") {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-search fa-5x" /></div>'
            } else if (resultItems.length === 0) {
              resultContent.innerHTML = '<div id="no-result"><i class="fa fa-frown-o fa-5x" /></div>'
            } else {
              resultItems.sort(function (resultLeft, resultRight) {
                if (resultLeft.searchTextCount !== resultRight.searchTextCount) {
                  return resultRight.searchTextCount - resultLeft.searchTextCount;
                } else if (resultLeft.hitCount !== resultRight.hitCount) {
                  return resultRight.hitCount - resultLeft.hitCount;
                } else {
                  return resultRight.id - resultLeft.id;
                }
              });
              var searchResultList = '<ul class=\"search-result-list\">';
              resultItems.forEach(function (result) {
                searchResultList += result.item;
              })
              searchResultList += "</ul>";
              resultContent.innerHTML = searchResultList;
            }
          }

          if ('auto' === 'auto') {
            input.addEventListener('input', inputEventFunction);
          } else {
            $('.search-icon').click(inputEventFunction);
            input.addEventListener('keypress', function (event) {
              if (event.keyCode === 13) {
                inputEventFunction();
              }
            });
          }

          // remove loading animation
          $(".local-search-pop-overlay").remove();
          $('body').css('overflow', '');

          proceedsearch();
        }
      });
    }

    // handle and trigger popup window;
    $('.popup-trigger').click(function(e) {
      e.stopPropagation();
      if (isfetched === false) {
        searchFunc(path, 'local-search-input', 'local-search-result');
      } else {
        proceedsearch();
      };
    });

    $('.popup-btn-close').click(onPopupClose);
    $('.popup').click(function(e){
      e.stopPropagation();
    });
    $(document).on('keyup', function (event) {
      var shouldDismissSearchPopup = event.which === 27 &&
        $('.search-popup').is(':visible');
      if (shouldDismissSearchPopup) {
        onPopupClose();
      }
    });
  </script>





  

  

  

  

  

  
  

  

  

  

  

  

  

</body>
</html>

<!-- 页面点击小红心 -->
<script type="text/javascript" src="/js/src/clicklove.js"></script>